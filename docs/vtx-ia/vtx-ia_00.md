# 前置材料

## 前言

我第一次在 2014 年接触到 Vert.x，当时我是 jClarity 的首席技术官，这是我与本·埃文斯和柯克·佩珀丁共同创立的一家初创公司。我们正在构建一个需要接收大量遥测数据、对其进行分析，并向最终用户展示调优建议的 SaaS。我们的用例需要非阻塞、异步通信、多租户（节省成本！）、与数据存储通信的能力，以及良好的安全 WebSocket 支持。它需要成为一个可扩展的分布式系统。这时，Vert.x 出现了！

我们的首席科学家约翰·奥利弗发现了这个灵活的框架来构建异步应用程序。Vert.x 可以做所有的事情。它凭借其 Netty 基础，具有惊人的性能，并支持所有其他功能性和非功能性要求。更好的是，它背后有一群聪明、谦逊、友好的工程师，例如这本书的作者朱利安·庞热。

Vert.x 故意是一个非强制性的框架，它不会像 Spring Boot 那样引导你走一条狭窄的道路。它更像是一个高质量工具的工具包，这些工具被设计成可以一起工作，但你必须决定如何集成它们。这就是这本书成为你不可或缺指南的地方。

书的第一部分揭示了两个主要构建块，即垂直处理单元和事件总线，以及异步编程模型如何与它们一起工作。但真正的价值在于第二部分。朱利安将引导你了解设计反应式应用程序的最佳实践，以及如何集成 Vert.x 的功能，如数据存储和 Web 栈。

对于我来说，奇怪的是，最令人印象深刻的是测试章节；测试反应式应用程序纯粹是件困难的事情，你真的会欣赏这一章！

阅读这本书是一种绝对的荣幸和快乐，即使它让我想起了我们在一些地方犯过的错误！不过，不用担心；当我们被微软收购时，我们带上了 Vert.x，这本书将成为我们完成真正全球规模故事的完美伴侣。

马丁·弗伯格——“邪恶的开发者”——Java 首席软件工程师团队经理（微软）

## 前言

我记得在 2012 年比利时 Devoxx 的舒适的电影室里坐着。在众多我计划参加的会议中，有一个是蒂姆·福克斯介绍他的新项目*Vert.x*。当时，Node.js 正成为所有炒作的焦点，回归异步编程被视为解决所有可扩展性问题的神奇解决方案。通过他的演讲，蒂姆说服了我（以及许多其他与会者），他刚刚为 JVM 上的异步编程奠定了坚实的基础，拥抱 Java 生态系统的优势，并从 Node.js 中挑选了好的想法。当时让我印象深刻的一点是，你可以编写简单的 Java 代码，并忘记复杂的基于注解的框架和应用服务器。Vert.x 感觉就像一股清新的空气，所以我一直关注着这个项目。快进几年：我现在在红帽公司的 Vert.x 团队工作，这在 2012 年时我根本想象不到！

在应用部署到虚拟化环境和容器化的时代，Vert.x 越来越相关。我们期望应用能够根据波动的流量进行扩展和缩减。我们期望应用具有低延迟。我们期望应用在其它系统失败时能够具有弹性。我们期望在给定的服务器上尽可能多地打包应用。简而言之，我们需要资源高效、可扩展和可靠的应用。

这就是*反应式应用*的精髓：无论是工作负载增长还是发生故障时，延迟都处于控制之下。Vert.x 是构建此类反应式应用的坚实基础，但 Vert.x 本身并不是万能的银弹。你不会通过从货架上拿一个软件栈来构建反应式应用；在架构和开发反应式应用时，你还需要一种方法论。

在这本书中，我们将探讨如何使用 Vert.x 编写反应式应用。这不仅仅关于学习 Vert.x，还包括异步编程的基础以及评估应用是否真正是反应式的技术。最后但同样重要的是，Vert.x 很有趣，你会发现这种简单性和忘记一些所谓的“最佳实践”可以带来解放。

## 致谢

我首先要感谢我的伴侣玛丽和我的儿子马修，他们给予了我难以置信的支持。写一本书需要从家庭生活中抽出一些时间，我很幸运能有他们在我身边。

我很感激能与红帽公司的杰出人士一起工作。感谢马克·利特尔、大卫·英厄姆、罗德尼·拉斯和朱利安·维埃，他们给了我机会，首先在红帽公司休假期间参与 Vert.x 项目，然后转到全职职位。非常感谢我的最亲密的同事朱利安·维埃、托马斯·塞吉蒙、克莱门特·埃斯科菲耶、保罗·洛佩斯、罗德尼·拉斯、斯蒂芬·埃帕尔多和弗朗西斯科·加利亚尼：与你们所有人一起工作是一种特权。

我在还是 INSA Lyon 的助理教授时就开始写这本书，我很幸运地得到了在我职业选择上的热情支持。感谢 Fabrice Valois、Frédéric Le Mouël、Nicolas Stouls、Oscar Carillo、François Lesueur 和 Éric Maurincomme。

对我来说，Martijn Verburg 为这本书撰写前言是一种荣誉。Martijn 是 Vert.x 项目中的历史人物，他在他的 jClarity 创业公司早期就证明了 Vert.x 是构建具有挑战性服务的生产级产品，后来被微软收购。非常感谢，Martijn。

Manning MEAP 项目给了我机会，在写作过程中收到很多反馈；感谢所有与我联系并提出评论、错别字和建议的人。

事实上，自从为 Manning 写作以来，我现在明白为什么他们的书如此出色。Manning 对投资作者和书籍非常认真。非常感谢我的发展编辑 Lesley Trites，她总是给予积极和建设性的指导，还要感谢与我一起开始这本书的 Kristen Watterson。感谢 Michael Stephens 对撰写关于 Java 中反应式应用程序的书籍的热情。非常感谢 Raphael Vilella 在我撰写章节时提供的准确技术反馈，以及 Evyatar Kafkafi 对其出色的技术校对。此外，还要感谢来自市场营销部门的 Candace Gillhoolley，我在 2018 年在蒙特利尔举办的反应式峰会上有幸与她见面。

向所有审稿人致谢：Michał Ambroziewicz、Andrew Buttery、Salvatore Campagna、Philippe Charrière、Ahmed Chicktay、John Clingan、Earl Benjamin Bingham、Arnaud Esteve、Damian Esteban、Leonardo Jose Gomes da Silva、Evyatar Kafkafi、Alexandros Koufoudakis、Sanket Naik、Eoghan O’Donnell、Dan Sheikh、Jerry Stralko、George Thomas、Evan Wallace、James Watson 和 Matthew Welke，你们的建议帮助使这本书变得更好。

## 关于这本书

异步和反应式应用程序是现代分布式系统中的一个重要主题，尤其是在逐渐转向虚拟化和容器化运行环境时，强调了资源高效、可适应和可靠的应用程序设计的需求。

异步编程是最大化硬件资源使用的关键，因为它允许我们处理比传统阻塞 I/O 体系结构更多的并发连接。服务需要满足可能在一小时内发生剧烈变化的工作负载，因此我们需要设计出自然支持水平扩展性的代码。最后但同样重要的是，当我们的服务通过网络与其他服务交互时，失败是不可避免的。接受失败是设计可靠系统的关键。

结合异步编程、水平扩展性和弹性，我们就有了今天所说的 *反应式应用程序*，也可以不使用营销术语概括为“可扩展且可靠的应用程序。”

话虽如此，天下没有免费的午餐，如果你有更传统的软件栈背景，转向编写异步和反应式应用程序是困难的。理解异步本身就很困难，但可扩展性和弹性对应用程序设计的影响并非微不足道。

本书旨在帮助所有背景的 Java 开发者自学构建异步和反应式应用程序的概念和实践。本书使用 Eclipse Vert.x，这是一个用于编写此类应用程序的“无魔法”工具包。开发者欣赏 Vert.x 的简单性、易于嵌入和经过实战检验的性能。

### 应该阅读这本书的人

本书面向熟悉 Web 开发、网络服务和 Spring 或 Java EE 等企业 Java 框架的中级 Java 开发者。不需要有异步或反应式编程的先验经验。

### 本书是如何组织的：路线图

《Vert.x 实战》分为两部分。

第一部分涵盖了异步编程的基础以及 Vert.x 的核心 API：

+   第一章是 Vert.x、异步编程和 Vert.x 的介绍。如果你之前从未接触过异步编程，这一章将带你回顾 Java 中的核心非阻塞 API，并展示为什么 Vert.x 提供了一个更易于接近的编程模型。这一章还讨论了在现代分布式系统中引入反应式编程的必要性。

+   第二章介绍了 *verticles*，这是在 Vert.x 中编写非阻塞代码的核心构建块。由于你有时需要调用阻塞或长时间运行的操作，这一章还为你提供了混合阻塞和非阻塞代码的工具和技术。

+   第三章介绍了 *事件总线*，这是 verticles 用于通信的事件系统。事件总线的好处在于，它允许 verticles 不仅可以在单个进程中通信，还可以在集群中通信，这使得它成为一个强大的抽象。

+   第四章讨论了异步流，重点关注 *背压* 的概念，这是在消费者和生产者之间调节事件流所必需的。

+   第五章展示了如何使用除了回调之外的异步编程模型。虽然回调简单且高效，但在许多情况下，它们会使异步操作的协调变得困难。Vert.x 可以混合和匹配不同的模型：未来和承诺、反应式扩展和 Kotlin 协程。

+   第六章回顾了事件总线，并介绍了事件总线服务，这是在事件总线之上的组件抽象。由于事件总线充当事件处理单元之间的自然界限，本章还讨论了如何在 Vert.x 中编写测试。

书的第二部分专注于构建一个现实世界的反应式应用程序：

+   第七章展示了第二部分章节中将使用的真实反应式应用程序用例。该应用程序由多个事件驱动的微服务组成，我们将指定这些服务。

+   第八章揭示了 Vert.x Web 堆栈的一些关键元素：设计 HTTP API、JSON Web 令牌、跨源资源共享以及与现代 Web 应用程序前端的集成。

+   第九章全部关于消息和事件流。我们将涵盖消息代理中使用的 AMQP 协议、Apache Kafka 以及通过 SMTP 发送电子邮件。

+   第十章涵盖了使用 Vert.x 进行数据库和持久状态管理。它展示了如何使用 MongoDB（一种所谓的 NoSQL 数据库）和 Vert.x 提供的原生响应式客户端 PostgreSQL 关系数据库。

+   第十一章探讨了使用 RxJava 和 Apache Kafka 进行端到端实时响应式事件处理。这一章还讨论了如何将 JavaScript 网络应用程序连接到 Vert.x 事件总线，以实现统一的编程模型。

+   第十二章高度实验性，提供了评估服务是否真正响应式的技术。通过使用负载和混沌测试工具，我们将观察服务的行为，并讨论故障缓解技术，如断路器，以及它们对服务整体行为的影响。

+   第十三章是最后一章，讨论了在容器环境中运行的 Vert.x 应用程序。我们将讨论集群、应用程序配置和服务发现，使用简单机制。你将看到如何将 Vert.x 服务打包成容器镜像，部署到 Kubernetes 集群，并公开健康检查和指标。

第一章到第六章适用于所有读者。如果你已经对异步编程有一些经验，某些部分可以跳过。

第七章展示了基于事件驱动响应式服务的应用程序分解。

第八章到第十一章涵盖了 Vert.x 堆栈中最受欢迎的部分，应该对所有希望精通 Vert.x 的读者都有用。

第十二章是我们巩固一切知识并涉及弹性主题的地方，弹性对于构建响应式应用至关重要。这一章几乎可以独立阅读，对负载和混沌测试感兴趣的任何人都可以阅读。实际上，这一章代码较少，实践内容较多，你可以将同样的方法应用于除 Vert.x 以外的任何堆栈编写的服务。

最后，如果你对容器和 Kubernetes 不感兴趣，可以跳过第十三章。

### 关于代码

书中示例的源代码可以从 GitHub 仓库[`github.com/jponge/vertx-in-action`](https://github.com/jponge/vertx-in-action)或 Manning 网站[www.manning.com/books/vertx-in-action](https://www.manning.com/books/vertx-in-action)免费下载。

样例需要 Java 8 或 11 进行编译。提供了 Maven 和 Gradle 构建。要运行第二部分章节的测试和示例，需要安装 Docker。本书的工作流程在 Unix 环境中更好：Linux、macOS 或 Microsoft Windows Subsystem for Linux（WSL）。我使用了一些您可能需要安装的命令行工具；详细信息将在相应的章节中给出。

本书包含许多源代码示例，既有编号列表，也有与普通文本混排。在这两种情况下，源代码都使用`固定宽度字体`如这样来格式化，以将其与普通文本区分开来。在许多情况下，原始源代码已被重新格式化；我们添加了换行并重新调整了缩进，以适应书中的可用页面空间。此外，当代码在文本中描述时，源代码中的注释通常已被从列表中删除。许多列表都有代码注释，突出显示重要概念。

### liveBook 讨论论坛

购买《Vert.x 实战》将包括免费访问由 Manning Publications 运营的私人网络论坛，您可以在论坛上对书籍发表评论、提出技术问题，并从作者和其他用户那里获得帮助。要访问论坛，请访问[`livebook.manning.com/#!/book/vertx-in-action/discussion`](https://livebook.manning.com/#!/book/vertx-in-action/discussion)。您还可以在[`livebook.manning.com/#!/discussion`](https://livebook.manning.com/#!/discussion)了解更多关于 Manning 的论坛和行为准则。

Manning 对我们读者的承诺是提供一个场所，让读者之间以及读者与作者之间可以进行有意义的对话。这不是对作者参与特定数量活动的承诺，作者对论坛的贡献仍然是自愿的（且未支付报酬）。我们建议您尝试向作者提出一些挑战性的问题，以免他的兴趣转移！只要本书有售，论坛和先前讨论的存档将可通过出版社的网站访问。

## 关于作者

朱利安·庞热博士是 Red Hat 的首席软件工程师，负责反应式和 Eclipse Vert.x 项目。他目前从 INSA Lyon 和 CITI 实验室休假，在那里他是计算机科学与工程副教授。他在那里担任过各种教学、研究、管理和行政职位。他在开源生态系统中拥有 20 年的经验，参与了许多项目，并创建了像 IzPack 和 Eclipse Golo 编程语言这样的项目。他还是用户组和会议的常客演讲者。他是法国克莱蒙奥弗涅大学（Université Clermont Auvergne）和澳大利亚新南威尔士大学的校友，在那里他获得了他的博士学位。

## 关于封面插图

《Vert.x 实战》的封面上的女性形象被标注为“库页岛女性”，或称库页岛上的女性。这幅插图取自雅克·Grasset de Saint-Sauveur（1757-1810）的作品集，名为《不同国家的服饰》，于 1797 年在法国出版。每一幅插图都是手工精心绘制和着色的。Grasset de Saint-Sauveur 收藏中的丰富多样性生动地提醒我们，仅仅 200 年前，世界的城镇和地区在文化上有多么不同。人们彼此孤立，说着不同的方言和语言。在街道或乡村，仅凭他们的服饰就能轻易识别他们居住的地方以及他们的职业或社会地位。

自那以后，我们的着装方式已经改变，当时地区间的多样性已经消失。现在很难区分不同大陆、城镇、地区或国家的人们。也许我们用文化多样性换取了更加多样化的个人生活——当然，是为了更加多样化且节奏更快的技术生活。

在难以区分一本计算机书籍与另一本的时候，曼宁通过书籍封面上的设计，庆祝了计算机行业的创新和进取精神。这些设计基于两百年前丰富多样的地区生活，通过 Grasset de Saint-Sauveur 的画作得以重现。
