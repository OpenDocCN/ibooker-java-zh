# 前置内容

## 前言

软件是当今大多数行业的生命线，并且可以成为那些能够快速迭代并在竞争对手之前找到客户价值的公司的差异化因素。一些允许大型组织快速行动的近期趋势包括采用云平台和微服务架构。尽管一些趋势已经演变，但有一点是始终如一的：当事情出错时，我们需要快速了解去哪里查找以解决问题。微服务和短暂的云基础设施（容器等）加剧了这个问题。

我清晰地记得几年前为一个客户解决一个特别棘手的分布式问题，其中一组服务会相互通信以提供某些业务功能。在六天后（几乎精确到点！），这组服务全部崩溃。由此造成的故障给客户造成了重大的收入损失。客户决定在四天后逐个重启所有服务以避免这个问题。

在观察系统几天后，我发现参与调用图的全部服务的内存使用量显著增长，所以我与客户合作，安全地捕获内存和线程转储以了解发生了什么。我确定某个缓冲区正在被填满，但查看代码时很难确定为什么会发生这种情况。系统在各个线程上包含了阻塞和非阻塞代码，这使得工作变得困难。我不得不求助于与分布式系统一起工作的经过验证的基础知识来诊断问题：记录事件。

在花了几天时间勤奋地审查了成千上万条日志行后，我能够看到系统中流动的某些消息组合触发了所有服务的内存泄漏，这最终会在服务中引发“OOM”或内存不足事件。

尽管日志记录在这个努力中起到了显著的作用，但并不容易。日志记录在服务之间不一致，时间戳错误，从机器中提取日志所使用的技术有时会失败、崩溃或损坏日志文件。由于客户不能承受停机，我们在四天后重启服务时也丢失了宝贵的日志数据。如果客户有一个更好的日志和可观察性架构，许多问题都会简化，并且会缩短定位 OOM 问题的耗时。

在这本书中，Phil Wilkins 出色地传达了良好日志模式的原理，并通过使用一种称为 Fluentd 的通用日志收集和聚合技术，用具体的科技和示例进行了展示。Fluentd 用于从各种系统中收集、统一和流式传输日志数据到集中式数据存储，然后可以用于适当的分析。Phil 引导读者构建一个日志系统，考虑到诸如时间戳、结构化可读数据以及更复杂的事物，如路由和日志数据的按摩。

如果你正在构建分布式系统，如微服务架构，你将需要认真考虑你的日志和可观察性架构来支持你的日常运营。这本书将是你踏上旅程的有用伴侣。

—克里斯蒂安·波斯塔，Solo.io 全球现场 CTO

我在七年前开始了 Fluentd 的旅程，将其作为微软 Azure 日志分析 Linux 代理的核心项目进行集成。最初的学习曲线颇具挑战性；然而，我们从不断增长的社区、插件生态系统以及易于扩展性中获得的益处，使得该项目在 Azure 环境中成为最受欢迎的。随后，我跳槽到 Treasure Data，在那里管理该项目，之后加入了 Elastic，在那里我了解了其他日志工具集。在远程欣赏 Fluentd 之后，我终于离开了 Elastic，创立了 Calyptia 公司，这是一家围绕 Fluentd 生态系统建立的公司，并成为了一个项目维护者。

当我开始担任维护者时，我深入社区，调查用户关于他们的痛点以及我们如何改进的地方。社区强调了他们在入门方面的知识差距以及如何找到某些主题的深入解释，并要求提供更多具体的示例。

在一个愉快的巧合中，我在与社区聊天时遇到了 Phil Wilkins，并有幸阅读了他的作品《Logging in Action》。Phil 在解读复杂主题并提供易于理解的视觉和指导方面具有巨大的天赋。《Logging in Action》通过架构细节和深入的分步解释，填补了社区中的许多空白。

对于刚开始接触可观察性领域或已经在生产中运行 Fluentd 的用户来说，通过深入研究 Fluentd 的插件架构和多 worker/multithread 架构，最大化 Fluentd 的性能将非常有价值。所有这些示例都伴随着简单的配置和逐行解释，以便在您的环境中进行定制。

除了基本的入门知识之外，《Logging in Action》还深入探讨了重要的实际用例和商业价值。其中一些我最喜欢的包括减少日志量，这可以降低使用昂贵后端用户的成本，以及如何使用 Fluentd 将数据路由和发送到多个目的地。这两个用例示例在过去几年中会极大地简化我的工作。

随着 Fluentd 进入其发展的第十年，用户每天使用 Docker 部署生态系统项目超过 200 万次，很难找到一个现代的 Kubernetes 服务或云提供商不提及这些基本工具。我强烈推荐使用《Logging in Action》作为入门指南或复习资料，或者作为优化您日志之旅的方法。

——Anurag Gupta，Fluent 维护者及 Calyptia 联合创始人

## 前言

在某些方面，这本书的开发时间几乎和我从事软件行业的时间一样长。考虑到我的 IT 生涯始于 20 世纪 90 年代初，这听起来可能有些奇怪。我早期就意识到了记录和将错误事件转化为诊断和问题解决的重要性。这些经验来自于担任一个关键产品开发项目的年轻主导开发者，进行全天候的系统测试。如果显示器上没有显示问题，就会认为是演示系统的问题，所以找 Phil——他现在需要解决问题，哪怕是在一些不合适的时间或夜晚。现实情况是，演示子系统很少出问题。错误通常源于众多复杂的后端系统之一，它们发送错误数据或尝试使用错误的接口版本进行通信。我越改进日志记录以帮助显示是否已将数据发送到显示系统，收到的电话就越少。

这些年来，我见证了不断追求交付功能性和特性，而有时却忽略了非功能性方面所需的关注。功能性目标总是优先于非功能性考虑。作为软件开发者，我们在监控和日志记录方面可能会成为自己最糟糕的敌人。当我们的代码运行顺畅并通过所有单元测试时，编写日志事件并不那么令人兴奋。从决策者的角度来看，功能已经完成，并且按照约定的时限完成，那么为什么还要花更多时间在解决方案上呢？

事实上，我们常常收集日志并将它们放在一个阴暗的地方，直到出现问题。日志记录永远不会是一个热门话题，但它至关重要，而且当做得好的时候，它可以使我们做一些聪明的事情。良好的日志记录使得机器学习和人工智能能够用于模式识别或直接通知相关人员解决问题。你甚至可以做到检测日志事件并触发清理过程以避免问题。IBM 曾经将自我保护和自我修复过程的理念称为“自治”——听起来现在更有趣了吗？

我的开源背景大约是在我转向使用 Java（1.4 版本刚刚发布）的同时开始的，从 Log4J 这样的库开始。这逐渐发展到更大的开源解决方案，如 JBoss v3 应用服务器，然后在 Red Hat 收购这些业务之前，与 Fuse（Apache CXF、Camel、ServiceMix 和 ActiveMQ）合作，为这些框架构建和提供服务。真正开源解决方案的伟大之处在于其供应商无关的特性，这意味着它可以有适配器和插件来覆盖各种来源，使其易于集成。一种有利于集成事物的架构将鼓励这样的生态系统蓬勃发展，这正是 Fluentd 所做的。

故事的最后一条线索来自我对知识共享的看法。我看到人们用“知识就是力量”的理念作为保留尽可能多的理由，迫使人们去找那些让自己变得不可或缺的人。我总是几乎完全相反地解释这个理念。我不想变得不可或缺，因为这意味着你将日夜被召唤。最好是与他人分享你的知识；人们更有可能欣赏它，并在将来（在你设定的条件下）回报你。直到我参与 Oracle 中间件及其用户社区，以及后来的合作伙伴社区，我才找到了一群志同道合的人，他们鼓励我写作和分享。我的作者之旅真正开始了。

我最初“认真”接触 Fluentd 是在我审视 CNCF 生态系统，看看孵化器中有哪些解决方案时。CNCF 孵化项目预示着可能的技术未来演变。在 Fluentd 中，我发现了一个工具，它提供的不仅仅是让 Splunk 吸取日志文件的功能。Fluentd 为将日志管理推向激动人心的领域创造了机会，并在混合和多云环境中解决了许多重要的日志管理挑战。然而，我认为它在解释和连贯地展示 Fluentd 的能力和潜力方面没有得到充分的体现，因此这本书应运而生。这可能会让人认为 Fluentd 的文档很糟糕，但事实并非如此。然而，在线文档更像是一本字典，而不是指南。它没有解决在应用配置时应该寻找什么，以及为什么会有这样的问题。

## 致谢

这本书是我第一次独立写作的冒险，也是我与 Manning 的第一次合作，它让我意识到，一本好书所付出的努力远比表面所见的多。但我希望你会同意，Manning 编辑团队的推动和鼓励意味着这本书会为你带来价值。

我要感谢曼宁出版社的每一个人，尤其是凯蒂·斯波萨托·约翰逊和安德鲁·沃尔德伦，他们一直陪伴我走过这段冒险之旅，还有凯丽·安德鲁斯，她最终使内容变得完美。

在编写这本书的过程中，我们得到了志愿者审稿人和 MEAP 读者的支持。他们的反馈非常有帮助和洞察力。在这个过程中，阿努拉格·古帕塔和埃德华多·席尔瓦·佩雷拉，作为 Fluentd 和 Fluent Bit 的技术和产品负责人，主动联系并抽出时间与我讨论 Fluentd 和 Fluent Bit，并参与到审稿过程中。感谢大家的时间和反馈。

我作为作者的经历如果没有多年的支持和鼓励是不可能开始的。那些参与我成为 Oracle Ace Director（在我的情况下，类似于 Java 摇滚明星或微软 MVP）之旅的人是这段旅程的核心。由此延伸，感谢过去和现在在凯捷和 Oracle 的同事们——一如既往，感谢你们，希望我们有机会再次在旅行安全时一起享受美食和饮料。

最后，也是最重要的一点，如果没有我的妻子凯瑟琳以及我们的两个儿子克里斯托弗和亚伦的支持和理解，这本书根本不可能完成。在我花费晚上的时间和周末在电脑前而不是陪伴他们的时候，所有的爱都给你们。

向所有审稿人致谢：亚历克斯·塞斯、安德烈亚·C·格兰塔、安德烈斯·萨科、克利福德·瑟伯、科诺尔·雷德蒙德、埃利亚斯·兰格尔、乔治·托马斯、乔尔·霍姆斯、约翰·古德里奇、卡纳克·克什特里、肯特·R·斯皮尔纳、凯里·E·科伊茨奇、马里奥-莱安德·雷伊默、迈克尔·布莱特、米哈尔·鲁特卡、雷蒙德·张、萨特杰·库马尔·萨胡、素法·方、西达尔特·马斯达南、西梅恩·莱泽宗、斯蒂芬·赫尔韦格、苏雷什·科亚、特伦特·怀特利、瓦姆西·克里希纳和佐希布·阿因波雷，你们的建议使这本书变得更好。

## 关于这本书

《*Logging in Action*》这本书的编写是为了帮助人们充分利用 Fluentd，并思考日志如何让我们的生活变得更简单。是的，这本书专注于 Fluentd，但正如你将看到的，它是最有影响力的日志工具之一。

开发软件所花费的时间只是我们产生的代码生命中的一小部分，这些代码需要保持运行。日志越弱，20 年或 30 年后理解和照顾这些系统就会越困难。考虑一下：在 2020 年，路透社援引报道称，大约有 2200 亿行 COBOL 代码([www.bmc.com/blogs/cobol-trends](http://www.bmc.com/blogs/cobol-trends))；Linux 内核于 1991 年发布，所以软件会持续存在。编写良好的日志和最大化日志工具和框架可以为帮助做出巨大的贡献。你不需要是一位超级明星级的热门开发者或精通内核配置黑暗艺术的系统管理员，就能从这本书中受益；作为作者，我也不认为自己是这两者之一。

Fluentd 以及 Prometheus 等各种技术与云原生解决方案紧密相关。但不要因此却步；即使你正在使用主机上的 COBOL 77，你仍然需要了解正在发生的事情。像 Fluentd 这样的工具只是以可以解决云原生所增加的需求（如容器集成、超大规模和高度分布式解决方案跨越数据中心和托管供应商）的方式处理了监控、测量和警报的问题。因此，本书的大部分内容都专注于日志问题，无论位置如何。Fluentd 解决了容器、超大规模等问题，因此我们在本书最先进的部分探讨了这些问题。

每个人都对日志和监控是什么以及应该如何使用都有自己的先入之见。这些先入之见受到我们作为开发者、系统管理员、数据库管理员、安全专家等日常工作的 影响。我希望这本书能帮助你看到你未曾考虑过的其他视角。例如，当我们查看日志时，我们通常考虑的是治疗而不是预防。我希望这本书能让你考虑那些有助于在处理日志事件时采用预防性或至少更响应性方法的观点。

### 适合阅读本书的人群

《日志实战》面向所有参与开发、配置或运行 IT 解决方案的实践任务的人员，例如那些在支持团队中努力保持一个过时的、未记录的软件运行一整天的人。对于正在考虑降低系统运行成本以释放下一笔资金用于下一个酷炫增强功能的架构师。对于编写代码的开发者，他们不希望凌晨 3 点被叫醒去解决问题，因为日志并不清楚发生了什么错误导致代码失败。对于 IT 行业中的任何人，如果他们认为现在是时候“回馈社会”并尝试减轻理解或预防 IT 问题之痛，这本书都将是你的良伴。最终，如果你想从日志中获得更多，这本书应该能为你提供一些帮助。

### 本书组织结构

本书分为四部分，共涵盖十一章和五章附录。章节带你了解如何做事，附录提供了大量的参考资料和额外的支持资源及工具。

第一部分

第一部分概述了主要思想，详细介绍了 Fluentd 的架构、Fluentd 可以支持的使用案例和机会，以及部署 Fluentd 的先决条件。我们以经典的动手实践“Hello World”示例结束本节：

+   *第一章* 从日志统一的电梯简报基础开始，回顾了日志和 Fluentd 背后的背景和基本思想。我们探讨了不同的用例和日志的不同视角，并检查了 ELF 和 EFK 软件堆栈，以及这些事物之间的差异和共性。

+   *第二章* 讲解了日志事件的构成，时间的重要性（尤其是对于分布式解决方案），Fluentd 的架构以及这些如何影响决策。接下来，我们讨论了部署和运行基本 Fluentd 配置所需的足迹。我们遵循传统，创建 Fluentd 的“Hello World”程序等价物。

第二部分

第二部分深入到与 Fluentd 一起工作的细节，展示了捕获日志事件、路由、过滤和输出事件的机制。我们提供了将日志事件的处理从移动数据转变为使日志更有意义、关键的是可操作和/或可衡量的实际步骤：

+   *第三章* 主要讲述如何捕获日志事件。我们探讨了最常见的来源，例如日志文件，并阐述了处理此类数据的细微差别。我们如何通过解析器从日志事件中提取更多意义？当然，如果我们正在监控所有其他内容，我们如何监控监控器呢？

+   *第四章* 探讨了这个问题：捕获事件后，我们将如何处理它们？我们检查了帮助提高 I/O 性能的缓冲区，但最终将日志事件存储在结构化文件或类似 NoSQL 数据库的存储库中。然后我们探讨了支持事件后分析的方法（例如，在 Elasticsearch 中挖掘事件），并探讨了如何更加积极主动，发现重要事件并在它们发生时通过 Slack 通知。

+   *第五章* 讨论了谁需要日志事件，以及我们如何将事件发送到正确的位置？安全人员希望所有数据都包含在他们专业的数据挖掘工具包中。运维人员不希望日志充斥环境，但他们希望任何有助于他们发现生产问题和将有意义的数据发送给正确人员的工具。

+   *第六章* 探讨了从日志中获得更多意义。让我们将日志从数据转变为信息。我们需要向日志事件中注入额外信息以提供有价值的上下文吗？如果是这样，我们该如何做？

第三部分

第三部分带我们进入 Fluentd 最先进的部分，探讨了在经典部署场景和容器化环境中部署、性能和扩展。我们解决了构建自己的插件以处理现有插件无法满足我们需求的利基情况：

+   *第七章*讨论了 Fluentd 如何应用于扩展（无论是静态还是动态），以及它如何在分布式多服务器和集群环境中运行，包括仅限本地、混合和多云因素。我们还探讨了如何将弹性集成到部署中，以便日志事件继续流动。

+   *第八章*探讨了在 Kubernetes 和 Docker 中配置 Fluentd 以捕获应用程序事件以及监听由这些平台技术本身生成的日志事件。

+   *第九章*针对那些希望用自己的插件为 Fluentd 社区做出贡献或需要开发一些东西来解决他们自己的特定问题（目前还没有插件可以提供帮助）的人。这是唯一一章，拥有一些开发经验将会很有益处。

第四部分

第四部分探讨了 Fluentd 及其日志处理能力的好坏取决于所创建的日志事件。我们检查了什么构成了好的日志事件。将日志事件输出到文件系统并不是最佳解决方案，因此我们探讨了更有效地将日志事件传递到 Fluentd 的不同方法：

+   *第十章*描述了日志分类的有效使用，以及可以增加日志事件价值和用途的信息类型，以及我们如何使这些信息可用。这包括考虑记录敏感数据的影响。

+   *第十一章*探讨了日志框架以及它们如何简化在不同语言中处理日志事件。本章检查了如何使用比日志文件更直接的技术将日志事件发送到 Fluentd。避免这一步骤可以提高我们设置的效率和灵活性。我们参观了众多日志框架的组织方式，并直接将这些框架连接到 Fluentd 而不是通过日志文件，包括如何在应用程序锁定使用 Fluentd 之前完成这一操作。

附录

附录中包含了在使用 Fluentd 时有助于快速参考的内容，以及许多资源，可以帮助您了解更多关于相关主题和有用工具的信息。除了 Fluentd 和 LogSimulator 之外，我们还涵盖了用于演示 Fluentd 各种方面的产品安装。我们将这些内容放在附录中，以避免对书籍流程造成任何干扰：

+   *附录 A*将指导您安装不同的工具和运行书中所有示例、场景和练习所需的配置，如果您想深入了解。

+   *附录 B*帮助处理时间和日期以及由于编程语言差异而可能不同的正则表达式。本附录提供了方便的查找，以解决这些问题。

+   *附录 C*讨论了 Fluentd 存在于插件的世界中，这应该有助于您识别可能有所帮助但尚未在章节中使用过的插件。这不是一个详尽的列表，但它指出了一些可能迟早会很有用的插件。

+   *附录 D* 讲述了我们如何应用日志管理来为大型组织带来显著改进的故事。为了保护无辜者，我对一些细节进行了模糊处理。然而，如果您试图帮助您的组织采用更好的日志和监控实践，这应该会提供一些想法。

+   *附录 E* 针对日志和 Fluentd 触及 IT 许多方面的现实情况。我们并没有试图详细涵盖所有内容，因为这会导致一本书变得如此庞大，以至于我们无法拿起它，所以我们已经确定了一系列我们认为可以帮助的外部资源。

### 关于代码

这本书包含了大量 Fluentd 配置和源代码的示例，无论是编号列表还是与标准文本并列，源代码都以`固定宽度字体`的形式呈现，以便与普通文本区分。

在大多数情况下，我们限制了本书只展示配置文件的相关部分。所有列表标题都提供了对完整代码或配置的参考。本书不包括配置或代码注释，但我们保留它们在原始源文件中，以使代码紧凑且易于在页面上阅读。在极少数情况下，即使这样也不够，列表中还包括了行续接标记（➥）。

本书示例的源代码可以从出版商的网站[www.manning.com/books/logging-in-action](https://www.manning.com/books/logging-in-action)或 GitHub 仓库[`github.com/mp3monster/LoggingInActionWithFluentd`](https://github.com/mp3monster/LoggingInActionWithFluentd)下载。我希望随着时间的推移，我们能够将更多示例添加到这个仓库中。

### liveBook 讨论论坛

购买《Logging in Action》包括免费访问 Manning 的在线阅读平台 liveBook。使用 liveBook 的独特讨论功能，您可以在全局或特定章节或段落中添加评论。为自己做笔记、提问和回答技术问题，以及从作者和其他用户那里获得帮助都非常简单。要访问论坛，请访问[`livebook.manning.com/#!/book/logging-in-action/discussion`](https://livebook.manning.com/#!/book/logging-in-action/discussion)。您还可以在[`livebook.manning.com/#!/discussion`](https://livebook.manning.com/#!/discussion)了解更多关于 Manning 论坛和行为准则的信息。

Manning 对我们读者的承诺是提供一个场所，让读者之间以及读者与作者之间可以进行有意义的对话。这并不是对作者参与特定数量活动的承诺，作者对论坛的贡献仍然是自愿的（且未付费）。我们建议您尝试向作者提出一些挑战性的问题，以免他的兴趣转移！只要本书有售，论坛和先前讨论的存档将可通过出版商的网站访问。

## 关于作者

| ![Wilkins 作者照片](img/Wilkins_AuthorPhoto_FM.png)     | Phil Wilkins 在软件行业工作了超过 30 年，为各种不同的企业和环境工作，从跨国公司到软件初创公司，从雷达到零售，再到商业医疗保健。他最初是一名实时解决方案的开发者，并逐步担任了技术领导角色，主要在基于 Java 的环境中工作。Phil 曾作为咨询架构师和技术倡导者加入 Oracle，此前在 Capgemini 工作，专注于云集成、API 设计和非功能性考虑，如日志记录和监控。他是英国一个多奖获奖的 PaaS 团队的成员，使用供应商特定的和开源技术；他在与知名英国和国际品牌打交道时担任客户 facing 角色，为交付团队提供内部支持。他与交付团队的合作集中在技术专长、开发和发展最佳实践以及领导创新项目。他是 TOGAF 认证的。在日常工作之外，Phil 积极参与以各种方式支持开发者社区，包括作为伦敦 Oracle 开发者 Meetup 的共同组织者、期刊文章和博客的作者，以及在英国和世界各地的会议上的演讲者。自 2019 年以来，Phil 对开源和 PaaS 的贡献得到了 Oracle 的认可，并被认证为 Oracle Ace Director。 |
| --- | --- |

## 关于封面插图

《Logging in Action》封面上的插图是“Fille Bratzke à Udinskoi Ostrog”，或称乌迪诺伊奥斯特罗格的 Bratzke 女孩，出自雅克·格拉塞·德·圣索沃尔 1797 年出版的一本书。每一幅插图都是手工精心绘制和着色的。

在那些日子里，人们通过他们的服饰就能轻易地识别出他们居住的地方以及他们的职业或社会地位。Manning 通过基于几个世纪前丰富的地方文化多样性的封面设计，以及像这一系列这样的图片，来庆祝当今计算机行业的创新精神和主动性。
