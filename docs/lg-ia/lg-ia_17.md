# 附录 B.处理时间和日期、正则表达式以及其他配置值

## B.1 表达相对时间

Fluentd 的一些配置属性要求我们以相对方式表达时间（即，从现在起有多长时间）。以可读形式表示这些值最好使用简单的整数和时间类型——秒、分钟和小时。以下表格显示了在 Fluentd 中如何实现这一点。

| Interval | 字符 | 示例 |
| --- | --- | --- |
| Seconds | s | 10s → 10 秒 0.1s → 100 毫秒 |
| Minutes | m | 1m → 1 分钟 0.25m → 15 秒 |
| Hours | h | 24h → 24 小时 0.25h → 15 分钟 |
| Days | d | 1d → 1 天 0.5d → 12 小时 |

## B.2 表达日期和时间

输入和输出的日期表示由 Ruby 如何解析自定义格式的日期时间驱动。以下表格显示了字符代码到它们解析的值的映射。在几个案例中，相同字符的大小写表示相同值的截断和完整版本（例如，`a%` 和 `%A`）。小写形式表示截断格式。我们将这些案例放在同一行中，以便更容易发现。

| Code | 日期元素描述 | 示例 |
| --- | --- | --- |
| `%a` `%A` | 一周中天数的三位字母缩写。一周中天数的完整名称。 | Mon 星期一 |
| `%b` 或 `%h` `%B` | 月份名称的缩写版本。完整月份名称。 | Feb 二月 |
| `%c` | 本地默认表示法的快捷方式。 | `%a %b %e %T %Y` 精确格式由区域设置驱动。 |
| `%C` | 以数字形式表示的世纪。2021 年将结果为 20（Ruby 通过将年份除以 100 并向下取整来得到这个值）。 | 2021 |
| `%d` | 月份中的天数，以两位数表示 01 ... 31。 | 06 |
| `%D` | `%m/%d/%y`（月/日/年）的快捷方式。 | 01/01/21 |
| `%e` | 月份中的天数，但小于 10 的天数以一位数表示。 | 6 |
| `%F` | `%Y-%m-%d` 的快捷方式，与 ISO 8601 格式对齐（有关 ISO 格式标准的更多信息，请参阅 [www.iso.org/iso-8601-date-and-time-format.html](http://www.iso.org/iso-8601-date-and-time-format.html)）。通常记录为 YYYY-MM-DD。 | 2021-12-31 |
| `%H` | 使用 24 小时制表示一天中的小时，以两位数形式表示。 | 02 |
| `%I` (大写 *I*) | 使用两位数 12 小时制表示一天中的小时，因此 01 可以是上午 1 点或下午 1 点。另一种形式是 `%l`（小写 *L*）。 | 01 |
| `%j` | 从 001 开始的一年中的天数的三位数表示。 | 211 |
| `%k` | 一天中的小时（24 小时制 0 ... 23）；个位数表示上午小时 | 3 |
| `%l`(小写 *L*) | 使用一位数表示小时数小于 10，对于剩余的小时使用两位数。这使用 12 小时制，因此 1 可以是上午 1 点或下午 1 点。另一种形式是 `%I`。 | 1 |
| `%L` | 时间中的毫秒部分，以三位数形式表示。 | 021 |
| `%m` | 年份中的月份，以两位数形式表示。 | 08 |
| `%M` | 小时中的分钟，以两位数形式表示。 | 09 |
| `%N` 或 `%9N` 或 `%6N` 或 `%3N` | 秒的分数以纳秒（9 位）表示。秒的分数以微秒（6 位）表示。秒的分数以毫秒（3 位）表示。 | 012345678012345012 |
| `%p` 或 `%P` | 子午线指示符：上午或下午（大写）。子午线指示符：am 或 pm（小写）。 | PMp.m. |
| `%r` | 使用 12 小时制的时钟表示时间的快捷方式——等同于使用 `%I:%M:%S %p`。 | 01:02:06 PM |
| `%R` | 使用 24 小时制的时钟表示时间的快捷方式——等同于 `%H:%M`。 | 15:01 |
| `%s` | 自纪元（即 1970-01-01 00:00:00 UTC）以来的秒数；也称为 POSIX 时间或 Unix 时间。 | 1588115129 |
| `%S` | 分中的秒数，以两位数字表示。 | 05 |
| `%T` | 使用 24 小时制的时钟表示时间的快捷方式——到秒的精度使用 24 小时制。 | 01:59:11 |
| `%u` | 周的星期几的数字表示形式，星期一为 1。 | 7 |
| `%U` | 当前年份的周数，以两位数字格式表示，第一个星期天算作第一周的第一天：00 . . . 53 | 52 |
| `%V` | 根据 ISO 8601 定义的周数（ `%U` 的替代）。 | 01 |
| `%W` | 从第一个星期一开始计算的周数。 | 00 |
| `%w` | 周的星期几的另一种数字表示形式，其中第一天是星期日（0）。 | 6 |
| `%x` | `%D` 的别名。 | 01/01/21 |
| `%X` | `%T` 的别名。 | 01:59:11 |
| `%y` 或 `%Y` | 年份以两位数字表示（即省略世纪）。包括世纪的年份。 | 212021 |
| `%z` | 时区偏移量以相对于 UTC 的正负四位数字表示。例如，纽约比 UTC 晚 4 小时，因此是 -0400。前两位数字代表小时；第二位代表分钟。例如，澳大利亚中央标准时间比 UTC 快 9.5 小时。 | +0930 |
| `%Z` | 时间区以名称表示。可以找到完整的时间区和它们的代码列表，请参阅 [www.timeanddate.com/time/zones/](https://www.timeanddate.com/time/zones/)。 | BST |

## B.3 表达大小

一些属性允许您以字节为单位表达数据大小，最高可达太字节。然而，我们不推荐您使用太字节大小。

| 大小 | 字符 | 示例 |
| --- | --- | --- |
| 字节 | - | 100 → 100 字节 |
| 千字节 | k | 12k → 12 千字节 (Kb) |
| 兆字节 | m | 5m → 5 兆字节 (MB) |
| 吉字节 | g | 3h → 3 吉字节 (GB) |
| 太字节 | T | 1t → 1 太字节 (TB) |

## B.4 正则表达式

正则表达式是我们处理文本字符串以查找特定模式或将字符串分解成部分的一种常用方法。不幸的是，正则表达式（通常简称为 REGEX）在不同的实现之间可能略有差异。为了参考，以下部分突出了 Ruby（以及 Fluentd 使用 Ruby 实现的方式）和 Fluentd 中实现的正则表达式的最有用方面。

### B.4.1 转义码

转义码提供了使用预定义字符组的手段。

| 正则表达式代码 | 说明 |
| --- | --- |
| `.` | 任何字符（除非在解析器中启用了多行选项，则不包括换行符） |
| `\d` | 一个数字字符 (`[0-9]`) |
| `\D` | 一个非数字字符 (`[⁰-9]`) |
| `\h` | 一个十六进制数字字符 (`[0-9a-fA-F]`) |
| `\H` | 一个非十六进制字符 (`[⁰-9a-fA-F]`) |
| `\s` | 一个空白字符（即空格、制表符、回车、换行、垂直制表符或换页符） |
| `\S` | 一个非空白字符（即 `^ \t\r\n\f\v` 的逆） |
| `\w` | 一个单词字符 (`[a-zA-Z0-9_]`) |
| `\W` | 任何非单词字符（即 `\w` 的逆） |

### B.4.2 重复/选择

这些字符允许我们定义不同的重复模式并定义可接受值的范围。

| 正则表达式代码 | 说明 |
| --- | --- |
| `*` | 零次或多次 |
| `?` | 零次或一次（可选） |
| `[n,m]` | 定义接受的值的选项 |
| `[n..m]` | 定义值范围——内容受 ASCII 编码影响，可以通过重复 `n . . . m` 包含多个范围（例如，`[a..zA..Z0..9]`） |
| `^` | 在范围内 |
| `{,m}` | `m` 次或更少 |
| `{n,}` | `n` 次或更多 |
| `{n,m}` | 至少 `n` 次且最多 `m` 次 |
| `{n}` | 精确 `n` 次 |
| `+` | 一次或多次 |

### B.4.3 锚点、组和备选方案

锚点是元字符，用于匹配字符之间的零宽度位置，*锚定*匹配到特定位置。组允许我们定义原子分组，这可以看作是数学中括号的使用。

| 正则表达式代码 | 说明 |
| --- | --- |
| `$` | 匹配行的结束。 |
| `(` | 开始分组。 |
| `(?` | 开始一个不捕获内容的组。 |
| `(?<NAME>` | 使用名称定义捕获组。NAME 被替换为选择的名称。 |
| `)` | 分组的结束，无论是捕获组还是非捕获组。 |
| `\A` | 匹配字符串的开始。 |
| `\G` | 匹配定义字符的第一个出现。 |
| `\k<NAME>` | 允许命名组进行回引用（即，一旦定义即可引用）。 |
| `\Z` | 匹配字符串的结束。如果行的结束是一个换行符，则忽略。 |
| `\z` | 匹配字符串的结束。 |
| `^` | 匹配行的开始。 |
| `&#124;` | 分隔两个值或表达式，可以像这样或这样处理——例如，对于 `(a&#124;b)`，值可以是 `a` 或 `b`。 |

## B.5 Docker 标签定制

在 Docker 日志驱动程序的 log-opts 配置中，可以定制其输出的标签元素。这是通过将 log-opts 的标签部分设置为等于使用预定义模板标记的配置字符串来完成的，如下表所示。

| 标记 | 描述 |
| --- | --- |
| `{{.ID}}` | 容器 ID 的前 12 个字符 |
| `{{.FullID}}` | 完整的 64 位容器 ID |
| `{{.Name}}` | 启动时的容器名称 |
| `{{.ImageID}}` | 镜像 ID 的前 12 个字符 |
| `{{.ImageFullID}}` | 镜像的完整 ID |
| `{{.ImageName}}` | 容器使用的镜像名称 |
| `{{.DaemonName}}` | 运行容器的软件守护进程名称（例如，Docker） |

使用这张表格，如果我们提供了额外的配置，例如 `–log-opt tag="{{.ID}}-{{.ImageID}}"`，那么标签看起来可能就像 `"myid12xxeerr-mynamefluent"` 这样，连字符来自我们在配置中指定的两个标签部分的分隔。
