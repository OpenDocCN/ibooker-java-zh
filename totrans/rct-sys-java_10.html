<html><head></head><body><section data-pdf-bookmark="Chapter 7. Mutiny: An Event-Driven &#10;Reactive Programming API" data-type="chapter" epub:type="chapter"><div class="chapter" id="mutiny">&#13;
<h1><span class="label">Chapter 7. </span>Mutiny: An Event-Driven &#13;
<span class="keep-together">Reactive Programming API</span></h1>&#13;
&#13;
&#13;
<p><a data-primary="Mutiny" data-type="indexterm" id="ix_mutiny-adoc0"/>In <a data-type="xref" href="ch05.html#reactive-programming">Chapter 5</a>, we introduced reactive programming and how it helps implement reactive applications.&#13;
Then, in <a data-type="xref" href="ch06.html#quarkus-reactive">Chapter 6</a>, we discussed how Quarkus uses Mutiny to allow implementing reactive applications.&#13;
This chapter focuses on Mutiny itself.<sup><a data-type="noteref" href="ch07.html#idm45358827414448" id="idm45358827414448-marker">1</a></sup></p>&#13;
&#13;
<p>This chapter presents Mutiny’s concepts and common patterns, which will help you understand the next few chapters.&#13;
Mutiny is the API used for every reactive-related feature from Quarkus.&#13;
You will see a lot more of it when delving into the construction of reactive applications and systems with Quarkus.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Why Another Reactive Programming Library?" data-type="sect1"><div class="sect1" id="idm45358827413088">&#13;
<h1>Why Another Reactive Programming Library?</h1>&#13;
&#13;
<p><a data-primary="Mutiny" data-secondary="programming issues addressed by" data-type="indexterm" id="idm45358827411680"/>That’s a great question!&#13;
As you have seen in <a data-type="xref" href="ch05.html#reactive-programming">Chapter 5</a>, other popular reactive programming libraries exist.&#13;
So why another one?</p>&#13;
&#13;
<p>In the past few years, we’ve observed how developers developed reactive systems and used reactive programming libraries.&#13;
Through this experience, we observed the challenges faced by the developers.&#13;
In a nutshell, reactive programming is hard to learn and hard to read.&#13;
Writing and maintaining reactive code creates a significant burden, slowing the adoption of reactive approaches.</p>&#13;
&#13;
<p>When we look at reactive programming usage, we immediately see a steep learning curve, which makes reactive programming limited to top-notch developers.&#13;
Indeed, the functional programming roots of reactive programming are both elegant and limiting at the same time.&#13;
Not every developer has a functional background.&#13;
We have seen developers lost in a <code>map</code> and <code>flatMap</code> jungle, trying to find their way out of a maze made of monads.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45358827407088">&#13;
<h5>Monads?</h5>&#13;
<p>Monads come from category theory but are massively used in functional programming.&#13;
A <em>monad</em> represents a form of computation.&#13;
Monads enable the chaining of operations.&#13;
With monads, each chained operation takes as input the output of the previous one.</p>&#13;
</div></aside>&#13;
&#13;
<p>Even for seasoned developers, some concepts are abstract and confusing.&#13;
For example, the difference between <code>flatMap</code> and <code>concatMap</code>, two prominent operators in traditional reactive programming libraries, leads to many mistakes, including production failures.&#13;
These reactive programming libraries require a functional background and a good understanding of the available operators.&#13;
Mastering hundreds of operators requires time.</p>&#13;
&#13;
<p>Another aspect is the API modeling.&#13;
Existing libraries often implement  <a href="http://reactivex.io/">Reactive Extensions (ReactX)</a> and provide Java classes with hundreds of methods.&#13;
Even with modern IDEs, finding the right method is like looking for a needle in a haystack.&#13;
It’s common to scroll through the list of methods to find the right one, not even looking at the method names but at the signature, hoping for the best.</p>&#13;
&#13;
<p>Finally, and this is a more philosophical aspect, existing reactive programming libraries do not reflect the event-driven nature of the reactive principles.&#13;
While it uses data streams, which are asynchronous constructs, the API does not convey the idea of events.&#13;
Reactive architectures should help to implement event-based processes, and these approaches fall short and require an additional mental-mapping between the business process and its implementation.</p>&#13;
&#13;
<p>To address these issues, we decided to create Mutiny, a new reactive programming API focusing on readability, maintenance, and putting the notion of <em>event</em> at the &#13;
<span class="keep-together">center</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What Makes Mutiny Unique?" data-type="sect1"><div class="sect1" id="idm45358827399008">&#13;
<h1>What Makes Mutiny Unique?</h1>&#13;
&#13;
<p><a data-primary="Mutiny" data-secondary="unique characteristics of" data-type="indexterm" id="idm45358827397792"/>Mutiny is an intuitive, event-driven reactive programming library for Java.&#13;
Mutiny uses the notion of an <em>event</em> to communicate that something happened.&#13;
This event-driven nature fits perfectly the asynchronous nature of distributed systems, as described in <a data-type="xref" href="ch03.html#distributed-system">Chapter 3</a>.&#13;
With Mutiny, you get notified when an event occurs, and you react to it. As a result, Mutiny structures itself around <em>on</em> methods such as <code>onItem</code> and <code>onFailure</code>.&#13;
Each method lets you express what you want to do when you receive an event.&#13;
For example, <code>onItem.transform</code> receives an item event and transforms it, or <code>onFailure.recoverWithItem</code> recovers with a fallback item after a failure event.</p>&#13;
&#13;
<p>We wanted to address the API navigation and avoid the <em>one class with hundreds of methods</em> pattern.&#13;
We introduced the notion of method <em>groups</em>.&#13;
Each group handles a specific type of event.&#13;
In the <code>onItem</code> group, you find all the methods to handle an individual item event, such as to transform it (<code>onItem.transform</code>), or invoke a method (<code>onItem.invoke</code>).&#13;
In the <code>onFailure</code> group, you find the methods to handle failures and recover, such as <code>onFailure.recoverWithItem</code> or <code>onFailure.retry</code>.&#13;
The resulting API is more readable, understandable, and navigable.&#13;
As a user, you select the group and navigate across a limited number of methods.</p>&#13;
&#13;
<p>Mutiny’s API is not concise.&#13;
We favor readability and understandability over conciseness.&#13;
Over the years, we heard many times that reactive programming was hard and usable only by senior developers or architects.&#13;
It was a key obstacle to the reactive adoption.&#13;
When we designed Mutiny, we wanted to avoid creating an elitist library.&#13;
This is not to “dumb down” the ideas behind reactive programming, but instead the goal is to strip away mathematical jargon.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mutiny Usage in Quarkus" data-type="sect1"><div class="sect1" id="idm45358827387040">&#13;
<h1>Mutiny Usage in Quarkus</h1>&#13;
&#13;
<p><a data-primary="Mutiny" data-secondary="Quarkus and" data-type="indexterm" id="idm45358827385632"/><a data-primary="Quarkus" data-secondary="Mutiny usage in" data-type="indexterm" id="idm45358827384656"/>To illustrate the common patterns you will see when using Mutiny, we need an example.&#13;
The application is a simple shop, handling users, products, and orders (<a data-type="xref" href="#image:shop-arch">Figure 7-1</a>).&#13;
A user creates orders that contain a list of products.&#13;
How the application is implemented is not relevant for this chapter. Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch08.html#http">8</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.html#data">9</a> will cover how Mutiny integrates on the HTTP and data parts of Quarkus.</p>&#13;
&#13;
<figure><div class="figure" id="image:shop-arch">&#13;
<img alt="Shop Application Architecture" src="assets/rsij_0701.png"/>&#13;
<h6><span class="label">Figure 7-1. </span>Shop application architecture</h6>&#13;
</div></figure>&#13;
&#13;
<p>The application uses nonblocking database clients to avoid blocking when integrating with the database.&#13;
Thus, the APIs of <code>OrderService</code>, <code>UserService</code>, and <code>ProductService</code> are asynchronous and use Mutiny types.&#13;
<code>ShopResource</code>, implementing the HTTP API, also uses Mutiny to query the services and compose the response.</p>&#13;
&#13;
<p>The code is available in the <em>chapter-7/order-example</em> directory, and can be started with <code>mvn quarkus:dev</code>.&#13;
The code uses port 8080 to expose the HTTP API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uni and Multi" data-type="sect1"><div class="sect1" id="idm45358827373936">&#13;
<h1>Uni and Multi</h1>&#13;
&#13;
<p><a data-primary="Multi class (Mutiny)" data-type="indexterm" id="ix_mutiny-adoc1"/><a data-primary="Mutiny" data-secondary="Uni and Multi classes" data-type="indexterm" id="ix_mutiny-adoc2"/><a data-primary="Uni class (Mutiny)" data-type="indexterm" id="ix_mutiny-adoc3"/>Mutiny provides two main classes: <code>Uni</code> and <code>Multi</code>.<sup><a data-type="noteref" href="ch07.html#idm45358827368080" id="idm45358827368080-marker">2</a></sup>&#13;
<code>Uni</code> represents an asynchronous action or operation.&#13;
It can emit a single item or failure, if the represented action fails.&#13;
<code>Multi</code> represents a stream of items.&#13;
It can convey multiple items, as well as a terminal failure or completion event.</p>&#13;
&#13;
<p>Let’s look at two use cases to better understand the differences.&#13;
Imagine you want to retrieve a single user (represented by the <code>UserProfile</code> class) from the database. You will use <code>Uni&lt;UserProfile&gt;</code>, as shown in <a data-type="xref" href="#mutiny::uni">Example 7-1</a>.</p>&#13;
<div data-type="example" id="mutiny::uni">&#13;
<h5><span class="label">Example 7-1. </span>Example of <code>Uni</code> (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">uni</code> <code class="o">=</code> <code class="n">users</code><code class="o">.</code><code class="na">getUserByName</code><code class="o">(</code><code class="n">name</code><code class="o">);</code>&#13;
<code class="k">return</code> <code class="n">uni</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">user</code> <code class="o">-&gt;</code> <code class="n">user</code><code class="o">.</code><code class="na">name</code><code class="o">)</code>&#13;
        <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code><code class="s">"anonymous"</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>You can attach logic to <code>Uni</code>, so you can react when it emits events.&#13;
In the previous snippet, when <code>UserProfile</code> becomes available, we extract the name of the user.&#13;
If a failure happened, we recover with a fallback value.&#13;
The <code>onItem</code> and <code>onFailure</code> groups form the center of the <code>Uni</code> API.</p>&#13;
&#13;
<p><code>Multi</code> can emit 0, 1, <em>n</em>, or an infinite number of items.&#13;
It can also emit a failure, which is a terminal event.&#13;
Finally, when there are no more items to emit, <code>Multi</code> emits the completion event.&#13;
As a result, the API is slightly different.&#13;
Let’s now imagine we need all the users.&#13;
For this case, you use <code>Multi</code>, as shown in <a data-type="xref" href="#mutiny::multi">Example 7-2</a>.</p>&#13;
<div data-type="example" id="mutiny::multi">&#13;
<h5><span class="label">Example 7-2. </span>Example of <code>Multi</code> (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Multi</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">users</code> <code class="o">=</code> <code class="k">this</code><code class="o">.</code><code class="na">users</code><code class="o">.</code><code class="na">getAllUsers</code><code class="o">();</code>&#13;
<code class="k">return</code> <code class="n">users</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">user</code> <code class="o">-&gt;</code> <code class="n">user</code><code class="o">.</code><code class="na">name</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>As for <code>Uni</code>, you can handle events.&#13;
In the snippet, you extract the name of each user.&#13;
So, unlike <a data-type="xref" href="#mutiny::uni">Example 7-1</a>, the code can call the transformation multiple times.&#13;
While the API is somewhat similar, <code>Multi</code> proposes specific groups to select, drop, and collect items; see <a data-type="xref" href="#mutiny::multi-api">Example 7-3</a>.</p>&#13;
<div data-type="example" id="mutiny::multi-api">&#13;
<h5><span class="label">Example 7-3. </span>Example of code using <code>Multi</code> (<em>chapter-7/mutiny-examples/src/main/java/org/acme/MultiApi.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Multi</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">multi</code> <code class="o">=</code> <code class="n">users</code><code class="o">.</code><code class="na">getAllUsers</code><code class="o">();</code>&#13;
<code class="n">multi</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">user</code> <code class="o">-&gt;</code> <code class="n">user</code><code class="o">.</code><code class="na">name</code><code class="o">.</code><code class="na">toLowerCase</code><code class="o">())</code>&#13;
        <code class="o">.</code><code class="na">select</code><code class="o">().</code><code class="na">where</code><code class="o">(</code><code class="n">name</code> <code class="o">-&gt;</code> <code class="n">name</code><code class="o">.</code><code class="na">startsWith</code><code class="o">(</code><code class="s">"l"</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">collect</code><code class="o">().</code><code class="na">asList</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code>&#13;
                <code class="n">list</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"User names starting with `l`"</code> <code class="o">+</code> <code class="n">list</code><code class="o">)</code>&#13;
<code class="o">);</code></pre></div>&#13;
&#13;
<p>As you can see, these two types are inherently event driven.&#13;
However, the set of events each handles differ.&#13;
The API reflects these differences.&#13;
<code>Uni</code> and <code>Multi</code> do not offer the same set of groups, as some are specific to each case (<a data-type="xref" href="#table:uni-multi">Table 7-1</a>).</p>&#13;
<table id="table:uni-multi">&#13;
<caption><span class="label">Table 7-1. </span><code>Uni</code> and <code>Multi</code> use cases</caption>&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th>Events</th>&#13;
<th>Use cases</th>&#13;
<th>Implement Reactive Streams</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>Uni</code></p></td>&#13;
<td><p>Item and failure</p></td>&#13;
<td><p>Remote invocation, asynchronous computation returning a single result</p></td>&#13;
<td><p>No</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Multi</code></p></td>&#13;
<td><p>Item, failure, completion</p></td>&#13;
<td><p>Data streams, potentially unbounded (emitting an infinite number of items)</p></td>&#13;
<td><p>Yes</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>An essential aspect of <code>Uni</code> and <code>Multi</code> is their laziness.&#13;
Holding a reference on <code>Uni</code> and <code>Multi</code> instances does nothing.&#13;
In <a data-type="xref" href="#mutiny::multi-api">Example 7-3</a>, nothing will happen until someone explicitly subscribes (and so expresses an interest), as shown in <a data-type="xref" href="#mutiny::creation-subscription">Example 7-4</a>.</p>&#13;
<div data-type="example" id="mutiny::creation-subscription">&#13;
<h5><span class="label">Example 7-4. </span>Subscription to <code>Uni</code> and <code>Multi</code> (<em>chapter-7/order-example/src/main/java/org/acme/UniMultiExample.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">uni</code> <code class="o">=</code> <code class="n">users</code><code class="o">.</code><code class="na">getUserByName</code><code class="o">(</code><code class="s">"leia"</code><code class="o">);</code>&#13;
<code class="n">Multi</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">multi</code> <code class="o">=</code> <code class="n">users</code><code class="o">.</code><code class="na">getAllUsers</code><code class="o">();</code>&#13;
&#13;
<code class="n">uni</code><code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code>&#13;
        <code class="n">user</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"User is "</code> <code class="o">+</code> <code class="n">user</code><code class="o">.</code><code class="na">name</code><code class="o">),</code>&#13;
        <code class="n">failure</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"D'oh! "</code> <code class="o">+</code> <code class="n">failure</code><code class="o">)</code>&#13;
<code class="o">);</code>&#13;
&#13;
<code class="n">multi</code><code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code>&#13;
        <code class="n">user</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"User is "</code> <code class="o">+</code> <code class="n">user</code><code class="o">.</code><code class="na">name</code><code class="o">),</code>&#13;
        <code class="n">failure</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"D'oh! "</code> <code class="o">+</code> <code class="n">failure</code><code class="o">),</code>&#13;
        <code class="o">()</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"No more user"</code><code class="o">)</code>&#13;
<code class="o">);</code></pre></div>&#13;
&#13;
<p>To subscribe (and thereby trigger the operation) you use the <code>subscribe</code> group.&#13;
In Quarkus, you may not need to subscribe, because if you return <code>Uni</code> or <code>Multi</code> to &#13;
<span class="keep-together">Quarkus</span>, it subscribes for you.&#13;
For instance, you can have the HTTP method shown in <a data-type="xref" href="#mutiny::no-subscription">Example 7-5</a>.</p>&#13;
<div data-type="example" id="mutiny::no-subscription">&#13;
<h5><span class="label">Example 7-5. </span>Quarkus handles the subscription for HTTP methods (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/user/{name}"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getUser</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"name"</code><code class="o">)</code> <code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="c1">//tag::uni[]</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">uni</code> <code class="o">=</code> <code class="n">users</code><code class="o">.</code><code class="na">getUserByName</code><code class="o">(</code><code class="n">name</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">uni</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">user</code> <code class="o">-&gt;</code> <code class="n">user</code><code class="o">.</code><code class="na">name</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code><code class="s">"anonymous"</code><code class="o">);</code>&#13;
    <code class="c1">//end::uni[]</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>When a matching HTTP request arrives, Quarkus calls this method and subscribes on the produced <code>Uni</code>.&#13;
Quarkus will write the HTTP response only when <code>Uni</code> emits an item or failure.<a data-startref="ix_mutiny-adoc3" data-type="indexterm" id="idm45358826886176"/><a data-startref="ix_mutiny-adoc2" data-type="indexterm" id="idm45358826885568"/><a data-startref="ix_mutiny-adoc1" data-type="indexterm" id="idm45358826884960"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mutiny and Flow Control" data-type="sect1"><div class="sect1" id="idm45358827373344">&#13;
<h1>Mutiny and Flow Control</h1>&#13;
&#13;
<p><a data-primary="backpressure" data-secondary="Mutiny and flow control" data-type="indexterm" id="idm45358826883008"/><a data-primary="flow control" data-secondary="Mutiny and" data-type="indexterm" id="idm45358826881808"/><a data-primary="Multi class (Mutiny)" data-secondary="Reactive Streams backpressure protocol and" data-type="indexterm" id="idm45358826880864"/><a data-primary="Mutiny" data-secondary="flow control" data-type="indexterm" id="idm45358826879824"/>As indicated in <a data-type="xref" href="#table:uni-multi">Table 7-1</a>, <code>Multi</code> implements the Reactive Streams backpressure protocol.&#13;
In other words, it implements the Reactive Streams <code>Publisher</code> interface, and <code>Multi</code>’s consumers are the Reactive Streams <code>Subscriber</code>.&#13;
That’s not the case for <code>Uni</code>.</p>&#13;
&#13;
<p>When dealing with a stream sending multiple items, so a <code>Multi</code>, having backpressure support makes sense.&#13;
Under the hood, the subscriber can control the flow and the pace by requesting items when it can handle them.&#13;
It avoids flooding the subscribers with too many items.</p>&#13;
&#13;
<p>When dealing with <code>Uni</code>, subscribing to it is enough to express your interest and capacity to handle the emitted item.&#13;
There’s no need to send another request signal to express your interest.</p>&#13;
&#13;
<p>But, as you have seen in <a data-type="xref" href="ch05.html#reactive-programming">Chapter 5</a>, not every stream can support flow control.&#13;
Streams representing events from the physical world, such as user clicks or time, can’t be slowed.&#13;
In this case, there is a risk of sending too many events to the subscriber.&#13;
That’s why <code>Multi</code> provides the <code>onOverflow</code> group.&#13;
This group monitors the number of items emitted by the upstream source as well as the number of items requested by the downstream subscriber.&#13;
When there are more incoming items than requests, <code>Multi</code> emits an <em>overflow</em> event.&#13;
The <code>onOverflow</code> group allows configuring the desired behavior when this happens.</p>&#13;
&#13;
<p>To illustrate this, let’s imagine a stream producing product recommendations.&#13;
Every second, it sends a new recommended product.&#13;
But time cannot be slowed, so we cannot apply backpressure.&#13;
If the downstream can’t keep up, we would have an overflow.&#13;
To avoid that, if we can’t emit the tick item because of the lack of request, we just drop it, as shown in <a data-type="xref" href="#mutiny::multi-overflow">Example 7-6</a>.</p>&#13;
<div data-type="example" id="mutiny::multi-overflow">&#13;
<h5><span class="label">Example 7-6. </span>Handle overflow with <code>Multi</code> (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Product</code><code class="o">&gt;</code> <code class="nf">getRecommendations</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onOverflow</code><code class="o">().</code><code class="na">drop</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToUniAndConcatenate</code><code class="o">(</code>&#13;
                <code class="n">x</code> <code class="o">-&gt;</code> <code class="n">products</code><code class="o">.</code><code class="na">getRecommendedProduct</code><code class="o">());</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>onOverflow</code> group provides other possibilities, such as buffering the items.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Observing Events" data-type="sect1"><div class="sect1" id="idm45358826863760">&#13;
<h1>Observing Events</h1>&#13;
&#13;
<p><a data-primary="events" data-secondary="observing with Mutiny" data-type="indexterm" id="idm45358826795008"/><a data-primary="Mutiny" data-secondary="observing events with" data-type="indexterm" id="idm45358826793936"/><a data-primary="observability" data-secondary="observing events with Mutiny" data-type="indexterm" id="idm45358826792960"/>Once you have a <code>Uni</code> or <code>Multi</code> instance, it’s natural to observe the events emitted by these instances.&#13;
<a data-primary="invoke method (Mutiny)" data-type="indexterm" id="idm45358826791056"/>For each type of event, an <code>invoke</code> method is called when it sees a matching event; see <a data-type="xref" href="#mutiny::multi-observe">Example 7-7</a>.</p>&#13;
<div data-type="example" id="mutiny::multi-observe">&#13;
<h5><span class="label">Example 7-7. </span>Observe events (<em>chapter-7/mutiny-examples/src/main/java/org/acme/MultiObserve.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">multi</code>&#13;
        <code class="o">.</code><code class="na">onSubscribe</code><code class="o">().</code><code class="na">invoke</code><code class="o">(</code><code class="n">sub</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Subscribed!"</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">onCancellation</code><code class="o">().</code><code class="na">invoke</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Cancelled"</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">invoke</code><code class="o">(</code><code class="n">s</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Item: "</code> <code class="o">+</code> <code class="n">s</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">invoke</code><code class="o">(</code><code class="n">f</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Failure: "</code> <code class="o">+</code> <code class="n">f</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">onCompletion</code><code class="o">().</code><code class="na">invoke</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Completed!"</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code>&#13;
                <code class="n">item</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received: "</code> <code class="o">+</code> <code class="n">item</code><code class="o">)</code>&#13;
<code class="o">);</code></pre></div>&#13;
&#13;
<p>The <code>invoke</code> method does not modify the event; you observe it without changing it.&#13;
The downstream receives the same event you did.&#13;
This method is handy when needed to implement side effects or trace your code.&#13;
For example, we can use it to log when a new user is created or if the creation failed (see <a data-type="xref" href="#mutiny::uni-observe">Example 7-8</a>).</p>&#13;
<div data-type="example" id="mutiny::uni-observe">&#13;
<h5><span class="label">Example 7-8. </span>Observe <code>Uni</code> events (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@POST</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/users/{name}"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code> <code class="nf">createUser</code><code class="o">(</code><code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"name"</code><code class="o">)</code> <code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">users</code><code class="o">.</code><code class="na">createUser</code><code class="o">(</code><code class="n">name</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">invoke</code><code class="o">(</code>&#13;
                <code class="n">l</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"User created: "</code> <code class="o">+</code> <code class="n">name</code> <code class="o">+</code> <code class="s">", id: "</code> <code class="o">+</code> <code class="n">l</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">invoke</code><code class="o">(</code><code class="n">t</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
                    <code class="s">"Cannot create user "</code> <code class="o">+</code> <code class="n">name</code> <code class="o">+</code> <code class="s">": "</code> <code class="o">+</code> <code class="n">t</code><code class="o">.</code><code class="na">getMessage</code><code class="o">())</code>&#13;
            <code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>If you have the application running, you can run this code by using <a data-type="xref" href="#invoke-7-9">Example 7-9</a>.</p>&#13;
<div data-type="example" id="invoke-7-9">&#13;
<h5><span class="label">Example 7-9. </span>Invoke the <code>users</code> endpoint</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; curl -X POST http://localhost:8080/shop/users?name<code class="o">=</code>neo</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Transforming Events" data-type="sect1"><div class="sect1" id="idm45358826508144">&#13;
<h1>Transforming Events</h1>&#13;
&#13;
<p><a data-primary="events" data-secondary="transforming with Mutiny" data-type="indexterm" id="idm45358826506896"/><a data-primary="Mutiny" data-secondary="transforming events with" data-type="indexterm" id="idm45358826528208"/><a data-primary="transforming events (Mutiny)" data-type="indexterm" id="idm45358826527248"/>Most of the time, we need to transform the event.&#13;
Let’s first see how we can transform events synchronously.&#13;
You receive the event, transform it, and produce the result as a new event. For each type of event, a <code>transform</code> method is called when it sees a matching event, as shown in <a data-type="xref" href="#mutiny::multi-transform">Example 7-10</a>.</p>&#13;
<div data-type="example" id="mutiny::multi-transform">&#13;
<h5><span class="label">Example 7-10. </span>Transform events (<em>chapter-7/mutiny-examples/src/main/java/org/acme/MultiTransform.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Multi</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">transformed</code> <code class="o">=</code> <code class="n">multi</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="nl">String:</code><code class="o">:</code><code class="n">toUpperCase</code><code class="o">)</code>&#13;
        <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="nl">MyBusinessException:</code><code class="o">:</code><code class="k">new</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>Unlike <code>invoke</code>, <code>transform</code> produces a new event.&#13;
It invokes the passed function and sends the result to the downstream subscriber.</p>&#13;
&#13;
<p>The synchronous nature of <code>transform</code> is important.&#13;
After receiving the event, <code>transform</code> calls the transformation logic and emits the result downstream.&#13;
If the transformation logic takes a long time to complete, <code>transform</code> waits until the logic terminates.&#13;
So, use <code>transform</code> when the transformation is fast enough.</p>&#13;
&#13;
<p>For example, the following method retrieves the list of products, capitalizes their names consistently, and builds the representation (<code>ProductModel</code>).&#13;
For each product, <code>transform</code> extracts the name and applies the transformation.&#13;
This synchronous process is fast.&#13;
It emits the result downstream immediately, as shown in <a data-type="xref" href="#mutiny::multi-transform-product">Example 7-11</a>.</p>&#13;
<div data-type="example" id="mutiny::multi-transform-product">&#13;
<h5><span class="label">Example 7-11. </span>Transform products (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/products"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">ProductModel</code><code class="o">&gt;</code> <code class="nf">products</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">products</code><code class="o">.</code><code class="na">getAllProducts</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">p</code> <code class="o">-&gt;</code> <code class="n">captializeAllFirstLetter</code><code class="o">(</code><code class="n">p</code><code class="o">.</code><code class="na">name</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="nl">ProductModel:</code><code class="o">:</code><code class="k">new</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Chaining Asynchronous Actions" data-type="sect1"><div class="sect1" id="idm45358826442720">&#13;
<h1>Chaining Asynchronous Actions</h1>&#13;
&#13;
<p><a data-primary="asynchronous actions, chaining with Mutiny" data-type="indexterm" id="ix_mutiny-adoc4"/><a data-primary="chaining asynchronous actions" data-type="indexterm" id="ix_mutiny-adoc5"/><a data-primary="Mutiny" data-secondary="chaining asynchronous actions with" data-type="indexterm" id="ix_mutiny-adoc6"/>The <code>transform</code> method can process events synchronously, but what if we need to invoke an asynchronous process?&#13;
Imagine that you receive an event, and need to invoke a remote service or interact with a database.&#13;
You can’t use <code>transform</code>, as these methods should be asynchronous (otherwise, they would block, which would be against the reactive principles).&#13;
You need to <em>wait</em> until the asynchronous computation completes.</p>&#13;
&#13;
<p>How can we express this using the Mutiny lingo?&#13;
It would mean transforming an event, but unlike <code>transform</code> returning a <em>plain</em> result, it returns an asynchronous structure: another <code>Uni</code> or <code>Multi</code>.&#13;
What does that look like? Take a look at <a data-type="xref" href="#mutiny:uni-transform-async">Example 7-12</a>.</p>&#13;
<div data-type="example" id="mutiny:uni-transform-async">&#13;
<h5><span class="label">Example 7-12. </span>Chain asynchronous actions (<em>chapter-7/mutiny-examples/src/main/java/org/acme/UniTransformAsync.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">uni</code>&#13;
    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToUni</code><code class="o">(</code><code class="n">item</code> <code class="o">-&gt;</code> <code class="n">callMyRemoteService</code><code class="o">(</code><code class="n">item</code><code class="o">))</code>&#13;
    <code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code><code class="n">s</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received: "</code> <code class="o">+</code> <code class="n">s</code><code class="o">));</code>&#13;
&#13;
<code class="n">uni</code>&#13;
    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMulti</code><code class="o">(</code><code class="n">s</code> <code class="o">-&gt;</code> <code class="n">getAMulti</code><code class="o">(</code><code class="n">s</code><code class="o">))</code>&#13;
    <code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code>&#13;
        <code class="n">s</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received item: "</code> <code class="o">+</code> <code class="n">s</code><code class="o">),</code>&#13;
        <code class="o">()</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Done!"</code><code class="o">)</code>&#13;
<code class="o">);</code></pre></div>&#13;
&#13;
<p><code>transformToUni</code> and <code>transformToMulti</code> provide the ability to produce a <code>Uni</code> or a <code>Multi</code> instance.<sup><a data-type="noteref" href="ch07.html#idm45358826255536" id="idm45358826255536-marker">3</a></sup>&#13;
When you receive an item, Mutiny invokes the function returning <code>Uni</code> or <code>Multi</code>.&#13;
Then, it emits the events downstream from this <code>Uni</code> or <code>Multi</code>.&#13;
In <a data-type="xref" href="#mutiny::uni-transform-async-order">Example 7-13</a>, we retrieve the list of orders for a specific user (identified by its name).</p>&#13;
<div data-type="example" id="mutiny::uni-transform-async-order">&#13;
<h5><span class="label">Example 7-13. </span>Retrieve order for a specific user (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/orders/{user}"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">getOrdersForUser</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"user"</code><code class="o">)</code> <code class="n">String</code> <code class="n">username</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">users</code><code class="o">.</code><code class="na">getUserByName</code><code class="o">(</code><code class="n">username</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMulti</code><code class="o">(</code><code class="n">user</code> <code class="o">-&gt;</code> <code class="n">orders</code><code class="o">.</code><code class="na">getOrderForUser</code><code class="o">(</code><code class="n">user</code><code class="o">));</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>This code retrieves the user, and when it receives the user, the code then retrieves the orders.&#13;
The <code>getOrderForUser</code> method returns <code>Multi&lt;Order&gt;</code>, so the result is  <code>Multi&lt;Order&gt;</code>.</p>&#13;
&#13;
<p>If you look carefully at the preceding code, you will say, “Hey! You’re forgetting something! How does that work when we chain from a <code>Multi</code> and not a <code>Uni</code>?”&#13;
You are right; we need to discuss the <code>Multi</code> case.&#13;
How would you transform each item of a <code>Multi</code> into another <code>Uni</code> or <code>Multi</code>?</p>&#13;
&#13;
<p>Let’s illustrate the problem with an example.&#13;
Imagine you need to retrieve the orders for all the users.&#13;
So, instead of having the username as in <a data-type="xref" href="#mutiny::uni-transform-async-order">Example 7-13</a>, we need to retrieve all the users, and for each retrieve the orders.&#13;
<a data-type="xref" href="#mutiny::orders-per-user">Example 7-14</a> shows the resulting code.</p>&#13;
<div data-type="example" id="mutiny::orders-per-user">&#13;
<h5><span class="label">Example 7-14. </span>Retrieve the orders for each user using <code>concatenate</code> (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/orders"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">getOrdersPerUser</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">users</code><code class="o">.</code><code class="na">getAllUsers</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMultiAndConcatenate</code><code class="o">(</code>&#13;
                <code class="n">user</code> <code class="o">-&gt;</code> <code class="n">orders</code><code class="o">.</code><code class="na">getOrderForUser</code><code class="o">(</code><code class="n">user</code><code class="o">));</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>You can immediately spot a difference.&#13;
Instead of <code>transformToMulti</code>, we have <code>transformToMultiAndConcatenate</code>.&#13;
But why <em>AndConcatenate</em>?&#13;
It relates to the order of the item sent downstream.&#13;
It gets the <code>Multi</code> for the first user, emits the items downstream, and then handles the one for the next user, and so on.&#13;
In other words, it takes the <code>Multi</code> instances one by one and concatenates them.&#13;
This approach preserves the order, but also limits the concurrency as we retrieve the orders, one user at a time.</p>&#13;
&#13;
<p>If you don’t need to preserve the order, you can use the <code>transformToMultiAndMerge</code> method.<sup><a data-type="noteref" href="ch07.html#idm45358826140656" id="idm45358826140656-marker">4</a></sup> In this case, it invokes <code>getOrderForUser</code> concurrently.&#13;
It merges the items from the resulting <code>Multi</code> as they come, and so may interleave the orders from different users (<a data-type="xref" href="#mutiny::orders-per-user-merge">Example 7-15</a>).</p>&#13;
<div data-type="example" id="mutiny::orders-per-user-merge">&#13;
<h5><span class="label">Example 7-15. </span>Retrieve the orders for each user by using merge</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/orders"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">getOrdersPerUser</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">users</code><code class="o">.</code><code class="na">getAllUsers</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMultiAndMerge</code><code class="o">(</code><code class="n">user</code> <code class="o">-&gt;</code> <code class="n">orders</code><code class="o">.</code><code class="na">getOrderForUser</code><code class="o">(</code><code class="n">user</code><code class="o">));</code>&#13;
<code class="o">}</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><em>chapter-7/mutiny-examples/src/main/java/org/acme/MultiTransformAsync.java</em> lets you execute these examples. They highlight the ordering difference.<a data-startref="ix_mutiny-adoc6" data-type="indexterm" id="idm45358826073568"/><a data-startref="ix_mutiny-adoc5" data-type="indexterm" id="idm45358826072960"/><a data-startref="ix_mutiny-adoc4" data-type="indexterm" id="idm45358826072320"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Recovering from Failure" data-type="sect1"><div class="sect1" id="idm45358826373712">&#13;
<h1>Recovering from Failure</h1>&#13;
&#13;
<p><a data-primary="events" data-secondary="failures as" data-type="indexterm" id="idm45358826036096"/><a data-primary="failure handling" data-secondary="recovery with Mutiny" data-type="indexterm" id="idm45358826035248"/><a data-primary="Mutiny" data-secondary="recovering from failure" data-type="indexterm" id="idm45358826034400"/>As we said, failures are inevitable.&#13;
We must handle them.</p>&#13;
&#13;
<p>What can be done in such an unfortunate case?&#13;
In the Mutiny world, failures are events.&#13;
So, you can observe and process them.&#13;
You can use <code>invoke</code> or <code>transform</code> as for any other events.&#13;
But you can also handle the failure and recover gracefully.</p>&#13;
&#13;
<p>One of the most common approaches consists of recovering with a specific fallback item.&#13;
Let’s imagine we want to create a new user, but the insertion fails because the name needs to be unique.&#13;
We can return a message indicating the failure, as shown in Example 7-16.</p>&#13;
<div data-type="example" id="mutiny::recover-with-item">&#13;
<h5><span class="label">Example 7-16. </span>Recover from failure with a fallback item (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">addUser</code><code class="o">(</code><code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">users</code><code class="o">.</code><code class="na">createUser</code><code class="o">(</code><code class="n">name</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">id</code> <code class="o">-&gt;</code> <code class="s">"New User "</code> <code class="o">+</code> <code class="n">name</code> <code class="o">+</code> <code class="s">" inserted"</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code>&#13;
                <code class="n">failure</code> <code class="o">-&gt;</code> <code class="s">"User not inserted: "</code> <code class="o">+</code> <code class="n">failure</code><code class="o">.</code><code class="na">getMessage</code><code class="o">());</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>While a failure is an event, it’s a terminal one.&#13;
That’s not a problem if you are dealing with <code>Uni</code>; you won’t get the item, just the failure.&#13;
So, the <code>Uni</code> would replace the failure with the fallback item.&#13;
With <code>Multi</code>, you won’t get any more items after the failure.&#13;
The recovery emits the fallback item followed by the completion event.</p>&#13;
&#13;
<p>Another common possibility is to retry.&#13;
Remember, retry only if your system can endure it.&#13;
In this case (and only in this case), you can retry.&#13;
Retry resubscribing to the upstream source, as shown in <a data-type="xref" href="#mutiny::retry">Example 7-17</a>.</p>&#13;
<div data-type="example" id="mutiny::retry">&#13;
<h5><span class="label">Example 7-17. </span>Retry on failure</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">addUser</code><code class="o">(</code><code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">users</code><code class="o">.</code><code class="na">createUser</code><code class="o">(</code><code class="n">name</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">id</code> <code class="o">-&gt;</code> <code class="s">"New User "</code> <code class="o">+</code> <code class="n">name</code> <code class="o">+</code> <code class="s">" inserted"</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">retry</code><code class="o">().</code><code class="na">atMost</code><code class="o">(</code><code class="mi">3</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>You can limit the number of retries or introduce a delay between them by using <code>atMost</code> and configuring the backoff; see <a data-type="xref" href="#mutiny::retry-at-most">Example 7-18</a>.</p>&#13;
<div data-type="example" id="mutiny::retry-at-most">&#13;
<h5><span class="label">Example 7-18. </span>Retry on failure at most n times with delay between attempts (<em>chapter-7/mutiny-examples/src/main/java/org/acme/UniFailure.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">retryAtMost</code> <code class="o">=</code> <code class="n">uni</code>&#13;
        <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">retry</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">withBackOff</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">3</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">atMost</code><code class="o">(</code><code class="mi">5</code><code class="o">);</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><em>chapter-7/mutiny-examples/src/main/java/org/acme/UniFailure.java</em> lets you execute these examples to help you understand the various possibilities.</p>&#13;
</div>&#13;
&#13;
<p>The <code>onFailure</code> group contains a lot more possibilities.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Combining and Joining Items" data-type="sect1"><div class="sect1" id="idm45358826070928">&#13;
<h1>Combining and Joining Items</h1>&#13;
&#13;
<p><a data-primary="combining items" data-type="indexterm" id="ix_mutiny-adoc7"/><a data-primary="joining items (Mutiny)" data-type="indexterm" id="ix_mutiny-adoc8"/><a data-primary="Mutiny" data-secondary="combining/joining items" data-type="indexterm" id="ix_mutiny-adoc9"/>The next common pattern consists of combining the items from multiple upstream sources.&#13;
For example, imagine we want to generate recommendations.&#13;
We would pick a random user and a recommended product.&#13;
We could sequentially execute both, but they are independent, so we can execute them concurrently, and when we have both results, generate the recommendation (<a data-type="xref" href="#mutiny::recommended-product">Example 7-19</a>).</p>&#13;
<div data-type="example" id="mutiny::recommended-product">&#13;
<h5><span class="label">Example 7-19. </span>Combine <code>Uni</code> instances (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/random-recommendation"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getRecommendation</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">uni1</code> <code class="o">=</code> <code class="n">users</code><code class="o">.</code><code class="na">getRandomUser</code><code class="o">();</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Product</code><code class="o">&gt;</code> <code class="n">uni2</code> <code class="o">=</code> <code class="n">products</code><code class="o">.</code><code class="na">getRecommendedProduct</code><code class="o">();</code>&#13;
    <code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">combine</code><code class="o">().</code><code class="na">all</code><code class="o">().</code><code class="na">unis</code><code class="o">(</code><code class="n">uni1</code><code class="o">,</code> <code class="n">uni2</code><code class="o">).</code><code class="na">asTuple</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">tuple</code> <code class="o">-&gt;</code> <code class="s">"Hello "</code> <code class="o">+</code> <code class="n">tuple</code><code class="o">.</code><code class="na">getItem1</code><code class="o">().</code><code class="na">name</code> <code class="o">+</code>&#13;
                    <code class="s">", we recommend you "</code>&#13;
                    <code class="o">+</code> <code class="n">tuple</code><code class="o">.</code><code class="na">getItem2</code><code class="o">().</code><code class="na">name</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><a data-primary="Uni class (Mutiny)" data-secondary="combining Uni operations" data-type="indexterm" id="idm45358825808624"/>This snippet gets two <code>Uni</code>s. The first one retrieves a random user, and the second one gets a recommended product.&#13;
Then we combine both and aggregate their results into a tuple.&#13;
When both operations complete, Mutiny collects the items into a tuple and emits this tuple downstream.&#13;
We can transform it and generate the recommendation.&#13;
If the <code>Uni</code> fails, it propagates the failure downstream.</p>&#13;
&#13;
<p>Combining <code>Uni</code> operations is common when we want to execute operations concurrently and join their results.&#13;
<a data-primary="Multi class (Mutiny)" data-secondary="combining Multi operations" data-type="indexterm" id="idm45358825698720"/>But we can do the same with <code>Multi</code> too.&#13;
In this case, we associate the items from several <code>Multi</code> operations.&#13;
For example, we can generate a stream of recommendations, associating random users and recommended products, as shown in <a data-type="xref" href="#mutiny::recommented-products">Example 7-20</a>.</p>&#13;
<div data-type="example" id="mutiny::recommented-products">&#13;
<h5><span class="label">Example 7-20. </span>Join <code>Multi</code>s (<em>chapter-7/order-example/src/main/java/org/acme/ShopResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/random-recommendations"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getRandomRecommendations</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">Multi</code><code class="o">&lt;</code><code class="n">UserProfile</code><code class="o">&gt;</code> <code class="n">u</code> <code class="o">=</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code>&#13;
        <code class="n">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">)).</code><code class="na">onOverflow</code><code class="o">().</code><code class="na">drop</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToUniAndConcatenate</code><code class="o">(</code>&#13;
            <code class="n">x</code> <code class="o">-&gt;</code> <code class="n">users</code><code class="o">.</code><code class="na">getRandomUser</code><code class="o">());</code>&#13;
    <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Product</code><code class="o">&gt;</code> <code class="n">p</code> <code class="o">=</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code>&#13;
        <code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">)).</code><code class="na">onOverflow</code><code class="o">().</code><code class="na">drop</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToUniAndConcatenate</code><code class="o">(</code>&#13;
            <code class="n">x</code> <code class="o">-&gt;</code> <code class="n">products</code><code class="o">.</code><code class="na">getRecommendedProduct</code><code class="o">());</code>&#13;
&#13;
    <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createBy</code><code class="o">().</code><code class="na">combining</code><code class="o">().</code><code class="na">streams</code><code class="o">(</code><code class="n">u</code><code class="o">,</code> <code class="n">p</code><code class="o">).</code><code class="na">asTuple</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">tuple</code> <code class="o">-&gt;</code> <code class="s">"Hello "</code>&#13;
                    <code class="o">+</code> <code class="n">tuple</code><code class="o">.</code><code class="na">getItem1</code><code class="o">().</code><code class="na">name</code>&#13;
                        <code class="o">+</code> <code class="s">", we recommend you "</code>&#13;
                    <code class="o">+</code> <code class="n">tuple</code><code class="o">.</code><code class="na">getItem2</code><code class="o">().</code><code class="na">name</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>When joining <code>Multi</code>s, the resulting stream completes as soon as one of the joined <code>Multi</code> sends the completion event.&#13;
Indeed, it won’t be possible to combine the items anymore.<a data-startref="ix_mutiny-adoc9" data-type="indexterm" id="idm45358825692320"/><a data-startref="ix_mutiny-adoc8" data-type="indexterm" id="idm45358825520032"/><a data-startref="ix_mutiny-adoc7" data-type="indexterm" id="idm45358825519360"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Selecting Items" data-type="sect1"><div class="sect1" id="idm45358825518560">&#13;
<h1>Selecting Items</h1>&#13;
&#13;
<p><a data-primary="Mutiny" data-secondary="selecting items for propagation downstream" data-type="indexterm" id="idm45358825517056"/><a data-primary="selecting items (Mutiny)" data-type="indexterm" id="idm45358825515984"/>When dealing with <code>Multi</code>, you may want to select the items to propagate downstream and discard the others.&#13;
For example, we can retrieve all the orders and then select only the orders containing more than three products (see <a data-type="xref" href="#mutiny:select-where">Example 7-21</a>).</p>&#13;
<div data-type="example" id="mutiny:select-where">&#13;
<h5><span class="label">Example 7-21. </span>Select items (<em>chapter-7/order-example/src/main/java/org/acme/OrderService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">getLargeOrders</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="nf">getAllOrders</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">select</code><code class="o">().</code><code class="na">where</code><code class="o">(</code><code class="n">order</code> <code class="o">-&gt;</code> <code class="n">order</code><code class="o">.</code><code class="na">products</code><code class="o">.</code><code class="na">size</code><code class="o">()</code> <code class="o">&gt;</code> <code class="mi">3</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>select.where</code> operation lets you select the item.&#13;
For each item, the operation calls the predicates and decides whether the item should be propagated downstream.&#13;
It drops the items not passing the predicate.</p>&#13;
&#13;
<p>An asynchronous variant of the <code>select.when</code> operator is also available.&#13;
It lets you select the items to keep, using an asynchronous predicate.&#13;
<a data-type="xref" href="#mutiny::select-when">Example 7-22</a> shows how to select the orders for a specific username.&#13;
For each order, the code retrieves the associated user and selects only when the username matches.</p>&#13;
<div data-type="example" id="mutiny::select-when">&#13;
<h5><span class="label">Example 7-22. </span>Select items with an asynchronous predicate (<em>chapter-7/order-example/src/main/java/org/acme/OrderService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">getOrdersForUsername</code><code class="o">(</code><code class="n">String</code> <code class="n">username</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="nf">getAllOrders</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">select</code><code class="o">().</code><code class="na">when</code><code class="o">(</code><code class="n">order</code> <code class="o">-&gt;</code>&#13;
                    <code class="n">users</code><code class="o">.</code><code class="na">getUserByName</code><code class="o">(</code><code class="n">username</code><code class="o">)</code>&#13;
                        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">u</code> <code class="o">-&gt;</code> <code class="n">u</code><code class="o">.</code><code class="na">name</code><code class="o">.</code><code class="na">equalsIgnoreCase</code><code class="o">(</code><code class="n">username</code><code class="o">))</code>&#13;
            <code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Selection can also drop any duplicate items.&#13;
In <a data-type="xref" href="#mutiny::select-distinct">Example 7-23</a>, we list the ordered products.</p>&#13;
<div class="pagebreak-before less_space" data-type="example" id="mutiny::select-distinct">&#13;
<h5><span class="label">Example 7-23. </span>Select distinct items (<em>chapter-7/order-example/src/main/java/org/acme/ProductService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Product</code><code class="o">&gt;</code> <code class="nf">getAllOrderedProducts</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">orders</code><code class="o">.</code><code class="na">getAllOrders</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToIterable</code><code class="o">(</code><code class="n">order</code> <code class="o">-&gt;</code> <code class="n">order</code><code class="o">.</code><code class="na">products</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">select</code><code class="o">().</code><code class="na">distinct</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>For each order, we retrieve the products and generate <code>Multi&lt;Product&gt;</code>.&#13;
Then, we select only distinct items, dropping duplicates.&#13;
Note that we can’t use <code>distinct</code> on unbounded streams, as it needs to keep in memory all the already seen items.</p>&#13;
&#13;
<p>In addition to selection, Mutiny provides a <code>skip</code> group.&#13;
It provides the opposite functionality, and so allows skipping items matching predicates and repetitions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Collecting Items" data-type="sect1"><div class="sect1" id="idm45358825517968">&#13;
<h1>Collecting Items</h1>&#13;
&#13;
<p><a data-primary="collections" data-type="indexterm" id="idm45358825348208"/><a data-primary="lists, collecting items for" data-type="indexterm" id="idm45358825347504"/><a data-primary="Mutiny" data-secondary="collecting items with" data-type="indexterm" id="idm45358825346864"/>Finally, when dealing with bounded <code>Multi</code>, you may want to accumulate the items into a list or a collection.&#13;
The resulting structure is emitted when the <code>Multi</code> &#13;
<span class="keep-together">completes</span>.</p>&#13;
&#13;
<p>Let’s reuse the previous example.&#13;
We know that the set of ordered products is bounded, so, we can collect the product into a list, as shown in <a data-type="xref" href="#mutiny::collect">Example 7-24</a>.</p>&#13;
<div data-type="example" id="mutiny::collect">&#13;
<h5><span class="label">Example 7-24. </span>Collect items into a list (<em>chapter-7/order-example/src/main/java/org/acme/ProductService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Product</code><code class="o">&gt;&gt;</code> <code class="nf">getAllOrderedProductsAsList</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="nf">getAllOrderedProducts</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">collect</code><code class="o">().</code><code class="na">asList</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Note that the method returns <code>Uni&lt;List&lt;Product&gt;&gt;</code>.&#13;
The method emits the list (containing the products) when the <code>Multi</code> returned by <code>getAllOrderedProducts</code> &#13;
<span class="keep-together">completes</span>.</p>&#13;
&#13;
<p>The <code>collect</code> group provides other methods to aggregate items into maps, collections, or events, using your own collector (<a data-type="xref" href="#mutiny::collect-2">Example 7-25</a>).</p>&#13;
<div data-type="example" id="mutiny::collect-2">&#13;
<h5><span class="label">Example 7-25. </span>Other collection methods</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">itemsAsList</code> <code class="o">=</code> <code class="n">multi</code><code class="o">.</code><code class="na">collect</code><code class="o">().</code><code class="na">asList</code><code class="o">();</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">itemsAsMap</code> <code class="o">=</code> <code class="n">multi</code><code class="o">.</code><code class="na">collect</code><code class="o">().</code><code class="na">asMap</code><code class="o">(</code><code class="n">item</code> <code class="o">-&gt;</code>&#13;
    <code class="n">getKeyForItem</code><code class="o">(</code><code class="n">item</code><code class="o">));</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code> <code class="n">count</code> <code class="o">=</code> <code class="n">multi</code><code class="o">.</code><code class="na">collect</code><code class="o">().</code><code class="na">with</code><code class="o">(</code><code class="n">Collectors</code><code class="o">.</code><code class="na">counting</code><code class="o">());</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45358825287328">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>This chapter was a brief introduction to the Mutiny API.&#13;
It did not provide a complete overview of the possibilities but presented key patterns we will use later in this book. Remember:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Mutiny is an event-driven reactive programming API.</p>&#13;
</li>&#13;
<li>&#13;
<p>You observe and transform events.</p>&#13;
</li>&#13;
<li>&#13;
<p>Mutiny provides two main classes: <code>Uni</code> and <code>Multi</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>The Mutiny API is navigable and offers you guidance to pick the right operator.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>With this in mind, we can now start using the reactive services and facilities offered by Quarkus.<a data-startref="ix_mutiny-adoc0" data-type="indexterm" id="idm45358825170112"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45358827414448"><sup><a href="ch07.html#idm45358827414448-marker">1</a></sup> Quarkus integrates Mutiny, which is a separate project that can be embedded anywhere.</p><p data-type="footnote" id="idm45358827368080"><sup><a href="ch07.html#idm45358827368080-marker">2</a></sup> The Mutiny name comes from the contraction of <code>Multi</code> and <code>Uni</code>.</p><p data-type="footnote" id="idm45358826255536"><sup><a href="ch07.html#idm45358826255536-marker">3</a></sup> The <code>transformToUni</code> and <code>transformToMulti</code> operations are generally called <code>flatMap</code> in traditional reactive programming libraries.</p><p data-type="footnote" id="idm45358826140656"><sup><a href="ch07.html#idm45358826140656-marker">4</a></sup> <code>transformToMultiAndConcatenate</code> is called <code>concatMap</code> in traditional reactive programming libraries.  <span class="keep-together"><code>transformToMultiAndMerge</code></span> is generally named <code>flatMap</code>.</p></div></div></section></body></html>