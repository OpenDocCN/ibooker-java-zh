<html><head></head><body>
<div id="sbo-rt-content"><section data-nutshell-tab="File Handling and I/O" data-pdf-bookmark="Chapter 10. File Handling and I/O" data-type="chapter" epub:type="chapter"><div class="chapter" id="javanut8-CHP-10">
<h1><span class="label">Chapter 10. </span>File Handling and I/O</h1>
<p><a data-primary="I/O (input/output)" data-type="indexterm" id="ix_ch10-asciidoc0"/>Java has had input/output (I/O) support since the very first version.
However, due to Java’s strong desire for platform independence, the
earlier versions of I/O functionality emphasized portability over
functionality. As a result, they were not always easy to work with.</p>
<p>We’ll see later in the chapter how the original APIs have been supplemented—they are now rich, fully featured, and very easy to develop with.
Let’s kick off the chapter by looking at the original, “classic” approach to Java I/O, which the more modern approaches layer on top of.</p>
<section data-pdf-bookmark="Classic Java I/O" data-type="sect1"><div class="sect1" id="javanut8-CHP-10-SECT-1">
<h1>Classic Java I/O</h1>
<p><a data-primary="classic Java I/O" data-type="indexterm" id="ix_ch10-asciidoc1"/><a data-primary="I/O (input/output)" data-secondary="classic Java I/O" data-type="indexterm" id="ix_ch10-asciidoc2"/>The <code>File</code> class is the cornerstone of Java’s original way to do
file I/O. This abstraction can represent both files and directories but
in doing so is sometimes a bit cumbersome to deal with, leading to
code like this:</p>
<pre data-code-language="java" data-type="programlisting"><code class="c1">// Get a file object to represent the user's home directory</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">homedir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="na">getProperty</code><code class="p">(</code><code class="s">"user.home"</code><code class="p">));</code><code class="w"/>

<code class="c1">// Create an object to represent a config file (should</code><code class="w"/>
<code class="c1">// already be present in the home directory)</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">f</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="n">homedir</code><code class="p">,</code><code class="w"> </code><code class="s">"app.conf"</code><code class="p">);</code><code class="w"/>

<code class="c1">// Check the file exists, really is a file, and is readable</code><code class="w"/>
<code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="na">exists</code><code class="p">()</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">isFile</code><code class="p">()</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">canRead</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>

<code class="w">  </code><code class="c1">// Create a file object for a new configuration directory</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">configdir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="n">homedir</code><code class="p">,</code><code class="w"> </code><code class="s">".configdir"</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="c1">// And create it</code><code class="w"/>
<code class="w">  </code><code class="n">configdir</code><code class="p">.</code><code class="na">mkdir</code><code class="p">();</code><code class="w"/>

<code class="w">  </code><code class="c1">// Finally, move the config file to its new home</code><code class="w"/>
<code class="w">  </code><code class="n">f</code><code class="p">.</code><code class="na">renameTo</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="n">configdir</code><code class="p">,</code><code class="w"> </code><code class="s">".config"</code><code class="p">));</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>This shows some of the flexibility possible with the <code>File</code> class, but
it also demonstrates some of the problems with the abstraction. It is very
general and thus requires a lot of methods to interrogate a <code>File</code>
object in order to determine what it actually represents and its
capabilities.</p>
<section data-pdf-bookmark="Files" data-type="sect2"><div class="sect2" id="idm45927715001744">
<h2>Files</h2>
<p><a data-primary="classic Java I/O" data-secondary="File class" data-type="indexterm" id="ix_ch10-asciidoc3"/><a data-primary="File class" data-secondary="classic Java I/O" data-type="indexterm" id="ix_ch10-asciidoc4"/>The <code>File</code> class has a very large number of methods on it, but some
basic functionality (notably a way to read the actual contents of a file) is
not, and never has been, provided directly. The following is a quick summary of <code>File</code> methods:</p>
<pre data-code-language="java" data-type="programlisting"><code class="c1">// Permissions management</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">canX</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">canExecute</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">canR</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">canRead</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">canW</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">canWrite</code><code class="p">();</code><code class="w"/>

<code class="kt">boolean</code><code class="w"> </code><code class="n">ok</code><code class="p">;</code><code class="w"/>
<code class="n">ok</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">setReadOnly</code><code class="p">();</code><code class="w"/>
<code class="n">ok</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">setExecutable</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code><code class="w"/>
<code class="n">ok</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">setReadable</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code><code class="w"/>
<code class="n">ok</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">setWritable</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code><code class="w"/>

<code class="c1">// Different views of the file's name</code><code class="w"/>
<code class="n">File</code><code class="w"> </code><code class="n">absF</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getAbsoluteFile</code><code class="p">();</code><code class="w"/>
<code class="n">File</code><code class="w"> </code><code class="n">canF</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getCanonicalFile</code><code class="p">();</code><code class="w"/>
<code class="n">String</code><code class="w"> </code><code class="n">absName</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getAbsolutePath</code><code class="p">();</code><code class="w"/>
<code class="n">String</code><code class="w"> </code><code class="n">canName</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getCanonicalPath</code><code class="p">();</code><code class="w"/>
<code class="n">String</code><code class="w"> </code><code class="n">name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getName</code><code class="p">();</code><code class="w"/>
<code class="n">String</code><code class="w"> </code><code class="n">pName</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getParent</code><code class="p">();</code><code class="w"/>
<code class="n">URI</code><code class="w"> </code><code class="n">fileURI</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">toURI</code><code class="p">();</code><code class="w"> </code><code class="c1">// Create URI for File path</code><code class="w"/>

<code class="c1">// File metadata</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">exists</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">exists</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">isAbs</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">isAbsolute</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">isDir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">isDirectory</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">isFile</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">isFile</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">isHidden</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">isHidden</code><code class="p">();</code><code class="w"/>
<code class="kt">long</code><code class="w"> </code><code class="n">modTime</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">lastModified</code><code class="p">();</code><code class="w"> </code><code class="c1">// milliseconds since epoch</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">updateOK</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">setLastModified</code><code class="p">(</code><code class="n">updateTime</code><code class="p">);</code><code class="w"> </code><code class="c1">// milliseconds</code><code class="w"/>
<code class="kt">long</code><code class="w"> </code><code class="n">fileLen</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">length</code><code class="p">();</code><code class="w"/>

<code class="c1">// File management operations</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">renamed</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">renameTo</code><code class="p">(</code><code class="n">destFile</code><code class="p">);</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">deleted</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">delete</code><code class="p">();</code><code class="w"/>

<code class="c1">// Create won't overwrite existing file</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">createdOK</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">createNewFile</code><code class="p">();</code><code class="w"/>

<code class="c1">// Temporary file handling</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">tmp</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">File</code><code class="p">.</code><code class="na">createTempFile</code><code class="p">(</code><code class="s">"my-tmp"</code><code class="p">,</code><code class="w"> </code><code class="s">".tmp"</code><code class="p">);</code><code class="w"/>
<code class="n">tmp</code><code class="p">.</code><code class="na">deleteOnExit</code><code class="p">();</code><code class="w"/>

<code class="c1">// Directory handling</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">createdDir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">dir</code><code class="p">.</code><code class="na">mkdir</code><code class="p">();</code><code class="w"> </code><code class="c1">// Non-recursive create only</code><code class="w"/>
<code class="n">String</code><code class="o">[]</code><code class="w"> </code><code class="n">fileNames</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">dir</code><code class="p">.</code><code class="na">list</code><code class="p">();</code><code class="w"/>
<code class="n">File</code><code class="o">[]</code><code class="w"> </code><code class="n">files</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">dir</code><code class="p">.</code><code class="na">listFiles</code><code class="p">();</code><code class="w"/></pre>
<p>The <code>File</code> class also has a few methods on it that aren’t a perfect fit
for the abstraction. They largely involve interrogating the filesystem
(e.g., inquiring about available free space) that the file resides on:<a data-startref="ix_ch10-asciidoc4" data-type="indexterm" id="idm45927714730432"/><a data-startref="ix_ch10-asciidoc3" data-type="indexterm" id="idm45927714729824"/></p>
<pre data-code-language="java" data-type="programlisting"><code class="kt">long</code><code class="w"> </code><code class="n">free</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getFreeSpace</code><code class="p">();</code><code class="w"/>
<code class="kt">long</code><code class="w"> </code><code class="n">total</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getTotalSpace</code><code class="p">();</code><code class="w"/>
<code class="kt">long</code><code class="w"> </code><code class="n">usable</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">getUsableSpace</code><code class="p">();</code><code class="w"/>

<code class="n">File</code><code class="o">[]</code><code class="w"> </code><code class="n">roots</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">File</code><code class="p">.</code><code class="na">listRoots</code><code class="p">();</code><code class="w"> </code><code class="c1">// all available Filesystem roots</code><code class="w"/></pre>
</div></section>
<section data-pdf-bookmark="I/O Streams" data-type="sect2"><div class="sect2" id="idm45927714450992">
<h2>I/O Streams</h2>
<p><a data-primary="classic Java I/O" data-secondary="stream abstraction" data-type="indexterm" id="idm45927714439360"/><a data-primary="stream abstraction" data-type="indexterm" id="idm45927714333744"/>The I/O stream abstraction (not to be confused with the streams that are used when dealing with the Java 8 Collection APIs) was present in Java 1.0, as a way of dealing with sequential streams of bytes from disks or other sources.</p>
<p><a data-primary="InputStream class" data-type="indexterm" id="idm45927714332688"/><a data-primary="OutputStream class" data-type="indexterm" id="idm45927714331760"/>The core of this API is a pair of abstract classes, <code>InputStream</code> and
<code>OutputStream</code>. <a data-primary="System.in" data-type="indexterm" id="idm45927714330128"/><a data-primary="System.out" data-type="indexterm" id="idm45927714329392"/>These are very widely used, and in fact the “standard”
input and output streams, which are called <code>System.in</code> and
<code>System.out</code>, are streams of this type. They are public, static fields
of the <code>System</code> class, and they are often used in even the simplest <span class="keep-together">programs</span>:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Hello World!"</code><code class="p">);</code><code class="w"/></pre>
<p><a data-primary="FileInputStream class" data-type="indexterm" id="idm45927714305808"/><a data-primary="FileOutputStream class" data-type="indexterm" id="idm45927714305200"/>Specific subclasses of streams, including <code>FileInputStream</code> and
<code>FileOutputStream</code>, can be used to operate on individual bytes in a
file—for example, by counting all the times ASCII 97 (small letter <em>a</em>)
occurs in a file:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">is</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">FileInputStream</code><code class="p">(</code><code class="s">"/Users/ben/cluster.txt"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="kt">byte</code><code class="o">[]</code><code class="w"> </code><code class="n">buf</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="kt">byte</code><code class="o">[</code><code class="mi">4096</code><code class="o">]</code><code class="p">;</code><code class="w"/>
<code class="w">  </code><code class="kt">int</code><code class="w"> </code><code class="n">len</code><code class="p">,</code><code class="w"> </code><code class="n">count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"/>
<code class="w">  </code><code class="k">while</code><code class="w"> </code><code class="p">((</code><code class="n">len</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">is</code><code class="p">.</code><code class="na">read</code><code class="p">(</code><code class="n">buf</code><code class="p">))</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="n">len</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">buf</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">97</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">count</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">count</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"/>
<code class="w">      </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"'a's seen: "</code><code class="o">+</code><code class="w"> </code><code class="n">count</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">e</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>This approach to dealing with on-disk data can lack some
flexibility—most developers think in terms of characters, not bytes. To
allow for this, the streams are usually combined with the higher-level
<code>Reader</code> and <code>Writer</code> classes, which provide a character-stream level of
interaction, rather than the low-level bytestream provided by
<code>InputStream</code> and <code>OutputStream</code> and their subclasses.</p>
</div></section>
<section data-pdf-bookmark="Readers and Writers" data-type="sect2"><div class="sect2" id="idm45927714298480">
<h2>Readers and Writers</h2>
<p><a data-primary="classic Java I/O" data-secondary="readers and writers" data-type="indexterm" id="ix_ch10-asciidoc5"/><a data-primary="reader class" data-type="indexterm" id="ix_ch10-asciidoc6"/><a data-primary="writer class" data-type="indexterm" id="ix_ch10-asciidoc7"/>By moving to an abstraction that deals in characters, rather than
bytes, developers are presented with an API that is much more familiar
and that hides many of the issues with character encoding, Unicode, and
so on.</p>
<p>The <code>Reader</code> and <code>Writer</code> classes are intended to overlay the bytestream classes and to remove the need for low-level handling of I/O
streams. They have several subclasses that are often used to layer on
top of each other, such as:</p>
<ul>
<li>
<p><code>FileReader</code></p>
</li>
<li>
<p><code>BufferedReader</code></p>
</li>
<li>
<p><code>StringReader</code></p>
</li>
<li>
<p><code>InputStreamReader</code></p>
</li>
<li>
<p><code>FileWriter</code></p>
</li>
<li>
<p><code>PrintWriter</code></p>
</li>
<li>
<p><code>BufferedWriter</code></p>
</li>
</ul>
<p><a data-primary="BufferedReader class" data-type="indexterm" id="idm45927714083760"/><a data-primary="FileReader class" data-type="indexterm" id="idm45927714083056"/>To read all lines in from a file and print them out, we use a
<code>BufferedReader</code> layered on top of a <code>FileReader</code>, like this:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">FileReader</code><code class="p">(</code><code class="n">filename</code><code class="p">)))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>

<code class="w">  </code><code class="k">while</code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">in</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="c1">// Handle FileNotFoundException, etc. here</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p><a data-primary="InputStreamReader class" data-type="indexterm" id="idm45927714016976"/>If we need to read in lines from the console, rather than a file, we
will usually use an <code>InputStreamReader</code> applied to <code>System.in</code>. Let’s look at an example where we want to read in lines of input from the
console but treat input lines that start with a special character as
special—commands (“metas”) to be processed, rather than regular text.
This is a common feature of many chat programs, including IRC. We’ll
use regular expressions from <a data-type="xref" href="ch09.xhtml#javanut8-CHP-9">Chapter 9</a> to help
us:</p>
<pre data-code-language="java" data-type="programlisting"><code class="c1">// Meta example: "#info username"</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">SHELL_META_START</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Pattern</code><code class="p">.</code><code class="na">compile</code><code class="p">(</code><code class="s">"^#(\\w+)\\s*(\\w+)?"</code><code class="p">);</code><code class="w"/>

<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">console</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">      </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="na">in</code><code class="p">)))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>

<code class="w">  </code><code class="k">while</code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">console</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">// Check for special commands ("metas")</code><code class="w"/>
<code class="w">    </code><code class="n">Matcher</code><code class="w"> </code><code class="n">m</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">SHELL_META_START</code><code class="p">.</code><code class="na">matcher</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">m</code><code class="p">.</code><code class="na">find</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">metaName</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">m</code><code class="p">.</code><code class="na">group</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code><code class="w"/>
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">arg</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">m</code><code class="p">.</code><code class="na">group</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code><code class="w"/>
<code class="w">      </code><code class="n">doMeta</code><code class="p">(</code><code class="n">metaName</code><code class="p">,</code><code class="w"> </code><code class="n">arg</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="c1">// Handle FileNotFoundException, etc. here</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>To output text to a file, we can use code like this:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">f</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="na">getProperty</code><code class="p">(</code><code class="s">"user.home"</code><code class="p">)</code><code class="w"/>
<code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">File</code><code class="p">.</code><code class="na">separator</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">".bashrc"</code><code class="p">);</code><code class="w"/>
<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">      </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">BufferedWriter</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">FileWriter</code><code class="p">(</code><code class="n">f</code><code class="p">))))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"## Automatically generated config file. DO NOT EDIT"</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="c1">// ...</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">iox</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="c1">// Handle exceptions</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>This older style of Java I/O has a lot of other occasionally useful functionality. For example, to deal with text files, the
<a data-primary="FilterInputStream class" data-type="indexterm" id="idm45927713698256"/><code>FilterInputStream</code> class is quite often useful. Or for threads that
want to communicate in a way similar to the classic “piped” I/O
approach, <code>PipedInputStream</code>, <code>PipedReader</code>, and their write
counterparts are provided.</p>
<p>Throughout this chapter so far, we have used the language feature known
as “try-with-resources” (TWR). This syntax was briefly introduced in
<a data-type="xref" href="ch02.xhtml#javanut8-CHP-2-SECT-5.18">“The try-with-resources Statement”</a>, but it is in conjunction
with operations like I/O that it comes into its fullest potential, and
it has granted a new lease on life to the older I/O style.<a data-startref="ix_ch10-asciidoc7" data-type="indexterm" id="idm45927713669408"/><a data-startref="ix_ch10-asciidoc6" data-type="indexterm" id="idm45927713668736"/><a data-startref="ix_ch10-asciidoc5" data-type="indexterm" id="idm45927713668064"/></p>
</div></section>
<section data-pdf-bookmark="try-with-resources Revisited" data-type="sect2"><div class="sect2" id="idm45927713667136">
<h2>try-with-resources Revisited</h2>
<p><a data-primary="classic Java I/O" data-secondary="try-with-resources statement" data-type="indexterm" id="idm45927713665600"/><a data-primary="try-with-resources (TWR) statements" data-type="indexterm" id="idm45927713664656"/><a data-primary="TWR (try-with-resources) statements" data-type="indexterm" id="idm45927713664016"/>To make the most of Java’s I/O capabilities, it is important to understand how and when to use TWR. It is very easy to understand when code should use TWR—whenever it is possible to do so.</p>
<p>Before TWR, resources had to be closed manually; complex
interactions between resources that failed to close led to buggy
code that leaked <span class="keep-together">resources</span>.</p>
<p>In fact, Oracle’s engineers estimate that 60% of the resource handling
code in the initial JDK 6 release was incorrect. So, if even the
platform authors can’t reliably get manual resource handling right, then
all new code should definitely be using TWR.</p>
<p><a data-primary="AutoCloseable interface" data-type="indexterm" id="idm45927713661440"/>The key to TWR is a new interface—<code>AutoCloseable</code>. This interface is a direct superinterface of <code>Closeable</code>.
It marks a resource that must be automatically closed, and for which the compiler will insert special exception-handling code.</p>
<p>Inside a TWR resource clause, only declarations of objects that
implement <code>AutoCloseable</code> objects may appear—but the developer may
declare as many as required:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="w"/>
<code class="w">                           </code><code class="k">new</code><code class="w"> </code><code class="n">FileReader</code><code class="p">(</code><code class="s">"profile"</code><code class="p">));</code><code class="w"/>
<code class="w">     </code><code class="kd">var</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="w"/>
<code class="w">                         </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedWriter</code><code class="p">(</code><code class="w"/>
<code class="w">                           </code><code class="k">new</code><code class="w"> </code><code class="n">FileWriter</code><code class="p">(</code><code class="s">"profile.bak"</code><code class="p">))))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>
<code class="w">  </code><code class="k">while</code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">in</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="c1">// Handle FileNotFoundException, etc. here</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>The consequences of this are that resources are automatically scoped to the <code>try</code> block.
The resources (whether readable or writable) are automatically closed in the correct order (the reverse order to the way they were opened), and the compiler inserts exception handling that takes dependencies between resources into account.</p>
<p>TWR is related to similar concepts in other languages and environments, for example, RAII (Resource Acquisition Is Initialization) in C++.
However, as discussed in the finalization section, TWR is limited to block scope.
This minor limitation is because the feature is implemented by the Java source code compiler—it automatically inserts bytecode that calls the resource’s <code>close()</code> method when the scope is exited (by whatever means).</p>
<p><a data-primary="C#, using keyword" data-type="indexterm" id="idm45927713483712"/>As a result, the overall effect of TWR is more similar to C#’s <code>using</code> keyword, rather than the C++ version of RAII.
For Java developers, the best way to regard TWR is as “finalization done right.”
As noted in <a data-type="xref" href="ch06.xhtml#javanut8-CHP-6-SECT-4">“Finalization”</a>, new code should never directly use the finalization mechanism and should always use TWR instead.
Older code should be refactored to use TWR as soon as is practicable, as it provides real tangible benefits to resource handling code.</p>
</div></section>
<section data-pdf-bookmark="Problems with Classic I/O" data-type="sect2"><div class="sect2" id="idm45927713666544">
<h2>Problems with Classic I/O</h2>
<p><a data-primary="classic Java I/O" data-secondary="problems with" data-type="indexterm" id="idm45927713480560"/>Even with the welcome addition of <code>try</code>-with-resources, the <code>File</code>
class and friends have a number of problems that make them less than
ideal for extensive use when performing even standard I/O operations.
For instance:</p>
<ul>
<li>
<p>“Missing methods” for common operations</p>
</li>
<li>
<p>Does not deal with filenames consistently across platforms</p>
</li>
<li>
<p>Fails to have a unified model for file attributes (e.g., modeling
read/write access)</p>
</li>
<li>
<p>Difficult to traverse unknown directory structures</p>
</li>
<li>
<p>No platform- or OS-specific features</p>
</li>
<li>
<p>Nonblocking operations for filesystems not supported</p>
</li>
</ul>
<p>To deal with these shortcomings, Java’s I/O has evolved over several
major releases. With the release of Java 7, this
support became truly easy and effective to use.<a data-startref="ix_ch10-asciidoc2" data-type="indexterm" id="idm45927713439872"/><a data-startref="ix_ch10-asciidoc1" data-type="indexterm" id="idm45927713439264"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Modern Java I/O" data-type="sect1"><div class="sect1" id="idm45927715066560">
<h1>Modern Java I/O</h1>
<p><a data-primary="I/O (input/output)" data-secondary="modern Java I/O" data-type="indexterm" id="ix_ch10-asciidoc8"/><a data-primary="modern Java I/O" data-type="indexterm" id="ix_ch10-asciidoc9"/>Java 7 brought in a brand new I/O API—usually called NIO.2—and it
should be considered almost a complete replacement for the original
<code>File</code> approach to I/O.</p>
<p><a data-primary="java.nio.file package" data-type="indexterm" id="idm45927713434016"/>The new classes are contained in the
<code>java.nio.file</code> package and are considerably easier for many use cases.
The API has two major parts. The first is a new
abstraction called <code>Path</code> (which can be thought of as representing a
file location, which may or may not actually exist).
The second piece is lots of new convenience and utility
methods to deal with files and filesystems. These are contained as
static methods in the <code>Files</code> class.</p>
<section data-pdf-bookmark="Files" data-type="sect2"><div class="sect2" id="idm45927713431840">
<h2>Files</h2>
<p><a data-primary="File class" data-secondary="modern Java I/O" data-type="indexterm" id="ix_ch10-asciidoc10"/><a data-primary="modern Java I/O" data-secondary="File class" data-type="indexterm" id="ix_ch10-asciidoc11"/>For example, when you are using the new <code>Files</code> functionality, a basic copy operation is now as simple as:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">inputFile</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="s">"input.txt"</code><code class="p">);</code><code class="w"/>
<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">FileInputStream</code><code class="p">(</code><code class="n">inputFile</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">Files</code><code class="p">.</code><code class="na">copy</code><code class="p">(</code><code class="n">in</code><code class="p">,</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"output.txt"</code><code class="p">));</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">ex</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">ex</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>Let’s quickly survey some of the major methods in <code>Files</code>—the
operation of most of them is pretty self-explanatory. In many cases, the
methods have return types. We have omitted handling these, as they are
rarely useful except for contrived examples and for duplicating the
behavior of the equivalent C code:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">Path</code><code class="w"> </code><code class="n">source</code><code class="p">,</code><code class="w"> </code><code class="n">target</code><code class="p">;</code><code class="w"/>
<code class="n">Attributes</code><code class="w"> </code><code class="n">attr</code><code class="p">;</code><code class="w"/>
<code class="n">Charset</code><code class="w"> </code><code class="n">cs</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">StandardCharsets</code><code class="p">.</code><code class="na">UTF_8</code><code class="p">;</code><code class="w"/>

<code class="c1">// Creating files</code><code class="w"/>
<code class="c1">//</code><code class="w"/>
<code class="c1">// Example of path --&gt; /home/ben/.profile</code><code class="w"/>
<code class="c1">// Example of attributes --&gt; rw-rw-rw-</code><code class="w"/>
<code class="n">Files</code><code class="p">.</code><code class="na">createFile</code><code class="p">(</code><code class="n">target</code><code class="p">,</code><code class="w"> </code><code class="n">attr</code><code class="p">);</code><code class="w"/>

<code class="c1">// Deleting files</code><code class="w"/>
<code class="n">Files</code><code class="p">.</code><code class="na">delete</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">deleted</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">deleteIfExists</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>

<code class="c1">// Copying/moving files</code><code class="w"/>
<code class="n">Files</code><code class="p">.</code><code class="na">copy</code><code class="p">(</code><code class="n">source</code><code class="p">,</code><code class="w"> </code><code class="n">target</code><code class="p">);</code><code class="w"/>
<code class="n">Files</code><code class="p">.</code><code class="na">move</code><code class="p">(</code><code class="n">source</code><code class="p">,</code><code class="w"> </code><code class="n">target</code><code class="p">);</code><code class="w"/>

<code class="c1">// Utility methods to retrieve information</code><code class="w"/>
<code class="kt">long</code><code class="w"> </code><code class="n">size</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">size</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>

<code class="n">FileTime</code><code class="w"> </code><code class="n">fTime</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">getLastModifiedTime</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>
<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">fTime</code><code class="p">.</code><code class="na">to</code><code class="p">(</code><code class="n">TimeUnit</code><code class="p">.</code><code class="na">SECONDS</code><code class="p">));</code><code class="w"/>

<code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="w"> </code><code class="o">?&gt;</code><code class="w"> </code><code class="n">attrs</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">readAttributes</code><code class="p">(</code><code class="n">target</code><code class="p">,</code><code class="w"> </code><code class="s">"*"</code><code class="p">);</code><code class="w"/>
<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">attrs</code><code class="p">);</code><code class="w"/>

<code class="c1">// Methods to deal with file types</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">isDir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">isDirectory</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">isSym</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">isSymbolicLink</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>

<code class="c1">// Methods to deal with reading and writing</code><code class="w"/>
<code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="w"> </code><code class="n">lines</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">readAllLines</code><code class="p">(</code><code class="n">target</code><code class="p">,</code><code class="w"> </code><code class="n">cs</code><code class="p">);</code><code class="w"/>
<code class="kt">byte</code><code class="o">[]</code><code class="w"> </code><code class="n">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">readAllBytes</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>

<code class="kd">var</code><code class="w"> </code><code class="n">br</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">newBufferedReader</code><code class="p">(</code><code class="n">target</code><code class="p">,</code><code class="w"> </code><code class="n">cs</code><code class="p">);</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">bwr</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">newBufferedWriter</code><code class="p">(</code><code class="n">target</code><code class="p">,</code><code class="w"> </code><code class="n">cs</code><code class="p">);</code><code class="w"/>

<code class="kd">var</code><code class="w"> </code><code class="n">is</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">newInputStream</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">os</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">newOutputStream</code><code class="p">(</code><code class="n">target</code><code class="p">);</code><code class="w"/></pre>
<p>Some of the methods on <code>Files</code> provide the opportunity to pass optional
arguments, to provide additional (possibly implementation-specific)
behavior for the operation.</p>
<p>Some of the API choices here produce occasionally annoying behavior. For
example, by default, a copy operation will not overwrite an existing
file, so we need to specify this behavior as a copy option:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">Files</code><code class="p">.</code><code class="na">copy</code><code class="p">(</code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"input.txt"</code><code class="p">),</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"output.txt"</code><code class="p">),</code><code class="w"/>
<code class="w">           </code><code class="n">StandardCopyOption</code><code class="p">.</code><code class="na">REPLACE_EXISTING</code><code class="p">);</code><code class="w"/></pre>
<p><a data-primary="CopyOption interface" data-type="indexterm" id="idm45927713103584"/><a data-primary="LinkOption class" data-type="indexterm" id="idm45927713091344"/><a data-primary="StandardCopyOption enum" data-type="indexterm" id="idm45927713090736"/><code>StandardCopyOption</code> is an enum that implements an interface called
<code>CopyOption</code>. This is also implemented by <code>LinkOption</code>. So
<code>Files.copy()</code> can take any number of either <code>LinkOption</code> or
<code>StandardCopyOption</code> arguments. <code>LinkOption</code> is used to specify how
symbolic links should be handled (provided the underlying OS supports
symlinks, of course).<a data-startref="ix_ch10-asciidoc11" data-type="indexterm" id="idm45927712942688"/><a data-startref="ix_ch10-asciidoc10" data-type="indexterm" id="idm45927712942096"/></p>
</div></section>
<section data-pdf-bookmark="Path" data-type="sect2"><div class="sect2" id="idm45927712941424">
<h2>Path</h2>
<p><a data-primary="modern Java I/O" data-secondary="Path type" data-type="indexterm" id="ix_ch10-asciidoc12"/><a data-primary="Path type" data-type="indexterm" id="ix_ch10-asciidoc13"/><code>Path</code> is a type that may be used to locate a file in a filesystem.
It represents a path that is:</p>
<ul>
<li>
<p>System dependent</p>
</li>
<li>
<p>Hierarchical</p>
</li>
<li>
<p>Composed of a sequence of path elements</p>
</li>
<li>
<p>Hypothetical (may not exist yet, or may have been deleted)</p>
</li>
</ul>
<p>It is therefore fundamentally different from a <code>File</code>. In particular, the
system dependency is manifested by <code>Path</code> being an interface, not a
class, which enables different filesystem providers to each implement the
<code>Path</code> interface and provide for system-specific features while
retaining the overall abstraction.</p>
<p>The elements of a <code>Path</code> consist of an optional root component, which
identifies the filesystem hierarchy that this instance belongs to. Note
that, for example, relative <code>Path</code> instances may not have a root
component. In addition to the root, all <code>Path</code> instances have zero or
more directory names and a name element.</p>
<p>The name element is the element farthest from the root of the directory
hierarchy and represents the name of the file or directory. The <code>Path</code>
can be thought of as consisting of the path elements joined by a
special separator or delimiter.</p>
<p><code>Path</code> is an abstract concept; it isn’t necessarily bound to any physical file path.
This allows us to talk easily about the locations of files that don’t exist yet.
The <code>Path</code> interface provides static factory methods for creating <code>Path</code> instances.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-primary="Java 17" data-secondary="Path interface" data-type="indexterm" id="idm45927712913744"/><a data-primary="NIO.2" data-type="indexterm" id="idm45927712912768"/><a data-primary="Paths class" data-type="indexterm" id="idm45927712912096"/>When NIO.2 was introduced in Java 7, static methods were not supported on
interfaces, so a <code>Paths</code> class was introduced to hold the factory methods. With
Java 17 the <code>Path</code> interface methods are recommended instead, and the <code>Paths</code>
class may in the future be deprecated.</p>
</div>
<p><code>Path</code> provides two <code>of()</code> methods for creating <code>Path</code> objects. The
usual version takes one or more <code>String</code> instances and uses the default
filesystem provider. The <code>URI</code> version takes advantage of the ability of NIO.2
to plug in additional providers of bespoke filesystems. This is an advanced
usage, and interested developers should consult the primary documentation. Let’s
look at some simple examples of how to use <code>Path</code>:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">p</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"/Users/ben/cluster.txt"</code><code class="p">);</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">p2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">URI</code><code class="p">(</code><code class="s">"file:///Users/ben/cluster.txt"</code><code class="p">));</code><code class="w"/>
<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">p2</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="n">p</code><code class="p">));</code><code class="w"/>

<code class="n">File</code><code class="w"> </code><code class="n">f</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="na">toFile</code><code class="p">();</code><code class="w"/>
<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="na">isDirectory</code><code class="p">());</code><code class="w"/>

<code class="n">Path</code><code class="w"> </code><code class="n">p3</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">f</code><code class="p">.</code><code class="na">toPath</code><code class="p">();</code><code class="w"/>
<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">p3</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="n">p</code><code class="p">));</code><code class="w"/></pre>
<p>This example also shows the easy interoperation between <code>Path</code> and <code>File</code> objects.
The addition of a <code>toFile()</code> method to <code>Path</code> and a <code>toPath()</code> method to <code>File</code> allows the developer to move effortlessly between the two APIs and allows for a straightforward approach to refactoring the internals of code based on <code>File</code> to use <code>Path</code> instead.</p>
<p>We can also use some helpful “bridge” methods that the <code>Files</code>
class also provides. These provide convenient access to the older I/O
APIs—for example, by providing convenient methods to open <code>Writer</code>
objects to specified <code>Path</code> locations:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">logFile</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"/tmp/app.log"</code><code class="p">);</code><code class="w"/>
<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">writer</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">       </code><code class="n">Files</code><code class="p">.</code><code class="na">newBufferedWriter</code><code class="p">(</code><code class="n">logFile</code><code class="p">,</code><code class="w"> </code><code class="n">StandardCharsets</code><code class="p">.</code><code class="na">UTF_8</code><code class="p">,</code><code class="w"/>
<code class="w">                               </code><code class="n">StandardOpenOption</code><code class="p">.</code><code class="na">WRITE</code><code class="p">,</code><code class="w"/>
<code class="w">                               </code><code class="n">StandardOpenOption</code><code class="p">.</code><code class="na">CREATE</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">writer</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="s">"Hello World!"</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="c1">// ...</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="c1">// ...</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>We’re using the <code>StandardOpenOption</code> enum, which provides
similar capabilities to the copy options but for the case of opening a
new file instead. We provide both <code>WRITE</code> and <code>CREATE</code>, so if the file doesn’t
exist it will be created; otherwise, we’ll simply open it for additional writing.</p>
<p>In this example use case, we have used the <code>Path</code> API to:</p>
<ul>
<li>
<p>Create a <code>Path</code> corresponding to a new file</p>
</li>
<li>
<p>Use the <code>Files</code> class to create that new file</p>
</li>
<li>
<p>Open a <code>Writer</code> to that file</p>
</li>
<li>
<p>Write to that file</p>
</li>
<li>
<p>Automatically close it when done</p>
</li>
</ul>
<p><a data-primary="FileSystem class" data-type="indexterm" id="idm45927712720576"/><a data-primary="JAR (Java archive) files" data-secondary="manipulating as a FileSystem" data-type="indexterm" id="idm45927712719872"/>In our next example, we’ll build on this to manipulate a JAR file as a <code>FileSystem</code> in its own right, modifying it to add a file directly into the JAR.
Recall that JAR files are actually just ZIP files, so this technique will also work for <em>.zip</em> archives:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">tempJar</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"sample.jar"</code><code class="p">);</code><code class="w"/>
<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">workingFS</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">      </code><code class="n">FileSystems</code><code class="p">.</code><code class="na">newFileSystem</code><code class="p">(</code><code class="n">tempJar</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>

<code class="w">  </code><code class="n">Path</code><code class="w"> </code><code class="n">pathForFile</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">workingFS</code><code class="p">.</code><code class="na">getPath</code><code class="p">(</code><code class="s">"/hello.txt"</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="n">Files</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="n">pathForFile</code><code class="p">,</code><code class="w"/>
<code class="w">              </code><code class="n">List</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"Hello World!"</code><code class="p">),</code><code class="w"/>
<code class="w">              </code><code class="n">Charset</code><code class="p">.</code><code class="na">defaultCharset</code><code class="p">(),</code><code class="w"/>
<code class="w">              </code><code class="n">StandardOpenOption</code><code class="p">.</code><code class="na">WRITE</code><code class="p">,</code><code class="w"> </code><code class="n">StandardOpenOption</code><code class="p">.</code><code class="na">CREATE</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>This shows how we create a <code>FileSystem</code> object in order to create the <code>Path</code> objects that refer to files inside the jar, via the <code>getPath()</code> method.
This enables the developer to essentially treat <code>FileSystem</code> objects as black boxes: they are automatically created via a service provider interface (SPI) mechanism.</p>
<p>To see which file systems are available on your machine, you can run some code like this:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">FileSystemProvider</code><code class="w"> </code><code class="n">f</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">FileSystemProvider</code><code class="p">.</code><code class="na">installedProviders</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>The <code>Files</code> class also provides methods for handling temporary files and directories, which is a surprisingly common use case (and can be a source of security bugs).
For  example, let’s see how to load a resources file from within the classpath, copy
it to a newly created temporary directory, and then safely clean up the temporary files (using a <code>Reaper</code> class available in the book resources online):</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">Path</code><code class="w"> </code><code class="n">tmpdir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">createTempDirectory</code><code class="p">(</code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"/tmp"</code><code class="p">),</code><code class="w"> </code><code class="s">"tmp-test"</code><code class="p">);</code><code class="w"/>
<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">      </code><code class="n">FilesExample</code><code class="p">.</code><code class="na">class</code><code class="p">.</code><code class="na">getResourceAsStream</code><code class="p">(</code><code class="s">"/res.txt"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">Path</code><code class="w"> </code><code class="n">copied</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">tmpdir</code><code class="p">.</code><code class="na">resolve</code><code class="p">(</code><code class="s">"copied-resource.txt"</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="n">Files</code><code class="p">.</code><code class="na">copy</code><code class="p">(</code><code class="n">in</code><code class="p">,</code><code class="w"> </code><code class="n">copied</code><code class="p">,</code><code class="w"> </code><code class="n">StandardCopyOption</code><code class="p">.</code><code class="na">REPLACE_EXISTING</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="c1">// ... work with the copy</code><code class="w"/>
<code class="p">}</code><code class="w"/>
<code class="c1">// Clean up when done...</code><code class="w"/>
<code class="n">Files</code><code class="p">.</code><code class="na">walkFileTree</code><code class="p">(</code><code class="n">tmpdir</code><code class="p">,</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Reaper</code><code class="p">());</code><code class="w"/></pre>
<p>One of the criticisms of Java’s original I/O APIs was the lack of support for native and high-performance I/O.
A solution was initially added in Java 1.4, the Java New I/O (NIO) API, and it has been refined in later Java versions<a data-startref="ix_ch10-asciidoc13" data-type="indexterm" id="idm45927712465712"/><a data-startref="ix_ch10-asciidoc12" data-type="indexterm" id="idm45927712465104"/>.<a data-startref="ix_ch10-asciidoc9" data-type="indexterm" id="idm45927712430496"/><a data-startref="ix_ch10-asciidoc8" data-type="indexterm" id="idm45927712429792"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="NIO Channels and Buffers" data-type="sect1"><div class="sect1" id="idm45927712940512">
<h1>NIO Channels and Buffers</h1>
<p><a data-primary="buffers, NIO" data-type="indexterm" id="ix_ch10-asciidoc14"/><a data-primary="channels" data-type="indexterm" id="ix_ch10-asciidoc15"/><a data-primary="I/O (input/output)" data-secondary="NIO channels and buffers" data-type="indexterm" id="ix_ch10-asciidoc16"/><a data-primary="NIO channels and buffers" data-type="indexterm" id="ix_ch10-asciidoc17"/>NIO buffers are a low-level abstraction for high-performance I/O.
They provide a container for a linear sequence of elements of a
specific primitive type. We’ll work with the <code>ByteBuffer</code> (the most
common case) in our examples.</p>
<section data-pdf-bookmark="ByteBuffer" data-type="sect2"><div class="sect2" id="idm45927712354080">
<h2>ByteBuffer</h2>
<p><a data-primary="buffers, NIO" data-secondary="ByteBuffer" data-type="indexterm" id="ix_ch10-asciidoc18"/><a data-primary="ByteBuffer class" data-secondary="basics" data-type="indexterm" id="ix_ch10-asciidoc19"/><a data-primary="channels" data-secondary="ByteBuffer" data-type="indexterm" id="ix_ch10-asciidoc20"/><a data-primary="I/O (input/output)" data-secondary="ByteBuffer" data-type="indexterm" id="ix_ch10-asciidoc21"/><a data-primary="NIO channels and buffers" data-secondary="ByteBuffer" data-type="indexterm" id="ix_ch10-asciidoc22"/>This <a data-primary="ByteBuffer class" data-type="indexterm" id="ix_ch10-asciidoc23"/>is a sequence of bytes and can conceptually be thought of as a
performance-critical alternative to working with a <code>byte[]</code>. To get
the best possible performance, <code>ByteBuffer</code> provides support for dealing
directly with the native capabilities of the platform the JVM is running
on.</p>
<p>This approach is called the <em>direct buffers</em> case, and it bypasses the
Java heap wherever possible. Direct buffers are allocated in native
memory, not on the standard Java heap, and they are not subject to
garbage collection in the same way as regular on-heap Java objects.</p>
<p><a data-primary="allocateDirect()" data-type="indexterm" id="idm45927712343408"/>To obtain a direct <code>ByteBuffer</code>, call the <code>allocateDirect()</code> factory
method. An on-heap version, <code>allocate()</code>, is also provided, but in
practice this is not often used.</p>
<p><a data-primary="byte[]" data-type="indexterm" id="idm45927712341008"/>A third way to obtain a byte buffer is to <code>wrap()</code> an existing <code>byte[]</code>—this
will give an on-heap buffer that serves to provide a more
object-oriented view of the underlying bytes:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ByteBuffer</code><code class="p">.</code><code class="na">allocateDirect</code><code class="p">(</code><code class="mi">65536</code><code class="p">);</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">b2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ByteBuffer</code><code class="p">.</code><code class="na">allocate</code><code class="p">(</code><code class="mi">4096</code><code class="p">);</code><code class="w"/>

<code class="kt">byte</code><code class="o">[]</code><code class="w"> </code><code class="n">data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">};</code><code class="w"/>
<code class="n">ByteBuffer</code><code class="w"> </code><code class="n">b3</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ByteBuffer</code><code class="p">.</code><code class="na">wrap</code><code class="p">(</code><code class="n">data</code><code class="p">);</code><code class="w"/></pre>
<p>Byte buffers are all about low-level access to the bytes. This means
that developers have to deal with the details manually—including the
need to handle the endianness of the bytes and the signed nature of
Java’s integral primitives:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">b</code><code class="p">.</code><code class="na">order</code><code class="p">(</code><code class="n">ByteOrder</code><code class="p">.</code><code class="na">BIG_ENDIAN</code><code class="p">);</code><code class="w"/>

<code class="kt">int</code><code class="w"> </code><code class="n">capacity</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">capacity</code><code class="p">();</code><code class="w"/>
<code class="kt">int</code><code class="w"> </code><code class="n">position</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">position</code><code class="p">();</code><code class="w"/>
<code class="kt">int</code><code class="w"> </code><code class="n">limit</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">limit</code><code class="p">();</code><code class="w"/>
<code class="kt">int</code><code class="w"> </code><code class="n">remaining</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">remaining</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">more</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">hasRemaining</code><code class="p">();</code><code class="w"/></pre>
<p>To get data into or out of a buffer, we have two types of
operation—single value, which reads or writes a single value, and bulk,
which takes a <code>byte[]</code> or <code>ByteBuffer</code> and operates on a (potentially
large) number of values as a single operation. It is from the bulk
operations that we’d expect to realize performance gains:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">b</code><code class="p">.</code><code class="na">put</code><code class="p">((</code><code class="kt">byte</code><code class="p">)</code><code class="mi">42</code><code class="p">);</code><code class="w"/>
<code class="n">b</code><code class="p">.</code><code class="na">putChar</code><code class="p">(</code><code class="sc">'x'</code><code class="p">);</code><code class="w"/>
<code class="n">b</code><code class="p">.</code><code class="na">putInt</code><code class="p">(</code><code class="mh">0xc001c0de</code><code class="p">);</code><code class="w"/>

<code class="n">b</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">data</code><code class="p">);</code><code class="w"/>
<code class="n">b</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">b2</code><code class="p">);</code><code class="w"/>

<code class="kt">double</code><code class="w"> </code><code class="n">d</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">getDouble</code><code class="p">();</code><code class="w"/>
<code class="n">b</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">data</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="n">data</code><code class="p">.</code><code class="na">length</code><code class="p">);</code><code class="w"/></pre>
<p>The single value form also supports a form used for absolute positioning
within the buffer:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">b</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="kt">byte</code><code class="p">)</code><code class="mi">9</code><code class="p">);</code><code class="w"/></pre>
<p><a data-primary="java.nio.channels package" data-type="indexterm" id="idm45927712052896"/>Buffers are an in-memory abstraction. To affect the outside world (e.g.,
the file or network), we need to use a <code>Channel</code>, from the package
<code>java.nio.channels</code>. Channels represent connections to entities that
can support read or write operations. Files and sockets are the usual
examples of channels, but we could consider custom implementations used
for low-latency data processing.</p>
<p>Channels are open when they’re created and can subsequently be closed.
Once closed, they cannot be reopened. Channels are usually either
readable or writable, but not both. The key to understanding channels is
that:</p>
<ul>
<li>
<p>Reading from a channel puts bytes into a buffer</p>
</li>
<li>
<p>Writing to a channel takes bytes from a buffer</p>
</li>
</ul>
<p>For example, suppose we have a large file that we want to checksum in
16M chunks:</p>
<pre data-code-language="java" data-type="programlisting"><code class="n">FileInputStream</code><code class="w"> </code><code class="n">fis</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">getSomeStream</code><code class="p">();</code><code class="w"/>
<code class="kt">boolean</code><code class="w"> </code><code class="n">fileOK</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>

<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="n">FileChannel</code><code class="w"> </code><code class="n">fchan</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">fis</code><code class="p">.</code><code class="na">getChannel</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">buffy</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ByteBuffer</code><code class="p">.</code><code class="na">allocateDirect</code><code class="p">(</code><code class="mi">16</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="mi">1024</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="mi">1024</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="k">while</code><code class="p">(</code><code class="n">fchan</code><code class="p">.</code><code class="na">read</code><code class="p">(</code><code class="n">buffy</code><code class="p">)</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="o">-</code><code class="mi">1</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="n">buffy</code><code class="p">.</code><code class="na">position</code><code class="p">()</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="n">fileOK</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">fileOK</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">computeChecksum</code><code class="p">(</code><code class="n">buffy</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="n">buffy</code><code class="p">.</code><code class="na">compact</code><code class="p">();</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Exception in I/O"</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>This will use native I/O as far as possible and will avoid a lot of
copying of bytes on and off the Java heap. If the <code>computeChecksum()</code>
method has been well implemented, then this could be a very performant
implementation.<a data-startref="ix_ch10-asciidoc23" data-type="indexterm" id="idm45927711958256"/><a data-startref="ix_ch10-asciidoc22" data-type="indexterm" id="idm45927711875168"/><a data-startref="ix_ch10-asciidoc21" data-type="indexterm" id="idm45927711874528"/><a data-startref="ix_ch10-asciidoc20" data-type="indexterm" id="idm45927711873856"/><a data-startref="ix_ch10-asciidoc19" data-type="indexterm" id="idm45927711873184"/></p>
</div></section>
<section data-pdf-bookmark="Mapped Byte Buffers" data-type="sect2"><div class="sect2" id="idm45927712353488">
<h2>Mapped Byte Buffers</h2>
<p><a data-primary="buffers, NIO" data-secondary="MappedByteBuffer" data-type="indexterm" id="idm45927711871344"/><a data-primary="ByteBuffer class" data-secondary="MappedByteBuffer" data-type="indexterm" id="idm45927711870144"/><a data-primary="channels" data-secondary="MappedByteBuffer" data-type="indexterm" id="idm45927711869200"/><a data-primary="direct buffers" data-type="indexterm" id="idm45927711868256"/><a data-primary="I/O (input/output)" data-secondary="MappedByteBuffer" data-type="indexterm" id="idm45927711867584"/><a data-primary="MappedByteBuffer" data-type="indexterm" id="idm45927711866640"/><a data-primary="NIO channels and buffers" data-secondary="MappedByteBuffer" data-type="indexterm" id="idm45927711865968"/>These are a type of direct byte buffer that contains a memory-mapped
file (or a region of one). <a data-primary="FileChannel class" data-type="indexterm" id="idm45927711864816"/>They are created from a <code>FileChannel</code>
object, but note that the <code>File</code> object corresponding to the
<code>MappedByteBuffer</code> must not be used after the memory-mapped operations
or an exception will be thrown. To mitigate this, we again use
<code>try</code>-with-resources, to scope the objects tightly:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">raf</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">  </code><code class="k">new</code><code class="w"> </code><code class="n">RandomAccessFile</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">File</code><code class="p">(</code><code class="s">"input.txt"</code><code class="p">),</code><code class="w"> </code><code class="s">"rw"</code><code class="p">);</code><code class="w"/>
<code class="w">     </code><code class="n">FileChannel</code><code class="w"> </code><code class="n">fc</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">raf</code><code class="p">.</code><code class="na">getChannel</code><code class="p">();)</code><code class="w"> </code><code class="p">{</code><code class="w"/>

<code class="w">  </code><code class="n">MappedByteBuffer</code><code class="w"> </code><code class="n">mbf</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">    </code><code class="n">fc</code><code class="p">.</code><code class="na">map</code><code class="p">(</code><code class="n">FileChannel</code><code class="p">.</code><code class="na">MapMode</code><code class="p">.</code><code class="na">READ_WRITE</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="n">fc</code><code class="p">.</code><code class="na">size</code><code class="p">());</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="kt">byte</code><code class="o">[</code><code class="p">(</code><code class="kt">int</code><code class="p">)</code><code class="n">fc</code><code class="p">.</code><code class="na">size</code><code class="p">()</code><code class="o">]</code><code class="p">;</code><code class="w"/>
<code class="w">  </code><code class="n">mbf</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">b</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="n">b</code><code class="p">.</code><code class="na">length</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="n">fc</code><code class="p">.</code><code class="na">size</code><code class="p">();</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="c1">// Won't be written back to the file, we're a copy</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="n">mbf</code><code class="p">.</code><code class="na">position</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="n">mbf</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">b</code><code class="p">);</code><code class="w"> </code><code class="c1">// Zeros the file</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>Even with buffers, there are limitations of what can be done in Java for
large I/O operations (e.g., transferring 10G between filesystems) that
perform synchronously on a single thread. Before Java 7, these types of
operations would typically be done by writing custom multithreaded code
and managing a separate thread for performing a background copy. Let’s
move on to look at the new asynchronous I/O features that were added
with JDK 7<a data-startref="ix_ch10-asciidoc18" data-type="indexterm" id="idm45927711692368"/>.<a data-startref="ix_ch10-asciidoc17" data-type="indexterm" id="idm45927711691632"/><a data-startref="ix_ch10-asciidoc16" data-type="indexterm" id="idm45927711690992"/><a data-startref="ix_ch10-asciidoc15" data-type="indexterm" id="idm45927711690320"/><a data-startref="ix_ch10-asciidoc14" data-type="indexterm" id="idm45927711756288"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Async I/O" data-type="sect1"><div class="sect1" id="idm45927711755232">
<h1>Async I/O</h1>
<p><a data-primary="Async I/O" data-type="indexterm" id="ix_ch10-asciidoc24"/><a data-primary="I/O (input/output)" data-secondary="Async I/O" data-type="indexterm" id="ix_ch10-asciidoc25"/>The
key to the asynchronous functionality is new subclasses
of <span class="keep-together"><code>Channel</code></span> that can deal with I/O operations that need to be handed
off to a background thread. The same functionality can be applied to
large, long-running operations and to several other use cases.</p>
<p>In this section, we’ll deal exclusively with <code>AsynchronousFileChannel</code>
for file I/O, but there are a couple of other asynchronous channels to
be aware of. We’ll peek at asynchronous sockets at the end of the
chapter. We’ll look at:</p>
<ul>
<li>
<p><code>AsynchronousFileChannel</code> for file I/O</p>
</li>
<li>
<p><code>AsynchronousSocketChannel</code> for client socket I/O</p>
</li>
<li>
<p><code>AsynchronousServerSocketChannel</code> for asynchronous sockets that
accept incoming connections</p>
</li>
</ul>
<p>There are two different ways to interact with an asynchronous
channel—<code>Future</code> style and callback style.</p>
<section data-pdf-bookmark="Future-Based Style" data-type="sect2"><div class="sect2" id="idm45927711745024">
<h2>Future-Based Style</h2>
<p><a data-primary="Async I/O" data-secondary="future-based style" data-type="indexterm" id="idm45927711743472"/><a data-primary="future-based style, for async I/O" data-type="indexterm" id="idm45927711742496"/>A full discussion of the <code>Future</code> interface would take us too far into the details of Java concurrency.
However, for the purpose of this chapter, it can be thought of as an ongoing task that may or may not have completed yet. It has two key methods:</p>
<dl>
<dt><code>isDone()</code></dt>
<dd>
<p><a data-primary="isDone()" data-type="indexterm" id="idm45927711739840"/>Returns a Boolean indicating whether the task has finished.</p>
</dd>
<dt><code>get()</code></dt>
<dd>
<p><a data-primary="get()" data-type="indexterm" id="idm45927711737728"/>Returns the result. If finished, returns immediately. If not
finished, blocks until done.</p>
</dd>
</dl>
<p>Let’s look at an example of a program that reads a large file (possibly
as large as 100 Mb) asynchronously:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">channel</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">         </code><code class="n">AsynchronousFileChannel</code><code class="p">.</code><code class="na">open</code><code class="p">(</code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"input.txt"</code><code class="p">)))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">buffer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ByteBuffer</code><code class="p">.</code><code class="na">allocateDirect</code><code class="p">(</code><code class="mi">1024</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="mi">1024</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="mi">100</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">&gt;</code><code class="w"> </code><code class="n">result</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">channel</code><code class="p">.</code><code class="na">read</code><code class="p">(</code><code class="n">buffer</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">);</code><code class="w"/>

<code class="w">  </code><code class="k">while</code><code class="p">(</code><code class="o">!</code><code class="n">result</code><code class="p">.</code><code class="na">isDone</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">// Do some other useful work....</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>

<code class="w">  </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Bytes read: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">result</code><code class="p">.</code><code class="na">get</code><code class="p">());</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
</div></section>
<section data-pdf-bookmark="Callback-Based Style" data-type="sect2"><div class="sect2" id="idm45927711575632">
<h2>Callback-Based Style</h2>
<p><a data-primary="Async I/O" data-secondary="callback-based style" data-type="indexterm" id="ix_ch10-asciidoc26"/><a data-primary="callback-based style, for async I/O" data-type="indexterm" id="ix_ch10-asciidoc27"/>The <a data-primary="CompletionHandler interface" data-type="indexterm" id="idm45927711536768"/>callback style for asynchronous I/O is based on a
<code>CompletionHandler</code>, which defines two methods, <code>completed()</code> and
<code>failed()</code>, that will be called back when the operation either succeeds
or fails.</p>
<p>This style is useful if you want immediate notification of events in
asynchronous I/O—for example, if there are a large number of I/O
operations in flight, but failure of any single operation is not
necessarily fatal:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kt">byte</code><code class="o">[]</code><code class="w"> </code><code class="n">data</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="mi">5</code><code class="p">,</code><code class="w"> </code><code class="mi">7</code><code class="p">,</code><code class="w"> </code><code class="mi">11</code><code class="p">,</code><code class="w"> </code><code class="mi">13</code><code class="p">,</code><code class="w"> </code><code class="mi">17</code><code class="p">,</code><code class="w"> </code><code class="mi">19</code><code class="p">,</code><code class="w"> </code><code class="mi">23</code><code class="p">};</code><code class="w"/>
<code class="n">ByteBuffer</code><code class="w"> </code><code class="n">buffy</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ByteBuffer</code><code class="p">.</code><code class="na">wrap</code><code class="p">(</code><code class="n">data</code><code class="p">);</code><code class="w"/>

<code class="n">CompletionHandler</code><code class="o">&lt;</code><code class="n">Integer</code><code class="p">,</code><code class="n">Object</code><code class="o">&gt;</code><code class="w"> </code><code class="n">h</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">  </code><code class="k">new</code><code class="w"> </code><code class="n">CompletionHandler</code><code class="o">&lt;&gt;</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">completed</code><code class="p">(</code><code class="n">Integer</code><code class="w"> </code><code class="n">written</code><code class="p">,</code><code class="w"> </code><code class="n">Object</code><code class="w"> </code><code class="n">o</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Bytes written: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">written</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>

<code class="w">    </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">failed</code><code class="p">(</code><code class="n">Throwable</code><code class="w"> </code><code class="n">x</code><code class="p">,</code><code class="w"> </code><code class="n">Object</code><code class="w"> </code><code class="n">o</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Asynch write failed: "</code><code class="o">+</code><code class="w"> </code><code class="n">x</code><code class="p">.</code><code class="na">getMessage</code><code class="p">());</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">};</code><code class="w"/>

<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">channel</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">       </code><code class="n">AsynchronousFileChannel</code><code class="p">.</code><code class="na">open</code><code class="p">(</code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"primes.txt"</code><code class="p">),</code><code class="w"/>
<code class="w">          </code><code class="n">StandardOpenOption</code><code class="p">.</code><code class="na">CREATE</code><code class="p">,</code><code class="w"> </code><code class="n">StandardOpenOption</code><code class="p">.</code><code class="na">WRITE</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>

<code class="w">  </code><code class="n">channel</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="n">buffy</code><code class="p">,</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="kc">null</code><code class="p">,</code><code class="w"> </code><code class="n">h</code><code class="p">);</code><code class="w"/>

<code class="w">  </code><code class="c1">// Give the CompletionHandler time to run before foreground exit</code><code class="w"/>
<code class="w">  </code><code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="mi">1000</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>The <code>AsynchronousFileChannel</code> object is associated with a background
thread pool, so that the I/O operation proceeds, while the original
thread can get on with other tasks.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The <code>CompletionHandler</code> interface has two abstract methods, not one, so it cannot be the target type for a lambda expression, unfortunately.</p>
</div>
<p>By default, this uses a managed thread pool that is provided by the
runtime. If required, it can be created to use a thread pool that is
managed by the application (via an overloaded form of
<code>AsynchronousFileChannel.open()</code>), but this is seldom necessary.</p>
<p>Finally, for completeness, let’s touch upon NIO’s support for
multiplexed I/O. This enables a single thread to manage multiple
channels and to examine those channels to see which are ready for
reading or writing. The classes to support this are in the
<a data-primary="java.nio.channels package" data-type="indexterm" id="idm45927711244496"/><code>java.nio.channels</code> package and include <code>SelectableChannel</code> and
<code>Selector</code>.</p>
<p>These nonblocking multiplexed techniques can be extremely useful when you’re writing advanced applications that require high scalability, but a full discussion is outside the scope of this book.
In general, the nonblocking API should only be used for advanced use cases when
high performance or other nonfunctional requirements demand it.<a data-startref="ix_ch10-asciidoc27" data-type="indexterm" id="idm45927711242096"/><a data-startref="ix_ch10-asciidoc26" data-type="indexterm" id="idm45927711241392"/></p>
</div></section>
<section data-pdf-bookmark="Watch Services and Directory Searching" data-type="sect2"><div class="sect2" id="idm45927711240592">
<h2>Watch Services and Directory Searching</h2>
<p><a data-primary="Async I/O" data-secondary="watch services and directory searching" data-type="indexterm" id="idm45927711239216"/><a data-primary="search" data-secondary="Async I/O directory streams" data-type="indexterm" id="idm45927711238272"/><a data-primary="watch services" data-type="indexterm" id="idm45927711237360"/>The last class of asynchronous services we will consider are those
that watch a directory or visit a directory (or a tree). The watch
services operate by observing everything that happens within a
directory—for example, the creation or modification of files:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">watcher</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">FileSystems</code><code class="p">.</code><code class="na">getDefault</code><code class="p">().</code><code class="na">newWatchService</code><code class="p">();</code><code class="w"/>

<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">dir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">FileSystems</code><code class="p">.</code><code class="na">getDefault</code><code class="p">().</code><code class="na">getPath</code><code class="p">(</code><code class="s">"/home/ben"</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="n">dir</code><code class="p">.</code><code class="na">register</code><code class="p">(</code><code class="n">watcher</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="n">StandardWatchEventKinds</code><code class="p">.</code><code class="na">ENTRY_CREATE</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="n">StandardWatchEventKinds</code><code class="p">.</code><code class="na">ENTRY_MODIFY</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="n">StandardWatchEventKinds</code><code class="p">.</code><code class="na">ENTRY_DELETE</code><code class="p">);</code><code class="w"/>

<code class="w">  </code><code class="k">while</code><code class="p">(</code><code class="o">!</code><code class="n">shutdown</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">WatchKey</code><code class="w"> </code><code class="n">key</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">watcher</code><code class="p">.</code><code class="na">take</code><code class="p">();</code><code class="w"/>
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">WatchEvent</code><code class="o">&lt;?&gt;</code><code class="w"> </code><code class="n">event</code><code class="p">:</code><code class="w"> </code><code class="n">key</code><code class="p">.</code><code class="na">pollEvents</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">Object</code><code class="w"> </code><code class="n">o</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">event</code><code class="p">.</code><code class="na">context</code><code class="p">();</code><code class="w"/>
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">o</code><code class="w"> </code><code class="k">instanceof</code><code class="w"> </code><code class="n">Path</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Path altered: "</code><code class="o">+</code><code class="w"> </code><code class="n">o</code><code class="p">);</code><code class="w"/>
<code class="w">      </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="n">key</code><code class="p">.</code><code class="na">reset</code><code class="p">();</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p><a data-primary="directory streams, Async I/O" data-type="indexterm" id="idm45927711106752"/>By contrast, the directory streams provide a view into all files
currently in a single directory. For example, to list all the Java
source files and their size in bytes, we can use code like:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="p">(</code><code class="n">DirectoryStream</code><code class="o">&lt;</code><code class="n">Path</code><code class="o">&gt;</code><code class="w"> </code><code class="n">stream</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">    </code><code class="n">Files</code><code class="p">.</code><code class="na">newDirectoryStream</code><code class="p">(</code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"/opt/projects"</code><code class="p">),</code><code class="w"> </code><code class="s">"*.java"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">Path</code><code class="w"> </code><code class="n">p</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">stream</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">p</code><code class="w"> </code><code class="o">+</code><code class="s">": "</code><code class="o">+</code><code class="w"> </code><code class="n">Files</code><code class="p">.</code><code class="na">size</code><code class="p">(</code><code class="n">p</code><code class="p">));</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>One drawback of this API is that it will return only elements that
match according to glob syntax, which is sometimes insufficiently
flexible. We can go further by using the <code>Files.find()</code> and
<code>Files.walk()</code> methods to address each element obtained by a recursive
walk through the directory:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">homeDir</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"/Users/ben/projects/"</code><code class="p">);</code><code class="w"/>
<code class="n">Files</code><code class="p">.</code><code class="na">find</code><code class="p">(</code><code class="n">homeDir</code><code class="p">,</code><code class="w"> </code><code class="mi">255</code><code class="p">,</code><code class="w"/>
<code class="w">  </code><code class="p">(</code><code class="n">p</code><code class="p">,</code><code class="w"> </code><code class="n">attrs</code><code class="p">)</code><code class="w"> </code><code class="o">-&gt;</code><code class="w"> </code><code class="n">p</code><code class="p">.</code><code class="na">toString</code><code class="p">().</code><code class="na">endsWith</code><code class="p">(</code><code class="s">".java"</code><code class="p">))</code><code class="w"/>
<code class="w">     </code><code class="p">.</code><code class="na">forEach</code><code class="p">(</code><code class="n">q</code><code class="w"> </code><code class="o">-&gt;</code><code class="w"> </code><code class="p">{</code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">q</code><code class="p">.</code><code class="na">normalize</code><code class="p">());});</code><code class="w"/></pre>
<p><a data-primary="FileVisitor interface" data-type="indexterm" id="idm45927710852416"/><a data-primary="java.nio.file package" data-type="indexterm" id="idm45927710835152"/><a data-primary="javax.net package" data-type="indexterm" id="idm45927710834544"/>It is possible to go even farther and construct advanced solutions
based on the <code>FileVisitor</code> interface in <code>java.nio.file</code>, but that
requires the developer to implement all four methods on the interface,
rather than just using a single lambda expression as done here.</p>
<p>In the last section of this chapter, we will discuss Java’s networking
support and the core JDK classes that enable it.<a data-startref="ix_ch10-asciidoc25" data-type="indexterm" id="idm45927710832496"/><a data-startref="ix_ch10-asciidoc24" data-type="indexterm" id="idm45927710831792"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Networking" data-type="sect1"><div class="sect1" id="idm45927710830992">
<h1>Networking</h1>
<p><a data-primary="I/O (input/output)" data-secondary="networking" data-type="indexterm" id="ix_ch10-asciidoc28"/>The Java platform provides access to a large number of standard networking protocols, and these make writing simple networked applications quite easy.
<a data-primary="java.net package" data-type="indexterm" id="idm45927710827984"/>The core of Java’s network support lives in the package <code>java.net</code>, with additional extensibility provided by <code>javax.net</code> (and in particular, <code>javax.net.ssl</code>), all of which is in the module <code>java.base</code>.</p>
<p>One of the easiest protocols to use for building applications is
HyperText Transmission Protocol (HTTP), the protocol used as the
basic communication protocol of the Web.</p>
<section data-pdf-bookmark="HTTP" data-type="sect2"><div class="sect2" id="idm45927710825072">
<h2>HTTP</h2>
<p><a data-primary="HTTP" data-type="indexterm" id="ix_ch10-asciidoc29"/><a data-primary="I/O (input/output)" data-secondary="HTTP" data-type="indexterm" id="ix_ch10-asciidoc30"/><a data-primary="networking" data-secondary="HTTP" data-type="indexterm" id="ix_ch10-asciidoc31"/>HTTP is the most common and popular high-level network protocol that Java supports out of the box. It is a very simple protocol, implemented on top of the standard TCP/IP stack. It can run on any network port but is usually found on port 443 when encrypted with TLS (known as HTTPS) or port 80 when running unencrypted. These days, HTTPS should be the default wherever possible.</p>
<p>Java has two separate APIs for handling HTTP—one of which dates back to the
earliest days of the platform, and a more modern API that arrived fully in Java
11.</p>
<p>Let’s take a quick look at the older API, for the sake of completeness.
In this API, <code>URL</code> is the key class—it supports URLs of the form <code>http://</code>,
<code>ftp://</code>, <code>file://</code>, and <code>https://</code> out of the box. It is very easy to
use, and the simplest example of Java HTTP support is to download a
particular URL:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="s">"http://www.google.com/"</code><code class="p">);</code><code class="w"/>
<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">url</code><code class="p">.</code><code class="na">openStream</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">Files</code><code class="p">.</code><code class="na">copy</code><code class="p">(</code><code class="n">in</code><code class="p">,</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"output.txt"</code><code class="p">));</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">ex</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">ex</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>For more low-level control, including metadata about the request and
response, we can use <code>URLConnection</code> and achieve something like:</p>
<pre data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">URLConnection</code><code class="w"> </code><code class="n">conn</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">url</code><code class="p">.</code><code class="na">openConnection</code><code class="p">();</code><code class="w"/>

<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">type</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getContentType</code><code class="p">();</code><code class="w"/>
<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">encoding</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getContentEncoding</code><code class="p">();</code><code class="w"/>
<code class="w">  </code><code class="n">Date</code><code class="w"> </code><code class="n">lastModified</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Date</code><code class="p">(</code><code class="n">conn</code><code class="p">.</code><code class="na">getLastModified</code><code class="p">());</code><code class="w"/>
<code class="w">  </code><code class="kt">int</code><code class="w"> </code><code class="n">len</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getContentLength</code><code class="p">();</code><code class="w"/>
<code class="w">  </code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="c1">// Handle exception</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p><a data-primary="DELETE method (HTTP)" data-type="indexterm" id="idm45927710708752"/><a data-primary="GET method (HTTP)" data-type="indexterm" id="idm45927710708144"/><a data-primary="HEAD method (HTTP)" data-type="indexterm" id="idm45927710584032"/><a data-primary="OPTIONS method (HTTP)" data-type="indexterm" id="idm45927710583360"/><a data-primary="POST method (HTTP)" data-type="indexterm" id="idm45927710582688"/><a data-primary="PUT method (HTTP)" data-type="indexterm" id="idm45927710582016"/><a data-primary="request methods (HTTP)" data-type="indexterm" id="idm45927710581344"/><a data-primary="TRACE method (HTTP)" data-type="indexterm" id="idm45927710580672"/>HTTP defines “request methods,” which are the operations that a client
can make on a remote resource. These methods are called GET, POST, HEAD, PUT, DELETE, OPTIONS, and TRACE.</p>
<p>Each has slightly different usages, for example:</p>
<ul>
<li>
<p>GET should only be used to retrieve a document and <em>never</em> should perform any side effects.</p>
</li>
<li>
<p>HEAD is equivalent to GET except the body is not returned—useful if a program wants to quickly check via headers whether a URL has changed.</p>
</li>
<li>
<p>POST is used when we want to send data to a server for processing.</p>
</li>
</ul>
<p>By default, Java uses GET, but it does provide a way to use other
methods for building more complex applications; however, doing so is a
bit involved. In this next example, we’re using the echo function provided
by Postman to return a view of the data we posted:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="s">"https://postman-echo.com/post"</code><code class="p">);</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">encodedData</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">URLEncoder</code><code class="p">.</code><code class="na">encode</code><code class="p">(</code><code class="s">"q=java"</code><code class="p">,</code><code class="w"> </code><code class="s">"ASCII"</code><code class="p">);</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">contentType</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"application/x-www-form-urlencoded"</code><code class="p">;</code><code class="w"/>

<code class="kd">var</code><code class="w"> </code><code class="n">conn</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="n">HttpURLConnection</code><code class="p">)</code><code class="w"> </code><code class="n">url</code><code class="p">.</code><code class="na">openConnection</code><code class="p">();</code><code class="w"/>
<code class="n">conn</code><code class="p">.</code><code class="na">setInstanceFollowRedirects</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code><code class="w"/>
<code class="n">conn</code><code class="p">.</code><code class="na">setRequestMethod</code><code class="p">(</code><code class="s">"POST"</code><code class="p">);</code><code class="w"/>
<code class="n">conn</code><code class="p">.</code><code class="na">setRequestProperty</code><code class="p">(</code><code class="s">"Content-Type"</code><code class="p">,</code><code class="w"> </code><code class="n">contentType</code><code class="w"> </code><code class="p">);</code><code class="w"/>
<code class="n">conn</code><code class="p">.</code><code class="na">setRequestProperty</code><code class="p">(</code><code class="s">"Content-Length"</code><code class="p">,</code><code class="w"/>
<code class="w">  </code><code class="n">String</code><code class="p">.</code><code class="na">valueOf</code><code class="p">(</code><code class="n">encodedData</code><code class="p">.</code><code class="na">length</code><code class="p">()));</code><code class="w"/>

<code class="n">conn</code><code class="p">.</code><code class="na">setDoOutput</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code><code class="w"/>
<code class="n">OutputStream</code><code class="w"> </code><code class="n">os</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">();</code><code class="w"/>
<code class="n">os</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="w"> </code><code class="n">encodedData</code><code class="p">.</code><code class="na">getBytes</code><code class="p">()</code><code class="w"> </code><code class="p">);</code><code class="w"/>

<code class="kt">int</code><code class="w"> </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getResponseCode</code><code class="p">();</code><code class="w"/>
<code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">response</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="n">HttpURLConnection</code><code class="p">.</code><code class="na">HTTP_MOVED_PERM</code><code class="w"/>
<code class="w">    </code><code class="o">||</code><code class="w"> </code><code class="n">response</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="n">HttpURLConnection</code><code class="p">.</code><code class="na">HTTP_MOVED_TEMP</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Moved to: "</code><code class="o">+</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getHeaderField</code><code class="p">(</code><code class="s">"Location"</code><code class="p">));</code><code class="w"/>
<code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">conn</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="n">Files</code><code class="p">.</code><code class="na">copy</code><code class="p">(</code><code class="n">in</code><code class="p">,</code><code class="w"> </code><code class="n">Path</code><code class="p">.</code><code class="na">of</code><code class="p">(</code><code class="s">"postman.txt"</code><code class="p">),</code><code class="w"/>
<code class="w">                </code><code class="n">StandardCopyOption</code><code class="p">.</code><code class="na">REPLACE_EXISTING</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>Notice that we needed to send our query parameters in the body of a
request and to encode them before sending. We also had to disable
following of HTTP redirects and to treat any redirection from the
server manually. This is due to a limitation of the <code>HttpURLConnection</code>
class, which does not deal well with redirection of POST requests.</p>
<p>The older API definitely shows its age, and in fact implements only version 1.0
of the HTTP standard, which is very inefficient and considered archaic. As an
alternative, modern Java programs can use the new API, which was added as a
result of Java needing to support the new HTTP/2 protocol. It has been available
in a fully supported module, <code>java.net.http</code>, since Java 11. Let’s see a simple
example of using the new API:</p>
<pre data-code-language="java" data-type="programlisting"><code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="n">client</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpClient</code><code class="p">.</code><code class="na">newBuilder</code><code class="p">().</code><code class="na">build</code><code class="p">();</code><code class="w"/>
<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="n">uri</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URI</code><code class="p">(</code><code class="s">"https://www.oreilly.com"</code><code class="p">);</code><code class="w"/>
<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="n">request</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">HttpRequest</code><code class="p">.</code><code class="na">newBuilder</code><code class="p">(</code><code class="n">uri</code><code class="p">).</code><code class="na">build</code><code class="p">();</code><code class="w"/>

<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code><code class="p">.</code><code class="na">send</code><code class="p">(</code><code class="n">request</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="n">ofString</code><code class="p">(</code><code class="n">Charset</code><code class="p">.</code><code class="na">defaultCharset</code><code class="p">()));</code><code class="w"/>
<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="n">body</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">body</code><code class="p">();</code><code class="w"/>
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">body</code><code class="p">);</code><code class="w"/></pre>
<p>Note that this API is designed to be extensible, with interfaces such as
<code>HttpResponse.BodySubscriber</code> available for implementing custom handling.
The interface also seamlessly hides the differences between HTTP/2 and the older HTTP/1.1 protocol, meaning that Java applications will be able to migrate gracefully as web servers adopt the new version.<a data-startref="ix_ch10-asciidoc31" data-type="indexterm" id="idm45927710220976"/><a data-startref="ix_ch10-asciidoc30" data-type="indexterm" id="idm45927710191184"/><a data-startref="ix_ch10-asciidoc29" data-type="indexterm" id="idm45927710190576"/></p>
<p>Let’s move on to look at the next layer down the networking stack, the
Transmission Control Protocol (TCP).</p>
</div></section>
<section data-pdf-bookmark="TCP" data-type="sect2"><div class="sect2" id="idm45927710779712">
<h2>TCP</h2>
<p><a data-primary="I/O (input/output)" data-secondary="TCP" data-type="indexterm" id="ix_ch10-asciidoc32"/><a data-primary="networking" data-secondary="TCP" data-type="indexterm" id="ix_ch10-asciidoc33"/><a data-primary="TCP" data-type="indexterm" id="ix_ch10-asciidoc34"/>TCP is the basis of reliable network transport over the internet. It
ensures that web pages and other internet traffic are delivered in a
complete and comprehensible state. From a networking theory standpoint,
the protocol properties that allow TCP to function as this “reliability
layer” for internet traffic are:</p>
<dl class="pagebreak-before">
<dt>Connection based</dt>
<dd>
<p>Data belongs to a single logical stream (a connection).</p>
</dd>
<dt>Guaranteed in-order delivery</dt>
<dd>
<p>Data packets will be resent until they arrive.</p>
</dd>
<dt>Error checked</dt>
<dd>
<p>Damage caused by network transit will be detected and fixed
automatically.</p>
</dd>
</dl>
<p>TCP is a two-way (or bidirectional) communication channel and uses a
special numbering scheme (TCP sequence numbers) for data chunks to
ensure that both sides of a communication stream stay in sync. To support many different services on the same network host, TCP uses
port numbers to identify services and ensures that traffic intended for
one port does not go to a different one.</p>
<p><a data-primary="ServerSocket class" data-type="indexterm" id="idm45927710115888"/><a data-primary="Socket class" data-type="indexterm" id="idm45927710115392"/>In Java, TCP is represented by the classes <code>Socket</code> and
<code>ServerSocket</code>. They are used to provide the capability to be the client
side and server side of the connection, respectively—meaning that Java can be
used both to connect to network services and as a language for
implementing new services.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-primary="Java 13" data-secondary="socket support" data-type="indexterm" id="idm45927710112880"/>Java’s original socket support was reimplemented, without API changes, in Java
13. The classic socket APIs now share code with the more modern NIO
infrastructure and will continue working well into the future as a result.</p>
</div>
<p>As an example, let’s consider reimplementing HTTP 1.1. This is a relatively
simple, text-based protocol. We’ll need to implement both sides of the
connection, so let’s start with an HTTP client on top of a TCP socket.
To accomplish this, we will actually need to implement the details of
the HTTP protocol, but we do have the advantage that we have complete
control over the TCP socket.</p>
<p>We will need to both read and write from the client socket, and we’ll
construct the actual request line in accordance with the HTTP standard
(which is known as RFC 2616, and uses explicit line-ending syntax). The
resulting client code will look something like this:</p>
<pre data-code-language="java" data-type="programlisting"><code class="kd">var</code><code class="w"> </code><code class="n">hostname</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"www.example.com"</code><code class="p">;</code><code class="w"/>
<code class="kt">int</code><code class="w"> </code><code class="n">port</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">80</code><code class="p">;</code><code class="w"/>
<code class="kd">var</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"/index.xhtml"</code><code class="p">;</code><code class="w"/>

<code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">sock</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Socket</code><code class="p">(</code><code class="n">hostname</code><code class="p">,</code><code class="w"> </code><code class="n">port</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">from</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="w"/>
<code class="w">      </code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">sock</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">()));</code><code class="w"/>
<code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="n">to</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="w"/>
<code class="w">      </code><code class="k">new</code><code class="w"> </code><code class="n">OutputStreamWriter</code><code class="p">(</code><code class="n">sock</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">()));</code><code class="w"> </code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>

<code class="w">  </code><code class="c1">// The HTTP protocol</code><code class="w"/>
<code class="w">  </code><code class="n">to</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"GET "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">filename</code><code class="w"> </code><code class="o">+</code><code class="w"/>
<code class="w">    </code><code class="s">" HTTP/1.1\r\nHost: "</code><code class="o">+</code><code class="w"> </code><code class="n">hostname</code><code class="w"> </code><code class="o">+</code><code class="s">"\r\n\r\n"</code><code class="p">);</code><code class="w"/>
<code class="w">  </code><code class="n">to</code><code class="p">.</code><code class="na">flush</code><code class="p">();</code><code class="w"/>

<code class="w">  </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">l</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">null</code><code class="p">;</code><code class="w"> </code><code class="p">(</code><code class="n">l</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">from</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">;</code><code class="w"> </code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">l</code><code class="p">);</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>On the server side, we’ll need to receive possibly multiple incoming
connections. To handle this, we’ll kick off a main server loop,
then use <code>accept()</code> to take a new connection from the operating system.
The new connection is then quickly passed to a separate
handler class so that the main server loop can get back to listening
for new connections. The code for this is a bit more involved than the
client case:</p>
<pre data-code-language="java" data-type="programlisting"><code class="c1">// Handler class</code><code class="w"/>
<code class="kd">private</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kd">class</code> <code class="nc">HttpHandler</code><code class="w"> </code><code class="kd">implements</code><code class="w"> </code><code class="n">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="kd">private</code><code class="w"> </code><code class="kd">final</code><code class="w"> </code><code class="n">Socket</code><code class="w"> </code><code class="n">sock</code><code class="p">;</code><code class="w"/>
<code class="w">  </code><code class="n">HttpHandler</code><code class="p">(</code><code class="n">Socket</code><code class="w"> </code><code class="n">client</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="k">this</code><code class="p">.</code><code class="na">sock</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code><code class="p">;</code><code class="w"> </code><code class="p">}</code><code class="w"/>

<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">           </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="w"/>
<code class="w">             </code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">sock</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">()));</code><code class="w"/>
<code class="w">         </code><code class="kd">var</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"/>
<code class="w">           </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="w"/>
<code class="w">             </code><code class="k">new</code><code class="w"> </code><code class="n">OutputStreamWriter</code><code class="p">(</code><code class="n">sock</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">()));</code><code class="w"> </code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"HTTP/1.0 200\r\nContent-Type: text/plain\r\n\r\n"</code><code class="p">);</code><code class="w"/>
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>
<code class="w">      </code><code class="k">while</code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">in</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">line</code><code class="p">.</code><code class="na">length</code><code class="p">()</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="mi">0</code><code class="p">)</code><code class="w"> </code><code class="k">break</code><code class="p">;</code><code class="w"/>
<code class="w">        </code><code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>
<code class="w">      </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="p">(</code><code class="n">Exception</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="c1">// Handle exception</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="c1">// Main server loop</code><code class="w"/>
<code class="kd">public</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code><code class="w"> </code><code class="n">args</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="n">port</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Integer</code><code class="p">.</code><code class="na">parseInt</code><code class="p">(</code><code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="p">);</code><code class="w"/>

<code class="w">    </code><code class="n">ServerSocket</code><code class="w"> </code><code class="n">ss</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">ServerSocket</code><code class="p">(</code><code class="n">port</code><code class="p">);</code><code class="w"/>
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="n">Socket</code><code class="w"> </code><code class="n">client</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">ss</code><code class="p">.</code><code class="na">accept</code><code class="p">();</code><code class="w"/>
<code class="w">      </code><code class="kd">var</code><code class="w"> </code><code class="n">handler</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">HTTPHandler</code><code class="p">(</code><code class="n">client</code><code class="p">);</code><code class="w"/>
<code class="w">      </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">handler</code><code class="p">).</code><code class="na">start</code><code class="p">();</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">Exception</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="c1">// Handle exception</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p><a data-primary="Postel's Law" data-type="indexterm" id="idm45927709791392"/>When designing a protocol for applications to communicate over TCP,
there’s a simple and profound network architecture principle, known as
Postel’s Law (after Jon Postel, one of the fathers of the internet) that
you should always keep in mind. It is sometimes stated as: “Be
strict about what you send, and liberal about what you will accept.”
This simple principle means that communication can remain broadly
possible in a network system, even in the event of quite imperfect
<span class="keep-together">implementations</span>.</p>
<p>Postel’s Law, when combined with the general principle that the
protocol should be as simple as possible (sometimes called the KISS
principle), will make the developer’s job of implementing TCP-based
communication much easier than it otherwise would be.<a data-startref="ix_ch10-asciidoc34" data-type="indexterm" id="idm45927709789616"/><a data-startref="ix_ch10-asciidoc33" data-type="indexterm" id="idm45927709788912"/><a data-startref="ix_ch10-asciidoc32" data-type="indexterm" id="idm45927709788240"/></p>
<p>Below TCP is the internet’s general-purpose haulage protocol—the
Internet Protocol (IP) itself.</p>
</div></section>
<section data-pdf-bookmark="IP" data-type="sect2"><div class="sect2" id="idm45927709786816">
<h2>IP</h2>
<p><a data-primary="I/O (input/output)" data-secondary="IP" data-type="indexterm" id="idm45927709636032"/><a data-primary="IP" data-type="indexterm" id="idm45927709635056"/><a data-primary="networking" data-secondary="IP" data-type="indexterm" id="idm45927709634384"/>IP, the “lowest common denominator” transport, provides a useful
abstraction over the physical network technologies that are used to
actually move bytes from A to B.</p>
<p>Unlike TCP, delivery of an IP packet is not guaranteed, and a packet can
be dropped by any overloaded system along the path. IP packets do have a
destination but usually no routing data—it’s the responsibility of the
(possibly many different) physical transports along the route to
actually deliver the data.</p>
<p>It is possible to create “datagram” services in Java that are based
around single IP packets (or those with a UDP header, instead of TCP),
but this is not often required except for extremely low-latency
applications. Java uses the class <code>DatagramSocket</code> to implement this
functionality, although few developers should ever need to venture this
far down the network stack.</p>
<p>Finally, it’s worth noting some changes currently in-flight in the addressing schemes that are used across the internet. The current dominant version of IP in use is IPv4, which has a 32-bit space of possible network addresses. This space is now very badly squeezed and various mitigation techniques have been deployed to handle the depletion.</p>
<p>The next version of IP (IPv6) is being rolled out, but it is not fully accepted
and has yet to displace IPv4, although steady progress toward it becoming the
standard continues. As of this writing, IPv6 traffic is at about 35% of internet
traffic and steadily rising. In the next 10 years, IPv6 is likely to overtake
IPv4 in terms of traffic volume, and low-level networking will need to adapt to
this radically new version.</p>
<p>However, for Java programmers, the good news is that the language and platform
have been working for many years on good support for IPv6 and the changes that
it introduces. The transition between IPv4 and IPv6 is likely to be much
smoother and less problematic for Java applications than for many other
languages.<a data-startref="ix_ch10-asciidoc28" data-type="indexterm" id="idm45927709630720"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45927709629888">
<h1>Summary</h1>
<p>In this chapter we’ve met the file handling, I/O, and networking capabilities provided in Java’s SDK. However, these capabilities are not used equally often. The core file handling classes (especially <code>Path</code> and the rest of NIO.2) are used very often by Java developers, with the more advanced capabilities being less frequently encountered.</p>
<p>The story is different for the networking libraries. It’s good to be aware of these capabilities, but they are fairly basic. In practice, higher-level libraries provided by third parties are often used instead (e.g., Netty). The one exception: the one low-level JDK networking library that Java developers can expect to encounter relatively often is the new HTTP library in <code>java.net.http</code>.</p>
<p>Let’s move on to meet some of Java’s key dynamic features—classloading and reflection—powerful techniques that allow code to be discovered, loaded, and executed at runtime in ways that were unknown at compile time.<a data-startref="ix_ch10-asciidoc0" data-type="indexterm" id="idm45927709626896"/></p>
</div></section>
</div></section></div></body></html>