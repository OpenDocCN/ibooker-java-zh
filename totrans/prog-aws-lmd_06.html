<html><head></head><body><section data-pdf-bookmark="Chapter 6. Testing" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch06">&#13;
<h1><span class="label">Chapter 6. </span>Testing</h1>&#13;
&#13;
&#13;
<p>A<a data-primary="testing" data-secondary="benefits of" data-type="indexterm" id="idm46222417302424"/> good test suite, like the solid foundation of a house, provides a known baseline of system behavior on top of which we can build confidently.&#13;
That baseline gives us confidence to add features, fix bugs, and refactor without worrying that we’ll break other parts of the system.&#13;
When integrated into a development workflow, that same test suite also encourages good practices by making it easier to maintain existing tests and add new ones.</p>&#13;
&#13;
<p>Of<a data-primary="testing" data-secondary="balanced approach to" data-type="indexterm" id="idm46222417300440"/> course, foundations aren’t free.&#13;
The effort of maintaining tests must be balanced with the value that the tests provide.&#13;
If we spend all of our effort on testing, we’ll have none left to work on the rest of the system.</p>&#13;
&#13;
<p>For serverless applications, drawing the line between valuable tests and brittle technical debt is harder than ever.&#13;
Fortunately, we can use a familiar model to help consider the trade-offs.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Test Pyramid" data-type="sect1"><div class="sect1" id="idm46222417298344">&#13;
<h1>The Test Pyramid</h1>&#13;
&#13;
<p>The<a data-primary="Test Pyramid" data-type="indexterm" id="idm46222417296776"/><a data-primary="testing" data-secondary="deciding which tests to write" data-type="indexterm" id="idm46222417296040"/> classic “Test Pyramid” (from the 2009 book <em>Succeeding with Agile</em> by Mike Cohn, shown in <a data-type="xref" href="#test-pyramid">Figure 6-1</a>) is a useful guide in helping us decide which kinds of tests to write.&#13;
The pyramid metaphor illustrates the trade-offs between the number of tests in a given slice, the value of those tests, and the costs to write, run, and maintain them.</p>&#13;
&#13;
<figure><div class="figure" id="test-pyramid">&#13;
<img alt="images/ch06_image01.png" src="assets/awsl_0601.png"/>&#13;
<h6><span class="label">Figure 6-1. </span>The Test Pyramid</h6>&#13;
</div></figure>&#13;
&#13;
<p>Testing in a serverless world isn’t substantively different than in a traditional application, especially nearer the base of the pyramid.&#13;
However, as with any distributed system made up of different components and services, higher-level “end-to-end” testing is more challenging.&#13;
In this chapter, we’ll address testing from the bottom of the pyramid to the top, with plenty of examples along the way.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unit Tests" data-type="sect2"><div class="sect2" id="idm46222417290552">&#13;
<h2>Unit Tests</h2>&#13;
&#13;
<p>At<a data-primary="testing" data-secondary="unit tests" data-type="indexterm" id="idm46222417289224"/><a data-primary="unit tests" data-type="indexterm" id="idm46222417288216"/> the base of the pyramid are unit tests—these tests should exercise specific pieces of our components of our application, without relying on any external dependencies (like databases).&#13;
Unit tests should execute quickly, and we should be able to run them regularly (or even automatically) during the course of development, with a minimum of configuration and no network access.&#13;
We should have as many unit tests as necessary to give us confidence that our code is working correctly.&#13;
Unit tests not only cover the “happy paths,” but thoroughly address edge cases and error handling.&#13;
Even a small application might have dozens or hundreds of unit tests.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Functional Tests" data-type="sect2"><div class="sect2" id="idm46222417286488">&#13;
<h2>Functional Tests</h2>&#13;
&#13;
<p>In<a data-primary="testing" data-secondary="functional tests" data-type="indexterm" id="idm46222417285192"/><a data-primary="functional tests" data-type="indexterm" id="idm46222417284184"/> the middle of the pyramid are the functional tests.&#13;
Like unit tests, these tests should execute quickly, and shouldn’t rely on external dependencies.&#13;
Unlike unit tests, we might have to mock or stub those external dependencies to meet the runtime requirements of the component under test.</p>&#13;
&#13;
<p>Rather than attempting to exhaustively exercise every logical branch of our code, our functional tests address the major code paths for a component, paying particular attention to failure modes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="End-to-End Tests" data-type="sect2"><div class="sect2" id="idm46222417282232">&#13;
<h2>End-to-End Tests</h2>&#13;
&#13;
<p>At<a data-primary="testing" data-secondary="end-to-end tests" data-type="indexterm" id="idm46222417280904"/><a data-primary="end-to-end tests" data-type="indexterm" id="idm46222417279896"/> the top of the pyramid are the end-to-end tests.&#13;
An end-to-end test submits input to the application (often via the normal user interface or API) and then makes assertions on the output or side effects.&#13;
Unlike a functional test, an end-to-end test runs against the complete application and all of its external dependencies, in a production-like environment (although often isolated from production).</p>&#13;
&#13;
<p>Because end-to-end tests are more expensive to run than functional and unit tests (in terms of runtime and infrastructure cost), you typically should only test a few important scenarios.&#13;
A good rule of thumb is to have at least one end-to-end test that covers the most important path through an application (e.g., the purchase path in an online shopping application).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring for Testing" data-type="sect1"><div class="sect1" id="idm46222417277656">&#13;
<h1>Refactoring for Testing</h1>&#13;
&#13;
<p>We’re<a data-primary="testing" data-secondary="refactoring for" data-type="indexterm" id="idm46222417276248"/><a data-primary="refactoring" data-secondary="for testing" data-type="indexterm" id="idm46222417275240"/> going to use the serverless data pipeline we built in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a> as the basis to build out a suite of unit, functional, and end-to-end tests.&#13;
Before we jump in, let’s do a little refactoring to make our data pipeline Lambdas easier to test.</p>&#13;
&#13;
<p>Recall from the previous section that unit tests exercise specific pieces of components of our application.&#13;
In our case, we’re referring to methods within the Java classes that make up our Lambda functions.&#13;
We want to write tests that provide input to certain methods, and assert that the output (or side effects) of those methods are what we expect.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46222417272232">&#13;
<h5>Side Effects</h5>&#13;
<p>In<a data-primary="side effects" data-secondary="defined" data-type="indexterm" id="idm46222417270904"/> computer science, a <em>side effect</em> can be thought of as something that is observable outside of the scope of the invoking function or method.&#13;
For example, if a Java method writes output to a file or makes an HTTP call, that method is said to have a side effect.&#13;
Even “read-only” operations might have observable side effects like modifying a system file descriptor or opening a network socket.</p>&#13;
&#13;
<p>When testing applications, it’s important to validate both the application and the result of any side effects it may perform.</p>&#13;
</div></aside>&#13;
&#13;
<p>To start, let’s review <code>BulkEventsLambda</code>, keeping in mind the unit and functional slices of the Test Pyramid.&#13;
This relatively simple Lambda function is interacting with two external AWS services (S3 and SNS), as well as serializing and deserializing JSON data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Revisiting BulkEventsLambda" data-type="sect1"><div class="sect1" id="idm46222417267032">&#13;
<h1>Revisiting BulkEventsLambda</h1>&#13;
&#13;
<p><code>BulkEventsLambda</code> is<a data-primary="testing" data-secondary="BulkEventsLambda, basics of" data-type="indexterm" id="Tbelbasic06"/><a data-primary="BulkEventsLambda" data-secondary="basics of" data-type="indexterm" id="BELbasic06"/> triggered whenever a file is uploaded to a specific S3 bucket.&#13;
The handler method is invoked with an <code>S3Event</code> object.&#13;
For each <code>S3EventNotificationRecord</code> within that event, the Lambda retrieves a JSON file from an S3 bucket.&#13;
That JSON file contains zero or more JSON objects.&#13;
The Lambda deserializes the JSON file into a collection of <code>WeatherEvent</code> Java objects.&#13;
Each of those Java objects is then serialized into a <code>String</code> and published to an SNS topic.&#13;
Finally, the Lambda function writes a log entry to STDOUT (and hence to CloudWatch Logs) stating the number of weather events that were sent to SNS.</p>&#13;
&#13;
<p>The code you saw in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a> was written and organized for clarity, but not necessarily for ease of testing.&#13;
Let’s take a look at the four methods in the <code>BulkEvents Lambda</code> class.</p>&#13;
&#13;
<p>First, the <code>handler</code> method, which receives an <code>S3Event</code> object:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">handler</code><code class="o">(</code><code class="n">S3Event</code> <code class="n">event</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="n">event</code><code class="o">.</code><code class="na">getRecords</code><code class="o">().</code><code class="na">forEach</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">processS3EventRecord</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This is the only method accessible from outside the class—without refactoring, it means that any tests for this class <em>must</em> invoke this method with an <code>S3Event</code> object.&#13;
Furthermore, the method has a <code>void</code> return type, so asserting success or failure is <span class="keep-together">difficult</span>.</p>&#13;
&#13;
<p>Moving on, we see that this method calls <code>processS3EventRecord</code> for each incoming event record:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kt">void</code> <code class="nf">processS3EventRecord</code><code class="o">(</code>&#13;
    <code class="n">S3EventNotification</code><code class="o">.</code><code class="na">S3EventNotificationRecord</code> <code class="n">record</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">WeatherEvent</code><code class="o">&gt;</code> <code class="n">weatherEvents</code> <code class="o">=</code> <code class="n">readWeatherEventsFromS3</code><code class="o">(</code>&#13;
    <code class="n">record</code><code class="o">.</code><code class="na">getS3</code><code class="o">().</code><code class="na">getBucket</code><code class="o">().</code><code class="na">getName</code><code class="o">(),</code>&#13;
    <code class="n">record</code><code class="o">.</code><code class="na">getS3</code><code class="o">().</code><code class="na">getObject</code><code class="o">().</code><code class="na">getKey</code><code class="o">());</code>&#13;
&#13;
  <code class="n">weatherEvents</code><code class="o">.</code><code class="na">stream</code><code class="o">()</code>&#13;
    <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">weatherEventToSnsMessage</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">forEach</code><code class="o">(</code><code class="n">message</code> <code class="o">-&gt;</code> <code class="n">sns</code><code class="o">.</code><code class="na">publish</code><code class="o">(</code><code class="n">snsTopic</code><code class="o">,</code> <code class="n">message</code><code class="o">));</code>&#13;
&#13;
  <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Published "</code> <code class="o">+</code> <code class="n">weatherEvents</code><code class="o">.</code><code class="na">size</code><code class="o">()</code>&#13;
    <code class="o">+</code> <code class="s">" weather events to SNS"</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This method is private, so it can’t be tested at all without changing the visibility to “package-private” (by removing the <code>private</code> keyword).&#13;
Like the <code>handler</code> function, it has a void return type, so any assertions we make will be on the<a data-primary="side effects" data-secondary="BulkEventsLambda and" data-type="indexterm" id="idm46222417217592"/> side effects rather than the return value of the method.&#13;
This method has two explicit side effects:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <code>System.out.println</code> call.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>sns.publish</code> call, which sends an SNS message to the topic named by the <code>snsTopic</code> field.&#13;
Because this is an AWS SDK call, a number of other environment and system attributes must be accounted for:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The appropriate AWS configuration must be in place and correct.</p>&#13;
</li>&#13;
<li>&#13;
<p>The AWS API endpoint for the configured region must be accessible over the network.</p>&#13;
</li>&#13;
<li>&#13;
<p>The named SNS topic must exist.</p>&#13;
</li>&#13;
<li>&#13;
<p>The AWS credentials we’re using must have access to write to that SNS topic.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>To invoke <code>processS3EventRecord</code> as written, we have to address all of those items ahead of time.&#13;
For a unit test, this is unacceptable overhead.</p>&#13;
&#13;
<p>Furthermore, if we also want to assert that <code>processS3EventRecord</code> has run correctly, we need a way of knowing that the SNS message was sent to the correct topic.&#13;
One way to do that would be to subscribe to the SNS topic within our test process and wait for the expected message to show up.&#13;
As before, this is unacceptable overhead for a unit test.</p>&#13;
&#13;
<p>A<a data-primary="side effects" data-secondary="testing in Java" data-type="indexterm" id="idm46222417085928"/><a data-primary="Mockito" data-type="indexterm" id="idm46222417084920"/> common way to test these side effects in Java is to mock or stub the classes responsible for those side effects using tools like <a href="https://site.mockito.org">Mockito</a>.&#13;
This allows us to test our own application classes that produce side effects, by replacing things like the AWS SDK with a mock that looks and acts similarly but allows us to avoid actually setting up a real SNS topic.&#13;
Using techniques like <a href="https://oreil.ly/GPdlH">argument capture</a>, mocks can also save the parameters used to call them, which allows us to make assertions about how they are called—in this case we could assert that the <code>sns.publish</code> method was called with the correct topic name and message.</p>&#13;
&#13;
<p>To use a mock AWS SDK object like this, we need a way to inject it into the class under test—typically this is done via a constructor that accepts the appropriate parameters.&#13;
<code>BulkEventsLambda</code> doesn’t have such a constructor, so we’ll need to add one to be able to use mock objects.</p>&#13;
&#13;
<p>The <code>readWeatherEventsFromS3</code> method is another example of a method with a side effect, in this case a remote API call.&#13;
In this case, it uses the AWS S3 SDK client’s <code>getObject</code> call to download data from the S3.</p>&#13;
&#13;
<p>That data is then deserialized into a collection of <code>WeatherEvent</code> objects and returned to the caller:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">WeatherEvent</code><code class="o">&gt;</code> <code class="nf">readWeatherEventsFromS3</code><code class="o">(</code><code class="n">String</code> <code class="n">bucket</code><code class="o">,</code> <code class="n">String</code> <code class="n">key</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">try</code> <code class="o">{</code>&#13;
    <code class="kd">final</code> <code class="n">S3ObjectInputStream</code> <code class="n">s3is</code> <code class="o">=</code>&#13;
      <code class="n">s3</code><code class="o">.</code><code class="na">getObject</code><code class="o">(</code><code class="n">bucket</code><code class="o">,</code> <code class="n">key</code><code class="o">).</code><code class="na">getObjectContent</code><code class="o">();</code>&#13;
    <code class="kd">final</code> <code class="n">WeatherEvent</code><code class="o">[]</code> <code class="n">weatherEvents</code> <code class="o">=</code>&#13;
      <code class="n">objectMapper</code><code class="o">.</code><code class="na">readValue</code><code class="o">(</code><code class="n">s3is</code><code class="o">,</code> <code class="n">WeatherEvent</code><code class="o">[].</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="n">s3is</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="k">return</code> <code class="n">Arrays</code><code class="o">.</code><code class="na">asList</code><code class="o">(</code><code class="n">weatherEvents</code><code class="o">);</code>&#13;
  <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">throw</code> <code class="k">new</code> <code class="nf">RuntimeException</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This method does two distinctly different things—it downloads data from S3 <em>and</em> deserializes that data.&#13;
That combination of actions makes it harder for us to test each piece of functionality in isolation.&#13;
If we want to test how errors are handled during JSON deserialization, we still have to make sure that the input to the method has the correct S3 bucket and key even though that information isn’t relevant to the JSON processing.</p>&#13;
&#13;
<p>Finally, <code>weatherEventToSnsMessage</code> is an example of a method that should be easy to test (if made visible outside of the <code>BulkEventsLambda</code> class).&#13;
It takes a single <code>Weather Event</code> object and returns a <code>String</code>, and it doesn’t cause any side effects.<a data-primary="" data-startref="BELbasic06" data-type="indexterm" id="idm46222416999368"/><a data-primary="" data-startref="Tbelbasic06" data-type="indexterm" id="idm46222416998392"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring BulkEventsLambda" data-type="sect1"><div class="sect1" id="idm46222417266408">&#13;
<h1>Refactoring BulkEventsLambda</h1>&#13;
&#13;
<p>Having<a data-primary="testing" data-secondary="BulkEventsLambda, refactoring" data-type="indexterm" id="idm46222416996072"/><a data-primary="refactoring" data-secondary="BuldEventsLambda" data-type="indexterm" id="Rbulk06"/><a data-primary="BulkEventsLambda" data-secondary="refactoring" data-type="indexterm" id="BELrefact06"/> reviewed the four methods in <code>BulkEventsLambda</code>, here are some things we can do to better enable unit and functional testing:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Enable injection of mock AWS SDK classes via constructor arguments.</p>&#13;
</li>&#13;
<li>&#13;
<p>Isolate side effects, so most methods can be tested without using mocks.</p>&#13;
</li>&#13;
<li>&#13;
<p>Split methods up so most methods just do one thing.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Add Constructors" data-type="sect2"><div class="sect2" id="add-constructors">&#13;
<h2>Add Constructors</h2>&#13;
&#13;
<p>With those things in mind, let’s start by adding some constructors:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="nf">BulkEventsLambda</code><code class="o">()</code> <code class="o">{</code>&#13;
  <code class="k">this</code><code class="o">(</code><code class="n">AmazonSNSClientBuilder</code><code class="o">.</code><code class="na">defaultClient</code><code class="o">(),</code>&#13;
    <code class="n">AmazonS3ClientBuilder</code><code class="o">.</code><code class="na">defaultClient</code><code class="o">());</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="kd">public</code> <code class="nf">BulkEventsLambda</code><code class="o">(</code><code class="n">AmazonSNS</code> <code class="n">sns</code><code class="o">,</code> <code class="n">AmazonS3</code> <code class="n">s3</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">this</code><code class="o">.</code><code class="na">sns</code> <code class="o">=</code> <code class="n">sns</code><code class="o">;</code>&#13;
  <code class="k">this</code><code class="o">.</code><code class="na">s3</code> <code class="o">=</code> <code class="n">s3</code><code class="o">;</code>&#13;
  <code class="k">this</code><code class="o">.</code><code class="na">snsTopic</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">getenv</code><code class="o">(</code><code class="n">FAN_OUT_TOPIC_ENV</code><code class="o">);</code>&#13;
&#13;
  <code class="k">if</code> <code class="o">(</code><code class="k">this</code><code class="o">.</code><code class="na">snsTopic</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">throw</code> <code class="k">new</code> <code class="nf">RuntimeException</code><code class="o">(</code>&#13;
      <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="s">"%s must be set"</code><code class="o">,</code> <code class="n">FAN_OUT_TOPIC_ENV</code><code class="o">));</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>We<a data-primary="constructor chaining" data-type="indexterm" id="idm46222416985304"/> now have two constructors.&#13;
As we learned in <a data-type="xref" href="ch03.html#ch03">Chapter 3</a>, the no-arguments default constructor will be invoked by the Lambda runtime when our function is run for the first time.&#13;
That default constructor creates an AWS SDK SNS client and an S3 client and passes those two objects to the second constructor (this technique is called <em>constructor chaining</em>).</p>&#13;
&#13;
<p>The second constructor takes those client objects as parameters.&#13;
In tests we can use this constructor to instantiate the <code>BulkEventsLambda</code> class with mock AWS SDK <span class="keep-together">clients</span>.&#13;
That second constructor also reads the <code>FAN_OUT_TOPIC</code> environment variable, and throws an exception if it isn’t set.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Isolate Side Effects" data-type="sect2"><div class="sect2" id="idm46222416857064">&#13;
<h2>Isolate Side Effects</h2>&#13;
&#13;
<p>We<a data-primary="side effects" data-secondary="isolating" data-type="indexterm" id="idm46222416855464"/> noted three side effects from the <code>BulkEventsLambda</code> review:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Download a JSON file from S3.</p>&#13;
</li>&#13;
<li>&#13;
<p>Publish messages to an SNS topic.</p>&#13;
</li>&#13;
<li>&#13;
<p>Write a log entry to STDOUT.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The first two impose a number of prerequisites on the test environment, slow down test execution, and make tests more complex to write.&#13;
While we definitely want to test those side effects (using both mocks <em>and</em> the actual AWS services), isolating them to as few methods as possible will help make our unit tests simple and fast.</p>&#13;
&#13;
<p>With that in mind, let’s look at two new methods that isolate AWS side effects:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kt">void</code> <code class="nf">publishToSns</code><code class="o">(</code><code class="n">String</code> <code class="n">message</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="n">sns</code><code class="o">.</code><code class="na">publish</code><code class="o">(</code><code class="n">snsTopic</code><code class="o">,</code> <code class="n">message</code><code class="o">);</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="kd">private</code> <code class="n">InputStream</code> <code class="nf">getObjectFromS3</code><code class="o">(</code>&#13;
      <code class="n">S3EventNotification</code><code class="o">.</code><code class="na">S3EventNotificationRecord</code> <code class="n">record</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
  <code class="n">String</code> <code class="n">bucket</code> <code class="o">=</code> <code class="n">record</code><code class="o">.</code><code class="na">getS3</code><code class="o">().</code><code class="na">getBucket</code><code class="o">().</code><code class="na">getName</code><code class="o">();</code>&#13;
  <code class="n">String</code> <code class="n">key</code> <code class="o">=</code> <code class="n">record</code><code class="o">.</code><code class="na">getS3</code><code class="o">().</code><code class="na">getObject</code><code class="o">().</code><code class="na">getKey</code><code class="o">();</code>&#13;
  <code class="k">return</code> <code class="n">s3</code><code class="o">.</code><code class="na">getObject</code><code class="o">(</code><code class="n">bucket</code><code class="o">,</code> <code class="n">key</code><code class="o">).</code><code class="na">getObjectContent</code><code class="o">();</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>The first method, <code>publishToSns</code>, takes a <code>String</code> parameter and publishes a message to an SNS topic.&#13;
The second, <code>getObjectFromS3</code>, takes an <code>S3EventNotification​Record</code> and downloads the corresponding file from S3.</p>&#13;
&#13;
<p>These two methods are now called from a refactored <code>handler</code> method, which is where the actual isolation of side effects is realized:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">handler</code><code class="o">(</code><code class="n">S3Event</code> <code class="n">event</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
  <code class="n">List</code><code class="o">&lt;</code><code class="n">WeatherEvent</code><code class="o">&gt;</code> <code class="n">events</code> <code class="o">=</code> <code class="n">event</code><code class="o">.</code><code class="na">getRecords</code><code class="o">().</code><code class="na">stream</code><code class="o">()</code>&#13;
    <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">getObjectFromS3</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">readWeatherEvents</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">flatMap</code><code class="o">(</code><code class="nl">List:</code><code class="o">:</code><code class="n">stream</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">Collectors</code><code class="o">.</code><code class="na">toList</code><code class="o">());</code>&#13;
&#13;
  <code class="c1">// Serialize and publish WeatherEvent messages to SNS</code>&#13;
  <code class="n">events</code><code class="o">.</code><code class="na">stream</code><code class="o">()</code>&#13;
    <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">weatherEventToSnsMessage</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">forEach</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">publishToSns</code><code class="o">);</code>&#13;
&#13;
  <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Published "</code> <code class="o">+</code> <code class="n">events</code><code class="o">.</code><code class="na">size</code><code class="o">()</code>&#13;
    <code class="o">+</code> <code class="s">" weather events to SNS"</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>There’s more going on in this new <code>handler</code> method, but for now just note that <code>get​ObjectFromS3</code> and <code>publishToSns</code> are called from here (and nowhere else).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Split Methods" data-type="sect2"><div class="sect2" id="idm46222416856440">&#13;
<h2>Split Methods</h2>&#13;
&#13;
<p>In<a data-primary="split methods" data-type="indexterm" id="idm46222416618776"/> addition to isolating our side effects, the new <code>handler</code> method now also contains much of our processing logic.&#13;
This might seem contrary to our goal, but this “glue” logic orchestrates a number of simpler, single-purpose methods that are easier to unit test.&#13;
In this case, the <code>readWeatherEvents</code> method no longer requires access to S3 (or to a mock S3 client).&#13;
Its only purpose is to deserialize an <code>InputStream</code> into a collection of <code>WeatherEvent</code> objects and handle errors (by rethrowing a <code>RuntimeException</code>, which will halt the Lambda function).</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">List</code><code class="o">&lt;</code><code class="n">WeatherEvent</code><code class="o">&gt;</code> <code class="nf">readWeatherEvents</code><code class="o">(</code><code class="n">InputStream</code> <code class="n">inputStream</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">try</code> <code class="o">(</code><code class="n">InputStream</code> <code class="n">is</code> <code class="o">=</code> <code class="n">inputStream</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">Arrays</code><code class="o">.</code><code class="na">asList</code><code class="o">(</code>&#13;
      <code class="n">objectMapper</code><code class="o">.</code><code class="na">readValue</code><code class="o">(</code><code class="n">is</code><code class="o">,</code> <code class="n">WeatherEvent</code><code class="o">[].</code><code class="na">class</code><code class="o">));</code>&#13;
  <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">throw</code> <code class="k">new</code> <code class="nf">RuntimeException</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Note<a data-primary="Java" data-secondary="try-with-resources feature" data-type="indexterm" id="idm46222416485000"/> that we’re now using Java’s <a href="https://oreil.ly/LxRNY"><code>try-with-resources</code> feature</a> to automatically close the input stream.&#13;
We also removed the <code>private</code> keyword from this and the <code>weather​EventToSnsMessage</code> method, so those can both be accessed from our test classes as necessary.<a data-primary="" data-startref="BELrefact06" data-type="indexterm" id="idm46222416487032"/><a data-primary="" data-startref="Rbulk06" data-type="indexterm" id="idm46222416586872"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing BulkEventsLambda" data-type="sect1"><div class="sect1" id="idm46222416585912">&#13;
<h1>Testing BulkEventsLambda</h1>&#13;
&#13;
<p>Now<a data-primary="testing" data-secondary="BulkEventsLambda, testing" data-type="indexterm" id="Tbulk06"/> that we’ve refactored, let’s add some unit tests for <code>BulkEventsLambda</code>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unit Testing" data-type="sect2"><div class="sect2" id="idm46222416582760">&#13;
<h2>Unit Testing</h2>&#13;
&#13;
<p>These<a data-primary="BulkEventsLambda" data-secondary="unit testing" data-type="indexterm" id="BLEut06"/><a data-primary="unit tests" data-type="indexterm" id="UT06"/> tests are completely isolated from side effects—we don’t have to configure or connect to any AWS services or any other external dependencies.&#13;
That isolation also means that these tests execute quickly, in just a few milliseconds.&#13;
We have only a few, because <code>BulkEventsLambda</code> is fairly simple, but even hundreds of unit tests written in this style could be run in a few seconds.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46222416577752">&#13;
<h5>Maven Surefire</h5>&#13;
<p>Maven<a data-primary="Maven" data-secondary="Surefire plugin" data-type="indexterm" id="idm46222416576200"/> will automatically run our JUnit-based unit tests during the “test” phase of the build lifecycle, using the <a href="https://oreil.ly/aHfsc">Surefire plug-in</a>.&#13;
We don’t have to add any specific configuration—this will happen automatically as long as our test classes end with the word <em>Test</em> and our tests themselves are annotated properly with the <code>@Test</code> (<code>org.junit.Test</code>) annotation.</p>&#13;
&#13;
<p>If we want to explicitly run the unit tests (and functional tests, as we’ll see in the next section), we can do so by executing the <code>mvn test</code> command.</p>&#13;
</div></aside>&#13;
&#13;
<p>Here’s a unit test for the <code>readWeatherEvents</code> method of <code>BulkEventsLambda</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BulkEventsLambdaUnitTest</code> <code class="o">{</code>&#13;
&#13;
  <code class="nd">@Test</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">testReadWeatherEvents</code><code class="o">()</code> <code class="o">{</code>&#13;
&#13;
    <code class="c1">// Fixture data</code>&#13;
    <code class="n">InputStream</code> <code class="n">inputStream</code> <code class="o">=</code>&#13;
      <code class="n">getClass</code><code class="o">().</code><code class="na">getResourceAsStream</code><code class="o">(</code><code class="s">"/bulk_data.json"</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Construct Lambda function class, and invoke</code>&#13;
    <code class="n">BulkEventsLambda</code> <code class="n">lambda</code> <code class="o">=</code>&#13;
      <code class="k">new</code> <code class="nf">BulkEventsLambda</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="kc">null</code><code class="o">);</code>&#13;
    <code class="n">List</code><code class="o">&lt;</code><code class="n">WeatherEvent</code><code class="o">&gt;</code> <code class="n">weatherEvents</code> <code class="o">=</code>&#13;
      <code class="n">lambda</code><code class="o">.</code><code class="na">readWeatherEvents</code><code class="o">(</code><code class="n">inputStream</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Assert</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mi">3</code><code class="o">,</code> <code class="n">weatherEvents</code><code class="o">.</code><code class="na">size</code><code class="o">());</code>&#13;
&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="s">"Brooklyn, NY"</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">locationName</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mf">91.0</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">temperature</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mi">1564428897L</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">timestamp</code><code class="o">,</code> <code class="mi">0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mf">40.7</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">latitude</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(-</code><code class="mf">73.99</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">longitude</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="s">"Oxford, UK"</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">1</code><code class="o">).</code><code class="na">locationName</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mf">64.0</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">1</code><code class="o">).</code><code class="na">temperature</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mi">1564428897L</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">1</code><code class="o">).</code><code class="na">timestamp</code><code class="o">,</code> <code class="mi">0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mf">51.75</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">1</code><code class="o">).</code><code class="na">latitude</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(-</code><code class="mf">1.25</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">1</code><code class="o">).</code><code class="na">longitude</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="s">"Charlottesville, VA"</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">2</code><code class="o">).</code><code class="na">locationName</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mf">87.0</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">2</code><code class="o">).</code><code class="na">temperature</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mi">1564428897L</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">2</code><code class="o">).</code><code class="na">timestamp</code><code class="o">,</code> <code class="mi">0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code><code class="mf">38.02</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">2</code><code class="o">).</code><code class="na">latitude</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(-</code><code class="mf">78.47</code><code class="o">,</code>&#13;
      <code class="n">weatherEvents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">2</code><code class="o">).</code><code class="na">longitude</code><code class="o">,</code> <code class="mf">0.0</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>For convenience, we’re reading the input data from a JSON file on disk.&#13;
We then create an instance of <code>BulkEventsLambda</code>—notice that we’re simply passing in <code>null</code> for the SNS and S3 clients, because they’re not needed by this test at all.&#13;
The <code>readWeatherEvents</code> method is called, and we assert that it produced the right objects.</p>&#13;
&#13;
<p>We can test the failure case with even less code:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BulkEventsLambdaUnitTest</code> <code class="o">{</code>&#13;
&#13;
  <code class="nd">@Rule</code>&#13;
  <code class="kd">public</code> <code class="n">ExpectedException</code> <code class="n">thrown</code> <code class="o">=</code> <code class="n">ExpectedException</code><code class="o">.</code><code class="na">none</code><code class="o">();</code>&#13;
&#13;
  <code class="nd">@Rule</code>&#13;
  <code class="kd">public</code> <code class="n">EnvironmentVariables</code> <code class="n">environment</code> <code class="o">=</code> <code class="k">new</code> <code class="n">EnvironmentVariables</code><code class="o">();</code>&#13;
&#13;
  <code class="nd">@Test</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">testReadWeatherEventsBadData</code><code class="o">()</code> <code class="o">{</code>&#13;
&#13;
    <code class="c1">// Fixture data</code>&#13;
    <code class="n">InputStream</code> <code class="n">inputStream</code> <code class="o">=</code>&#13;
      <code class="n">getClass</code><code class="o">().</code><code class="na">getResourceAsStream</code><code class="o">(</code><code class="s">"/bad_data.json"</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Expect exception</code>&#13;
    <code class="n">thrown</code><code class="o">.</code><code class="na">expect</code><code class="o">(</code><code class="n">RuntimeException</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="n">thrown</code><code class="o">.</code><code class="na">expectCause</code><code class="o">(</code>&#13;
      <code class="n">CoreMatchers</code><code class="o">.</code><code class="na">instanceOf</code><code class="o">(</code><code class="n">InvalidFormatException</code><code class="o">.</code><code class="na">class</code><code class="o">));</code>&#13;
    <code class="n">thrown</code><code class="o">.</code><code class="na">expectMessage</code><code class="o">(</code>&#13;
      <code class="s">"Can not deserialize value of type java.lang.Long from String"</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Invoke</code>&#13;
    <code class="n">BulkEventsLambda</code> <code class="n">lambda</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BulkEventsLambda</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="kc">null</code><code class="o">);</code>&#13;
    <code class="n">lambda</code><code class="o">.</code><code class="na">readWeatherEvents</code><code class="o">(</code><code class="n">inputStream</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Here we use a <a href="https://oreil.ly/YeLiW">JUnit Rule</a> to assert that an exception of the expected type is thrown by our method.</p>&#13;
&#13;
<p>As unit tests go, these are simple and effective.&#13;
For a more complex Lambda function, we might have dozens of tests like these to test as many logical paths and edge cases as necessary.<a data-primary="" data-startref="BLEut06" data-type="indexterm" id="idm46222415885144"/><a data-primary="" data-startref="UT06" data-type="indexterm" id="idm46222415884200"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Functional Testing" data-type="sect2"><div class="sect2" id="idm46222416582232">&#13;
<h2>Functional Testing</h2>&#13;
&#13;
<p>Like<a data-primary="BulkEventsLambda" data-secondary="functional testing" data-type="indexterm" id="BELfunct06"/><a data-primary="functional tests" data-type="indexterm" id="functionalt06"/> the unit tests, we want our functional tests to run without having to connect to AWS.&#13;
However, unlike the unit tests, we want to test our Lambda function as a single component, and doing so means that we have to convince our code that it’s talking to the cloud! To accomplish this feat of trickery and deceit, we’ll use<a data-primary="Mockito" data-type="indexterm" id="idm46222415879000"/> Mockito to build “mock” instances of the AWS SDK clients configured to return prearranged responses to method calls.&#13;
For example, if our code calls the <code>getObject</code> method on the S3 client, our mock will return an <code>S3Object</code> complete with fixtured test data.</p>&#13;
&#13;
<p>Here’s a functional test for the “happy path”:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BulkEventsLambdaFunctionalTest</code> <code class="o">{</code>&#13;
&#13;
  <code class="nd">@Test</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">testHandler</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
&#13;
    <code class="c1">// Set up mock AWS SDK clients</code>&#13;
    <code class="n">AmazonSNS</code> <code class="n">mockSNS</code> <code class="o">=</code> <code class="n">Mockito</code><code class="o">.</code><code class="na">mock</code><code class="o">(</code><code class="n">AmazonSNS</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="n">AmazonS3</code> <code class="n">mockS3</code> <code class="o">=</code> <code class="n">Mockito</code><code class="o">.</code><code class="na">mock</code><code class="o">(</code><code class="n">AmazonS3</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Fixture S3 event</code>&#13;
    <code class="n">S3Event</code> <code class="n">s3Event</code> <code class="o">=</code> <code class="n">objectMapper</code>&#13;
      <code class="o">.</code><code class="na">readValue</code><code class="o">(</code><code class="n">getClass</code><code class="o">()</code>&#13;
      <code class="o">.</code><code class="na">getResourceAsStream</code><code class="o">(</code><code class="s">"/s3_event.json"</code><code class="o">),</code> <code class="n">S3Event</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="n">String</code> <code class="n">bucket</code> <code class="o">=</code>&#13;
      <code class="n">s3Event</code><code class="o">.</code><code class="na">getRecords</code><code class="o">().</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">getS3</code><code class="o">().</code><code class="na">getBucket</code><code class="o">().</code><code class="na">getName</code><code class="o">();</code>&#13;
    <code class="n">String</code> <code class="n">key</code> <code class="o">=</code>&#13;
      <code class="n">s3Event</code><code class="o">.</code><code class="na">getRecords</code><code class="o">().</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">getS3</code><code class="o">().</code><code class="na">getObject</code><code class="o">().</code><code class="na">getKey</code><code class="o">();</code>&#13;
&#13;
    <code class="c1">// Fixture S3 return value</code>&#13;
    <code class="n">S3Object</code> <code class="n">s3Object</code> <code class="o">=</code> <code class="k">new</code> <code class="n">S3Object</code><code class="o">();</code>&#13;
    <code class="n">s3Object</code><code class="o">.</code><code class="na">setObjectContent</code><code class="o">(</code>&#13;
      <code class="n">getClass</code><code class="o">().</code><code class="na">getResourceAsStream</code><code class="o">(</code><code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="s">"/%s"</code><code class="o">,</code> <code class="n">key</code><code class="o">)));</code>&#13;
    <code class="n">Mockito</code><code class="o">.</code><code class="na">when</code><code class="o">(</code><code class="n">mockS3</code><code class="o">.</code><code class="na">getObject</code><code class="o">(</code><code class="n">bucket</code><code class="o">,</code> <code class="n">key</code><code class="o">)).</code><code class="na">thenReturn</code><code class="o">(</code><code class="n">s3Object</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Fixture environment</code>&#13;
    <code class="n">String</code> <code class="n">topic</code> <code class="o">=</code> <code class="s">"test-topic"</code><code class="o">;</code>&#13;
    <code class="n">environment</code><code class="o">.</code><code class="na">set</code><code class="o">(</code><code class="n">BulkEventsLambda</code><code class="o">.</code><code class="na">FAN_OUT_TOPIC_ENV</code><code class="o">,</code> <code class="n">topic</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Construct Lambda function class, and invoke handler</code>&#13;
    <code class="n">BulkEventsLambda</code> <code class="n">lambda</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BulkEventsLambda</code><code class="o">(</code><code class="n">mockSNS</code><code class="o">,</code> <code class="n">mockS3</code><code class="o">);</code>&#13;
    <code class="n">lambda</code><code class="o">.</code><code class="na">handler</code><code class="o">(</code><code class="n">s3Event</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Capture outbound SNS messages</code>&#13;
    <code class="n">ArgumentCaptor</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">topics</code> <code class="o">=</code>&#13;
      <code class="n">ArgumentCaptor</code><code class="o">.</code><code class="na">forClass</code><code class="o">(</code><code class="n">String</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="n">ArgumentCaptor</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">messages</code> <code class="o">=</code>&#13;
      <code class="n">ArgumentCaptor</code><code class="o">.</code><code class="na">forClass</code><code class="o">(</code><code class="n">String</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="n">Mockito</code><code class="o">.</code><code class="na">verify</code><code class="o">(</code><code class="n">mockSNS</code><code class="o">,</code>&#13;
      <code class="n">Mockito</code><code class="o">.</code><code class="na">times</code><code class="o">(</code><code class="mi">3</code><code class="o">)).</code><code class="na">publish</code><code class="o">(</code><code class="n">topics</code><code class="o">.</code><code class="na">capture</code><code class="o">(),</code>&#13;
        <code class="n">messages</code><code class="o">.</code><code class="na">capture</code><code class="o">());</code>&#13;
&#13;
    <code class="c1">// Assert</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertArrayEquals</code><code class="o">(</code>&#13;
      <code class="k">new</code> <code class="n">String</code><code class="o">[]{</code><code class="n">topic</code><code class="o">,</code> <code class="n">topic</code><code class="o">,</code> <code class="n">topic</code><code class="o">},</code>&#13;
      <code class="n">topics</code><code class="o">.</code><code class="na">getAllValues</code><code class="o">().</code><code class="na">toArray</code><code class="o">());</code>&#13;
    <code class="n">Assert</code><code class="o">.</code><code class="na">assertArrayEquals</code><code class="o">(</code><code class="k">new</code> <code class="n">String</code><code class="o">[]{</code>&#13;
      <code class="s">"{\"locationName\":\"Brooklyn, NY\",\"temperature\":91.0,"</code>&#13;
        <code class="o">+</code> <code class="s">"\"timestamp\":1564428897,\"longitude\":-73.99,"</code>&#13;
        <code class="o">+</code> <code class="s">"\"latitude\":40.7}"</code><code class="o">,</code>&#13;
      <code class="s">"{\"locationName\":\"Oxford, UK\",\"temperature\":64.0,"</code>&#13;
        <code class="o">+</code> <code class="s">"\"timestamp\":1564428898,\"longitude\":-1.25,"</code>&#13;
        <code class="o">+</code> <code class="s">"\"latitude\":51.75}"</code><code class="o">,</code>&#13;
      <code class="s">"{\"locationName\":\"Charlottesville, VA\",\"temperature\":87.0,"</code>&#13;
        <code class="o">+</code> <code class="s">"\"timestamp\":1564428899,\"longitude\":-78.47,"</code>&#13;
        <code class="o">+</code> <code class="s">"\"latitude\":38.02}"</code>&#13;
    <code class="o">},</code> <code class="n">messages</code><code class="o">.</code><code class="na">getAllValues</code><code class="o">().</code><code class="na">toArray</code><code class="o">());</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>The first thing you should note is that this test is <em>much</em> longer than our unit tests.&#13;
Most of that additional code is setting up the mock objects and configuring the environment so that our Lambda function’s <code>handler</code> method thinks it’s running in the cloud.</p>&#13;
&#13;
<p>The second thing to note is that we’re reading the input data from a file on disk.&#13;
<em>s3_event.json</em> is a file that was generated using this <code>sam</code> command:</p>&#13;
&#13;
<pre data-type="programlisting">$ sam local generate-event s3 put &gt; src/test/resources/s3_event.json</pre>&#13;
&#13;
<p>We then changed the <code>key</code> field to reference another local file, <em>bulk_data.json</em>, which represents the weather data that would be stored on S3:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"Records"</code><code class="p">:</code> <code class="p">[</code>&#13;
    <code class="p">{</code>&#13;
      <code class="err">...</code>&#13;
      <code class="nt">"s3"</code><code class="p">:</code> <code class="p">{</code>&#13;
        <code class="nt">"bucket"</code><code class="p">:</code> <code class="p">{</code>&#13;
          <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"example-bucket"</code><code class="p">,</code>&#13;
        <code class="err">...</code>&#13;
        <code class="p">},</code>&#13;
        <code class="nt">"object"</code><code class="p">:</code> <code class="p">{</code>&#13;
          <code class="nt">"key"</code><code class="p">:</code> <code class="s2">"bulk_data.json"</code><code class="p">,</code>&#13;
        <code class="p">}</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">]</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Our mock S3 client returns the contents of the <em>bulk_data.json</em> file when the <code>s3.getObject</code> method is called, and our Lambda function is none the wiser.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46222415629080">&#13;
<h5>JSON Files to Java Objects</h5>&#13;
<p>Some<a data-primary="Jackson library" data-type="indexterm" id="idm46222415627608"/> event types can be easily deserialized from JSON files using the out-of-the-box functionality provided by the <a href="https://oreil.ly/P07R8">Jackson library</a>.&#13;
This allows us to use the sample events generated by the <code>sam</code> CLI or copied from various AWS Web Console sources.</p>&#13;
&#13;
<p>However, some<a data-primary="Java" data-secondary="deserializing legacy JSON formats" data-type="indexterm" id="idm46222415625128"/><a data-primary="input/output" data-secondary="JSON deserialization and serialization" data-type="indexterm" id="idm46222415624152"/> events use legacy JSON formats that aren’t parseable without extra configuration. For an example of this, take a look at the following <code>Single​Event​Lambda​FunctionalTest</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">SingleEventLambdaFunctionalTest</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kd">final</code> <code class="n">ObjectMapper</code> <code class="n">objectMapper</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ObjectMapper</code><code class="o">()</code>&#13;
    <code class="o">.</code><code class="na">registerModule</code><code class="o">(</code><code class="k">new</code> <code class="n">JodaModule</code><code class="o">())</code>&#13;
    <code class="o">.</code><code class="na">enable</code><code class="o">(</code><code class="n">MapperFeature</code><code class="o">.</code><code class="na">ACCEPT_CASE_INSENSITIVE_PROPERTIES</code><code class="o">);</code>&#13;
&#13;
  <code class="o">...</code>&#13;
&#13;
  <code class="nd">@Test</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">testHandler</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
&#13;
    <code class="c1">// Fixture SNS event</code>&#13;
    <code class="n">SNSEvent</code> <code class="n">snsEvent</code> <code class="o">=</code> <code class="n">objectMapper</code><code class="o">.</code><code class="na">readValue</code><code class="o">(</code><code class="n">getClass</code><code class="o">()</code>&#13;
      <code class="o">.</code><code class="na">getResourceAsStream</code><code class="o">(</code><code class="s">"/sns_event.json"</code><code class="o">),</code> <code class="n">SNSEvent</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// Construct Lambda function class, and invoke handler</code>&#13;
    <code class="n">SingleEventLambda</code> <code class="n">lambda</code> <code class="o">=</code> <code class="k">new</code> <code class="n">SingleEventLambda</code><code class="o">();</code>&#13;
    <code class="n">lambda</code><code class="o">.</code><code class="na">handler</code><code class="o">(</code><code class="n">snsEvent</code><code class="o">);</code>&#13;
&#13;
    <code class="o">...</code>&#13;
&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Here we have to configure the Jackson <code>ObjectMapper</code> to use a different module for date handling and parse property names without regard to capitalization.&#13;
If you’re trying to test with an event type that is difficult to parse from JSON, remember that you can always fall back to simply building the Java object in your test code!</p>&#13;
&#13;
<p>We could rewrite the previous test as follows and avoid having to deal with JSON deserialization:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">testHandlerNoJackson</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
&#13;
  <code class="c1">// Fixture SNS content, record, and event</code>&#13;
  <code class="n">SNSEvent</code><code class="o">.</code><code class="na">SNS</code> <code class="n">snsContent</code> <code class="o">=</code> <code class="k">new</code> <code class="n">SNSEvent</code><code class="o">.</code><code class="na">SNS</code><code class="o">()</code>&#13;
    <code class="o">.</code><code class="na">withMessage</code><code class="o">(</code><code class="s">"{\"locationName\":\"Brooklyn, NY\","</code>&#13;
      <code class="o">+</code> <code class="s">"\"temperature\":91.0,\"timestamp\":1564428897,"</code>&#13;
      <code class="o">+</code> <code class="s">"\"longitude\":-73.99,\"latitude\":40.7}"</code><code class="o">);</code>&#13;
  <code class="n">SNSEvent</code><code class="o">.</code><code class="na">SNSRecord</code> <code class="n">snsRecord</code> <code class="o">=</code>&#13;
    <code class="k">new</code> <code class="n">SNSEvent</code><code class="o">.</code><code class="na">SNSRecord</code><code class="o">().</code><code class="na">withSns</code><code class="o">(</code><code class="n">snsContent</code><code class="o">);</code>&#13;
  <code class="n">SNSEvent</code> <code class="n">snsEvent</code> <code class="o">=</code>&#13;
    <code class="k">new</code> <code class="nf">SNSEvent</code><code class="o">()</code>&#13;
      <code class="o">.</code><code class="na">withRecords</code><code class="o">(</code><code class="n">Collections</code><code class="o">.</code><code class="na">singletonList</code><code class="o">(</code><code class="n">snsRecord</code><code class="o">));</code>&#13;
&#13;
  <code class="c1">// Construct Lambda function class, and invoke handler</code>&#13;
  <code class="n">SingleEventLambda</code> <code class="n">lambda</code> <code class="o">=</code> <code class="k">new</code> <code class="n">SingleEventLambda</code><code class="o">();</code>&#13;
  <code class="n">lambda</code><code class="o">.</code><code class="na">handler</code><code class="o">(</code><code class="n">snsEvent</code><code class="o">);</code>&#13;
&#13;
  <code class="n">Assert</code><code class="o">.</code><code class="na">assertEquals</code><code class="o">(</code>&#13;
    <code class="s">"Received weather event:\nWeatherEvent{"</code>&#13;
      <code class="o">+</code> <code class="s">"locationName='Brooklyn, NY', temperature=91.0, "</code>&#13;
      <code class="o">+</code> <code class="s">"timestamp=1564428897, longitude=-73.99, "</code>&#13;
      <code class="o">+</code> <code class="s">"latitude=40.7}\n"</code>&#13;
    <code class="o">,</code> <code class="n">systemOutRule</code><code class="o">.</code><code class="na">getLog</code><code class="o">());</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This avoids the Jackson configuration, but the result is a fair amount of boilerplate to build up the required <code>SNSEvent</code> object.&#13;
We recommend using a combination of these two approaches, depending on the circumstances and the complexity of the event objects.</p>&#13;
</div></aside>&#13;
&#13;
<p>Lastly, we<a data-primary="Simple Notification Service (SNS)" data-type="indexterm" id="idm46222415310472"/> want to assert that <code>BulkEventsLambda</code> publishes messages to SNS, but without actually sending messages to AWS.&#13;
Here we use our mock SNS client and capture the parameters that are passed to the <code>sns.publish</code> method.&#13;
If that method is called the expected number of times with the right parameters, our test passes.</p>&#13;
&#13;
<p>Another functional test asserts that the Lambda function throws an exception if it receives bad input data.&#13;
The last test asserts that an exception is thrown if the <code>FAN_OUT_TOPIC</code> environment variable isn’t set.</p>&#13;
&#13;
<p>These functional tests are more complex to write and take somewhat longer to run, but they give us confidence that <code>BulkEventsLambda</code> will behave as we expect it to when the Lambda runtime calls the <code>handler</code> function with an <code>S3Event</code> object.<a data-primary="" data-startref="Tbulk06" data-type="indexterm" id="idm46222415305992"/><a data-primary="" data-startref="BELfunct06" data-type="indexterm" id="idm46222415304984"/><a data-primary="" data-startref="functionalt06" data-type="indexterm" id="idm46222415304040"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="End-to-End Testing" data-type="sect1"><div class="sect1" id="idm46222415302968">&#13;
<h1>End-to-End Testing</h1>&#13;
&#13;
<p>With<a data-primary="testing" data-secondary="end-to-end tests" data-type="indexterm" id="Tend06"/><a data-primary="end-to-end tests" data-type="indexterm" id="end06"/> the confidence gained from our suite of unit and functional tests, we can focus our most complex and costly testing methodology on the critical path for our application.&#13;
We can also take advantage of our infrastructure-as-code approach to deploy a complete version of our serverless application and infrastructure to AWS, for the sole purpose of running an end-to-end test.&#13;
When the test has completed successfully, we’ll clean up and tear it all down.</p>&#13;
&#13;
<p>To<a data-primary="mvn verify command" data-type="indexterm" id="idm46222415297880"/> run the end-to-end test, we simply need to execute the <code>mvn verify</code> command.&#13;
This uses the<a data-primary="Maven" data-secondary="Failsafe plugin" data-type="indexterm" id="idm46222415296632"/> Maven Failsafe plug-in, which finds test classes that end in <em>*IT</em> and runs them using JUnit.&#13;
In this case, IT stands for integration test, but that’s just Maven nomenclature—we could configure the Failsafe plug-in to use a different suffix.</p>&#13;
&#13;
<p>For our end-to-end test, we exercise our application exactly as it would be used in production.&#13;
We upload a JSON file to an S3 bucket and then assert that the <code>Single EventLambda</code> produces the correct<a data-primary="CloudWatch Logs" data-secondary="end-to-end testing" data-type="indexterm" id="idm46222415293912"/> CloudWatch Logs output.&#13;
From the perspective of the test, our serverless application is a black box.</p>&#13;
&#13;
<p>Here’s the main body of the test method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">endToEndTest</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">InterruptedException</code> <code class="o">{</code>&#13;
  <code class="n">String</code> <code class="n">bucketName</code> <code class="o">=</code> <code class="n">resolvePhysicalId</code><code class="o">(</code><code class="s">"PipelineStartBucket"</code><code class="o">);</code>&#13;
  <code class="n">String</code> <code class="n">key</code> <code class="o">=</code> <code class="n">UUID</code><code class="o">.</code><code class="na">randomUUID</code><code class="o">().</code><code class="na">toString</code><code class="o">();</code>&#13;
  <code class="n">File</code> <code class="n">file</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="o">(</code><code class="n">getClass</code><code class="o">().</code><code class="na">getResource</code><code class="o">(</code><code class="s">"/bulk_data.json"</code><code class="o">).</code><code class="na">getFile</code><code class="o">());</code>&#13;
&#13;
  <code class="c1">// 1. Upload bulk_data file to S3</code>&#13;
  <code class="n">s3</code><code class="o">.</code><code class="na">putObject</code><code class="o">(</code><code class="n">bucketName</code><code class="o">,</code> <code class="n">key</code><code class="o">,</code> <code class="n">file</code><code class="o">);</code>&#13;
&#13;
  <code class="c1">// 2. Check for executions of SingleEventLambda</code>&#13;
  <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">30000</code><code class="o">);</code>&#13;
  <code class="n">String</code> <code class="n">singleEventLambda</code> <code class="o">=</code> <code class="n">resolvePhysicalId</code><code class="o">(</code><code class="s">"SingleEventLambda"</code><code class="o">);</code>&#13;
  <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">logMessages</code> <code class="o">=</code> <code class="n">getLogMessages</code><code class="o">(</code><code class="n">singleEventLambda</code><code class="o">);</code>&#13;
  <code class="n">Assert</code><code class="o">.</code><code class="na">assertThat</code><code class="o">(</code><code class="n">logMessages</code><code class="o">,</code> <code class="n">CoreMatchers</code><code class="o">.</code><code class="na">hasItems</code><code class="o">(</code>&#13;
    <code class="s">"WeatherEvent{locationName='Brooklyn, NY', temperature=91.0, "</code>&#13;
      <code class="o">+</code> <code class="s">"timestamp=1564428897, longitude=-73.99, latitude=40.7}"</code><code class="o">,</code>&#13;
    <code class="s">"WeatherEvent{locationName='Oxford, UK', temperature=64.0, "</code>&#13;
      <code class="o">+</code> <code class="s">"timestamp=1564428898, longitude=-1.25, latitude=51.75}"</code><code class="o">,</code>&#13;
    <code class="s">"WeatherEvent{locationName='Charlottesville, VA', temperature=87.0, "</code>&#13;
      <code class="o">+</code> <code class="s">"timestamp=1564428899, longitude=-78.47, latitude=38.02}"</code>&#13;
  <code class="o">));</code>&#13;
&#13;
  <code class="c1">// 3. Delete object from S3 bucket (to allow a clean CloudFormation teardown)</code>&#13;
  <code class="n">s3</code><code class="o">.</code><code class="na">deleteObject</code><code class="o">(</code><code class="n">bucketName</code><code class="o">,</code> <code class="n">key</code><code class="o">);</code>&#13;
&#13;
  <code class="c1">// 4. Delete Lambda log groups</code>&#13;
  <code class="n">logs</code><code class="o">.</code><code class="na">deleteLogGroup</code><code class="o">(</code>&#13;
    <code class="k">new</code> <code class="nf">DeleteLogGroupRequest</code><code class="o">(</code><code class="n">getLogGroup</code><code class="o">(</code><code class="n">singleEventLambda</code><code class="o">)));</code>&#13;
  <code class="n">String</code> <code class="n">bulkEventsLambda</code> <code class="o">=</code> <code class="n">resolvePhysicalId</code><code class="o">(</code><code class="s">"BulkEventsLambda"</code><code class="o">);</code>&#13;
  <code class="n">logs</code><code class="o">.</code><code class="na">deleteLogGroup</code><code class="o">(</code>&#13;
    <code class="k">new</code> <code class="nf">DeleteLogGroupRequest</code><code class="o">(</code><code class="n">getLogGroup</code><code class="o">(</code><code class="n">bulkEventsLambda</code><code class="o">)));</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Here are a few points worth noting from this example:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The test resolves the actual name (in AWS parlance, the “Physical ID”) of the S3 bucket from our CloudFormation stack.&#13;
This technique for resource discovery is useful because it allows us to deploy named stacks that don’t explicitly specify names for resources (or that use the stack name as part of the resource name).&#13;
This means that we can deploy the same application multiple times in the same account and even the same region, using different names each time for the CloudFormation stack.</p>&#13;
</li>&#13;
<li>&#13;
<p>For simplicity’s sake, our test simply sleeps for 30 seconds before checking if the <code>SingleEventLambda</code> has executed.&#13;
Another approach would be to poll CloudWatch Logs proactively, which would be more reliable, but obviously more <span class="keep-together">complex</span>.</p>&#13;
</li>&#13;
<li>&#13;
<p>We clean up some resources at the end of the test method. We do this so if the test fails, those resources remain available for our investigation into the test failure.&#13;
If we had used JUnit’s <code>@After</code> functionality, that cleanup would happen even if the test failed, thus hampering an investigation.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Now that you’ve seen the test method itself, let’s look at how we set up and tear down the test infrastructure.&#13;
We need to make sure that the S3 bucket, SNS topic, and Lambda functions are in place for our test to run, but we don’t want to create those resources individually. Instead, we want to use the same SAM <em>template.yaml</em> file as we use for production.</p>&#13;
&#13;
<p>For this example, we’re using the<a data-primary="Maven" data-secondary="exec plugin" data-type="indexterm" id="idm46222415114584"/> Maven “exec” plug-in to hook into the build lifecycle’s “pre-integration” phase, which will execute before the end-to-end test.&#13;
Don’t be put off by the fact that we’re using Maven here. You could just as easily do this with a simple shell script or Makefile. What’s important is that we use the same <em>template.yaml</em> file as we would use for production, and if possible, the same AWS CLI commands to deploy our application.</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;plugin&gt;</code>&#13;
  <code class="nt">&lt;groupId&gt;</code>org.codehaus.mojo<code class="nt">&lt;/groupId&gt;</code>&#13;
  <code class="nt">&lt;artifactId&gt;</code>exec-maven-plugin<code class="nt">&lt;/artifactId&gt;</code>&#13;
  <code class="nt">&lt;executions&gt;</code>&#13;
    <code class="nt">&lt;execution&gt;</code>&#13;
      <code class="nt">&lt;id&gt;</code>001-sam-deploy<code class="nt">&lt;/id&gt;</code>&#13;
      <code class="nt">&lt;phase&gt;</code>pre-integration-test<code class="nt">&lt;/phase&gt;</code>&#13;
      <code class="nt">&lt;goals&gt;</code>&#13;
        <code class="nt">&lt;goal&gt;</code>exec<code class="nt">&lt;/goal&gt;</code>&#13;
      <code class="nt">&lt;/goals&gt;</code>&#13;
      <code class="nt">&lt;configuration&gt;</code>&#13;
        <code class="nt">&lt;basedir&gt;</code>${project.parent.basedir}<code class="nt">&lt;/basedir&gt;</code>&#13;
        <code class="nt">&lt;executable&gt;</code>sam<code class="nt">&lt;/executable&gt;</code>&#13;
        <code class="nt">&lt;arguments&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>deploy<code class="nt">&lt;/argument&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>--s3-bucket<code class="nt">&lt;/argument&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>${integration.test.code.bucket}<code class="nt">&lt;/argument&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>--stack-name<code class="nt">&lt;/argument&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>${integration.test.stack.name}<code class="nt">&lt;/argument&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>--capabilities<code class="nt">&lt;/argument&gt;</code>&#13;
          <code class="nt">&lt;argument&gt;</code>CAPABILITY_IAM<code class="nt">&lt;/argument&gt;</code>&#13;
        <code class="nt">&lt;/arguments&gt;</code>&#13;
      <code class="nt">&lt;/configuration&gt;</code>&#13;
    <code class="nt">&lt;/execution&gt;</code>&#13;
  <code class="nt">&lt;/executions&gt;</code>&#13;
<code class="nt">&lt;/plugin&gt;</code></pre>&#13;
&#13;
<p>It takes several lines of XML to describe, but in this example we’re calling the SAM CLI binary with the same arguments that we used in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a>.</p>&#13;
&#13;
<p>The <code>${integration.test.code.bucket}</code> and <code>${integration.test.stack.name}</code> properties come from the top-level <em>pom.xml</em> file and are defined like this:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;properties&gt;</code>&#13;
  <code class="nt">&lt;maven.build.timestamp.format&gt;</code>&#13;
    yyyyMMddHHmmss&#13;
  <code class="nt">&lt;/maven.build.timestamp.format&gt;</code>&#13;
  <code class="nt">&lt;integration.test.code.bucket&gt;</code>&#13;
    ${env.CF_BUCKET}&#13;
  <code class="nt">&lt;/integration.test.code.bucket&gt;</code>&#13;
  <code class="nt">&lt;integration.test.stack.name&gt;</code>&#13;
    chapter6-it-${maven.build.timestamp}&#13;
  <code class="nt">&lt;/integration.test.stack.name&gt;</code>&#13;
<code class="nt">&lt;/properties&gt;</code></pre>&#13;
&#13;
<p>Our Maven process populates the value of <code>${integration.test.code.bucket}</code> with the value of the <code>$CF_BUCKET</code> environment variable, which we’ve used in previous chapters.&#13;
The <code>${maven.build.timestamp.format}</code> <a href="https://oreil.ly/FIl7J"><em>pom.xml</em> documentation</a> tells Maven to construct a human-readable numeric timestamp, which we then use as part of the <code>${integration.test.stack.name}</code>.&#13;
This gives us a (nearly) unique CloudFormation stack name, so multiple end-to-end tests could be run simultaneously using the same AWS account and region (as long as they’re not started in the same <span class="keep-together">second!</span>).</p>&#13;
&#13;
<p>What we don’t see in this Maven configuration are any AWS credentials.&#13;
Processes started by the Maven “exec” plug-in will pick up environment variables automatically, so this will use the AWS environment variables that we’ve been using for the last several chapters without any additional configuration on our part.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46222415051192">&#13;
<h5>Configuring the AWS SDK Versus the CLI</h5>&#13;
<p>The<a data-primary="Java" data-secondary="AWS SDK for Java versions" data-type="indexterm" id="idm46222415049656"/><a data-primary="AWS CLI" data-secondary="configuring for testing" data-type="indexterm" id="idm46222415043368"/> AWS CLI pulls its configuration from two files, <em>~/.aws/config</em> and <em>~/.aws/credentials</em>.&#13;
Unfortunately, while the AWS Java SDK V1 has some knowledge of those files, it doesn’t parse them in the same way as the CLI.</p>&#13;
&#13;
<p>While the AWS CLI uses a <em>profile</em> prefix in the <em>~/.aws/config</em> file, the AWS SDK does not.&#13;
This means that the AWS SDK isn’t able to parse which region to use.&#13;
Therefore, for our “end-to-end” test to run successfully, we need to add a section to the <em>~/.aws/config</em> file as follows:</p>&#13;
&#13;
<pre data-type="programlisting">[default]&#13;
region = us-west-2</pre>&#13;
&#13;
<p>If you’re using a different named profile, just replace <em>default</em> with that profile name.</p>&#13;
&#13;
<p>Alternatively, setting the <code>AWS_REGION</code> environment variable appropriately will have the same effect.&#13;
In AWS-managed environments like CodeBuild, this is done <span class="keep-together">automatically</span>.</p>&#13;
</div></aside>&#13;
&#13;
<p>In most cases you should use separate AWS accounts for your test environments to isolate test infrastructure and data.&#13;
To achieve that here, simply supply a different set of AWS credentials via environment variables.</p>&#13;
&#13;
<p>After our end-to-end test runs, teardown of the CloudFormation stack works in the same way, as part of Maven’s “post-integration-test” lifecycle phase:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;execution&gt;</code>&#13;
  <code class="nt">&lt;id&gt;</code>001-cfn-delete<code class="nt">&lt;/id&gt;</code>&#13;
  <code class="nt">&lt;phase&gt;</code>post-integration-test<code class="nt">&lt;/phase&gt;</code>&#13;
  <code class="nt">&lt;goals&gt;</code>&#13;
    <code class="nt">&lt;goal&gt;</code>exec<code class="nt">&lt;/goal&gt;</code>&#13;
  <code class="nt">&lt;/goals&gt;</code>&#13;
  <code class="nt">&lt;configuration&gt;</code>&#13;
    <code class="nt">&lt;basedir&gt;</code>${project.parent.basedir}<code class="nt">&lt;/basedir&gt;</code>&#13;
    <code class="nt">&lt;executable&gt;</code>aws<code class="nt">&lt;/executable&gt;</code>&#13;
    <code class="nt">&lt;arguments&gt;</code>&#13;
      <code class="nt">&lt;argument&gt;</code>cloudformation<code class="nt">&lt;/argument&gt;</code>&#13;
      <code class="nt">&lt;argument&gt;</code>delete-stack<code class="nt">&lt;/argument&gt;</code>&#13;
      <code class="nt">&lt;argument&gt;</code>--stack-name<code class="nt">&lt;/argument&gt;</code>&#13;
      <code class="nt">&lt;argument&gt;</code>${integration.test.stack.name}<code class="nt">&lt;/argument&gt;</code>&#13;
    <code class="nt">&lt;/arguments&gt;</code>&#13;
  <code class="nt">&lt;/configuration&gt;</code>&#13;
<code class="nt">&lt;/execution&gt;</code></pre>&#13;
&#13;
<p>We’ve now reached the very top of the Test Pyramid.&#13;
The end-to-end test brings a lot of value: it deploys and runs the entire application.&#13;
It tests the critical path just as it would be executed in production.&#13;
However, with that value comes a fairly high cost—we need a lot of extra configuration and setup and teardown code to make sure the test can be run repeatedly and without any affinity to a particular AWS account or region.&#13;
Despite those efforts, this test is still vulnerable to vendor outages, environment changes, and the indeterminate behavior inherent in operating over a global network.</p>&#13;
&#13;
<p>In other words, our end-to-end test is brittle and costly to maintain compared to the unit and functional tests.&#13;
For this reason, you should try to write as few end-to-end tests as possible and instead rely on more, lower-cost tests to fully exercise your <span class="keep-together">application</span>.<a data-primary="" data-startref="Tend06" data-type="indexterm" id="idm46222414889272"/><a data-primary="" data-startref="end06" data-type="indexterm" id="idm46222414888328"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Local Cloud Testing" data-type="sect1"><div class="sect1" id="idm46222414920200">&#13;
<h1>Local Cloud Testing</h1>&#13;
&#13;
<p>For<a data-primary="testing" data-secondary="local cloud testing" data-type="indexterm" id="idm46222414886616"/><a data-primary="fully-local development workflow" data-type="indexterm" id="idm46222414885608"/><a data-primary="development environment" data-secondary="pitfalls of fully-local development workflow" data-type="indexterm" id="idm46222414884968"/> years, an inherent and unassailable property of a good development workflow was the ability to run the entire application or system locally, without touching any external resources.&#13;
For a traditional desktop or server application, this might mean just running the application itself, or perhaps the application and a database.&#13;
For a web application, the list of requirements might include a reverse proxy, a web server, and a job queue.</p>&#13;
&#13;
<p>But what happens when we start using vendor-managed cloud services?&#13;
Our initial reaction might be to try to achieve the same fully local development workflow we were used to before, using tools like <a href="https://oreil.ly/TbcEo">localstack</a> and <code>sam local</code> (<a data-type="xref" href="#sam-local">“sam local invoke”</a>).&#13;
This approach might seem tenable at first, but it quickly puts us at odds with a cloud-first architecture in which we want to take full advantage of scalable, reliable, fully managed services provided by a cloud vendor.&#13;
Most importantly, we don’t want to limit our service choices to only those that enable our development workflow. This is the tail wagging the dog!</p>&#13;
&#13;
<p>What are the difficulties with fully local development in a world of vendor-managed cloud services?&#13;
The fundamental issue is fidelity: it is simply impossible for a local version of a service (like S3 or DynamoDB or Lambda) to have the same properties as the cloud version.&#13;
Even if the local analogue is provided by the vendor (in this case AWS), it will have at least some of the following issues:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Missing features</p>&#13;
</li>&#13;
<li>&#13;
<p>Different (or absent) control plane behavior (e.g., creating DynamoDB tables)</p>&#13;
</li>&#13;
<li>&#13;
<p>Different scaling behavior</p>&#13;
</li>&#13;
<li>&#13;
<p>Different latency (e.g., extremely low latency for the local analogue compared to the cloud service)</p>&#13;
</li>&#13;
<li>&#13;
<p>Different failure modes</p>&#13;
</li>&#13;
<li>&#13;
<p>Different (or no) security controls</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Having run into these issues time after time, we advocate for the pragmatic testing approach taken in this chapter.&#13;
We rely extensively on unit tests to verify the behavior of specific pieces of functionality, and we use those tests to rapidly iterate during development of individual Lambda functions.&#13;
Functional tests exercise the capability of a Lambda function using mocks or stubs in place of AWS SDK clients and other external dependencies.&#13;
Finally, a few full-fledged end-to-end tests let us execute the entire application in the cloud, using the same SAM infrastructure template and CLI commands that we would use in production.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sam-local">&#13;
<h5>sam local invoke</h5>&#13;
<p>The<a data-primary="sam local invoke command" data-type="indexterm" id="idm46222414870760"/> SAM CLI provides a few different methods to execute Lambda functions locally, with or without an API Gateway layer.&#13;
While these methods can be useful for a brief ad hoc test, they fall victim to the issues described in this section.&#13;
The local execution environment of a Lambda function lacks fidelity compared to the actual cloud service.&#13;
We can see this lack of fidelity manifested in a couple of different ways, using <code>sam local invoke</code>.</p>&#13;
&#13;
<p>First, while <code>sam local invoke</code> parses the <em>template.yaml</em> file to find the relevant Lambda resources and paths to local code artifacts, it doesn’t perform any kind of higher-level validation of SAM (or CloudFormation) resources or of the structure of the template in general.</p>&#13;
&#13;
<p>Second, the runtime environment itself differs from the real Lambda platform.&#13;
For example, we can configure our Lambda functions to use less (or more) memory than would be allowed by the Lambda platform, and <code>sam local invoke</code> won’t pick that up.</p>&#13;
&#13;
<p>These issues (and others like them) aren’t significant in isolation.&#13;
The real danger, however, is that tools like <code>sam local invoke</code> allow developers to build up a sense of confidence that a Lambda that correctly executes locally will run without errors in the cloud.&#13;
In many cases, those developers are then confronted by new issues when they finally deploy their applications to the cloud.</p>&#13;
&#13;
<p>Given the simplicity of the Lambda programming model, it’s unclear that <code>sam local invoke</code> adds enough value (over the unit and functional tests described in this chapter) to make it part of a local testing process.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cloud Test Environments" data-type="sect1"><div class="sect1" id="idm46222414864056">&#13;
<h1>Cloud Test Environments</h1>&#13;
&#13;
<p>For<a data-primary="testing" data-secondary="cloud test environments" data-type="indexterm" id="idm46222414862648"/> the unit and functional testing we’ve described in this chapter, a local environment with Java, Maven, and your favorite IDE will suffice nicely.&#13;
For the end-to-end tests, you need access to an AWS account.&#13;
This is all straightforward for a single developer working in isolation, but when working as part of a larger team, it can get more complex.</p>&#13;
&#13;
<p>When you’re working as a part of a larger team, what’s the best way to work with cloud resources?&#13;
We have found that a good place to start is for each developer to have an isolated development account and for the team as a whole to have one account per shared integration environment (e.g., dev, test, staging).&#13;
Things can get tricky when relying on truly shared resources (such as databases or S3 buckets), but in general maintaining isolation during rapid development prevents an entire class of issues ranging from accidental deletion to resource contention.</p>&#13;
&#13;
<p>A rigorous infrastructure-as-code approach makes managing resources in multiple accounts much easier.&#13;
Taking it a step further, an infrastructure-as-code approach to setting up build pipelines means that standing up and deploying a serverless application in a new account might be as simple as deploying a single CloudFormation stack representing the build pipeline, which will then pull the latest source code and deploy the application.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="canary-testing">&#13;
<h5>Canary Testing with CloudWatch Synthetics</h5>&#13;
<p><a href="https://oreil.ly/XbXfP">CloudWatch Synthetics</a> is<a data-primary="CloudWatch Synthetics" data-type="indexterm" id="idm46222414856664"/><a data-primary="testing" data-secondary="canary testing" data-type="indexterm" id="idm46222414855928"/><a data-primary="canary testing" data-type="indexterm" id="idm46222414854984"/> a new service (in preview at the time of writing) that allows developers to create small scripts, called <em>canaries</em>, that exercise a deployed application in the same way a user might.&#13;
Canaries can be run on a schedule or just once, and they can trigger CloudWatch alarms if they fail.&#13;
The code for a canary is written in JavaScript and has access to the Synthetics library as well as <a href="https://oreil.ly/SUDHt">Puppeteer</a> and <a href="https://www.chromium.org/Home">Chromium</a>.&#13;
As you might have guessed, behind-the-scenes canaries are simply managed Lambda functions, and as such they have access to 1GB of RAM and up to a 10-minute timeout.</p>&#13;
&#13;
<p>You might think that this new capability could take the place of end-to-end tests.&#13;
While it can certainly be used across multiple environments (e.g., you can run a canary in your end-to-end test environment), keep in mind that Synthetics is meant to exercise an application from the user’s perspective.&#13;
This means that a canary shouldn’t have access to components or services that a user doesn’t have access too, which precludes testing asynchronous operations and side effects.&#13;
Furthermore, Synthetics tightly couples canary failures to alarms, which isn’t the mechanism by which test failures should be surfaced.</p>&#13;
&#13;
<p>Once Synthetics is generally available, we strongly recommend considering it as part of your application monitoring strategy (see <a data-type="xref" href="ch07.html#ch07">Chapter 7</a>).</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46222414849384">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Testing serverless applications is not substantively different than testing traditional applications—it’s all about finding the right balance of coverage, complexity, cost, and value, and scaling our testing approach to work for a team.</p>&#13;
&#13;
<p>In this chapter, you learned that the Test Pyramid can guide your testing strategy for a serverless application.&#13;
We refactored our Lambda code to ease unit testing and to enable functional testing without a network connection.&#13;
The end-to-end test demonstrated the efficacy of an infrastructure-as-code approach as well as the high degree of complexity inherent in testing a distributed application.</p>&#13;
&#13;
<p>You saw that trying to run cloud services for local testing is subject to a host of issues, especially the lack of fidelity that can be achieved locally. If you want to test a cloud-based application, at some point you have to actually run it in the cloud! Finally, for a team to work effectively in this way, developers should have isolated cloud accounts, and teams should have shared integration environments.</p>&#13;
&#13;
<p>Through testing, we now have confidence that our application will behave as expected.&#13;
In the next chapter, we’ll explore how to gain insight into the behavior of our deployed applications through logging, metrics, and tracing.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exercise" data-type="sect1"><div class="sect1" id="idm46222414827096">&#13;
<h1>Exercise</h1>&#13;
&#13;
<p>The<a data-primary="exercises" data-secondary="testing" data-type="indexterm" id="idm46222414825960"/> code and tests in this chapter exercise S3 and SNS.&#13;
Write an integration test for the <a data-type="xref" href="ch05.html#ch05">Chapter 5</a> application that makes HTTP calls from Java to the deployed API Gateway and then asserts on the responses (and side effects).&#13;
For extra credit, use <a href="https://oreil.ly/ctKPo">Java 11’s new native HTTP client</a>!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>