<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 8. Deploying for Developers"><div class="chapter" id="cloud_native_deployment">
<h1><span class="label">Chapter 8. </span>Deploying for Developers</h1>


<p class="byline">Ana-Maria Mihalceanu</p>
  <blockquote data-type="epigraph" epub:type="epigraph">
    <p>However beautiful the strategy, you should occasionally look at the results.</p>
    <p data-type="attribution">Sir Winston Churchill</p>
  </blockquote>

<p>When computers were extremely large and expensive,<a data-type="indexterm" data-primary="deployment" data-secondary="about" id="idm45310205347712"/> manufacturers often bundled together the software with the hardware.
With the development of mass-market software, this type of operation was time-consuming, and new forms of software distribution emerged.
Today’s development processes focus on decoupling build and deployment activities to facilitate fast software distribution and parallel activities in teams.</p>

<p>The deployment of an application represents the transformation of that software from a packaged artifact to an operational working state.
Modern development days require this transformation to happen as fast as possible in order to get rapid feedback about the running state of our system.</p>

<p>As a developer, your focus is mainly on<a data-type="indexterm" data-primary="DevOps" data-secondary="deployment" data-seealso="deployment" id="idm45310205345072"/> writing performant application code. Yet DevOps is collaboration centric, and
your work should flawlessly blend within the infrastructure. While looking at your deployment process, you should continuously ask yourself, “What instructions would a machine need to execute this deployment as I envisioned it?” and share those with
the colleagues or experts in charge of the infrastructure and automation.
When planning a deployment process, you can make a wish list that you can later scale to more components of the distributed system:</p>

<ul>
<li>
<p>To gradually extend the functionalities of your system, conduct small deployments often.
Using this approach, you can easily roll back to a previously working state in case of failures.</p>
</li>
<li>
<p>Isolate deployment of each microservice, as you should be able to scale or replace it individually.</p>
</li>
<li>
<p>You should be able to reuse in another environment an already deployed <span class="keep-together">microservice</span>.</p>
</li>
<li>
<p>Automate infrastructure deployment and evolve it with your application features.</p>
</li>
</ul>

<p>Regardless of the container orchestration platform where you will deploy any of your microservices, you likely will start by packaging the application and continue with the following:</p>
<ol>
<li>
<p>Building and pushing a container image</p>
</li>
<li>
<p>Choosing and implementing a deployment strategy</p>
</li>

</ol>

<p>As the application deployment progresses throughout various stages or environments, is likely for you to get involved in the following:</p>
<dl>
<dt>Workload management</dt>
<dd>
<p>Refine health checks and the amount of CPU and memory used to avoid slow or nonresponsive functionalities.</p>
</dd>
<dt>Observability aspects</dt>
<dd>
<p>Use metrics, logs, and traces to provide visibility into internals of your distributed systems and measure its outputs.</p>
</dd>
</dl>

<p>This chapter walks you through these activities and explores their impact at scale.</p>






<section data-type="sect1" data-pdf-bookmark="Building and Pushing Container Images"><div class="sect1" id="building-and-pushing-container-images">
<h1>Building and Pushing Container Images</h1>

<p>Deploying applications to containers<a data-type="indexterm" data-primary="deployment" data-secondary="building and pushing container images" data-tertiary="about" id="idm45310205328976"/><a data-type="indexterm" data-primary="container images" data-secondary="building and pushing" data-tertiary="about" id="idm45310205327664"/> requires creating the Java application artifacts and building container images.
By leveraging the recommended artifact formats and practices shared in <a data-type="xref" href="ch06.xhtml#package_management">Chapter 6</a>, we can focus on producing container images.</p>

<p>Starting with Docker’s appearance in 2013,<a data-type="indexterm" data-primary="Docker" data-secondary="about" data-tertiary="building container images" id="idm45310205324336"/><a data-type="indexterm" data-primary="Dockerfile" data-secondary="building container images" id="idm45310205323072"/><a data-type="indexterm" data-primary="Dockerfile" data-secondary="about" id="idm45310205322112"/> building container images using Dockerfiles became popular.
A <em>Dockerfile</em> is a standardized<a data-type="indexterm" data-primary="OS" data-secondary="Docker" data-tertiary="Dockerfile" id="idm45310205320576"/> image format consisting of the base operating system, application artifacts to be added, and required runtime configurations.
Essentially, this file is the blueprint for how your future container will behave.
As explained in <a data-type="xref" href="ch03.xhtml#thinking_in_containers">Chapter 3</a>, besides Docker, you can build container images with tools like<a data-type="indexterm" data-primary="Podman" id="idm45310205318128"/><a data-type="indexterm" data-primary="Buildah" id="idm45310205317376"/><a data-type="indexterm" data-primary="kaniko" id="idm45310205316704"/>
<a href="https://podman.io">Podman</a>, <a href="https://buildah.io">Buildah</a>, and <a href="https://oreil.ly/X1A8A">kaniko</a>.</p>

<p>As DevOps methodology relies on good<a data-type="indexterm" data-primary="collaboration" data-secondary="Dockerfiles at repository root" id="idm45310205313328"/><a data-type="indexterm" data-primary="communication" data-see="collaboration" id="idm45310205312288"/> communication among application developers and infrastructure engineers,
some teams find it best to keep the Dockerfiles at the repository root.
Moreover, scripts or pipelines can further use that location when instrumenting a container image build. In addition to writing your Dockerfile, Java-specific options can help you make container images part of your standard build processes, such as Eclipse JKube or Jib.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Using Java-specific tools to generate and push container images might tempt you to control the entire runtime from application code.
To avoid tight coupling between infrastructure and application code, you should configure those tools with parameters that can be overwritten at build or runtime.
Modern Java frameworks provide customization of configuration files under <em>src/main/resources</em>. The examples from this chapter use parameters in project configuration files to showcase this approach.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Managing Container Images by Using Jib"><div class="sect2" id="managing-container-images-using-jib">
<h2>Managing Container Images by Using Jib</h2>

<p>Google’s <a href="https://oreil.ly/nWoWY">Jib</a> is one<a data-type="indexterm" data-primary="container images" data-secondary="building and pushing" data-tertiary="Jib to manage" id="ch08-jib"/><a data-type="indexterm" data-primary="Jib" id="ch08-jib2"/><a data-type="indexterm" data-primary="deployment" data-secondary="building and pushing container images" data-tertiary="Jib to manage" id="ch08-jib3"/> of the tools that you can use to containerize Java applications without writing a Dockerfile.
It provides a Java library, and Maven and Gradle plug-ins for creating OCI-compatible container images.
Additionally, the tool does not require running the Docker daemon locally in order to produce a container image.</p>

<p>Jib takes advantage of image layering and registry caching to achieve fast, incremental builds.
The tool can create reproducible build images as long as the inputs remain the same.</p>

<p>To begin using Jib within your Maven project,<a data-type="indexterm" data-primary="Maven (Apache)" data-secondary="Jib for building container images" id="idm45310205300016"/><a data-type="indexterm" data-primary="Apache Maven" data-secondary="Jib for building container images" id="idm45310205299024"/> set up the authentication method for the target container registry by using any of the following:</p>

<ul>
<li>
<p>System properties <code>jib.to.auth.username</code> and <code>jib.to.auth.password</code></p>
</li>
<li>
<p><code>&lt;to&gt;</code> section in the plug-in configuration with <code>username</code> and <code>password</code> elements</p>
</li>
<li>
<p>A <code>&lt;server&gt;</code> configuration in <em>~/.m2/settings.xml</em></p>
</li>
<li>
<p>Previous login into a registry with Docker login (credentials in a credential helper or in <em>~/.docker/config.json</em>)</p>
</li>
</ul>
<div data-type="caution"><h6>Caution</h6>
<p>If you are using a specific base image registry, you can set up its credentials by using the <code>&lt;from&gt;</code> section in the plug-in configuration
or <code>jib.from.auth.username</code> and <code>jib.from.auth.password</code> system properties.</p>
</div>

<p>Next, let’s configure the Maven plug-in in your <em>pom.xml</em>:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;project&gt;</code>
    ...
    <code class="nt">&lt;build&gt;</code>
        <code class="nt">&lt;plugins&gt;</code>
            ...
            <code class="nt">&lt;plugin&gt;</code>
                <code class="nt">&lt;groupId&gt;</code>com.google.cloud.tools<code class="nt">&lt;/groupId&gt;</code>
                <code class="nt">&lt;artifactId&gt;</code>jib-maven-plugin<code class="nt">&lt;/artifactId&gt;</code>
                <code class="nt">&lt;version&gt;</code>3.1.4<code class="nt">&lt;/version&gt;</code>
                <code class="nt">&lt;configuration&gt;</code>
                    <code class="nt">&lt;to&gt;</code>
                        <code class="nt">&lt;image&gt;</code>${pathTo.image}<code class="nt">&lt;/image&gt;</code>
                    <code class="nt">&lt;/to&gt;</code>
                <code class="nt">&lt;/configuration&gt;</code>
            <code class="nt">&lt;/plugin&gt;</code>
            ...
        <code class="nt">&lt;/plugins&gt;</code>
    <code class="nt">&lt;/build&gt;</code>
    ...
<code class="nt">&lt;/project&gt;</code></pre>

<p>The image tag configuration is mandatory and is the target path in the container registry.
Now you can build the image to a container registry with a single command:</p>

<pre data-type="programlisting" data-code-language="bash">mvn compile jib:build -DpathTo.image<code class="o">=</code>registry.hub.docker.com/myuser/repo</pre>

<p>If you would like to build and push<a data-type="indexterm" data-primary="Gradle" data-secondary="Jib for building container images" id="idm45310205188544"/> the container image by using Gradle, you can configure the authentication in one of these ways:</p>

<ul>
<li>
<p>Use the <code>to</code> and <code>from</code> section in the plug-in configuration in <em>build.gradle</em>.</p>
</li>
<li>
<p>Connect into a registry with a Docker login command (store credentials in a credential helper or in <em>~/.docker/config.json</em>).</p>
</li>
</ul>

<p>Next, add the plug-in to your <em>build.gradle</em>:</p>

<pre data-type="programlisting" data-code-language="groovy"><code class="n">plugins</code> <code class="o">{</code>
  <code class="n">id</code> <code class="s1">'com.google.cloud.tools.jib'</code> <code class="n">version</code> <code class="s1">'3.1.4'</code>
<code class="o">}</code></pre>

<p>And invoke the following command in a terminal window:</p>

<pre data-type="programlisting" data-code-language="bash">gradle jib --image<code class="o">=</code>registry.hub.docker.com/myuser/repo</pre>

<p>To simplify container image customization when using Jib, some frameworks have integrated the plug-in as a dependency library.<a data-type="indexterm" data-primary="Quarkus" data-secondary="building container images" data-tertiary="Jib for" id="idm45310205166656"/>
For example, Quarkus provides the <em>quarkus-container-image-jib</em> extension for personalizing the container image build process.
Using this extension, we can revisit the Quarkus example from <a data-type="xref" href="ch04.xhtml#dissecting_the_monolith">Chapter 4</a>
and add it using the following Maven command:</p>

<pre data-type="programlisting" data-code-language="bash">mvn quarkus:add-extension -Dextensions<code class="o">=</code><code class="s2">"io.quarkus:quarkus-container-image-jib"</code></pre>

<p>Furthermore, you can customize the image details in <em>src/main/resources/<span class="keep-together">application</span>.properties</em>:</p>

<pre id="quarkuspdb-update-jib-props" data-type="programlisting">quarkus.container-image.builder=jib <a class="co" id="co_deploying_for_developers_CO1-1" href="#callout_deploying_for_developers_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a>

quarkus.container-image.registry=quay.io <a class="co" id="co_deploying_for_developers_CO1-2" href="#callout_deploying_for_developers_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
quarkus.container-image.group=repo <a class="co" id="co_deploying_for_developers_CO1-3" href="#callout_deploying_for_developers_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
quarkus.container-image.name=demo <a class="co" id="co_deploying_for_developers_CO1-4" href="#callout_deploying_for_developers_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a>
quarkus.container-image.tag=1.0.0-SNAPSHOT <a class="co" id="co_deploying_for_developers_CO1-5" href="#callout_deploying_for_developers_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO1-1" href="#co_deploying_for_developers_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The extension used for building (and pushing) container images.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO1-2" href="#co_deploying_for_developers_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The container registry to use.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO1-3" href="#co_deploying_for_developers_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The container image will be part of this group.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO1-4" href="#co_deploying_for_developers_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The name of the container image is optional; if not set, it defaults to the <span class="keep-together">application</span> name.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO1-5" href="#co_deploying_for_developers_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>The tag of the container image is also optional; if not set, it defaults to the application version.</p></dd>
</dl>

<p>Finally, you can build and push the container image:</p>

<pre data-type="programlisting" data-code-language="bash">mvn package -Dquarkus.container-image.push<code class="o">=</code><code class="nb">true</code></pre>

<p>In <a data-type="xref" href="ch03.xhtml#thinking_in_containers">Chapter 3</a>, you read about<a data-type="indexterm" data-primary="attack surface" data-secondary="minimal base images" id="idm45310205039712"/><a data-type="indexterm" data-primary="container images" data-secondary="minimal image size" id="idm45310205076048"/> keeping the container images small. The size of a container image influences the time spent by the orchestrating platform to pull that image from the registry.
Often, the size of the base image used by the <code>FROM</code> instruction influences the size of your container image, and Jib allows you to control
it by changing the <code>baseImage</code> configuration. Moreover, when using Jib, you can also control the ports you expose or the entry point of your container image.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Changing the JVM base image<a data-type="indexterm" data-primary="Java Virtual Machine (JVM)" data-secondary="changing base image on JDK upgrades" id="idm45310205072976"/><a data-type="indexterm" data-primary="Quarkus" data-secondary="building container images" data-tertiary="JVM base image customization" id="idm45310205072064"/><a data-type="indexterm" data-primary="Native Image" data-secondary="GraalVM required" data-tertiary="Quarkus" id="idm45310205070768"/><a data-type="indexterm" data-primary="GraalVM" data-secondary="Native Image" data-tertiary="Quarkus" id="idm45310205069552"/> is also helpful when performing JDK upgrades.
In addition, the Quarkus extension supports customization of the JVM base image (<code>quarkus.jib.base-jvm-image</code>)
and the native base image (<code>quarkus.jib.base-native-image</code>) used for the native binary build.</p>
</div>

<p>The code sample referenced in this section<a data-type="indexterm" data-primary="repositories" data-secondary="book repository" data-tertiary="code for JKube plus Jib" id="idm45310205066608"/><a data-type="indexterm" data-primary="Eclipse" data-secondary="JKube" id="ch08-jkube"/><a data-type="indexterm" data-primary="JKube (Eclipse)" id="ch08-jkube2"/><a data-type="indexterm" data-primary="container images" data-secondary="building and pushing" data-tertiary="Eclipse JKube" id="ch08-jkube3"/><a data-type="indexterm" data-primary="deployment" data-secondary="building and pushing container images" data-tertiary="Eclipse JKube" id="ch08-jkube4"/><a data-type="indexterm" data-primary="Eclipse" data-secondary="JKube" data-tertiary="book code repository" id="idm45310205060208"/><a data-type="indexterm" data-primary="JKube (Eclipse)" data-secondary="book code repository" id="idm45310205036768"/> is available on <a href="https://oreil.ly/AshKo">GitHub</a>.<a data-type="indexterm" data-startref="ch08-jib" id="idm45310205035168"/><a data-type="indexterm" data-startref="ch08-jib2" id="idm45310205034560"/><a data-type="indexterm" data-startref="ch08-jib3" id="idm45310205033952"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Building Container Images with Eclipse JKube"><div class="sect2" id="building-container-images-with-eclipse-jkube">
<h2>Building Container Images with Eclipse JKube</h2>

<p>An alternative tool that a Java developer can use to containerize Java applications without writing Dockerfiles is <a href="https://oreil.ly/Fp5xx">Eclipse JKube</a>.
This community project, supported by the Eclipse Foundation and Red Hat, can help you
build container images and cooperate with Kubernetes. <a data-type="indexterm" data-primary="Fabric8 Maven plug-in" id="idm45310205030384"/><a data-type="indexterm" data-primary="Maven (Apache)" data-secondary="Fabric8 plug-in" id="idm45310205029776"/><a data-type="indexterm" data-primary="Apache Maven" data-secondary="Fabric8 plug-in" id="idm45310205028928"/>The project contains a Maven plug-in that is the refactored and rebranded version of the <a href="https://oreil.ly/dHtw8">Fabric8 Maven plug-in</a>.
At the time of writing this chapter, <a data-type="indexterm" data-primary="Gradle" data-secondary="Eclipse JKube container image builder" id="idm45310205027184"/>Gradle plug-ins are available for technical preview, and support is planned for the future.</p>

<p>To start using the Eclipse JKube Maven <a data-type="indexterm" data-primary="Apache Maven" data-secondary="POM file" data-tertiary="Eclipse JKube plug-in" id="idm45310205025744"/><a data-type="indexterm" data-primary="Maven (Apache)" data-secondary="POM file" data-tertiary="Eclipse JKube plug-in" id="idm45310205024496"/><a data-type="indexterm" data-primary="POM file (Apache Maven)" data-secondary="Eclipse JKube plug-in" id="idm45310205023280"/>plug-in within your project, please add the Kubernetes Maven plug-in to your <em>pom.xml</em>:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;plugin&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.eclipse.jkube<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>kubernetes-maven-plugin<code class="nt">&lt;/artifactId&gt;</code>
    <code class="nt">&lt;version&gt;</code>${jkube.version}<code class="nt">&lt;/version&gt;</code>
<code class="nt">&lt;/plugin&gt;</code></pre>

<p>Let’s add the snippet to the sample Spring Boot application from <a data-type="xref" href="ch04.xhtml#dissecting_the_monolith">Chapter 4</a>.</p>
<div id="example_0801" data-type="example">
<h5><span class="label">Example 8-1. </span>pom.xml configuration file for sample Spring Boot project</h5>

<pre data-type="programlisting" data-code-language="xml"><code class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code><code>
</code><code class="nt">&lt;project</code><code> </code><code class="na">xmlns:xsi=</code><code class="s">"http://www.w3.org/2001/XMLSchema-instance"</code><code>
         </code><code class="na">xmlns=</code><code class="s">"http://maven.apache.org/POM/4.0.0"</code><code>
         </code><code class="na">xsi:schemaLocation=</code><code class="s">"http://maven.apache.org/POM/4.0.0
    https://maven.apache.org/xsd/maven-4.0.0.xsd"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;modelVersion</code><code class="nt">&gt;</code><code>4.0.0</code><code class="nt">&lt;/modelVersion&gt;</code><code>
    </code><code class="nt">&lt;parent</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>org.springframework.boot</code><code class="nt">&lt;/groupId&gt;</code><code>
        </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>spring-boot-starter-parent</code><code class="nt">&lt;/artifactId&gt;</code><code>
        </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>2.5.0</code><code class="nt">&lt;/version&gt;</code><code>
    </code><code class="nt">&lt;/parent&gt;</code><code>
    </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>com.example</code><code class="nt">&lt;/groupId&gt;</code><code>
    </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>demo</code><code class="nt">&lt;/artifactId&gt;</code><code>
    </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>0.0.1-SNAPSHOT</code><code class="nt">&lt;/version&gt;</code><code>
    </code><code class="nt">&lt;name</code><code class="nt">&gt;</code><code>demo</code><code class="nt">&lt;/name&gt;</code><code>
    </code><code class="nt">&lt;description</code><code class="nt">&gt;</code><code>Demo project for Spring Boot</code><code class="nt">&lt;/description&gt;</code><code>
    </code><code class="nt">&lt;properties</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;java.version</code><code class="nt">&gt;</code><code>11</code><code class="nt">&lt;/java.version&gt;</code><code>
        </code><code class="nt">&lt;spring-native.version</code><code class="nt">&gt;</code><code>0.10.5</code><code class="nt">&lt;/spring-native.version&gt;</code><code>
        </code><code class="nt">&lt;jkube.version</code><code class="nt">&gt;</code><code>1.5.1</code><code class="nt">&lt;/jkube.version&gt;</code><code>
        </code><code class="nt">&lt;jkube.docker.registry</code><code class="nt">&gt;</code><code>registry.hub.docker.com</code><code class="nt">&lt;/jkube.docker.registry&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO2-1" href="#callout_deploying_for_developers_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
        </code><code class="nt">&lt;repository</code><code class="nt">&gt;</code><code>myuser</code><code class="nt">&lt;/repository&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO2-2" href="#callout_deploying_for_developers_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
        </code><code class="nt">&lt;tag</code><code class="nt">&gt;</code><code>${project.version}</code><code class="nt">&lt;/tag&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO2-3" href="#callout_deploying_for_developers_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
        </code><code class="nt">&lt;jkube.generator.name</code><code class="nt">&gt;</code><code>
            ${jkube.docker.registry}/${repository}/${project.name}:${tag}
         </code><code class="nt">&lt;/jkube.generator.name&gt;</code><code>
    </code><code class="nt">&lt;/properties&gt;</code><code>
    </code><code class="nt">&lt;dependencies</code><code class="nt">&gt;</code><code>
        ...
    </code><code class="nt">&lt;/dependencies&gt;</code><code>
    </code><code class="nt">&lt;build</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;plugins</code><code class="nt">&gt;</code><code>
            </code><code class="nt">&lt;plugin</code><code class="nt">&gt;</code><code>
                </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>org.eclipse.jkube</code><code class="nt">&lt;/groupId&gt;</code><code>
                </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>kubernetes-maven-plugin</code><code class="nt">&lt;/artifactId&gt;</code><code>
                </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>${jkube.version}</code><code class="nt">&lt;/version&gt;</code><code>
            </code><code class="nt">&lt;/plugin&gt;</code><code>
            ...
        </code><code class="nt">&lt;/plugins&gt;</code><code>
    </code><code class="nt">&lt;/build&gt;</code><code>
    ...
</code><code class="nt">&lt;/project&gt;</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO2-1" href="#co_deploying_for_developers_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>You can provide a default value for the container registry property and override it at build time.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO2-2" href="#co_deploying_for_developers_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>You can provide a default value for the repository property and override it at build time.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO2-3" href="#co_deploying_for_developers_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>You can provide a default value for the tag property and override it at build time. The default image name will be the project name.</p></dd>
</dl>

<p>To produce a container image for that application, run the following at the command line:</p>

<pre data-type="programlisting" data-code-language="bash">mvn k8s:build</pre>

<p>JKube selects opinionated defaults like base images and handcrafted startup scripts, depending on the type of technology stack you are using.
For this case, JKube uses the current local Docker build context for pulling and pushing the container images.</p>

<p>In addition, the image name results from concatenating the values
of the Maven properties <code>${jkube.docker.registry}</code>, <code>${repository}</code>, <code>${project.name}</code>, and ​<code>$⁠{tag}</code> : <code>registry.hub.docker.com/myuser/demo:0.0.1-SNAPSHOT</code>.</p>

<p>Yet, in order to separate the development part from the operational side, we will customize these details and override them at build time.
By customizing the property, <code>jkube.generator.name</code>, you can include a remote registry, repository, image name, and tag of choice:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;jkube.generator.name&gt;</code>
    ${jkube.docker.registry}/${repository}/${project.name}:${tag}
<code class="nt">&lt;/jkube.generator.name&gt;</code></pre>

<p>Now, we can build an image for a remote container registry by using the following command:</p>

<pre data-type="programlisting" data-code-language="bash">mvn k8s:build -Djkube.docker.registry<code class="o">=</code>quay.io -Drepository<code class="o">=</code>repo -Dtag<code class="o">=</code><code class="m">0</code>.0.1</pre>

<p>If you would like to build and push the image to the remote container registry, you can use this:</p>

<pre data-type="programlisting" data-code-language="bash">mvn k8s:build k8s:push -Djkube.docker.registry<code class="o">=</code>quay.io <code class="se">\</code>
      -Drepository<code class="o">=</code>repo -Dtag<code class="o">=</code><code class="m">0</code>.0.1</pre>

<p class="pagebreak-before">This command builds the image <em>quay.io/repo/demo:0.0.1</em> and pushes it to the respective remote registry.</p>
<div data-type="caution"><h6>Caution</h6>
<p>When using remote registries, you need to provide credentials. Eclipse JKube will search for these locations to obtain credentials:</p>

<ul>
<li>
<p>The system properties <code>jkube.docker.username</code> and <code>jkube​.docker.password</code></p>
</li>
<li>
<p>The <code>&lt;authConfig&gt;</code> section in the plug-in configuration with the <code>&lt;username&gt;</code> and <code>&lt;password&gt;</code> elements</p>
</li>
<li>
<p>A <code>&lt;server&gt;</code> configuration in <em>~/.m2/settings.xml</em></p>
</li>
<li>
<p>Previous login into a registry with Docker login (credentials in a credential helper or in <em>~/.docker/config.json</em>)</p>
</li>
<li>
<p>OpenShift configuration in <em>~/.config/kube</em></p>
</li>
</ul>
</div>

<p>You can use the same steps to build and push container images using the <a href="https://oreil.ly/CeYVl">Eclipse JKube Kubernetes Gradle plug-in</a>.
In that case, you should configure the plug-in in <em>build.gradle</em>:</p>

<pre data-type="programlisting" data-code-language="groovy"><code class="n">plugins</code> <code class="o">{</code>
  <code class="n">id</code> <code class="s1">'org.eclipse.jkube.kubernetes'</code> <code class="n">version</code> <code class="s1">'1.5.1'</code>
<code class="o">}</code></pre>

<p>At the command line, you can build the container image by using <code>gradle k8sBuild</code> and push the result with <code>gradle k8sPush</code>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can add <code>k8s:watch</code> goal to the plug-in configuration in order to automatically re-create images or copy new artifacts into running containers when your code changes.<a data-type="indexterm" data-startref="ch08-jkube" id="idm45310204689856"/><a data-type="indexterm" data-startref="ch08-jkube2" id="idm45310204689152"/><a data-type="indexterm" data-startref="ch08-jkube3" id="idm45310204688480"/><a data-type="indexterm" data-startref="ch08-jkube4" id="idm45310204687808"/></p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Deploying to Kubernetes"><div class="sect1" id="deploying-to-kubernetes">
<h1>Deploying to Kubernetes</h1>

<p>With a good understanding of building<a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="about" id="idm45310204685376"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="about" id="idm45310204684128"/> and pushing container images, you can focus on running containers.
When working with distributed systems,<a data-type="indexterm" data-primary="containers" data-secondary="about" data-tertiary="deployment independence" id="idm45310204661536"/> containers help you achieve deployment independency and can isolate application code from failures.</p>

<p>Because a distributed system will likely have more than one microservice, you will need to figure out how<a data-type="indexterm" data-primary="Kubernetes" data-secondary="about" data-tertiary="orchestration tools" id="idm45310204659696"/><a data-type="indexterm" data-primary="orchestration tools" data-seealso="Kubernetes" id="idm45310204658608"/>
to manage those using containers. Orchestration tools can help you manage a large number of containers
as they typically provide the following:</p>

<ul>
<li>
<p>A declarative system configuration</p>
</li>
<li>
<p>Container provisioning and discovery</p>
</li>
<li>
<p>System monitoring and crash recovery</p>
</li>
<li>
<p>Instruments for defining rules and constraints on container placement and <span class="keep-together">performance</span>.</p>
</li>
</ul>

<p><em>Kubernetes</em> is an open source<a data-type="indexterm" data-primary="Kubernetes" data-secondary="about" id="idm45310204652144"/> platform automating deployment, scaling, and management of containerized workloads.
With Kubernetes, you can organize<a data-type="indexterm" data-primary="scalability" data-secondary="Kubernetes deployments" id="idm45310204650880"/> your deployments in such a way that the platform can spin up or remove instances to match the load demand.
Furthermore, Kubernetes can replace and reschedule containers when nodes die.</p>

<p>Features like portability and extensibility increased the popularity of Kubernetes, stimulating community contributions and vendors’ support.
The proven success of Kubernetes to support increasingly complex categories of applications continues to enable enterprise transition to both hybrid cloud and microservices.</p>

<p>With Kubernetes, you can deploy your application(s) in such a way to  have Kubernetes run more instances of your service if load increases, stop instances if load decreases, or spin up new instances should existing ones fail.
As a developer, when you want to deploy to Kubernetes, you need access to a Kubernetes cluster.
A <em>Kubernetes cluster</em> consists<a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="clusters" id="idm45310204648368"/><a data-type="indexterm" data-primary="clusters" data-secondary="Kubernetes clusters" id="idm45310204647088"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="Kubernetes clusters" id="idm45310204646144"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="kubelet" data-tertiary="Kubernetes clusters" id="idm45310204644928"/><a data-type="indexterm" data-primary="nodes in Kubernetes clusters" id="idm45310204643712"/> of a set of nodes that run containerized applications, as shown in <a data-type="xref" href="#components-of-kubernetes">Figure 8-1</a>.</p>

<figure><div id="components-of-kubernetes" class="figure">
<img src="Images/dtjd_0801.png" alt="The components of a Kubernetes cluster" width="600" height="335"/>
<h6><span class="label">Figure 8-1. </span>Kubernetes components (image adapted from <a href="https://oreil.ly/nyzh7">Kubernetes documentation</a>)</h6>
</div></figure>

<p>Every cluster has at least one worker node, and each worker hosts Pods.<a data-type="indexterm" data-primary="namespaces" data-secondary="Kubernetes clusters" id="idm45310204639200"/><a data-type="indexterm" data-primary="Pods" data-secondary="Kubernetes clusters" id="idm45310204638224"/>
Within a cluster, namespaces are used to isolate groups of resources (Pods included).
Pods are the components in direct contact with your running containers,
instantiated from container images previously built and pushed to a container registry.</p>

<p>When you work with Kubernetes, you are using a set of objects that are validated and accepted by the system.
To work with Kubernetes objects,<a data-type="indexterm" data-primary="APIs" data-secondary="Kubernetes API" id="idm45310204636608"/> you need to use the Kubernetes API.
Nowadays it’s possible to instrument Kubernetes deployments by using visual helpers, command-line interfaces, or Java add-ons like Dekorate and JKube to generate and deploy Kubernetes manifests.</p>








<section data-type="sect2" data-pdf-bookmark="Local Setup for Deployment"><div class="sect2" id="idm45310204635376">
<h2>Local Setup for Deployment</h2>

<p>As a developer, you are used to configuring<a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="local setup" id="idm45310204633888"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="local setup" id="idm45310204632640"/> a local setup to implement application features.
Typically, this local setup involves having access to a version control system, and installing and configuring the following:</p>

<ul>
<li>
<p>A JDK</p>
</li>
<li>
<p>Maven or Gradle</p>
</li>
<li>
<p>An IDE like IntelliJ IDEA, Eclipse, or Visual Studio Code</p>
</li>
<li>
<p>Optionally, a database or middleware that integrates with your code</p>
</li>
<li>
<p>One or more tools for building, running, and pushing container images: Docker, Podman, Buildah, Jib, JKube, etc.</p>
</li>
<li>
<p>A Kubernetes development cluster:<a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="clusters" id="idm45310204625056"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="Kubernetes clusters" id="idm45310204623968"/><a data-type="indexterm" data-primary="clusters" data-secondary="Kubernetes clusters" data-tertiary="development clusters" id="idm45310204622880"/><a data-type="indexterm" data-primary="minikube" id="idm45310204621792"/><a data-type="indexterm" data-primary="kind Kubernetes development clusters" id="idm45310204621184"/><a data-type="indexterm" data-primary="Red Hat" data-secondary="CodeReady Containers" id="idm45310204620544"/><a data-type="indexterm" data-primary="resources for learning" data-secondary="Kubernetes" data-tertiary="development clusters" id="idm45310204619600"/> <a href="https://oreil.ly/SfNR3">minikube</a>,  <a href="https://oreil.ly/BcYHp">kind</a>, or <a href="https://oreil.ly/iIkzu">Red Hat CodeReady Containers</a>.
For development purposes,<a data-type="indexterm" data-primary="Docker Desktop" data-secondary="Kubernetes development cluster" id="idm45310204616080"/> <a href="https://oreil.ly/gmh6B">Docker Desktop</a> also offers a single-node Kubernetes cluster that runs locally within your Docker instance.
<a href="https://oreil.ly/09wOS">Rancher Desktop</a> is<a data-type="indexterm" data-primary="Rancher Desktop" id="idm45310204613456"/> another great tool that can help you locally with container management and running Kubernetes.
If running a local development cluster<a data-type="indexterm" data-primary="namespaces" data-secondary="development namespaces in remote clusters" id="idm45310204612592"/><a data-type="indexterm" data-primary="clusters" data-secondary="development namespaces in remote clusters" id="idm45310204611616"/> consumes too many resources, you may prefer to have development namespaces in remote Kubernetes cluster(s)
or use an already provisioned one like<a data-type="indexterm" data-primary="Red Hat" data-secondary="OpenShift" data-tertiary="Developer Sandbox" id="idm45310204610352"/><a data-type="indexterm" data-primary="OpenShift (Red Hat)" data-secondary="Developer Sandbox" id="idm45310204609136"/> <a href="https://oreil.ly/14VUx">Developer Sandbox for Red Hat OpenShift</a>.</p>
</li>
</ul>

<p>Before creating any Kubernetes resources, let’s summarize some Kubernetes concepts:<a data-type="indexterm" data-primary="Kubernetes" data-secondary="terminology" id="idm45310204606800"/><a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="terminology" id="idm45310204605824"/></p>
<dl>
<dt>Cluster</dt>
<dd>
<p>A set of nodes where<a data-type="indexterm" data-primary="clusters" data-secondary="definition" id="idm45310204602720"/><a data-type="indexterm" data-primary="nodes in Kubernetes clusters" data-secondary="cluster definition" id="idm45310204601712"/> you can instruct Kubernetes on deploying containers.</p>
</dd>
<dt>Namespace</dt>
<dd>
<p>A Kubernetes object responsible<a data-type="indexterm" data-primary="namespaces" id="idm45310204599392"/> for isolating groups’ resources based on different permissions.</p>
</dd>
<dt>User</dt>
<dd>
<p>Interaction with the Kubernetes API<a data-type="indexterm" data-primary="user authentication for Kubernetes API" id="idm45310204597200"/><a data-type="indexterm" data-primary="APIs" data-secondary="Kubernetes API" data-tertiary="user authentication for" id="idm45310204596480"/> requires a form of authentication managed through users.</p>
</dd>
<dt>Context</dt>
<dd>
<p>A specific combination that contains<a data-type="indexterm" data-primary="context in Kubernetes" id="idm45310204593776"/> a Kubernetes cluster, a user, and a namespace.</p>
</dd>
<dt>Kubelet</dt>
<dd>
<p>The main agent that runs on each<a data-type="indexterm" data-primary="Kubernetes" data-secondary="kubelet" data-tertiary="about" id="idm45310204591552"/><a data-type="indexterm" data-primary="nodes in Kubernetes clusters" data-secondary="kubelet definition" id="idm45310204590304"/><a data-type="indexterm" data-primary="clusters" data-secondary="kubelet definition" id="idm45310204589296"/> cluster node and ensures that containers are running and healthy, according to pod specifications.</p>
</dd>
<dt>Deployment</dt>
<dd>
<p>A resource that instructs Kubernetes<a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="about" id="idm45310204586832"/><a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="about" id="idm45310204585584"/> on creating or modifying instances of pods with a containerized application.</p>
</dd>
<dt>ReplicaSet</dt>
<dd>
<p>Every time Kubernetes creates<a data-type="indexterm" data-primary="ReplicaSet (Kubernetes)" id="idm45310204582912"/> a deployment, this resource instantiates a ReplicaSet and delegates to it counting pods.</p>
</dd>
<dt>Service</dt>
<dd>
<p>A way to expose an application<a data-type="indexterm" data-primary="Service (Kubernetes)" id="idm45310204580640"/> having multiple instances in different pods as a network service.</p>
</dd>
</dl>

<p>Keeping in mind these concepts, let’s investigate how you can generate Kubernetes objects and deploy them.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Generate Kubernetes Manifests by Using Dekorate"><div class="sect2" id="idm45310204579168">
<h2>Generate Kubernetes Manifests by Using Dekorate</h2>

<p><a href="http://dekorate.io">Dekorate</a> can generate<a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="Dekorate for manifests" id="ch08-manif"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="manifests from Dekorate" id="ch08-manif2"/><a data-type="indexterm" data-primary="manifests in Kubernetes from Dekorate" id="ch08-manif3"/><a data-type="indexterm" data-primary="Dekorate" id="ch08-manif4"/><a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="Dekorate for manifests" id="ch08-manif5"/> Kubernetes manifests at compile time, using Java annotations
and standard Java framework configuration mechanisms. <a data-type="xref" href="#dekorate_dependencies">Table 8-1</a> shows Dekorate Maven dependencies available for Quarkus, Spring Boot, or a generic Java project.</p>
<table id="dekorate_dependencies" style="width: 100%">
<caption><span class="label">Table 8-1. </span>Dekorate Maven dependencies</caption>
<thead>
<tr>
<th>Framework</th>
<th>Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>
Quarkus</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
  <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>
  <code class="nt">&lt;artifactId&gt;</code>quarkus-kubernetes<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre></div></td>
</tr>
<tr>
<td><p>
Spring Boot</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
  <code class="nt">&lt;groupId&gt;</code>io.dekorate<code class="nt">&lt;/groupId&gt;</code>
  <code class="nt">&lt;artifactId&gt;</code>kubernetes-spring-starter<code class="nt">&lt;/artifactId&gt;</code>
  <code class="nt">&lt;version&gt;</code>2.7.0<code class="nt">&lt;/version&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre></div></td>
</tr>
<tr>
<td><p>
Generic Java Application</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>io.dekorate<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>kubernetes-annotations<code class="nt">&lt;/artifactId&gt;</code>
    <code class="nt">&lt;version&gt;</code>2.7.0<code class="nt">&lt;/version&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre></div></td>
</tr>
</tbody>
</table>

<p>Let’s create some Kubernetes resources by adding Dekorate to <a data-type="xref" href="#example_0801">Example 8-1</a>:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code>
<code class="nt">&lt;project</code> <code class="na">xmlns:xsi=</code><code class="s">"http://www.w3.org/2001/XMLSchema-instance"</code>
         <code class="na">xmlns=</code><code class="s">"http://maven.apache.org/POM/4.0.0"</code>
         <code class="na">xsi:schemaLocation=</code><code class="s">"http://maven.apache.org/POM/4.0.0</code>
<code class="s">    https://maven.apache.org/xsd/maven-4.0.0.xsd"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;modelVersion&gt;</code>4.0.0<code class="nt">&lt;/modelVersion&gt;</code>
    <code class="nt">&lt;parent&gt;</code>
        <code class="nt">&lt;groupId&gt;</code>org.springframework.boot<code class="nt">&lt;/groupId&gt;</code>
        <code class="nt">&lt;artifactId&gt;</code>spring-boot-starter-parent<code class="nt">&lt;/artifactId&gt;</code>
        <code class="nt">&lt;version&gt;</code>2.5.0<code class="nt">&lt;/version&gt;</code>
    <code class="nt">&lt;/parent&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>com.example<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>demo<code class="nt">&lt;/artifactId&gt;</code>
    <code class="nt">&lt;version&gt;</code>0.0.1-SNAPSHOT<code class="nt">&lt;/version&gt;</code>
    <code class="nt">&lt;name&gt;</code>demo<code class="nt">&lt;/name&gt;</code>
    <code class="nt">&lt;description&gt;</code>Demo project for Spring Boot<code class="nt">&lt;/description&gt;</code>
    <code class="nt">&lt;properties&gt;</code>
        <code class="nt">&lt;java.version&gt;</code>11<code class="nt">&lt;/java.version&gt;</code>
        <code class="nt">&lt;spring-native.version&gt;</code>0.10.5<code class="nt">&lt;/spring-native.version&gt;</code>
        <code class="nt">&lt;kubernetes-spring-starter.version&gt;</code>
              2.7.0
        <code class="nt">&lt;/kubernetes-spring-starter.version&gt;</code>
    <code class="nt">&lt;/properties&gt;</code>
    <code class="nt">&lt;dependencies&gt;</code>
        <code class="nt">&lt;dependency&gt;</code>
            <code class="nt">&lt;groupId&gt;</code>io.dekorate<code class="nt">&lt;/groupId&gt;</code>
            <code class="nt">&lt;artifactId&gt;</code>kubernetes-spring-starter<code class="nt">&lt;/artifactId&gt;</code>
            <code class="nt">&lt;version&gt;</code>${kubernetes-spring-starter.version}<code class="nt">&lt;/version&gt;</code>
        <code class="nt">&lt;/dependency&gt;</code>
        ...
    <code class="nt">&lt;/dependencies&gt;</code>
    ...
<code class="nt">&lt;/project&gt;</code></pre>

<p>If no configuration is provided, Dekorate will produce a Deployment and Service resource in the manifest created under <em>target/classes/META-INF/dekorate</em>.
This generated Service type is <code>ClusterIP</code> <a data-type="indexterm" data-primary="Service (Kubernetes)" data-secondary="ClusterIP Deployment and Service resource" id="idm45310204485280"/>and makes the application available only within the Kubernetes cluster.
If you want to expose the service externally, using the load balancer of a cloud provider, you
can do that by using a Service resource of type <code>LoadBalancer</code>, as explained in the <a href="https://oreil.ly/uPUm6">Kubernetes documentation</a>.</p>

<p>When working with Dekorate, you can customize the generation of Kubernetes resources by using the following approaches:</p>

<ul>
<li>
<p>Specifying configurations in <code>application.properies</code></p>
</li>
<li>
<p>Adding the <code>@KubernetesApplication</code> annotation to the <code>DemoApplication</code> class</p>
</li>
</ul>

<p>To avoid tight coupling between infrastructure and application code, we customize the Service resource <em>src/main/resources/application.properties</em> by using the following:</p>

<pre id="springboot-update-dekorate-props" data-type="programlisting">dekorate.kubernetes.serviceType=LoadBalancer</pre>

<p>To generate the Kubernetes objects, you can package the application like this:</p>

<pre data-type="programlisting" data-code-language="bash">mvn clean package</pre>

<p>After packaging the application, you will notice among the other files that are created,
two files named <em>kubernetes.json</em> and <em>kubernetes.yml</em> in the <em>target/classes/META-INF/dekorate</em> directory.
Either of these manifests can be used to deploy to Kubernetes:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nn">---</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-1" href="#callout_deploying_for_developers_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.dekorate.io/vcs-url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">&lt;&lt;unknown&gt;&gt;</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-2" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-3" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-4" href="#callout_deploying_for_developers_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-5" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-6" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.dekorate.io/vcs-url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">&lt;&lt;unknown&gt;&gt;</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-7" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-8" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">KUBERNETES_NAMESPACE</code><code class="w">
</code><code class="w">              </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w">
</code><code class="w">                </code><code class="nt">fieldRef</code><code class="p">:</code><code class="w">
</code><code class="w">                  </code><code class="nt">fieldPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">metadata.namespace</code><code class="w">
</code><code class="w">          </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">repo/demo:0.0.1-SNAPSHOT</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-9" href="#callout_deploying_for_developers_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="w">
</code><code class="w">          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IfNotPresent</code><code class="w">
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">          </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-10" href="#callout_deploying_for_developers_CO3-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="w">
</code><code class="w">              </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">              </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w">
</code><code class="nn">---</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-11" href="#callout_deploying_for_developers_CO3-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.dekorate.io/vcs-url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">&lt;&lt;unknown&gt;&gt;</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-12" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-13" href="#callout_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">80</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-14" href="#callout_deploying_for_developers_CO3-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-15" href="#callout_deploying_for_developers_CO3-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w">
</code><code class="w">  </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">LoadBalancer</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO3-16" href="#callout_deploying_for_developers_CO3-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO3-1" href="#co_deploying_for_developers_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>A Deployment provides declarative updates for Pods and ReplicaSets.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-2" href="#co_deploying_for_developers_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Labels are used by selectors to connect the Service to the Pods, but also to align the specifications of <code>Deployment</code> to ReplicaSets and Pods.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-3" href="#co_deploying_for_developers_CO3-4"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Name of the Deployment object.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-4" href="#co_deploying_for_developers_CO3-9"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Container image used by the Deployment.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-5" href="#co_deploying_for_developers_CO3-10"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Port exposed by the container and targeted by the Service.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-6" href="#co_deploying_for_developers_CO3-11"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>A Service exposes the application running on a set of Pods as a network service.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-7" href="#co_deploying_for_developers_CO3-14"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Port used to serve incoming traffic.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO3-8" href="#co_deploying_for_developers_CO3-16"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Expose the service externally using the load balancer of a cloud provider.</p></dd>
</dl>

<p>Assuming you have previously logged in a Kubernetes cluster, you can deploy to it using the command-line interface:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl apply -f target/classes/META-INF/dekorate/kubernetes.yml</pre>

<p>As a result, you can access the application by using the external IP (<code>LoadBalancer Ingress</code>) and port
by Kubernetes after applying the manifests.<a data-type="indexterm" data-startref="ch08-manif" id="idm45310204040256"/><a data-type="indexterm" data-startref="ch08-manif2" id="idm45310204039760"/><a data-type="indexterm" data-startref="ch08-manif3" id="idm45310204039152"/><a data-type="indexterm" data-startref="ch08-manif4" id="idm45310204038544"/><a data-type="indexterm" data-startref="ch08-manif5" id="idm45310204037936"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Generate and Deploy Kubernetes Manifests with Eclipse JKube"><div class="sect2" id="generate-kubernetes-resources-with-jkube">
<h2>Generate and Deploy Kubernetes Manifests with Eclipse JKube</h2>

<p>Eclipse JKube can also generate and deploy<a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="Eclipse JKube" id="ch08-jkubedep"/><a data-type="indexterm" data-primary="Eclipse" data-secondary="JKube" data-tertiary="Kubernetes deployment" id="ch08-jkubedep2"/><a data-type="indexterm" data-primary="JKube (Eclipse)" data-secondary="Kubernetes deployment" id="ch08-jkubedep3"/><a data-type="indexterm" data-primary="OpenShift (Red Hat)" data-secondary="JKube generating manifests" id="ch08-jkubedep4"/><a data-type="indexterm" data-primary="Red Hat" data-secondary="OpenShift" data-tertiary="JKube generating manifests" id="ch08-jkubedep5"/><a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="Eclipse JKube" id="ch08-jkubedep6"/> Kubernetes/OpenShift manifests at compile time.
In addition to creating Kubernetes descriptors (YAML files), you can adjust the output by using the following:</p>

<ul>
<li>
<p>Inline configuration within the XML plug-in configuration</p>
</li>
<li>
<p>External configuration templates of deployment descriptors</p>
</li>
</ul>

<p><a data-type="xref" href="Images/#building-container-images-with-eclipse-jkube">“Building Container Images with Eclipse JKube”</a> explored
building container images with JKube and with Docker daemon integration.
We will reuse the Quarkus sample code
from  <a data-type="xref" href="Images/#managing-container-images-using-jib">“Managing Container Images by Using Jib”</a> to generate and deploy Kubernetes resources with Eclipse JKube and Jib.</p>
<div id="example_0802" data-type="example">
<h5><span class="label">Example 8-2. </span><em>pom.xml</em> configuration file for sampled Quarkus project</h5>

<pre data-type="programlisting" data-code-language="xml"><code class="cp">&lt;?xml version="1.0"?&gt;</code><code>
</code><code class="nt">&lt;project</code><code> </code><code class="na">xsi:schemaLocation=</code><code class="s">"http://maven.apache.org/POM/4.0.0
https://maven.apache.org/xsd/maven-4.0.0.xsd"</code><code>
         </code><code class="na">xmlns=</code><code class="s">"http://maven.apache.org/POM/4.0.0"</code><code>
         </code><code class="na">xmlns:xsi=</code><code class="s">"http://www.w3.org/2001/XMLSchema-instance"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;modelVersion</code><code class="nt">&gt;</code><code>4.0.0</code><code class="nt">&lt;/modelVersion&gt;</code><code>
    </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>com.example.demo</code><code class="nt">&lt;/groupId&gt;</code><code>
    </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>demo</code><code class="nt">&lt;/artifactId&gt;</code><code>
    </code><code class="nt">&lt;name</code><code class="nt">&gt;</code><code>demo</code><code class="nt">&lt;/name&gt;</code><code>
    </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>1.0-SNAPSHOT</code><code class="nt">&lt;/version&gt;</code><code>
    </code><code class="nt">&lt;properties</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;compiler-plugin.version</code><code class="nt">&gt;</code><code>3.8.1</code><code class="nt">&lt;/compiler-plugin.version&gt;</code><code>
        </code><code class="nt">&lt;maven.compiler.parameters</code><code class="nt">&gt;</code><code>true</code><code class="nt">&lt;/maven.compiler.parameters&gt;</code><code>
        </code><code class="nt">&lt;maven.compiler.target</code><code class="nt">&gt;</code><code>11</code><code class="nt">&lt;/maven.compiler.target&gt;</code><code>
        </code><code class="nt">&lt;maven.compiler.source</code><code class="nt">&gt;</code><code>11</code><code class="nt">&lt;/maven.compiler.source&gt;</code><code>
        </code><code class="nt">&lt;project.build.sourceEncoding</code><code class="nt">&gt;</code><code>UTF-8</code><code class="nt">&lt;/project.build.sourceEncoding&gt;</code><code>
        </code><code class="nt">&lt;quarkus-plugin.version</code><code class="nt">&gt;</code><code>2.5.0.Final</code><code class="nt">&lt;/quarkus-plugin.version&gt;</code><code>
        </code><code class="nt">&lt;quarkus.platform.artifact-id</code><code class="nt">&gt;</code><code>quarkus-bom</code><code class="nt">&lt;/quarkus.platform.artifact-id&gt;</code><code>
        </code><code class="nt">&lt;quarkus.platform.group-id</code><code class="nt">&gt;</code><code>io.quarkus</code><code class="nt">&lt;/quarkus.platform.group-id&gt;</code><code>
        </code><code class="nt">&lt;quarkus.platform.version</code><code class="nt">&gt;</code><code>2.5.0.Final</code><code class="nt">&lt;/quarkus.platform.version&gt;</code><code>
        </code><code class="nt">&lt;surefire-plugin.version</code><code class="nt">&gt;</code><code>3.0.0-M5</code><code class="nt">&lt;/surefire-plugin.version&gt;</code><code>
        </code><code class="nt">&lt;jkube.version</code><code class="nt">&gt;</code><code>1.5.1</code><code class="nt">&lt;/jkube.version&gt;</code><code>
        </code><code class="nt">&lt;jkube.generator.name</code><code class="nt">&gt;</code><code>
            ${quarkus.container-image.registry}/${quarkus.container-image.group}
            /${quarkus.container-image.name}:${quarkus.container-image.tag} </code><a class="co" id="co_deploying_for_developers_CO4-1" href="#callout_deploying_for_developers_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
        </code><code class="nt">&lt;/jkube.generator.name&gt;</code><code>
        </code><code class="nt">&lt;jkube.enricher.jkube-service.type</code><code class="nt">&gt;</code><code>
            NodePort
        </code><code class="nt">&lt;/jkube.enricher.jkube-service.type&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO4-2" href="#callout_deploying_for_developers_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
    </code><code class="nt">&lt;/properties&gt;</code><code>
    </code><code class="nt">&lt;dependencyManagement</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;dependencies</code><code class="nt">&gt;</code><code>
            </code><code class="nt">&lt;dependency</code><code class="nt">&gt;</code><code>
                </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>${quarkus.platform.group-id}</code><code class="nt">&lt;/groupId&gt;</code><code>
                </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>${quarkus.platform.artifact-id}</code><code class="nt">&lt;/artifactId&gt;</code><code>
                </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>${quarkus.platform.version}</code><code class="nt">&lt;/version&gt;</code><code>
                </code><code class="nt">&lt;type</code><code class="nt">&gt;</code><code>pom</code><code class="nt">&lt;/type&gt;</code><code>
                </code><code class="nt">&lt;scope</code><code class="nt">&gt;</code><code>import</code><code class="nt">&lt;/scope&gt;</code><code>
            </code><code class="nt">&lt;/dependency&gt;</code><code>
        </code><code class="nt">&lt;/dependencies&gt;</code><code>
    </code><code class="nt">&lt;/dependencyManagement&gt;</code><code>
    </code><code class="nt">&lt;dependencies</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;dependency</code><code class="nt">&gt;</code><code>
            </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>io.quarkus</code><code class="nt">&lt;/groupId&gt;</code><code>
            </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>quarkus-container-image-jib</code><code class="nt">&lt;/artifactId&gt;</code><code>
        </code><code class="nt">&lt;/dependency&gt;</code><code>
        ...
    </code><code class="nt">&lt;/dependencies&gt;</code><code>
    </code><code class="nt">&lt;build</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;plugins</code><code class="nt">&gt;</code><code>
            </code><code class="nt">&lt;plugin</code><code class="nt">&gt;</code><code>
                </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>org.eclipse.jkube</code><code class="nt">&lt;/groupId&gt;</code><code>
                </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>kubernetes-maven-plugin</code><code class="nt">&lt;/artifactId&gt;</code><code>
                </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>${jkube.version}</code><code class="nt">&lt;/version&gt;</code><code>
                </code><code class="nt">&lt;configuration</code><code class="nt">&gt;</code><code>
                    </code><code class="nt">&lt;buildStrategy</code><code class="nt">&gt;</code><code>jib</code><code class="nt">&lt;/buildStrategy&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO4-3" href="#callout_deploying_for_developers_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
                </code><code class="nt">&lt;/configuration&gt;</code><code>
            </code><code class="nt">&lt;/plugin&gt;</code><code>
            ...
        </code><code class="nt">&lt;/plugins&gt;</code><code>
    </code><code class="nt">&lt;/build&gt;</code><code>
    ...
</code><code class="nt">&lt;/project&gt;</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO4-1" href="#co_deploying_for_developers_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>For consistency, you can reuse the Quarkus extension properties within the JKube image name.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO4-2" href="#co_deploying_for_developers_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Expose the service on each node’s IP at a static port (the <code>NodePort</code>).</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO4-3" href="#co_deploying_for_developers_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Specify that the build strategy is Jib.</p></dd>
</dl>

<p>We can now invoke the container image build (<code>k8s:build</code>) and create a Kubernetes resource (<code>k8s:resource</code>) in a single command:</p>

<pre data-type="programlisting" data-code-language="bash">mvn package k8s:build k8s:resource <code class="se">\</code>
    -Dquarkus.container-image.registry<code class="o">=</code>quay.io <code class="se">\</code>
    -Dquarkus.container-image.group<code class="o">=</code>repo <code class="se">\</code>
    -Dquarkus.container-image.name<code class="o">=</code>demo <code class="se">\</code>
    -Dquarkus.container-image.tag<code class="o">=</code><code class="m">1</code>.0.0-SNAPSHOT</pre>

<p>The following structure will appear under <em>target/classes/META-INF/jkube</em>:</p>

<pre data-type="programlisting">|-- kubernetes
|   |-- demo-deployment.yml
|   `-- demo-service.yml
`-- kubernetes.yml</pre>

<p><em>kubernetes.yml</em> contains both the Deployment and the Service resource definition,
while in the <em>kubernetes</em> folder you have them separated in two distinct files.</p>

<p>As we did for the Dekorate manifest, we can deploy <em>kubernetes.yml</em> by using the command-line interface:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl apply -f target/classes/META-INF/jkube/kubernetes.yml</pre>

<p>Or you can use the <code>k8s:apply</code> Maven goal of the JKube plug-in to achieve the same result:</p>

<pre data-type="programlisting" data-code-language="bash">mvn k8s:apply</pre>

<p>This goal will search for the previously generated files and apply them to the connected Kubernetes cluster.
The application will be reachable using the cluster IP and the assigned node port.</p>

<p>Furthermore, you can model the interaction between the generated resources and  the Kubernetes cluster with more plug-in goals.
<a data-type="xref" href="#additional_jkube_goals">Table 8-2</a> lists other goals available with the Kubernetes Maven plug-in.</p>
<table id="additional_jkube_goals" style="width: 100%">
<caption><span class="label">Table 8-2. </span>Eclipse JKube additional goals</caption>
<thead>
<tr>
<th>Goal</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><div>
<p><code>k8s:log</code></p></div></td>
<td><p>
Gets the logs from your running container in Kubernetes</p></td>
</tr>
<tr>
<td><div>
<p><code>k8s:debug</code></p></div></td>
<td><p>
Opens the debug port so that you can debug the application deployed in Kubernetes from your IDE</p></td>
</tr>
<tr>
<td><div>
<p><code>k8s:watch</code></p></div></td>
<td><p>
Does an automatic deployment of your application by watching your application context</p></td>
</tr>
<tr>
<td><div>
<p><code>k8s:deploy</code></p></div></td>
<td><p>
Forks the Install goal and applies your generated manifests onto a Kubernetes cluster</p></td>
</tr>
<tr>
<td><div>
<p><code>k8s:undeploy</code></p></div></td>
<td><p>
Deletes all of the resources applied with <code>k8s:apply</code></p></td>
</tr>
</tbody>
</table>

<p>Now that you have seen how to deploy to Kubernetes, let’s see how we can refine this by choosing and implementing a deployment strategy.<a data-type="indexterm" data-startref="ch08-jkubedep" id="idm45310203562992"/><a data-type="indexterm" data-startref="ch08-jkubedep2" id="idm45310203562384"/><a data-type="indexterm" data-startref="ch08-jkubedep3" id="idm45310203561776"/><a data-type="indexterm" data-startref="ch08-jkubedep4" id="idm45310203561168"/><a data-type="indexterm" data-startref="ch08-jkubedep5" id="idm45310203560560"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Choose and Implement a Deployment Strategy"><div class="sect2" id="choosing-and-implementing-a-deployment-strategy">
<h2>Choose and Implement a Deployment Strategy</h2>

<p>Deploying a single application to Kubernetes<a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="strategies" id="ch08-stratg"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="strategies" id="ch08-stratg2"/> can be an easy task when using the right tools.
As developers, we should also think ahead and decide how we might replace an old version of a microservice
with a newer one without downtime.</p>

<p>When you choose a deployment strategy to Kubernetes,<a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="quotas" id="idm45310203554832"/><a data-type="indexterm" data-primary="quotas in Kubernetes deployments" id="idm45310203553584"/><a data-type="indexterm" data-primary="instances of application" id="idm45310203552944"/> you need to look into establishing these quotas:</p>

<ul>
<li>
<p>Number of desired instances for your application</p>
</li>
<li>
<p>Minimum healthy running instances</p>
</li>
<li>
<p>Maximum instances</p>
</li>
</ul>

<p>The ideal situation is to have the number of desired running instances in the shortest time possible
while using minimal resources (CPU, memory). But let’s try the already established methodologies
and compare their performance.</p>

<p>All-in-one deployment using<a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="Recreate strategy" id="idm45310203548304"/><a data-type="indexterm" data-primary="Recreate deployment strategy" id="idm45310203547360"/> the <code>Recreate</code>  strategy is the simplest available when using Kubernetes Deployment objects:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Recreate</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO5-1" href="#callout_deploying_for_developers_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">revisionHistoryLimit</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">15</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO5-2" href="#callout_deploying_for_developers_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">4</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/repo/demo:1.0.0-SNAPSHOT</code><code class="w">
</code><code class="w">        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IfNotPresent</code><code class="w">
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quarkus</code><code class="w">
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO5-1" href="#co_deploying_for_developers_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The deployment strategy is <code>Recreate</code>.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO5-2" href="#co_deploying_for_developers_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>You can set <code>revisionHistoryLimit</code> to specify the number of old ReplicaSets for this deployment that you want to retain.
By default, Kubernetes stores the last 10 ReplicaSets.</p></dd>
</dl>

<p>Whenever the preceding specification is applied in a cluster, Kubernetes will take down all the current running pod instances, and once they are terminated,
will bring up new ones. We do not need to set up a minimum and maximum number of instances, only the number of desired instances (4).</p>

<p>In this example, Kubernetes does not delete the previous ReplicaSet immediately after performing an update.
Instead, it keeps the ReplicaSet around with a replicas count of 0.
If the deployment introduced a change that breaks the stability of the system, we can roll back to a previous working version by choosing from the old ReplicaSets.</p>

<p>You can find out the previous revisions by running the following command:</p>

<pre data-type="programlisting" data-code-language="bash"> kubectl rollout <code class="nb">history</code> deployment/demo</pre>

<p>And roll back to a previous version by using the following:</p>

<pre data-type="programlisting" data-code-language="bash"> kubectl rollout undo deployment/demo --to-revision<code class="o">=[</code>revision-number<code class="o">]</code></pre>

<p>Although this strategy is efficient in terms of memory and amount of CPU consumption, it introduces
a gap in time when the microservice is unavailable.</p>

<p>Another Kubernetes built-in strategy<a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="RollingUpdate strategy" id="idm45310203355344"/><a data-type="indexterm" data-primary="RollingUpdate deployment strategy" id="idm45310203354608"/> is <code>RollingUpdate</code>, where the current running instances are slowly replaced by the new ones:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RollingUpdate</code><code class="w">
</code><code class="w">    </code><code class="nt">rollingUpdate</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">maxUnavailable</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO6-1" href="#callout_deploying_for_developers_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">maxSurge</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO6-2" href="#callout_deploying_for_developers_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">4</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO6-3" href="#callout_deploying_for_developers_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/repo/demo:1.0.0-SNAPSHOT</code><code class="w">
</code><code class="w">        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IfNotPresent</code><code class="w">
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quarkus</code><code class="w">
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO6-1" href="#co_deploying_for_developers_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Maximum number of Pods that can be unavailable when performing the <span class="keep-together">deployment</span></p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO6-2" href="#co_deploying_for_developers_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Maximum number of Pods that can be created over the desired number of Pods</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO6-3" href="#co_deploying_for_developers_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Desired number of Pods</p></dd>
</dl>

<p>By focusing on the maximum number of the unavailable Pods, this strategy safely upgrades your deployment, without experiencing any downtime.
But, depending on your microservice startup time, the entire transition to the newer version of the deployment can take longer to complete.
If the deployment introduces a change that breaks the stability of the system, Kubernetes will update the Deployment template
but will keep the previous running Pods.</p>
<div data-type="caution"><h6>Caution</h6>
<p>The rolling deployment is the <a data-type="indexterm" data-primary="RollingUpdate deployment strategy" data-secondary="default deployment" id="idm45310203178368"/><a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="default RollingUpdate" id="idm45310203177376"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="default RollingUpdate" id="idm45310203176160"/>standard default deployment to Kubernetes if you do not fill in a strategy in the object <code>spec</code>.</p>
</div>

<p>If your application is using a database, you should consider the impact of having two application versions running simultaneously.
Another disadvantage with this strategy is that during the upgrade, there will be a mix of old and new versions
of the application. If you want to keep the zero downtime and avoid mixing application versions in production, take
a look at the blue/green deployment technique.</p>

<p><em>Blue/green deployment</em> is a strategy<a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="blue/green strategy" id="ch08-blue"/><a data-type="indexterm" data-primary="blue/green deployment strategy" id="ch08-blue2"/> that reduces downtime and risk of failure by running two identical (production) environments named Blue and Green; see <a data-type="xref" href="#blue-green-setup">Figure 8-2</a>.
When using this deployment strategy, no new instances will serve user requests until all become available;
at that moment, all old instances become instantly unavailable. You can achieve this by orchestrating services
and routing requests.</p>

<figure><div id="blue-green-setup" class="figure">
<img src="Images/dtjd_0802.png" alt="Blue/Green deployment strategy" width="600" height="214"/>
<h6><span class="label">Figure 8-2. </span>Blue/green strategy</h6>
</div></figure>

<p>Let’s observe how we can implement blue/green deployments by using standard Kubernetes objects:</p>
<ol>
<li>
<p>Apply the blue version of the microservice having the label  <code>version: blue</code>. We will associate the convention of <em>blue deployment</em> by using the value of the label <code>version</code>:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl apply -f blue_deployment_sample.yml</pre>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"/>
<code class="w">    </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">blue</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo-blue</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"/>
<code class="w">      </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">blue</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"/>
<code class="w">        </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">blue</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx:1.14.2</code><code class="w"/>
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-demo</code><code class="w"/>
<code class="w">          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IfNotPresent</code><code class="w"/>
<code class="w">          </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">80</code><code class="w"/>
<code class="w">          </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
</li>
<li>
<p>Expose this deployment by using a Kubernetes Service. After this, traffic is served from the blue version:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl expose deployment demo-blue --selector<code class="o">=</code><code class="s2">"version=blue"</code>
        --type<code class="o">=</code>LoadBalancer</pre>
</li>
<li>
<p>Apply the <em>green deployment</em> of a microservice having the label <code>version: green</code>:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl apply -f green_deployment_sample.yml</pre>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"/>
<code class="w">    </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">green</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo-green</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"/>
<code class="w">      </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">green</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w"/>
<code class="w">        </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">green</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx:1.14.2</code><code class="w"/>
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-demo</code><code class="w"/>
<code class="w">          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IfNotPresent</code><code class="w"/>
<code class="w">          </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">80</code><code class="w"/>
<code class="w">          </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
</li>
<li>
<p>Switch the traffic from blue deployment to green by patching the Service object:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl patch svc/demo -p <code class="s1">'{"spec":{"selector":{"version":"green"}}}'</code></pre>
</li>
<li>
<p>If the blue deployment is no longer needed, you can remove it by using <code>kubectl delete</code>.</p>
</li>

</ol>

<p>Although this deployment strategy is more complex and requires more resources, you can shorten the time between software development and user feedback.
This approach is less disruptive for experimenting with features; if any issues appear after a deployment, you can quickly route to a previous stable version.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can explore a blue/green deployment<a data-type="indexterm" data-primary="Istio" data-secondary="blue/green deployment strategy" id="idm45310202651056"/><a data-type="indexterm" data-primary="Knative blue/green deployment strategy" id="idm45310202617568"/> strategy with more cloud native tools that are compatible with Kubernetes,
such as <a href="https://istio.io">Istio</a> and <a href="https://knative.dev">Knative</a>.<a data-type="indexterm" data-startref="ch08-blue" id="idm45310202615424"/><a data-type="indexterm" data-startref="ch08-blue2" id="idm45310202614688"/></p>
</div>

<p>The last strategy that we will look at is a <em>canary deployment</em>.<a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="canary strategy" id="idm45310202670784"/><a data-type="indexterm" data-primary="canary deployment strategy" id="idm45310202669808"/>
This is a way to reduce risk and validate new system features by releasing software to a small percentage of users.
Performing a canary deployment allows you to try out the new version of
a microservice with a small user audience without replacing any of the existing instances of the application.
To evaluate the behavior of the deployments<a data-type="indexterm" data-primary="load balancer in deployment" id="idm45310202669040"/> (canary and existing), you should implement a load balancer configuration
on top of the service instances and add weighted routing to choose how much traffic is routed to each resource.</p>

<p>Currently, the canary strategy can be achieved by adding an extra layer of tools (<a data-type="xref" href="#istio-canary-setup">Figure 8-3</a>).
API gateways with weighted routing support<a data-type="indexterm" data-primary="API gateways" data-secondary="weighted routing support" id="idm45310202667056"/> let you manage your API endpoints and decide the amount of traffic routed toward them.
Service mesh control planes<a data-type="indexterm" data-primary="Istio" data-secondary="service mesh control plane" id="idm45310202665888"/><a data-type="indexterm" data-primary="service mesh control planes" id="idm45310202664976"/><a data-type="indexterm" data-primary="service-to-service communication control" id="idm45310202664288"/> like Istio are a solution compatible with Kubernetes that can help you
to control service-to-service communication over a network and the percentage of user traffic to each service version.</p>

<figure><div id="istio-canary-setup" class="figure">
<img src="Images/dtjd_0803.png" alt="Weighted traffic routing in Istio" width="600" height="340"/>
<h6><span class="label">Figure 8-3. </span>Canary strategy using weighted traffic routing in Istio</h6>
</div></figure>

<p>If you still struggle to choose a deployment mechanism, check out <a data-type="xref" href="#deployment_strategies">Table 8-3</a>, which summarizes characteristics of the
previously discussed strategies.<a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="strategy summary table" id="idm45310202660320"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="strategy summary table" id="idm45310202613216"/><a data-type="indexterm" data-startref="ch08-stratg" id="idm45310202612032"/><a data-type="indexterm" data-startref="ch08-stratg2" id="idm45310202611360"/></p>
<table id="deployment_strategies" style="width: 100%">
<caption><span class="label">Table 8-3. </span>Characteristics of the deployment strategies</caption>
<thead>
<tr>
<th/>
<th>Re-create</th>
<th>Rolling update</th>
<th>Blue/green</th>
<th>Canary</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>
Out of the box in Kubernetes</p></td>
<td><p>
Yes</p></td>
<td><p>
Yes</p></td>
<td><p>
No</p></td>
<td><p>
No</p></td>
</tr>
<tr>
<td><p>
Downtime occurrence</p></td>
<td><p>
Yes</p></td>
<td><p>
No</p></td>
<td><p>
No</p></td>
<td><p>
No</p></td>
</tr>
<tr>
<td><p>
Rollback process</p></td>
<td><p>
Manually roll out a previous version</p></td>
<td><p>
Stop rollout and keep the previous version</p></td>
<td><p>
Switch traffic to previous version</p></td>
<td><p>
Delete canary instance</p></td>
</tr>
<tr>
<td><p>
Traffic control</p></td>
<td><p>
No</p></td>
<td><p>
No</p></td>
<td><p>
Yes</p></td>
<td><p>
Yes</p></td>
</tr>
<tr>
<td><p>
Traffic sent simultaneously to old and new version</p></td>
<td><p>
No</p></td>
<td><p>
Yes</p></td>
<td><p>
No</p></td>
<td><p>
Yes</p></td>
</tr>
</tbody>
</table>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Managing Workloads in Kubernetes"><div class="sect1" id="idm45310204686752">
<h1>Managing Workloads in Kubernetes</h1>

<p>An application running on Kubernetes is a <em>workload</em>.<a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="about" id="idm45310202587152"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="workload management" data-tertiary="about" id="idm45310202586176"/><a data-type="indexterm" data-primary="clusters" data-secondary="workloads" id="idm45310202584960"/><a data-type="indexterm" data-primary="Pods" data-secondary="workloads" id="idm45310202584016"/>
In the cluster, your workload will run on one or several Pods having a defined lifecycle. To simplify Pod lifecycle management,
Kubernetes provides several built-in workload resources:<a data-type="indexterm" data-primary="Pods" data-secondary="workloads" data-tertiary="Kubernetes resources" id="idm45310202582944"/></p>
<dl>
<dt>Deployment and ReplicaSet</dt>
<dd>
<p>Help manage a stateless application workload.<a data-type="indexterm" data-primary="ReplicaSet (Kubernetes)" id="idm45310202580064"/><a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="definition" id="idm45310202579360"/></p>
</dd>
<dt>StatefulSet</dt>
<dd>
<p>Enables you to run a stateful application either as a single instance or as a replicated set.<a data-type="indexterm" data-primary="StatefulSet (Kubernetes)" id="idm45310202577056"/></p>
</dd>
<dt>Job and CronJob</dt>
<dd>
<p>Define tasks that run to completion and then stop.<a data-type="indexterm" data-primary="Job (Kubernetes)" id="idm45310202575040"/><a data-type="indexterm" data-primary="CronJob (Kubernetes)" id="idm45310202574336"/> These types of resources are useful when implementing batch-processing activities.
Jobs are one-off tasks, while CronJobs run according to a schedule.</p>
</dd>
<dt>DaemonSet</dt>
<dd>
<p>Can help you to define Pods with functionalities impacting the entire node. Scheduling the workload using this type of resource is rare.<a data-type="indexterm" data-primary="DaemonSet (Kubernetes)" id="idm45310202571936"/></p>
</dd>
</dl>

<p>Earlier, we generated and deployed Kubernetes manifests containing a Deployment specification, as typically microservices are stateless applications.
But how can we prevent failure for those microservices that depend on an external service or persist their data in a database?
Moreover, as a microservice codebase evolves, how can it use a fair share of memory and CPU?</p>








<section data-type="sect2" data-pdf-bookmark="Setting Up Health Checks"><div class="sect2" id="idm45310202570592">
<h2>Setting Up Health Checks</h2>

<p>Another benefit of working with<a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="health checks" id="ch08-health"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="workload management" data-tertiary="health checks" id="ch08-health2"/><a data-type="indexterm" data-primary="microservices" data-secondary="health checks" id="ch08-health3"/><a data-type="indexterm" data-primary="health checks for microservices" id="ch08-health4"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying to" data-tertiary="health checks" id="ch08-health5"/><a data-type="indexterm" data-primary="deployment" data-secondary="Kubernetes" data-tertiary="health checks" id="ch08-health6"/><a data-type="indexterm" data-primary="clusters" data-secondary="workloads" data-tertiary="health checks" id="ch08-health7"/> distributed systems and in the cloud is that microservices independence often stimulates automated deployments.
As automated deployments can occur several times per day, on multiple instances, you need a way to validate that your application is available and running as expected.
Each increase in the number of components in the system brings with it an increase in the probability of failure: a deadlock,
a host becoming unavailable, a hardware failure, etc. To detect issues before they propagate as outages, we can validate the status of a microservice by using health checks.</p>

<p>Health checks should span across the entire system, from application code to infrastructure.
Infrastructure can use application health checks to determine when to serve traffic using readiness probes or to restart the container via liveness probes.
You should know that<a data-type="indexterm" data-primary="liveness probes" id="idm45310202558736"/><a data-type="indexterm" data-primary="readiness probes" id="idm45310202558032"/> a liveness probe does not always execute after the readiness probe succeeds.
When your application needs additional time to initialize, you can  define the amount of time in seconds to wait before executing the probe or use a startup probe to check if the container has started.</p>

<p>At the Kubernetes level, the <em>kubelet</em> is the<a data-type="indexterm" data-primary="Kubernetes" data-secondary="kubelet" data-tertiary="health checks" id="idm45310202556144"/> component that uses liveness, readiness, and startup probes to assess the state of your containers.
The kubelet uses readiness probes to check when a container is ready to start accepting traffic, and liveness probes to know when to restart it.
You can use any of these three mechanisms to implement liveness, readiness, or startup probes:</p>

<ul>
<li>
<p>Opening a TCP socket against a container</p>
</li>
<li>
<p>Making an HTTP request against a containerized application that exposes API endpoints</p>
</li>
<li>
<p>Running a command inside a container in case your application uses a protocol different from HTTP or TCP</p>
</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>With Kubernetes v1.23, a gRPC health probe mechanism is available as an alpha feature.
Please keep an eye on the evolution of the<a data-type="indexterm" data-primary="health checks for microservices" data-secondary="Kubernetes health probe documentation" id="idm45310202550176"/><a data-type="indexterm" data-primary="resources for learning" data-secondary="Kubernetes" data-tertiary="health probe documentation" id="idm45310202549264"/> <a href="https://oreil.ly/IDsqC">Kubernetes health probe documentation</a>.</p>
</div>

<p>The simplest way of implementing<a data-type="indexterm" data-primary="APIs" data-secondary="health checks" id="idm45310202546672"/> a health check is to periodically evaluate the running application by sending requests to some of its API endpoints.
You can determine the health of the system based on the response payload.
Typically, these health endpoints are HTTP GET or HEAD requests that do not change the state of the system and perform a lightweight task.
You can define a <em>/health</em> endpoint in a RESTful API  to check the internal status of your microservice or you can use framework-compatible dependencies:</p>

<p>The <a href="https://oreil.ly/rNxMx">Actuator</a> module<a data-type="indexterm" data-primary="Spring Boot" data-secondary="Actuator" data-tertiary="health checks" id="idm45310202544048"/><a data-type="indexterm" data-primary="Actuator (Spring Boot)" id="idm45310202542768"/> provides useful insight into a Spring environment running applications.
Actuator has functions for health checking and gathers metrics by exposing multiple endpoints over HTTP and Java Management Extensions (JMX).</p>

<p>You can add the Actuator module to your Spring Boot project as a Maven or Gradle dependency (see <a data-type="xref" href="#actuator_dependency">Table 8-4</a>) and can access the default health endpoints at
<em>/actuator/health</em>.</p>
<table id="actuator_dependency" style="width: 100%">
<caption><span class="label">Table 8-4. </span>Actuator as Maven or Gradle dependency</caption>
<thead>
<tr>
<th>Build tool</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>
Maven</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
  <code class="nt">&lt;groupId&gt;</code>org.springframework.boot<code class="nt">&lt;/groupId&gt;</code>
  <code class="nt">&lt;artifactId&gt;</code>spring-boot-starter-actuator<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre></div></td>
</tr>
<tr>
<td><p>
Gradle</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="groovy"><code class="n">dependencies</code> <code class="o">{</code>
  <code class="n">compile</code><code class="o">(</code><code class="s2">"org.springframework.boot:spring-boot-starter-actuator"</code><code class="o">)</code>
<code class="o">}</code></pre></div></td>
</tr>
</tbody>
</table>

<p>With Actuator, you can check the health of individual components with health indicators or have a composite health check with composite health contributors.
You can work with several predefined health indicators, including <code>DataSourceHealth​Indi⁠cator</code>,
<code>MongoHealthIndicator</code>, <code>RedisHealthIndicator</code>, and <code>CassandraHealthIndicator</code>. These implement the <code>HealthIndicator</code> interface, which enables you to check the health of that component.
For example, if your application is using a database to persist data, the database health indicator will be automatically added by Spring Boot if it detects a datasource.
The health check consists of creating a connection to a database to perform a simple query.</p>

<p>Although using the built-in health indicators saves you development time, sometimes you should
investigate the health of dependent systems aggregated together.
Spring Boot will aggregate all health indicators it finds in the application context under the <code>/actuator/health</code> endpoint.
Yet, if a health check on one of the dependent systems is unsuccessful, the composite probe will fail.
For such cases, you should consider implementing the <code>CompositeHealthContributor</code> interface in a Spring bean
or treating the potential failure by offering a fallback response.</p>

<p>The MicroProfile Health module allows services to report their health, and it publishes the overall health status to a defined endpoint.<a data-type="indexterm" data-primary="Quarkus" data-secondary="health checks" id="idm45310202479712"/>
Quarkus applications can use the<a data-type="indexterm" data-primary="SmallRye Health extension" id="idm45310202478608"/>  <a href="https://oreil.ly/r9QuE">SmallRye Health extension</a>, which is an implementation<a data-type="indexterm" data-primary="Eclipse" data-secondary="MicroProfile Health Check" id="idm45310202477152"/> of the Eclipse MicroProfile Health Check specification.
You can add the extension to your Maven or Gradle configuration by using snippets from <a data-type="xref" href="#smallrye_health_dependency">Table 8-5</a>.</p>
<table id="smallrye_health_dependency" style="width: 100%">
<caption><span class="label">Table 8-5. </span>SmallRye Health as Maven or Gradle dependency</caption>
<thead>
<tr>
<th>Build tool</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>
Maven</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
   <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>
   <code class="nt">&lt;artifactId&gt;</code>quarkus-smallrye-health<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre></div></td>
</tr>
<tr>
<td><p>
Gradle</p></td>
<td><div>
<pre data-type="programlisting" data-code-language="groovy"><code class="n">dependencies</code> <code class="o">{</code>
    <code class="n">implementation</code> <code class="s1">'io.quarkus:quarkus-smallrye-health'</code>
<code class="o">}</code></pre></div></td>
</tr>
</tbody>
</table>

<p>All health-check procedures in the application are accumulated in the <code>/q/health</code> REST endpoint.
Some Quarkus extensions provide default health checks.
This means that the extension can automatically register its health checks.</p>

<p>For example, when using a Quarkus datasource, the <code>quarkus-agroal</code> extension automatically registers a readiness health check that will validate that datasource.
You can disable automatic registration of the extension health check via the property <code>quarkus.health.extensions.enabled</code>.</p>

<p>When you investigate the health of dependent systems, you can define your own health checks by implementing <code>org.eclipse.microprofile.health.HealthCheck</code>
and use <code>@Liveness</code>, <code>@Readiness</code>, and <code>@Startup</code> to distinguish the role of each check.
A composite health check inspects the condition of the dependent systems aggregated together.
Yet this approach is counterproductive if one of the dependent systems fails.
A more proactive strategy involves offering a fallback response and monitoring a set of metrics showing the application’s health.
These are more useful as they offer early notifications about a system’s deteriorating health, giving us time to take mitigating measures.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Besides the automatic readiness probes when adding specific extensions,
Quarkus comes with some health-check implementations for you to check the status of various components:</p>

<ul>
<li>
<p><code>SocketHealthCheck</code> checks if the host is reachable using a socket.</p>
</li>
<li>
<p><code>UrlHealthCheck</code> checks if the host is reachable using an HTTP URL connection.</p>
</li>
<li>
<p><code>InetAddressHealthCheck</code> checks if the host is reachable using the <code>InetAddress.isReachable</code> method.</p>
</li>
</ul>
</div>

<p>When you implement health checks using REST endpoints at the application level, you will likely invoke those using an HTTP request from a probe.
Kubernetes probes consult these endpoints to determine the health of your container.
A probe has configuration parameters to control its behavior, including the following:</p>

<ul>
<li>
<p>How often to execute the probe (<code>periodSeconds</code>)</p>
</li>
<li>
<p>How long to wait after starting the container to initiate the probe (<code>initialDelaySeconds</code>)</p>
</li>
<li>
<p>Number of seconds after which the probe is considered failed (<code>timeoutSeconds</code>)</p>
</li>
<li>
<p>Number of times the probe can fail before giving up (<code>failureThreshold</code>)</p>
</li>
<li>
<p>Minimum consecutive successes for the probe to be considered successful after having failed (<code>successThreshold</code>)</p>
</li>
</ul>

<p>The tools we have previously used to generate Kubernetes manifests (Dekorate and Eclipse JKube) can help you start working with health probes.
For example, let’s add the Actuator dependency to the Spring Boot project and package the application by using the following:</p>

<pre data-type="programlisting" data-code-language="bash">mvn clean package</pre>

<p>The Kubernetes manifest file from <em>target/classes/dekorate/</em> will contain specifications for health probes:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nn">---</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w">
</code><code class="c1">#[...]</code><code class="w">
</code><code class="nn">---</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.dekorate.io/vcs-url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">&lt;&lt;unknown&gt;&gt;</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.dekorate.io/vcs-url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">&lt;&lt;unknown&gt;&gt;</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.0.1-SNAPSHOT</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">KUBERNETES_NAMESPACE</code><code class="w">
</code><code class="w">              </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w">
</code><code class="w">                </code><code class="nt">fieldRef</code><code class="p">:</code><code class="w">
</code><code class="w">                  </code><code class="nt">fieldPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">metadata.namespace</code><code class="w">
</code><code class="w">          </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">repo/demo:0.0.1-SNAPSHOT</code><code class="w">
</code><code class="w">          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IfNotPresent</code><code class="w">
</code><code class="w">          </code><code class="nt">livenessProbe</code><code class="p">:</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-1" href="#callout_deploying_for_developers_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">failureThreshold</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-2" href="#callout_deploying_for_developers_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">httpGet</code><code class="p">:</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-3" href="#callout_deploying_for_developers_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="w">
</code><code class="w">              </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/actuator/info</code><code class="w">
</code><code class="w">              </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">
</code><code class="w">              </code><code class="nt">scheme</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">HTTP</code><code class="w">
</code><code class="w">            </code><code class="nt">initialDelaySeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-4" href="#callout_deploying_for_developers_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">periodSeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">30</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-5" href="#callout_deploying_for_developers_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">successThreshold</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-6" href="#callout_deploying_for_developers_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">timeoutSeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">10</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-7" href="#callout_deploying_for_developers_CO7-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code class="w">
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">          </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">
</code><code class="w">              </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">              </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w">
</code><code class="w">          </code><code class="nt">readinessProbe</code><code class="p">:</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-8" href="#callout_deploying_for_developers_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">failureThreshold</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-9" href="#callout_deploying_for_developers_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">httpGet</code><code class="p">:</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-10" href="#callout_deploying_for_developers_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="w">
</code><code class="w">              </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/actuator/health</code><code class="w">
</code><code class="w">              </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">
</code><code class="w">              </code><code class="nt">scheme</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">HTTP</code><code class="w">
</code><code class="w">            </code><code class="nt">initialDelaySeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-11" href="#callout_deploying_for_developers_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">periodSeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">30</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-12" href="#callout_deploying_for_developers_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">successThreshold</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-13" href="#callout_deploying_for_developers_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">timeoutSeconds</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">10</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO7-14" href="#callout_deploying_for_developers_CO7-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO7-1" href="#co_deploying_for_developers_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Declaration of readiness and liveness probe is within the container specification.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO7-2" href="#co_deploying_for_developers_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The probe can fail three times before giving up.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO7-3" href="#co_deploying_for_developers_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The probe should make an HTTP GET request against the container.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO7-4" href="#co_deploying_for_developers_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Wait 0 seconds after starting the container to initiate the probe.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO7-5" href="#co_deploying_for_developers_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Execute the probe every 30 seconds.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO7-6" href="#co_deploying_for_developers_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Minimum one consecutive success for the probe to be considered successful after having failed.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO7-7" href="#co_deploying_for_developers_CO7-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>After 10 seconds, the probe is considered failed.</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>Depending on the tech stack that you use, <a href="https://oreil.ly/guUR9">Eclipse JKube</a> has a list of enrichers
that can help you adjust health checks.</p>
</div>

<p>Now that you have used application health checks to ensure that the system is performing as expected,<a data-type="indexterm" data-startref="ch08-health" id="idm45310201828736"/><a data-type="indexterm" data-startref="ch08-health2" id="idm45310201828032"/><a data-type="indexterm" data-startref="ch08-health3" id="idm45310201827360"/><a data-type="indexterm" data-startref="ch08-health4" id="idm45310201826688"/><a data-type="indexterm" data-startref="ch08-health5" id="idm45310201826016"/><a data-type="indexterm" data-startref="ch08-health6" id="idm45310201825344"/><a data-type="indexterm" data-startref="ch08-health7" id="idm45310201824672"/>
we can look into fine-tuning resource quotas for containerized applications.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Adjusting Resource Quotas"><div class="sect2" id="adjusting-resource-quotas">
<h2>Adjusting Resource Quotas</h2>

<p>A common practice is to have several users<a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="adjusting resource quotas" id="ch08-adjqu"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="workload management" data-tertiary="adjusting resource quotas" id="ch08-adjqu2"/><a data-type="indexterm" data-primary="clusters" data-secondary="workloads" data-tertiary="adjusting resource quotas" id="ch08-adjqu3"/><a data-type="indexterm" data-primary="ResourceQuota Kubernetes object" id="ch08-adjqu4"/> or teams share a cluster with a fixed number of nodes.
To facilitate a fair share of resources for each deployed application, cluster administrators establish a <code>ResourceQuota</code> object.
This object provides constraints that limit resource consumption for a namespace.</p>

<p>When you define specifications for a Pod, you can specify the amount of resources each container will need.<a data-type="indexterm" data-primary="Kubernetes" data-secondary="kubelet" data-tertiary="resource limit enforcement" id="idm45310201815792"/>
Requests define the minimum amount of resources that containers need, while limits define the maximum amount of resources that the container can consume.
The kubelet enforces those limits for the running container.</p>

<p>For a container, the common resources to specify<a data-type="indexterm" data-primary="containers" data-secondary="resource limit specification" id="idm45310201814016"/><a data-type="indexterm" data-primary="Pods" data-secondary="workloads" data-tertiary="resource limit specification" id="idm45310201813024"/><a data-type="indexterm" data-primary="CPU resource limit specification" id="idm45310201811792"/><a data-type="indexterm" data-primary="memory resource limit specification" id="idm45310201811104"/> are CPU and memory. For each container of a Pod, you can define them as follows:</p>

<ul>
<li>
<p><code>spec.containers[].resources.limits.cpu</code></p>
</li>
<li>
<p><code>spec.containers[].resources.limits.memory</code></p>
</li>
<li>
<p><code>spec.containers[].resources.requests.cpu</code></p>
</li>
<li>
<p><code>spec.containers[].resources.requests.memory</code></p>
</li>
</ul>

<p>In Kubernetes, the CPU is  assigned with values in millicores or millicpu, and memory is measured in bytes.
The kubelet collects metrics such as<a data-type="indexterm" data-primary="Kubernetes" data-secondary="metrics server" id="idm45310201805328"/><a data-type="indexterm" data-primary="resources for learning" data-secondary="Kubernetes" data-tertiary="metrics server" id="idm45310201804352"/><a data-type="indexterm" data-primary="metrics server (Kubernetes)" id="idm45310201803136"/> CPU and memory from your Pods and can check them using <a href="https://oreil.ly/31lKM">Metrics Server</a>.</p>

<p>As your containers start to compete for resources, you should carefully divide the CPU and memory based on limits and requests.
To achieve that, you need the following:</p>

<ul>
<li>
<p>A tool or practice to programmatically generate traffic for your application. For local development purposes, you can start<a data-type="indexterm" data-primary="hey tool" id="idm45310201800112"/><a data-type="indexterm" data-primary="Apache JMeter" id="idm45310201799408"/><a data-type="indexterm" data-primary="JMeter (Apache)" id="idm45310201798736"/> with tools like <a href="https://oreil.ly/rJK0q">hey</a>
or <a href="https://oreil.ly/pvNfd">Apache JMeter</a>.</p>
</li>
<li>
<p>A tool or practice to collect metrics and decide how to set requests and limits for CPU and memory.
For example, on local minikube installations, you can enable the<a data-type="indexterm" data-primary="minikube" data-secondary="enabling metrics server add-on" id="idm45310201795632"/> <a href="https://oreil.ly/9Ix3p"><code>metrics-server</code> add-on</a>.</p>
</li>
</ul>

<p>Next, you can add the resource limits and requests to your existing container specification.
You can also have them generated<a data-type="indexterm" data-primary="Dekorate" data-secondary="resource limits" id="idm45310202241680"/><a data-type="indexterm" data-primary="Quarkus" data-secondary="Dekorate resource limits" id="idm45310202240704"/> if you are using Dekorate and have them defined at the application configuration level.
For example, in the case of Quarkus, you can add the Kubernetes extension that includes Dekorate:</p>

<pre data-type="programlisting" data-code-language="bash">mvn quarkus:add-extension -Dextensions<code class="o">=</code><code class="s2">"io.quarkus:quarkus-kubernetes"</code></pre>

<p>and configure them in <em>src/main/resources/application.properties</em>:</p>

<pre data-type="programlisting" class="console-input">quarkus.kubernetes.resources.limits.cpu=200m
quarkus.kubernetes.resources.limits.memory=230Mi
quarkus.kubernetes.resources.requests.cpu=100m
quarkus.kubernetes.resources.requests.memory=115Mi</pre>

<p>These configurations can be customized when packaging the application.
After running <code>mvn clean package</code>, note<a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="resource specifications" id="idm45310202204048"/> that the newly generated Deployment object includes resource specifications:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.quarkus.io/build-timestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2021-12-11</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">-</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">16:51:44</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">+0000</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.0.0-SNAPSHOT</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.0.0-SNAPSHOT</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.quarkus.io/build-timestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2021-12-11</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">-</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">16:51:44</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">+0000</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.0.0-SNAPSHOT</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">KUBERNETES_NAMESPACE</code><code class="w">
</code><code class="w">              </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w">
</code><code class="w">                </code><code class="nt">fieldRef</code><code class="p">:</code><code class="w">
</code><code class="w">                  </code><code class="nt">fieldPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">metadata.namespace</code><code class="w">
</code><code class="w">          </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/repo/demo:1.0.0-SNAPSHOT</code><code class="w">
</code><code class="w">          </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w">
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">demo</code><code class="w">
</code><code class="w">          </code><code class="nt">resources</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="nt">limits</code><code class="p">:</code><code class="w">
</code><code class="w">              </code><code class="nt">cpu</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">200m</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO8-1" href="#callout_deploying_for_developers_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="w">              </code><code class="nt">memory</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">230Mi</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO8-2" href="#callout_deploying_for_developers_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">requests</code><code class="p">:</code><code class="w">
</code><code class="w">              </code><code class="nt">cpu</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">100m</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO8-3" href="#callout_deploying_for_developers_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="w">              </code><code class="nt">memory</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">115Mi</code><code class="w"> </code><a class="co" id="co_deploying_for_developers_CO8-4" href="#callout_deploying_for_developers_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO8-1" href="#co_deploying_for_developers_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The container is limited to use maximum 200 millicores (m) and 230 mebibytes (MiB).</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO8-2" href="#co_deploying_for_developers_CO8-3"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The container can request a minimum 100 m and 115 MiB.</p></dd>
</dl>
<div data-type="caution"><h6>Caution</h6>
<p>If a container specifies a memory limit but does not specify a memory request, Kubernetes automatically assigns a memory request that matches the limit.
If a container specifies a CPU limit but does not specify a CPU request, Kubernetes automatically assigns a CPU request that matches the limit.<a data-type="indexterm" data-startref="ch08-adjqu" id="idm45310202290576"/><a data-type="indexterm" data-startref="ch08-adjqu2" id="idm45310202289872"/><a data-type="indexterm" data-startref="ch08-adjqu3" id="idm45310202289200"/><a data-type="indexterm" data-startref="ch08-adjqu4" id="idm45310202288528"/></p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Working with Persistent Data Collections"><div class="sect2" id="idm45310201823616">
<h2>Working with Persistent Data Collections</h2>

<p>A basic principle of microservices is that each<a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="persistent data collections" id="idm45310202286112"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="workload management" data-tertiary="persistent data collections" id="idm45310202285104"/><a data-type="indexterm" data-primary="data" data-secondary="persistent data collections" id="idm45310202283872"/><a data-type="indexterm" data-primary="persistent data collections" id="idm45310202282912"/><a data-type="indexterm" data-primary="microservices" data-secondary="persistent data collections" id="idm45310202282224"/><a data-type="indexterm" data-primary="databases" data-secondary="persistent data collections" id="idm45310202281264"/> service manages its own data.
If services share the same underlying data schemas, unintentional coupling between services can occur,
thus endangering independent deployments.</p>

<p>If you are working with NoSQL databases, like CouchDB or MongoDB, don’t worry about database changes,
as altering the data structure can be performed from application code.</p>

<p>On the other hand, if you are using a standard SQL
database, you can use<a data-type="indexterm" data-primary="Flyway" id="idm45310202279376"/><a data-type="indexterm" data-primary="Liquibase" id="idm45310202278672"/> tools like <a href="https://flywaydb.org">Flyway</a> or <a href="https://liquibase.org">Liquibase</a> to handle schema changes.
These tools can help you generate migration scripts and keep track of which of those were run in the database and which were not yet applied.
When any of these migration tools is invoked, it will scan the available migration scripts, identify ones
that have not been run on a particular database, and then execute those.</p>

<p>When investigating the options from <a data-type="xref" href="#choosing-and-implementing-a-deployment-strategy">“Choose and Implement a Deployment Strategy”</a>, you should consider the following:</p>

<ul>
<li>
<p>Both database schema versions must work well with the application versions used during the deployment phase.</p>
</li>
<li>
<p>Ensure that you have a schema compatibility with the previous working version of your containerized application.</p>
</li>
<li>
<p>Changing a column’s data type requires converting all values stored according to the old column definition.</p>
</li>
<li>
<p>Renaming a column, a table, or a view are backward-incompatible operations unless you use triggers or a programmatic migration script.</p>
</li>
</ul>

<p>By separating application deployments from applying migration scripts, you can independently manage your microservices.
Most of the time, cloud providers offer several datasources as part of their cloud service.
These types of offerings might be the right option for your workloads if you are looking for database solutions without having to manage and maintain the underlying layers.
Nevertheless, also consider how to protect, manage, and secure sensitive data when using a managed database service.</p>

<p>Should databases run in Kubernetes? The answer to this question depends on how the Kubernetes way to manage workload and traffic aligns with operational steps
to maintain the database. Because maintaining databases requires more complex sequences of actions, the Kubernetes community resolved these challenges
by implementing operators that incorporate logical domain and operational runbooks needed to run databases in Kubernetes.
<a href="https://operatorhub.io">OperatorHub.io</a> has an extensive list of operators.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Best Practices for Monitoring, Logging, and Tracing"><div class="sect1" id="idm45310202268304">
<h1>Best Practices for Monitoring, Logging, and Tracing</h1>

<p>So far, we’ve been focusing on making containerized applications operational.
On your local machine, you are the only end user of your work, but your application will face the rest of the world in production.<a data-type="indexterm" data-primary="deployment" data-secondary="observability" id="idm45310202266288"/><a data-type="indexterm" data-primary="observability" id="idm45310202265312"/><a data-type="indexterm" data-primary="metrics" data-secondary="about observability" id="idm45310202264640"/><a data-type="indexterm" data-primary="monitoring" data-secondary="about observability" id="idm45310202263696"/><a data-type="indexterm" data-primary="logging" data-secondary="about observability" id="idm45310202262752"/><a data-type="indexterm" data-primary="tracing" data-secondary="about observability" id="idm45310202261808"/>
To have your application aligned to the expectations of all your end users, you should observe its evolution in time under different conditions and environment instances.</p>

<p>In recent years, the term <em>observability</em> has become popular in the IT industry, but chances are that
you have already been working on <em>observable</em> Java applications.
Observability is the ability to measure a system’s current state based on the telemetry data it generates, such as logs, metrics, and traces.
If you have implemented auditing, exception handling, or event logging, you have already started to observe your application behavior.
Furthermore, to build observability for your distributed system, you will likely use different tools to implement monitoring, logging, and tracing practices.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You should observe applications, networks, and infrastructures that you and your team(s) are responsible for, regardless of the tools used to implement them.</p>
</div>

<p>Applications and the underlying infrastructure can produce useful metrics, logs, and traces to correctly observe a system.
As shown in <a data-type="xref" href="#observability-overview">Figure 8-4</a>, collecting this telemetry data contributes to visualizing the state of the system and to triggering notifications
when a part of your system is underperforming.</p>

<figure><div id="observability-overview" class="figure">
<img src="Images/dtjd_0804.png" alt="Observability overview" width="600" height="216"/>
<h6><span class="label">Figure 8-4. </span>Gathering metrics, logs, and traces from applications and infrastructure</h6>
</div></figure>

<p>Alerts help you acknowledge an<a data-type="indexterm" data-primary="alerts" id="idm45310201533856"/> unforeseen scenario and implement a recovery mechanism if the unexpected conditions reoccur.
You can use distribution of notifications to identify a pattern in the normal workflow of the system.
This pattern can further help you automate the recovery mechanism and use it whenever the alert is received.</p>

<p>As observability measures the state of a distributed system, you can have it as input to repair the faulty states of your microservices; see <a data-type="xref" href="Images/#observation-to-automatic-recovery">Figure 8-5</a>. <a data-type="indexterm" data-primary="Kubernetes" data-secondary="self-healing mechanism" id="idm45310201531168"/><a data-type="indexterm" data-primary="self-healing of Kubernetes" id="idm45310201530320"/><a data-type="indexterm" data-primary="containers" data-secondary="self-healing of Kubernetes" id="idm45310201529712"/>Kubernetes has a built-in self-healing mechanism that includes restarting failed containers, disposing of unhealthy containers,
or not routing traffic to Pods that are not ready to serve traffic. <a data-type="indexterm" data-primary="nodes in Kubernetes clusters" data-secondary="control planes" id="idm45310201528736"/><a data-type="indexterm" data-primary="service mesh control planes" id="idm45310201527888"/>At the node level, the control plane watches over the state of the
worker nodes. Some practices for automating the recovery mechanism involve extending the Kubernetes self-healing mechanism by utilizing
Job and DaemonSet resources. <a data-type="indexterm" data-primary="DaemonSet (Kubernetes)" data-secondary="node-monitoring daemon" id="idm45310201527152"/><a data-type="indexterm" data-primary="Job (Kubernetes)" data-secondary="recovery mechanisms automated" id="idm45310201526304"/>For example, you can use a DaemonSet to run a node-monitoring daemon on every worker,
while a Job creates one or more Pods and retries execution of those until a specified number successfully terminate.</p>

<figure><div id="observation-to-automatic-recovery" class="figure">
<img src="Images/dtjd_0805.png" alt="Observation to automatic recovery" width="600" height="63"/>
<h6><span class="label">Figure 8-5. </span>Improving from observation to automating recovery</h6>
</div></figure>

<p>Observability also helps you measure the state of the system when traffic spikes occur. Applications that respond with delay induce frustrations in end users. In such cases, you should investigate how you can scale your containerized applications.
Moreover, autoscaling eliminates the need to respond manually to traffic spikes that need new resources and instances by automatically changing their active number.</p>

<p>In Kubernetes, a HorizontalPodAutoscaler (HPA)<a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="HorizontalPodAutoscaler" id="idm45310201522816"/><a data-type="indexterm" data-primary="HorizontalPodAutoscaler (HPA; Kubernetes)" id="idm45310201521968"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="workload management" data-tertiary="HorizontalPodAutoscaler" id="idm45310201521360"/><a data-type="indexterm" data-primary="scalability" data-secondary="HorizontalPodAutoscaler" id="idm45310201520272"/><a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="HorizontalPodAutoscaler" id="idm45310201519424"/> resource automatically updates a workload resource like Deployment, aiming to scale the workload to match demand automatically.
A HorizontalPodAutoscaler resource responds to increased load by deploying more Pods. If the load diminishes and the number of Pods is above the minimum configured, the HorizontalPodAutoscaler
requires the Deployment resource to scale down.</p>

<p>As explained in the<a data-type="indexterm" data-primary="Deployment objects in Kubernetes" data-secondary="HorizontalPodAutoscaler" data-tertiary="documentation online" id="idm45310201518064"/><a data-type="indexterm" data-primary="HorizontalPodAutoscaler (HPA; Kubernetes)" data-secondary="documentation online" id="idm45310201516976"/><a data-type="indexterm" data-primary="scalability" data-secondary="HorizontalPodAutoscaler" data-tertiary="documentation online" id="idm45310201516128"/><a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="HorizontalPodAutoscaler" data-tertiary="documentation online" id="idm45310201515040"/><a data-type="indexterm" data-primary="resources for learning" data-secondary="Kubernetes" data-tertiary="HorizontalPodAutoscaler documentation" id="idm45310201513952"/> <a href="https://oreil.ly/UWebg">Kubernetes documentation</a>, the algorithm HorizontalPodAutoscaler uses the ratio of the desired metric value to the current metric value:</p>

<pre data-type="programlisting" class="console-output">wantedReplicas = ceil[currentReplicas * (currentMetricValue / wantedMetricValue)]</pre>

<p>To demonstrate how the preceding algorithm works when you set up a <span class="keep-together">HorizontalPodAutoscaler</span> resource, let’s reuse the example from <a data-type="xref" href="#adjusting-resource-quotas">“Adjusting Resource Quotas”</a>, where we adjusted resource quotas:</p>

<pre data-type="programlisting" class="console-input">quarkus.kubernetes.resources.limits.cpu=200m
quarkus.kubernetes.resources.limits.memory=230Mi
quarkus.kubernetes.resources.requests.cpu=100m
quarkus.kubernetes.resources.requests.memory=115Mi</pre>

<p>Each Pod using the previous configuration can request a minimum 100 m for CPU. You can set up the HorizontalPodAutoscaler to maintain an average CPU utilization across all Pods of 80% for this deployment by using the following command:</p>

<pre data-type="programlisting" data-code-language="bash">kubectl autoscale deployment demo --cpu-percent<code class="o">=</code><code class="m">80</code> --min<code class="o">=</code><code class="m">1</code> --max<code class="o">=</code><code class="m">10</code></pre>

<p>Assuming that the current metric value for CPU is 320 m and the desired value is 160 m, the number of replicas needed is 320 / 160 = 2.0.
Based on the HorizontalPodAutoscaler configuration, the Deployment updates the ReplicaSet and then the ReplicaSet adds Pods to match the workload need.
If the current metric value for CPU decreases at 120 m, the number of replicas needed will be 120 / 160 = 0.75, and the scale-down to one replica will occur gradually.</p>

<p>Another option to scale with Kubernetes is to use <em>vertical scaling</em>, <a data-type="indexterm" data-primary="workload management in Kubernetes" data-secondary="VerticalPodAutoscaler" id="idm45310201489888"/><a data-type="indexterm" data-primary="VerticalPodAutoscaler (VPA; Kubernetes)" id="idm45310201488976"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="workload management" data-tertiary="VerticalPodAutoscaler" id="idm45310201504976"/><a data-type="indexterm" data-primary="Pods" data-secondary="VerticalPodAutoscaler" id="idm45310201503760"/><a data-type="indexterm" data-primary="scalability" data-secondary="VerticalPodAutoscaler" id="idm45310201502816"/>which means to match the workload by assigning more resources to the Pods that are already running.
<a href="https://oreil.ly/vTegk">VerticalPodAutoscaler</a> (VPA) needs to be installed and enabled in order to further use its policies.
To avoid undefined behavior over your Pods, do not use VerticalPodAutoscaler and HorizontalPodAutoscaler simultaneously to adjust CPU or memory of resources.</p>

<p>Let’s look into some monitoring, logging, and tracing recommendations to understand observability better when deploying, scaling, and maintaining containerized applications.</p>








<section data-type="sect2" data-pdf-bookmark="Monitoring"><div class="sect2" id="idm45310201487936">
<h2>Monitoring</h2>

<p>You can use monitoring to observe<a data-type="indexterm" data-primary="observability" data-secondary="monitoring" id="ch08-monit"/><a data-type="indexterm" data-primary="monitoring" id="ch08-monit2"/><a data-type="indexterm" data-primary="metrics" data-secondary="monitoring" id="ch08-monit3"/><a data-type="indexterm" data-primary="deployment" data-secondary="observability" data-tertiary="monitoring" id="ch08-monit4"/> a system in near real-time. Typically, this practice involves setting up a technical solution that can gather logs and predefined sets of metrics, as shown in <a data-type="xref" href="#pull-and-query-metrics">Figure 8-6</a>.</p>

<figure><div id="pull-and-query-metrics" class="figure">
<img src="Images/dtjd_0806.png" alt="Pulling and querying metrics" width="600" height="83"/>
<h6><span class="label">Figure 8-6. </span>Pulling and querying metrics</h6>
</div></figure>

<p><em>Metrics</em> are numeric values of system<a data-type="indexterm" data-primary="metrics" id="idm45310201477424"/><a data-type="indexterm" data-primary="observability" data-secondary="about metrics" id="idm45310201476720"/> properties over time, like  maximum Java heap memory available or the total number of garbage collections that occurred. <a data-type="xref" href="#metrics_types">Table 8-6</a> shows which metrics can help you when monitoring a system.</p>
<table id="metrics_types" style="width: 100%">
<caption><span class="label">Table 8-6. </span>General types of metrics</caption>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>
<em>Counter</em></p></td>
<td><p>
A cumulative<a data-type="indexterm" data-primary="counters as metrics" id="idm45310201455568"/> value based on incrementing an integer</p></td>
</tr>
<tr>
<td><p>
<em>Timer</em></p></td>
<td><p>
Measures both the <a data-type="indexterm" data-primary="timers as metrics" id="idm45310201453168"/>count of timed events and the total time of all timed events</p></td>
</tr>
<tr>
<td><p>
<em>Gauge</em></p></td>
<td><p>
A single numerical value<a data-type="indexterm" data-primary="gauges as metrics" id="idm45310201450768"/> that can go up and down arbitrarily</p></td>
</tr>
<tr>
<td><p>
<em>Histogram</em></p></td>
<td><p>
Measures distribution<a data-type="indexterm" data-primary="histograms as metrics" id="idm45310201448144"/> of values in a stream of data</p></td>
</tr>
<tr>
<td><p>
<em>Meter</em></p></td>
<td><p>
Indicates the rate<a data-type="indexterm" data-primary="meters as metrics" id="idm45310201445456"/> at which a set of events occur</p></td>
</tr>
</tbody>
</table>

<p>A few popular Java libraries for<a data-type="indexterm" data-primary="metrics" data-secondary="libraries and tools" id="idm45310201443728"/><a data-type="indexterm" data-primary="observability" data-secondary="about metrics" data-tertiary="libraries and tools" id="idm45310201442848"/><a data-type="indexterm" data-primary="MicroProfile" data-secondary="Metrics library" id="idm45310201441632"/><a data-type="indexterm" data-primary="Spring Boot" data-secondary="Actuator" data-tertiary="metrics" id="ch08-metex"/><a data-type="indexterm" data-primary="Micrometer" id="idm45310201439200"/><a data-type="indexterm" data-primary="Prometheus" data-secondary="metrics" id="ch08-metex2"/><a data-type="indexterm" data-primary="Actuator (Spring Boot)" id="ch08-metex3"/> working with metrics include MicroProfile Metrics, Spring Boot Actuator, and Micrometer.
For a better overview of your system behavior, you can collect and query these metrics with tools such as <a href="https://prometheus.io">Prometheus</a>.</p>

<p>To provide you with an example, we will reuse <a data-type="xref" href="#example_0801">Example 8-1</a>, expose its metrics under <em>/actuator/prometheus</em>,
and send those to Prometheus by generating the container image and Kubernetes resources using Eclipse JKube.</p>

<p>Let’s start by adding the Micrometer registry dependency, which specifically enables Prometheus support:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>io.micrometer<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>micrometer-registry-prometheus<code class="nt">&lt;/artifactId&gt;</code>
    <code class="nt">&lt;scope&gt;</code>runtime<code class="nt">&lt;/scope&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre>

<p>Next, you need to instruct Spring Boot’s Actuator which endpoints it should expose by adding this line to <em>src/main/resources/application.properties</em>:</p>

<pre data-type="programlisting" class="console-input">management.endpoints.web.exposure.include=health,info,prometheus</pre>

<p>The Spring Boot application exposes the metrics under <em>/actuator/prometheus</em>.
Metrics related to JVM are also available at <em>/actuator/prometheus</em>, such as <code>jvm.gc.pause</code> that measures garbage collection pause times.
To further expose these metrics at the container and Kubernetes resource level, we can customize the Eclipse JKube setup with the following:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code><code>
</code><code class="nt">&lt;project</code><code> </code><code class="na">xmlns:xsi=</code><code class="s">"http://www.w3.org/2001/XMLSchema-instance"</code><code>
         </code><code class="na">xmlns=</code><code class="s">"http://maven.apache.org/POM/4.0.0"</code><code>
         </code><code class="na">xsi:schemaLocation=</code><code class="s">"http://maven.apache.org/POM/4.0.0
    https://maven.apache.org/xsd/maven-4.0.0.xsd"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;modelVersion</code><code class="nt">&gt;</code><code>4.0.0</code><code class="nt">&lt;/modelVersion&gt;</code><code>
    </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>com.example</code><code class="nt">&lt;/groupId&gt;</code><code>
    </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>demo</code><code class="nt">&lt;/artifactId&gt;</code><code>
    </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>0.0.1-SNAPSHOT</code><code class="nt">&lt;/version&gt;</code><code>
    </code><code class="nt">&lt;name</code><code class="nt">&gt;</code><code>demo</code><code class="nt">&lt;/name&gt;</code><code>
    </code><code class="cm">&lt;!--[...]--&gt;</code><code>
    </code><code class="nt">&lt;build</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;plugins</code><code class="nt">&gt;</code><code>
            </code><code class="nt">&lt;plugin</code><code class="nt">&gt;</code><code>
                </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>org.eclipse.jkube</code><code class="nt">&lt;/groupId&gt;</code><code>
                </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>kubernetes-maven-plugin</code><code class="nt">&lt;/artifactId&gt;</code><code>
                </code><code class="nt">&lt;version</code><code class="nt">&gt;</code><code>${jkube.version}</code><code class="nt">&lt;/version&gt;</code><code>
                </code><code class="nt">&lt;executions</code><code class="nt">&gt;</code><code>
                    </code><code class="nt">&lt;execution</code><code class="nt">&gt;</code><code>
                        </code><code class="nt">&lt;id</code><code class="nt">&gt;</code><code>resources</code><code class="nt">&lt;/id&gt;</code><code>
                        </code><code class="nt">&lt;phase</code><code class="nt">&gt;</code><code>process-resources</code><code class="nt">&lt;/phase&gt;</code><code>
                        </code><code class="nt">&lt;goals</code><code class="nt">&gt;</code><code>
                            </code><code class="nt">&lt;goal</code><code class="nt">&gt;</code><code>resource</code><code class="nt">&lt;/goal&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO9-1" href="#callout_deploying_for_developers_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
                        </code><code class="nt">&lt;/goals&gt;</code><code>
                    </code><code class="nt">&lt;/execution&gt;</code><code>
                </code><code class="nt">&lt;/executions&gt;</code><code>
                </code><code class="nt">&lt;configuration</code><code class="nt">&gt;</code><code>
                    </code><code class="nt">&lt;generator</code><code class="nt">&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO9-2" href="#callout_deploying_for_developers_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
                        </code><code class="nt">&lt;config</code><code class="nt">&gt;</code><code>
                            </code><code class="nt">&lt;spring-boot</code><code class="nt">&gt;</code><code>
                                </code><code class="nt">&lt;prometheusPort</code><code class="nt">&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO9-3" href="#callout_deploying_for_developers_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
                                    9779
                                </code><code class="nt">&lt;/prometheusPort&gt;</code><code>
                            </code><code class="nt">&lt;/spring-boot&gt;</code><code>
                        </code><code class="nt">&lt;/config&gt;</code><code>
                    </code><code class="nt">&lt;/generator&gt;</code><code>
                    </code><code class="nt">&lt;enricher</code><code class="nt">&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO9-4" href="#callout_deploying_for_developers_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
                        </code><code class="nt">&lt;config</code><code class="nt">&gt;</code><code>
                            </code><code class="nt">&lt;jkube-prometheus</code><code class="nt">&gt;</code><code>
                                </code><code class="nt">&lt;prometheusPort</code><code class="nt">&gt;</code><code> </code><a class="co" id="co_deploying_for_developers_CO9-5" href="#callout_deploying_for_developers_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
                                    9779
                                </code><code class="nt">&lt;/prometheusPort&gt;</code><code>
                            </code><code class="nt">&lt;/jkube-prometheus&gt;</code><code>
                        </code><code class="nt">&lt;/config&gt;</code><code>
                    </code><code class="nt">&lt;/enricher&gt;</code><code>
                </code><code class="nt">&lt;/configuration&gt;</code><code>
            </code><code class="nt">&lt;/plugin&gt;</code><code>
        </code><code class="nt">&lt;/plugins&gt;</code><code>
    </code><code class="nt">&lt;/build&gt;</code><code>
</code><code class="nt">&lt;/project&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO9-1" href="#co_deploying_for_developers_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Execute this configuration with the <code>k8s:resource</code> goal.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO9-2" href="#co_deploying_for_developers_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Adjust the generated Docker image to expose the Prometheus port.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO9-3" href="#co_deploying_for_developers_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Expose the 9779 port at the container-image level and have it in  Kubernetes resources annotations.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO9-4" href="#co_deploying_for_developers_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Generate Kubernetes resources helpful for Spring Boot applications.</p></dd>
</dl>

<p>To build the container image and generate the Kubernetes resources, run the following command:</p>

<pre data-type="programlisting" data-code-language="bash">mvn clean package k8s:build k8s:resource <code class="se">\</code>
    -Djkube.docker.registry<code class="o">=</code>quay.io <code class="se">\</code>
    -Drepository<code class="o">=</code>repo <code class="se">\</code>
    -Dtag<code class="o">=</code><code class="m">0</code>.0.1</pre>

<p>The Kubernetes resources generated at  <em>target/classes/META-INF/jkube/kubernetes.yml</em> will contain the Prometheus annotations controlling the metrics collection process:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">List</code><code class="w"/>
<code class="nt">items</code><code class="p">:</code><code class="w"/>
<code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="w">  </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="w">  </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">annotations</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">prometheus.io/path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/metrics</code><code class="w"/>
<code class="w">      </code><code class="nt">prometheus.io/port</code><code class="p">:</code><code class="w"> </code><code class="s">"9779"</code><code class="w"/>
<code class="w">      </code><code class="nt">prometheus.io/scrape</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/></pre>

<p>Once you deploy the generated resources, you can use a custom Prometheus query (PromQL) to query different metrics.
For example, you can pick the <code>jvm.gc.pause</code> metric and run the following PromQL query to check the average time spent in garbage collection by cause:<a data-type="indexterm" data-startref="ch08-metex" id="idm45310201144896"/><a data-type="indexterm" data-startref="ch08-metex2" id="idm45310201144288"/><a data-type="indexterm" data-startref="ch08-metex3" id="idm45310201143648"/></p>

<pre data-type="programlisting" data-code-language="bash">avg<code class="o">(</code>rate<code class="o">(</code>jvm_gc_pause_seconds_sum<code class="o">[</code>1m<code class="o">]))</code> by <code class="o">(</code>cause<code class="o">)</code></pre>

<p>When generating and capturing metrics, several best practices should be followed:<a data-type="indexterm" data-primary="metrics" data-secondary="best practices" id="idm45310201088624"/><a data-type="indexterm" data-primary="observability" data-secondary="about metrics" data-tertiary="best practices" id="idm45310201140016"/></p>

<ul>
<li>
<p>As metrics can be defined at both the application and infrastructure level, have team members collaborate on defining those.</p>
</li>
<li>
<p>Always expose internal JVM metrics, such as number of threads, CPU usage, how often the garbage collector ran, heap, and nonheap memory usage.</p>
</li>
<li>
<p>Make an effort to create metrics for application-specific implementations that impact nonfunctional requirements.
For example, cache statistics like size, hits, and entry time-to-live can offer you insights when assessing the performance of a functionality.</p>
</li>
<li>
<p>Tailor metrics that can support key performance indicators (KPIs) used by business people. For example, the number of end users who used a new functionality is a KPI
that can be proven with software metrics.</p>
</li>
<li>
<p>Measure and expose details about errors and exceptions that occur within your system.
You can use these details later to establish error patterns and thus perform an enhancement.<a data-type="indexterm" data-startref="ch08-monit" id="idm45310201081856"/><a data-type="indexterm" data-startref="ch08-monit2" id="idm45310201081152"/><a data-type="indexterm" data-startref="ch08-monit3" id="idm45310201080480"/><a data-type="indexterm" data-startref="ch08-monit4" id="idm45310201079808"/></p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Logging"><div class="sect2" id="idm45310201486992">
<h2>Logging</h2>

<p>At the Java application level, developers<a data-type="indexterm" data-primary="metrics" data-secondary="logging" id="idm45310201078112"/><a data-type="indexterm" data-primary="logging" id="idm45310201077136"/><a data-type="indexterm" data-primary="observability" data-secondary="logging" id="idm45310201076464"/><a data-type="indexterm" data-primary="deployment" data-secondary="observability" data-tertiary="logging" id="idm45310201075520"/> use logging to record exceptional cases.
Logs are useful to obtain insights with additional context information and can complement existing metrics.
When it comes to logging, three formats are available: plain text, JSON or XML, and binary.</p>

<p>Besides the Java language built-in log, several<a data-type="indexterm" data-primary="logging" data-secondary="frameworks for" id="idm45310201073568"/><a data-type="indexterm" data-primary="Simple Logging Facade for Java (SLF4J)" id="idm45310201072592"/><a data-type="indexterm" data-primary="SLF4J (Simple Logging Facade for Java)" id="idm45310201071952"/><a data-type="indexterm" data-primary="Apache Log4j" id="idm45310201071312"/><a data-type="indexterm" data-primary="Log4j (Apache)" id="idm45310201070640"/> logging frameworks can help you achieve this task: <a href="http://www.slf4j.org">Simple Logging Facade for Java (SLF4J)</a>
and <a href="https://oreil.ly/foEtO">Apache Log4j 2</a>. Some logging best practices include the <span class="keep-together">following</span>:<a data-type="indexterm" data-primary="logging" data-secondary="best practices" id="idm45310201055104"/></p>

<ul>
<li>
<p>Be conservative; log only details that are relevant to a particular functionality of your system.</p>
</li>
<li>
<p>Write meaningful information in the log message in order to help you and your colleagues troubleshoot future issues.</p>
</li>
<li>
<p>Use the correct log level: <code>TRACE</code> for capturing fine-grained insights, <code>DEBUG</code> for statements helpful when troubleshooting, <code>INFO</code> for general information,
<code>WARN</code> and <code>ERROR</code> to signal events that might require action.</p>
</li>
<li>
<p>Make sure you use guard clauses or lambda expressions to log messages if the corresponding log level is enabled.</p>
</li>
<li>
<p>Have the log level customizable via variables that can be set at container runtime.</p>
</li>
<li>
<p>Set appropriate permissions to locations where your log files will live.</p>
</li>
<li>
<p>Customize layout of your logs to have region-specific formats.</p>
</li>
<li>
<p>Protect sensitive data when logging. For example, logging personally identifiable information (PII) can lead not only to compliance violations, but also to security vulnerabilities.</p>
</li>
<li>
<p>Periodically rotate logs to prevent log files from growing too large or have them automatically discarded.
Container and Pod logs are transient by default. This means that the container logs are gone when Pods are deleted, crashed, or scheduled on a different node.
But you can stream your logs asynchronously to a centralized storage or service and keep locally a fixed number of rotated log files.</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Tracing"><div class="sect2" id="tracing">
<h2>Tracing</h2>

<p>Within a distributed system, a request<a data-type="indexterm" data-primary="observability" data-secondary="tracing" id="idm45310201041056"/><a data-type="indexterm" data-primary="tracing" id="idm45310201040080"/><a data-type="indexterm" data-primary="metadata" data-secondary="tracing to capture" id="idm45310201039408"/><a data-type="indexterm" data-primary="data" data-secondary="metadata" data-tertiary="tracing to capture" id="idm45310201038464"/><a data-type="indexterm" data-primary="deployment" data-secondary="observability" data-tertiary="tracing" id="idm45310201037248"/> traverses multiple components. Tracing helps you capture metadata and timing details
concerning the flow of a request to identify slow transactions or where failures occur.</p>

<p>Finding the right instrumentation to capture<a data-type="indexterm" data-primary="tracing" data-secondary="tools for" id="idm45310201035200"/> traces can be challenging for a developer. Proprietary agents can help you with that,
but you should look into solutions aligned<a data-type="indexterm" data-primary="OpenCensus" id="idm45310201034096"/><a data-type="indexterm" data-primary="OpenTracing" id="idm45310201033424"/> to vendor-neutral, open standards like <a href="https://opencensus.io">OpenCensus</a> or <a href="https://opentracing.io">OpenTracing</a>.
Many developers found it difficult to choose the best option for an application and have it work across vendors and projects,<a data-type="indexterm" data-primary="Cloud Native Computing Foundation (CNCF)" id="idm45310201031184"/>
so OpenTracing and OpenCensus projects merged and formed another <a href="https://www.cncf.io">CNCF</a> incubating<a data-type="indexterm" data-primary="OpenTelemetry" id="idm45310201029600"/> project called <a href="https://oreil.ly/QyOhu">OpenTelemetry</a>.
This collection of tools, APIs, and SDKs standardizes the way you collect and transmit metrics, logs, and traces.
The OpenTelemetry tracing specification defines the following terms:<a data-type="indexterm" data-primary="tracing" data-secondary="terminology" id="idm45310201028048"/><a data-type="indexterm" data-primary="observability" data-secondary="tracing" data-tertiary="terminology" id="idm45310201027072"/></p>
<dl>
<dt>Trace</dt>
<dd>
<p>A single transaction request<a data-type="indexterm" data-primary="tracing" data-secondary="trace definition" id="idm45310201024160"/> that uses other services and resources as it moves through a distributed system.</p>
</dd>
<dt>Span</dt>
<dd>
<p>A named, timed operation<a data-type="indexterm" data-primary="span in tracing" id="idm45310201021776"/> representing a workflow piece. A trace contains multiple spans.</p>
</dd>
<dt>Attributes</dt>
<dd>
<p>Key/value pairs that you<a data-type="indexterm" data-primary="attributes in tracing" id="idm45310201019664"/> can use to query, filter, and comprehend trace data.</p>
</dd>
<dt>Baggage items</dt>
<dd>
<p>Key/value pairs that<a data-type="indexterm" data-primary="baggage items in tracing" id="idm45310201017552"/> cross process boundaries.</p>
</dd>
<dt>Context propagation</dt>
<dd>
<p>A common subsystem shared<a data-type="indexterm" data-primary="context propagation in tracing" id="idm45310201015440"/> by traces, metrics, and baggage. A developer can pass additional context information to a span by using attributes, logs, and baggage items.</p>
</dd>
</dl>

<p><a data-type="xref" href="#distributed-tracing">Figure 8-7</a> illustrates the<a data-type="indexterm" data-primary="distributed tracing" id="idm45310201013456"/> trace for a transaction that begins with microservice Blue and traverses microservices Violet and Green. The trace has three spans, and attributes are set on the Violet and Green spans.</p>

<figure><div id="distributed-tracing" class="figure">
<img src="Images/dtjd_0807.png" alt="Distributed tracing example" width="600" height="202"/>
<h6><span class="label">Figure 8-7. </span>Distributed tracing example</h6>
</div></figure>

<p>To give an example that incorporates both metrics and traces, we will enhance <a href="#generate-kubernetes-resources-with-jkube">Example 8-2</a>
by tracing the request to the <em>/greeting</em> endpoint and detecting the time spent to return a response with a Timer metric.</p>

<p>Next, let’s export the metrics<a data-type="indexterm" data-primary="Prometheus" data-secondary="tracing" id="idm45310201008688"/><a data-type="indexterm" data-primary="Quarkus" data-secondary="tracing" id="idm45310201007712"/> to Prometheus and for further processing include OpenTelemetry support by adding the following Quarkus extensions:</p>

<pre data-type="programlisting" data-code-language="bash">mvn quarkus:add-extension <code class="se">\</code>
    -Dextensions<code class="o">=</code><code class="s2">"quarkus-micrometer-registry-prometheus,</code>
<code class="s2">                   quarkus-opentelemetry-exporter-otlp"</code></pre>

<p>Next, let’s customize the endpoint for sending spans by adding the following:</p>

<pre data-type="programlisting" class="console-input">custom.host = ${exporter.host:localhost} <a class="co" id="co_deploying_for_developers_CO10-1" href="#callout_deploying_for_developers_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
quarkus.kubernetes.env.vars.otlp-exporter=${custom.host:localhost} <a class="co" id="co_deploying_for_developers_CO10-2" href="#callout_deploying_for_developers_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
quarkus.opentelemetry.tracer.exporter.otlp.endpoint=http://${custom.host}:4317 <a class="co" id="co_deploying_for_developers_CO10-3" href="#callout_deploying_for_developers_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO10-1" href="#co_deploying_for_developers_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Define the host as a configuration that you can parametrize. The default value for the host of the endpoint is <code>localhost</code>,
but you can override it with <code>-Dexporter.host</code>: <code>mvn package -Dexporter.host=myhost</code>.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO10-2" href="#co_deploying_for_developers_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>At compile time, the <code>quarkus-kubernetes</code> extension that is already in the project will take into account this
environment variable and autogenerate the configuration of the Kubernetes resources. The configuration reuses the value
of <code>custom.host</code>.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO10-3" href="#co_deploying_for_developers_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The gRPC endpoint for sending spans that reuses the previous host definition. The configuration reuses the value
of <code>custom.host</code>.</p></dd>
</dl>

<p>To measure the duration of a request sent to the <em>/greeting</em> endpoint, we will annotate it with <code>@Timed</code>
and instrument its traces by customizing a <code>Span</code> with two attributes:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">com</code><code class="o">.</code><code class="na">example</code><code class="o">.</code><code class="na">demo</code><code class="o">;</code><code>
</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.micrometer.core.annotation.Timed</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.opentelemetry.api.trace.*</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.opentelemetry.context.Context</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.*</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.logging.Logger</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/greeting"</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">GreetingResource</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">static</code><code> </code><code class="kd">final</code><code> </code><code class="n">String</code><code> </code><code class="n">template</code><code> </code><code class="o">=</code><code> </code><code class="s">"Hello, %s!"</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">final</code><code> </code><code class="kd">static</code><code> </code><code class="n">Logger</code><code> </code><code class="n">log</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="kd">static</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">log</code><code> </code><code class="o">=</code><code> </code><code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">GreetingResource</code><code class="o">.</code><code class="na">class</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code><code>
</code><code>    </code><code class="nd">@Timed</code><code class="o">(</code><code class="n">value</code><code class="o">=</code><code class="s">"custom"</code><code class="o">)</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Greeting</code><code> </code><code class="nf">greeting</code><code class="o">(</code><code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"name"</code><code class="o">)</code><code> </code><code class="n">String</code><code> </code><code class="n">name</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">pause</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Greeting</code><code class="o">(</code><code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="n">template</code><code class="o">,</code><code> </code><code class="n">name</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="kt">void</code><code> </code><code class="nf">pause</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">Span</code><code> </code><code class="n">span</code><code> </code><code class="o">=</code><code> </code><code class="n">Span</code><code class="o">.</code><code class="na">fromContext</code><code class="o">(</code><code class="n">Context</code><code class="o">.</code><code class="na">current</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="s">"pause"</code><code class="o">,</code><code> </code><code class="s">"start"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_deploying_for_developers_CO11-1" href="#callout_deploying_for_developers_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">try</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">2000</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">InterruptedException</code><code> </code><code class="n">e</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">span</code><code class="o">.</code><code class="na">setStatus</code><code class="o">(</code><code class="n">StatusCode</code><code class="o">.</code><code class="na">ERROR</code><code class="o">,</code><code> </code><code class="s">"Execution was interrupted"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">span</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="s">"unexpected.pause"</code><code class="o">,</code><code> </code><code class="s">"exception"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">span</code><code class="o">.</code><code class="na">recordException</code><code class="o">(</code><code class="n">e</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_deploying_for_developers_CO11-2" href="#callout_deploying_for_developers_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>            </code><code class="n">log</code><code class="o">.</code><code class="na">severe</code><code class="o">(</code><code class="s">"Thread interrupted"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_for_developers_CO11-1" href="#co_deploying_for_developers_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Attribute set to trace when the logic started.</p></dd>
<dt><a class="co" id="callout_deploying_for_developers_CO11-2" href="#co_deploying_for_developers_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>After recording the exception, set the attribute to trace the exception case.</p></dd>
</dl>

<p>Given the changes introduced, you can rebuild and push the container image, and deploy the Kubernetes resources generated at compile time by using the following:</p>

<pre data-type="programlisting" data-code-language="bash">mvn package -Dquarkus.container-image.build<code class="o">=</code><code class="nb">true</code> <code class="se">\</code>
    -Dquarkus.container-image.push<code class="o">=</code><code class="nb">true</code> <code class="se">\</code>
    -Dquarkus.kubernetes.deploy<code class="o">=</code><code class="nb">true</code></pre>

<p>To instrument end-to-end distributed tracing,<a data-type="indexterm" data-primary="tracing" data-secondary="tools for" data-tertiary="distributed tracing" id="idm45310200893136"/><a data-type="indexterm" data-primary="distributed tracing" data-secondary="tools for" id="idm45310200892048"/><a data-type="indexterm" data-primary="Jaeger" id="idm45310200891104"/><a data-type="indexterm" data-primary="Cloud Native Computing Foundation (CNCF)" id="idm45310200890432"/> you can use a tool like <a href="https://oreil.ly/Kp09K">Jaeger</a> (<a data-type="xref" href="#jaeger-filtered-trace">Figure 8-8</a>).
This top-level  <a href="https://oreil.ly/vZRTZ">CNCF project</a> can easily integrate with Kubernetes. You can set up the value for <code>quarkus​.opentele⁠metry.tracer.exporter.otlp.endpoint</code> by using the Jaeger endpoint.
Within the Jaeger UI, you can search traces by using the <code>pause</code> tag.</p>

<figure><div id="jaeger-filtered-trace" class="figure">
<img src="Images/dtjd_0808.png" alt="Filtering traces by tag with Jaeger" width="600" height="253"/>
<h6><span class="label">Figure 8-8. </span>Filtering traces by tag with Jaeger</h6>
</div></figure>

<p>Furthermore, you can observe the requests that generated an exception as follows:</p>
<ol>
<li>
<p>Search in the Jaeger UI for traces having <code>error=true</code> and <code>unexpec⁠ted​.pause=exception</code> tags.</p>
</li>
<li>
<p>Utilize the <code>Timer</code> named <code>custom</code> in a Prometheus query like the following one:</p>

<pre data-type="programlisting" data-code-language="bash">avg<code class="o">(</code>rate<code class="o">(</code>custom_seconds_sum<code class="o">[</code>1m<code class="o">]))</code> by <code class="o">(</code>exception<code class="o">)</code></pre>
</li>
<li>
<p>Inspect logs for the message <code>Thread interrupted</code>.</p>
</li>

</ol>

<p>Here are some recommended practices for tracing:<a data-type="indexterm" data-primary="tracing" data-secondary="best practices" id="idm45310200857376"/><a data-type="indexterm" data-primary="observability" data-secondary="tracing" data-tertiary="best practices" id="idm45310200856400"/></p>

<ul>
<li>
<p>Instrument a trace end-to-end, meaning forward the tracing headers to all the downstream services,
data stores, or middleware part of your system.</p>
</li>
<li>
<p>Report metrics related to request rate, errors, and their duration.<a data-type="indexterm" data-primary="metrics" data-secondary="rate, errors, duration (RED)" id="idm45310200930256"/><a data-type="indexterm" data-primary="rate, errors, duration (RED)" id="idm45310200929424"/><a data-type="indexterm" data-primary="site reliability engineering (SRE)" data-secondary="rate, errors, duration (RED)" id="idm45310200928784"/>
The rate, errors, duration (RED) method is popular in the SRE world
and focuses on instrumenting: request throughput, request error rate, latency, or response time.</p>
</li>
<li>
<p>If you instrument your custom tracing spans, avoid using a lot of metadata.</p>
</li>
<li>
<p>When searching for Java-compatible tracing solutions, look at the language-specific implementation of <a href="https://oreil.ly/Df5RD">OpenTelemetry in Java</a>.</p>
</li>
</ul>

<p>When designing systems for observability, remember that your metrics and logs should be available for a later analysis.
As a consequence, regardless of where you deploy, always have tools and practices that can reliably capture and store metrics and logging data.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="High Availability and Geographic Distribution"><div class="sect1" id="idm45310201042256">
<h1>High Availability and Geographic Distribution</h1>

<p>When working on a software system, you<a data-type="indexterm" data-primary="deployment" data-secondary="high availability" id="ch08-avail"/><a data-type="indexterm" data-primary="high availability (HA)" id="ch08-avail2"/><a data-type="indexterm" data-primary="availability" id="ch08-avail3"/><a data-type="indexterm" data-primary="failure and high availability" id="ch08-avail4"/> have probably received a nonfunctional requirement indicating that your application(s) should be available 24/7.
In the industry literature, <em>availability</em> refers to the probability that a system is operational at a given time;
this is expressed as a percentage of uptime in a given year.</p>

<p><em>High availability</em> (HA) is the ability of a system to work continuously without failure for an established time.
As developers, we create software with the intent to be always available for end users, but external factors
like power outages, network failures, and underprovisioned environments can impact the quality of service received by consumers.</p>

<p>Small-size container images and successful deployments to Kubernetes are the first steps toward having an application available on Kubernetes.
For example, let’s assume you have to upgrade your worker nodes to a newer Kubernetes version. This operation includes that your nodes have to pull all the containers
before working with the latest Kubernetes version. The longer it takes for each node to pull the containers, the lengthier it will be for the cluster
to work as expected.</p>

<p>Different deployment strategies were explained in <a data-type="xref" href="#choosing-and-implementing-a-deployment-strategy">“Choose and Implement a Deployment Strategy”</a>
because downtime, traffic routing between deployment versions, and the rollback process influence availability.
In a failed deployment, a fast rollback process can save you from user discomfort, time, and compute resources.
Moreover, you want your system to have a highly available state, and the way you define health checks and adjust resources for your containerized applications
impacts its performance to work continuously without failure for an established time.
Eventually, you can fine-tune your health checks, resource consumption, and deployments by observing your system’s behavior through logs, metrics, and traces.</p>

<p>Availability is commonly defined as a percentage of uptime in a given year.
<a data-type="xref" href="#connecting-availability-and-downtime">Table 8-7</a> shows the connection between a given availability percentage to the corresponding amount of downtime per year.
The table uses a year with 365 days, and for consistency, all times are rounded to two decimal digits.</p>
<table id="connecting-availability-and-downtime" style="width: 100%">
<caption><span class="label">Table 8-7. </span>Connecting a certain availability percentage to downtime per year</caption>
<thead>
<tr>
<th>Availability %</th>
<th>Downtime in a year</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>
90%</p></td>
<td><p>
36.5 days</p></td>
</tr>
<tr>
<td><p>
95%</p></td>
<td><p>
18.25 days</p></td>
</tr>
<tr>
<td><p>
99%</p></td>
<td><p>
3.65 days</p></td>
</tr>
<tr>
<td><p>
99.9%</p></td>
<td><p>
8.76 hours</p></td>
</tr>
<tr>
<td><p>
99.95%</p></td>
<td><p>
4.38 hours</p></td>
</tr>
<tr>
<td><p>
99.99%</p></td>
<td><p>
52.56 minutes</p></td>
</tr>
<tr>
<td><p>
99.999%</p></td>
<td><p>
5.25 minutes</p></td>
</tr>
<tr>
<td><p>
99.9999%</p></td>
<td><p>
31.53 seconds</p></td>
</tr>
</tbody>
</table>

<p>Nowadays, service providers use<a data-type="indexterm" data-primary="service-level objectives (SLOs)" id="idm45310200816992"/><a data-type="indexterm" data-primary="service-level indicators (SLIs)" id="idm45310200816320"/> service-level indicators (SLIs) to measure the goal set by a service-level objective (SLO).
SLOs are the individual commitments made by the service provider to a customer.
You can incorporate the percentages from <a data-type="xref" href="#connecting-availability-and-downtime">Table 8-7</a> by setting a value for availability as part of the SLO.<a data-type="indexterm" data-primary="Prometheus" data-secondary="performance of application" id="idm45310200814512"/><a data-type="indexterm" data-primary="high availability (HA)" data-secondary="tools for calculating performance" id="idm45310200813552"/><a data-type="indexterm" data-primary="Grafana" id="idm45310200812592"/>
Tools like <a href="https://prometheus.io">Prometheus</a> and <a href="https://grafana.com">Grafana</a> can help you calculate the performance
of your applications by incorporating the SLOs, querying metrics, and alerting when goals are endangered.</p>

<p>To create highly available systems, reliability engineering offers three principles of systems design:</p>

<ul>
<li>
<p>Eliminate single points of failure at the application, network, and infrastructure level. Because even the way you internally code your application can sometimes generate failures, you should properly test every software component. Observability and great deployment strategies help you eliminate the possible failures in your system.</p>
</li>
<li>
<p>Detect failures as they occur. Monitoring and alerting help discover when a system reaches critical conditions.</p>
</li>
<li>
<p>Have a reliable transition to a running component when a failure occurs to another one. An efficient rollback process in case of deployment issues, the Kubernetes self-healing mechanism, and smooth traffic routing between Kubernetes resources help in this matter.</p>
</li>
</ul>

<p>A good plan for failure involves following the preceding principles and implementing them using several best practices:</p>

<ul>
<li>
<p>Perform data backups, recovery, and replications.</p>
</li>
<li>
<p>Set up network load balancing to distribute the traffic efficiently when increased workloads are received by the critical features of your applications. Load balancing helps you eliminate single points of failure at the application level while using the network and infrastructure available.</p>
</li>
<li>
<p>When it comes to natural disasters that could affect your system, having it deployed in multiple geographical locations can prevent service failure.
It is critical to run independent application stacks in each location so the others can continue running if a failure occurs in one place.
Ideally, these locations should spread globally and not be localized in a specific area.</p>
</li>
<li>
<p>If you are worried about a Kubernetes cluster performance when a component or its control-plane node goes down, you should
choose to have highly available Kubernetes <a href="https://oreil.ly/9iTgz">clusters</a>.
Kubernetes high availability is about having a multiple control-plane setup behaving like a unified data center.
A setup consisting of multiple control planes protects your system from losing a worker node to the failure of the control plane node’s etcd.
Managing Kubernetes clusters is not an easy task, but you should know that a wide range of cloud providers will share this type of configuration up-front when setting the clusters for you.</p>
</li>
<li>
<p>Depending on your requirements, maintaining multiregion Kubernetes clusters can be unjustified.
But you can still set up multiple namespaces to ensure availability across the same cluster.<a data-type="indexterm" data-startref="ch08-avail" id="idm45310200800064"/><a data-type="indexterm" data-startref="ch08-avail2" id="idm45310200799360"/><a data-type="indexterm" data-startref="ch08-avail3" id="idm45310200798688"/><a data-type="indexterm" data-startref="ch08-avail4" id="idm45310200798016"/></p>
</li>
</ul>

<p>Since one of the previous practices involved multiregional deployments,<a data-type="indexterm" data-primary="latency" id="idm45310200796704"/><a data-type="indexterm" data-primary="geographically distributed applications" id="idm45310200796000"/> you should know that by using this technique,
you can improve end-user experiences by keeping latencies low for a distributed user base.
Your application architecture can achieve low latency because it would keep data close to end users distributed worldwide.</p>

<p>Another aspect to consider when having geographically distributed applications is the ability to comply with data privacy laws and regulations.
As more and more social and economic activities occur online, the importance of privacy and data protection is increasingly recognized.
In some countries, collection, usage, and sharing of personal information to different parties without notice or consent of consumers are considered illegal.
According to <a href="https://oreil.ly/p0KH2">United Nations Conference on Trade and Development (UNCTAD)</a>, 128 out of 194 countries have put in place legislation to secure the protection of data and privacy.</p>

<p>As you start to understand the requirements on your end to ensure the high availability of a distributed system,
let’s explore the cloud models that can help you achieve it.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Hybrid and MultiCloud Architectures"><div class="sect1" id="idm45310200924048">
<h1>Hybrid and MultiCloud Architectures</h1>

<p>The <em>cloud</em> is a collection of technologies<a data-type="indexterm" data-primary="hybrid cloud architecture" id="idm45310200790752"/><a data-type="indexterm" data-primary="cloud computing" data-secondary="about" id="idm45310200790080"/><a data-type="indexterm" data-primary="cloud computing" data-secondary="hybrid cloud" id="idm45310200789136"/><a data-type="indexterm" data-primary="cloud computing" data-secondary="multicloud" id="idm45310200788192"/><a data-type="indexterm" data-primary="multicloud architecture" id="idm45310200787248"/> to approach challenges like availability, scaling, security, and resilience.
It can exist on premises, on a Kubernetes distribution, or in a public infrastructure.
Often, you will see the terms <em>hybrid cloud</em> and <em>multicloud</em> used synonymously.
The most intuitive definition for a multicloud architecture is that this type of architecture requires at least one public cloud.</p>

<p>Hybrid cloud architecture differs from multicloud by including a private cloud infrastructure component and at least one public cloud (<a data-type="xref" href="#multi-cloud-hybrid-cloud">Figure 8-9</a>). As a result, when a hybrid cloud architecture has more than one public offering, that architecture can be simultaneously a multicloud one.</p>

<figure><div id="multi-cloud-hybrid-cloud" class="figure">
<img src="Images/dtjd_0809.png" alt="Multi-cloud and Hybrid Cloud" width="600" height="216"/>
<h6><span class="label">Figure 8-9. </span>Multicloud and hybrid cloud</h6>
</div></figure>

<p>When deploying on hybrid or multicloud infrastructures, you should take into consideration these cross-team aspects:</p>

<ul>
<li>
<p>Having a unified view over what and where you deployed.</p>
</li>
<li>
<p>Replacing provider-specific SaaS and IaaS services.</p>
</li>
<li>
<p>Following a unified approach for mitigating security vulnerabilities across clouds.</p>
</li>
<li>
<p>Scaling out and provisioning new resources seamlessly.</p>
</li>
<li>
<p>When you port applications across clouds, you need to avoid disconnection of services.
There is a time to recovery when moving workloads between infrastructures, but you can provide an end-user flawless transition using appropriate network configurations and deployment strategies.</p>
</li>
<li>
<p>At such a large scale, automation helps when orchestrating processes. Besides, the orchestrations platform for containerized
applications, you and your team will likely add an extra layer of tools and processes to manage workloads.</p>
</li>
</ul>

<p>From a developer point of view, you can contribute to a hybrid or multicloud strategy by taking care of these elements:</p>

<ul>
<li>
<p>Your application’s codebase should be the same regardless of the environment (namespace).</p>
</li>
<li>
<p>Your local building and deployment practice should be reproducible when other colleagues attempt to work with your code.</p>
</li>
<li>
<p>Avoid referencing local dependencies in your code or container image build.</p>
</li>
<li>
<p>When possible, parameterize the container image through build-time variables or environment variables.</p>
</li>
<li>
<p>If you need to support environment customizations, propagate them with environment variables from the orchestration platform toward container/application code parameters.</p>
</li>
<li>
<p>Use dependencies and images from repositories and registries that your organization has previously validated as trusted sources.</p>
</li>
<li>
<p>Prefer volumes to share information among containers.</p>
</li>
</ul>

<p>When working toward a hybrid or multicloud architecture, always ask yourself how you and your colleagues will evolve the software piece you are currently building. A progressive software architecture starts with a forward-thinking developer mindset.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm45310200767488">
<h1>Summary</h1>

<p>This chapter covered aspects of deployments that can concern a Java developer.
Although the typical Java developer role does not involve infrastructure administration,
you can influence the operational stages and processes of your application by doing the following:</p>

<ul>
<li>
<p>Building and pushing container images to container image registries by using Java-based tools like Jib and Eclipse JKube</p>
</li>
<li>
<p>Generating and deploying Kubernetes manifests by using Dekorate and Eclipse JKube</p>
</li>
<li>
<p>Implementing health checks and coordinating their execution at the infrastructure level</p>
</li>
<li>
<p>Observing the behavior of the distributed system in order to know when to introduce changes and which resources to adjust</p>
</li>
<li>
<p>Associating deployment aspects with high availability, hybrid, and multicloud architectures</p>
</li>
</ul>

<p>Since you have a good understanding of deploying applications, the next chapter investigates DevOps workflows for mobile software.</p>
</div></section>







</div></section></div></body></html>