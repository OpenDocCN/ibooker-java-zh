<html><head></head><body><section data-pdf-bookmark="Chapter 13. Server-Side Java" data-type="chapter" epub:type="chapter"><div class="chapter" id="javacook-netserver">&#13;
<h1><span class="label">Chapter 13. </span>Server-Side Java</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.0 Introduction" data-type="sect1"><div class="sect1" id="javacook-netserver-intro">&#13;
<h1>13.0 Introduction</h1>&#13;
&#13;
<p><a data-primary="sockets" data-type="indexterm" id="soc_ch"/><a data-primary="Java" data-secondary="sockets in" data-type="indexterm" id="idm45290642048376"/><a data-primary="sockets" data-secondary="in Java" data-type="indexterm" id="idm45290642047432"/>Sockets form the underpinnings of almost all networking protocols. JDBC, RMI, CORBA, EJB, and the non-Java RPC (Remote Procedure Call) and NFS (Network File System) are all implemented by connecting various types of sockets together. Socket connections can be implemented in most any language, not just Java: C, C++, Perl, and Python are also popular, and many others are possible. A client or server written in any one of these languages can communicate with its opposite written in any of the other languages. Therefore, it’s worth taking a quick look at how the <code>ServerSocket</code> behaves, even if you wind up utilizing the higher-level services such as RMI, JDBC, CORBA, or EJB.</p>&#13;
&#13;
<p>The discussion looks first at the <code>ServerSocket</code> itself, then at writing data over a socket in various ways. Finally, I show a complete implementation of a usable network server written in Java: the chat server from the client in the previous chapter.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Most production work in server-side Java uses the <a data-primary="Java Enterprise Edition (Java EE)" data-type="indexterm" id="idm45290642043224"/>Java Enterprise Edition (Java EE),&#13;
recently transferred from Oracle to the Eclipse Software Foundation and renamed to Jakarta&#13;
but widely referred to by the previous name&#13;
(and occasionally by its very old name, “J2EE,” which was retired in 2005).&#13;
Java EE provides scalability and support for building well-structured, multitiered distributed applications.&#13;
EE provides the servlet framework; a servlet is a strategy object that can be installed&#13;
into any standard Java EE web server. EE also provides two web view technologies: the original&#13;
JSP (JavaServer Pages) and the newer, component-based JSF (JavaServer Faces).&#13;
Finally, EE provides a number of other network-based services, including EJB3 remote access and Java Messaging Service (JMS).&#13;
These are outside the scope of this book; they are covered in other books,&#13;
such as <a data-primary="Gupta, Arun" data-secondary="Java EE 7 Essentials: Enterprise Developer Handbook" data-type="indexterm" id="idm45290642041480"/><a data-primary="Java EE 7 Essentials: Enterprise Developer Handbook (Gupta)" data-type="indexterm" id="idm45290642040504"/>Arun Gupta’s <em><a class="orm:hideurl" href="http://shop.oreilly.com/product/0636920030614.do">Java EE 7 Essentials: Enterprise Developer Handbook</a></em>.&#13;
This chapter is only for those who need or want to build their own server from the ground up.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.1 Opening a Server Socket for Business" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-1">&#13;
<h1>13.1 Opening a Server Socket for Business</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="sockets" data-secondary="opening" data-type="indexterm" id="soc_op"/>You need to write a socket-based server.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create a <code>ServerSocket</code> for the given port number.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-1.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>ServerSocket</code> represents the other end of a connection, the server that waits patiently for clients to come along and connect to it. You construct a <code>ServerSocket</code> with just the port number.<sup><a data-type="noteref" href="ch13.html#idm45290642028248" id="idm45290642028248-marker">1</a></sup> Because it doesn’t need to connect to another host, it doesn’t need a particular host’s address as the client socket constructor does.</p>&#13;
&#13;
<p>Assuming the <code>ServerSocket</code> constructor doesn’t throw an exception, you’re in business. Your next step is to await client activity, which you do by calling <code>accept()</code>. This call blocks until a client connects to your server; at that point, the <code>accept()</code> returns to you a <code>Socket</code> object (not a <code>ServerSocket</code>) that is connected in both directions to the <span class="keep-together"><code>ServerSocket</code></span> object on the client (or its equivalent, if written in another language). <a data-type="xref" href="#javacook-netserver-EX-1">Example 13-1</a> shows the code for a socket-based server.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-1">&#13;
<h5><span class="label">Example 13-1. </span>main/src/main/java/network/Listen.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Listen</code> <code class="o">{</code>&#13;
    <code class="cm">/** The TCP port for the service. */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">short</code> <code class="n">PORT</code> <code class="o">=</code> <code class="mi">9999</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">ServerSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
        <code class="n">Socket</code>  <code class="n">clientSock</code><code class="o">;</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">PORT</code><code class="o">);</code>&#13;
            <code class="k">while</code> <code class="o">((</code><code class="n">clientSock</code> <code class="o">=</code> <code class="n">sock</code><code class="o">.</code><code class="na">accept</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
                <code class="c1">// Process it, usually on a separate thread</code>&#13;
                <code class="c1">// to avoid blocking the accept() call.</code>&#13;
                <code class="n">process</code><code class="o">(</code><code class="n">clientSock</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** This would do something with one client. */</code>&#13;
    <code class="kd">static</code> <code class="kt">void</code> <code class="nf">process</code><code class="o">(</code><code class="n">Socket</code> <code class="n">s</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Accept from client "</code> <code class="o">+</code> <code class="n">s</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">());</code>&#13;
        <code class="c1">// The conversation would be here.</code>&#13;
        <code class="n">s</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>You would normally use the same socket for both reading and writing, as shown in the next few recipes.</p>&#13;
&#13;
<p>You may want to listen only on a particular network interface. Though&#13;
we tend to think of network  addresses as computer addresses, the&#13;
two are not the same. A network address is actually the address of&#13;
a particular network card, or network interface connection, on a&#13;
given computing device. A desktop computer, laptop, tablet,&#13;
or mobile phone might have only a single interface, hence a single&#13;
network address. But a large server machine might have two or more&#13;
interfaces, usually when it is connected to several networks. A&#13;
network router is a box, either special purpose (e.g., a Cisco&#13;
router), or general purpose (e.g., a Unix host), that has interfaces&#13;
on multiple networks <em>and</em> has both the capability and the&#13;
administrative permission to forward packets from one network to&#13;
another. A program running on such a server machine might want to&#13;
provide services only to its inside network or its outside network.&#13;
One way to accomplish this is by specifying the network interface&#13;
to be listened on. Suppose you want to provide a different view of&#13;
web pages for your intranet than you provide to outside customers.&#13;
For security reasons, you probably wouldn’t run both these services&#13;
on the same machine. But if you wanted to, you could do this by&#13;
providing the network interface addresses as arguments to the&#13;
<code>ServerSocket</code> <span class="keep-together">constructor.</span></p>&#13;
&#13;
<p>However, to use this form of the constructor, you don’t have the&#13;
option of using a string for the network address’s name, as you did&#13;
with the client socket; you must convert it to an <code>InetAddress</code>&#13;
object. You also have to provide a backlog argument, which is the&#13;
number of connections that can queue up to be accepted before clients&#13;
are told that your server is too busy. The complete setup is shown&#13;
in <a data-type="xref" href="#javacook-netserver-EX-2">Example 13-2</a>.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-2">&#13;
<h5><span class="label">Example 13-2. </span>main/src/main/java/network/ListenInside.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ListenInside</code> <code class="o">{</code>&#13;
    <code class="cm">/** The TCP port for the service. */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">short</code> <code class="n">PORT</code> <code class="o">=</code> <code class="mi">9999</code><code class="o">;</code>&#13;
    <code class="cm">/** The name of the network interface. */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">INSIDE_HOST</code> <code class="o">=</code> <code class="s">"acmewidgets-inside"</code><code class="o">;</code>&#13;
    <code class="cm">/** The number of clients allowed to queue */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">BACKLOG</code> <code class="o">=</code> <code class="mi">10</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">ServerSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
        <code class="n">Socket</code>  <code class="n">clientSock</code><code class="o">;</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">PORT</code><code class="o">,</code> <code class="n">BACKLOG</code><code class="o">,</code>&#13;
                <code class="n">InetAddress</code><code class="o">.</code><code class="na">getByName</code><code class="o">(</code><code class="n">INSIDE_HOST</code><code class="o">));</code>&#13;
            <code class="k">while</code> <code class="o">((</code><code class="n">clientSock</code> <code class="o">=</code> <code class="n">sock</code><code class="o">.</code><code class="na">accept</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
                <code class="c1">// Process it.</code>&#13;
                <code class="n">process</code><code class="o">(</code><code class="n">clientSock</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Hold server's conversation with one client. */</code>&#13;
    <code class="kd">static</code> <code class="kt">void</code> <code class="nf">process</code><code class="o">(</code><code class="n">Socket</code> <code class="n">s</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Connected from  "</code> <code class="o">+</code> <code class="n">INSIDE_HOST</code> <code class="o">+</code>&#13;
            <code class="s">": "</code> <code class="o">+</code> <code class="n">s</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">(</code>  <code class="o">));</code>&#13;
        <code class="c1">// The conversation would be here.</code>&#13;
        <code class="n">s</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><a data-primary="InetAddress.getByName() method" data-type="indexterm" id="idm45290641645112"/><code>InetAddress.getByName()</code> looks up the given hostname in a system-dependent way, referring to a configuration file in the <em>/etc</em> or <em>\windows</em> directory, or to some kind of resolver such as the Domain Name System. Consult a good book on networking and system administration if you need to modify this data.  <a data-primary="" data-startref="soc_op" data-type="indexterm" id="idm45290641642968"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.2 Finding Network Interfaces" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-10">&#13;
<h1>13.2 Finding Network Interfaces</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-10.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="sockets" data-secondary="network interfaces, finding" data-type="indexterm" id="idm45290641423832"/><a data-primary="networking" data-secondary="network interfaces, finding" data-type="indexterm" id="idm45290641422840"/>You wish to find out about the computer’s networking arrangements.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-10.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>NetworkInterface</code> class.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-10.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Every computer on a network has one or more “network interfaces.” On typical desktop machines, a network interface represents a network card or network port or some software network interface, such as the loopback interface. Each interface has an operating system–defined name. On most versions of Unix, these devices have a two- or three-character device driver name plus a digit (starting from 0), for example, <code>eth0</code> or <code>en0</code> for the first Ethernet on systems that hide the details of the card manufacturer, or <code>de0</code> and <code>de1</code> for the first and second <a data-primary="Digital Equipment" data-type="indexterm" id="idm45290641415000"/>Digital Equipment<sup><a data-type="noteref" href="ch13.html#idm45290641414168" id="idm45290641414168-marker">2</a></sup> DC21x4x-based Ethernet card, <code>xl0</code> for a 3Com EtherLink XL, and so on. The loopback interface is almost invariably <code>lo0</code> on all Unix-like platforms.</p>&#13;
&#13;
<p>So what? Most of the time this is of no consequence to you. If you have only one network connection, like a cable link to your ISP, you really don’t care. Where this matters is on a server, where you might need to find the address for a given network, for example. The <code>NetworkInterface</code> class lets you find out. It has static methods for listing the interfaces and other methods for finding the addresses associated with a given interface. The program in <a data-type="xref" href="#javacook-netserver-EX-14">Example 13-3</a> shows some examples of using this class. Running it prints the names of all the local interfaces. If you happen to be on a computer named <em>laptop</em>, it prints the machine’s network address; if not, you probably want to change it to accept the local computer’s name from the command line; this is left as an exercise for the reader.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-14">&#13;
<h5><span class="label">Example 13-3. </span>main/src/main/java/network/NetworkInterfaceDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">NetworkInterfaceDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">a</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">Enumeration</code><code class="o">&lt;</code><code class="n">NetworkInterface</code><code class="o">&gt;</code> <code class="n">list</code> <code class="o">=</code>&#13;
            <code class="n">NetworkInterface</code><code class="o">.</code><code class="na">getNetworkInterfaces</code><code class="o">();</code>&#13;
        <code class="k">while</code> <code class="o">(</code><code class="n">list</code><code class="o">.</code><code class="na">hasMoreElements</code><code class="o">())</code> <code class="o">{</code>&#13;
            <code class="c1">// Get one NetworkInterface</code>&#13;
            <code class="n">NetworkInterface</code> <code class="n">iface</code> <code class="o">=</code> <code class="n">list</code><code class="o">.</code><code class="na">nextElement</code><code class="o">();</code>&#13;
            <code class="c1">// Print its name</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">iface</code><code class="o">.</code><code class="na">getDisplayName</code><code class="o">());</code>&#13;
            <code class="n">Enumeration</code><code class="o">&lt;</code><code class="n">InetAddress</code><code class="o">&gt;</code> <code class="n">addrs</code> <code class="o">=</code> <code class="n">iface</code><code class="o">.</code><code class="na">getInetAddresses</code><code class="o">();</code>&#13;
            <code class="c1">// And its address(es)</code>&#13;
            <code class="k">while</code> <code class="o">(</code><code class="n">addrs</code><code class="o">.</code><code class="na">hasMoreElements</code><code class="o">())</code> <code class="o">{</code>&#13;
                <code class="n">InetAddress</code> <code class="n">addr</code> <code class="o">=</code> <code class="n">addrs</code><code class="o">.</code><code class="na">nextElement</code><code class="o">();</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">addr</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
        <code class="o">}</code>&#13;
        <code class="c1">// Try to get the Interface for a given local (this machine's) address</code>&#13;
        <code class="n">InetAddress</code> <code class="n">destAddr</code> <code class="o">=</code> <code class="n">InetAddress</code><code class="o">.</code><code class="na">getByName</code><code class="o">(</code><code class="s">"laptop"</code><code class="o">);</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">NetworkInterface</code> <code class="n">dest</code> <code class="o">=</code> <code class="n">NetworkInterface</code><code class="o">.</code><code class="na">getByInetAddress</code><code class="o">(</code><code class="n">destAddr</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Address for "</code> <code class="o">+</code> <code class="n">destAddr</code> <code class="o">+</code> <code class="s">" is "</code> <code class="o">+</code> <code class="n">dest</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">SocketException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Couldn't get address for "</code> <code class="o">+</code> <code class="n">destAddr</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.3 Returning a Response (String or Binary)" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-2">&#13;
<h1>13.3 Returning a Response (String or Binary)</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-2.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="binary data" data-secondary="returning over sockets" data-type="indexterm" id="bd_ros"/><a data-primary="sockets" data-secondary="binary/string data, returning over" data-type="indexterm" id="soc_bsd"/><a data-primary="sockets" data-secondary="returning responses" data-type="indexterm" id="soc_rr"/><a data-primary="strings" data-secondary="returning over sockets" data-type="indexterm" id="stri_ros"/>You need to write a string or binary data to the client.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-2.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>The socket gives you an <code>InputStream</code> and an <code>OutputStream</code>. Use them.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-2.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The client socket examples in the previous chapter called the <a data-primary="getInputStream() method" data-type="indexterm" id="idm45290642019560"/><a data-primary="getOutputStream() method" data-type="indexterm" id="idm45290641200280"/><code>getInputStream()</code> and <code>getOutputStream()</code> methods. These examples do the same. The main difference is that these ones get the socket from a <code>ServerSocket</code>’s <a data-primary="accept() method" data-type="indexterm" id="idm45290641198248"/><code>accept()</code> method. Another distinction is, by definition, that normally the server creates or modifies the data and sends it to the client. <a data-type="xref" href="#javacook-netserver-EX-3">Example 13-4</a> is a simple <code>Echo</code> server, which the <code>Echo</code> client of <a data-type="xref" href="ch12.html#javacook-netclient-SECT-4">Recipe 12.5</a> can connect to. This server handles one complete connection with a client, then goes back and does the <code>accept()</code> to wait for the next client.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-3">&#13;
<h5><span class="label">Example 13-4. </span>main/src/main/java/network/EchoServer.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EchoServer</code> <code class="o">{</code>&#13;
    <code class="cm">/** Our server-side rendezvous socket */</code>&#13;
    <code class="kd">protected</code> <code class="n">ServerSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
    <code class="cm">/** The port number to use by default */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">ECHOPORT</code> <code class="o">=</code> <code class="mi">7</code><code class="o">;</code>&#13;
    <code class="cm">/** Flag to control debugging */</code>&#13;
    <code class="kd">protected</code> <code class="kt">boolean</code> <code class="n">debug</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** main: construct and run */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="kt">int</code> <code class="n">p</code> <code class="o">=</code> <code class="n">ECHOPORT</code><code class="o">;</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">args</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">p</code> <code class="o">=</code> <code class="n">Integer</code><code class="o">.</code><code class="na">parseInt</code><code class="o">(</code><code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">NumberFormatException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Usage: EchoServer [port#]"</code><code class="o">);</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">new</code> <code class="nf">EchoServer</code><code class="o">(</code><code class="n">p</code><code class="o">).</code><code class="na">handle</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Construct an EchoServer on the given port number */</code>&#13;
    <code class="kd">public</code> <code class="nf">EchoServer</code><code class="o">(</code><code class="kt">int</code> <code class="n">port</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"I/O error in setup"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** This handles the connections */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">handle</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">Socket</code> <code class="n">ios</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
        <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Waiting for client..."</code><code class="o">);</code>&#13;
                <code class="n">ios</code> <code class="o">=</code> <code class="n">sock</code><code class="o">.</code><code class="na">accept</code><code class="o">();</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Accepted from "</code> <code class="o">+</code>&#13;
                    <code class="n">ios</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">().</code><code class="na">getHostName</code><code class="o">());</code>&#13;
                <code class="k">try</code> <code class="o">(</code><code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code>&#13;
                            <code class="k">new</code> <code class="nf">InputStreamReader</code><code class="o">(</code><code class="n">ios</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">(),</code> <code class="s">"8859_1"</code><code class="o">));</code>&#13;
                        <code class="n">PrintWriter</code> <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintWriter</code><code class="o">(</code>&#13;
                            <code class="k">new</code> <code class="nf">OutputStreamWriter</code><code class="o">(</code><code class="n">ios</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">(),</code> <code class="s">"8859_1"</code><code class="o">),</code>&#13;
                            <code class="kc">true</code><code class="o">);)</code> <code class="o">{</code>&#13;
                    <code class="n">String</code> <code class="n">echoLine</code><code class="o">;</code>&#13;
                    <code class="k">while</code> <code class="o">((</code><code class="n">echoLine</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                        <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Read "</code> <code class="o">+</code> <code class="n">echoLine</code><code class="o">);</code>&#13;
                        <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">echoLine</code> <code class="o">+</code> <code class="s">"\r\n"</code><code class="o">);</code>&#13;
                        <code class="n">os</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
                        <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Wrote "</code> <code class="o">+</code> <code class="n">echoLine</code><code class="o">);</code>&#13;
                    <code class="o">}</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"All done!"</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
        <code class="cm">/* NOTREACHED */</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>To send a string across an arbitrary network connection, some authorities recommend sending both the carriage return and the newline character; many protocol specifications require that you do so. This explains the <code>\r\n</code> in the code. If the other end is a DOS program or a Telnet-like program, it may be expecting both characters. On the other hand, if you are writing both ends, you can simply use <code>println()</code>—followed always by an explicit <a data-primary="flush() method" data-type="indexterm" id="idm45290641182920"/><code>flush()</code> before you read—to prevent the deadlock of having both ends trying to read with one end’s data still in the <code>PrintWriter</code>’s buffer!</p>&#13;
&#13;
<p>If you need to process binary data, use the data streams from <code>java.io</code> instead of the&#13;
readers/writers. I need a server for the <code>DaytimeBinary</code> program of&#13;
<a data-type="xref" href="ch12.html#javacook-netclient-SECT-5">Recipe 12.6</a>. In operation, it should look like the following:</p>&#13;
<pre data-type="programlisting" id="I_17_tt501">C:\javasrc\network&gt;<strong>java network.DaytimeBinary</strong>&#13;
Remote time is 3161316799&#13;
BASE_DIFF is 2208988800&#13;
Time diff == 952284799&#13;
Time on localhost is Sun Mar 08 19:33:19 GMT 2014&#13;
&#13;
C:\javasrc\network&gt;<strong>time/t</strong>&#13;
Current time is  7:33:23.84p&#13;
&#13;
C:\javasrc\network&gt;<strong>date/t</strong>&#13;
Current date is Sun 03-08-2014&#13;
&#13;
C:\javasrc\network&gt;</pre>&#13;
&#13;
<p>Well, it happens that I have such a program in my arsenal, so I present it in <a data-type="xref" href="#javacook-netserver-EX-4">Example 13-5</a>. Note that it directly uses certain public constants defined in the client class. Normally these are defined in the server class and used by the client, but I wanted to present the client code first.<a data-primary="" data-startref="bd_ros" data-type="indexterm" id="idm45290640831912"/><a data-primary="" data-startref="soc_bsd" data-type="indexterm" id="idm45290640830968"/><a data-primary="" data-startref="soc_rr" data-type="indexterm" id="idm45290640830024"/><a data-primary="" data-startref="stri_ros" data-type="indexterm" id="idm45290640829080"/></p>&#13;
<div data-type="example" id="javacook-netserver-EX-4">&#13;
<h5><span class="label">Example 13-5. </span>main/src/main/java/network/DaytimeServer.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DaytimeServer</code> <code class="o">{</code>&#13;
    <code class="cm">/** Our server-side rendezvous socket */</code>&#13;
    <code class="n">ServerSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
    <code class="cm">/** The port number to use by default */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">PORT</code> <code class="o">=</code> <code class="mi">37</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** main: construct and run */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">DaytimeServer</code><code class="o">(</code><code class="n">PORT</code><code class="o">).</code><code class="na">runService</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Construct a DaytimeServer on the given port number */</code>&#13;
    <code class="kd">public</code> <code class="nf">DaytimeServer</code><code class="o">(</code><code class="kt">int</code> <code class="n">port</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"I/O error in setup\n"</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** This handles the connections */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">runService</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">Socket</code> <code class="n">ios</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
        <code class="n">DataOutputStream</code> <code class="n">os</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
        <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Waiting for connection on port "</code> <code class="o">+</code> <code class="n">PORT</code><code class="o">);</code>&#13;
                <code class="n">ios</code> <code class="o">=</code> <code class="n">sock</code><code class="o">.</code><code class="na">accept</code><code class="o">();</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Accepted from "</code> <code class="o">+</code>&#13;
                    <code class="n">ios</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">().</code><code class="na">getHostName</code><code class="o">());</code>&#13;
                <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DataOutputStream</code><code class="o">(</code><code class="n">ios</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">());</code>&#13;
                <code class="kt">long</code> <code class="n">time</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">currentTimeMillis</code><code class="o">();</code>&#13;
&#13;
                <code class="n">time</code> <code class="o">/=</code> <code class="mi">1000</code><code class="o">;</code>    <code class="c1">// Daytime Protocol is in seconds</code>&#13;
&#13;
                <code class="c1">// Convert to Java time base.</code>&#13;
                <code class="n">time</code> <code class="o">+=</code> <code class="n">RDateClient</code><code class="o">.</code><code class="na">BASE_DIFF</code><code class="o">;</code>&#13;
&#13;
                <code class="c1">// Write it, truncating cast to int since it is using</code>&#13;
                <code class="c1">// the Internet Daytime protocol which uses 4 bytes.</code>&#13;
                <code class="c1">// This will fail in the year 2038, along with all</code>&#13;
                <code class="c1">// 32-bit timekeeping systems based from 1970.</code>&#13;
                <code class="c1">// Remember, you read about the Y2038 crisis here first!</code>&#13;
                <code class="n">os</code><code class="o">.</code><code class="na">writeInt</code><code class="o">((</code><code class="kt">int</code><code class="o">)</code><code class="n">time</code><code class="o">);</code>&#13;
                <code class="n">os</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.4 Returning Object Information Across a Network Connection" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-3">&#13;
<h1>13.4 Returning Object Information Across a Network Connection</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-3.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="networking" data-secondary="returning objects over" data-type="indexterm" id="idm45290640742456"/><a data-primary="sockets" data-secondary="returning objects over" data-type="indexterm" id="idm45290640741480"/>You need to return an object across a network connection.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-3.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create the object you need, and write it using an <code>ObjectOutputStream</code> created on top of the socket’s output stream.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-3.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The program in <a data-type="xref" href="ch12.html#javacook-netclient-EX-7">Example 12-7</a> in the previous chapter reads a <code>Date</code> object over an <code>ObjectInputStream</code>. <a data-type="xref" href="#javacook-netserver-EX-5">Example 13-6</a>, the <code>DaytimeObjectServer</code> (the other end of that process), is a program that constructs a <code>Date</code> object each time it’s connected to and returns it to the client.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-5">&#13;
<h5><span class="label">Example 13-6. </span>main/src/main/java/network/DaytimeObjectServer.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DaytimeObjectServer</code> <code class="o">{</code>&#13;
    <code class="cm">/** The TCP port for the object time service. */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">short</code> <code class="n">TIME_PORT</code> <code class="o">=</code> <code class="mi">1951</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">ServerSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
        <code class="n">Socket</code>  <code class="n">clientSock</code><code class="o">;</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">TIME_PORT</code><code class="o">);</code>&#13;
            <code class="k">while</code> <code class="o">((</code><code class="n">clientSock</code> <code class="o">=</code> <code class="n">sock</code><code class="o">.</code><code class="na">accept</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Accept from "</code> <code class="o">+</code>&#13;
                    <code class="n">clientSock</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">());</code>&#13;
                <code class="n">ObjectOutputStream</code> <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ObjectOutputStream</code><code class="o">(</code>&#13;
                    <code class="n">clientSock</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">());</code>&#13;
&#13;
                <code class="c1">// Construct and write the Object</code>&#13;
                <code class="n">os</code><code class="o">.</code><code class="na">writeObject</code><code class="o">(</code><code class="n">LocalDateTime</code><code class="o">.</code><code class="na">now</code><code class="o">());</code>&#13;
&#13;
                <code class="n">os</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
            <code class="o">}</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.5 Handling Multiple Clients" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-4">&#13;
<h1>13.5 Handling Multiple Clients</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-4.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="sockets" data-secondary="multiple" data-type="indexterm" id="soc_mul"/>Your server needs to handle multiple clients.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-4.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a thread for each.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-4.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>In the C world, several mechanisms allow a server to handle multiple clients. One is to use a special system call<a data-primary="select() method" data-type="indexterm" id="idm45290640672072"/><a data-primary="poll() method" data-type="indexterm" id="idm45290640671368"/> <code>select()</code> or <code>poll()</code>, which notifies the server when any of a set of file/socket descriptors is ready to read, ready to write, or has an error. By including its rendezvous socket  (equivalent to our <code>ServerSocket</code>) in this list, the C-based server can read from any of a number of clients in any order. Java does not provide this call, because it is not readily implementable on some Java platforms. Instead, Java uses the general-purpose <code>Thread</code> mechanism, as described in <a data-type="xref" href="ch16.html#javacook-threads">Chapter 16</a> (threads are now commonplace in many programming languages, though not always under that name). Each time the code accepts a new connection from the <code>ServerSocket</code>, it immediately constructs and starts a new thread object to process that <span class="keep-together">client.</span><sup><a data-type="noteref" href="ch13.html#idm45290640666504" id="idm45290640666504-marker">3</a></sup></p>&#13;
&#13;
<p>The Java code to implement accepting on a socket is pretty simple, apart from having to catch <code>IOException</code>s:</p>&#13;
&#13;
<pre data-type="programlisting">/** Run the main loop of the Server. */&#13;
void runServer( ) {&#13;
    while (true) {&#13;
        try {&#13;
            Socket clntSock = sock.accept( );&#13;
            new Handler(clntSock).start( );&#13;
        } catch(IOException e) {&#13;
            System.err.println(e);&#13;
        }&#13;
    }&#13;
}</pre>&#13;
&#13;
<p>To use a thread, you must either subclass <code>Thread</code> or implement <code>Runnable</code>. The <code>Handler</code>  class must be a subclass of <code>Thread</code> for this code to work as written; if <code>Handler</code> instead implemented the <code>Runnable</code>  interface, the code would pass an instance of the <code>Runnable</code> into the constructor for <code>Thread</code>, as in:</p>&#13;
&#13;
<pre data-type="programlisting">Thread t = new Thread(new Handler(clntSock));&#13;
t.start( );</pre>&#13;
&#13;
<p>But as written, <code>Handler</code> is constructed using the normal socket returned by <a data-primary="accept() method" data-type="indexterm" id="idm45290640656232"/><code>accept()</code> and normally calls the socket’s <a data-primary="getInputStream() method" data-type="indexterm" id="idm45290640655144"/><a data-primary="getOutputStream() method" data-type="indexterm" id="idm45290640654440"/><code>getInputStream()</code> and <code>getOutputStream()</code> methods and holds its conversation in the usual way. I’ll present a full implementation, a threaded echo client. First, a session showing it in use:</p>&#13;
<pre data-type="programlisting" id="I_17_tt504">$<strong> java network.EchoServerThreaded</strong>&#13;
EchoServerThreaded ready for connections.&#13;
Socket starting: Socket[addr=localhost/127.0.0.1,port=2117,localport=7]&#13;
Socket starting: Socket[addr=darian/192.168.1.50,port=13386,localport=7]&#13;
Socket starting: Socket[addr=darian/192.168.1.50,port=22162,localport=7]&#13;
Socket ENDED: Socket[addr=darian/192.168.1.50,port=22162,localport=7]&#13;
Socket ENDED: Socket[addr=darian/192.168.1.50,port=13386,localport=7]&#13;
Socket ENDED: Socket[addr=localhost/127.0.0.1,port=2117,localport=7]</pre>&#13;
&#13;
<p>Here I connected to the server once with my <code>EchoClient</code>  program and, while still&#13;
connected, called it up again (and again) with an operating system–provided Telnet client.&#13;
The server communicated with all the clients concurrently, sending the answers from the&#13;
first client back to the first client, and the data from the second client back to the&#13;
second client. In short, it works. I ended the sessions with the end-of-file character in&#13;
the program and used the normal disconnect mechanism from the Telnet client.&#13;
<a data-type="xref" href="#javacook-netserver-EX-6-ch16">Example 13-7</a> is the code for the server.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-6-ch16">&#13;
<h5><span class="label">Example 13-7. </span>main/src/main/java/network/EchoServerThreaded.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EchoServerThreaded</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">ECHOPORT</code> <code class="o">=</code> <code class="mi">7</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">av</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">EchoServerThreaded</code><code class="o">().</code><code class="na">runServer</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">runServer</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">ServerSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
        <code class="n">Socket</code> <code class="n">clientSocket</code><code class="o">;</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">ECHOPORT</code><code class="o">);</code>&#13;
&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"EchoServerThreaded ready for connections."</code><code class="o">);</code>&#13;
&#13;
            <code class="cm">/* Wait for a connection */</code>&#13;
            <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">clientSocket</code> <code class="o">=</code> <code class="n">sock</code><code class="o">.</code><code class="na">accept</code><code class="o">();</code>&#13;
                <code class="cm">/* Create a thread to do the communication, and start it */</code>&#13;
                <code class="k">new</code> <code class="nf">Handler</code><code class="o">(</code><code class="n">clientSocket</code><code class="o">).</code><code class="na">start</code><code class="o">();</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="cm">/* Crash the server if IO fails. Something bad has happened */</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Could not accept "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** A Thread subclass to handle one client conversation. */</code>&#13;
    <code class="kd">class</code> <code class="nc">Handler</code> <code class="kd">extends</code> <code class="n">Thread</code> <code class="o">{</code>&#13;
        <code class="n">Socket</code> <code class="n">sock</code><code class="o">;</code>&#13;
&#13;
        <code class="n">Handler</code><code class="o">(</code><code class="n">Socket</code> <code class="n">s</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="n">s</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Socket starting: "</code> <code class="o">+</code> <code class="n">sock</code><code class="o">);</code>&#13;
            <code class="k">try</code> <code class="o">(</code><code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code>&#13;
                        <code class="k">new</code> <code class="nf">InputStreamReader</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
                    <code class="n">PrintStream</code> <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintStream</code><code class="o">(</code>&#13;
                        <code class="n">sock</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">(),</code> <code class="kc">true</code><code class="o">);)</code> <code class="o">{</code>&#13;
                <code class="n">String</code> <code class="n">line</code><code class="o">;</code>&#13;
                <code class="k">while</code> <code class="o">((</code><code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">line</code> <code class="o">+</code> <code class="s">"\r\n"</code><code class="o">);</code>&#13;
                    <code class="n">os</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
                <code class="o">}</code>&#13;
                <code class="n">sock</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"IO Error on socket "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
                <code class="k">return</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Socket ENDED: "</code> <code class="o">+</code> <code class="n">sock</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>A lot of short transactions can degrade performance, because each client causes the creation&#13;
of a new threaded object. If you know or can reliably predict the degree of concurrency&#13;
that is needed, an alternative paradigm involves the precreation of a fixed number of&#13;
threads. But then how do you control their access to the <code>ServerSocket</code>? A look at the&#13;
<a data-primary="ServerSocket class documentation" data-type="indexterm" id="idm45290640638008"/><code>ServerSocket</code>  class documentation reveals that the <code>accept()</code>   method is not&#13;
synchronized, meaning that any number of threads can call the method concurrently. This&#13;
could cause bad things to happen. So I use the <code>synchronized</code> keyword around this call to&#13;
ensure that only one client runs in it at a time, because it updates global data. When no&#13;
clients are connected, you will have one (randomly selected) thread running in the&#13;
<code>ServerSocket</code> object’s <code>accept()</code> method, waiting for a connection, plus <em>n-1</em> threads&#13;
waiting for the first thread to return from the method. As soon as the first thread&#13;
manages to accept a connection, it goes off and holds its conversation, releasing its lock&#13;
in the process so that another randomly chosen thread is allowed into the <a data-primary="accept() method" data-type="indexterm" id="idm45290639932488"/><code>accept()</code>&#13;
method. Each thread’s <a data-primary="run() method" data-type="indexterm" id="idm45290639931352"/><code>run()</code> method has an infinite loop beginning with an <code>accept()</code>&#13;
and then holding the conversation. The result is that client connections can get started&#13;
more quickly, at a cost of slightly greater server startup time. Doing it this way also&#13;
avoids the overhead of constructing a new <code>Handler</code> or <code>Thread</code> object each time a request&#13;
comes along. This general approach is similar to what the popular Apache web server does,&#13;
although it normally creates a number or pool of identical processes (instead of threads)&#13;
to handle client connections. Accordingly, I have modified the <code>EchoServerThreaded</code> class&#13;
shown in <a data-type="xref" href="#javacook-netserver-EX-6-ch16">Example 13-7</a> to work this way, as you can see in&#13;
<a data-type="xref" href="#javacook-netserver-EX-7">Example 13-8</a>.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-7">&#13;
<h5><span class="label">Example 13-8. </span>main/src/main/java/network/EchoServerThreaded2.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EchoServerThreaded2</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">ECHOPORT</code> <code class="o">=</code> <code class="mi">7</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">NUM_THREADS</code> <code class="o">=</code> <code class="mi">4</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** Main method, to start the servers. */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">av</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">EchoServerThreaded2</code><code class="o">(</code><code class="n">ECHOPORT</code><code class="o">,</code> <code class="n">NUM_THREADS</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Constructor */</code>&#13;
    <code class="kd">public</code> <code class="nf">EchoServerThreaded2</code><code class="o">(</code><code class="kt">int</code> <code class="n">port</code><code class="o">,</code> <code class="kt">int</code> <code class="n">numThreads</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">ServerSocket</code> <code class="n">servSock</code><code class="o">;</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">servSock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ServerSocket</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="cm">/* Crash the server if IO fails. Something bad has happened */</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">RuntimeException</code><code class="o">(</code><code class="s">"Could not create ServerSocket "</code><code class="o">,</code> <code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="c1">// Create a series of threads and start them.</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numThreads</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="k">new</code> <code class="nf">Handler</code><code class="o">(</code><code class="n">servSock</code><code class="o">,</code> <code class="n">i</code><code class="o">).</code><code class="na">start</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** A Thread subclass to handle one client conversation. */</code>&#13;
    <code class="kd">class</code> <code class="nc">Handler</code> <code class="kd">extends</code> <code class="n">Thread</code> <code class="o">{</code>&#13;
        <code class="n">ServerSocket</code> <code class="n">servSock</code><code class="o">;</code>&#13;
        <code class="kt">int</code> <code class="n">threadNumber</code><code class="o">;</code>&#13;
&#13;
        <code class="cm">/** Construct a Handler. */</code>&#13;
        <code class="n">Handler</code><code class="o">(</code><code class="n">ServerSocket</code> <code class="n">s</code><code class="o">,</code> <code class="kt">int</code> <code class="n">i</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">servSock</code> <code class="o">=</code> <code class="n">s</code><code class="o">;</code>&#13;
            <code class="n">threadNumber</code> <code class="o">=</code> <code class="n">i</code><code class="o">;</code>&#13;
            <code class="n">setName</code><code class="o">(</code><code class="s">"Thread "</code> <code class="o">+</code> <code class="n">threadNumber</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="cm">/*</code>&#13;
<code class="cm">             * Wait for a connection. Synchronized on the ServerSocket while</code>&#13;
<code class="cm">             * calling its accept() method.</code>&#13;
<code class="cm">             */</code>&#13;
            <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="k">try</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" waiting"</code><code class="o">);</code>&#13;
&#13;
                    <code class="n">Socket</code> <code class="n">clientSocket</code><code class="o">;</code>&#13;
                    <code class="c1">// Wait here for the next connection.</code>&#13;
                    <code class="kd">synchronized</code> <code class="o">(</code><code class="n">servSock</code><code class="o">)</code> <code class="o">{</code>&#13;
                        <code class="n">clientSocket</code> <code class="o">=</code> <code class="n">servSock</code><code class="o">.</code><code class="na">accept</code><code class="o">();</code>&#13;
                    <code class="o">}</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
                        <code class="n">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" starting, IP="</code> <code class="o">+</code>&#13;
                        <code class="n">clientSocket</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">());</code>&#13;
                    <code class="k">try</code> <code class="o">(</code><code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code>&#13;
                            <code class="k">new</code> <code class="nf">InputStreamReader</code><code class="o">(</code><code class="n">clientSocket</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
                            <code class="n">PrintStream</code> <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintStream</code><code class="o">(</code>&#13;
                                <code class="n">clientSocket</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">(),</code> <code class="kc">true</code><code class="o">);)</code> <code class="o">{</code>&#13;
                        <code class="n">String</code> <code class="n">line</code><code class="o">;</code>&#13;
                        <code class="k">while</code> <code class="o">((</code><code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">line</code> <code class="o">+</code> <code class="s">"\r\n"</code><code class="o">);</code>&#13;
                            <code class="n">os</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
                        <code class="o">}</code>&#13;
                        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" ENDED "</code><code class="o">);</code>&#13;
                        <code class="n">clientSocket</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
                    <code class="o">}</code>&#13;
                <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">": IO Error on socket "</code> <code class="o">+</code> <code class="n">ex</code><code class="o">);</code>&#13;
                    <code class="k">return</code><code class="o">;</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>It is quite possible to implement a server of this sort with NIO, the “new” (back in J2SE 1.4) I/O package.&#13;
However, the code to do so outweighs anything in this chapter, and it is fraught with&#13;
issues. There are several good tutorials on the internet for the person who truly needs&#13;
the performance gain of using NIO to manage server <span class="keep-together">connections.</span><a data-primary="" data-startref="soc_mul" data-type="indexterm" id="idm45290639915944"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.6 Serving the HTTP Protocol" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-5">&#13;
<h1>13.6 Serving the HTTP Protocol</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-5.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="HTTP protocol" data-type="indexterm" id="idm45290639912120"/><a data-primary="sockets" data-secondary="HTTP protocol" data-type="indexterm" id="idm45290639668424"/>You want to serve up a protocol such as HTTP.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-5.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create a <code>ServerSocket</code> and write some code that speaks the particular protocol.&#13;
Or, better, use a Java-powered web server such as Apache Tomcat or a Java Enterprise Edition (Java EE)&#13;
server such as JBoss WildFly.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-5.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>You can implement your own HTTP protocol server for very simple applications, which we’ll do here.&#13;
For any serious development, you want to use the Java Enterprise Edition; see the note&#13;
at the beginning of this chapter.</p>&#13;
&#13;
<p>This example just constructs a <code>ServerSocket</code> and listens on it. When connections come in,&#13;
they are replied to using the HTTP protocol. So it is somewhat more involved than the&#13;
simple <code>Echo</code> server presented in <a data-type="xref" href="#javacook-netserver-SECT-2">Recipe 13.3</a>. However, it’s not a&#13;
complete web server; the filename in the request is ignored, and a standard message is&#13;
always returned. This is thus a <em>very</em> simple web server; it follows only the bare minimum&#13;
of the HTTP protocol needed to send its response back.&#13;
For a real web server written in Java, get Tomcat from the&#13;
<a href="http://tomcat.apache.org">Apache Tomcat website</a> or any of the Jakarta/JavaEE Application Servers.&#13;
The code shown in <a data-type="xref" href="#javacook-netserver-EX-8">Example 13-9</a>, however, is enough to understand how to build&#13;
a simple server that responds to requests using a protocol.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-8">&#13;
<h5><span class="label">Example 13-9. </span>main/src/main/java/network/WebServer0.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">WebServer0</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">HTTP</code> <code class="o">=</code> <code class="mi">80</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">CRLF</code> <code class="o">=</code> <code class="s">"\r\n"</code><code class="o">;</code>&#13;
    <code class="n">ServerSocket</code> <code class="n">s</code><code class="o">;</code>&#13;
    <code class="cm">/** A link to the source of this program, used in error message */</code>&#13;
    <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">VIEW_SOURCE_URL</code> <code class="o">=</code>&#13;
    <code class="s">"https://github.com/IanDarwin/javasrc/tree/master/main/src/main/</code>&#13;
<code class="s">      java/network"</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/**</code>&#13;
<code class="cm">     * Main method, just creates a server and call its runServer().</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"DarwinSys JavaWeb Server 0.0 starting..."</code><code class="o">);</code>&#13;
        <code class="n">WebServer0</code> <code class="n">w</code> <code class="o">=</code> <code class="k">new</code> <code class="n">WebServer0</code><code class="o">();</code>&#13;
        <code class="kt">int</code> <code class="n">port</code> <code class="o">=</code> <code class="n">HTTP</code><code class="o">;</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">args</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">port</code> <code class="o">=</code> <code class="n">Integer</code><code class="o">.</code><code class="na">parseInt</code><code class="o">(</code><code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="n">w</code><code class="o">.</code><code class="na">runServer</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>        <code class="c1">// never returns!!</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Get the actual ServerSocket; deferred until after Constructor</code>&#13;
<code class="cm">     * so subclass can mess with ServerSocketFactory (e.g., to do SSL).</code>&#13;
<code class="cm">     * @param port The port number to listen on</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="n">ServerSocket</code> <code class="nf">getServerSocket</code><code class="o">(</code><code class="kt">int</code> <code class="n">port</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nf">ServerSocket</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** RunServer accepts connections and passes each one to handler. */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">runServer</code><code class="o">(</code><code class="kt">int</code> <code class="n">port</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">s</code> <code class="o">=</code> <code class="n">getServerSocket</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>&#13;
        <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">Socket</code> <code class="n">us</code> <code class="o">=</code> <code class="n">s</code><code class="o">.</code><code class="na">accept</code><code class="o">();</code>&#13;
                <code class="n">Handler</code><code class="o">(</code><code class="n">us</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code><code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
                <code class="k">return</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Handler() handles one conversation with a Web client.</code>&#13;
<code class="cm">     * This is the only part of the program that "knows" HTTP.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">Handler</code><code class="o">(</code><code class="n">Socket</code> <code class="n">s</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">BufferedReader</code> <code class="n">is</code><code class="o">;</code>    <code class="c1">// inputStream, from Viewer</code>&#13;
        <code class="n">PrintWriter</code> <code class="n">os</code><code class="o">;</code>        <code class="c1">// outputStream, to Viewer</code>&#13;
        <code class="n">String</code> <code class="n">request</code><code class="o">;</code>        <code class="c1">// what Viewer sends us.</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">String</code> <code class="n">from</code> <code class="o">=</code> <code class="n">s</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">().</code><code class="na">toString</code><code class="o">();</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Accepted connection from "</code> <code class="o">+</code> <code class="n">from</code><code class="o">);</code>&#13;
            <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">s</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
            <code class="n">request</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">();</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Request: "</code> <code class="o">+</code> <code class="n">request</code><code class="o">);</code>&#13;
&#13;
            <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintWriter</code><code class="o">(</code><code class="n">s</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">(),</code> <code class="kc">true</code><code class="o">);</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"HTTP/1.0 200 Here is your data"</code> <code class="o">+</code> <code class="n">CRLF</code><code class="o">);</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"Content-type: text/html"</code> <code class="o">+</code> <code class="n">CRLF</code><code class="o">);</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"Server-name: DarwinSys NULL Java WebServer 0"</code> <code class="o">+</code> <code class="n">CRLF</code><code class="o">);</code>&#13;
            <code class="n">String</code> <code class="n">reply1</code> <code class="o">=</code> <code class="s">"&lt;html&gt;&lt;head&gt;"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;title&gt;Wrong System Reached&lt;/title&gt;&lt;/head&gt;\n"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;h1&gt;Welcome, "</code><code class="o">;</code>&#13;
            <code class="n">String</code> <code class="n">reply2</code> <code class="o">=</code> <code class="s">", but...&lt;/h1&gt;\n"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;p&gt;You have reached a desktop machine "</code> <code class="o">+</code>&#13;
                <code class="s">"that does not run a real Web service.\n"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;p&gt;Please pick another system!&lt;/p&gt;\n"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;p&gt;Or view &lt;a href=\""</code> <code class="o">+</code> <code class="n">VIEW_SOURCE_URL</code> <code class="o">+</code> <code class="s">"\"&gt;"</code> <code class="o">+</code>&#13;
                <code class="s">"the WebServer0 source on github&lt;/a&gt;.&lt;/p&gt;\n"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;hr/&gt;&lt;em&gt;Java-based WebServer0&lt;/em&gt;&lt;hr/&gt;\n"</code> <code class="o">+</code>&#13;
                <code class="s">"&lt;/html&gt;\n"</code><code class="o">;</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"Content-length: "</code> <code class="o">+</code>&#13;
                <code class="o">(</code><code class="n">reply1</code><code class="o">.</code><code class="na">length</code><code class="o">()</code> <code class="o">+</code> <code class="n">from</code><code class="o">.</code><code class="na">length</code><code class="o">()</code> <code class="o">+</code> <code class="n">reply2</code><code class="o">.</code><code class="na">length</code><code class="o">())</code> <code class="o">+</code> <code class="n">CRLF</code><code class="o">);</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">CRLF</code><code class="o">);</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">reply1</code> <code class="o">+</code> <code class="n">from</code> <code class="o">+</code> <code class="n">reply2</code> <code class="o">+</code> <code class="n">CRLF</code><code class="o">);</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
            <code class="n">s</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"IOException "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">return</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.7 Securing a Web Server with SSL and JSSE" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-6">&#13;
<h1>13.7 Securing a Web Server with SSL and JSSE</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-6.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="sockets" data-secondary="SSL, securing with" data-type="indexterm" id="soc_ssl"/><a data-primary="SSL" data-type="indexterm" id="ssl_ab"/><a data-primary="JSSE" data-type="indexterm" id="jsse_ab"/>You want to protect your network traffic from prying eyes or malicious modification while the data is in transit.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-6.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the Java Secure Socket Extension, JSSE, to encrypt your traffic.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-6.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>JSSE provides services at a number of levels, but the simplest way to use it is simply to get your <code>ServerSocket</code> from an <code>SSLServerSocketFactory</code>  instead of using the <code>ServerSocket</code> constructor directly. SSL is the Secure Sockets Layer; a revised version is known as  TLS. It is specifically for use on the web. To secure other protocols, you’d have to use a different form of the <code>SocketFactory</code>.</p>&#13;
&#13;
<p>The <code>SSLServerSocketFactory</code> returns a <code>ServerSocket</code> that is set up to do SSL encryption. <a data-type="xref" href="#javacook-netserver-EX-9">Example 13-10</a> uses this technique to override the <code>getServerSocket()</code> method in <a data-type="xref" href="#javacook-netserver-SECT-5">Recipe 13.6</a>. If you’re thinking this is too easy, you’re wrong!</p>&#13;
<div data-type="example" id="javacook-netserver-EX-9">&#13;
<h5><span class="label">Example 13-10. </span>main/src/main/java/network/JSSEWebServer0</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * JSSEWebServer - subclass trivial WebServer0 to make it use SSL.</code>&#13;
<code class="cm"> * N.B. You MUST have set up a server certificate (see the</code>&#13;
<code class="cm"> * accompanying book text), or you will get the dreaded</code>&#13;
<code class="cm"> * javax.net.ssl.SSLHandshakeException: no cipher suites in common</code>&#13;
<code class="cm"> * (because without it JSSE can't use any of its built-in ciphers!).</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">JSSEWebServer0</code> <code class="kd">extends</code> <code class="n">WebServer0</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">HTTPS</code> <code class="o">=</code> <code class="mi">8443</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">System</code><code class="o">.</code><code class="na">getProperty</code><code class="o">(</code><code class="s">"javax.net.ssl.keyStore"</code><code class="o">)</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
                <code class="s">"You must pass in a keystore via -D; see the documentation!"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"DarwinSys JSSE Server 0.0 starting..."</code><code class="o">);</code>&#13;
        <code class="n">JSSEWebServer0</code> <code class="n">w</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JSSEWebServer0</code><code class="o">();</code>&#13;
        <code class="n">w</code><code class="o">.</code><code class="na">runServer</code><code class="o">(</code><code class="n">HTTPS</code><code class="o">);</code>        <code class="c1">// never returns!!</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Get an HTTPS ServerSocket using JSSE.</code>&#13;
<code class="cm">     * @see WebServer0#getServerSocket(int)</code>&#13;
<code class="cm">     * @throws ClassNotFoundException the SecurityProvider can't be instantiated.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="n">ServerSocket</code> <code class="nf">getServerSocket</code><code class="o">(</code><code class="kt">int</code> <code class="n">port</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">SSLServerSocketFactory</code> <code class="n">ssf</code> <code class="o">=</code>&#13;
            <code class="o">(</code><code class="n">SSLServerSocketFactory</code><code class="o">)</code><code class="n">SSLServerSocketFactory</code><code class="o">.</code><code class="na">getDefault</code><code class="o">();</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">ssf</code><code class="o">.</code><code class="na">createServerSocket</code><code class="o">(</code><code class="n">port</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>That is, indeed, all the Java code one needs to write. You do have to set up an SSL&#13;
Certificate. For demonstration purposes, this can be a self-signed  certificate; the steps&#13;
in <a href="https://darwinsys.com/java/selfsigncert.html"><em class="hyperlink">https://darwinsys.com/java/selfsigncert.html</em></a> (steps 1–4) will suffice.&#13;
You have to tell the JSSE layer where to find your keystore:</p>&#13;
<pre data-type="programlisting" id="I_17_tt505"><strong>java -Djavax.net.ssl.keyStore=/home/ian/.keystore -Djavax.net.ssl.</strong>&#13;
<strong>keyStorePassword=secrit JSSEWebServer0</strong></pre>&#13;
&#13;
<p>The typical client browser raises its eyebrows at a self-signed certificate (see <a data-type="xref" href="#javacook-netserver-FIG-1">Figure 13-1</a>), but, if the user okays it, will accept the certificate.</p>&#13;
&#13;
<p><a data-type="xref" href="#javacook-netserver-FIG-2">Figure 13-2</a> shows the output of the simple <code>WebServer0</code> being displayed&#13;
over the HTTPS protocol (notice the padlock in the lower-right corner).</p>&#13;
&#13;
<figure><div class="figure" id="javacook-netserver-FIG-1">&#13;
<img alt="jcb4 1301" src="assets/jcb4_1301.png"/>&#13;
<h6><span class="label">Figure 13-1. </span>Browser caution</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="javacook-netserver-FIG-2">&#13;
<img alt="jcb4 1302" src="assets/jcb4_1302.png"/>&#13;
<h6><span class="label">Figure 13-2. </span>With encryption</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-6.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>JSSE can do much more than encrypt web server traffic; this is, however, sometimes seen as&#13;
its most exciting application. For more information on JSSE, see <a href="http://java.sun.com/products/jsse">the Sun website</a> or<a data-primary="Java Security (Oaks)" data-type="indexterm" id="idm45290638940648"/><a data-primary="Oaks, Scott" data-secondary="Java Security" data-type="indexterm" id="idm45290638939912"/> <em><a class="orm:hideurl" href="http://shop.oreilly.com/product/9780596001575.do">Java Security</a></em> by Scott Oaks (O’Reilly).<a data-primary="" data-startref="soc_ssl" data-type="indexterm" id="idm45290638937624"/><a data-primary="" data-startref="ssl_ab" data-type="indexterm" id="idm45290638936680"/><a data-primary="" data-startref="jsse_ab" data-type="indexterm" id="idm45290638935736"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.8 Creating a REST Service with JAX-RS" data-type="sect1"><div class="sect1" id="javacook-netserver-REST">&#13;
<h1>13.8 Creating a REST Service with JAX-RS</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45290638933240">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="JAX-RS" data-type="indexterm" id="jax_ab"/><a data-primary="REST web services" data-type="indexterm" id="rest_ab"/><a data-primary="sockets" data-secondary="JAX-RS" data-type="indexterm" id="soc_jax"/>You want to implement a RESTful server by using the provided Java EE/Jakarta EE APIs.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45290638928520">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use JAX-RS annotations on a class that provides a service; install it in an enterprise application server.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45290638926840">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This operation consists of both coding and configuration.</p>&#13;
&#13;
<p>The coding steps consist of creating a class that extends the JAX-RS <code>Application</code> class&#13;
and adding annotations to a class that provides a service.</p>&#13;
&#13;
<p>Here is a minimal <code>Application</code> class:</p>&#13;
&#13;
<pre data-type="programlisting">import javax.ws.rs.ApplicationPath;&#13;
import javax.ws.rs.core.Application;&#13;
&#13;
@ApplicationPath("")&#13;
public class RestApplication extends Application {&#13;
	// Empty&#13;
}</pre>&#13;
&#13;
<p><a data-type="xref" href="#javacook-netserver-EX-REST">Example 13-11</a> is a “Hello, World"–type service class with the annotations&#13;
needed to make it a service class and to have three sample methods.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-REST">&#13;
<h5><span class="label">Example 13-11. </span>restdemo/src/main/java/rest/RestService.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Path</code><code class="o">(</code><code class="s">""</code><code class="o">)</code>&#13;
<code class="nd">@ApplicationScoped</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">RestService</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">RestService</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"RestService.init()"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@GET</code> <code class="nd">@Path</code><code class="o">(</code><code class="s">"/timestamp"</code><code class="o">)</code>&#13;
    <code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getDate</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">LocalDateTime</code><code class="o">.</code><code class="na">now</code><code class="o">().</code><code class="na">toString</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** A Hello message method</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="nd">@GET</code> <code class="nd">@Path</code><code class="o">(</code><code class="s">"/greeting/{userName}"</code><code class="o">)</code>&#13;
    <code class="nd">@Produces</code><code class="o">(</code><code class="s">"text/html"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">doGreeting</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"userName"</code><code class="o">)</code><code class="n">String</code> <code class="n">userName</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"RestService.greeting()"</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">userName</code> <code class="o">==</code> <code class="kc">null</code> <code class="o">||</code> <code class="n">userName</code><code class="o">.</code><code class="na">trim</code><code class="o">().</code><code class="na">length</code><code class="o">()</code> <code class="o">&lt;=</code> <code class="mi">3</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="s">"Missing or too-short username"</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">return</code> <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code>&#13;
            <code class="s">"&lt;h1&gt;Welcome %s&lt;/h1&gt;&lt;p&gt;%s, We are glad to see you back!"</code><code class="o">,</code>&#13;
            <code class="n">userName</code><code class="o">,</code> <code class="n">userName</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Used to download all items */</code>&#13;
    <code class="nd">@GET</code> <code class="nd">@Path</code><code class="o">(</code><code class="s">"/names"</code><code class="o">)</code>&#13;
    <code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">findTasksForUser</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"Robin"</code><code class="o">,</code> <code class="s">"Jedunkat"</code><code class="o">,</code> <code class="s">"Lyn"</code><code class="o">,</code> <code class="s">"Glen"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Now the class must be deployed. If we have created a proper Maven project structure (see <a data-type="xref" href="ch01.html#javacook-getstarted-maven">Recipe 1.7</a>)&#13;
and have provided an application-server-specific Maven plug-in, and our development server is running,&#13;
we can use some variation on <code>mvn deploy</code>.&#13;
In the present case I have set this up, in the <em>rest</em> subdirectory, for deployment to WildFly, a Java Enterprise server from the JBoss open source community (though somewhat dated), funded by RedHat Inc.&#13;
I need only say <code>mvn wildfly:deploy</code> to have the application compiled, packaged,&#13;
and deployed to my server.</p>&#13;
&#13;
<p>For deploying REST services as a microservice based on Eclipse MicroProfile,&#13;
you may wish to investigate the <a href="https://quarkus.io">Quarkus Framework</a>.</p>&#13;
&#13;
<p>Once the service is deployed, you can explore it interactively with a browser or,&#13;
for simple GET requests, a Telnet client:</p>&#13;
&#13;
<pre data-type="programlisting">$ telnet localhost 8080 # output cleaned up&#13;
Escape character is '^]'.&#13;
GET /rest/timestamp HTTP/1.0&#13;
Connection: keep-alive&#13;
&#13;
HTTP/1.1 200 OK&#13;
Content-Type: text/plain;charset=UTF-8&#13;
&#13;
2019-10-16T19:54:31.42&#13;
&#13;
GET /rest/greeting/Ian%20Darwin HTTP/1.0&#13;
&#13;
HTTP/1.1 200 OK&#13;
Content-Type: text/html;charset=UTF-8&#13;
&#13;
&lt;h1&gt;Welcome Ian Darwin&lt;/h1&gt;&lt;p&gt;Ian Darwin, We are glad to see you back!&#13;
&#13;
get /rest/names HTTP/1.0&#13;
Accept: Application/JSON&#13;
&#13;
HTTP/1.1 200 OK&#13;
Content-Type: application/json&#13;
&#13;
["Robin","Jedunkat","Lyn","Glen"]&#13;
^] (CTRL/C)&#13;
$</pre>&#13;
&#13;
<p>An issue with REST is that there is not an official standard&#13;
for documenting&#13;
the API or protocol offered by a server&#13;
(there are several competing specifications).&#13;
So people writing clients must either rely on plain documentation&#13;
offered by the server’s developers, or use trial and error to discover the&#13;
protocol. Our example here is simple enough that we don’t have this problem,&#13;
but imagine a class with 20 or 30 methods in it.</p>&#13;
&#13;
<p>The <a data-primary="Spring Framework" data-type="indexterm" id="idm45290638580952"/>Spring Framework offers an API that is very similar to the JAX-RS API used here;&#13;
if you are already using Spring, it may be simpler to use their annotations.<a data-primary="" data-startref="jax_ab" data-type="indexterm" id="idm45290638579912"/><a data-primary="" data-startref="rest_ab" data-type="indexterm" id="idm45290638578968"/><a data-primary="" data-startref="soc_jax" data-type="indexterm" id="idm45290638578024"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.9 Network Logging" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-7">&#13;
<h1>13.9 Network Logging</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-7.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="sockets" data-secondary="logging" data-type="indexterm" id="idm45290638574168"/><a data-primary="logging" data-type="indexterm" id="idm45290638573192"/><a data-primary="networking" data-secondary="log4j, logging with" data-type="indexterm" id="idm45290638572520"/><a data-primary="log4j" data-type="indexterm" id="idm45290638571576"/>Your class is running inside a server container, and its debugging output is hard to obtain.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-7.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a network-based logger like the Java Logging API (JUL), the Apache Logging Services Project’s <code>Log4j</code>, or the simple one shown here.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-7.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Getting the debug output from a desktop client is fairly easy on most operating systems. But if the program you want to debug is running in a container like a servlet engine or an EJB server, it can be difficult to obtain debugging output, particularly if the container is running on a remote computer. It would be convenient if you could have your program send messages back to a program on your desktop machine for immediate display. Needless to say, it’s not that hard to do this with Java’s socket mechanism.</p>&#13;
&#13;
<p>Many logging APIs can handle this:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Java has had for years a standard logging API JUL (discussed in <a data-type="xref" href="#javacook-netserver-SECT-9">Recipe 13.12</a>) that talks to various logging mechanisms, including Unix <code>syslog</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Apache Logging Services Project" data-type="indexterm" id="idm45290638561912"/>The Apache Logging Services Project produces <code>Log4j</code>, which is used in many open source projects that require logging (see <a data-type="xref" href="#javacook-netserver-SECT-8">Recipe 13.11</a>).</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Apache Jakarta Commons Logging (JCL)" data-type="indexterm" id="idm45290638559096"/><a href="http://commons.apache.org/proper/commons-logging">The Apache Jakart Commons Logging (JCL)</a>. Not discussed here; similar to the others.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Simple Logging Facade for Java (SLF4J)" data-type="indexterm" id="idm45290638556920"/><a data-primary="SLF4J (Simple Logging Facade For Java)" data-type="indexterm" id="idm45290638556152"/>SLF4J (Simple Logging Facade For Java, see <a data-type="xref" href="#javacook-netserver-slf4j">Recipe 13.10</a>) is the newest and,&#13;
as the name implies, a facade that can use the others.</p>&#13;
</li>&#13;
<li>&#13;
<p>And, before these became widely used, I wrote a small, simple API to handle this type of logging function.&#13;
My <code>netlog</code> is not discussed here because it is preferable to use one of the standard logging mechanisms;&#13;
its code is in the <em>logging</em> subdirectory of the <em>javasrc</em> repo if you want to exhume it.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The JDK logging API,  <code>Log4j</code>, and <code>SFL4J</code> are more fully fleshed out and can write to such destinations as a file; an <code>OutputStream</code> or <code>Writer</code>; or a remote <code>Log4j</code>, Unix <code>syslog</code>, or Windows Event Log server.</p>&#13;
&#13;
<p>The program being debugged is the client from the logging API’s point of view—even though it may be running in a server-side container such as a web server or <span class="keep-together">application</span> server—because the network client is the program that initiates the connection. The program that runs on your desktop machine is the “server” program for sockets because it waits for a connection to come along.</p>&#13;
&#13;
<p>If you want to run any network-based logger reachable from any public network,&#13;
you need to be more aware of security issues.&#13;
One common form of attack is a simple denial-of-service (DoS), during which the attacker makes a&#13;
lot of connections to your server in order to slow it down.  If you are writing the log to disk,&#13;
for example, the attacker could fill up your disk by sending lots of garbage.&#13;
In common use, your log listener would be behind a firewall and not reachable from outside;&#13;
but if this is not the case, beware of the DoS attack.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.10 Setting Up SLF4J" data-type="sect1"><div class="sect1" id="javacook-netserver-slf4j">&#13;
<h1>13.10 Setting Up SLF4J</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-slf4j.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Simple Logging Facade for Java (SLF4J)" data-type="indexterm" id="simp_slf"/><a data-primary="SLF4J (Simple Logging Facade For Java)" data-type="indexterm" id="slf_ab"/><a data-primary="sockets" data-secondary="SLF4J" data-type="indexterm" id="soc_slf"/>You want to use a logging API that lets you use any of the other logging APIs,&#13;
for example, so that your code can be used in other projects without requiring them&#13;
to switch logging APIs.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-slf4j.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use SLF4J: get a <code>Logger</code> from the <code>LoggerFactory</code>, and use its various methods for logging.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-slf4j.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Using SLF4J requires only one JAR file to compile, <em>slf4j-api-1.x.y.jar</em> (where <em>x</em> and <em>y</em> will change&#13;
over time). To actually get logging output, you need to add one of several implementation JARs to your runtime&#13;
<code>CLASSPATH</code>, the simplest of which is <em>slf4j-simple-1.x.y.jar</em> (where <em>x</em> and <em>y</em> should match between&#13;
the two files).</p>&#13;
&#13;
<p>Once you’ve added those JAR files to your build script or on your <code>CLASSPATH</code>, you can&#13;
get a <code>Logger</code> by calling <code>LoggerFactory.getLogger()</code>, passing either the string name of&#13;
a class or package or just the current <code>Class</code> reference. Then call the logger’s logging methods.&#13;
A simple example is in <a data-type="xref" href="#javacook-netserver-slf4j-ex1">Example 13-12</a>.</p>&#13;
<div data-type="example" id="javacook-netserver-slf4j-ex1">&#13;
<h5><span class="label">Example 13-12. </span>main/src/main/java/logging/Slf4jDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Slf4jDemo</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">final</code> <code class="kd">static</code> <code class="n">Logger</code> <code class="n">theLogger</code> <code class="o">=</code>&#13;
            <code class="n">LoggerFactory</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">Slf4jDemo</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Object</code><code class="o">();</code>&#13;
        <code class="n">theLogger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I created this object: "</code> <code class="o">+</code> <code class="n">o</code><code class="o">);</code>&#13;
&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>There are various methods used to log information at different levels of severity,&#13;
which are shown in <a data-type="xref" href="#javacook-netserver-TABLE-0">Table 13-1</a>.</p>&#13;
<table id="javacook-netserver-TABLE-0">&#13;
<caption><span class="label">Table 13-1. </span>SLF4j logging methods</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Meaning</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>trace</p></td>&#13;
<td><p>Verbose debugging (disabled by default)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>debug</p></td>&#13;
<td><p>Verbose debugging</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>info</p></td>&#13;
<td><p>Low-level informational message</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>warn</p></td>&#13;
<td><p>Possible error</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>error</p></td>&#13;
<td><p>Serious error</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>One of the advantages of SLF4j over most of the other logging APIs is the avoidance of the&#13;
dead string anti-pattern. In the use of many other logger APIs you may find code like the following:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">logger</code><code class="o">.</code><code class="na">log</code><code class="o">(</code><code class="s">"The value is "</code> <code class="o">+</code> <code class="n">object</code> <code class="o">+</code> <code class="s">"; this is not good"</code><code class="o">);</code></pre>&#13;
&#13;
<p>This can lead to a performance problem, in that the object’s <a data-primary="toString() method" data-type="indexterm" id="idm45290638477800"/><code>toString()</code> is implicitly called,&#13;
and two string concatenations are performed, before we even know if the logger is going to use them!&#13;
If this is in code that is called repeatedly, a lot of overhead can be wasted.</p>&#13;
&#13;
<p>This led the other logging packages to offer code guards, based on logger methods that can&#13;
find out very quickly if a logger is enabled, leading to code like the following:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">if</code> <code class="o">(</code><code class="n">logger</code><code class="o">.</code><code class="na">isEnabled</code><code class="o">())</code> <code class="o">{</code>&#13;
	<code class="n">logger</code><code class="o">.</code><code class="na">log</code><code class="o">(</code><code class="s">"The value is "</code> <code class="o">+</code> <code class="n">object</code> <code class="o">+</code> <code class="s">"; this is not good"</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This solves the performance problem but clutters the code! SLF4J’s solution is to&#13;
use a mechanism similar to (but not quite compatible with) Java’s <code>MessageFormat</code> mechanism,&#13;
as shown in <a data-type="xref" href="#javacook-netserver-slf4j-ex1-ch16">Example 13-13</a>.</p>&#13;
<div data-type="example" id="javacook-netserver-slf4j-ex1-ch16">&#13;
<h5><span class="label">Example 13-13. </span>main/src/main/java/logging/Slf4jDemo2.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Slf4jDemo2</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">final</code> <code class="kd">static</code> <code class="n">Logger</code> <code class="n">theLogger</code> <code class="o">=</code> <code class="n">LoggerFactory</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">Slf4jDemo2</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Person</code> <code class="n">p</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Person</code><code class="o">();</code>&#13;
            <code class="c1">// populate person's fields here...</code>&#13;
            <code class="n">theLogger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I created an object {}"</code><code class="o">,</code> <code class="n">p</code><code class="o">);</code>&#13;
&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">p</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>    <code class="c1">// bogus, just to show logging</code>&#13;
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code><code class="s">"Just testing"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">theLogger</code><code class="o">.</code><code class="na">error</code><code class="o">(</code><code class="s">"Caught Exception: "</code> <code class="o">+</code> <code class="n">ex</code><code class="o">,</code> <code class="n">ex</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Although this doesn’t demonstrate network logging, it is easy to accomplish that in conjunction with&#13;
a logging implementation like Log4j or JUL (Java Util Logging, a standard part of the JDK),&#13;
which allow you to provide configurable logging.&#13;
<code>Log4j</code> is described in the next recipe.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45290638536168">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>The SLF4J website contains a <a href="http://www.slf4j.org/manual.html">manual</a> that discusses the various <code>CLASSPATH</code> options. There are also some <a href="http://mvnrepository.com/artifact/org.slf4j">Maven artifacts</a> for the various options.<a data-primary="" data-startref="simp_slf" data-type="indexterm" id="idm45290638175064"/><a data-primary="" data-startref="slf_ab" data-type="indexterm" id="idm45290638174088"/><a data-primary="" data-startref="soc_slf" data-type="indexterm" id="idm45290638173144"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.11 Network Logging with Log4j" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-8">&#13;
<h1>13.11 Network Logging with Log4j</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-8.1-ch16">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="log4j" data-type="indexterm" id="log_ab"/><a data-primary="logging" data-type="indexterm" id="logg_ab"/><a data-primary="networking" data-secondary="log4j, logging with" data-type="indexterm" id="net_log"/><a data-primary="sockets" data-secondary="log4j" data-type="indexterm" id="soc_log"/>You wish to write log file messages using Log4j.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-8.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Get a <code>Logger</code> and use its <a data-primary="log() method" data-type="indexterm" id="idm45290638162200"/><code>log()</code> method or the convenience methods. Control logging by changing a properties file. Use the <code>org.apache.logging.log4j.net</code> package to make it network based.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-8.3">&#13;
<h2>Discussion</h2>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>This recipe describes Version 2 of the Log4j API.  Between Version 1 and&#13;
Version 2, there are changes to the package names, filenames, and the&#13;
method used to obtain a logger. If you see code using, for example,&#13;
<code>Logger.getLogger("class name")</code>, that code is written to the older API,&#13;
which is no longer maintained&#13;
(the Log4j website refers to Log4j 1.2, and versions up to 2.12, as “legacy”;&#13;
we are using 2.13 in this recipe).&#13;
A good degree of compatibility is offered for code written to the 1.x API;&#13;
see <a href="https://logging.apache.org/log4j/2.x/manual/compatibility.html"><em class="hyperlink">https://logging.apache.org/log4j/2.x/manual/compatibility.html</em></a>.</p>&#13;
</div>&#13;
&#13;
<p>Logging using Log4j is simple, convenient, and flexible. You need to get a <code>Logger</code>&#13;
object from the static method <code>LogManager.getLogger()</code>,&#13;
The <code>Logger</code> has public void methods<a data-primary="debug() method" data-type="indexterm" id="idm45290638153160"/><a data-primary="error() method" data-type="indexterm" id="idm45290638152456"/><a data-primary="info() method (logging)" data-type="indexterm" id="idm45290638151784"/><a data-primary="warn() method" data-type="indexterm" id="idm45290638151112"/><a data-primary="fatal() method (logging)" data-type="indexterm" id="idm45290638150440"/> (<code>debug()</code>, <code>info()</code>, <code>warn()</code>, <code>error()</code>,&#13;
and <code>fatal()</code>), each of which takes one <code>Object</code> to be logged (and an optional <code>Throwable</code>). As with&#13;
<code>System.out.println()</code>, if you pass in anything that is not a <code>String</code>, its <a data-primary="toString() method" data-type="indexterm" id="idm45290638145560"/><code>toString()</code>&#13;
method is called. A generic logging method is also included:</p>&#13;
&#13;
<pre data-type="programlisting">public void log(Level level, Object message);</pre>&#13;
&#13;
<p>The <code>Level</code> class is defined in the Log4j 2 API. The standard levels are, in&#13;
order, <code>DEBUG</code> &lt; <code>INFO</code> &lt; <code>WARN</code> &lt; <code>ERROR</code> &lt; <code>FATAL</code>. That is, debug messages are considered&#13;
the least important, and fatal the most important. Each <code>Logger</code> has a level associated with&#13;
it; messages whose level is less than the <code>Logger</code>’s level are silently discarded.</p>&#13;
&#13;
<p>A simple application can log messages using these few statements:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Log4JDemo</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">Logger</code> <code class="n">myLogger</code> <code class="o">=</code> <code class="n">LogManager</code><code class="o">.</code><code class="na">getLogger</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Object</code><code class="o">();</code>&#13;
        <code class="n">myLogger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I created an object: "</code> <code class="o">+</code> <code class="n">o</code><code class="o">);</code>&#13;
&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>If you compile and run this program with no <em>log4j2.properties</em> file, it does not produce any logging output (see the <em>log4j2demos</em> script in the source folder).&#13;
We need to create a configuration file whose default name is <em>log4j2.properties</em>.&#13;
You can also provide the logfile name via System Properties: <code>-Dlog4j​.configurationFile=URL</code>.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Log4j configuration is very flexible, and therefore very complex.&#13;
Even their own documentation admits that&#13;
“Trying to configure Log4j without understanding [the logging architecture] will lead to frustration.”&#13;
See this <a href="https://logging.apache.org/log4j/2.x/manual/configuration.html">Apache website for&#13;
full details on the logging configuration file location and format</a>.</p>&#13;
</div>&#13;
&#13;
<p>Every <code>Logger</code> has a <code>Level</code> to specify what level of messages to write. It will also have an <code>Appender</code>, which is the code that writes the messages out. A <code>ConsoleAppender</code>  writes to <code>System.out</code>, of course; other loggers write to files, operating system–level loggers, and so on. A simple configuration file looks something like this:</p>&#13;
&#13;
<pre data-type="programlisting"># Log4J2 properties file for the logger demo programs.&#13;
# tag::generic[] # Ensure file gets copied for Java Cookbook&#13;
&#13;
# WARNING - log4j2.properties must be on your CLASSPATH,&#13;
# not necessarily in your source directory.&#13;
&#13;
# The configuration file for Version 2 is different from V1!&#13;
&#13;
rootLogger.level = info&#13;
rootLogger.appenderRef.stdout.ref = STDOUT&#13;
&#13;
appender.console.type = Console&#13;
appender.console.name = STDOUT&#13;
appender.console.layout.type = PatternLayout&#13;
appender.console.layout.pattern = %m%n&#13;
appender.console.filter.threshold.type = ThresholdFilter&#13;
appender.console.filter.threshold.level = debug</pre>&#13;
&#13;
<p>This file gives the root logger a level of <code>DEBUG</code>, which causes it to write all messages.&#13;
The config file also sets up an appender of <code>APPENDER1</code>, which is configured on the next few lines. Note that I didn’t have to refer to the <code>com.darwinsys Logger</code>.&#13;
Because every <code>Logger</code> inherits from the root logger, a simple application needs to configure only the root logger. The properties file can also be an XML document, or you can write your own configuration parser (almost nobody does this).</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If the logging configuration file is not found, the default root logger defaults&#13;
the root logger to <code>Level.ERROR</code>, so you will not see any output below the <code>ERROR</code> level.</p>&#13;
</div>&#13;
&#13;
<p>With the configuration file in place, the demonstration works better.&#13;
Running this program (with the appropriate <code>CLASSPATH</code> as done in the scripts) produces this <span class="keep-together">output:</span></p>&#13;
&#13;
<pre data-type="programlisting">$ java Log4j2Demo&#13;
I created an object: java.lang.Object@477b4cdf&#13;
$</pre>&#13;
&#13;
<p>A common use of logging is to log a caught <code>Exception</code>, as shown in <a data-type="xref" href="#javacook-netserver-EX-12">Example 13-14</a>.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-12">&#13;
<h5><span class="label">Example 13-14. </span>main/src/main/java/Log4JDemo2.java (Log4j—catching and logging)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Log4JDemo2</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">Logger</code> <code class="n">myLogger</code> <code class="o">=</code> <code class="n">LogManager</code><code class="o">.</code><code class="na">getLogger</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Object</code><code class="o">();</code>&#13;
            <code class="n">myLogger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I created an object: "</code> <code class="o">+</code> <code class="n">o</code><code class="o">);</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">o</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>    <code class="c1">// bogus, just to show logging</code>&#13;
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code><code class="s">"Just testing"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">myLogger</code><code class="o">.</code><code class="na">error</code><code class="o">(</code><code class="s">"Caught Exception: "</code> <code class="o">+</code> <code class="n">ex</code><code class="o">,</code> <code class="n">ex</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>When run, <code>Log4JDemo2</code> produces the expected output:</p>&#13;
&#13;
<pre data-type="programlisting">$ java Log4JDemo2&#13;
I created an object: java.lang.Object@477b4cdf&#13;
Caught Exception: java.lang.IllegalArgumentException: Just testing&#13;
java.lang.IllegalArgumentException: Just testing&#13;
	at logging.Log4JDemo2.main(Log4JDemo2.java:17) [classes/:?]&#13;
$</pre>&#13;
&#13;
<p>Much of the flexibility of Log4j 2 stems from its use of external configuration files; you can enable or disable logging without recompiling the application. A properties file that eliminates most logging might have this entry:</p>&#13;
&#13;
<pre data-type="programlisting">rootLogger.level = fatal</pre>&#13;
&#13;
<p>Only fatal error messages print; all levels less than that are ignored.</p>&#13;
&#13;
<p>To log from a client to a server on a remote machine, the <code>SocketAppender</code> can be used.&#13;
There is also an <code>SmtpAppender</code> to send urgent notices via email.&#13;
See <a href="https://logging.apache.org/log4j/2.x/manual/appenders.html"><em class="hyperlink">https://logging.apache.org/log4j/2.x/manual/appenders.html</em></a> for details&#13;
on all the supported Appenders.&#13;
Here is <em>log4j2-network.properties</em>, the socket-based networking version of the configuration file:</p>&#13;
&#13;
<pre data-type="programlisting"># Log4J2 properties file for the NETWORKED logger demo programs.&#13;
# tag::generic[] # Ensure file gets copied for Java Cookbook&#13;
&#13;
# WARNING - log4j2.properties must be on your CLASSPATH,&#13;
# not necessarily in your source directory.&#13;
&#13;
# The configuration file for Version 2 is different from V1!&#13;
&#13;
rootLogger.level = info&#13;
rootLogger.appenderRef.stdout.ref = STDOUT&#13;
&#13;
appender.console.type = Socket&#13;
appender.console.name = STDOUT&#13;
appender.console.host = localhost&#13;
appender.console.port = 6666&#13;
appender.console.layout.type = PatternLayout&#13;
appender.console.layout.pattern = %m%n&#13;
appender.console.filter.threshold.type = ThresholdFilter&#13;
appender.console.filter.threshold.level = debug</pre>&#13;
&#13;
<p>This file gets passed to the demo programs via a Java System Property in the <code>netdemos</code> script:</p>&#13;
&#13;
<pre data-type="programlisting">build=../../../../target/classes&#13;
log4j2_jar=\&#13;
${HOME}/.m2/repository/org/apache/logging/log4j/log4j-api/2.13.0/log4j-api-2.13.0.jar:\&#13;
${HOME}/.m2/repository/org/apache/logging/log4j/log4j-core/2.13.0/log4j-core-2.13.0.jar&#13;
&#13;
echo "==&gt; Log4JDemo"&#13;
java -Dlog4j.configurationFile=log4j2-network.properties \&#13;
	-classpath ".:${build}:${log4j2_jar}" logging.Log4JDemo&#13;
&#13;
echo "==&gt; Log4JDemo2"&#13;
java -Dlog4j.configurationFile=log4j2-network.properties \&#13;
	-classpath ".:${build}:${log4j2_jar}" logging.Log4JDemo2</pre>&#13;
&#13;
<p>When run with the <em>log4j2-network.properties</em> file, you have to arrange for a listener on the other end.&#13;
On Unix systems the <code>nc</code> (or <code>netcat</code>) program will work fine:</p>&#13;
&#13;
<pre data-type="programlisting">$ nc -kl 6666&#13;
I created an object: java.lang.Object@37ceb1df&#13;
I created an object: java.lang.Object@37ceb1df&#13;
Caught Exception: java.lang.IllegalArgumentException: Just testing&#13;
java.lang.IllegalArgumentException: Just testing&#13;
	at logging.Log4JDemo2.main(Log4JDemo2.java:17) [classes/:?]&#13;
^C&#13;
$</pre>&#13;
&#13;
<p><code>Netcat</code> option <code>-l</code> says to listen on the numbered port; <code>-k</code> tells it to keep listening,&#13;
that is, to reopen the connection when the client closes it, as happens when each&#13;
demo program exits.</p>&#13;
&#13;
<p>There is a performance issue with some logging calls. Consider some expensive operation, like a&#13;
<a data-primary="toString() method" data-type="indexterm" id="idm45290637898600"/><code>toString()</code> or two along with several string concatenations passed to a <code>Log.info()</code> call&#13;
in an often-used piece of code.&#13;
If this is placed into production with a higher logging level, all the work will be done&#13;
but the resultant string will never be used.&#13;
In older APIs we used to use “code guards,” methods like “isLoggerEnabled(Level),”&#13;
to determine whether to bother creating the string. Nowadays, the preferred method is to create&#13;
the string inside a lambda expression (see <a data-type="xref" href="ch09.html#javacook-fp">Chapter 9</a>).&#13;
All the log methods have an overload that accepts a <code>Supplier</code> argument (<a data-type="xref" href="#javacook-network-SECT8-log4jlambda">Example 13-15</a>).</p>&#13;
<div data-type="example" id="javacook-network-SECT8-log4jlambda">&#13;
<h5><span class="label">Example 13-15. </span>main/src/main/java/logging/Log4J2Lambda.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Log4JLambda</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">Logger</code> <code class="n">myLogger</code> <code class="o">=</code> <code class="n">LogManager</code><code class="o">.</code><code class="na">getLogger</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Person</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">getPerson</code><code class="o">();</code>&#13;
        <code class="n">myLogger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code> <code class="o">()</code> <code class="o">-&gt;</code> <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code>&#13;
            <code class="s">"Value %d from Customer %s"</code><code class="o">,</code> <code class="n">customer</code><code class="o">.</code><code class="na">value</code><code class="o">,</code> <code class="n">customer</code><code class="o">)</code> <code class="o">);</code>&#13;
&#13;
    <code class="o">}</code></pre></div>&#13;
&#13;
<p>This way the string operations will only be performed if needed: if the logger is operating&#13;
at the <code>INFO</code> level it will call the <code>Supplier</code> and if not, it won’t do the expensive operation.</p>&#13;
&#13;
<p>When run as part of the <em>log4j2demos</em> script, this prints:</p>&#13;
&#13;
<pre data-type="programlisting">Value 42 from Customer Customer[Robin]</pre>&#13;
&#13;
<p>For more information on Log4j, visit its <a href="http://logging.apache.org/log4j">main website</a>.&#13;
Log4j 2 is free software, distributed under the Apache Software Foundation license.  <a data-primary="" data-startref="log_ab" data-type="indexterm" id="idm45290637807592"/><a data-primary="" data-startref="logg_ab" data-type="indexterm" id="idm45290637806616"/><a data-primary="" data-startref="net_log" data-type="indexterm" id="idm45290637805672"/><a data-primary="" data-startref="soc_log" data-type="indexterm" id="idm45290637804728"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="13.12 Network Logging with java.util.logging" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-9">&#13;
<h1>13.12 Network Logging with java.util.logging</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-9.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="java.util.logging" data-type="indexterm" id="java_util"/><a data-primary="networking" data-secondary="java.util.logging and" data-type="indexterm" id="net_util"/><a data-primary="sockets" data-secondary="java.util.logging and" data-type="indexterm" id="soc_util"/>You wish to write logging messages using the Java logging mechanism.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-9.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Get a <code>Logger</code>, and use it to log your messages and/or exceptions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-9.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The Java Logging API (package <code>java.util.logging</code>) is similar to, and was obviously inspired by, the Log4j package. You acquire a <code>Logger</code> object by calling the static <span class="keep-together"><code>Logger.getLogger()</code></span> with a descriptive <code>String</code>. You then use instance methods to write to the log; these methods include the following:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">log</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">LogRecord</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">log</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Level</code><code class="o">,</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="c1">// and a variety of overloaded log(  ) methods</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">logp</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Level</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">logrb</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Level</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">);</code>&#13;
&#13;
<code class="c1">// Convenience routines for tracing program flow</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">entering</code><code class="o">(</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">entering</code><code class="o">(</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">Object</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">entering</code><code class="o">(</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">Object</code><code class="o">[]);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">exiting</code><code class="o">(</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">exiting</code><code class="o">(</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">Object</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">throwing</code><code class="o">(</code><code class="n">String</code><code class="o">,</code><code class="n">String</code><code class="o">,</code><code class="n">Throwable</code><code class="o">);</code>&#13;
&#13;
<code class="c1">// Convenience routines for log(  ) with a given level</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">severe</code><code class="o">(</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">warning</code><code class="o">(</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">info</code><code class="o">(</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">config</code><code class="o">(</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">fine</code><code class="o">(</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">finer</code><code class="o">(</code><code class="n">String</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">finest</code><code class="o">(</code><code class="n">String</code><code class="o">);</code></pre>&#13;
&#13;
<p>As with Log4j, every <code>Logger</code> object has a given logging level, and messages below that level are silently discarded:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">setLevel</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Level</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Level</code> <code class="nf">getLevel</code><code class="o">(</code>  <code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">isLoggable</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Level</code><code class="o">);</code></pre>&#13;
&#13;
<p>As with Log4j, objects handle the writing of the log. Each logger has a <code>Handler</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">synchronized</code> <code class="kt">void</code> <code class="nf">addHandler</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Handler</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kd">synchronized</code> <code class="kt">void</code> <code class="nf">removeHandler</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Handler</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="kd">synchronized</code> <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">logging</code><code class="o">.</code><code class="na">Handler</code><code class="o">[]</code> <code class="nf">getHandlers</code><code class="o">(</code>  <code class="o">);</code></pre>&#13;
&#13;
<p>Each <code>Handler</code> has a <code>Formatter</code>, which formats a <code>LogRecord</code>  for display. By providing your own <code>Formatter</code>, you have more control over how the information being passed into the log gets formatted.</p>&#13;
&#13;
<p>Unlike Log4j, the Java SE logging mechanism has a default configuration, so <a data-type="xref" href="#jullogdemojava">Example 13-16</a> is a minimal logging example program.</p>&#13;
<div data-type="example" id="jullogdemojava">&#13;
<h5><span class="label">Example 13-16. </span>main/src/main/java/logging/JulLogDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">JulLogDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Logger</code> <code class="n">myLogger</code> <code class="o">=</code> <code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="s">"com.darwinsys"</code><code class="o">);</code>&#13;
&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Object</code><code class="o">();</code>&#13;
        <code class="n">myLogger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I created an object: "</code> <code class="o">+</code> <code class="n">o</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Running it prints the following:</p>&#13;
<pre data-type="programlisting" id="I_17_tt519">$ <strong>juldemos</strong>&#13;
Jan 31, 2020 1:03:27 PM logging.JulLogDemo main&#13;
INFO: I created an object: java.lang.Object@5ca881b5&#13;
$ </pre>&#13;
&#13;
<p>As with Log4j, one common use is in logging caught exceptions; the code for this is in <a data-type="xref" href="#javacook-netserver-EX-13">Example 13-17</a>.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-13">&#13;
<h5><span class="label">Example 13-17. </span>main/src/main/java/logging/JulLogDemo2.java (catching and logging an exception)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">JulLogDemo2</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">setProperty</code><code class="o">(</code><code class="s">"java.util.logging.config.file"</code><code class="o">,</code>&#13;
            <code class="s">"logging/logging.properties"</code><code class="o">);</code>&#13;
&#13;
        <code class="n">Logger</code> <code class="n">logger</code> <code class="o">=</code> <code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="s">"com.darwinsys"</code><code class="o">);</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Object</code><code class="o">();</code>&#13;
            <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I created an object: "</code> <code class="o">+</code> <code class="n">o</code><code class="o">);</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">o</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>    <code class="c1">// bogus, just to show logging</code>&#13;
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code><code class="s">"Just testing"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">t</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// All-in-one call:</code>&#13;
            <code class="n">logger</code><code class="o">.</code><code class="na">log</code><code class="o">(</code><code class="n">Level</code><code class="o">.</code><code class="na">SEVERE</code><code class="o">,</code> <code class="s">"Caught Exception"</code><code class="o">,</code> <code class="n">t</code><code class="o">);</code>&#13;
            <code class="c1">// Alternate: Long form, more control.</code>&#13;
            <code class="c1">// LogRecord msg = new LogRecord(Level.SEVERE, "Caught exception");</code>&#13;
            <code class="c1">// msg.setThrown(t);</code>&#13;
            <code class="c1">// logger.log(msg);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>As with Log4j, <code>java.util.logging</code> accepts a lambda expression (and has since Java 8); see <a data-type="xref" href="#javacook-network-sect8-jullambda">Example 13-18</a>.</p>&#13;
<div data-type="example" id="javacook-network-sect8-jullambda">&#13;
<h5><span class="label">Example 13-18. </span>main/src/main/java/logging/JulLambdaDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/** Demonstrate how Java 8 Lambdas avoid extraneous object creation</code>&#13;
<code class="cm"> * @author Ian Darwin</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">JulLambdaDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Logger</code> <code class="n">myLogger</code> <code class="o">=</code> <code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="s">"com.darwinsys.jullambda"</code><code class="o">);</code>&#13;
&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Helper</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// If you change the log call from finest to info,</code>&#13;
        <code class="c1">// you see both the systrace from the toString,</code>&#13;
        <code class="c1">// and the logging output. As it is here,</code>&#13;
        <code class="c1">// you don't see either, so the toString() is not called!</code>&#13;
        <code class="n">myLogger</code><code class="o">.</code><code class="na">finest</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="s">"I created this object: "</code> <code class="o">+</code> <code class="n">o</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">static</code> <code class="kd">class</code> <code class="nc">Helper</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"JulLambdaDemo.Helper.toString()"</code><code class="o">);</code>&#13;
            <code class="k">return</code> <code class="s">"failure!"</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-11.1">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>A good general reference on this chapter’s topic is <a data-primary="Java Network Programming (Harold)" data-type="indexterm" id="idm45290637138952"/><a data-primary="Harold, Elliotte" data-secondary="Java Network Programming" data-type="indexterm" id="idm45290637138264"/><em><a class="orm:hideurl" href="http://oreil.ly/java-network-prgamming">Java Network Programming</a></em> by Elliotte Harold.</p>&#13;
&#13;
<p>The server side of any network mechanism is  extremely sensitive to  security issues. It is easy for one misconfigured or poorly written server program to compromise the security of an entire network! Of the many books on network security, two stand out:<a data-primary="Firewalls and Internet Security (Cheswick)" data-type="indexterm" id="idm45290637108104"/><a data-primary="Cheswick, William R." data-secondary="Firewalls and Internet Security" data-type="indexterm" id="idm45290637107368"/> <em>Firewalls and Internet Security</em> by William R. Cheswick et al. (Addison-Wesley) and a series of books with<a data-primary="Hacking Exposed (McClure)" data-type="indexterm" id="idm45290637105864"/><a data-primary="McClure, Stuart" data-secondary="Hacking Exposed" data-type="indexterm" id="idm45290637105128"/> <em>Hacking Exposed</em> in the title, the first in the series by Stuart McClure et al. (McGraw-Hill).</p>&#13;
&#13;
<p>This completes my discussion of server-side Java using sockets. A chat server could be implemented using several technologies, such as RMI (Remote Methods Invocation), an HTTP web service, JMS (Java Message Service), and a Java Enterprise API that handles store-and-forward  message processing. This is beyond the scope of this book, but there’s an example of an RMI chat server in the <em>chat</em> folder of the source distribution, and there’s an example of a JMS chat server in <a data-primary="Java Message Service (Richards)" data-type="indexterm" id="idm45290637102312"/><a data-primary="Richards, Mark" data-secondary="Java Message Service" data-type="indexterm" id="idm45290637101640"/><em><a class="orm:hideurl" href="http://shop.oreilly.com/product/9780596522056.do">Java Message Service</a></em> by Mark Richards et al. (O’Reilly).<a data-primary="" data-startref="java_util" data-type="indexterm" id="idm45290637099576"/><a data-primary="" data-startref="net_util" data-type="indexterm" id="idm45290637098632"/><a data-primary="" data-startref="soc_util" data-type="indexterm" id="idm45290637097688"/><a data-primary="" data-startref="soc_ch" data-type="indexterm" id="idm45290637096744"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45290642028248"><sup><a href="ch13.html#idm45290642028248-marker">1</a></sup> You may not be able to pick just any port number for your own service, of course. Certain well-known port numbers are reserved for specific services and listed in your <em>services</em> file, such as 22 for Secure Shell and 25 for SMTP. Also, on server-based operating systems, ports below 1024 are considered privileged ports and require root or administrator privilege to create. This was an early security mechanism; today, with zillions of single-user desktops connected to the internet, it provides little real security, but the restriction remains.</p><p data-type="footnote" id="idm45290641414168"><sup><a href="ch13.html#idm45290641414168-marker">2</a></sup> Digital Equipment was absorbed by Compaq, which was then absorbed by HP, but the name remains <code>de</code> because the engineers who name such things don’t care for corporate mergers anyway.</p><p data-type="footnote" id="idm45290640666504"><sup><a href="ch13.html#idm45290640666504-marker">3</a></sup> There are some limits to how many threads you can have, which affect only very large, enterprise-scale servers. You can’t expect to have thousands of threads running in the standard Java runtime. For large, high-performance servers, you may wish to resort to native code (see <a data-type="xref" href="ch18.html#javacook-otherlang-SECT-5">Recipe 18.6</a>) using <code>select()</code> or <code>poll()</code>.</p></div></div></section></body></html>