<html><head></head><body><section data-pdf-bookmark="Chapter 14. Accumulating Objects to Transformations" data-type="chapter" epub:type="chapter"><div class="chapter" id="accumulating-objects-to-transformations">&#13;
<h1><span class="label">Chapter 14. </span>Accumulating Objects to Transformations</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Java programs usually rely heavily on mutable state because it is so arduous in Java to define value types and transform values, even with the Streams API.&#13;
What is the best way to translate Java code that relies upon mutable objects and side effects to Kotlin code that transforms immutable values?</p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Calculating with Accumulator Parameters" data-type="sect1"><div class="sect1" id="idm46393380201224">&#13;
<h1>Calculating with Accumulator Parameters</h1>&#13;
&#13;
<p>One<a data-primary="accumulating objects to transformations" data-secondary="calculating with accumulator parameters" data-type="indexterm" id="ACTcalc14"/><a data-primary="accumulator parameters" data-type="indexterm" id="accparam14"/> of the most important things our travelers want to know is how much their adventures will cost.&#13;
International travel makes this rather complicated.&#13;
A trip will incur costs in multiple currencies as it wends its way across borders, but the traveler wants to be able to compare overall costs to make decisions about routes and where to stay.&#13;
So Travelator summarizes costs by local currency <em>and</em> the traveler’s preferred currency, and then shows the overall total in the preferred currency.&#13;
It does this using the <code>CostSummary</code> and <code>CostSummaryCalculator</code> classes.&#13;
Let’s take a look at how they are used, and then we’ll look at their implementation.</p>&#13;
&#13;
<p>The <code>Itinerary</code> class has an operation for summarizing its costs with a <code>CostSummary​Cal⁠culator</code>.&#13;
It is used like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting" id="cost-summary-calculator-usage"><code class="k">val</code><code> </code><code class="py">fx</code><code class="p">:</code><code> </code><code class="n">ExchangeRates</code><code> </code><code class="p">=</code><code> </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code class="k">val</code><code> </code><code class="py">userCurrency</code><code> </code><code class="p">=</code><code> </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code class="k">val</code><code> </code><code class="py">calculator</code><code> </code><code class="p">=</code><code> </code><code class="n">CostSummaryCalculator</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">,</code><code> </code><code class="n">fx</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO22-1" id="co_introduction_CO22-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="k">fun</code><code> </code><code class="nf">costSummary</code><code class="p">(</code><code class="n">i</code><code class="p">:</code><code> </code><code class="n">Itinerary</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">CostSummary</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="n">i</code><code class="p">.</code><code class="n">addCostsTo</code><code class="p">(</code><code class="n">calculator</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO22-2" id="co_introduction_CO22-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">calculator</code><code class="p">.</code><code class="n">summarise</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO22-3" id="co_introduction_CO22-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.1&amp;show=file">Example 14.1 [accumulator.0:src/test/java/travelator/itinerary/Itinerary_CostTest.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO22-1" id="callout_introduction_CO22-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Here the code creates a <code>CostSummaryCalculator</code> with the traveler’s preferred currency and a source of currency exchange rates.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO22-2" id="callout_introduction_CO22-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This tells the <code>Itinerary</code> to add its costs to the calculator.  In response, the &#13;
<span class="keep-together"><code>Itinerary</code></span> adds the cost of its elements: the journeys along the route, accommodation, and other chargeable services.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO22-3" id="callout_introduction_CO22-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This calls the calculator’s <code>summarise</code> method to obtain the <code>CostSummary</code> after all the costs have been collected.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Someone has already converted the <code>Itinerary</code> class to Kotlin, but the implementations of <code>addCostsTo</code> still have a Java flavor:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Itinerary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">route</code><code class="p">:</code> <code class="n">Route</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">accommodations</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Accommodation</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="p">...</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addCostsTo</code><code class="p">(</code><code class="n">calculator</code><code class="p">:</code> <code class="n">CostSummaryCalculator</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">route</code><code class="p">.</code><code class="n">addCostsTo</code><code class="p">(</code><code class="n">calculator</code><code class="p">)</code>&#13;
        <code class="n">accommodations</code><code class="p">.</code><code class="n">addCostsTo</code><code class="p">(</code><code class="n">calculator</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">Iterable</code><code class="p">&lt;</code><code class="n">Accommodation</code><code class="p">&gt;.</code><code class="n">addCostsTo</code><code class="p">(</code><code class="n">calculator</code><code class="p">:</code> <code class="n">CostSummaryCalculator</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">forEach</code> <code class="p">{</code> <code class="n">a</code> <code class="p">-&gt;</code>&#13;
        <code class="n">a</code><code class="p">.</code><code class="n">addCostsTo</code><code class="p">(</code><code class="n">calculator</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.2&amp;show=file">Example 14.2 [accumulator.0:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The logic relies upon side effects to accumulate costs in the mutable state of the <code>CostSummaryCalculator</code>.</p>&#13;
&#13;
<p>The benefit of this design is that we can use the calculator to summarize the costs of any object in our domain model, without knowing the structure of that object.&#13;
The object is responsible for adding its costs to the calculator and passing the calculator to its children so that they can add <em>their</em> costs.&#13;
This decouples the code that needs the costs from the code that provides the costs, allowing us to evolve them independently.</p>&#13;
&#13;
<p>For example, a <code>Route</code> contains a list of <code>Journey</code>, each of which has a cost, and &#13;
<span class="keep-together"><code>Accommodation</code></span> has a room rate, a number of nights, and additional costs such as meals and hotel services.&#13;
The <code>Itinerary</code> doesn’t have to know or care how these objects are structured, or how to collect their respective costs.&#13;
That knowledge is encapsulated in the <code>Route</code> and <code>Accommodation</code> classes.</p>&#13;
&#13;
<p>However, our use of mutable state has two significant disadvantages.</p>&#13;
&#13;
<p>First, it<a data-primary="aliasing errors" data-type="indexterm" id="idm46393379948504"/> introduces the possibility of <a href="https://oreil.ly/PeqKs">aliasing errors</a>.&#13;
Aliasing errors create “spooky action at a distance” (as Einstein famously described quantum entanglement) that is not immediately obvious from the source code.&#13;
We saw an example in <a data-type="xref" href="ch06.html#java-to-kotlin-collections">Chapter 6</a>, when a function sorted a mutable list parameter and broke its caller.</p>&#13;
&#13;
<p>In the case of the <code>CostSummaryCalculator</code>, if we reuse a calculator to summarize the costs of multiple entities, we have to reset its state between each calculation.&#13;
If we do not reset the calculator state, costs collected during one calculation will be included in the next.&#13;
The type system cannot help us avoid this mistake.</p>&#13;
&#13;
<p>The example at the start of this chapter <em>may</em> make this error.&#13;
The calculator is not local to the <code>costSummary</code> method, and <code>costSummary</code> does not reset the calculator before each calculation.&#13;
We can’t tell whether this is a problem merely by looking at the <code>costSummary</code> method.&#13;
We have to understand how that method is used in its wider context, and as we make changes in that context, we have to make sure those changes do not break our assumptions about how the <code>costSummary</code> method is used.</p>&#13;
&#13;
<p>The second problem with mutable state is that it scatters the implementation of our algorithms across the code.&#13;
We’ll return to this later in this chapter.</p>&#13;
&#13;
<p>Before we look at <code>CostSummaryCalculator</code>, let’s have a look at the <code>CostSummary</code> that it computes.&#13;
It uses <code>CurrencyConversion</code> (thankfully already Kotlin):</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">CurrencyConversion</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">fromMoney</code><code class="p">:</code> <code class="n">Money</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">toMoney</code><code class="p">:</code> <code class="n">Money</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.3&amp;show=file">Example 14.3 [accumulator.0:src/main/java/travelator/money/CurrencyConversion.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>A <code>CostSummary</code> is a mutable<a data-primary="POJOs (plain old Java objects)" data-type="indexterm" id="idm46393379916808"/> POJO (as described in <a data-type="xref" href="ch05.html#beans-to-values">Chapter 5</a>) that holds a list of &#13;
<span class="keep-together"><code>CurrencyConversion</code></span>, from local currencies to the traveler’s preferred currency:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CostSummary</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">CurrencyConversion</code><code class="o">&gt;</code> <code class="n">lines</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>&#13;
    <code class="kd">private</code> <code class="n">Money</code> <code class="n">total</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">CostSummary</code><code class="o">(</code><code class="n">Currency</code> <code class="n">userCurrency</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">total</code> <code class="o">=</code> <code class="n">Money</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">userCurrency</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">addLine</code><code class="o">(</code><code class="n">CurrencyConversion</code> <code class="n">line</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">lines</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">line</code><code class="o">);</code>&#13;
        <code class="n">total</code> <code class="o">=</code> <code class="n">total</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">line</code><code class="o">.</code><code class="na">getToMoney</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">CurrencyConversion</code><code class="o">&gt;</code> <code class="nf">getLines</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">List</code><code class="o">.</code><code class="na">copyOf</code><code class="o">(</code><code class="n">lines</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">Money</code> <code class="nf">getTotal</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">total</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.4&amp;show=file">Example 14.4 [accumulator.0:src/main/java/travelator/itinerary/CostSummary.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>CostSummary</code> also reports the total cost in the preferred currency.&#13;
It stores the total cost in a field rather than calculating it in <code>getTotal</code> because the application often sorts items by their <code>CostSummary.total</code>, and recalculating every time we make a comparison turned out to be a bottleneck.&#13;
This means that a <code>CostSummary</code> has to update <code>total</code> whenever a <code>CurrencyConversion</code> is added.</p>&#13;
&#13;
<p><code>CostSummary</code> is also effectively a shared mutable collection.&#13;
Because this breaks our rule of thumb in <a data-type="xref" href="ch06.html#dont-mutate-shared-collections">“Don’t Mutate Shared Collections”</a>, it performs a copy in <code>getLines</code> to limit the damage.</p>&#13;
&#13;
<p>Now to <code>CostSummaryCalculator</code>.&#13;
It keeps a running total for each <code>Currency</code> in a <code>currencyTotals</code> field when <code>addCost</code> is called.&#13;
The <code>summarise</code> method constructs a <code>CostSummary</code> using a source of exchange rates to convert local costs to the traveler’s preferred &#13;
<span class="keep-together">currency</span>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CostSummaryCalculator</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Currency</code> <code class="n">userCurrency</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">ExchangeRates</code> <code class="n">exchangeRates</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">Currency</code><code class="o">,</code> <code class="n">Money</code><code class="o">&gt;</code> <code class="n">currencyTotals</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;&gt;();</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">CostSummaryCalculator</code><code class="o">(</code>&#13;
        <code class="n">Currency</code> <code class="n">userCurrency</code><code class="o">,</code>&#13;
        <code class="n">ExchangeRates</code> <code class="n">exchangeRates</code>&#13;
    <code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">userCurrency</code> <code class="o">=</code> <code class="n">userCurrency</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">exchangeRates</code> <code class="o">=</code> <code class="n">exchangeRates</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">addCost</code><code class="o">(</code><code class="n">Money</code> <code class="n">cost</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">currencyTotals</code><code class="o">.</code><code class="na">merge</code><code class="o">(</code><code class="n">cost</code><code class="o">.</code><code class="na">getCurrency</code><code class="o">(),</code> <code class="n">cost</code><code class="o">,</code> <code class="nl">Money:</code><code class="o">:</code><code class="n">add</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">CostSummary</code> <code class="nf">summarise</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">totals</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;(</code><code class="n">currencyTotals</code><code class="o">.</code><code class="na">values</code><code class="o">());</code>&#13;
        <code class="n">totals</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">comparing</code><code class="o">(</code><code class="n">m</code> <code class="o">-&gt;</code> <code class="n">m</code><code class="o">.</code><code class="na">getCurrency</code><code class="o">().</code><code class="na">getCurrencyCode</code><code class="o">()));</code>&#13;
&#13;
        <code class="n">CostSummary</code> <code class="n">summary</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CostSummary</code><code class="o">(</code><code class="n">userCurrency</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">var</code> <code class="n">total</code> <code class="o">:</code> <code class="n">totals</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">summary</code><code class="o">.</code><code class="na">addLine</code><code class="o">(</code><code class="n">exchangeRates</code><code class="o">.</code><code class="na">convert</code><code class="o">(</code><code class="n">total</code><code class="o">,</code> <code class="n">userCurrency</code><code class="o">));</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">summary</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">reset</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">currencyTotals</code><code class="o">.</code><code class="na">clear</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.5&amp;show=file">Example 14.5 [accumulator.0:src/main/java/travelator/itinerary/CostSummaryCalculator.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Thus, the calculation of a <code>CostSummary</code> is spread between two classes that intertwine the following responsibilities:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Hold information from the context of the calculation that is needed to compute the summary.</p>&#13;
</li>&#13;
<li>&#13;
<p>Calculate per-currency totals, so the calculation doesn’t accumulate rounding errors.</p>&#13;
</li>&#13;
<li>&#13;
<p>Convert costs to the traveler’s preferred currency.</p>&#13;
</li>&#13;
<li>&#13;
<p>Calculate the grand total in the traveler’s preferred currency.</p>&#13;
</li>&#13;
<li>&#13;
<p>Sort the currency conversions in alphabetical order of the original currency code.</p>&#13;
</li>&#13;
<li>&#13;
<p>Store the currency conversions and grand total so they can be displayed to the traveler.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Such smearing of responsibilities across classes is common when we compute by mutating shared state.&#13;
We’d like to disentangle the responsibilities and simplify the implementation. What final structure we should we aim for?</p>&#13;
&#13;
<p>One clue is in the name of the <code>CostCurrencyCalculator</code> class.&#13;
In linguistic jargon, the <code>CostCurrencyCalculator</code> is an<a data-primary="agent nouns" data-type="indexterm" id="idm46393379543720"/> <em>agent noun</em>: a noun derived from a verb that means no more than a thing that performs the action identified by the verb, like <em>driver</em> or <em>baker</em> or <em>calculator</em>.&#13;
<code>CostCurrencyCalculator</code> is a so-called<a data-primary="doer classes" data-type="indexterm" id="idm46393379540552"/> “doer class.”</p>&#13;
&#13;
<p>Another clue is in the data that the class holds.&#13;
The traveler’s preferred currency and source of exchange rates are the context for the calculation.&#13;
They are managed elsewhere in the application and held by <code>CostCurrencyCalculator</code> so that they are close at hand for its calculations.&#13;
The map of totals by currency (<code>currencyTotals</code>) contains transient, intermediate results of the calculation that are irrelevant after the calculation is complete and, in fact, should be discarded to avoid aliasing errors.&#13;
The class doesn’t <em>own</em> any data, only holds it temporarily for operational reasons.</p>&#13;
&#13;
<p>The <code>CostCurrencyCalculator</code> class doesn’t represent a <em>concept</em> in our application domain model, but a <em>function</em> that we perform upon elements of that domain model.&#13;
In Kotlin, we usually implement functions not with objects but with, well, functions.</p>&#13;
&#13;
<p>Let’s refactor the calculation from mutable classes to functions that work with immutable data.<a data-primary="" data-startref="ACTcalc14" data-type="indexterm" id="idm46393379535272"/><a data-primary="" data-startref="accparam14" data-type="indexterm" id="idm46393379534296"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring to Functions over Immutable Data" data-type="sect1"><div class="sect1" id="idm46393380200280">&#13;
<h1>Refactoring to Functions over Immutable Data</h1>&#13;
&#13;
<p>Converting<a data-primary="accumulating objects to transformations" data-secondary="refactoring to functions over immutable data" data-type="indexterm" id="AOTfuncover14"/><a data-primary="refactoring" data-secondary="to functions over immutable data" data-secondary-sortas="functions over immutable data" data-type="indexterm" id="Rfunc14"/> the two classes to Kotlin leaves us with Java in Kotlin syntax.&#13;
Here is <code>CostSummary</code> after a little tidying and rearranging:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">_lines</code> <code class="p">=</code> <code class="n">mutableListOf</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;()</code>&#13;
&#13;
    <code class="k">var</code> <code class="py">total</code><code class="p">:</code> <code class="n">Money</code> <code class="p">=</code> <code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code>&#13;
        <code class="k">private</code> <code class="k">set</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code>&#13;
        <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">_lines</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">CurrencyConversion</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">_lines</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>&#13;
        <code class="n">total</code> <code class="p">+=</code> <code class="n">line</code><code class="p">.</code><code class="n">toMoney</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.6&amp;show=file">Example 14.6 [accumulator.1:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The automatic conversion of <code>CostSummaryCalculator</code> needs less tidying:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummaryCalculator</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">exchangeRates</code><code class="p">:</code> <code class="n">ExchangeRates</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">currencyTotals</code> <code class="p">=</code> <code class="n">mutableMapOf</code><code class="p">&lt;</code><code class="n">Currency</code><code class="p">,</code> <code class="n">Money</code><code class="p">&gt;()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addCost</code><code class="p">(</code><code class="n">cost</code><code class="p">:</code> <code class="n">Money</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">currencyTotals</code><code class="p">.</code><code class="n">merge</code><code class="p">(</code><code class="n">cost</code><code class="p">.</code><code class="n">currency</code><code class="p">,</code> <code class="n">cost</code><code class="p">,</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">totals</code> <code class="p">=</code> <code class="n">ArrayList</code><code class="p">(</code><code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code><code class="p">)</code>&#13;
        <code class="n">totals</code><code class="p">.</code><code class="n">sortWith</code><code class="p">(</code><code class="n">comparing</code> <code class="p">{</code> <code class="n">m</code><code class="p">:</code> <code class="n">Money</code> <code class="p">-&gt;</code> <code class="n">m</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code> <code class="p">})</code>&#13;
&#13;
        <code class="k">val</code> <code class="py">summary</code> <code class="p">=</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">)</code>&#13;
        <code class="k">for</code> <code class="p">(</code><code class="n">total</code> <code class="k">in</code> <code class="n">totals</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="n">summary</code><code class="p">.</code><code class="n">addLine</code><code class="p">(</code><code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">total</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">))</code>&#13;
        <code class="p">}</code>&#13;
        <code class="k">return</code> <code class="n">summary</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">reset</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">currencyTotals</code><code class="p">.</code><code class="n">clear</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.7&amp;show=file">Example 14.7 [accumulator.1:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can start from here and refactor away the mutability.&#13;
We’ll work from the inside, making <code>CostSummary</code> an immutable value type, and gradually push immutability outward through the <code>CostSummaryCalculator</code>.&#13;
Before we do though, we’ve been stung by Java’s obsession with sorting collections in place before now, so we fix that first:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">totals</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code><code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code>&#13;
        <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">val</code> <code class="py">summary</code> <code class="p">=</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">total</code> <code class="k">in</code> <code class="n">totals</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">summary</code><code class="p">.</code><code class="n">addLine</code><code class="p">(</code><code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">total</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">))</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="n">summary</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.8&amp;show=file">Example 14.8 [accumulator.2:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we see a pattern that is common in mutating code: create an object (<code>CostSummary</code> in this case), call some initialization steps, and then return it.&#13;
Whenever we see initialization steps like this, we should reach for <code>apply</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">totals</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code><code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code>&#13;
        <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">val</code> <code class="py">summary</code> <code class="p">=</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">).</code><code class="n">apply</code> <code class="p">{</code>&#13;
        <code class="k">for</code> <code class="p">(</code><code class="n">total</code> <code class="k">in</code> <code class="n">totals</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="n">addLine</code><code class="p">(</code><code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">total</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">))</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="n">summary</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.9&amp;show=file">Example 14.9 [accumulator.3:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Using <code>apply</code> allows us to group the initialization steps into a block to better express our intent.&#13;
It’s like a mini builder: the <code>summarise</code> function never sees a reference to a partially initialized <code>CostSummary</code>, only the completed object.</p>&#13;
&#13;
<p>This is small-scale functional thinking—trying to limit the scope of mutation even within a function.&#13;
Functional thinking also helps us see that looping over <code>totals</code>, creating a <code>CurrencyConversion</code> for each, and calling <code>addLine</code> with it, is the same as creating a <code>conversions</code> list and looping over that:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">conversions</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code><code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code>&#13;
        <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code>&#13;
    <code class="p">}.</code><code class="n">map</code> <code class="p">{</code> <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code> <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">).</code><code class="n">apply</code> <code class="p">{</code>&#13;
        <code class="n">conversions</code><code class="p">.</code><code class="n">forEach</code><code class="p">(</code><code class="k">this</code><code class="o">::</code><code class="n">addLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.10&amp;show=file">Example 14.10 [accumulator.4:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Why make this change?&#13;
Well, we want to strip a <code>CostSummary</code> down to its immutable essence.&#13;
If <code>CostSummary</code> was immutable, client code would have to pass the list of lines to its constructor instead of calling its <code>addLine</code> method.&#13;
<code>CostSummary</code> shouldn’t be responsible for currency conversion, so we’re making the <code>apply</code> block look like we want its constructor to look.&#13;
From here we add a secondary constructor that duplicates this initialization logic:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">_lines</code> <code class="p">=</code> <code class="n">mutableListOf</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;()</code>&#13;
&#13;
    <code class="k">var</code> <code class="py">total</code><code class="p">:</code> <code class="n">Money</code> <code class="p">=</code> <code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code>&#13;
        <code class="k">private</code> <code class="k">set</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code>&#13;
        <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">_lines</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
&#13;
    <code class="n">constructor</code><code class="p">(</code>&#13;
        <code class="n">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
        <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code>&#13;
    <code class="p">):</code> <code class="k">this</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">forEach</code><code class="p">(</code><code class="o">::</code><code class="n">addLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">CurrencyConversion</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">_lines</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>&#13;
        <code class="n">total</code> <code class="p">+=</code> <code class="n">line</code><code class="p">.</code><code class="n">toMoney</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.11&amp;show=file">Example 14.11 [accumulator.5:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we can change the <code>CostSummaryCalculator.summarise</code> method to call the new constructor, treating the <code>CostSummary</code> class as if it was an immutable value type:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">conversions</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code><code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code>&#13;
        <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code>&#13;
    <code class="p">}.</code><code class="n">map</code> <code class="p">{</code> <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code> <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">,</code> <code class="n">conversions</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.12&amp;show=file">Example 14.12 [accumulator.5:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This in turn allows us to make the <code>CostSummary</code> class actually immutable, at least from outside:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code>&#13;
    <code class="n">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
&#13;
    <code class="k">var</code> <code class="py">total</code><code class="p">:</code> <code class="n">Money</code> <code class="p">=</code> <code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code>&#13;
        <code class="k">private</code> <code class="k">set</code>&#13;
&#13;
    <code class="n">init</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code>&#13;
            <code class="n">total</code> <code class="p">+=</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.13&amp;show=file">Example 14.13 [accumulator.6:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>As we can see from that nasty <code>var</code> and <code>init</code>, it’s sometimes hard to get away from mutation once it has set in, especially for accumulators like this; <code>fold</code> is our friend here.&#13;
We<a data-primary="calculations" data-secondary="initializing immutable variables" data-type="indexterm" id="idm46393378647208"/><a data-primary="actions" data-secondary="refactoring to functions over immutable data" data-type="indexterm" id="idm46393378646232"/> had a series of actions (<a data-type="xref" href="ch07.html#actions">“Actions”</a>) acting on the mutable variable <code>total</code>, and <code>fold</code> converts the actions to a single calculation (<a data-type="xref" href="ch07.html#calculations">“Calculations”</a>) that we can use to initialize an immutable variable:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code>&#13;
    <code class="n">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">fold</code><code class="p">(</code><code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">),</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.14&amp;show=file">Example 14.14 [accumulator.7:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that it is fully immutable, we can make <code>CostSummary</code> a data class if we can make <code>total</code> a primary constructor parameter.&#13;
We could do this by converting the current constructor to a secondary constructor, but instead we are going to move all the calculation into the <code>CostSummaryCalculator</code>, leaving the <code>CostSummary</code> merely to hold the results of that calculation.</p>&#13;
&#13;
<p>To do this, we first select the expression to the right of the equals sign in the definition of the <code>total</code> property and use the IDE’s “Introduce Parameter” refactoring to push the expression out as a constructor parameter:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;,</code>&#13;
    <code class="n">total</code><code class="p">:</code> <code class="n">Money</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">total</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.15&amp;show=file">Example 14.15 [accumulator.8:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The <code>total</code> property is now highlighted as a style warning: the IDE detected that the property can be declared in the constructor parameter.&#13;
A quick Alt-Enter on the warning leaves the class declaration as:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">total</code><code class="p">:</code> <code class="n">Money</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.16&amp;show=file">Example 14.16 [accumulator.9:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Meanwhile, back at the <code>CostSummaryCalculator</code>, IntelliJ has pulled the calculation into <code>summarise</code>, leaving it looking like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">lines</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code> <code class="p">}</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">fold</code><code class="p">(</code><code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">),</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
&#13;
    <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code> <code class="n">total</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.17&amp;show=file">Example 14.17 [accumulator.9:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><em>Now</em> we can make <code>CostSummary</code> a data class.&#13;
Its sole responsibility is to hold the results of the calculation for filtering, sorting, and display:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">total</code><code class="p">:</code> <code class="n">Money</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.18&amp;show=file">Example 14.18 [accumulator.10:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We said previously that mutable state can obscure algorithms by smearing them through the code.&#13;
We can now look back and see that was the case with <code>CostSummary</code>.&#13;
When we arrived, calculating the total was split into initializing a mutable <code>total</code> property and updating it in the <code>addLine</code> method:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummary</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">_lines</code> <code class="p">=</code> <code class="n">mutableListOf</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;()</code>&#13;
&#13;
    <code class="k">var</code> <code class="py">total</code><code class="p">:</code> <code class="n">Money</code> <code class="p">=</code> <code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code>&#13;
        <code class="k">private</code> <code class="k">set</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code>&#13;
        <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">_lines</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">CurrencyConversion</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">_lines</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>&#13;
        <code class="n">total</code> <code class="p">+=</code> <code class="n">line</code><code class="p">.</code><code class="n">toMoney</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.19&amp;show=file">Example 14.19 [accumulator.1:src/main/java/travelator/itinerary/CostSummary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now<a data-primary="" data-startref="Rfunc14" data-type="indexterm" id="idm46393378199592"/><a data-primary="" data-startref="AOTfuncover14" data-type="indexterm" id="idm46393378198584"/> the calculation is a single expression in <code>summarise</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
    <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
    <code class="p">.</code><code class="n">fold</code><code class="p">(</code><code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">),</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.20&amp;show=file">Example 14.20 [accumulator.9:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Let’s Do That Again" data-type="sect1"><div class="sect1" id="idm46393379531800">&#13;
<h1>Let’s Do That Again</h1>&#13;
&#13;
<p>Similarly, whatever<a data-primary="accumulating objects to transformations" data-secondary="expand-and-contract refactoring" data-type="indexterm" id="AOTexpand14"/><a data-primary="expand-and-contract refactoring" data-type="indexterm" id="expand14"/><a data-primary="refactoring" data-secondary="expand-and-contract refactoring" data-type="indexterm" id="Rexpand14"/> is happening with currencies is still hidden in the remaining mutations in <code>CostSummaryCalculator</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummaryCalculator</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">exchangeRates</code><code class="p">:</code> <code class="n">ExchangeRates</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">currencyTotals</code> <code class="p">=</code> <code class="n">mutableMapOf</code><code class="p">&lt;</code><code class="n">Currency</code><code class="p">,</code> <code class="n">Money</code><code class="p">&gt;()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addCost</code><code class="p">(</code><code class="n">cost</code><code class="p">:</code> <code class="n">Money</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">currencyTotals</code><code class="p">.</code><code class="n">merge</code><code class="p">(</code><code class="n">cost</code><code class="p">.</code><code class="n">currency</code><code class="p">,</code> <code class="n">cost</code><code class="p">,</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">summarise</code><code class="p">():</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">lines</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code>&#13;
            <code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code> <code class="p">}</code>&#13;
&#13;
        <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">fold</code><code class="p">(</code><code class="n">Money</code><code class="p">.</code><code class="n">of</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">),</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code> <code class="n">total</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">reset</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">currencyTotals</code><code class="p">.</code><code class="n">clear</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.21&amp;show=file">Example 14.21 [accumulator.9:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can apply a similar process to eliminate these, but this time we won’t add a secondary constructor.&#13;
Instead, we will apply <a data-type="xref" href="ch04.html#expand-contract">“Expand-and-Contract Refactoring”</a> by adding an overload of the <code>summarise</code> method that takes the costs:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">(</code><code class="n">costs</code><code class="p">:</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;):</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">delegate</code> <code class="p">=</code> <code class="n">CostSummaryCalculator</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">,</code> <code class="n">exchangeRates</code><code class="p">)</code>&#13;
    <code class="n">costs</code><code class="p">.</code><code class="n">forEach</code><code class="p">(</code><code class="n">delegate</code><code class="o">::</code><code class="n">addCost</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">delegate</code><code class="p">.</code><code class="n">summarise</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.22&amp;show=file">Example 14.22 [accumulator.11:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.22&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is quite sneaky.&#13;
The old <code>summarise</code> method is an action: its result depends on the past history of calling <code>addCost</code> and <code>reset</code>.&#13;
This new <code>summarise</code> is a calculation: its result depends only on the values of its inputs (the <code>costs</code> parameter plus the <code>userCurrency</code> and <code>exchangeRates</code> properties it accesses).&#13;
And yet the new <code>summarise</code> uses the old one; it just limits the scope of mutation to a local variable, converting it to a calculation.</p>&#13;
&#13;
<p>When we use this version of <code>summarise</code>, we have drawn a distinction between the <em>context</em> of cost-summary calculations, which we pass to the constructor as <code>userCurrency</code> and <code>exchangeRates</code>, and the parameters of a <em>specific</em> calculation (the <code>costs</code> that we pass to the <code>summarise</code> method).&#13;
This will be significant later (<a data-type="xref" href="#pricing-context">“Enriching the Abstraction We Discovered”</a>).</p>&#13;
&#13;
<p>Now that we have two <code>summarise</code> methods, we can move our callers to the new one.&#13;
To switch over to using the new <code>summarise</code>, we’ll have to extract the costs from the entities we want to summarize, rather than telling them to add their costs to a mutable calculator that we pass in.&#13;
Instead of asking children to add their costs to the &#13;
<span class="keep-together"><code>CostSummaryCalculator</code></span>, parents will ask their children for their costs and combine them.</p>&#13;
&#13;
<p>We’ll end up using the calculator like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">fx</code><code class="p">:</code> <code class="n">ExchangeRates</code> <code class="p">=</code> <code class="p">...</code>&#13;
<code class="k">val</code> <code class="py">userCurrency</code> <code class="p">=</code> <code class="p">...</code>&#13;
<code class="k">val</code> <code class="py">calculator</code> <code class="p">=</code> <code class="n">CostSummaryCalculator</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">,</code> <code class="n">fx</code><code class="p">)</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">costSummary</code><code class="p">(</code><code class="n">i</code><code class="p">:</code> <code class="n">Itinerary</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">calculator</code><code class="p">.</code><code class="n">summarise</code><code class="p">(</code><code class="n">i</code><code class="p">.</code><code class="n">costs</code><code class="p">())</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.23&amp;show=file">Example 14.23 [accumulator.12:src/test/java/travelator/itinerary/Itinerary_CostTest.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.23&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>And we’ll report the costs from our domain models like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Itinerary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">route</code><code class="p">:</code> <code class="n">Route</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">accommodations</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Accommodation</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="p">...</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">costs</code><code class="p">():</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">route</code><code class="p">.</code><code class="n">costs</code><code class="p">()</code> <code class="p">+</code> <code class="n">accommodations</code><code class="p">.</code><code class="n">costs</code><code class="p">()</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">Iterable</code><code class="p">&lt;</code><code class="n">Accommodation</code><code class="p">&gt;.</code><code class="n">costs</code><code class="p">():</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">flatMap</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">costs</code><code class="p">()</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.24&amp;show=file">Example 14.24 [accumulator.12:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.24&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>When all uses of <code>CostSummaryCalculator</code> in the application are using our new &#13;
<span class="keep-together"><code>summarise</code></span> method, we can flatten the calculation of the <code>currencyTotals</code> and &#13;
<span class="keep-together"><code>CostSummary</code></span> into that method, the one that currently uses a local to do the job:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">(</code><code class="n">costs</code><code class="p">:</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;):</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">delegate</code> <code class="p">=</code> <code class="n">CostSummaryCalculator</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">,</code> <code class="n">exchangeRates</code><code class="p">)</code>&#13;
    <code class="n">costs</code><code class="p">.</code><code class="n">forEach</code><code class="p">(</code><code class="n">delegate</code><code class="o">::</code><code class="n">addCost</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">delegate</code><code class="p">.</code><code class="n">summarise</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.25&amp;show=file">Example 14.25 [accumulator.11:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.25&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can effectively inline the entire class into this method using local variables instead:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">summarise</code><code class="p">(</code><code class="n">costs</code><code class="p">:</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;):</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">currencyTotals</code> <code class="p">=</code> <code class="n">mutableMapOf</code><code class="p">&lt;</code><code class="n">Currency</code><code class="p">,</code> <code class="n">Money</code><code class="p">&gt;()</code>&#13;
    <code class="n">costs</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code>&#13;
        <code class="n">currencyTotals</code><code class="p">.</code><code class="n">merge</code><code class="p">(</code><code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">,</code> <code class="n">it</code><code class="p">,</code> <code class="n">Money</code><code class="o">::</code><code class="n">plus</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">val</code> <code class="py">lines</code> <code class="p">=</code> <code class="n">currencyTotals</code><code class="p">.</code><code class="n">values</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code> <code class="p">}</code>&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">fold</code><code class="p">(</code><code class="n">Money</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">),</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code> <code class="n">total</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.26&amp;show=file">Example 14.26 [accumulator.13:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.26&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Our tests still pass, and IntelliJ tells us that all the other methods of <code>CostSummary​Cal⁠cu⁠lator</code> are now unused, as is the <code>currencyTotals</code> field, so by deleting them all we have finally succeeded in removing all the mutable state from the class.&#13;
Not from that method though—we still have a mutable map!&#13;
This is the last remnant of the smearing out of the algorithm that we mentioned earlier.&#13;
We have finally brought all the logic into this one method, and because all our logic is in one place, we know that it happens at one time and is safe to refactor to any equivalent form.</p>&#13;
&#13;
<p>What is that form?&#13;
We have to think about that, but come to the conclusion that the <code>MutableMap.merge</code> is accumulating a total per currency.&#13;
When we have all the data at once, as we do now, we can perform the same calculation by grouping by currency and summing the lists:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">CostSummaryCalculator</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">exchangeRates</code><code class="p">:</code> <code class="n">ExchangeRates</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">summarise</code><code class="p">(</code><code class="n">costs</code><code class="p">:</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;):</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">currencyTotals</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">costs</code>&#13;
            <code class="p">.</code><code class="n">groupBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">values</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">moneys</code> <code class="p">-&gt;</code> <code class="n">moneys</code><code class="p">.</code><code class="n">reduce</code><code class="p">(</code><code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code> <code class="p">}</code>&#13;
        <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">currencyTotals</code>&#13;
            <code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code> <code class="p">}</code>&#13;
        <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">fold</code><code class="p">(</code><code class="n">Money</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">),</code> <code class="n">Money</code><code class="o">::</code><code class="n">add</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code> <code class="n">total</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.27&amp;show=file">Example 14.27 [accumulator.14:src/main/java/travelator/itinerary/CostSummaryCalculator.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.27&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It is a bit irritating that we have to use <code>reduce</code> to sum monies instead of having a nice <code>Iterable&lt;Money&gt;.sum()</code> extension function. We should probably fix that.&#13;
And now that the calculation is all in one place, we might ponder whether there is meaning in the fact that we use <code>reduce</code> in one expression and <code>fold</code> in another (hint, there is), but these are thoughts that we can have only because the code is now set out in one place.</p>&#13;
&#13;
<p>The key thing is that we can see the shape of the <code>summarise</code> calculation more clearly now.&#13;
It is a pure function that is applied to a collection of costs and is evaluated in the context of some exchange rates and the traveler’s preferred currency.&#13;
The function transforms the nested entities of our domain model into a flat collection of costs and then transforms the costs into a map of the total for each currency, transforms the totals for each <code>Currency</code> into a list of <code>CurrencyConversion</code>, and finally transforms the list of currency conversions into a <code>CostSummary</code>.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>A functional program transforms its inputs into outputs.</p>&#13;
&#13;
<p>If you can’t write that easily in one step, transform the inputs into an intermediate representation that is easy to transform into the outputs.</p>&#13;
&#13;
<p>Introduce intermediate forms and transformations until you have a pipeline of simple transformations between intermediate forms that compose to transform the inputs that you <em>have</em> to the outputs that you <em>want</em>.</p>&#13;
</div>&#13;
&#13;
<p>We will look more at pure functions evaluated in context in <a data-type="xref" href="ch16.html#interfaces-to-functions">Chapter 16</a>.<a data-primary="" data-startref="Rexpand14" data-type="indexterm" id="idm46393377331880"/><a data-primary="" data-startref="expand14" data-type="indexterm" id="idm46393377330904"/><a data-primary="" data-startref="AOTexpand14" data-type="indexterm" id="idm46393377329960"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enriching the Abstraction We Discovered" data-type="sect1"><div class="sect1" id="pricing-context">&#13;
<h1>Enriching the Abstraction We Discovered</h1>&#13;
&#13;
<p>Travelator<a data-primary="accumulating objects to transformations" data-secondary="enriching the abstraction" data-type="indexterm" id="AOTenrich14"/> does more with exchange rates and the traveler’s preferred currency than summarize costs.&#13;
For example, while the user is browsing hotel rooms, it shows the cost of each room in both local and preferred currencies.&#13;
That is, the hotel room browser performs a currency conversion on an individual cost.&#13;
The <code>CostSummary​Cal⁠cu⁠lator</code> also has to perform currency conversions on individual costs to calculate a summary.&#13;
If we extract that functionality as a public method, which we can call &#13;
<span class="keep-together"><code>toUserCurrency</code></span>, we can initialize the hotel room browser with a <code>CostSummary​Cal⁠cul⁠ator</code> instead of passing it both the exchange rates and preferred currency.&#13;
We can also remove the currency conversion calculation—that we now see is duplicated &#13;
<span class="keep-together">code—from</span> the hotel room browser.</p>&#13;
&#13;
<p>At that point, the class is no longer a calculator of cost summaries.&#13;
It holds the context for any pricing we do for an individual traveler.&#13;
So let’s rename it to reflect its newfound responsibility.&#13;
At the moment, we can’t think of a better name than <code>PricingContext</code>, which leaves our class looking like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">PricingContext</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">userCurrency</code><code class="p">:</code> <code class="n">Currency</code><code class="p">,</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">exchangeRates</code><code class="p">:</code> <code class="n">ExchangeRates</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">toUserCurrency</code><code class="p">(</code><code class="n">money</code><code class="p">:</code> <code class="n">Money</code><code class="p">)</code> <code class="p">=</code>&#13;
        <code class="n">exchangeRates</code><code class="p">.</code><code class="n">convert</code><code class="p">(</code><code class="n">money</code><code class="p">,</code> <code class="n">userCurrency</code><code class="p">)</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">summarise</code><code class="p">(</code><code class="n">costs</code><code class="p">:</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;):</code> <code class="n">CostSummary</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">currencyTotals</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Money</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">costs</code>&#13;
            <code class="p">.</code><code class="n">groupBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">values</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
                <code class="n">it</code><code class="p">.</code><code class="n">sumOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"Unexpected empty list"</code><code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
        <code class="k">val</code> <code class="py">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CurrencyConversion</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">currencyTotals</code>&#13;
            <code class="p">.</code><code class="n">sortedBy</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">currency</code><code class="p">.</code><code class="n">currencyCode</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">::</code><code class="n">toUserCurrency</code><code class="p">)</code>&#13;
        <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">lines</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">toMoney</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">sum</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">CostSummary</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code> <code class="n">total</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.28&amp;show=file">Example 14.28 [accumulator.16:src/main/java/travelator/itinerary/PricingContext.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.28&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393377316776">&#13;
<h5>Naming</h5>&#13;
<p>The<a data-primary="naming conventions" data-type="indexterm" id="idm46393377111672"/> name is a bit too generic for our tastes, but will do until we think of something better.&#13;
At least it’s not misleading.&#13;
Renames are cheap, even in a mixed Java/Kotlin codebase, so a small incremental improvement is better than no improvement.</p>&#13;
</div></aside>&#13;
&#13;
<p>This leaves the code that used to use the <code>CostSummaryCalculator</code> looking like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">fx</code><code class="p">:</code> <code class="n">ExchangeRates</code> <code class="p">=</code> <code class="p">...</code>&#13;
<code class="k">val</code> <code class="py">userCurrency</code> <code class="p">=</code> <code class="p">...</code>&#13;
<code class="k">val</code> <code class="py">pricing</code> <code class="p">=</code> <code class="n">PricingContext</code><code class="p">(</code><code class="n">userCurrency</code><code class="p">,</code> <code class="n">fx</code><code class="p">)</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">costSummary</code><code class="p">(</code><code class="n">i</code><code class="p">:</code> <code class="n">Itinerary</code><code class="p">)</code> <code class="p">=</code> <code class="n">pricing</code><code class="p">.</code><code class="n">summarise</code><code class="p">(</code><code class="n">i</code><code class="p">.</code><code class="n">costs</code><code class="p">())</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=14.29&amp;show=file">Example 14.29 [accumulator.16:src/test/java/travelator/itinerary/Itinerary_CostTest.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=14.29&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that we have this concept in our codebase, we can identify other parts of our application that can use it.&#13;
We can move logic from those parts onto the <code>Pricing​Con⁠text</code>, making it a one-stop shop for operations that need to convert monetary amounts into the traveler’s preferred currency.&#13;
And should it end up full of disparate methods for different use cases, then we can move the operations from methods to extension functions to keep them closer to where they are needed (see <a data-type="xref" href="ch10.html#functions-to-extension-functions">Chapter 10</a>).<a data-primary="" data-startref="AOTenrich14" data-type="indexterm" id="idm46393377081656"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393377328760">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>We started this chapter with a calculation that relied on shared, mutable state.&#13;
It duplicated logic from the standard library and introduced the risk of aliasing errors.&#13;
By the end of the chapter, we had refactored the same calculation to a transformation of immutable data.</p>&#13;
&#13;
<p>To do so, we moved mutation out of our code in two directions, outward and inward.&#13;
Outward was obvious: we made the <code>CostSummaryCalculator</code> treat the <code>CostSummary</code> class as an immutable value type and then made <code>CostSummary</code> immutable.&#13;
Then we made users of <code>CostSummaryCalculator</code> treat it as an immutable context to a calculation and then made <code>CostSummaryCalculator</code> immutable.&#13;
But inward?&#13;
We replaced the imperative code that mutated collections and fields with calls to standard higher-order functions, like <code>groupingBy</code>, <code>fold</code>, and <code>reduce</code>.&#13;
Under the hood, those functions may mutate state, but they hide that mutation from their callers.&#13;
From outside, the functions are calculations.</p>&#13;
&#13;
<p>We can use the same approach in our own code when we need to.&#13;
Sometimes mutating a collection is the easiest thing to do.&#13;
The standard library does not always have a higher-order function that transforms data the way we want.&#13;
If we do need a mutable collection, we can hide that mutation inside a calculation to limit the blast radius of any potential aliasing errors.&#13;
However, every release adds more functions to the standard library, so the need diminishes over time.</p>&#13;
&#13;
<p>Functional programming<a data-primary="functional programming" data-type="indexterm" id="idm46393377073160"/> does not eliminate mutable state but instead <em>makes it the responsibility of the runtime</em>.&#13;
A functional program declares what the runtime should calculate and lets the runtime be responsible for computing that calculation.&#13;
Kotlin is not a pure functional language, but we benefit by following that principle where we can.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>