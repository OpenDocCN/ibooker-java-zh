<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 15. Working with a Reactive &#10;Programming Model"><div class="chapter" id="working_with_a_reactive_programming_model_chapter">
<h1><span class="label">Chapter 15. </span>Working with a Reactive 
<span class="keep-together">Programming Model</span></h1>


<p><a data-type="indexterm" data-primary="reactive programming model" data-secondary="about" id="idm45128495735320"/><a data-type="indexterm" data-primary="reactive programming model" id="react_ch"/>We are all familiar with the client-server architecture that has dominated enterprise software development for decades.
However, we have recently had a shift in architecture styles.
In addition to the standard client-server approach, we have message-driven applications, microservices, reactive applications, and even serverless!
All of these types of applications are possible to create using Quarkus.
In the follow recipes, you’ll learn about reactive programming models, message buses, and streaming.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="SmallRye Mutiny" data-seealso="reactive programming model" id="idm45128495702792"/>Quarkus (and this book!) makes use of SmallRye Mutiny for its reactive library.
You can read more about Mutiny at <a href="https://oreil.ly/nBP7H">SmallRye Mutiny</a>.
There is also support for RxJava and Reactor, but they are not the preferred choice.
To use either of them, you will need to use converters from Mutiny.</p>
</div>






<section data-type="sect1" data-pdf-bookmark="15.1 Creating Async HTTP Endpoints"><div class="sect1" id="idm45128495700504">
<h1>15.1 Creating Async HTTP Endpoints</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128495699496">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="async HTTP endpoints, creating" id="idm45128495698296"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="creating async HTTP endpoints" id="idm45128495697624"/>You want to create an async HTTP endpoint.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128495696360">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="Eclipse MicroProfile Reactive Messaging" id="idm45128495694952"/>Quarkus has integrations with Java Streams, the Eclipse MicroProfile Reactive spec, and SmallRye Mutiny.
These integrations make it easy to support an asynchronous HTTP endpoint.
The first thing you will need to do is determine which libraries you wish to use.
If you wish to use native Streams or the MicroProfile Reactive specification, you will need to add the <code>quarkus-smallrye-reactive-streams-operators</code> extension.
If you want to use SmallRye Mutiny, add the <code>quarkus-resteasy-mutiny</code> extension to your project.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Going forward, Mutiny will be the preferred library within Quarkus for all things reactive.</p>
</div>

<p>Once the extension is in place, all you need to do with your HTTP endpoints is return a reactive class:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code><code>
</code><code class="nd">@PATH</code><code class="o">(</code><code class="s">"/reactive"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="n">CompletionStage</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="nf">reactiveHello</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-2" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">ReactiveStreams</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"h"</code><code class="o">,</code><code> </code><code class="s">"e"</code><code class="o">,</code><code> </code><code class="s">"l"</code><code class="o">,</code><code> </code><code class="s">"l"</code><code class="o">,</code><code> </code><code class="s">"o"</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">String:</code><code class="o">:</code><code class="n">toUpperCase</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">toList</code><code class="o">(</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">run</code><code class="o">(</code><code class="o">)</code><code>
</code><code>        </code><code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">list</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">list</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Naturally, any valid <code>MediaType</code> is valid; for simplicity, we used plain text</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-2" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p><code>CompletionStage</code> comes from the <code>java.util.concurrent</code> package</p></dd>
</dl>

<p>For Mutiny, this example becomes the following:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code>
<code class="nd">@PATH</code><code class="o">(</code><code class="s">"/reactive"</code><code class="o">)</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">helloMutiny</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">items</code><code class="o">(</code><code class="s">"h"</code><code class="o">,</code> <code class="s">"e"</code><code class="o">,</code> <code class="s">"l"</code><code class="o">,</code> <code class="s">"l"</code><code class="o">,</code> <code class="s">"o"</code><code class="o">);</code>
<code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128495547592">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="SmallRye Mutiny" id="idm45128495533432"/>For more information, visit the following websites:</p>

<ul>
<li>
<p><a href="https://oreil.ly/nBP7H">SmallRye Mutiny</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ab8eo">SmallRye Reactive Streams Operators</a></p>
</li>
<li>
<p><a href="https://oreil.ly/pgyMk">Reactive Streams</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.2 Streaming Data Asynchronously"><div class="sect1" id="idm45128495527912">
<h1>15.2 Streaming Data Asynchronously</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128495526904">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="reactive programming model" data-secondary="streaming data asynchronously" id="idm45128495525704"/><a data-type="indexterm" data-primary="streaming data asynchronously" id="idm45128495524792"/><a data-type="indexterm" data-primary="data" id="idm45128495524152"/>You want to stream data in an async way.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128495523032">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="SSE (server-side events)" id="idm45128495521624"/>Very similar to creating an asynchronous HTTP endpoint, Quarkus allows you to stream events from your application using server-sent events or server-side events (SSE).
What you will need to do in this case is to return a <code>Publisher</code> and tell JAX-RS that your endpoint produces <code>MediaType.SERVER_SENT_EVENTS</code>.
Here’s an example that streams a <code>long</code> every 500 milliseconds:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/integers"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">SERVER_SENT_EVENTS</code><code class="o">)</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="n">Publisher</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code><code> </code><code class="nf">longPublisher</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-2" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">ticks</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofMillis</code><code class="o">(</code><code class="mi">500</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Make sure you tell JAX-RS you are using SSEs</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-2" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The return type for the method must be a <code>org.reactivestream.Publisher</code> from the Reactive Streams library</p></dd>
</dl>

<p>With Mutiny, a <code>Multi</code> is a <code>Publisher</code>, making this even easier by simply returning a <code>Multi</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128495437448">
<h2>See Also</h2>

<p>For more information, visit the following websites:</p>

<ul>
<li>
<p><a href="https://oreil.ly/m0cAC">Wikiwand: Server-Sent Events</a></p>
</li>
<li>
<p><a href="https://oreil.ly/ZIX4X">MDN Web Docs: Using server-sent events</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.3 Using Messaging to Decouple Components"><div class="sect1" id="idm45128495403400">
<h1>15.3 Using Messaging to Decouple Components</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128495402184">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="messaging" data-secondary="using to decouple components" id="idm45128495400984"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="using messaging to decouple components" id="idm45128495400040"/>You want to use messaging to decouple components.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128495398776">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="Vert.x" id="idm45128495397368"/>One of the underlying/bundled frameworks used by Quarkus is Vert.x.
Vert.x is a framework for building asynchronous, event-driven, reactive applications, much like Quarkus!
Quarkus makes use of the Vert.x Event Bus for sending and receiving events/messages with decoupled classes.</p>

<p>To make use of Vert.x, just like many features with Quarkus, you will need to add the proper extension to your application.
The name for the Vert.x extension is <code>vertx</code>.</p>










<section data-type="sect3" data-pdf-bookmark="Handling events/messages"><div class="sect3" id="idm45128495395128">
<h3>Handling events/messages</h3>

<p><a data-type="indexterm" data-primary="messaging" data-secondary="handling" id="idm45128495393928"/><a data-type="indexterm" data-primary="event handling" id="idm45128495392952"/>We’ll first take a look at listening to or consuming events.
The easiest way to consume events in Quarkus is to use the <code>io.quarkus.vertx.ConsumeEvent</code> annotation.

<span class="keep-together"><code>@ConsumeEvent</code></span> has attributes, which we’ll get to, but let’s see it in action:</p>

<pre id="decouple-basic-source" data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">com</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">vertx</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.vertx.ConsumeEvent</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@ApplicationScoped</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">GreetingService</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="nd">@ConsumeEvent</code><code>   </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">consumeNormal</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">name</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-2" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">name</code><code class="o">.</code><code class="na">toUpperCase</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>With no value set, the address of the event is the fully qualified name of the bean; in this case, it would be <code>com.acme.vertx.GreetingService</code></p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-2" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The parameter for the consumer is the message body; if the method returns anything, it is packaged as the message response</p></dd>
</dl>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Sending events/messages"><div class="sect3" id="idm45128495332760">
<h3>Sending events/messages</h3>

<p><a data-type="indexterm" data-primary="messaging" data-secondary="sending" id="idm45128495331352"/>To send an event, you will be interacting with the Vert.x Event Bus. You can obtain the instance via injection: <code>@Inject io.vertx.axle.core.eventbus.EventBus bus</code>.
You will be primarily making use of two methods on the event bus:</p>
<dl>
<dt><code>send</code></dt>
<dd>
<p>Sends a message and optionally expects a reply</p>
</dd>
<dt><code>publish</code></dt>
<dd>
<p>Publishes a message to each listener</p>
</dd>
</dl>

<pre id="sending-vertx-messages" data-type="programlisting" data-code-language="java"><code class="n">bus</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="s">"address"</code><code class="o">,</code><code> </code><code class="s">"hello"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">bus</code><code class="o">.</code><code class="na">publish</code><code class="o">(</code><code class="s">"address"</code><code class="o">,</code><code> </code><code class="s">"hello"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-2" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">bus</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="s">"address"</code><code class="o">,</code><code> </code><code class="s">"hello, how are you?"</code><code class="o">)</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-3" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">.</code><code class="na">thenAccept</code><code class="o">(</code><code class="n">msg</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="c1">// do something with the message
</code><code class="o">}</code><code class="o">)</code><code class="o">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Send a message to a specific address, and a single consumer receives it, then forget about the response.</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-2" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Publish a message to a specific address, and all consumers receive the message.</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-3" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Send a message to a specific address, and expect a reply.</p></dd>
</dl>

<p>You should have enough information to create your own version of the Greeting Service using Vert.x Eventing!</p>
</div></section>



</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128495241384">
<h2>Discussion</h2>

<p>You can also return a <code>CompletionStage</code> to handle events in asynchronous fashion.
Lastly, if you wish to use the <code>io.vertx.axle.core.eventbus.Message</code> as the method param, you may do so and get access to the rest of the message within your event handler.</p>

<p>Fire-and-forget style interactions are just as easy—simply return <code>void</code> from your method.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The method consuming an event is called on the Vert.x event loop.
The first tenet of Vert.x is to never block the event loop.
Your code <em>must</em> be nonblocking.
<em>If</em> you need the method to block, set the <code>blocking</code> attribute on <code>@ConsumeEvent</code> to <code>true</code>.</p>
</div>

<p>To configure the name or address of the event handler, use the <code>value</code> parameter:</p>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@ConsumeEvent</code><code class="o">(</code><code class="n">value</code> <code class="o">=</code> <code class="s">"greeting"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">consumeNamed</code><code class="o">(</code><code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">name</code><code class="o">.</code><code class="na">toUpperCase</code><code class="o">();</code>
    <code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128495181768">
<h2>See Also</h2>

<p>For more information, visit the following websites:</p>

<ul>
<li>
<p><a href="https://www.vertx.io">Vert.x</a></p>
</li>
<li>
<p><a href="https://oreil.ly/TAnxk">Vert.x: The Event Bus</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.4 Reacting to Apache Kafka Messages"><div class="sect1" id="reacting_apache_kafka_messages">
<h1>15.4 Reacting to Apache Kafka Messages</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128495179688">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Apache Kafka" data-secondary="reacting to messages in" id="idm45128495178488"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="reacting to Apache Kafka messages" id="idm45128495177512"/>You want to react to Apache Kafka messages.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128495176184">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="Eclipse MicroProfile Reactive Messaging" id="idm45128495174776"/>Quarkus makes use of Eclipse MicroProfile Reactive Messaging to interact with Apache Kafka.</p>

<p>The Reactive Messaging specification is built on top of three main concepts:</p>
<ol>
<li>
<p><code>Message</code></p>
</li>
<li>
<p><code>@Incoming</code></p>
</li>
<li>
<p><code>@Outgoing</code></p>
</li>

</ol>

<p>This recipe focuses on <code>Message</code> and <code>@Incoming</code>; see <a data-type="xref" href="#sending_message_apache">Recipe 15.5</a> if you need to go the other direction.</p>










<section data-type="sect3" data-pdf-bookmark="Message"><div class="sect3" id="idm45128495167656">
<h3>Message</h3>

<p>In short, a <code>Message</code> is an envelope around a payload.
The envelope also carries with it optional metadata, though more often than not, you care only about the payload.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="@Incoming annotation"><div class="sect3" id="idm45128495165496">
<h3>@Incoming annotation</h3>

<p><a data-type="indexterm" data-primary="@Incoming annotation" id="idm45128495164056"/>This annotation (<code>org.eclipse.microprofile.reactive.messaging.Incoming</code>) indicates that the method consumes a stream of messages.
The only attribute is the name of the name of the stream or topic.
Methods are annotated this way for the end of a processing chain, also known as a <em>sink</em>.
The following are a couple of uses within Quarkus:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.concurrent.CompletableFuture</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.concurrent.CompletionStage</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Message</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">CharacterReceiver</code> <code class="o">{</code>
  <code class="nd">@Incoming</code><code class="o">(</code><code class="s">"ascii-char"</code><code class="o">)</code>
  <code class="kd">public</code> <code class="n">CompletionStage</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">processKafkaChar</code><code class="o">(</code><code class="n">Message</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">character</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">CompletableFuture</code><code class="o">.</code><code class="na">runAsync</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="o">{</code>
      <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received a message from Kafka "</code>
          <code class="o">+</code> <code class="s">"using CompletableFuture: '"</code> <code class="o">+</code> <code class="n">character</code><code class="o">.</code><code class="na">getPayload</code><code class="o">()</code> <code class="o">+</code> <code class="s">"'"</code><code class="o">);</code>
    <code class="o">});</code>
  <code class="o">}</code>

  <code class="nd">@Incoming</code><code class="o">(</code><code class="s">"ascii-char"</code><code class="o">)</code>
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">processCharacter</code><code class="o">(</code><code class="n">String</code> <code class="n">character</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received a String from kafka: '"</code> <code class="o">+</code> <code class="n">character</code> <code class="o">+</code> <code class="s">"'"</code><code class="o">);</code>
  <code class="o">}</code>
<code class="o">}</code></pre>

<p>You can see that either method works; however, in the case of <code>processKafkaCharacter</code> it takes a <code>Message</code> and returns a <code>CompletionStage</code>.
If your method receives a <code>Message</code> as the parameter, it <em>must</em> return a <code>CompletionStage</code>.</p>

<p>If you are interested only in the payload, you don’t need to worry about any of that and can simply accept the type of the payload and return void, as is demonstrated in <code>processCharacter</code> in the previous code.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Configuration"><div class="sect3" id="idm45128493587400">
<h3>Configuration</h3>

<p>As expected, you will need to configure your application to talk to Apache Kafka:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">mp.messaging.incoming.ascii-char.connector</code><code class="o">=</code><code class="s">smallrye-kafka</code>
<code class="na">mp.messaging.incoming.ascii-char.value.deserializer</code><code class="o">=</code><code class="s">org.apache.kafka.common\</code>
<code class="s">                                                    .serialization\</code>
<code class="s">                                                    .StringDeserializer</code>
<code class="na">mp.messaging.incoming.ascii-char.broadcast</code><code class="o">=</code><code class="s">true</code></pre>

<p>In the preceding code, we have multiple subscribers, so we need to use <code>broadcast=true</code>. The <code>broadcast</code> attribute lets MicroProfile Reactive Messaging (SmallRye is an implementation) know that messages received can be dispatched to more than one subscriber.</p>

<p>The syntax of the configuration is as follows:</p>

<pre data-type="programlisting">mp.messaging.[outgoing|incoming].{channel-name}.property=value</pre>

<p>The value in the <code>channel-name</code> segment must match the value set in <code>@Incoming</code> (and @<code>Outgoing</code>, which is covered in the next recipe).</p>

<p>There are some sensible defaults that you can see in <a href="https://oreil.ly/L5WHK">SmallRye Reactive Messaging: Apache Kafka</a>.</p>
</div></section>



</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128493564888">
<h2>Discussion</h2>

<p>To get up and running quickly with Apache Kafka in a development environment, you can visit the websites listed in <a data-type="xref" href="#see_also">“See Also”</a>, or use the following <em>docker-compose.yml</em> file along with <code>docker-compose</code>:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">version</code><code class="p">:</code> <code class="s">'2'</code>

<code class="nt">services</code><code class="p">:</code>

  <code class="nt">zookeeper</code><code class="p">:</code>
    <code class="nt">image</code><code class="p">:</code> <code class="l-Scalar-Plain">strimzi/kafka:0.11.3-kafka-2.1.0</code>
    <code class="nt">command</code><code class="p">:</code> <code class="p-Indicator">[</code>
      <code class="s">"sh"</code><code class="p-Indicator">,</code> <code class="s">"-c"</code><code class="p-Indicator">,</code>
      <code class="s">"bin/zookeeper-server-start.sh</code><code class="nv"> </code><code class="s">config/zookeeper.properties"</code>
    <code class="p-Indicator">]</code>
    <code class="nt">ports</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="s">"2181:2181"</code>
    <code class="nt">environment</code><code class="p">:</code>
      <code class="nt">LOG_DIR</code><code class="p">:</code> <code class="l-Scalar-Plain">/tmp/logs</code>

  <code class="nt">kafka</code><code class="p">:</code>
    <code class="nt">image</code><code class="p">:</code> <code class="l-Scalar-Plain">strimzi/kafka:0.11.3-kafka-2.1.0</code>
    <code class="nt">command</code><code class="p">:</code> <code class="p-Indicator">[</code>
      <code class="s">"sh"</code><code class="p-Indicator">,</code> <code class="s">"-c"</code><code class="p-Indicator">,</code>
      <code class="s">"bin/kafka-server-start.sh</code><code class="nv"> </code><code class="s">config/server.properties</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">listeners=$${KAFKA_LISTENERS}</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">advertised.listeners=$${KAFKA_ADVERTISED_LISTENERS}</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">zookeeper.connect=$${KAFKA_ZOOKEEPER_CONNECT}"</code>
    <code class="p-Indicator">]</code>
    <code class="nt">depends_on</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">zookeeper</code>
    <code class="nt">ports</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="s">"9092:9092"</code>
    <code class="nt">environment</code><code class="p">:</code>
      <code class="nt">LOG_DIR</code><code class="p">:</code> <code class="s">"/tmp/logs"</code>
      <code class="nt">KAFKA_ADVERTISED_LISTENERS</code><code class="p">:</code> <code class="l-Scalar-Plain">PLAINTEXT://localhost:9092</code>
      <code class="nt">KAFKA_LISTENERS</code><code class="p">:</code> <code class="l-Scalar-Plain">PLAINTEXT://0.0.0.0:9092</code>
      <code class="nt">KAFKA_ZOOKEEPER_CONNECT</code><code class="p">:</code> <code class="l-Scalar-Plain">zookeeper:2181</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="see_also">
<h2>See Also</h2>

<p>For more information, visit the following:</p>

<ul>
<li>
<p><a href="https://oreil.ly/DSu7u">GitHub: Reactive Messaging for MicroProfile</a></p>
</li>
<li>
<p><a href="https://oreil.ly/QlGHK">SmallRye Reactive Messaging</a></p>
</li>
<li>
<p><a href="https://oreil.ly/6xsAP">Apache Kafka</a></p>
</li>
<li>
<p><a href="https://oreil.ly/iE8aU">Apache Kafka: Consumer Configs</a></p>
</li>
<li>
<p><a href="https://oreil.ly/zFD5J">Vert.x Kafka client</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.5 Sending Messages to Apache Kafka"><div class="sect1" id="sending_message_apache">
<h1>15.5 Sending Messages to Apache Kafka</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128493413672">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="reactive programming model" data-secondary="sending messages to Apache Kafka" id="idm45128493412472"/><a data-type="indexterm" data-primary="Apache Kafka" data-secondary="sending messages to" id="idm45128493411416"/><a data-type="indexterm" data-primary="messaging" data-secondary="sending" id="idm45128493410472"/>You want to send messages to Apache Kafka.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128493409144">
<h2>Solution</h2>

<p>First, you’ll need to add the <code>quarkus-smallrye-reactive-messaging-kafka</code> extension to your project.
In this example, we’re also using SmallRye Mutiny, so add the <code>io.smallrye.reactive:mutiny</code> dependency as well.</p>

<p><a data-type="indexterm" data-primary="@Outgoing annotation" id="idm45128493406360"/>To send messages to Apache Kafka, use the <code>@Outgoing</code> annotation from Eclipse MicroProfile Reactive Messaging.</p>

<p>When you generate data to send to Apache Kafka, you will annotate your methods with <code>org.eclipse.microprofile.reactive.messaging.Outgoing</code>.
You can send either a stream of messages or a single message.
If you wish to publish a stream of messages, you must return a <code>org.reactivestreams.Publisher</code> or a <code>org.eclipse.microprofile.reactive.streams.operators.PublisherBuilder</code>.
If you wish to publish a single message, return a <code>org.eclipse.microprofile.reactive.messaging.Message</code>, <code>java.util.concurrent.CompletionStage</code>, or the corresponding type for your message payload.</p>

<p>The following is a basic example that creates a new ASCII character every second and sends it to the “letter-out” channel:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.time.Duration</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.concurrent.ThreadLocalRandom</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Multi</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.reactivestreams.Publisher</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">CharacterGenerator</code> <code class="o">{</code>
    <code class="nd">@Outgoing</code><code class="o">(</code><code class="s">"letter-out"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">Publisher</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">generate</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">()</code>
                <code class="o">.</code><code class="na">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">))</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">tick</code> <code class="o">-&gt;</code> <code class="o">{</code>
                    <code class="kd">final</code> <code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="n">ThreadLocalRandom</code><code class="o">.</code><code class="na">current</code><code class="o">().</code><code class="na">nextInt</code><code class="o">(</code><code class="mi">95</code><code class="o">);</code>
                    <code class="k">return</code> <code class="n">String</code><code class="o">.</code><code class="na">valueOf</code><code class="o">((</code><code class="kt">char</code><code class="o">)</code> <code class="o">(</code><code class="n">i</code> <code class="o">+</code> <code class="mi">32</code><code class="o">));</code>
                <code class="o">});</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>The value attribute for <code>@Outgoing</code> is required and is the name of the outbound channel.
In this example, we used SmallRye Mutiny, but you could use anything that returns an instance of <code>org.reactivestreams.Publisher</code>; a <code>Flowable</code> from RXJava2, for example, would also work well.</p>

<p>The following configuration is also necessary:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">mp.messaging.outgoing.letter-out.connector</code><code class="o">=</code><code class="s">smallrye-kafka</code>
<code class="na">mp.messaging.outgoing.letter-out.topic</code><code class="o">=</code><code class="s">ascii-char</code>
<code class="na">mp.messaging.outgoing.letter-out.value.serializer</code><code class="o">=</code><code class="s">org.apache.kafka.common\</code>
<code class="s">                                                    .serialization\</code>
<code class="s">                                                    .StringSerializer</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128493408840">
<h2>Discussion</h2>

<p>If you find yourself needing to send a message in an imperative way, you can use 
<span class="keep-together">an <code>org.eclipse.microprofile.reactive.messaging.Emitter</code></span> injected into your 
<span class="keep-together">application:</span></p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code> <code class="nd">@Channel</code><code class="o">(</code><code class="s">"price-create"</code><code class="o">)</code> <code class="n">Emitter</code><code class="o">&lt;</code><code class="n">Double</code><code class="o">&gt;</code> <code class="n">priceEmitter</code><code class="o">;</code>

<code class="nd">@POST</code>
<code class="nd">@Consumes</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">addPrice</code><code class="o">(</code><code class="n">Double</code> <code class="n">price</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">priceEmitter</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="n">price</code><code class="o">);</code>
<code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128493223032">
<h2>See Also</h2>

<p>For more information, check out the following:</p>

<ul>
<li>
<p><a data-type="xref" href="#reacting_apache_kafka_messages">Recipe 15.4</a></p>
</li>
<li>
<p><a href="https://oreil.ly/hZ9Bm">Apache Kafka: Producer Configs</a></p>
</li>
<li>
<p><a href="https://oreil.ly/QlGHK">SmallRye Reactive Messaging</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.6 Marshalling POJOs into/out of Kafka"><div class="sect1" id="idm45128493249976">
<h1>15.6 Marshalling POJOs into/out of Kafka</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128493164104">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Apache Kafka" data-secondary="marshalling POJOs into/out of" id="idm45128493162936"/><a data-type="indexterm" data-primary="marshalling" data-secondary="POJOs into/out of Kafka" id="idm45128493161944"/><a data-type="indexterm" data-primary="POJOs" id="idm45128493161000"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="marshalling POJOs into/out of Kafka" id="idm45128493160328"/>You want to serialize/deserialize POJOs into Kafka.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128493158904">
<h2>Solution</h2>

<p>Quarkus has capabilities to work with JSON Kafka messages; you will need to select either JSONB or Jackson as an implementation.
The required extensions are either <code>quarkus-resteasy-jsonb</code> or <code>quarkus-resteasy-jackson</code>, depending on your 
<span class="keep-together">preference</span>.</p>

<p><a data-type="indexterm" data-primary="deserializer" id="idm45128493155160"/>You will then need to create a deserializer.
The easiest way to do this is to extend either the <code>JsonDeserializer</code> for JSONB or the <code>ObjectMapperDeserializer</code> for Jackson.
Here is the <code>Book</code> class and its deserializer:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Book</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">author</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">Long</code> <code class="n">isbn</code><code class="o">;</code>

    <code class="kd">public</code> <code class="nf">Book</code><code class="o">()</code> <code class="o">{</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">author</code><code class="o">,</code> <code class="n">Long</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">author</code> <code class="o">=</code> <code class="n">author</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="JSON-B (Jakarta JSON Binding)" data-secondary="deserializer in" id="idm45128493151352"/>For JSONB, the deserializer looks like this:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.quarkus.kafka.client.serialization.JsonbDeserializer</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookDeserializer</code> <code class="kd">extends</code> <code class="n">JsonbDeserializer</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="nf">BookDeserializer</code><code class="o">()</code> <code class="o">{</code>
        <code class="kd">super</code><code class="o">(</code><code class="n">Book</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="Jackson" id="idm45128493050312"/>For Jackson, it is also just as easy:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">com</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.quarkus.kafka.client.serialization.ObjectMapperDeserializer</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookDeserializer</code> <code class="kd">extends</code> <code class="n">ObjectMapperDeserializer</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="nf">BookDeserializer</code><code class="o">()</code> <code class="o">{</code>
        <code class="kd">super</code><code class="o">(</code><code class="n">Book</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>The last bit you will need to do is to add your deserializer and the default serializer to the Quarkus configuration:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="c"># Configure the Kafka source (we read from it)</code>
<code class="na">mp.messaging.incoming.book-in.connector</code><code class="o">=</code><code class="s">smallrye-kafka</code>
<code class="na">mp.messaging.incoming.book-in.topic</code><code class="o">=</code><code class="s">book-in</code>
<code class="na">mp.messaging.incoming.book-in.value.deserializer</code><code class="o">=</code><code class="s">com.acme\</code>
<code class="s">                                                .kafka.BookDeserializer</code>

<code class="c"># Configure the Kafka sink (we write to it)</code>
<code class="na">mp.messaging.outgoing.book-out.connector</code><code class="o">=</code><code class="s">smallrye-kafka</code>
<code class="na">mp.messaging.outgoing.book-out.topic</code><code class="o">=</code><code class="s">book-out</code>
<code class="na">mp.messaging.outgoing.book-out.value.serializer</code><code class="o">=</code><code class="s">io.quarkus.kafka\</code>
<code class="s">                                                .client.serialization\</code>
<code class="s">                                                .JsonbSerializer</code></pre>

<p>Or, for Jackson:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="c"># Configure the Kafka source (we read from it)</code>
<code class="na">mp.messaging.incoming.book-in.connector</code><code class="o">=</code><code class="s">smallrye-kafka</code>
<code class="na">mp.messaging.incoming.book-in.topic</code><code class="o">=</code><code class="s">book-in</code>
<code class="na">mp.messaging.incoming.book-in.value.deserializer</code><code class="o">=</code><code class="s">com.acme\</code>
<code class="s">                                                .kafka.BookDeserializer</code>

<code class="c"># Configure the Kafka sink (we write to it)</code>
<code class="na">mp.messaging.outgoing.book-out.connector</code><code class="o">=</code><code class="s">smallrye-kafka</code>
<code class="na">mp.messaging.outgoing.book-out.topic</code><code class="o">=</code><code class="s">book-out</code>
<code class="na">mp.messaging.outgoing.book-out.value.serializer</code><code class="o">=</code><code class="s">io.quarkus.kafka.client\</code>
<code class="s">                                                .serialization\</code>
<code class="s">                                                .ObjectMapperSerializer</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128492919320">
<h2>Discussion</h2>

<p>If you are using JSONB and you do not wish to create a deserializer for each POJO sent over the wire, you can use the generic <code>io.vertx.kafka.client.serialization.JsonObjectDeserializer</code>.
The resulting object returned will be a <code>javax.json.JsonObject</code>.
Here, we have chosen to use the default serializers.</p>

<p>You can also create your own serializers if you need something more than the basic functionality.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.7 Using Kafka Streams API"><div class="sect1" id="kafka-streams-api-with-quarkus">
<h1>15.7 Using Kafka Streams API</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128492843032">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Apache Kafka Streams API" id="aks_ab"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="using Apache Kafka Streams API" id="rp_aks"/>You want to use the Kafka Streams API for querying data.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128492839176">
<h2>Solution</h2>

<p>The Apache Kafka extension in Quarkus (<code>quarkus-smallrye-reactive-messaging-kafka</code>) has integration with the Apache Kafka Streams API.
This example is a bit in depth and requires some additional moving parts.
You’ll of course need an Apache Kafka instance up and running.
We recommend you set up an Apache Kafka instance using Kubernetes if you don’t already have one available.
If you simply need something for development, you can use the following <em>docker-compose.yml</em> file:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">version</code><code class="p">:</code> <code class="s">'3.5'</code>

<code class="nt">services</code><code class="p">:</code>
  <code class="nt">zookeeper</code><code class="p">:</code>
    <code class="nt">image</code><code class="p">:</code> <code class="l-Scalar-Plain">strimzi/kafka:0.11.3-kafka-2.1.0</code>
    <code class="nt">command</code><code class="p">:</code> <code class="p-Indicator">[</code>
      <code class="s">"sh"</code><code class="p-Indicator">,</code> <code class="s">"-c"</code><code class="p-Indicator">,</code>
      <code class="s">"bin/zookeeper-server-start.sh</code><code class="nv"> </code><code class="s">config/zookeeper.properties"</code>
    <code class="p-Indicator">]</code>
    <code class="nt">ports</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="s">"2181:2181"</code>
    <code class="nt">environment</code><code class="p">:</code>
      <code class="nt">LOG_DIR</code><code class="p">:</code> <code class="l-Scalar-Plain">/tmp/logs</code>
    <code class="nt">networks</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">kafkastreams-network</code>
  <code class="nt">kafka</code><code class="p">:</code>
    <code class="nt">image</code><code class="p">:</code> <code class="l-Scalar-Plain">strimzi/kafka:0.11.3-kafka-2.1.0</code>
    <code class="nt">command</code><code class="p">:</code> <code class="p-Indicator">[</code>
      <code class="s">"sh"</code><code class="p-Indicator">,</code> <code class="s">"-c"</code><code class="p-Indicator">,</code>
      <code class="s">"bin/kafka-server-start.sh</code><code class="nv"> </code><code class="s">config/server.properties</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">listeners=$${KAFKA_LISTENERS}</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">advertised.listeners=$${KAFKA_ADVERTISED_LISTENERS}</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">zookeeper.connect=$${KAFKA_ZOOKEEPER_CONNECT}</code>
      <code class="s">--override</code><code class="nv"> </code><code class="s">num.partitions=$${KAFKA_NUM_PARTITIONS}"</code>
    <code class="p-Indicator">]</code>
    <code class="nt">depends_on</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">zookeeper</code>
    <code class="nt">ports</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="s">"9092:9092"</code>
    <code class="nt">environment</code><code class="p">:</code>
      <code class="nt">LOG_DIR</code><code class="p">:</code> <code class="s">"/tmp/logs"</code>
      <code class="nt">KAFKA_ADVERTISED_LISTENERS</code><code class="p">:</code> <code class="l-Scalar-Plain">PLAINTEXT://kafka:9092</code>
      <code class="nt">KAFKA_LISTENERS</code><code class="p">:</code> <code class="l-Scalar-Plain">PLAINTEXT://0.0.0.0:9092</code>
      <code class="nt">KAFKA_ZOOKEEPER_CONNECT</code><code class="p">:</code> <code class="l-Scalar-Plain">zookeeper:2181</code>
      <code class="nt">KAFKA_NUM_PARTITIONS</code><code class="p">:</code> <code class="l-Scalar-Plain">3</code>
    <code class="nt">networks</code><code class="p">:</code>
      <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">kafkastreams-network</code></pre>

<p>The next part in this solution is to create a producer that generates values and sends those generated values to a Kafka topic.
We’ll be using the idea of a jukebox for this.
Our jukebox will contain a number of songs and their artists, as well as the number 
<span class="keep-together">of times</span> a song was played.
Each of those will be sent to a different topic and then 
<span class="keep-together">aggregated</span> together by another service:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">.</code><code class="na">jukebox</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.time.Duration</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.time.Instant</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Arrays</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Collections</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.concurrent.ThreadLocalRandom</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Multi</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.smallrye.reactive.messaging.kafka.KafkaRecord</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.jboss.logging.Logger</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Jukebox</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">Logger</code> <code class="n">LOG</code> <code class="o">=</code> <code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">Jukebox</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>

    <code class="kd">private</code> <code class="n">ThreadLocalRandom</code> <code class="n">random</code> <code class="o">=</code> <code class="n">ThreadLocalRandom</code><code class="o">.</code><code class="na">current</code><code class="o">();</code>

    <code class="kd">private</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Song</code><code class="o">&gt;</code> <code class="n">songs</code> <code class="o">=</code> <code class="n">Collections</code><code class="o">.</code><code class="na">unmodifiableList</code><code class="o">(</code>
            <code class="n">Arrays</code><code class="o">.</code><code class="na">asList</code><code class="o">(</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">1</code><code class="o">,</code> <code class="s">"Confessions"</code><code class="o">,</code> <code class="s">"Usher"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">2</code><code class="o">,</code> <code class="s">"How Do I Live"</code><code class="o">,</code> <code class="s">"LeAnn Rimes"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">3</code><code class="o">,</code> <code class="s">"Physical"</code><code class="o">,</code> <code class="s">"Olivia Newton-John"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">4</code><code class="o">,</code> <code class="s">"You Light Up My Life"</code><code class="o">,</code> <code class="s">"Debby Boone"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">5</code><code class="o">,</code> <code class="s">"The Twist"</code><code class="o">,</code> <code class="s">"Chubby Checker"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">6</code><code class="o">,</code> <code class="s">"Mack the Knife"</code><code class="o">,</code> <code class="s">"Bobby Darin"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">7</code><code class="o">,</code> <code class="s">"Night Fever"</code><code class="o">,</code> <code class="s">"Bee Gees"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">8</code><code class="o">,</code> <code class="s">"Bette Davis Eyes"</code><code class="o">,</code> <code class="s">"Kim Carnes"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">9</code><code class="o">,</code> <code class="s">"Macarena (Bayside Boys Mix)"</code><code class="o">,</code> <code class="s">"Los Del Rio"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Song</code><code class="o">(</code><code class="mi">10</code><code class="o">,</code> <code class="s">"Yeah!"</code><code class="o">,</code> <code class="s">"Usher"</code><code class="o">)</code>
            <code class="o">)</code>
    <code class="o">);</code>

    <code class="nd">@Outgoing</code><code class="o">(</code><code class="s">"song-values"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">KafkaRecord</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">generate</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofMillis</code><code class="o">(</code><code class="mi">500</code><code class="o">))</code>
                <code class="o">.</code><code class="na">onOverflow</code><code class="o">().</code><code class="na">drop</code><code class="o">()</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">tick</code> <code class="o">-&gt;</code> <code class="o">{</code>
                   <code class="n">Song</code> <code class="n">s</code> <code class="o">=</code> <code class="n">songs</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">random</code><code class="o">.</code><code class="na">nextInt</code><code class="o">(</code><code class="n">songs</code><code class="o">.</code><code class="na">size</code><code class="o">()));</code>
                   <code class="kt">int</code> <code class="n">timesPlayed</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="na">nextInt</code><code class="o">(</code><code class="mi">1</code><code class="o">,</code> <code class="mi">100</code><code class="o">);</code>

                   <code class="n">LOG</code><code class="o">.</code><code class="na">infov</code><code class="o">(</code><code class="s">"song {0}, times played: {1,number}"</code><code class="o">,</code>
                           <code class="n">s</code><code class="o">.</code><code class="na">title</code><code class="o">,</code> <code class="n">timesPlayed</code><code class="o">);</code>
                   <code class="k">return</code> <code class="n">KafkaRecord</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">s</code><code class="o">.</code><code class="na">id</code><code class="o">,</code> <code class="n">Instant</code><code class="o">.</code><code class="na">now</code><code class="o">()</code>
                                               <code class="o">+</code> <code class="s">";"</code> <code class="o">+</code> <code class="n">timesPlayed</code><code class="o">);</code>
                <code class="o">});</code>
    <code class="o">}</code>

    <code class="nd">@Outgoing</code><code class="o">(</code><code class="s">"songs"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">KafkaRecord</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">songs</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">iterable</code><code class="o">(</code><code class="n">songs</code><code class="o">)</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">s</code> <code class="o">-&gt;</code> <code class="n">KafkaRecord</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">s</code><code class="o">.</code><code class="na">id</code><code class="o">,</code>
                        <code class="s">"{\n"</code> <code class="o">+</code>
                        <code class="s">"\t\"id\":\""</code><code class="o">+</code> <code class="n">s</code><code class="o">.</code><code class="na">id</code> <code class="o">+</code> <code class="s">"\",\n"</code> <code class="o">+</code>
                        <code class="s">"\t\"title\":\""</code> <code class="o">+</code> <code class="n">s</code><code class="o">.</code><code class="na">title</code> <code class="o">+</code> <code class="s">"\",\n"</code> <code class="o">+</code>
                        <code class="s">"\t\"artist\":\""</code> <code class="o">+</code> <code class="n">s</code><code class="o">.</code><code class="na">artist</code> <code class="o">+</code> <code class="s">"\"\n"</code> <code class="o">+</code>
                        <code class="s">"}"</code>
                        <code class="o">));</code>
    <code class="o">}</code>

    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">Song</code> <code class="o">{</code>
        <code class="kt">int</code> <code class="n">id</code><code class="o">;</code>
        <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
        <code class="n">String</code> <code class="n">artist</code><code class="o">;</code>

        <code class="kd">public</code> <code class="nf">Song</code><code class="o">(</code><code class="kt">int</code> <code class="n">id</code><code class="o">,</code> <code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">artist</code><code class="o">)</code> <code class="o">{</code>
            <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>
            <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
            <code class="k">this</code><code class="o">.</code><code class="na">artist</code> <code class="o">=</code> <code class="n">artist</code><code class="o">;</code>
        <code class="o">}</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Every 500 milliseconds, a new message containing the song and the times it was played, along with a time stamp, is sent out to the <code>songs</code> topic.
We’ll forgo the extra configuration—you can see steps for that in the <a data-type="xref" href="#sending_message_apache">Recipe 15.5</a> recipe.</p>

<p>Next, we need to build the pipeline.
The first step is to create some value holders:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">.</code><code class="na">jukebox</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Song</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">id</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">artist</code><code class="o">;</code>
<code class="o">}</code></pre>

<p>Now we need a holder for a play count:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">.</code><code class="na">jukebox</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.time.Instant</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PlayedCount</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">count</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">artist</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">id</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">;</code>

    <code class="kd">public</code> <code class="nf">PlayedCount</code><code class="o">(</code><code class="kt">int</code> <code class="n">id</code><code class="o">,</code> <code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">artist</code><code class="o">,</code>
                       <code class="kt">int</code> <code class="n">count</code><code class="o">,</code> <code class="n">Instant</code> <code class="n">timestamp</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">count</code> <code class="o">=</code> <code class="n">count</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">artist</code> <code class="o">=</code> <code class="n">artist</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">timestamp</code> <code class="o">=</code> <code class="n">timestamp</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Last, for the value holders is an object to track the aggregation of values while the messages are processed in the pipeline:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">.</code><code class="na">jukebox</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.math.BigDecimal</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.math.RoundingMode</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Aggregation</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">songId</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">songTitle</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">songArtist</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">count</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">sum</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">min</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">max</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kt">double</code> <code class="n">avg</code><code class="o">;</code>

    <code class="kd">public</code> <code class="n">Aggregation</code> <code class="nf">updateFrom</code><code class="o">(</code><code class="n">PlayedCount</code> <code class="n">playedCount</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">songId</code> <code class="o">=</code> <code class="n">playedCount</code><code class="o">.</code><code class="na">id</code><code class="o">;</code>
        <code class="n">songTitle</code> <code class="o">=</code> <code class="n">playedCount</code><code class="o">.</code><code class="na">title</code><code class="o">;</code>
        <code class="n">songArtist</code> <code class="o">=</code> <code class="n">playedCount</code><code class="o">.</code><code class="na">artist</code><code class="o">;</code>

        <code class="n">count</code><code class="o">++;</code>
        <code class="n">sum</code> <code class="o">+=</code> <code class="n">playedCount</code><code class="o">.</code><code class="na">count</code><code class="o">;</code>
        <code class="n">avg</code> <code class="o">=</code> <code class="n">BigDecimal</code><code class="o">.</code><code class="na">valueOf</code><code class="o">(</code><code class="n">sum</code> <code class="o">/</code> <code class="n">count</code><code class="o">)</code>
                <code class="o">.</code><code class="na">setScale</code><code class="o">(</code><code class="mi">1</code><code class="o">,</code> <code class="n">RoundingMode</code><code class="o">.</code><code class="na">HALF_UP</code><code class="o">).</code><code class="na">doubleValue</code><code class="o">();</code>
        <code class="n">min</code> <code class="o">=</code> <code class="n">Math</code><code class="o">.</code><code class="na">min</code><code class="o">(</code><code class="n">min</code><code class="o">,</code> <code class="n">playedCount</code><code class="o">.</code><code class="na">count</code><code class="o">);</code>
        <code class="n">max</code> <code class="o">=</code> <code class="n">Math</code><code class="o">.</code><code class="na">max</code><code class="o">(</code><code class="n">max</code><code class="o">,</code> <code class="n">playedCount</code><code class="o">.</code><code class="na">count</code><code class="o">);</code>

        <code class="k">return</code> <code class="k">this</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Now, on to the magic!
The last part of the puzzle is streaming the query implementation.
We only need to define a method that is a CDI producer that returns an Apache Kafka Stream <code>Topology</code>.
Quarkus will take care of the configuration, and the life cycle will take care of the Kafka Streams engine:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">kafka</code><code class="o">.</code><code class="na">jukebox</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.time.Instant</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.enterprise.inject.Produces</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.quarkus.kafka.client.serialization.JsonbSerde</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.common.serialization.Serdes</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.StreamsBuilder</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.Topology</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.kstream.Consumed</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.kstream.GlobalKTable</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.kstream.Materialized</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.kstream.Produced</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.state.KeyValueBytesStoreSupplier</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.apache.kafka.streams.state.Stores</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">TopologyProducer</code> <code class="o">{</code>
    <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">SONG_STORE</code> <code class="o">=</code> <code class="s">"song-store"</code><code class="o">;</code>

    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">SONG_TOPIC</code> <code class="o">=</code> <code class="s">"songs"</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">SONG_VALUES_TOPIC</code> <code class="o">=</code> <code class="s">"song-values"</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">SONG_AGG_TOPIC</code> <code class="o">=</code> <code class="s">"song-aggregated"</code><code class="o">;</code>

    <code class="nd">@Produces</code>
    <code class="kd">public</code> <code class="n">Topology</code> <code class="nf">buildTopology</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">StreamsBuilder</code> <code class="n">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StreamsBuilder</code><code class="o">();</code>

        <code class="n">JsonbSerde</code><code class="o">&lt;</code><code class="n">Song</code><code class="o">&gt;</code> <code class="n">songSerde</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JsonbSerde</code><code class="o">&lt;&gt;(</code><code class="n">Song</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>
        <code class="n">JsonbSerde</code><code class="o">&lt;</code><code class="n">Aggregation</code><code class="o">&gt;</code> <code class="n">aggregationSerde</code> <code class="o">=</code>
                <code class="k">new</code> <code class="n">JsonbSerde</code><code class="o">&lt;&gt;(</code><code class="n">Aggregation</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>

        <code class="n">KeyValueBytesStoreSupplier</code> <code class="n">storeSupplier</code> <code class="o">=</code>
                <code class="n">Stores</code><code class="o">.</code><code class="na">persistentKeyValueStore</code><code class="o">(</code><code class="n">SONG_STORE</code><code class="o">);</code>

        <code class="n">GlobalKTable</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">,</code> <code class="n">Song</code><code class="o">&gt;</code> <code class="n">songs</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="na">globalTable</code><code class="o">(</code><code class="n">SONG_TOPIC</code><code class="o">,</code>
                <code class="n">Consumed</code><code class="o">.</code><code class="na">with</code><code class="o">(</code><code class="n">Serdes</code><code class="o">.</code><code class="na">Integer</code><code class="o">(),</code> <code class="n">songSerde</code><code class="o">));</code>

        <code class="n">builder</code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="n">SONG_VALUES_TOPIC</code><code class="o">,</code> <code class="n">Consumed</code><code class="o">.</code><code class="na">with</code><code class="o">(</code><code class="n">Serdes</code><code class="o">.</code><code class="na">Integer</code><code class="o">(),</code>
                <code class="n">Serdes</code><code class="o">.</code><code class="na">String</code><code class="o">()))</code>
                <code class="o">.</code><code class="na">join</code><code class="o">(</code>
                        <code class="n">songs</code><code class="o">,</code>
                        <code class="o">(</code><code class="n">songId</code><code class="o">,</code> <code class="n">timestampAndValue</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">songId</code><code class="o">,</code>
                        <code class="o">(</code><code class="n">timestampAndValue</code><code class="o">,</code> <code class="n">song</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="o">{</code>
                            <code class="n">String</code><code class="o">[]</code> <code class="n">parts</code> <code class="o">=</code> <code class="n">timestampAndValue</code><code class="o">.</code><code class="na">split</code><code class="o">(</code><code class="s">";"</code><code class="o">);</code>
                            <code class="k">return</code> <code class="k">new</code> <code class="nf">PlayedCount</code><code class="o">(</code><code class="n">song</code><code class="o">.</code><code class="na">id</code><code class="o">,</code> <code class="n">song</code><code class="o">.</code><code class="na">title</code><code class="o">,</code>
                                    <code class="n">song</code><code class="o">.</code><code class="na">artist</code><code class="o">,</code>
                                    <code class="n">Integer</code><code class="o">.</code><code class="na">parseInt</code><code class="o">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">1</code><code class="o">]),</code>
                                    <code class="n">Instant</code><code class="o">.</code><code class="na">parse</code><code class="o">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">0</code><code class="o">]));</code>
                        <code class="o">}</code>
                <code class="o">)</code>
                <code class="o">.</code><code class="na">groupByKey</code><code class="o">()</code>
                <code class="o">.</code><code class="na">aggregate</code><code class="o">(</code>
                        <code class="nl">Aggregation:</code><code class="o">:</code><code class="k">new</code><code class="o">,</code>
                        <code class="o">(</code><code class="n">songId</code><code class="o">,</code> <code class="n">value</code><code class="o">,</code> <code class="n">aggregation</code><code class="o">)</code> <code class="o">-&gt;</code>
                                <code class="n">aggregation</code><code class="o">.</code><code class="na">updateFrom</code><code class="o">(</code><code class="n">value</code><code class="o">),</code>
                        <code class="n">Materialized</code><code class="o">.&lt;</code><code class="n">Integer</code><code class="o">,</code> <code class="n">Aggregation</code><code class="o">&gt;</code> <code class="n">as</code><code class="o">(</code><code class="n">storeSupplier</code><code class="o">)</code>
                            <code class="o">.</code><code class="na">withKeySerde</code><code class="o">(</code><code class="n">Serdes</code><code class="o">.</code><code class="na">Integer</code><code class="o">())</code>
                            <code class="o">.</code><code class="na">withValueSerde</code><code class="o">(</code><code class="n">aggregationSerde</code><code class="o">)</code>
                <code class="o">)</code>
                <code class="o">.</code><code class="na">toStream</code><code class="o">()</code>
                <code class="o">.</code><code class="na">to</code><code class="o">(</code>
                        <code class="n">SONG_AGG_TOPIC</code><code class="o">,</code>
                        <code class="n">Produced</code><code class="o">.</code><code class="na">with</code><code class="o">(</code><code class="n">Serdes</code><code class="o">.</code><code class="na">Integer</code><code class="o">(),</code> <code class="n">aggregationSerde</code><code class="o">)</code>
                <code class="o">);</code>
        <code class="k">return</code> <code class="n">builder</code><code class="o">.</code><code class="na">build</code><code class="o">();</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Explaining all of what is happening is beyond the scope of this recipe, but the Kafka Streams site, linked to in <a data-type="xref" href="#see-also-15-7">“See Also”</a>, has entire tutorials and videos dedicated to this topic.
In a nutshell, this connects to the previous <code>songs</code> and <code>song-values</code> topic then merges the values together based on song ID.
The play count values then have some aggregation performed on them, and the output is sent back to Apache Kafka on a new topic.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128492838584">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="kafkacat utility" id="idm45128491758936"/>We recommend using the <code>kafkacat</code> utility for seeing the messages as they are sent to the topics.</p>
<div data-type="important"><h6>Important</h6>
<p>In both of the examples with Apache Kafka we connected with only a single client and machine.
This is not a limitation of Quarkus but something we have done to help simplify the examples.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="see-also-15-7">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="aks_ab" id="idm45128491416440"/><a data-type="indexterm" data-primary="" data-startref="rp_aks" id="idm45128491415464"/>For more information, visit the following websites:</p>

<ul>
<li>
<p><a href="https://oreil.ly/gNAof">Apache Kafka: Kafka Streams</a></p>
</li>
<li>
<p><a href="https://oreil.ly/bgIT_">Confluent: kafkacat Utility</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.8 Using AMQP with Quarkus"><div class="sect1" id="idm45128491411000">
<h1>15.8 Using AMQP with Quarkus</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128491410024">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="reactive programming model" data-secondary="using AMQP with Quarkus" id="idm45128491408792"/><a data-type="indexterm" data-primary="AMQP (Advanced Message Queuing Protocol)" id="idm45128491407800"/>You want to use AMQP (Advanced Message Queuing Protocol) as the messaging 
<span class="keep-together">system</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128491405992">
<h2>Solution</h2>

<p>Use the <code>quarkus-smallrye-reactive-messaging-amqp</code> extension.</p>

<p><a data-type="indexterm" data-primary="Eclipse MicroProfile Reactive Messaging" id="idm45128491403496"/>Just like the Kafka integration, Quarkus uses Eclipse MicroProfile Reactive Messaging as the facade around all messaging interactions.
By adding the <code>quarkus-smallrye-reactive-messaging-amqp</code> extension to your project, you will get the SmallRye AMQP connector and associated dependencies.
This will allow <code>@Outbound</code>, <code>@Inbound</code>, <code>@Broadcast</code>, and other Eclipse MicroProfile Reactive Messaging annotations and concepts to work with AMQP.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>These annotations work with AMQP 1.0, not 0.9.x.</p>
</div>

<p>You will also need to set the channel connector to <code>smallrye-amqp</code> in the <em>application.properties</em> file.
Remember that the syntax for those configurations is the 
<span class="keep-together">following</span>:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">mp.messaging.[outgoing|incoming].[channel-name].property</code><code class="o">=</code><code class="s">value</code></pre>

<p>You can also set the username and password for AMQP connections globally via the following:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">amqp-username</code><code class="o">=</code><code class="s">[my-username]</code>
<code class="na">amqp-password</code><code class="o">=</code><code class="s">[my-secret-password]</code></pre>

<p>Or, if you need to talk to different instances with their own credentials, you may set those on a per-channel basis.
Please see the SmallRye documentation for further properties.</p>

<p>The code from <a data-type="xref" href="#sending_message_apache">Recipe 15.5</a> will work exactly the same with AMQP as it will with Kafka, assuming that the channels are the same name and that the rest of the AMQP setup and connection information are correct.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128491405336">
<h2>See Also</h2>

<p>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/ViPyo">SmallRye Reactive Messaging: AMQP 1.0</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.9 Using MQTT"><div class="sect1" id="idm45128491387640">
<h1>15.9 Using MQTT</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128491386600">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="MQTT (MQ Telemetry Transport)" id="idm45128491385368"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="using MQTT" id="idm45128491384696"/>You want to use MQTT (MQ Telemetry Transport) as the messaging system.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128491383400">
<h2>Solution</h2>

<p>Use the <code>quarkus-smallrye-reactive-messaging-mqtt</code> extension.</p>

<p><a data-type="indexterm" data-primary="Eclipse MicroProfile Reactive Messaging" id="idm45128491353176"/>Just like the Kafka and AMQP integration, Quarkus uses Eclipse MicroProfile Reactive Messaging as the facade around all messaging interactions.
By adding the <code>quarkus-smallrye-reactive-messaging-mqtt</code> extension to your project, you will get the SmallRye MQTT connector and associated dependencies.
This will allow <code>@Outbound</code>, <code>@Inbound</code>, <code>@Broadcast</code>, and other Eclipse MicroProfile Reactive Messaging annotations and concepts to work with MQTT.</p>

<p>You will also need to set the channel connector to <code>smallrye-mqtt</code> in the <em>application.properties</em> file.
Remember, the syntax for those configurations is the following:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">mp.messaging.[outgoing|incoming].[channel-name].property</code><code class="o">=</code><code class="s">value</code></pre>

<p>Connection and credentials can be set on a channel-by-channel basis.
Please see the SmallRye documentation for further properties.</p>

<p>The code from <a data-type="xref" href="#reacting_apache_kafka_messages">Recipe 15.4</a> will work exactly the same with MQTT as it will with Kafka, assuming that the channels have the same name and that the rest of the MQTT setup is correct along with the connection information.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128491341528">
<h2>Discussion</h2>

<p>There is also support for acting as an MQTT server; however, it is not a fully featured MQTT server.
For example, it will handle only publish requests and their acknowledgment; it does not handle subscription requests.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128491348216">
<h2>See Also</h2>

<p>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/QmkVY">SmallRye Reactive Messaging: MQTT</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.10 Query Using Reactive SQL"><div class="sect1" id="idm45128491344824">
<h1>15.10 Query Using Reactive SQL</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128491322344">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="query, using Reactive SQL" id="idm45128491321144"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="query using Reactive SQL" id="idm45128491320472"/>You want to query data using the PostgreSQL reactive client.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128491319160">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="Vert.x Reactive SQL" id="idm45128491317592"/>Quarkus integrates with the Vert.x Reactive SQL client, which works with MySQL/MariaDB, and PostgreSQL.
In this recipe, we will be demonstrating this with PostgreSQL; in the following recipe we will use MariaDB.</p>

<p>Naturally, you will need to add an extension to utilize the reactive SQL client.
Currently, there are two of them: <code>quarkus-reactive-pg-client</code> and <code>quarkus-reactive-mysql-client</code>, respective to the two databases.
You will also need to ensure that the following extensions are in your project (if you are using JAX-RS):</p>

<ul>
<li>
<p><code>quarkus-resteasy</code></p>
</li>
<li>
<p><code>quarkus-resteasy-jsonb</code> or <code>quarkus-resteasy-jackson</code></p>
</li>
<li>
<p><code>quarkus-resteasy-mutiny</code></p>
</li>
</ul>

<p>Just as with any data store, you will need to configure access:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.db-kind</code><code class="o">=</code><code class="s">postgresql</code>
<code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">quarkus_test</code>
<code class="na">quarkus.datasource.password</code><code class="o">=</code><code class="s">quarkus_test</code>
<code class="na">quarkus.datasource.reactive.url</code><code class="o">=</code><code class="s">postgresql://localhost:5432/quarkus_test</code></pre>

<p>Now you can use the client:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">pg</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.smallrye.mutiny.Multi</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.vertx.mutiny.pgclient.PgPool</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.vertx.mutiny.sqlclient.Row</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.vertx.mutiny.sqlclient.Tuple</code><code class="o">;</code><code>
</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Book</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Long</code><code> </code><code class="n">id</code><code class="o">;</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">Book</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">Book</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">title</code><code class="o">,</code><code> </code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">title</code><code> </code><code class="o">=</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">isbn</code><code> </code><code class="o">=</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">Book</code><code class="o">(</code><code class="n">Long</code><code> </code><code class="n">id</code><code class="o">,</code><code> </code><code class="n">String</code><code> </code><code class="n">title</code><code class="o">,</code><code> </code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">id</code><code> </code><code class="o">=</code><code> </code><code class="n">id</code><code class="o">;</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">title</code><code> </code><code class="o">=</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">isbn</code><code> </code><code class="o">=</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Book</code><code> </code><code class="nf">from</code><code class="o">(</code><code class="n">Row</code><code> </code><code class="n">row</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Book</code><code class="o">(</code><code class="n">row</code><code class="o">.</code><code class="na">getLong</code><code class="o">(</code><code class="s">"id"</code><code class="o">)</code><code class="o">,</code><code>
</code><code>                        </code><code class="n">row</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="s">"title"</code><code class="o">)</code><code class="o">,</code><code>
</code><code>                        </code><code class="n">row</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Multi</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code><code> </code><code class="nf">findAll</code><code class="o">(</code><code class="n">PgPool</code><code> </code><code class="n">client</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">client</code><code class="o">.</code><code class="na">query</code><code class="o">(</code><code class="s">"SELECT id, title, isbn "</code><code> </code><code class="o">+</code><code>
</code><code>                            </code><code class="s">"FROM books ORDER BY title ASC"</code><code class="o">)</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                </code><code class="o">.</code><code class="na">onItem</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">produceMulti</code><code class="o">(</code><code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">:</code><code class="o">:</code><code class="n">iterable</code><code class="o">)</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-2" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Book:</code><code class="o">:</code><code class="n">from</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-3" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Query the database, returning a <code>Uni&lt;RowSet&lt;Row&gt;&gt;</code></p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-2" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Create a <code>Multi&lt;Row&gt;</code> once the query returns</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-3" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Map each row into a <code>Book</code> instance</p></dd>
</dl>

<p>To complete the exercise, you can use the RESTful endpoint:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">pg</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.annotation.PostConstruct</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Consumes</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Produces</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.Response</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.vertx.mutiny.pgclient.PgPool</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.config.inject.ConfigProperty</code><code class="o">;</code>

<code class="nd">@Path</code><code class="o">(</code><code class="s">"/books"</code><code class="o">)</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>
<code class="nd">@Consumes</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookResource</code> <code class="o">{</code>

    <code class="nd">@Inject</code>
    <code class="n">PgPool</code> <code class="n">client</code><code class="o">;</code>
    <code class="nd">@GET</code>
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">get</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Book</code><code class="o">.</code><code class="na">findAll</code><code class="o">(</code><code class="n">client</code><code class="o">)</code>
                <code class="o">.</code><code class="na">collectItems</code><code class="o">().</code><code class="na">asList</code><code class="o">()</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Response:</code><code class="o">:</code><code class="n">ok</code><code class="o">)</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">ResponseBuilder</code><code class="o">::</code><code class="n">build</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128491318568">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="preparedQuery method" id="idm45128490626024"/>You can also use prepared queries by using the <code>preparedQuery</code> method and the <code>Tuple</code> class:</p>

<pre data-type="programlisting" data-code-language="java"><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Uni</code><code class="o">&lt;</code><code class="n">Boolean</code><code class="o">&gt;</code><code> </code><code class="nf">delete</code><code class="o">(</code><code class="n">PgPool</code><code> </code><code class="n">client</code><code class="o">,</code><code> </code><code class="n">Long</code><code> </code><code class="n">id</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">client</code><code class="o">.</code><code class="na">preparedQuery</code><code class="o">(</code><code class="s">"DELETE FROM books "</code><code> </code><code class="o">+</code><code>
</code><code>                                    </code><code class="s">"WHERE id = $1"</code><code class="o">,</code><code> </code><code class="n">Tuple</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">id</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">rowSet</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">rowSet</code><code class="o">.</code><code class="na">rowCount</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="mi">1</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO6-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO6-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Using metadata, return from the <code>RowSet</code> instance to verify the row was deleted</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128490273736">
<h2>See Also</h2>

<p>The underlying implementation can be found at <a href="https://oreil.ly/0nuDM">Vert.x: Reactive PostgreSQL Client</a>.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.11 Insert Using Reactive SQL Client"><div class="sect1" id="idm45128490278360">
<h1>15.11 Insert Using Reactive SQL Client</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128490281192">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="reactive programming model" data-secondary="inserting using Reactive SQL" id="idm45128490279992"/><a data-type="indexterm" data-primary="Vert.x Reactive SQL" id="idm45128490282888"/>You want to insert data using the MySQL reactive client.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128490906856">
<h2>Solution</h2>

<p>Similar to the previous recipe using PostgreSQL, data insertion can be done with a reactive MySQL client.
The same extensions need to be used to changed the <code>quarkus-reactive-pg-client</code> for <code>quarkus-reactive-mysql-client</code>:</p>

<ul>
<li>
<p><code>quarkus-resteasy</code></p>
</li>
<li>
<p><code>quarkus-resteasy-jsonb</code> or <code>quarkus-resteasy-jackson</code></p>
</li>
<li>
<p><code>quarkus-resteasy-mutiny</code></p>
</li>
</ul>

<p>You will, of course, need to set up the datasource:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.db-kind</code><code class="o">=</code><code class="s">mysql</code>
<code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">quarkus_test</code>
<code class="na">quarkus.datasource.password</code><code class="o">=</code><code class="s">quarkus_test</code>
<code class="na">quarkus.datasource.reactive.url</code><code class="o">=</code><code class="s">mysql://localhost:3306/quarkus_test</code></pre>

<p>You will see very similar themes in the <code>Book.save</code> method as you did in the previous recipe:</p>

<pre data-type="programlisting" data-code-language="java"><code>    </code><code class="kd">public</code><code> </code><code class="n">Uni</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code><code> </code><code class="nf">save</code><code class="o">(</code><code class="n">MySQLPool</code><code> </code><code class="n">client</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">String</code><code> </code><code class="n">query</code><code> </code><code class="o">=</code><code> </code><code class="s">"INSERT INTO books (title,isbn) VALUES (?,?)"</code><code class="o">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">client</code><code class="o">.</code><code class="na">preparedQuery</code><code class="o">(</code><code class="n">query</code><code class="o">,</code><code> </code><code class="n">Tuple</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">title</code><code class="o">,</code><code> </code><code class="n">isbn</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">rowSet</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">rowSet</code><code>
</code><code>                        </code><code class="o">.</code><code class="na">property</code><code class="o">(</code><code class="n">MySQLClient</code><code class="o">.</code><code class="na">LAST_INSERTED_ID</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO7-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO7-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Use the property from the <code>RowSet</code> to get the inserted ID.</p></dd>
</dl>

<p>By now, you should be able to put together the appropriate POST method for the <code>BookResource</code> endpoint, calling the <code>save</code> method on the new <code>Book</code> instance received from the user.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128490765048">
<h2>See Also</h2>

<p>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/UHxfh">Vert.x: Reactive MySQL Client</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.12 Using the Reactive MongoDB Client"><div class="sect1" id="using-reactive-mongodb-client-recipe">
<h1>15.12 Using the Reactive MongoDB Client</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128490805208">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="reactive programming model" data-secondary="using Reactive MongoDB client" id="idm45128490803976"/><a data-type="indexterm" data-primary="Reactive MongoDB client" id="idm45128490807064"/>You want to use the Reactive MongoDB client.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128490811992">
<h2>Solution</h2>

<p>The MongoDB Quarkus extension also includes a reactive MongoDB client.
As was shown in <a data-type="xref" href="ch07.xhtml#working_mongodb">Recipe 7.21</a>, you will need to add the <code>quarkus-mongodb-client</code>.
You will also need to add the following extensions to your project<a data-type="indexterm" data-primary="quarkus-resteasy-mutiny extension" id="idm45128490808600"/><a data-type="indexterm" data-primary="quarkus-smallrye-context-propagation extension" id="idm45128490816312"/>:</p>
<dl>
<dt><code>quarkus-resteasy-mutiny</code></dt>
<dd>
<p>To return and interact with Mutiny for endpoint returns.</p>
</dd>
<dt><code>quarkus-smallrye-context-propagation</code></dt>
<dd>
<p>This allows things like injection and transactions to work with async code.</p>
</dd>
</dl>

<p>The rest of the integration is pretty straightforward.
Here are the versions of the service and the resource classes from the previous MongoDB recipe, but written in a reactive way:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">mongodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Objects</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">com.mongodb.client.model.Filters</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.mongodb.reactive.ReactiveMongoClient</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.mongodb.reactive.ReactiveMongoCollection</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.bson.Document</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">ReactiveBookService</code> <code class="o">{</code>
    <code class="nd">@Inject</code>
    <code class="n">ReactiveMongoClient</code> <code class="n">mongoClient</code><code class="o">;</code>

    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;&gt;</code> <code class="nf">list</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">getCollection</code><code class="o">().</code><code class="na">find</code><code class="o">()</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Book:</code><code class="o">:</code><code class="n">from</code><code class="o">).</code><code class="na">collectItems</code><code class="o">().</code><code class="na">asList</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">add</code><code class="o">(</code><code class="n">Book</code> <code class="n">b</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">Document</code> <code class="n">doc</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Document</code><code class="o">()</code>
                <code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">isbn</code><code class="o">)</code>
                <code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"title"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">title</code><code class="o">)</code>
                <code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"authors"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">authors</code><code class="o">);</code>

        <code class="k">return</code> <code class="nf">getCollection</code><code class="o">().</code><code class="na">insertOne</code><code class="o">(</code><code class="n">doc</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">findSingle</code><code class="o">(</code><code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Objects</code><code class="o">.</code><code class="na">requireNonNull</code><code class="o">(</code><code class="n">getCollection</code><code class="o">()</code>
                <code class="o">.</code><code class="na">find</code><code class="o">(</code><code class="n">Filters</code><code class="o">.</code><code class="na">eq</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code> <code class="n">isbn</code><code class="o">))</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Book:</code><code class="o">:</code><code class="n">from</code><code class="o">))</code>
                <code class="o">.</code><code class="na">toUni</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="kd">private</code> <code class="n">ReactiveMongoCollection</code><code class="o">&lt;</code><code class="n">Document</code><code class="o">&gt;</code> <code class="nf">getCollection</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">mongoClient</code><code class="o">.</code><code class="na">getDatabase</code><code class="o">(</code><code class="s">"book"</code><code class="o">)</code>
                <code class="o">.</code><code class="na">getCollection</code><code class="o">(</code><code class="s">"book"</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Besides imports and moving from an imperative to a reactive approach with Mutiny, nothing has changed.
The same can be seen for the REST endpoint:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">mongodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Consumes</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.POST</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.PathParam</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Produces</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.Response</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>

<code class="nd">@Path</code><code class="o">(</code><code class="s">"/reactive_books"</code><code class="o">)</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>
<code class="nd">@Consumes</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">ReactiveBookResource</code> <code class="o">{</code>
    <code class="nd">@Inject</code>
    <code class="n">ReactiveBookService</code> <code class="n">service</code><code class="o">;</code>

    <code class="nd">@GET</code>
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;&gt;</code> <code class="nf">getAll</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">list</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="nd">@GET</code>
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"{isbn}"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">getSingle</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">)</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">findSingle</code><code class="o">(</code><code class="n">isbn</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@POST</code>
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">add</code><code class="o">(</code><code class="n">Book</code> <code class="n">b</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">b</code><code class="o">).</code><code class="na">onItem</code><code class="o">().</code><code class="na">ignore</code><code class="o">()</code>
                <code class="o">.</code><code class="na">andSwitchTo</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">getAll</code><code class="o">)</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">books</code> <code class="o">-&gt;</code> <code class="n">Response</code><code class="o">.</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">CREATED</code><code class="o">)</code>
                                      <code class="o">.</code><code class="na">entity</code><code class="o">(</code><code class="n">books</code><code class="o">).</code><code class="na">build</code><code class="o">());</code>
    <code class="o">}</code>
<code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128491207816">
<h2>See Also</h2>

<p>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/bd9hA">Quarkus: Context Propagation in Quarkus</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="15.13 Using the Reactive Neo4j Client"><div class="sect1" id="idm45128489992136">
<h1>15.13 Using the Reactive Neo4j Client</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128489991160">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Reactive Neo4j client" id="idm45128489989960"/><a data-type="indexterm" data-primary="reactive programming model" data-secondary="using Reactive Neo4j client" id="idm45128489989256"/>You want to use the reactive Neo4j client.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128489987928">
<h2>Solution</h2>

<p>The Neo4j Quarkus extension has support for the reactive driver.</p>

<p>You will need to use version 4 or higher of Neo4j to go fully reactive.
You will also need to add the <code>quarkus-resteasy-mutiny</code> extension to your project.
Following up from <a data-type="xref" href="ch07.xhtml#neo4j_with_quarkus">Recipe 7.23</a>, there isn’t much that has changed, besides using an <code>RxSession</code> from the driver and using Mutiny<a data-type="indexterm" data-primary="" data-startref="react_ch" id="idm45128489984232"/>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">neo4j</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.stream.Collectors</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.inject.Inject</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Consumes</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.GET</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.POST</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Path</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Produces</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.core.Response</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.smallrye.mutiny.Multi</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.neo4j.driver.Driver</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.neo4j.driver.Record</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.neo4j.driver.Value</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.neo4j.driver.Values</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.neo4j.driver.reactive.RxResult</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.reactivestreams.Publisher</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/reactivebooks"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code><code>
</code><code class="nd">@Consumes</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">ReactiveBookResource</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="nd">@Inject</code><code>
</code><code>    </code><code class="n">Driver</code><code> </code><code class="n">driver</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">SERVER_SENT_EVENTS</code><code class="o">)</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-1" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Publisher</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code> </code><code class="nf">getAll</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">resource</code><code class="o">(</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-2" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                </code><code class="nl">driver:</code><code class="o">:</code><code class="n">rxSession</code><code class="o">,</code><code>
</code><code>                </code><code class="n">rxSession</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">rxSession</code><code class="o">.</code><code class="na">readTransaction</code><code class="o">(</code><code class="n">tx</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-3" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>                    </code><code class="n">RxResult</code><code> </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">tx</code><code class="o">.</code><code class="na">run</code><code class="o">(</code><code class="s">"MATCH (b:Book) RETURN "</code><code> </code><code class="o">+</code><code>
</code><code>                                             </code><code class="s">"b ORDER BY b.title"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                    </code><code class="k">return</code><code> </code><code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">publisher</code><code class="o">(</code><code class="n">result</code><code class="o">.</code><code class="na">records</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                            </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Record:</code><code class="o">:</code><code class="n">values</code><code class="o">)</code><code>
</code><code>                            </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">values</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">values</code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Value:</code><code class="o">:</code><code class="n">asNode</code><code class="o">)</code><code>
</code><code>                                                          </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Book:</code><code class="o">:</code><code class="n">from</code><code class="o">)</code><code>
</code><code>                                                          </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Book:</code><code class="o">:</code><code class="n">toJson</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                            </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">bookStream</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code>
</code><code>                                    </code><code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">(</code><code class="n">bookStream</code><code>
</code><code>                                            </code><code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">Collectors</code><code class="o">.</code><code class="na">toList</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                                    </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                </code><code class="o">}</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">withFinalizer</code><code class="o">(</code><code class="n">rxSession</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-4" href="#callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                    </code><code class="k">return</code><code> </code><code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">publisher</code><code class="o">(</code><code class="n">rxSession</code><code class="o">.</code><code class="na">close</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                </code><code class="o">}</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@POST</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Publisher</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code> </code><code class="nf">create</code><code class="o">(</code><code class="n">Book</code><code> </code><code class="n">b</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">resource</code><code class="o">(</code><code>
</code><code>                </code><code class="nl">driver:</code><code class="o">:</code><code class="n">rxSession</code><code class="o">,</code><code>
</code><code>                </code><code class="n">rxSession</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">rxSession</code><code class="o">.</code><code class="na">writeTransaction</code><code class="o">(</code><code class="n">tx</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code>
</code><code>                    </code><code class="n">String</code><code> </code><code class="n">query</code><code> </code><code class="o">=</code><code> </code><code class="s">"CREATE "</code><code> </code><code class="o">+</code><code>
</code><code>                                   </code><code class="s">"(b:Book {title: $title, isbn: $isbn,"</code><code> </code><code class="o">+</code><code>
</code><code>                                   </code><code class="s">" authors: $authors}) "</code><code> </code><code class="o">+</code><code>
</code><code>                                   </code><code class="s">"RETURN b"</code><code class="o">;</code><code>
</code><code>                    </code><code class="n">RxResult</code><code> </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">tx</code><code class="o">.</code><code class="na">run</code><code class="o">(</code><code class="n">query</code><code class="o">,</code><code>
</code><code>                            </code><code class="n">Values</code><code class="o">.</code><code class="na">parameters</code><code class="o">(</code><code class="s">"title"</code><code class="o">,</code><code> </code><code class="n">b</code><code class="o">.</code><code class="na">title</code><code class="o">,</code><code>
</code><code>                                    </code><code class="s">"isbn"</code><code class="o">,</code><code> </code><code class="n">b</code><code class="o">.</code><code class="na">isbn</code><code class="o">,</code><code> </code><code class="s">"authors"</code><code class="o">,</code><code> </code><code class="n">b</code><code class="o">.</code><code class="na">authors</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                    </code><code class="k">return</code><code> </code><code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">publisher</code><code class="o">(</code><code class="n">result</code><code class="o">.</code><code class="na">records</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>                            </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">record</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">(</code><code class="n">record</code><code>
</code><code>                                    </code><code class="o">.</code><code class="na">asMap</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>                </code><code class="o">}</code><code class="o">)</code><code>
</code><code>        </code><code class="o">)</code><code class="o">.</code><code class="na">withFinalizer</code><code class="o">(</code><code class="n">rxSession</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">publisher</code><code class="o">(</code><code class="n">rxSession</code><code class="o">.</code><code class="na">close</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-1" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-3"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Get an <code>RxSession</code> from the driver</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-2" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Use Mutiny to interact with the ReactiveStreams <code>Publisher</code></p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-3" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-1"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Stream the results back to the user</p></dd>
<dt><a class="co" id="callout_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-4" href="#co_working_with_a_reactive___span_class__keep_together__programming_model__span__CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Close the session at the very end</p></dd>
</dl>
</div></section>





</div></section>







</div></section></div>



  </body></html>