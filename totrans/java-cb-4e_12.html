<html><head></head><body><section data-pdf-bookmark="Chapter 12. Network Clients" data-type="chapter" epub:type="chapter"><div class="chapter" id="javacook-netclient">&#13;
<h1><span class="label">Chapter 12. </span>Network Clients</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.0 Introduction" data-type="sect1"><div class="sect1" id="javacook-netclient-intro">&#13;
<h1>12.0 Introduction</h1>&#13;
&#13;
<p><a data-primary="networking" data-type="indexterm" id="net_ch"/><a data-primary="Java" data-secondary="networking in" data-type="indexterm" id="jav_net"/><a data-primary="networking" data-secondary="in Java" data-type="indexterm" id="net_jav"/>Java can be used to write many types of networked programs. In traditional socket-based&#13;
code, the programmer is responsible for structuring the interaction between the client and&#13;
server; the TCP <em>socket code</em> simply ensures that whatever data you send gets to the other end.&#13;
In higher-level types, such as HTTP, RMI, CORBA, and EJB, the software takes over&#13;
more control. Sockets are often used for connecting to legacy servers;&#13;
if you were writing a new application from scratch, you’d be better off using a&#13;
higher-level service.</p>&#13;
&#13;
<p>It may be helpful to compare sockets with the telephone system. Telephones were originally&#13;
used for analog voice traffic, which is pretty unstructured. Then it began to be used for&#13;
some layered applications; the first widely popular one was facsimile transmission, or&#13;
fax. Where would fax be without the widespread availability of voice telephony? The second&#13;
wildly popular layered application historically was dial-up TCP/IP. This coexisted with the web to become&#13;
popular as a mass-market service. Where would dial-up IP be without widely deployed voice&#13;
lines? And where would the internet be without dial-up IP?&#13;
Fax and dial-up are mostly gone now, but they paved the way for&#13;
your smartphone’s networked ability, which is what makes it useful&#13;
(and even seductive as a time sink).</p>&#13;
&#13;
<p>Sockets are layered like that too. The web, RMI, JDBC, CORBA, and EJB are all layered on top of sockets.&#13;
HTTP is now the most common protocol and should generally be used for new applications&#13;
when all you want is to get data from point b to point a.</p>&#13;
&#13;
<p>Ever since the alpha release of Java (originally as a sideline to&#13;
the HotJava browser) in May 1995, Java has been popular as a&#13;
programming language for building network applications. It’s easy&#13;
to see why, particularly if you’ve ever built a networked <span class="keep-together">application</span>&#13;
in C. First, C programmers have to worry about the platform they&#13;
are on. Unix uses <a data-primary="synchronous sockets" data-type="indexterm" id="idm45290646386488"/>synchronous sockets, which work rather like normal&#13;
disk files vis-à-vis reading and writing, whereas Microsoft OSes use&#13;
<a data-primary="asynchronous sockets" data-type="indexterm" id="idm45290646385512"/>asynchronous sockets, which use callbacks to notify when a read or&#13;
write has completed. Java glosses over this distinction. Further,&#13;
the amount of code needed to set up a socket in C is intimidating.&#13;
Just for fun, <a data-type="xref" href="#javacook-netclient-EX-1">Example 12-1</a> shows the typical C code&#13;
for setting up a client socket. And remember, this is only the Unix&#13;
part. And only the part that makes and closes the connection. To be portable&#13;
to Windows, it would need some additional conditional code (using C’s&#13;
<code>#ifdef</code> mechanism). C’s <code>#include</code> mechanism requires that&#13;
exactly the right files be included, and some files have to be listed in particular orders&#13;
(Java’s <code>import</code> mechanism is much more flexible).</p>&#13;
<div data-type="example" id="javacook-netclient-EX-1">&#13;
<h5><span class="label">Example 12-1. </span>main/src/main/java/network/Connect.c (C client setup)</h5>&#13;
&#13;
<pre data-type="programlisting">#include &lt;sys/types.h&gt;&#13;
#include &lt;sys/socket.h&gt;&#13;
#include &lt;netinet/in.h&gt;&#13;
#include &lt;netdb.h&gt;&#13;
#include &lt;stdio.h&gt;&#13;
#include &lt;string.h&gt;&#13;
#include &lt;fcntl.h&gt;&#13;
&#13;
int&#13;
main(int argc, char *argv[])&#13;
{&#13;
    char* server_name = "localhost";&#13;
    struct hostent *host_info;&#13;
    int sock;&#13;
    struct sockaddr_in server;&#13;
&#13;
    /* Look up the remote host's IP address */&#13;
    host_info = gethostbyname(server_name);&#13;
    if (host_info == NULL) {&#13;
        fprintf(stderr, "%s: unknown host: %s\n", argv[0], server_name);&#13;
        exit(1);&#13;
    }&#13;
&#13;
    /* Create the socket */&#13;
    if ((sock = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {&#13;
        perror("creating client socket");&#13;
        exit(2);&#13;
    }&#13;
&#13;
    /* Set up the server's socket address */&#13;
    server.sin_family = AF_INET;&#13;
    memcpy((char *)&amp;server.sin_addr, host_info-&gt;h_addr,&#13;
                     host_info-&gt;h_length);&#13;
    server.sin_port = htons(80);&#13;
&#13;
    /* Connect to the server */&#13;
    if (connect(sock,(struct sockaddr *)&amp;server,sizeof server) &lt; 0) {&#13;
        perror("connecting to server");&#13;
        exit(4);&#13;
    }&#13;
&#13;
    /* Finally, we can read and write on the socket. */&#13;
    /* ... */&#13;
&#13;
    (void) close(sock);&#13;
}</pre></div>&#13;
&#13;
<p>In the first recipe, we’ll see how to do the connect in essentially&#13;
one line of Java (plus a bit of error handling). We’ll then cover&#13;
error handling and transferring data over a socket. Next, we’ll&#13;
take a quick look at a <code>datagram</code> or UDP client that implements&#13;
most of the <a data-primary="TFTP (trivial file transfer protocol)" data-type="indexterm" id="idm45290646378296"/><a data-primary="trivial file transfer protocol (TFTP)" data-type="indexterm" id="idm45290646377624"/>TFTP (Trivial File Transfer Protocol) that has been&#13;
used for two decades to boot diskless workstations. We’ll end with&#13;
a program that connects interactively to a chat server.</p>&#13;
&#13;
<p>A common theme through most of these client examples is to use&#13;
existing servers so that we don’t have to generate both the client&#13;
and the server at the same time. Most of these&#13;
are services that exist on any standard Unix platform. If you can’t&#13;
find a Unix server near you to try them on, let me suggest that you&#13;
take an old PC, maybe one that’s underpowered for running the latest&#13;
Microsoft software, and put up a free, open source Unix system on it.&#13;
My personal favorite is <a href="https://openbsd.org">OpenBSD</a>, and the market’s overall&#13;
favorite is Linux. Both are readily available and can be&#13;
installed for free over the internet, and they offer all the standard&#13;
services used in the client examples, including the time servers&#13;
and TFTP. Both have free Java implementations available.</p>&#13;
&#13;
<p>I also provide basic coverage of web services clients.&#13;
The term “web services” has come to mean program-to-program communication using HTTP.&#13;
The two general categories are SOAP-based and REST-based.&#13;
REST services are very simple—you send an HTTP request and get back a response in&#13;
plain text, or JSON (<a data-type="xref" href="ch14.html#javacook-json">Chapter 14</a>) or XML.&#13;
SOAP is more complicated and not covered in this book.&#13;
There is more information on the client-side connections in<a data-primary="Java Network Programming (Harold)" data-type="indexterm" id="idm45290646345880"/><a data-primary="Harold, Elliotte" data-secondary="Java Network Programming" data-type="indexterm" id="idm45290646345272"/> <a href="http://shop.oreilly.com/product/0636920028420.do"><em>Java Network Programming</em></a> by Elliotte Harold (O’Reilly). I don’t cover the server-side APIs for building web services—JAX-RS and JAX-WS—because these are covered in <a href="http://search.oreilly.com/?q=java+enterprise">several O’Reilly books</a>.<a data-primary="" data-startref="jav_net" data-type="indexterm" id="idm45290646342760"/><a data-primary="" data-startref="net_jav" data-type="indexterm" id="idm45290646341912"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.1 HTTP/REST Web Client" data-type="sect1"><div class="sect1" id="javacook-netclient-rest-1">&#13;
<h1>12.1 HTTP/REST Web Client</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-rest-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="HTTP/REST web client" data-type="indexterm" id="http_ab"/><a data-primary="networking" data-secondary="HTTP/REST web client" data-type="indexterm" id="net_http"/>You need to read from a URL, for example, to connect to a RESTful web service or to download a web page&#13;
or other resource over HTTP/HTTPS.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-rest-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the standard Java 11 <code>HttpClient</code> or the <code>URLConnection</code> class.</p>&#13;
&#13;
<p>This technique applies anytime you need to read from a URL, not just a RESTful web service.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netclient-rest-1.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Prior to Java 11, you had to either use the <code>URLConnection</code> class or&#13;
download and use the older Apache HTTP Client Library.&#13;
With Java 11, there is a fairly easy-to-use and flexible API&#13;
in standard Java. It also supports HTTP/2.0; which the Apache <code>HttpClient</code>&#13;
does not as of early 2020, and the legacy <code>URLConnection</code>, which is unlikely ever to support HTTP/2.0.</p>&#13;
&#13;
<p>As our simple example, we’ll use Google’s Suggest service,&#13;
that is, what you see when you type the first few characters of a search&#13;
into the Google web search engine.</p>&#13;
&#13;
<p>This Google service supports various output formats.&#13;
The base URL is just the <span class="keep-together">following:</span></p>&#13;
&#13;
<pre data-type="programlisting">https://suggestqueries.google.com/complete/search?client=firefox&amp;q=</pre>&#13;
&#13;
<p>Append to it the word you want suggestions on. The <code>client=firefox</code> tells it we want a simple JSON format;&#13;
with <code>client=chrome</code> it contains more fields.</p>&#13;
&#13;
<p>To use the Java HTTP Client API, you need a <code>HttpClient</code> object, which you&#13;
get using the Builder pattern, then create a <code>Request</code> object:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="c1">// This object would be kept for the life of an application</code>&#13;
        <code class="n">HttpClient</code> <code class="n">client</code> <code class="o">=</code> <code class="n">HttpClient</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">followRedirects</code><code class="o">(</code><code class="n">Redirect</code><code class="o">.</code><code class="na">NORMAL</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">version</code><code class="o">(</code><code class="n">Version</code><code class="o">.</code><code class="na">HTTP_1_1</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">build</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Build the HttpRequest object to "GET" the urlString</code>&#13;
        <code class="n">HttpRequest</code> <code class="n">req</code> <code class="o">=</code>&#13;
            <code class="n">HttpRequest</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="n">URI</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="n">urlString</code> <code class="o">+</code>&#13;
                <code class="n">URLEncoder</code><code class="o">.</code><code class="na">encode</code><code class="o">(</code><code class="n">keyword</code><code class="o">)))</code>&#13;
            <code class="o">.</code><code class="na">header</code><code class="o">(</code><code class="s">"User-Agent"</code><code class="o">,</code> <code class="s">"Dept of Silly Walks"</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">GET</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">build</code><code class="o">();</code></pre>&#13;
&#13;
<p>The <code>HttpRequest</code> object can be sent&#13;
using the client to get a <code>HttpResponse</code> object, from which you can get&#13;
the status and/or the body.&#13;
Sending can be done either synchronously (if you need the&#13;
results right away) or asynchronously (if you can usefully do something&#13;
else in the meantime). This example shows sending it both synchronously and asynchronously:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="c1">// Send the request - synchronously</code>&#13;
        <code class="n">HttpResponse</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">resp</code> <code class="o">=</code>&#13;
            <code class="n">client</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="n">req</code><code class="o">,</code> <code class="n">BodyHandlers</code><code class="o">.</code><code class="na">ofString</code><code class="o">());</code>&#13;
&#13;
        <code class="c1">// Collect the results</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">resp</code><code class="o">.</code><code class="na">statusCode</code><code class="o">()</code> <code class="o">==</code> <code class="mi">200</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">String</code> <code class="n">response</code> <code class="o">=</code> <code class="n">resp</code><code class="o">.</code><code class="na">body</code><code class="o">();</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">response</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">printf</code><code class="o">(</code><code class="s">"ERROR: Status %d on request %s\n"</code><code class="o">,</code>&#13;
                <code class="n">resp</code><code class="o">.</code><code class="na">statusCode</code><code class="o">(),</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code></pre>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="c1">// Send the request - asynchronously</code>&#13;
        <code class="n">client</code><code class="o">.</code><code class="na">sendAsync</code><code class="o">(</code><code class="n">req</code><code class="o">,</code> <code class="n">BodyHandlers</code><code class="o">.</code><code class="na">ofString</code><code class="o">())</code>&#13;
            <code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="nl">HttpResponse:</code><code class="o">:</code><code class="n">body</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">thenAccept</code><code class="o">(</code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">::</code><code class="n">println</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">join</code><code class="o">();</code></pre>&#13;
&#13;
<p>Here is the output; the line has been broken at commas to make it fit on the page:</p>&#13;
&#13;
<pre data-type="programlisting">$ java HttpClientDemo.java&#13;
["darwin",["darwin thompson","darwin","darwin awards","darwinism",&#13;
 "darwin australia","darwin thompson fantasy","darwin barney",&#13;
 "darwin theory","darwinai","darwin dormitorio"]]</pre>&#13;
&#13;
<p>Should you not wish to use the <code>HttpClient</code> library, you <em>could</em>&#13;
use the legacy code in <code>java.net</code>,&#13;
since all we usually need here is the ability to open and read from a URL.&#13;
Here is the code using a <code>URLConnection</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">RestClientURLDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">URLConnection</code> <code class="n">conn</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code>&#13;
            <code class="n">HttpClientDemo</code><code class="o">.</code><code class="na">urlString</code> <code class="o">+</code> <code class="n">HttpClientDemo</code><code class="o">.</code><code class="na">keyword</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code>&#13;
            <code class="k">new</code> <code class="nf">BufferedReader</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">())))</code> <code class="o">{</code>&#13;
&#13;
            <code class="n">String</code> <code class="n">line</code><code class="o">;</code>&#13;
            <code class="k">while</code> <code class="o">((</code><code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">line</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>The output should be identical to what the <code>HttpClient</code> version produced.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45290646331560">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>Don’t confuse this <code>HttpClient</code> with the <a href="https://hc.apache.org/httpcomponents-client-ga/index.html">older Apache HttpClient Library</a>.</p>&#13;
&#13;
<p>You can find more information on REST services (including implementing the server-side components for them) in <a data-primary="Burke, Bill" data-secondary="RESTful Java with JAX-RS 2.0, 2nd Edition" data-type="indexterm" id="idm45290645969432"/><a data-primary="RESTful Java with JAX-RS 2.0, 2nd Edition (Burke)" data-type="indexterm" id="idm45290645968488"/>Bill Burke’s <a href="http://shop.oreilly.com/product/0636920028925.do"><em>RESTful Java with JAX-RS 2.0, 2nd Edition</em></a> (O’Reilly).<a data-primary="" data-startref="http_ab" data-type="indexterm" id="idm45290645966840"/><a data-primary="" data-startref="net_http" data-type="indexterm" id="idm45290645965896"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.2 Contacting a Socket Server" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-1">&#13;
<h1>12.2 Contacting a Socket Server</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="networking" data-secondary="contacting servers" data-type="indexterm" id="idm45290645961800"/><a data-primary="servers, contacting" data-type="indexterm" id="idm45290645960824"/>You need to contact a server using TCP/IP.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Just create a <code>java.net.Socket</code>, passing the hostname and port number into the <span class="keep-together">constructor</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-1.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>There isn’t much to this in Java. When creating a socket, you pass in the hostname and the port number. The <code>java.net.Socket</code> constructor does the <code>gethostbyname()</code> and the <code>socket()</code> system call, sets up the server’s <code>sockaddr_in</code> structure, and executes the <code>connect()</code> call. All you have to do is catch the errors, which are subclassed from <span class="keep-together">the familiar</span> <code>IOException</code>.&#13;
<a data-type="xref" href="#javacook-netclient-EX-2">Example 12-2</a> sets up a Java network client but doesn’t actually do any I/O yet.&#13;
It uses try-with-resources to ensure that&#13;
the socket is closed automatically when we are done with it.</p>&#13;
<div data-type="example" id="javacook-netclient-EX-2">&#13;
<h5><span class="label">Example 12-2. </span>main/src/main/java/network/ConnectSimple.java (simple client connection)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">import</code> <code class="nn">java.net.Socket</code><code class="o">;</code>&#13;
&#13;
<code class="cm">/* Client with NO error handling */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">ConnectSimple</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="s">"localhost"</code><code class="o">,</code> <code class="mi">8080</code><code class="o">))</code> <code class="o">{</code>&#13;
&#13;
            <code class="cm">/* If we get here, we can read and write on the socket "sock" */</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">" *** Connected OK ***"</code><code class="o">);</code>&#13;
&#13;
            <code class="cm">/* Do some I/O here... */</code>&#13;
&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>This version does no real error reporting, but a version called <em>ConnectFriendly</em> does; we’ll see this version in <a data-type="xref" href="#javacook-netclient-SECT-3">Recipe 12.4</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-1.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>Java supports other ways of using network applications. You can also open a URL and read from it (see <a data-type="xref" href="#javacook-netserver-SECT-8-ch15">Recipe 12.8</a>). You can write code so that it will run from a URL, when opened in a web browser, or from an application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.3 Finding and Reporting Network Addresses" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-2">&#13;
<h1>12.3 Finding and Reporting Network Addresses</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-2.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="addresses, network" data-type="indexterm" id="add_net"/><a data-primary="networking" data-secondary="network addresses" data-type="indexterm" id="net_add"/>You want to look up a host’s address name or number or get the address at the other end of a network connection.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-2.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Get an <code>InetAddress</code> object.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-2.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>InetAddress</code> object represents the internet address of a given computer or host. It has no public constructors; you obtain an <code>InetAddress</code> by calling the static <a data-primary="getByName() method" data-type="indexterm" id="idm45290645859128"/><code>getByName()</code> method, passing in either a hostname like <em>darwinsys.com</em> or a network address as a string, like 1.23.45.67. All the “lookup” methods in this class can throw the checked <code>UnknownHostException</code> (a subclass of <code>java.io.IOException</code>), which must be caught or declared on the calling method’s header. None of these methods actually contact the remote host, so they do not throw the other exceptions related to network connections.</p>&#13;
&#13;
<p>The method <a data-primary="getHostAddress() method" data-type="indexterm" id="idm45290645856104"/><code>getHostAddress()</code> gives you the numeric IP address (as a string) corresponding to the <code>InetAddress</code>. The inverse is <code>getHostName()</code>, which reports the name of the <code>InetAddress</code>. This can be used to print the address of a host given its name, or vice versa:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">InetAddrDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">hostName</code> <code class="o">=</code> <code class="s">"darwinsys.com"</code><code class="o">;</code>&#13;
        <code class="n">String</code> <code class="n">ipNumber</code> <code class="o">=</code> <code class="s">"8.8.8.8"</code><code class="o">;</code> <code class="c1">// currently a well-known Google DNS server</code>&#13;
&#13;
        <code class="c1">// Show getting the InetAddress (looking up a host) by host name</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">hostName</code> <code class="o">+</code> <code class="s">"'s address is "</code> <code class="o">+</code>&#13;
            <code class="n">InetAddress</code><code class="o">.</code><code class="na">getByName</code><code class="o">(</code><code class="n">hostName</code><code class="o">).</code><code class="na">getHostAddress</code><code class="o">());</code>&#13;
&#13;
        <code class="c1">// Look up a host by address</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">ipNumber</code> <code class="o">+</code> <code class="s">"'s name is "</code> <code class="o">+</code>&#13;
            <code class="n">InetAddress</code><code class="o">.</code><code class="na">getByName</code><code class="o">(</code><code class="n">ipNumber</code><code class="o">).</code><code class="na">getHostName</code><code class="o">());</code>&#13;
&#13;
        <code class="c1">// Look up my localhost addresss</code>&#13;
        <code class="kd">final</code> <code class="n">InetAddress</code> <code class="n">localHost</code> <code class="o">=</code> <code class="n">InetAddress</code><code class="o">.</code><code class="na">getLocalHost</code><code class="o">();</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"My localhost address is "</code> <code class="o">+</code> <code class="n">localHost</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Show getting the InetAddress from an open Socket</code>&#13;
        <code class="n">String</code> <code class="n">someServerName</code> <code class="o">=</code> <code class="s">"google.com"</code><code class="o">;</code>&#13;
        <code class="c1">// assuming there's a web server on the named server:</code>&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">theSocket</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">someServerName</code><code class="o">,</code> <code class="mi">80</code><code class="o">))</code> <code class="o">{</code>&#13;
            <code class="n">InetAddress</code> <code class="n">remote</code> <code class="o">=</code> <code class="n">theSocket</code><code class="o">.</code><code class="na">getInetAddress</code><code class="o">();</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">printf</code><code class="o">(</code><code class="s">"The InetAddress for %s is %s%n"</code><code class="o">,</code>&#13;
                <code class="n">someServerName</code><code class="o">,</code> <code class="n">remote</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>You can also get an <a data-primary="getInetAddress() method" data-type="indexterm" id="idm45290645850696"/><code>InetAddress</code> from a <code>Socket</code> by calling its <code>getInetAddress()</code> method. You can construct a <code>Socket</code> using an <code>InetAddress</code> instead of a hostname string. So, to connect to port number <code>myPortNumber</code> on the same host as an existing socket, you’d use this:</p>&#13;
&#13;
<pre data-type="programlisting">InetAddress remote = theSocket.getInetAddress( );&#13;
Socket anotherSocket = new Socket(remote, myPortNumber);</pre>&#13;
&#13;
<p>Finally, to look up all the addresses associated with a host—a server may be on more than one network—use the static method <code>getAllByName(host)</code>, which returns an array of <code>InetAddress</code> objects, one for each IP address associated with the given name.</p>&#13;
&#13;
<p>A static method<a data-primary="getLocalHost() methd" data-type="indexterm" id="idm45290645659240"/> <code>getLocalHost()</code> returns an <code>InetAddress</code> equivalent to <code>localhost</code> or 127.0.0.1. This can be used to connect to a server program running on the same machine as the client.</p>&#13;
&#13;
<p>If you are using IPv6, you can use <code>Inet6Address</code> instead.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-2.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>See <code>NetworkInterface</code> in <a data-type="xref" href="ch13.html#javacook-netserver-SECT-10">Recipe 13.2</a>, which lets you find out more about the networking of the machine you are running on. There is no way to look up services in the standard API yet—that is, to find out that the HTTP service is on port 80. Full implementations of TCP/IP have always included an additional set of resolvers; in C, the call <code>getservbyname("http"</code>, "<code>tcp");</code> would look up the given service<sup><a data-type="noteref" href="ch12.html#idm45290645651848" id="idm45290645651848-marker">1</a></sup> <a data-primary="Network Information Services (NIS)" data-type="indexterm" id="idm45290645649656"/><a data-primary="NIS (Network Information Services)" data-type="indexterm" id="idm45290645648888"/>and return a <code>servent</code> (service entry) structure whose <code>s_port</code> member would contain the value 80. The numbers of established services do not change, but when services are new or installed in nonroutine ways, it is convenient to be able to change the service number for all programs on a machine or network (regardless of programming language) just by changing the services definitions. Java should provide this capability in a future release.<a data-primary="" data-startref="add_net" data-type="indexterm" id="idm45290645646840"/><a data-primary="" data-startref="net_add" data-type="indexterm" id="idm45290645645864"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.4 Handling Network Errors" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-3">&#13;
<h1>12.4 Handling Network Errors</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-3.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="error handling" data-type="indexterm" id="idm45290645642056"/><a data-primary="networking" data-secondary="errors, handling" data-type="indexterm" id="idm45290645641352"/>You want more detailed reporting than just <code>IOException</code> if something goes wrong.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-3.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Catch a greater variety of exception classes. <code>SocketException</code> has several subclasses; the most notable are <code>ConnectException</code> and <code>NoRouteToHostException</code>. The names are self-explanatory: the first means that the connection was refused by the machine at the other end (the server machine), and the second completely explains the failure. <a data-type="xref" href="#javacook-netclient-EX-3">Example 12-3</a> is an excerpt from the <code>Connect</code> program, enhanced to handle these <span class="keep-together">conditions.</span></p>&#13;
<div data-type="example" id="javacook-netclient-EX-3">&#13;
<h5><span class="label">Example 12-3. </span>ConnectFriendly.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ConnectFriendly</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">server_name</code> <code class="o">=</code> <code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">1</code> <code class="o">?</code> <code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">:</code> <code class="s">"localhost"</code><code class="o">;</code>&#13;
        <code class="kt">int</code> <code class="n">tcp_port</code> <code class="o">=</code> <code class="mi">80</code><code class="o">;</code>&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">server_name</code><code class="o">,</code> <code class="n">tcp_port</code><code class="o">))</code> <code class="o">{</code>&#13;
&#13;
            <code class="cm">/* If we get here, we can read and write on the socket. */</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">" *** Connected to "</code> <code class="o">+</code> <code class="n">server_name</code>  <code class="o">+</code> <code class="s">" ***"</code><code class="o">);</code>&#13;
&#13;
            <code class="cm">/* Do some I/O here... */</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">UnknownHostException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">server_name</code> <code class="o">+</code> <code class="s">" Unknown host"</code><code class="o">);</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">NoRouteToHostException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">server_name</code> <code class="o">+</code> <code class="s">" Unreachable"</code> <code class="o">);</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">ConnectException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">server_name</code> <code class="o">+</code> <code class="s">" connect refused"</code><code class="o">);</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">io</code><code class="o">.</code><code class="na">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">server_name</code> <code class="o">+</code> <code class="sc">' '</code> <code class="o">+</code> <code class="n">e</code><code class="o">.</code><code class="na">getMessage</code><code class="o">());</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.5 Reading and Writing Textual Data" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-4">&#13;
<h1>12.5 Reading and Writing Textual Data</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-4.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="networking" data-secondary="text data, reading/writing" data-type="indexterm" id="net_tdrw"/><a data-primary="text data, reading/writing" data-type="indexterm" id="td-rw"/>Having connected, you wish to transfer textual data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-4.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Construct a <code>BufferedReader</code> or <code>PrintWriter</code> from the socket’s <a data-primary="getInputStream() method" data-type="indexterm" id="idm45290645451672"/><a data-primary="getOutputStream() method" data-type="indexterm" id="idm45290645450936"/><code>getInputStream()</code> or <code>getOutputStream()</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-4.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>Socket</code> class has methods that allow you to get an <code>InputStream</code> or <code>OutputStream</code> to read from or write to the socket. It has no method to fetch a <code>Reader</code> or <code>Writer</code>, partly because some network services are limited to ASCII, but mainly because the <code>Socket</code> class was decided on before there were <code>Reader</code> and <code>Writer</code> classes. You can always create a <code>Reader</code> from an <code>InputStream</code> or a <code>Writer</code> from an <code>OutputStream</code> using the conversion classes. This is the paradigm for the two most common forms:</p>&#13;
&#13;
<pre data-type="programlisting">BufferedReader is = new BufferedReader(&#13;
    new InputStreamReader(sock.getInputStream( )));&#13;
PrintWriter os = new PrintWriter(sock.getOutputStream( ), true);</pre>&#13;
&#13;
<p><a data-type="xref" href="#javacook-netclient-EX-4">Example 12-4</a> reads a line of text from the daytime service, which is offered by full-fledged TCP/IP suites (such as those included with most Unixes). You don’t have to send anything to the <code>Daytime</code> server; you simply connect and read one line. The server writes one line containing the date and time and then closes the connection.</p>&#13;
&#13;
<p>Running it looks like the following code. I started by getting the current date and time on the local host, then ran the <code>DaytimeText</code> program to see the date and time on the server (machine <em>darian</em> is one of my Unix servers):</p>&#13;
<pre data-type="programlisting" id="I_16_tt488">C:\javasrc\network&gt;<strong>date </strong>&#13;
Current date is Sun 01-23-2000&#13;
Enter new date (mm-dd-yy):&#13;
C:\javasrc\network&gt;<strong>time</strong>&#13;
Current time is  1:13:18.70p&#13;
Enter new time:&#13;
C:\javasrc\network&gt;<strong>java network.DaytimeText darian</strong>&#13;
Time on darian is Sun Jan 23 13:14:34 2000</pre>&#13;
&#13;
<p>The code is in class <code>DaytimeText</code>, shown in <a data-type="xref" href="#javacook-netclient-EX-4">Example 12-4</a>.</p>&#13;
<div data-type="example" id="javacook-netclient-EX-4">&#13;
<h5><span class="label">Example 12-4. </span>DaytimeText.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DaytimeText</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">short</code> <code class="n">TIME_PORT</code> <code class="o">=</code> <code class="mi">13</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">server_name</code> <code class="o">=</code> <code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">1</code> <code class="o">?</code> <code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">:</code> <code class="s">"localhost"</code><code class="o">;</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">server_name</code><code class="o">,</code><code class="n">TIME_PORT</code><code class="o">);</code>&#13;
            <code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="k">new</code>&#13;
                <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));)</code> <code class="o">{</code>&#13;
            <code class="n">String</code> <code class="n">remoteTime</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">();</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Time on "</code> <code class="o">+</code> <code class="n">server_name</code> <code class="o">+</code> <code class="s">" is "</code> <code class="o">+</code> <code class="n">remoteTime</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The second example, shown in <a data-type="xref" href="#javacook-netclient-EX-5">Example 12-5</a>, shows both reading and writing on the same socket. The <code>Echo</code> server simply echoes back whatever lines of text you send it. It’s not a very clever server, but it is a useful one. It helps in network testing and also in testing clients of this type!</p>&#13;
&#13;
<p>The <code>converse()</code> method holds a short conversation with the <code>Echo</code> server on the named host; if no host is named, it tries to contact <code>localhost</code>, a universal alias<sup><a data-type="noteref" href="ch12.html#idm45290645253384" id="idm45290645253384-marker">2</a></sup> for the machine the program is running on.</p>&#13;
<div data-type="example" id="javacook-netclient-EX-5">&#13;
<h5><span class="label">Example 12-5. </span>main/src/main/java/network/EchoClientOneLine.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EchoClientOneLine</code> <code class="o">{</code>&#13;
    <code class="cm">/** What we send across the net */</code>&#13;
    <code class="n">String</code> <code class="n">mesg</code> <code class="o">=</code> <code class="s">"Hello across the net"</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code>&#13;
            <code class="k">new</code> <code class="nf">EchoClientOneLine</code><code class="o">().</code><code class="na">converse</code><code class="o">(</code><code class="s">"localhost"</code><code class="o">);</code>&#13;
        <code class="k">else</code>&#13;
            <code class="k">new</code> <code class="nf">EchoClientOneLine</code><code class="o">().</code><code class="na">converse</code><code class="o">(</code><code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Hold one conversation across the net */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">converse</code><code class="o">(</code><code class="n">String</code> <code class="n">hostName</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">hostName</code><code class="o">,</code> <code class="mi">7</code><code class="o">);)</code> <code class="o">{</code> <code class="c1">// echo server.</code>&#13;
            <code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="k">new</code>&#13;
                <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
            <code class="n">PrintWriter</code> <code class="n">os</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintWriter</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">(),</code> <code class="kc">true</code><code class="o">);</code>&#13;
            <code class="c1">// Do the CRLF ourself since println appends only a \r on</code>&#13;
            <code class="c1">// platforms where that is the native line ending.</code>&#13;
            <code class="n">os</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">mesg</code> <code class="o">+</code> <code class="s">"\r\n"</code><code class="o">);</code> <code class="n">os</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
            <code class="n">String</code> <code class="n">reply</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">();</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Sent \""</code> <code class="o">+</code> <code class="n">mesg</code>  <code class="o">+</code> <code class="s">"\""</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Got  \""</code> <code class="o">+</code> <code class="n">reply</code> <code class="o">+</code> <code class="s">"\""</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>It might be a good exercise to isolate the reading and writing code from this method into a <code>NetWriter</code> class, possibly subclassing <code>PrintWriter</code> and adding the <code>\r\n</code> and the flushing.<a data-primary="" data-startref="net_tdrw" data-type="indexterm" id="idm45290645246968"/><a data-primary="" data-startref="td_rw" data-type="indexterm" id="idm45290645245960"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.6 Reading and Writing Binary or Serialized Data" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-5">&#13;
<h1>12.6 Reading and Writing Binary or Serialized Data</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-5.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="binary data" data-secondary="reading/writing over networks" data-type="indexterm" id="bd_rwn"/><a data-primary="networking" data-secondary="binary data, reading/writing" data-type="indexterm" id="net_bdrw"/><a data-primary="networking" data-secondary="serialized data, reading/writing" data-type="indexterm" id="net_sdrw"/><a data-primary="serialized data, reading/writing over networks" data-type="indexterm" id="sd_rwn"/>Having connected, you wish to transfer binary data, either raw binary data or serialized Java objects.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-5.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>For plain binary date, construct a <code>DataInputStream</code> or <code>DataOutputStream</code> from the socket’s <a data-primary="getInputStream() method" data-type="indexterm" id="idm45290645020056"/><a data-primary="getOutputStream() method" data-type="indexterm" id="idm45290645019320"/><code>getInputStream()</code> or <code>getOutputStream()</code>.&#13;
For serialized Java object data, construct an <code>ObjectInputStream</code> or <code>ObjectOutputStream</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-5.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The simplest paradigm for reading/writing on a socket is this:</p>&#13;
&#13;
<pre data-type="programlisting">DataInputStream is = new DataInputStream(sock.getInputStream());&#13;
DataOutputStream is = new DataOutputStream(sock.getOutputStream( ));</pre>&#13;
&#13;
<p>If the volume of data might be large, insert a buffered stream for efficiency. The paradigm is this:</p>&#13;
&#13;
<pre data-type="programlisting">DataInputStream is = new DataInputStream(&#13;
    new BufferedInputStream(sock.getInputStream( )));&#13;
DataOutputStream is = new DataOutputStream(&#13;
    new BufferedOutputStream(sock.getOutputStream( )));</pre>&#13;
&#13;
<p>The program example in <a data-type="xref" href="#javacook-netclient-EX-6">Example 12-6</a>&#13;
uses another standard service that gives out the time as a binary integer&#13;
representing the number of seconds since 1900. Because the Java <code>Date</code> class base is 1970,&#13;
we convert the time base by subtracting the difference between 1970 and 1900. When I used&#13;
this exercise in a course, most of the students wanted to <em>add</em> this time difference,&#13;
reasoning that 1970 is later. But if you think clearly, you’ll see that there are fewer&#13;
seconds between 1999 and 1970 than there are between 1999 and 1900, so subtraction gives&#13;
the correct number of seconds. And because the <code>Date</code> constructor needs milliseconds, we&#13;
multiply the number of seconds by 1,000.</p>&#13;
&#13;
<p>The time difference is the number of years multiplied by 365, plus the number of leap days between the two dates (in the years 1904, 1908, . . . , 1968)—19 days.</p>&#13;
&#13;
<p>The integer that we read from the server is a C-language <code>unsigned int</code>. But Java doesn’t provide an unsigned integer type; normally when you need an unsigned number, you use the next-larger integer type, which would be <code>long</code>. But Java also doesn’t give us a method to read an unsigned integer from a data stream. The <code>DataInputStream</code> method <a data-primary="readInt() method" data-type="indexterm" id="idm45290645006616"/><code>readInt()</code> reads Java-style signed integers. There are <a data-primary="readUnsignedByte() method" data-type="indexterm" id="idm45290645005496"/><a data-primary="readUnsignedShort() method" data-type="indexterm" id="idm45290645004824"/><code>readUnsignedByte()</code> methods and <code>readUnsignedShort()</code> methods, but no <code>readUnsignedInt()</code> method. Accordingly, we synthesize the ability to read an unsigned <code>int</code> (which must be stored in a <code>long</code>, or else you’d lose the signed bit and be back where you started from) by reading unsigned bytes and reassembling them using Java’s bit-shifting operators:</p>&#13;
&#13;
<p>At the end of the code, we use the new date/time API (see <a data-type="xref" href="ch06.html#javacook-dates">Chapter 6</a>) to construct and&#13;
print a <code>LocalDateTime</code> object to show the current date and time on the local (client) machine:</p>&#13;
<pre data-type="programlisting" id="I_16_tt491">$ <strong>date</strong>&#13;
Thu Dec 26 09:48:36 EST 2019&#13;
<strong>java network.RDateClient aragorn</strong>&#13;
Remote time is 3786360519&#13;
BASE_DIFF is 2208988800&#13;
Time diff == 1577371719&#13;
Time on aragorn is 2019-12-26T09:48:39&#13;
Local date/time = 2019-12-26T09:48:41.208180&#13;
$</pre>&#13;
&#13;
<p>The name <em>aragorn</em> is the hostname of one of my OpenBSD Unix computers.&#13;
Looking at the output, you can see that the server agrees within a second or two.&#13;
That confirms the date calculation code in <a data-type="xref" href="#javacook-netclient-EX-6">Example 12-6</a>.&#13;
This protocol is commonly known as <code>rdate</code>, so the client code is called <code>RDateClient</code>.</p>&#13;
<div data-type="example" id="javacook-netclient-EX-6">&#13;
<h5><span class="label">Example 12-6. </span>main/src/main/java/network/RDateClient.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">RDateClient</code> <code class="o">{</code>&#13;
    <code class="cm">/** The TCP port for the binary time service. */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">short</code> <code class="n">TIME_PORT</code> <code class="o">=</code> <code class="mi">37</code><code class="o">;</code>&#13;
    <code class="cm">/** Seconds between 1970, the time base for dates and times</code>&#13;
<code class="cm">     * Factors in leap years (up to 2100), hours, minutes, and seconds.</code>&#13;
<code class="cm">     * Subtract 1 day for 1900, add in 1/2 day for 1969/1970.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">BASE_DAYS</code> <code class="o">=</code>&#13;
        <code class="o">(</code><code class="kt">long</code><code class="o">)((</code><code class="mi">1970</code><code class="o">-</code><code class="mi">1900</code><code class="o">)*</code><code class="mi">365</code> <code class="o">+</code> <code class="o">(</code><code class="mi">1970</code><code class="o">-</code><code class="mi">1900</code><code class="o">-</code><code class="mi">1</code><code class="o">)/</code><code class="mi">4</code><code class="o">);</code>&#13;
&#13;
    <code class="cm">/* Seconds since 1970 */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">BASE_DIFF</code> <code class="o">=</code> <code class="o">(</code><code class="n">BASE_DAYS</code> <code class="o">*</code> <code class="mi">24</code> <code class="o">*</code> <code class="mi">60</code> <code class="o">*</code> <code class="mi">60</code><code class="o">);</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">hostName</code><code class="o">;</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code>&#13;
            <code class="n">hostName</code> <code class="o">=</code> <code class="s">"localhost"</code><code class="o">;</code>&#13;
        <code class="k">else</code>&#13;
            <code class="n">hostName</code> <code class="o">=</code> <code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">];</code>&#13;
&#13;
        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">hostName</code><code class="o">,</code><code class="n">TIME_PORT</code><code class="o">);)</code> <code class="o">{</code>&#13;
            <code class="n">DataInputStream</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DataInputStream</code><code class="o">(</code><code class="k">new</code>&#13;
                <code class="n">BufferedInputStream</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
            <code class="c1">// Read 4 bytes from the network, unsigned.</code>&#13;
            <code class="c1">// Do it yourself; there is no readUnsignedInt().</code>&#13;
            <code class="c1">// Long is 8 bytes on Java, but we are using the</code>&#13;
            <code class="c1">// existing time protocol, which uses 4-byte ints.</code>&#13;
            <code class="kt">long</code> <code class="n">remoteTime</code> <code class="o">=</code> <code class="o">(</code>&#13;
                <code class="o">((</code><code class="kt">long</code><code class="o">)(</code><code class="n">is</code><code class="o">.</code><code class="na">readUnsignedByte</code><code class="o">())</code> <code class="o">&lt;&lt;</code> <code class="mi">24</code><code class="o">)</code> <code class="o">|</code>&#13;
                <code class="o">((</code><code class="kt">long</code><code class="o">)(</code><code class="n">is</code><code class="o">.</code><code class="na">readUnsignedByte</code><code class="o">())</code> <code class="o">&lt;&lt;</code> <code class="mi">16</code><code class="o">)</code> <code class="o">|</code>&#13;
                <code class="o">((</code><code class="kt">long</code><code class="o">)(</code><code class="n">is</code><code class="o">.</code><code class="na">readUnsignedByte</code><code class="o">())</code> <code class="o">&lt;&lt;</code>  <code class="mi">8</code><code class="o">)</code> <code class="o">|</code>&#13;
                <code class="o">((</code><code class="kt">long</code><code class="o">)(</code><code class="n">is</code><code class="o">.</code><code class="na">readUnsignedByte</code><code class="o">())</code> <code class="o">&lt;&lt;</code>  <code class="mi">0</code><code class="o">));</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Remote time is "</code> <code class="o">+</code> <code class="n">remoteTime</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"BASE_DIFF is "</code> <code class="o">+</code> <code class="n">BASE_DIFF</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Time diff == "</code> <code class="o">+</code> <code class="o">(</code><code class="n">remoteTime</code> <code class="o">-</code> <code class="n">BASE_DIFF</code><code class="o">));</code>&#13;
            <code class="n">Instant</code> <code class="n">time</code> <code class="o">=</code> <code class="n">Instant</code><code class="o">.</code><code class="na">ofEpochSecond</code><code class="o">(</code><code class="n">remoteTime</code> <code class="o">-</code> <code class="n">BASE_DIFF</code><code class="o">);</code>&#13;
            <code class="n">LocalDateTime</code> <code class="n">d</code> <code class="o">=</code> <code class="n">LocalDateTime</code><code class="o">.</code><code class="na">ofInstant</code><code class="o">(</code><code class="n">time</code><code class="o">,</code> <code class="n">ZoneId</code><code class="o">.</code><code class="na">systemDefault</code><code class="o">());</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Time on "</code> <code class="o">+</code> <code class="n">hostName</code> <code class="o">+</code> <code class="s">" is "</code> <code class="o">+</code> <code class="n">d</code><code class="o">.</code><code class="na">toString</code><code class="o">());</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Local date/time = "</code> <code class="o">+</code> <code class="n">LocalDateTime</code><code class="o">.</code><code class="na">now</code><code class="o">());</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><a data-primary="object serialization" data-type="indexterm" id="idm45290644985752"/><em>Object serialization</em> is the ability&#13;
to convert in-memory objects to an external form that can be sent serially&#13;
(a byte at a time).&#13;
To read or write Java objects via serialization, you need only construct an&#13;
<code>ObjectInputStream</code> or <code>ObjectOutputStream</code> from an <code>InputStream</code> or&#13;
<code>OutputStream</code>; in this case, the socket’s <a data-primary="getInputStream() method" data-type="indexterm" id="idm45290644982664"/><a data-primary="getOutputStream() method" data-type="indexterm" id="idm45290644981960"/><code>getInputStream()</code> or&#13;
<code>getOutputStream()</code>.</p>&#13;
&#13;
<p>This program (and its server) provide a service that isn’t a standard part of&#13;
the TCP/IP stack; it’s a service I made up as a demo. The server for this service&#13;
is introduced in <a data-type="xref" href="ch13.html#javacook-netserver-SECT-2">Recipe 13.3</a>. The client code in <a data-type="xref" href="#javacook-netclient-EX-7">Example 12-7</a> is quite&#13;
similar to the <code>DaytimeBinary</code> program in the previous recipe, but the&#13;
server sends us a <code>LocalDateTime</code> object already constructed.&#13;
<a data-type="xref" href="#javacook-netclient-EX-7">Example 12-7</a> shows the portion of the client code that differs from&#13;
<a data-type="xref" href="#javacook-netclient-EX-6">Example 12-6</a>.</p>&#13;
<div data-type="example" id="javacook-netclient-EX-7">&#13;
<h5><span class="label">Example 12-7. </span>main/src/main/java/network/DaytimeObject.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="k">try</code> <code class="o">(</code><code class="n">Socket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">hostName</code><code class="o">,</code> <code class="n">TIME_PORT</code><code class="o">);)</code> <code class="o">{</code>&#13;
            <code class="n">ObjectInputStream</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ObjectInputStream</code><code class="o">(</code><code class="k">new</code>&#13;
                <code class="n">BufferedInputStream</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
&#13;
            <code class="c1">// Read and validate the Object</code>&#13;
            <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readObject</code><code class="o">();</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">o</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Read null from server!"</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">else</code> <code class="k">if</code> <code class="o">((</code><code class="n">o</code> <code class="k">instanceof</code> <code class="n">LocalDateTime</code><code class="o">))</code> <code class="o">{</code>&#13;
&#13;
                <code class="c1">// Valid, so cast to LocalDateTime, and print</code>&#13;
                <code class="n">LocalDateTime</code> <code class="n">d</code> <code class="o">=</code> <code class="o">(</code><code class="n">LocalDateTime</code><code class="o">)</code> <code class="n">o</code><code class="o">;</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Time on "</code> <code class="o">+</code> <code class="n">hostName</code> <code class="o">+</code> <code class="s">" is "</code> <code class="o">+</code> <code class="n">d</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code>&#13;
                    <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="s">"Wanted LocalDateTime, got %s, a %s"</code><code class="o">,</code>&#13;
                        <code class="n">o</code><code class="o">,</code> <code class="n">o</code><code class="o">.</code><code class="na">getClass</code><code class="o">()));</code>&#13;
            <code class="o">}</code></pre></div>&#13;
&#13;
<p>I ask the operating system for the date and time, and then I run the program, which prints the date and time on a remote machine:</p>&#13;
<pre data-type="programlisting" id="I_16_tt492">$ <strong>date</strong>&#13;
Thu Dec 26 09:29:02 EST 2019&#13;
C:\javasrc\network&gt;<strong>java network.DaytimeObject aragorn</strong>&#13;
Time on aragorn is 2019-12-26T09:29:05.227397&#13;
C:\javasrc\network&gt;</pre>&#13;
&#13;
<p>Again, the results agree within a few seconds.<a data-primary="" data-startref="bd_rwn" data-type="indexterm" id="idm45290644566792"/><a data-primary="" data-startref="net_bdrw" data-type="indexterm" id="idm45290644565816"/><a data-primary="" data-startref="net_sdrw" data-type="indexterm" id="idm45290644564872"/><a data-primary="" data-startref="sd_rwn" data-type="indexterm" id="idm45290644563928"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.7 UDP Datagrams" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-7">&#13;
<h1>12.7 UDP Datagrams</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-7.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="networking" data-secondary="UDP datagrams" data-type="indexterm" id="net_udp"/><a data-primary="UDP datagrams" data-type="indexterm" id="udp_ab"/>You need to use a datagram connection (UDP) instead of a stream connection (TCP).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-7.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use <code>DatagramSocket</code> and <code>DatagramPacket</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-7.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Datagram network traffic is a kindred spirit to the underlying packet-based Ethernet and&#13;
IP (Internet Protocol) layers. Unlike a stream-based connection such as TCP, <span class="keep-together">datagram</span>&#13;
transports like UDP transmit each <em>packet</em>, or chunk of data, as a single entity with&#13;
no necessary relation to any other.<sup><a data-type="noteref" href="ch12.html#idm45290644551496" id="idm45290644551496-marker">3</a></sup>&#13;
A common analogy is that TCP is like talking on the&#13;
telephone, whereas UDP is like sending postcards or maybe fax <span class="keep-together">messages.</span></p>&#13;
&#13;
<p>The differences show up most in error handling. Packets can, like postcards, go astray.&#13;
When was the last time the postman rang your bell to tell you that the post office had&#13;
lost one of several postcards it was supposed to deliver to you? That’s not going to&#13;
happen, because the post office doesn’t keep track of postcards. On the other hand, when&#13;
you’re talking on the phone and there’s a noise burst—like somebody yelling in the room,&#13;
or even a bad connection—you notice the failure in real time, and you can ask the person&#13;
at the other end to repeat what they just said.</p>&#13;
&#13;
<p>With a stream-based connection like a TCP socket, the network transport layer handles&#13;
errors for you: it asks the other end to retransmit. With a datagram transport such as&#13;
UDP, you have to handle retransmission yourself. It’s kind of like numbering the postcards&#13;
you send so that you can go back and resend any that don’t arrive—a good excuse to return&#13;
to your vacation spot, perhaps.</p>&#13;
&#13;
<p>Another difference is that datagram transmission preserves message boundaries. That is, if&#13;
you write 20 bytes and then write 10 bytes when using TCP, the program reading from the&#13;
other end will not know if you wrote one chunk of 30 bytes, two chunks of 15, or even 30&#13;
individual characters. With a <code>DatagramSocket</code>, you construct a <code>DatagramPacket</code> object&#13;
for each buffer, and its contents are sent as a <em>single</em> entity over the network; its&#13;
contents will not be mixed together with the contents of any other buffer. The&#13;
<code>DatagramPacket</code> object has methods like <a data-primary="getLength() method" data-type="indexterm" id="idm45290644545304"/><a data-primary="setPort() method" data-type="indexterm" id="idm45290644544600"/><code>getLength()</code> and <code>setPort()</code>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="javacook-netclient-SIDEBAR-1">&#13;
<h5>Ian’s Basic Steps: UDP Client</h5>&#13;
<p>UDP is a bit more involved, so I’ll list the basic steps for generating a UDP client:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create a <code>DatagramSocket</code> with no arguments (the form that takes two arguments is used on the server).</p>&#13;
</li>&#13;
<li>&#13;
<p>Optionally <code>connect()</code> the socket to an <code>InetAddress</code> (see <a data-type="xref" href="#javacook-netclient-SECT-2">Recipe 12.3</a>) and port number.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create one or more <code>DatagramPacket</code> objects; these are wrappers around a byte array that contains data you want to send and is filled in with data you receive.</p>&#13;
</li>&#13;
<li>&#13;
<p>If you did not <code>connect()</code> the socket, provide the <code>InetAddress</code> and port when constructing the <code>DatagramPacket</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Set the packet’s length and use <code>sock.send(packet)</code> to send data to the server.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use <code>sock.receive()</code> to retrieve data.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></aside>&#13;
&#13;
<p>So why would we even use UDP? UDP has a lot less overhead than TCP, which can be&#13;
particularly valuable when sending huge amounts of data over a reliable local network or a few&#13;
hops on the internet.  Over long-haul networks, TCP is probably preferred because TCP handles&#13;
retransmission of lost packets for you. And obviously, if preserving record boundaries&#13;
makes your life easier, that may be a reason for considering UDP.&#13;
UDP is also the way to perform Multicast (broadcast to many receivers simultaneously),&#13;
though Multicast is out of scope for this discussion.</p>&#13;
&#13;
<p><a data-type="xref" href="#javacook-netclient-EX-8">Example 12-8</a> is a short program that connects via UDP to the <code>Daytime</code> date and time server used in <a data-type="xref" href="#javacook-netclient-SECT-4">Recipe 12.5</a>. Because UDP has no real notion of connection,&#13;
the client typically initiates the conversation, which sometimes means sending an empty packet;&#13;
the UDP server uses the address information it gets from that to return its response.</p>&#13;
<div data-type="example" id="javacook-netclient-EX-8">&#13;
<h5><span class="label">Example 12-8. </span>main/src/main/java/network/DaytimeUDP.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DaytimeUDP</code> <code class="o">{</code>&#13;
    <code class="cm">/** The UDP port number */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">DAYTIME_PORT</code> <code class="o">=</code> <code class="mi">13</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** A buffer plenty big enough for the date string */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">PACKET_SIZE</code> <code class="o">=</code> <code class="mi">100</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** The main program that drives this network client.</code>&#13;
<code class="cm">     * @param argv[0] hostname, running daytime/udp server</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"usage: java DayTimeUDP host"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">String</code> <code class="n">host</code> <code class="o">=</code> <code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">];</code>&#13;
        <code class="n">InetAddress</code> <code class="n">servAddr</code> <code class="o">=</code> <code class="n">InetAddress</code><code class="o">.</code><code class="na">getByName</code><code class="o">(</code><code class="n">host</code><code class="o">);</code>&#13;
        <code class="n">DatagramSocket</code> <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DatagramSocket</code><code class="o">();</code>&#13;
        <code class="c1">//sock.connect(servAddr, DAYTIME_PORT);</code>&#13;
        <code class="kt">byte</code><code class="o">[]</code> <code class="n">buffer</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="o">[</code><code class="n">PACKET_SIZE</code><code class="o">];</code>&#13;
&#13;
        <code class="c1">// The udp packet we will send and receive</code>&#13;
        <code class="n">DatagramPacket</code> <code class="n">packet</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DatagramPacket</code><code class="o">(</code>&#13;
            <code class="n">buffer</code><code class="o">,</code> <code class="n">PACKET_SIZE</code><code class="o">,</code> <code class="n">servAddr</code><code class="o">,</code> <code class="n">DAYTIME_PORT</code><code class="o">);</code>&#13;
&#13;
        <code class="cm">/* Send empty max-length (-1 for null byte) packet to server */</code>&#13;
        <code class="n">packet</code><code class="o">.</code><code class="na">setLength</code><code class="o">(</code><code class="n">PACKET_SIZE</code><code class="o">-</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="n">sock</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="n">packet</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Sent request"</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Receive a packet and print it.</code>&#13;
        <code class="n">sock</code><code class="o">.</code><code class="na">receive</code><code class="o">(</code><code class="n">packet</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Got packet of size "</code> <code class="o">+</code> <code class="n">packet</code><code class="o">.</code><code class="na">getLength</code><code class="o">());</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"Date on "</code> <code class="o">+</code> <code class="n">host</code> <code class="o">+</code> <code class="s">" is "</code> <code class="o">+</code>&#13;
            <code class="k">new</code> <code class="nf">String</code><code class="o">(</code><code class="n">buffer</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">packet</code><code class="o">.</code><code class="na">getLength</code><code class="o">()));</code>&#13;
&#13;
        <code class="n">sock</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>I’ll run it to my Unix box just to be sure that it works:<a data-primary="" data-startref="net_udp" data-type="indexterm" id="idm45290644522232"/><a data-primary="" data-startref="udp_ab" data-type="indexterm" id="idm45290644521384"/></p>&#13;
<pre data-type="programlisting" id="I_16_tt493">$&#13;
$ <strong>java network.DaytimeUDP aragorn</strong>&#13;
Sent request&#13;
Got packet of size 26&#13;
Date on aragorn is Sat Feb  8 20:22:12 2014&#13;
$</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.8 URI, URL, or URN?" data-type="sect1"><div class="sect1" id="javacook-netserver-SECT-8-ch15">&#13;
<h1>12.8 URI, URL, or URN?</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-8.1-ch15">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="networking" data-secondary="URI" data-type="indexterm" id="idm45290644125112"/><a data-primary="networking" data-secondary="URL" data-type="indexterm" id="idm45290644124136"/><a data-primary="networking" data-secondary="URN" data-type="indexterm" id="idm45290644123192"/><a data-primary="URI" data-type="indexterm" id="idm45290644122248"/><a data-primary="URL" data-type="indexterm" id="idm45290644121576"/><a data-primary="URN" data-type="indexterm" id="idm45290644120904"/>Having heard these terms, you want to know the difference between a URI, URL, and URN.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-8.2-ch15">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Read on. Or see the javadoc for <em>java.net.uri</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-netserver-SECT-8.3-ch15">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>A URL is the traditional name for a network address consisting of a scheme (like HTTP) and an address (site name) and resource or pathname. But there are three distinct terms in all:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>URI (Uniform Resource Identifier)</p>&#13;
</li>&#13;
<li>&#13;
<p>URL (Uniform Resource Locator)</p>&#13;
</li>&#13;
<li>&#13;
<p>URN (Uniform Resource Name)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>A discussion near the end of the Java documentation&#13;
for the new class explains the relationship among URI, URL, and URN.&#13;
URIs form the set of all identifiers. URLs and URNs are subsets.</p>&#13;
&#13;
<p>URIs are the most general; a URI is parsed for basic syntax without&#13;
regard to the scheme, if any, that it specifies, and it need not&#13;
refer to a particular server. A URL includes a hostname, scheme,&#13;
and other components; the string is parsed according to rules for&#13;
its scheme. When you construct a URL, an <code>InputStream</code>&#13;
is created automatically. URNs name resources but do not explain&#13;
how to locate them; typical examples of URNs that you will have&#13;
seen include <code>mailto:</code> and <code>news:</code> references.</p>&#13;
&#13;
<p>The main operations provided by the <code>URI</code> class&#13;
are normalization (removing extraneous path segments including&#13;
“..”) and relativization (this should be called&#13;
“making relative,” but somebody wanted a single word&#13;
to make a method name). A <code>URI</code> object does not&#13;
have any methods for opening the URI; for that, you would normally&#13;
use a string representation of the URI to construct a URL object,&#13;
like so:</p>&#13;
&#13;
<pre data-type="programlisting">URL x = new URL(theURI.toString( ));</pre>&#13;
&#13;
<p>The program in <a data-type="xref" href="#javacook-netserver-EX-6">Example 12-9</a> shows examples of&#13;
normalizating, making relative, and constructing a URL from a URI.</p>&#13;
<div data-type="example" id="javacook-netserver-EX-6">&#13;
<h5><span class="label">Example 12-9. </span>main/src/main/java/network/URIDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">URIDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">URISyntaxException</code><code class="o">,</code> <code class="n">MalformedURLException</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">URI</code> <code class="n">u</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URI</code><code class="o">(</code><code class="s">"https://darwinsys.com/java/../openbsd/../index.jsp"</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Raw: "</code> <code class="o">+</code> <code class="n">u</code><code class="o">);</code>&#13;
        <code class="n">URI</code> <code class="n">normalized</code> <code class="o">=</code> <code class="n">u</code><code class="o">.</code><code class="na">normalize</code><code class="o">();</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Normalized: "</code> <code class="o">+</code> <code class="n">normalized</code><code class="o">);</code>&#13;
        <code class="kd">final</code> <code class="n">URI</code> <code class="n">BASE</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URI</code><code class="o">(</code><code class="s">"https://darwinsys.com"</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Relativized to "</code> <code class="o">+</code> <code class="n">BASE</code> <code class="o">+</code> <code class="s">": "</code> <code class="o">+</code> <code class="n">BASE</code><code class="o">.</code><code class="na">relativize</code><code class="o">(</code><code class="n">u</code><code class="o">));</code>&#13;
&#13;
        <code class="c1">// A URL is a type of URI</code>&#13;
        <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="n">normalized</code><code class="o">.</code><code class="na">toString</code><code class="o">());</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"URL: "</code> <code class="o">+</code> <code class="n">url</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Demo of non-URL but valid URI</code>&#13;
        <code class="n">URI</code> <code class="n">uri</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URI</code><code class="o">(</code><code class="s">"bean:WonderBean"</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">uri</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.9 Program: TFTP UDP Client" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-8">&#13;
<h1>12.9 Program: TFTP UDP Client</h1>&#13;
&#13;
<p><a data-primary="networking" data-secondary="TFTP UDP Client program" data-type="indexterm" id="net_tftp"/><a data-primary="TFTP UDP Client program" data-type="indexterm" id="tftp_ab"/>This program implements the client half of the TFTP application protocol, a&#13;
once-well-known service that has been used in the Unix world for network booting of&#13;
workstations since before Windows 3.1, now primarily used for network bootstrapping of&#13;
computers. I chose this protocol because it’s widely implemented on the server side, so&#13;
it’s easy to find a test server for it.</p>&#13;
&#13;
<p>The TFTP protocol is a bit odd. The client contacts the server on the well-known UDP port&#13;
number 69, from a generated port number,<sup><a data-type="noteref" href="ch12.html#idm45290643937208" id="idm45290643937208-marker">4</a></sup> and the server&#13;
responds to the client from a generated port number. Further communication is on the two&#13;
generated port numbers.</p>&#13;
&#13;
<p>Getting into more detail, as shown in <a data-type="xref" href="#javacook-netclient-FIG-1">Figure 12-1</a>, the client initially&#13;
sends a read request with the filename and reads the first packet of data. The read&#13;
request consists of two bytes (a <code>short</code>) with the read request code (short integer with a&#13;
value of 1, defined as <code>OP_RRQ</code>), two bytes for the sequence number, then the ASCII&#13;
filename, null terminated, and the mode string, also null terminated. The server reads the&#13;
read request from the client, verifies that it can open the file and, if so, sends the&#13;
first data packet (<code>OP_DATA</code>), and then reads again. The client reads from its end and, if&#13;
the read is OK, turns the packet into an acknowledgement packet, and sends it. This&#13;
read-acknowledge cycle is repeated until all the data is read. Note that each packet is&#13;
516 bytes (512 bytes of data, plus 2 bytes for the packet type and 2 more for the packet&#13;
number) except the last, which can be any length from 4 (zero bytes of data) to 515 (511&#13;
bytes of data). If a network <span class="keep-together">I/O</span> error occurs, the packet is resent. If a given packet&#13;
goes astray, both client and server are supposed to perform a timeout cycle. This client&#13;
does not, but the server does. You could add timeouts either using a thread (see&#13;
<a data-type="xref" href="ch16.html#javacook-threads-SECT-4">Recipe 16.4</a>) or by invoking <a data-primary="setSoTimeout() method" data-type="indexterm" id="idm45290643929800"/><code>setSoTimeout()</code> on the socket and, if packets&#13;
do get lost, catching the <code>SocketTimeoutException</code>, retransmitting the ACK (or RRQ),&#13;
perhaps up to some max number of attempts. This is left as an exercise for the reader.&#13;
The current version of the client code is shown in <a data-type="xref" href="#javacook-netclient-EX-9">Example 12-10</a>.</p>&#13;
&#13;
<figure><div class="figure" id="javacook-netclient-FIG-1">&#13;
<img alt="jcb4 1201" src="assets/jcb4_1201.png"/>&#13;
<h6><span class="label">Figure 12-1. </span>The TFTP protocol packet formats</h6>&#13;
</div></figure>&#13;
<div data-type="example" id="javacook-netclient-EX-9">&#13;
<h5><span class="label">Example 12-10. </span>main/src/main/java/network/RemCat.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">RemCat</code> <code class="o">{</code>&#13;
    <code class="cm">/** The UDP port number */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">TFTP_PORT</code> <code class="o">=</code> <code class="mi">69</code><code class="o">;</code>&#13;
    <code class="cm">/** The mode we will use - octet for everything. */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">MODE</code> <code class="o">=</code> <code class="s">"octet"</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** The offset for the code/response as a byte */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OFFSET_REQUEST</code> <code class="o">=</code> <code class="mi">1</code><code class="o">;</code>&#13;
    <code class="cm">/** The offset for the packet number as a byte */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OFFSET_PACKETNUM</code> <code class="o">=</code> <code class="mi">3</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** Debugging flag */</code>&#13;
    <code class="kd">protected</code> <code class="kd">static</code> <code class="kt">boolean</code> <code class="n">debug</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** TFTP op-code for a read request */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OP_RRQ</code> <code class="o">=</code> <code class="mi">1</code><code class="o">;</code>&#13;
    <code class="cm">/** TFTP op-code for a read request */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OP_WRQ</code> <code class="o">=</code> <code class="mi">2</code><code class="o">;</code>&#13;
    <code class="cm">/** TFTP op-code for a read request */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OP_DATA</code> <code class="o">=</code> <code class="mi">3</code><code class="o">;</code>&#13;
    <code class="cm">/** TFTP op-code for a read request */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OP_ACK</code>    <code class="o">=</code> <code class="mi">4</code><code class="o">;</code>&#13;
    <code class="cm">/** TFTP op-code for a read request */</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">OP_ERROR</code> <code class="o">=</code> <code class="mi">5</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">PACKET_SIZE</code> <code class="o">=</code> <code class="mi">516</code><code class="o">;</code>    <code class="c1">// == 2 + 2 + 512</code>&#13;
    <code class="kd">protected</code> <code class="n">String</code> <code class="n">host</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="n">InetAddress</code> <code class="n">servAddr</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="n">DatagramSocket</code> <code class="n">sock</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="kt">byte</code> <code class="n">buffer</code><code class="o">[];</code>&#13;
    <code class="kd">protected</code> <code class="n">DatagramPacket</code> <code class="n">inp</code><code class="o">,</code> <code class="n">outp</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** The main program that drives this network client.</code>&#13;
<code class="cm">     * @param argv[0] hostname, running TFTP server</code>&#13;
<code class="cm">     * @param argv[1..n] filename(s), must be at least one</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">&lt;</code> <code class="mi">2</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"usage: rcat host filename[...]"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">debug</code><code class="o">)</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Java RemCat starting"</code><code class="o">);</code>&#13;
        <code class="n">RemCat</code> <code class="n">rc</code> <code class="o">=</code> <code class="k">new</code> <code class="n">RemCat</code><code class="o">(</code><code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">1</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">debug</code><code class="o">)</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"-- Starting file "</code> <code class="o">+</code>&#13;
                    <code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">+</code> <code class="s">":"</code> <code class="o">+</code> <code class="n">argv</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">+</code> <code class="s">"---"</code><code class="o">);</code>&#13;
            <code class="n">rc</code><code class="o">.</code><code class="na">readFile</code><code class="o">(</code><code class="n">argv</code><code class="o">[</code><code class="n">i</code><code class="o">]);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="n">RemCat</code><code class="o">(</code><code class="n">String</code> <code class="n">host</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="kd">super</code><code class="o">();</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">host</code> <code class="o">=</code> <code class="n">host</code><code class="o">;</code>&#13;
        <code class="n">servAddr</code> <code class="o">=</code> <code class="n">InetAddress</code><code class="o">.</code><code class="na">getByName</code><code class="o">(</code><code class="n">host</code><code class="o">);</code>&#13;
        <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DatagramSocket</code><code class="o">();</code>&#13;
        <code class="n">buffer</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="o">[</code><code class="n">PACKET_SIZE</code><code class="o">];</code>&#13;
        <code class="n">outp</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DatagramPacket</code><code class="o">(</code><code class="n">buffer</code><code class="o">,</code> <code class="n">PACKET_SIZE</code><code class="o">,</code> <code class="n">servAddr</code><code class="o">,</code> <code class="n">TFTP_PORT</code><code class="o">);</code>&#13;
        <code class="n">inp</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DatagramPacket</code><code class="o">(</code><code class="n">buffer</code><code class="o">,</code> <code class="n">PACKET_SIZE</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/* Build a TFTP Read Request packet. This is messy because the</code>&#13;
<code class="cm">     * fields have variable length. Numbers must be in</code>&#13;
<code class="cm">     * network order, too; fortunately Java just seems</code>&#13;
<code class="cm">     * naturally smart enough :-) to use network byte order.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kt">void</code> <code class="nf">readFile</code><code class="o">(</code><code class="n">String</code> <code class="n">path</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">buffer</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>&#13;
        <code class="n">buffer</code><code class="o">[</code><code class="n">OFFSET_REQUEST</code><code class="o">]</code> <code class="o">=</code> <code class="n">OP_RRQ</code><code class="o">;</code>        <code class="c1">// read request</code>&#13;
        <code class="kt">int</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">2</code><code class="o">;</code>            <code class="c1">// number of chars into buffer</code>&#13;
&#13;
        <code class="c1">// Convert filename String to bytes in buffer , using "p" as an</code>&#13;
        <code class="c1">// offset indicator to get all the bits of this request</code>&#13;
        <code class="c1">// in exactly the right spot.</code>&#13;
        <code class="kt">byte</code><code class="o">[]</code> <code class="n">bTemp</code> <code class="o">=</code> <code class="n">path</code><code class="o">.</code><code class="na">getBytes</code><code class="o">();</code>    <code class="c1">// i.e., ASCII</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">arraycopy</code><code class="o">(</code><code class="n">bTemp</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">buffer</code><code class="o">,</code> <code class="n">p</code><code class="o">,</code> <code class="n">path</code><code class="o">.</code><code class="na">length</code><code class="o">());</code>&#13;
        <code class="n">p</code> <code class="o">+=</code> <code class="n">path</code><code class="o">.</code><code class="na">length</code><code class="o">();</code>&#13;
        <code class="n">buffer</code><code class="o">[</code><code class="n">p</code><code class="o">++]</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>        <code class="c1">// null byte terminates string</code>&#13;
&#13;
        <code class="c1">// Similarly, convert MODE ("stream" or "octet") to bytes in buffer</code>&#13;
        <code class="n">bTemp</code> <code class="o">=</code> <code class="n">MODE</code><code class="o">.</code><code class="na">getBytes</code><code class="o">();</code>    <code class="c1">// i.e., ASCII</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">arraycopy</code><code class="o">(</code><code class="n">bTemp</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">buffer</code><code class="o">,</code> <code class="n">p</code><code class="o">,</code> <code class="n">MODE</code><code class="o">.</code><code class="na">length</code><code class="o">());</code>&#13;
        <code class="n">p</code> <code class="o">+=</code> <code class="n">MODE</code><code class="o">.</code><code class="na">length</code><code class="o">();</code>&#13;
        <code class="n">buffer</code><code class="o">[</code><code class="n">p</code><code class="o">++]</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>        <code class="c1">// null terminate</code>&#13;
&#13;
        <code class="cm">/* Send Read Request to tftp server */</code>&#13;
        <code class="n">outp</code><code class="o">.</code><code class="na">setLength</code><code class="o">(</code><code class="n">p</code><code class="o">);</code>&#13;
        <code class="n">sock</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="n">outp</code><code class="o">);</code>&#13;
&#13;
        <code class="cm">/* Loop reading data packets from the server until a short</code>&#13;
<code class="cm">         * packet arrives; this indicates the end of the file.</code>&#13;
<code class="cm">         */</code>&#13;
        <code class="k">do</code> <code class="o">{</code>&#13;
            <code class="n">sock</code><code class="o">.</code><code class="na">receive</code><code class="o">(</code><code class="n">inp</code><code class="o">);</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">debug</code><code class="o">)</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
                    <code class="s">"Packet # "</code> <code class="o">+</code> <code class="n">Byte</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="n">buffer</code><code class="o">[</code><code class="n">OFFSET_PACKETNUM</code><code class="o">])+</code>&#13;
                    <code class="s">"RESPONSE CODE "</code> <code class="o">+</code> <code class="n">Byte</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="n">buffer</code><code class="o">[</code><code class="n">OFFSET_REQUEST</code><code class="o">]));</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">buffer</code><code class="o">[</code><code class="n">OFFSET_REQUEST</code><code class="o">]</code> <code class="o">==</code> <code class="n">OP_ERROR</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"rcat ERROR: "</code> <code class="o">+</code>&#13;
                    <code class="k">new</code> <code class="nf">String</code><code class="o">(</code><code class="n">buffer</code><code class="o">,</code> <code class="mi">4</code><code class="o">,</code> <code class="n">inp</code><code class="o">.</code><code class="na">getLength</code><code class="o">()-</code><code class="mi">4</code><code class="o">));</code>&#13;
                <code class="k">return</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">debug</code><code class="o">)</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Got packet of size "</code> <code class="o">+</code>&#13;
                    <code class="n">inp</code><code class="o">.</code><code class="na">getLength</code><code class="o">());</code>&#13;
&#13;
            <code class="cm">/* Print the data from the packet */</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">buffer</code><code class="o">,</code> <code class="mi">4</code><code class="o">,</code> <code class="n">inp</code><code class="o">.</code><code class="na">getLength</code><code class="o">()-</code><code class="mi">4</code><code class="o">);</code>&#13;
&#13;
            <code class="cm">/* Ack the packet. The block number we</code>&#13;
<code class="cm">             * want to ack is already in buffer so</code>&#13;
<code class="cm">             * we just change the opcode. The ACK is</code>&#13;
<code class="cm">             * sent to the port number which the server</code>&#13;
<code class="cm">             * just sent the data from, NOT to port</code>&#13;
<code class="cm">             * TFTP_PORT.</code>&#13;
<code class="cm">             */</code>&#13;
            <code class="n">buffer</code><code class="o">[</code><code class="n">OFFSET_REQUEST</code><code class="o">]</code> <code class="o">=</code> <code class="n">OP_ACK</code><code class="o">;</code>&#13;
            <code class="n">outp</code><code class="o">.</code><code class="na">setLength</code><code class="o">(</code><code class="mi">4</code><code class="o">);</code>&#13;
            <code class="n">outp</code><code class="o">.</code><code class="na">setPort</code><code class="o">(</code><code class="n">inp</code><code class="o">.</code><code class="na">getPort</code><code class="o">());</code>&#13;
            <code class="n">sock</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="n">outp</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">while</code> <code class="o">(</code><code class="n">inp</code><code class="o">.</code><code class="na">getLength</code><code class="o">()</code> <code class="o">==</code> <code class="n">PACKET_SIZE</code><code class="o">);</code>&#13;
&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">debug</code><code class="o">)</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"** ALL DONE** Leaving loop, last size "</code> <code class="o">+</code>&#13;
                <code class="n">inp</code><code class="o">.</code><code class="na">getLength</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>To test this client, you need a TFTP server. If you are on a Unix system that you administer, you can enable the TFTP server to test this client just by editing the file <em>/etc/inetd.conf</em> and restarting or reloading the <em>inetd</em> server (Linux uses a different mechanism, which may vary depending on which distribution you are on). <em>inetd</em> is a program that listens for a wide range of connections and starts the servers only when a connection from a client comes along (a kind of lazy evaluation).<sup><a data-type="noteref" href="ch12.html#idm45290643677448" id="idm45290643677448-marker">5</a></sup> I set up the traditional <em>/tftpboot</em> directory, put this line in my <em>inetd.conf</em>, and reloaded <code>inetd</code>:</p>&#13;
&#13;
<pre data-type="programlisting">tftp dgram udp wait root /usr/libexec/tftpd tftpd -s /tftpboot</pre>&#13;
&#13;
<p>Then I put a few test files, one named <em>foo</em>, into the <em>/tftpboot</em> directory. Running</p>&#13;
<pre data-type="programlisting" id="I_16_tt496">$ <strong>java network.RemCat localhost foo</strong></pre>&#13;
&#13;
<p>produced what looked like the file. But just to be safe, I tested the output of <code>RemCat</code> against the original file, using the Unix <em>diff</em> comparison program. No news is good news:</p>&#13;
<pre data-type="programlisting" id="I_16_tt497">$ <strong>java network.RemCat localhost foo | diff - /tftpboot/foo</strong></pre>&#13;
&#13;
<p>So far so good. Let’s not slip this program on an unsuspecting network without exercising the error handling at least briefly:<a data-primary="" data-startref="net_tftp" data-type="indexterm" id="idm45290643142120"/><a data-primary="" data-startref="tftp_ab" data-type="indexterm" id="idm45290643141144"/></p>&#13;
<pre data-type="programlisting" id="I_16_tt498">$ <strong>java network.RemCat localhost nosuchfile </strong>&#13;
remcat ERROR: File not found&#13;
$</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.10 Program: Sockets-Based Chat Client" data-type="sect1"><div class="sect1" id="javacook-netclient-SECT-10">&#13;
<h1>12.10 Program: Sockets-Based Chat Client</h1>&#13;
&#13;
<p><a data-primary="Chat Client program" data-type="indexterm" id="ccp_ab"/><a data-primary="networking" data-secondary="Chat Client program" data-type="indexterm" id="net_ccp"/>This program is a simple chat program. You can’t break in on ICQ or AIM with it, because&#13;
they each use their own protocol.<sup><a data-type="noteref" href="ch12.html#idm45290643134536" id="idm45290643134536-marker">6</a></sup> Rather, this program simply writes to and reads from a server.&#13;
The server for this will be presented in <a data-type="xref" href="ch13.html#javacook-netserver">Chapter 13</a>. How does it look when you run it?&#13;
<a data-type="xref" href="#javacook-netclient-FIG-2">Figure 12-2</a> shows me chatting all by myself one day.</p>&#13;
&#13;
<p>The code is reasonably self-explanatory. We read from the remote server in a thread to&#13;
make the input and the output run without blocking each other; this is discussed in&#13;
<a data-type="xref" href="ch16.html#javacook-threads">Chapter 16</a>. The reading and writing are discussed in this chapter. The program&#13;
is shown in <a data-type="xref" href="#javacook-netclient-EX-11">Example 12-11</a>.</p>&#13;
&#13;
<figure><div class="figure" id="javacook-netclient-FIG-2">&#13;
<img alt="jcb4 1202" src="assets/jcb4_1202.png"/>&#13;
<h6><span class="label">Figure 12-2. </span>Chat client in action</h6>&#13;
</div></figure>&#13;
<div data-type="example" id="javacook-netclient-EX-11">&#13;
<h5><span class="label">Example 12-11. </span>main/src/main/java/chat/ChatClient.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ChatClient</code> <code class="kd">extends</code> <code class="n">JFrame</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">serialVersionUID</code> <code class="o">=</code> <code class="o">-</code><code class="mi">3686334002367908392L</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">userName</code> <code class="o">=</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">getProperty</code><code class="o">(</code><code class="s">"user.name"</code><code class="o">,</code> <code class="s">"User With No Name"</code><code class="o">);</code>&#13;
    <code class="cm">/** The state of logged-in-ness */</code>&#13;
    <code class="kd">protected</code> <code class="kt">boolean</code> <code class="n">loggedIn</code><code class="o">;</code>&#13;
    <code class="cm">/* The main Frame. */</code>&#13;
    <code class="kd">protected</code> <code class="n">JFrame</code> <code class="n">cp</code><code class="o">;</code>&#13;
    <code class="cm">/** The default port number */</code>&#13;
    <code class="kd">protected</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">PORTNUM</code> <code class="o">=</code> <code class="n">ChatProtocol</code><code class="o">.</code><code class="na">PORTNUM</code><code class="o">;</code>&#13;
    <code class="cm">/** The actual port number */</code>&#13;
    <code class="kd">protected</code> <code class="kt">int</code> <code class="n">port</code><code class="o">;</code>&#13;
    <code class="cm">/** The network socket */</code>&#13;
    <code class="kd">protected</code> <code class="n">Socket</code> <code class="n">sock</code><code class="o">;</code>&#13;
    <code class="cm">/** PrintWriter for sending lines on socket */</code>&#13;
    <code class="kd">protected</code> <code class="n">PrintWriter</code> <code class="n">pw</code><code class="o">;</code>&#13;
    <code class="cm">/** TextField for input */</code>&#13;
    <code class="kd">protected</code> <code class="n">JTextField</code> <code class="n">tf</code><code class="o">;</code>&#13;
    <code class="cm">/** TextArea to display conversations */</code>&#13;
    <code class="kd">protected</code> <code class="n">JTextArea</code> <code class="n">ta</code><code class="o">;</code>&#13;
    <code class="cm">/** The Login Button */</code>&#13;
    <code class="kd">protected</code> <code class="n">JButton</code> <code class="n">loginButton</code><code class="o">;</code>&#13;
    <code class="cm">/** The LogOUT button */</code>&#13;
    <code class="kd">protected</code> <code class="n">JButton</code> <code class="n">logoutButton</code><code class="o">;</code>&#13;
    <code class="cm">/** The TitleBar title */</code>&#13;
    <code class="kd">final</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">TITLE</code> <code class="o">=</code> <code class="s">"ChatClient: Ian Darwin's Chat Room Client"</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">final</code> <code class="n">Executor</code> <code class="n">threadPool</code> <code class="o">=</code> <code class="n">Executors</code><code class="o">.</code><code class="na">newSingleThreadExecutor</code><code class="o">();</code>&#13;
&#13;
    <code class="cm">/** set up the GUI */</code>&#13;
    <code class="kd">public</code> <code class="nf">ChatClient</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">cp</code> <code class="o">=</code> <code class="k">this</code><code class="o">;</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">setTitle</code><code class="o">(</code><code class="n">TITLE</code><code class="o">);</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">setLayout</code><code class="o">(</code><code class="k">new</code> <code class="n">BorderLayout</code><code class="o">());</code>&#13;
        <code class="n">port</code> <code class="o">=</code> <code class="n">PORTNUM</code><code class="o">;</code>&#13;
&#13;
        <code class="c1">// The GUI</code>&#13;
        <code class="n">ta</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JTextArea</code><code class="o">(</code><code class="mi">14</code><code class="o">,</code> <code class="mi">80</code><code class="o">);</code>&#13;
        <code class="n">ta</code><code class="o">.</code><code class="na">setEditable</code><code class="o">(</code><code class="kc">false</code><code class="o">);</code>        <code class="c1">// readonly</code>&#13;
        <code class="n">ta</code><code class="o">.</code><code class="na">setFont</code><code class="o">(</code><code class="k">new</code> <code class="n">Font</code><code class="o">(</code><code class="s">"Monospaced"</code><code class="o">,</code> <code class="n">Font</code><code class="o">.</code><code class="na">PLAIN</code><code class="o">,</code> <code class="mi">11</code><code class="o">));</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">BorderLayout</code><code class="o">.</code><code class="na">NORTH</code><code class="o">,</code> <code class="n">ta</code><code class="o">);</code>&#13;
&#13;
        <code class="n">JPanel</code> <code class="n">p</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JPanel</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// The login button</code>&#13;
        <code class="n">p</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">loginButton</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Login"</code><code class="o">));</code>&#13;
        <code class="n">loginButton</code><code class="o">.</code><code class="na">setEnabled</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
        <code class="n">loginButton</code><code class="o">.</code><code class="na">requestFocus</code><code class="o">();</code>&#13;
        <code class="n">loginButton</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
                <code class="n">login</code><code class="o">();</code>&#13;
                <code class="n">loginButton</code><code class="o">.</code><code class="na">setEnabled</code><code class="o">(</code><code class="kc">false</code><code class="o">);</code>&#13;
                <code class="n">logoutButton</code><code class="o">.</code><code class="na">setEnabled</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
                <code class="n">tf</code><code class="o">.</code><code class="na">requestFocus</code><code class="o">();</code>    <code class="c1">// set keyboard focus in right place!</code>&#13;
        <code class="o">});</code>&#13;
&#13;
        <code class="c1">// The logout button</code>&#13;
        <code class="n">p</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">logoutButton</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Logout"</code><code class="o">));</code>&#13;
        <code class="n">logoutButton</code><code class="o">.</code><code class="na">setEnabled</code><code class="o">(</code><code class="kc">false</code><code class="o">);</code>&#13;
        <code class="n">logoutButton</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
                <code class="n">logout</code><code class="o">();</code>&#13;
                <code class="n">loginButton</code><code class="o">.</code><code class="na">setEnabled</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
                <code class="n">logoutButton</code><code class="o">.</code><code class="na">setEnabled</code><code class="o">(</code><code class="kc">false</code><code class="o">);</code>&#13;
                <code class="n">loginButton</code><code class="o">.</code><code class="na">requestFocus</code><code class="o">();</code>&#13;
        <code class="o">});</code>&#13;
&#13;
        <code class="n">p</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="k">new</code> <code class="n">JLabel</code><code class="o">(</code><code class="s">"Message here:"</code><code class="o">));</code>&#13;
        <code class="n">tf</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JTextField</code><code class="o">(</code><code class="mi">40</code><code class="o">);</code>&#13;
        <code class="n">tf</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
                <code class="k">if</code> <code class="o">(</code><code class="n">loggedIn</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">pw</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">ChatProtocol</code><code class="o">.</code><code class="na">CMD_BCAST</code><code class="o">+</code><code class="n">tf</code><code class="o">.</code><code class="na">getText</code><code class="o">());</code>&#13;
                    <code class="n">tf</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="s">""</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
        <code class="o">});</code>&#13;
        <code class="n">p</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">tf</code><code class="o">);</code>&#13;
&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">BorderLayout</code><code class="o">.</code><code class="na">SOUTH</code><code class="o">,</code> <code class="n">p</code><code class="o">);</code>&#13;
&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">setDefaultCloseOperation</code><code class="o">(</code><code class="n">JFrame</code><code class="o">.</code><code class="na">EXIT_ON_CLOSE</code><code class="o">);</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">pack</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="n">String</code> <code class="n">serverHost</code> <code class="o">=</code> <code class="s">"localhost"</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** LOG ME IN TO THE CHAT */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">login</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="cm">/** BufferedReader for reading from socket */</code>&#13;
        <code class="n">BufferedReader</code> <code class="n">is</code><code class="o">;</code>&#13;
&#13;
        <code class="n">showStatus</code><code class="o">(</code><code class="s">"In login!"</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">loggedIn</code><code class="o">)</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">sock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="n">serverHost</code><code class="o">,</code> <code class="n">port</code><code class="o">);</code>&#13;
            <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
            <code class="n">pw</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintWriter</code><code class="o">(</code><code class="n">sock</code><code class="o">.</code><code class="na">getOutputStream</code><code class="o">(),</code> <code class="kc">true</code><code class="o">);</code>&#13;
            <code class="n">showStatus</code><code class="o">(</code><code class="s">"Got socket"</code><code class="o">);</code>&#13;
&#13;
            <code class="c1">// FAKE LOGIN FOR NOW - no password needed</code>&#13;
            <code class="n">pw</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">ChatProtocol</code><code class="o">.</code><code class="na">CMD_LOGIN</code> <code class="o">+</code> <code class="n">userName</code><code class="o">);</code>&#13;
&#13;
            <code class="n">loggedIn</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code><code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">warn</code><code class="o">(</code><code class="s">"Can't get socket to "</code> <code class="o">+</code>&#13;
                <code class="n">serverHost</code> <code class="o">+</code> <code class="s">"/"</code> <code class="o">+</code> <code class="n">port</code> <code class="o">+</code> <code class="s">": "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
            <code class="n">cp</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="k">new</code> <code class="n">JLabel</code><code class="o">(</code><code class="s">"Can't get socket: "</code> <code class="o">+</code> <code class="n">e</code><code class="o">));</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="c1">// Construct and start the reader: from server to textarea.</code>&#13;
        <code class="c1">// Make a Thread to avoid lockups.</code>&#13;
        <code class="n">Runnable</code> <code class="n">readerThread</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Runnable</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
                <code class="n">String</code> <code class="n">line</code><code class="o">;</code>&#13;
                <code class="k">try</code> <code class="o">{</code>&#13;
                    <code class="k">while</code> <code class="o">(</code><code class="n">loggedIn</code> <code class="o">&amp;&amp;</code> <code class="o">((</code><code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">))</code>&#13;
                        <code class="n">ta</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">line</code> <code class="o">+</code> <code class="s">"\n"</code><code class="o">);</code>&#13;
                <code class="o">}</code> <code class="k">catch</code><code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">showStatus</code><code class="o">(</code><code class="s">"Lost another client!\n"</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
                    <code class="k">return</code><code class="o">;</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">};</code>&#13;
        <code class="n">threadPool</code><code class="o">.</code><code class="na">execute</code><code class="o">(</code><code class="n">readerThread</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Log me out, Scotty, there's no intelligent life here! */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">logout</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(!</code><code class="n">loggedIn</code><code class="o">)</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="n">loggedIn</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">sock</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code>&#13;
                <code class="n">sock</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">ign</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// so what?</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">showStatus</code><code class="o">(</code><code class="n">String</code> <code class="n">message</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">message</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">warn</code><code class="o">(</code><code class="n">String</code> <code class="n">message</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">JOptionPane</code><code class="o">.</code><code class="na">showMessageDialog</code><code class="o">(</code><code class="k">this</code><code class="o">,</code> <code class="n">message</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** A main method to allow the client to be run as an Application */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">ChatClient</code> <code class="n">room101</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ChatClient</code><code class="o">();</code>&#13;
        <code class="n">room101</code><code class="o">.</code><code class="na">pack</code><code class="o">();</code>&#13;
        <code class="n">room101</code><code class="o">.</code><code class="na">setVisible</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-netclient-SECT-10.1">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>There are many better-structured ways to write a chat client, including WebSockets, RMI, and JMS.&#13;
RMI is Java’s RPC interface and is included both in Java SE and Java EE;&#13;
it is not described in this edition of this book, but you can find the RMI chapter from previous editions on the <a href="http://darwinsys.com/java/rmi">my website</a>.&#13;
The other technologies are part of the Java Enterprise so, again,&#13;
I refer you to <a data-primary="Gupta, Arun" data-secondary="Java EE 7 Essentials: Enterprise Developer Handbook" data-type="indexterm" id="idm45290642911784"/><a data-primary="Java EE 7 Essentials: Enterprise Developer Handbook (Gupta)" data-type="indexterm" id="idm45290642910712"/>Arun Gupta’s <em><a class="orm:hideurl" href="http://shop.oreilly.com/product/0636920030614.do">Java EE 7 Essentials</a></em>.</p>&#13;
&#13;
<p>If your communication goes over the public internet, you do need to encrypt your socket connection,&#13;
so check out Sun’s JSSE (Java Secure Socket Extension).&#13;
If you took my earlier advice and used the standard HTTP protocol, you can encrypt the conversation&#13;
just by changing the URL to https.</p>&#13;
&#13;
<p>For a good overview of network programming from the C programmer’s point of view, see the late<a data-primary="Steven, W. Richard" data-secondary="Unix Network Programming" data-type="indexterm" id="idm45290642907544"/><a data-primary="Unix Network Programming (Stevens)" data-type="indexterm" id="idm45290642906552"/> W. Richard Stevens’ <em>Unix Network Programming</em> (Prentice Hall). Despite the book’s name, it’s really about socket and TCP/IP/UDP programming and covers all parts of the (Unix) networking API and protocols such as TFTP in amazing detail.<a data-primary="" data-startref="ccp_ab" data-type="indexterm" id="idm45290642905112"/><a data-primary="" data-startref="net_ccp" data-type="indexterm" id="idm45290642312424"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="12.11 Program: Simple HTTP Link Checker" data-type="sect1"><div class="sect1" id="javacook-netclient-linkchecker">&#13;
<h1>12.11 Program: Simple HTTP Link Checker</h1>&#13;
&#13;
<p><a data-primary="networking" data-secondary="Simple HTTP Link Checker program" data-type="indexterm" id="net_shttp"/><a data-primary="Simple HTTP Link Checker program" data-type="indexterm" id="shttp_ab"/>Checking links is an ongoing problem for website owners as well as those who write&#13;
technical documentation that links to external sources (e.g., people like the author&#13;
of the book you are now reading).&#13;
<em>Link checkers</em> are the tool they inevitably use to validate the links in their pages,&#13;
be they web pages or book pages.&#13;
Implementing a link checker is basically a matter of (a) extracting links and (b) opening them.&#13;
Thus, we have the program in <a data-type="xref" href="#javacook-netclient-ex-kwiklinkchecker">Example 12-12</a>. I call it <code>KwikLinkChecker</code> as it is a bit on the quick-and-dirty side—it&#13;
doesn’t validate the content of the link to be sure it still contains what it once did; so if, say,&#13;
an open source project forgets to renew its domain registration, and it gets taken over by a porn&#13;
site, well, <code>KwikLinkChecker</code> will never know.&#13;
But that said, it does its job reasonably well, and reasonably quickly.</p>&#13;
<div data-type="example" id="javacook-netclient-ex-kwiklinkchecker">&#13;
<h5><span class="label">Example 12-12. </span>darwinsys-api/src/main/java/com/darwinsys/tools/KwikLinkChecker.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">    <code class="cm">/**</code>&#13;
<code class="cm">     * Check one HTTP link; not recursive. Returns a LinkStatus with</code>&#13;
<code class="cm">     * boolean success, and the filename or an error message in the</code>&#13;
<code class="cm">     * message part of the LinkStatus.  The end of this method is one of</code>&#13;
<code class="cm">     * the few places where a whole raft of different "catch" clauses is</code>&#13;
<code class="cm">     * actually needed for the intent of the program.</code>&#13;
<code class="cm">     * @param urlString the link to check</code>&#13;
<code class="cm">     * @return the link's status</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"exports"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">LinkStatus</code> <code class="nf">check</code><code class="o">(</code><code class="n">String</code> <code class="n">urlString</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">HttpResponse</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">resp</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="na">send</code><code class="o">(</code>&#13;
                <code class="n">HttpRequest</code><code class="o">.</code><code class="na">newBuilder</code><code class="o">(</code><code class="n">URI</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="n">urlString</code><code class="o">))</code>&#13;
                <code class="o">.</code><code class="na">header</code><code class="o">(</code><code class="s">"User-Agent"</code><code class="o">,</code> <code class="n">getClass</code><code class="o">().</code><code class="na">getName</code><code class="o">())</code>&#13;
                <code class="o">.</code><code class="na">GET</code><code class="o">()</code>&#13;
                <code class="o">.</code><code class="na">build</code><code class="o">(),</code>&#13;
                <code class="n">BodyHandlers</code><code class="o">.</code><code class="na">ofString</code><code class="o">());</code>&#13;
&#13;
            <code class="c1">// Collect the results</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">resp</code><code class="o">.</code><code class="na">statusCode</code><code class="o">()</code> <code class="o">==</code> <code class="mi">200</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">resp</code><code class="o">.</code><code class="na">body</code><code class="o">());</code>&#13;
            <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">printf</code><code class="o">(</code><code class="s">"ERROR: Status %d on request %s\n"</code><code class="o">,</code>&#13;
                    <code class="n">resp</code><code class="o">.</code><code class="na">statusCode</code><code class="o">(),</code> <code class="n">urlString</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
            <code class="k">switch</code> <code class="o">(</code><code class="n">resp</code><code class="o">.</code><code class="na">statusCode</code><code class="o">())</code> <code class="o">{</code>&#13;
            <code class="k">case</code> <code class="mi">200</code><code class="o">:</code>&#13;
                <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">true</code><code class="o">,</code> <code class="n">urlString</code><code class="o">);</code>&#13;
            <code class="k">case</code> <code class="mi">403</code><code class="o">:</code>&#13;
                <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code><code class="s">"403: "</code> <code class="o">+</code> <code class="n">urlString</code> <code class="o">);</code>&#13;
            <code class="k">case</code> <code class="mi">404</code><code class="o">:</code>&#13;
                <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code><code class="s">"404: "</code> <code class="o">+</code> <code class="n">urlString</code> <code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">true</code><code class="o">,</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IllegalArgumentException</code> <code class="o">|</code> <code class="n">MalformedURLException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// JDK throws IAE if host can't be determined from URL string</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code> <code class="s">"Malformed URL: "</code> <code class="o">+</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">UnknownHostException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code> <code class="s">"Host invalid/dead: "</code> <code class="o">+</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">FileNotFoundException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code><code class="s">"NOT FOUND (404) "</code> <code class="o">+</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">ConnectException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code> <code class="s">"Server not listening: "</code> <code class="o">+</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">SocketException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code> <code class="n">e</code> <code class="o">+</code> <code class="s">": "</code> <code class="o">+</code> <code class="n">urlString</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code> <code class="n">e</code><code class="o">.</code><code class="na">toString</code><code class="o">());</code> <code class="c1">// includes failing URL</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">LinkStatus</code><code class="o">(</code><code class="kc">false</code><code class="o">,</code> <code class="n">urlString</code> <code class="o">+</code> <code class="s">": "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code></pre></div>&#13;
&#13;
<p>Fancier link checkers are surely available, but this one works for me.<a data-primary="" data-startref="net_shttp" data-type="indexterm" id="idm45290642294664"/><a data-primary="" data-startref="shttp_ab" data-type="indexterm" id="idm45290642293816"/><a data-primary="" data-startref="net_ch" data-type="indexterm" id="idm45290642292936"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45290645651848"><sup><a href="ch12.html#idm45290645651848-marker">1</a></sup> The location where it is looked up varies. It might be in a file named <em>/etc/services</em> on Unix; in the <em>services</em> file in a subdirectory of <em>\ or _\winnt</em> in Windows; in a centralized registry such as Sun’s Network Information Services (NIS, formerly YP); or in some other platform- or network-dependent location.</p><p data-type="footnote" id="idm45290645253384"><sup><a href="ch12.html#idm45290645253384-marker">2</a></sup> It used to be universal, when most networked systems were administered by full-time systems people who had been trained or served an apprenticeship. Today many machines on the internet don’t have <code>localhost</code> configured properly.</p><p data-type="footnote" id="idm45290644551496"><sup><a href="ch12.html#idm45290644551496-marker">3</a></sup> The UDP packet may need to be fragmented by some networks, but this is not germane to us at the UDP level, because it will reassemble the network packets into our single-entity UDP packet at the other end.</p><p data-type="footnote" id="idm45290643937208"><sup><a href="ch12.html#idm45290643937208-marker">4</a></sup> When the application doesn’t care, these port numbers are usually made up by the operating system. For example, when you call a company from a pay phone or cell phone, the company doesn’t usually care what number you are calling from, and if it does, there are ways to find out. Generated port numbers generally range from 1024 (the first nonprivileged port; see <a data-type="xref" href="ch13.html#javacook-netserver">Chapter 13</a>) to 65535 (the largest value that can be held in a 16-bit port number).</p><p data-type="footnote" id="idm45290643677448"><sup><a href="ch12.html#idm45290643677448-marker">5</a></sup> Beware of security holes; don’t turn a TFTP server loose on the internet without first reading a good security book, such as <a href="http://shop.oreilly.com/product/9781565928718.do"><em>Building Internet Firewalls</em></a> by D. Chapman et al. (O’Reilly).</p><p data-type="footnote" id="idm45290643134536"><sup><a href="ch12.html#idm45290643134536-marker">6</a></sup> For an open source program that provides an IM service to let you talk to both from the same program, check out Jabber at <a href="http://www.jabber.org"><em class="hyperlink">http://www.jabber.org</em></a>.</p></div></div></section></body></html>