<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. Adding Database Access to &#10;Your Spring Boot App"><div class="chapter" id="sbur-04">
<h1><span class="label">Chapter 4. </span>Adding Database Access to 
<span class="keep-together">Your Spring Boot App</span></h1>


<p><a data-type="indexterm" data-primary="database access" id="ix_database_access_ch4"/>As discussed in the previous chapter, applications often expose stateless APIs for many very good reasons. Behind the scenes, however, very few useful applications are entirely ephemeral; state of some kind is usually stored for <em>something</em>. For example, every request to an online store’s shopping cart may well include its state, but once the order is placed, that order’s data is kept. There are many ways to do this, and many ways to share or route this data, but invariably there are one or more databases involved within nearly all systems of sufficient size.</p>

<p>In this chapter, I’ll demonstrate how to add database access to the Spring Boot application created in the previous chapter. This chapter is meant to be a short primer on Spring Boot’s data capabilities, and subsequent chapters will dive much deeper. But in many cases, the basics covered here still apply well and provide a fully sufficient solution. Let’s dig in.</p>
<div data-type="tip"><h1>Code Checkout Checkup</h1>
<p>Please check out branch <em>chapter4begin</em> from the code repository to begin.</p>
</div>






<section data-type="sect1" data-pdf-bookmark="Priming Autoconfig for Database Access"><div class="sect1" id="idm45693963999080">
<h1>Priming Autoconfig for Database Access</h1>

<p><a data-type="indexterm" data-primary="autoconfiguration" id="idm45693963997864"/><a data-type="indexterm" data-primary="configuration" data-secondary="autoconfiguration" id="idm45693963997160"/><a data-type="indexterm" data-primary="database access" data-secondary="autoconfig priming" id="idm45693963996216"/>As demonstrated earlier, Spring Boot aims to simplify to the maximum extent possible the so-called 80–90% use case: the patterns of code and process that developers do over and over and over again. Once patterns are identified, Boot springs into action to initialize the required beans automatically, with sensible default configurations. Customizing a capability is as simple as providing one or more property values or creating a tailored version of one or more beans; once autoconfig detects the changes, it backs off and follows the developer’s guidance. Database access is a perfect example.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="What Do We Hope to Gain?"><div class="sect1" id="idm45693963994264">
<h1>What Do We Hope to Gain?</h1>

<p>In our earlier example application, I used an <code>ArrayList</code> to store and maintain our list of coffees. This approach is straightforward enough for a single application, but it does have its drawbacks.</p>

<p>First, it isn’t resilient at all. If your application or the platform running it fails, all changes made to the list while the app was running—whether for seconds or 
<span class="keep-together">months—disappear.</span></p>

<p>Second, it doesn’t scale. Starting another instance of the application results in that second (or subsequent) app instance having its own distinct list of coffees it maintains. Data isn’t shared between the multiple instances, so changes to coffees made by one instance—new coffees, deletions, update—aren’t visible to anyone accessing a different app instance.</p>

<p>Clearly this is no way to run a railroad.</p>

<p>I cover a few different ways to fully solve these very real problems in upcoming chapters. But for now, let’s lay some groundwork that will serve as useful steps on the path there.</p>








<section data-type="sect2" data-pdf-bookmark="Adding a Database Dependency"><div class="sect2" id="idm45693963989016">
<h2>Adding a Database Dependency</h2>

<p><a data-type="indexterm" data-primary="dependency management" data-secondary="database access" id="ix_depend_database_access"/><a data-type="indexterm" data-primary="database access" data-secondary="adding a dependency" id="ix_database_access_depend"/>In order to access a database from your Spring Boot application, you need a few things:</p>

<ul>
<li>
<p>A running database, whether initiated by/embedded within your application or simply accessible to your application</p>
</li>
<li>
<p>Database drivers enabling programmatic access, usually provided by the database vendor</p>
</li>
<li>
<p>A Spring Data module for accessing the target database</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="JPA (Java Persistence API)" data-secondary="adding database dependency" id="ix_jpa_depend"/>Certain Spring Data modules include the appropriate database drivers as a single selectable dependency from within the Spring Initializr. In other cases, such as when Spring uses the Java Persistence API (JPA) to access JPA-compliant datastores, it’s necessary to choose the Spring Data JPA dependency <em>and</em> a dependency for the target database’s specific driver, e.g., PostgreSQL.</p>

<p>To take the first step forward from memory constructs to persistent database, I’ll begin by adding dependencies, and thus capabilities, to our project’s build file.</p>

<p><a data-type="indexterm" data-primary="H2 database driver" id="idm45693963788344"/>H2 is a fast database written completely in Java that has some interesting and useful features. For one thing, it’s JPA-compliant, so we can connect our application to it in the same manner we would to any other JPA database like Microsoft SQL, MySQL, Oracle, or PostgreSQL. It also has in-memory and disk-based modes. This allows us some useful options after we convert from our in-memory <code>ArrayList</code> to an in-memory database: we can either change H2 to disk-based persistence or—since we’re now using a JPA database—change to a different JPA database. Either option becomes much simpler at that point.</p>

<p>To enable our application to interact with the H2 database, I’ll add the following two dependencies to the <code>&lt;dependencies&gt;</code> section of our project’s <em>pom.xml</em>:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.boot<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-boot-starter-data-jpa<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>com.h2database<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>h2<code class="nt">&lt;/artifactId&gt;</code>
    <code class="nt">&lt;scope&gt;</code>runtime<code class="nt">&lt;/scope&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The H2 database driver dependency’s scope of <code>runtime</code> indicates that it will be present in the runtime and test classpath but not in the compile classpath. This is a good practice to adopt for libraries that are not required for compilation.</p>
</div>

<p>Once you save your updated <em>pom.xml</em> and (if necessary) reimport/refresh your Maven dependencies, you have access to the functionality included within the added dependencies. Next, it’s time to write a bit of code to use it.<a data-type="indexterm" data-primary="" data-startref="ix_database_access_depend" id="idm45693963776808"/><a data-type="indexterm" data-primary="" data-startref="ix_depend_database_access" id="idm45693963775864"/><a data-type="indexterm" data-primary="" data-startref="ix_jpa_depend" id="idm45693963774952"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Adding Code"><div class="sect2" id="idm45693963988392">
<h2>Adding Code</h2>

<p><a data-type="indexterm" data-primary="database access" data-secondary="adding code" id="ix_database_access_code"/>Since we already have code in place to manage coffees in some fashion, we’ll need to refactor a bit while we add our new database capabilities. I find the best place to begin is with the domain class(es), in this case, <code>Coffee</code>.</p>










<section data-type="sect3" data-pdf-bookmark="The @Entity"><div class="sect3" id="idm45693963755912">
<h3>The @Entity</h3>

<p><a data-type="indexterm" data-primary="@Entity" id="ix_at_entity"/>As mentioned earlier, H2 is a JPA-compliant database, so I’ll add JPA annotations to connect the dots. To the <code>Coffee</code> class itself I add an <code>@Entity</code> annotation from <code>javax.persistence</code> that indicates <code>Coffee</code> is a persistable entity, and to the existing <code>id</code> member variable, I add the <code>@Id</code> annotation (also from <code>javax.persistence</code>) to mark it as the database table’s ID field.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If the class name—<code>Coffee</code> in this case—doesn’t match the desired database table name, the <code>@Entity</code> annotation accepts a <code>name</code> parameter for specifying the data table name to match the annotated entity.</p>
</div>

<p>If your IDE is helpful enough, it may provide you feedback that something is still missing in the <code>Coffee</code> class. For example, IntelliJ underlines the class name in red and provides the helpful pop-up upon mouseover shown in <a data-type="xref" href="#missing_constructor_in_the_jpa_coffee_class">Figure 4-1</a>.</p>

<figure><div id="missing_constructor_in_the_jpa_coffee_class" class="figure">
<img src="Images/sbur_0401.png" alt="sbur 0401" width="600" height="110"/>
<h6><span class="label">Figure 4-1. </span>Missing constructor in the JPA <code>Coffee</code> class</h6>
</div></figure>

<p>Java Persistence API requires a no-argument constructor for use when creating objects from database table rows, so I’ll add that next. This results in our next IDE warning, as displayed in <a data-type="xref" href="#with_a_no_arg_constructor_id_can_no_longer_be_final">Figure 4-2</a>: in order to have a no-arg constructor, we must make all member variables mutable, i.e., nonfinal.</p>

<figure><div id="with_a_no_arg_constructor_id_can_no_longer_be_final" class="figure">
<img src="Images/sbur_0402.png" alt="sbur 0402" width="600" height="193"/>
<h6><span class="label">Figure 4-2. </span>With a no-arg constructor, <code>id</code> cannot be final</h6>
</div></figure>

<p>Removing the <code>final</code> keyword from the declaration for the <code>id</code> member variable solves that. Making <code>id</code> mutable also requires our <code>Coffee</code> class to have a mutator method for <code>id</code> for JPA to be able to assign a value to that member, so I add the <code>setId()</code> method as well, as shown in <a data-type="xref" href="#the_new_setid_method">Figure 4-3</a>.<a data-type="indexterm" data-primary="" data-startref="ix_at_entity" id="idm45693963715448"/></p>

<figure><div id="the_new_setid_method" class="figure">
<img src="Images/sbur_0403.png" alt="sbur 0403" width="600" height="124"/>
<h6><span class="label">Figure 4-3. </span>The new <code>setId()</code> method</h6>
</div></figure>
</div></section>













<section data-type="sect3" data-pdf-bookmark="The Repository"><div class="sect3" id="idm45693963712120">
<h3>The Repository</h3>

<p><a data-type="indexterm" data-primary="repository" data-secondary="connecting to database" id="ix_repository_connect"/>With <code>Coffee</code> now defined as a valid JPA entity able to be stored and retrieved, it’s time to make the connection to the database</p>

<p>For such a simple concept, configuring and establishing a database connection in the Java ecosystem has long been a rather cumbersome affair. As mentioned in <a data-type="xref" href="ch01.xhtml#sbur-01">Chapter 1</a>, using an application server to host a Java application required developers to perform several tedious steps just to get things ready. Once you started interacting with the database, or if you were accessing a datastore directly from a Java utility or client application, you would be expected to perform additional steps involving <code>PersistenceUnit</code>, <code>EntityManagerFactory</code>, and <code>EntityManager</code> APIs (and possibly <code>DataSource</code> objects), open and close the database, and more. It’s a lot of repetitive ceremony for something developers do so often.</p>

<p>Spring Data introduces the concept of repositories. A <code>Repository</code> is an interface defined in Spring Data as a useful abstraction above various databases. There are other mechanisms for accessing databases from Spring Data that will be explained in subsequent chapters, but the various flavors of <code>Repository</code> are arguably the most useful in the most cases.</p>

<p><code>Repository</code> itself is a mere placeholder for the following types:</p>

<ul>
<li>
<p>The object stored in the database</p>
</li>
<li>
<p>The object’s unique ID/primary key field</p>
</li>
</ul>

<p>There is a lot more to repositories, of course, and I cover a great deal of that in <a data-type="xref" href="ch06.xhtml#sbur-06">Chapter 6</a>. <a data-type="indexterm" data-primary="CrudRepository" id="ix_crud_repository"/><a data-type="indexterm" data-primary="JpaRepository" id="idm45693963698136"/>For now, let’s focus on two that are directly relevant to our current example: <code>CrudRepository</code> and <code>JpaRepository</code>.</p>

<p>Recall my earlier mention of the preferred practice of writing code to use the highest-level interface suited to purpose? While <code>JpaRepository</code> extends a handful of interfaces and thus incorporates broader functionality, <code>CrudRepository</code> covers all of the key <a data-type="indexterm" data-primary="CRUD" id="idm45693963695080"/>CRUD capabilities and is sufficient for our (so far) simple application.</p>

<p>The first thing to do to enable repository support for our application is to define an interface specific to our application by extending a Spring Data <code>Repository</code> interface:
.interfaceCoffeeRepo</p>

<pre data-type="programlisting" data-code-language="java"><code class="kd">interface</code> <code class="nc">CoffeeRepository</code> <code class="kd">extends</code> <code class="n">CrudRepository</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="o">{}</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The two types defined are the object type to store and the type of its unique ID.</p>
</div>

<p>This represents the simplest expression of repository creation within a Spring Boot app. It’s possible, and very useful at times, to define queries for a repository; I’ll dive into that in a future chapter as well. But here is the “magical” part: Spring Boot’s autoconfiguration takes into account the database driver on the classpath (in this case, H2), the repository interface defined in our application, and the JPA entity <code>Coffee</code> class definition and creates a database proxy bean <em>on our behalf</em>. No need to write lines of nearly identical boilerplate for every application when the patterns are this clear and consistent, which frees the developer to work on new, requested 
<span class="keep-together">functionality.</span></p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="The utility, aka “Springing” into action"><div class="sect3" id="idm45693963711496">
<h3>The utility, aka “Springing” into action</h3>

<p>Now to put that repository to work. I’ll approach this step by step as in previous chapters, introducing functionality first and polishing afterward.</p>

<p><a data-type="indexterm" data-primary="RestApiDemoController" id="ix_RestApiDemoController"/>First, I’ll autowire/inject the repository bean into <code>RestApiDemoController</code> so the controller can access it when receiving requests via the external API, as shown in <a data-type="xref" href="#autowire_repository_into_restapidemocontrollder">Figure 4-4</a>.</p>

<p>First I declare the member variable with:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kd">private</code> <code class="kd">final</code> <code class="n">CoffeeRepository</code> <code class="n">coffeeRepository</code><code class="o">;</code></pre>

<p>Next, I add it as a parameter to the constructor with:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="nf">RestApiDemoController</code><code class="o">(</code><code class="n">CoffeeRepository</code> <code class="n">coffeeRepository</code><code class="o">){}</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Prior to Spring Framework 4.3, it was necessary in all cases to add the <code>@Autowired</code> annotation above the method to indicate when a parameter represented a Spring bean to be autowired/injected. From 4.3 onward, a class with a single constructor doesn’t require the annotation for autowired parameters, a useful time-saver. <a data-type="indexterm" data-primary="@Autowired" id="idm45693963665640"/></p>
</div>

<figure><div id="autowire_repository_into_restapidemocontrollder" class="figure">
<img src="Images/sbur_0404.png" alt="sbur 0404" width="600" height="526"/>
<h6><span class="label">Figure 4-4. </span>Autowire repository into <code>RestApiDemoController</code></h6>
</div></figure>

<p>With the repository in place, I delete the <code>List&lt;Coffee&gt;</code> member variable and change the initial population of that list in the constructor to instead save the same coffees to the repository, as in <a data-type="xref" href="#autowire_repository_into_restapidemocontrollder">Figure 4-4</a>.</p>

<p>Per <a data-type="xref" href="#replacing_the_removed_coffees_member_variable">Figure 4-5</a>, removing the <code>coffees</code> variable immediately flags all references to it as unresolvable symbols, so the next task is replacing those with appropriate repository interactions.</p>

<figure><div id="replacing_the_removed_coffees_member_variable" class="figure">
<img src="Images/sbur_0405.png" alt="sbur 0405" width="600" height="150"/>
<h6><span class="label">Figure 4-5. </span>Replacing the removed <code>coffees</code> member variable</h6>
</div></figure>

<p>As a simple retrieval of all coffees with no parameters, the <code>getCoffees()</code> method is a great place to begin. <a data-type="indexterm" data-primary="findAll()" id="idm45693963604472"/>Using the <code>findAll()</code> method built into <code>CrudRepository</code>, it isn’t even necessary to change the return type of <code>getCoffees()</code> as it also returns an <code>Iterable</code> type; simply calling <code>coffeeRepository.findAll()</code> and returning its result does the job, as shown here:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GetMapping</code>
<code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">getCoffees</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">findAll</code><code class="o">();</code>
<code class="o">}</code></pre>

<p>Refactoring the <code>getCoffeeById()</code> method presents some insights into how much simpler your code can be, thanks to the functionality that repositories bring to the mix. We no longer have to manually search the list of coffees for a matching <code>id</code>; <code>CrudRepository</code>’s <code>findById()</code> method handles it for us, as demonstrated in the following code snippet. <a data-type="indexterm" data-primary="findById()" id="idm45693963566920"/>And since <code>findById()</code> returns an <code>Optional</code> type, no changes whatsoever are required for our method signature:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GetMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
<code class="n">Optional</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">getCoffeeById</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">findById</code><code class="o">(</code><code class="n">id</code><code class="o">);</code>
<code class="o">}</code></pre>

<p>Converting the <code>postCoffee()</code> method to use the repository is also a fairly straightforward endeavor, as shown here:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@PostMapping</code>
<code class="n">Coffee</code> <code class="nf">postCoffee</code><code class="o">(</code><code class="nd">@RequestBody</code> <code class="n">Coffee</code> <code class="n">coffee</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">);</code>
<code class="o">}</code></pre>

<p>With the <code>putCoffee()</code> method, we again see some of the substantial time- and code-saving functionality of the <code>CrudRepository</code> on display. I use the built-in <code>existsById()</code> repository method to determine if this is a new or existing <code>Coffee</code> and return the appropriate HTTP status code along with the saved <code>Coffee</code>, as shown in this listing:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@PutMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
<code class="n">ResponseEntity</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">putCoffee</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">,</code>
                                 <code class="nd">@RequestBody</code> <code class="n">Coffee</code> <code class="n">coffee</code><code class="o">)</code> <code class="o">{</code>

    <code class="k">return</code> <code class="o">(!</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">existsById</code><code class="o">(</code><code class="n">id</code><code class="o">))</code>
            <code class="o">?</code> <code class="k">new</code> <code class="n">ResponseEntity</code><code class="o">&lt;&gt;(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">),</code>
                  <code class="n">HttpStatus</code><code class="o">.</code><code class="na">CREATED</code><code class="o">)</code>
            <code class="o">:</code> <code class="k">new</code> <code class="n">ResponseEntity</code><code class="o">&lt;&gt;(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">),</code> <code class="n">HttpStatus</code><code class="o">.</code><code class="na">OK</code><code class="o">);</code>
<code class="o">}</code></pre>
<div class="hard-pagebreak"/>

<p><a data-type="indexterm" data-primary="deleteById()" id="idm45693963466248"/>Finally, I update the <code>deleteCoffee()</code> method to use <code>CrudRepository</code>’s built-in <code>deleteById()</code> method, as shown here:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@DeleteMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
<code class="kt">void</code> <code class="nf">deleteCoffee</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">deleteById</code><code class="o">(</code><code class="n">id</code><code class="o">);</code>
<code class="o">}</code></pre>

<p>Leveraging a repository bean created using the fluent API of <code>CrudRepository</code> streamlines the code for the <code>RestApiDemoController</code> and makes it much clearer, in terms of both readability and understandability, as evidenced by the complete code listing:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@RestController</code>
<code class="nd">@RequestMapping</code><code class="o">(</code><code class="s">"/coffees"</code><code class="o">)</code>
<code class="kd">class</code> <code class="nc">RestApiDemoController</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">CoffeeRepository</code> <code class="n">coffeeRepository</code><code class="o">;</code>

    <code class="kd">public</code> <code class="nf">RestApiDemoController</code><code class="o">(</code><code class="n">CoffeeRepository</code> <code class="n">coffeeRepository</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">coffeeRepository</code> <code class="o">=</code> <code class="n">coffeeRepository</code><code class="o">;</code>

        <code class="k">this</code><code class="o">.</code><code class="na">coffeeRepository</code><code class="o">.</code><code class="na">saveAll</code><code class="o">(</code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Cereza"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Ganador"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Lareño"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Três Pontas"</code><code class="o">)</code>
        <code class="o">));</code>
    <code class="o">}</code>

    <code class="nd">@GetMapping</code>
    <code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">getCoffees</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">findAll</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="nd">@GetMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
    <code class="n">Optional</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">getCoffeeById</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">findById</code><code class="o">(</code><code class="n">id</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@PostMapping</code>
    <code class="n">Coffee</code> <code class="nf">postCoffee</code><code class="o">(</code><code class="nd">@RequestBody</code> <code class="n">Coffee</code> <code class="n">coffee</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@PutMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
    <code class="n">ResponseEntity</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">putCoffee</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">,</code>
                                     <code class="nd">@RequestBody</code> <code class="n">Coffee</code> <code class="n">coffee</code><code class="o">)</code> <code class="o">{</code>

        <code class="k">return</code> <code class="o">(!</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">existsById</code><code class="o">(</code><code class="n">id</code><code class="o">))</code>
                <code class="o">?</code> <code class="k">new</code> <code class="n">ResponseEntity</code><code class="o">&lt;&gt;(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">),</code>
                <code class="n">HttpStatus</code><code class="o">.</code><code class="na">CREATED</code><code class="o">)</code>
                <code class="o">:</code> <code class="k">new</code> <code class="n">ResponseEntity</code><code class="o">&lt;&gt;(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">),</code> <code class="n">HttpStatus</code><code class="o">.</code><code class="na">OK</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@DeleteMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
    <code class="kt">void</code> <code class="nf">deleteCoffee</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">deleteById</code><code class="o">(</code><code class="n">id</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Now all that remains is to verify that our application works as expected and external functionality remains the same.<a data-type="indexterm" data-primary="TDD (Test Driven Development)" id="idm45693963344696"/></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>An alternative approach to testing functionality—and a recommended practice—is to create unit tests first, a la Test Driven Development (TDD). I strongly recommend this approach in real-world software development environments, but I’ve found that when the goal is to demonstrate and explain discrete software development concepts, less is better; showing as little as possible to clearly communicate key concepts increases signal and decreases noise, even if the noise is useful later. As such, I cover testing in a dedicated chapter later in this book.<a data-type="indexterm" data-primary="" data-startref="ix_database_access_code" id="idm45693963342632"/><a data-type="indexterm" data-primary="" data-startref="ix_crud_repository" id="idm45693963131480"/><a data-type="indexterm" data-primary="" data-startref="ix_repository_connect" id="idm45693963130536"/><a data-type="indexterm" data-primary="" data-startref="ix_RestApiDemoController" id="idm45693963129592"/></p>
</div>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Saving and Retrieving Data"><div class="sect1" id="idm45693963681560">
<h1>Saving and Retrieving Data</h1>

<p><a data-type="indexterm" data-primary="HTTPie" id="ix_httpie_ch4"/><a data-type="indexterm" data-primary="database access" data-secondary="saving and retrieving data" id="ix_database_access_save"/>Once more unto the breach, dear friends, once more: accessing the API from the command line using HTTPie.
Querying the <em>coffees</em> endpoint results in the same four coffees being returned from our H2 database as before, as shown in <a data-type="xref" href="#get_all_coffees">Figure 4-6</a>.</p>

<p><a data-type="indexterm" data-primary="GET" id="idm45693963123560"/><a data-type="indexterm" data-primary="HTTP verbs" data-secondary="GET" id="idm45693963122856"/><a data-type="indexterm" data-primary="JSON (JavaScript Object Notation)" data-secondary="GET" id="idm45693963121912"/>Copying the <code>id</code> field for one of the coffees just listed and pasting it into a coffee-specific <code>GET</code> request produces the output shown in <a data-type="xref" href="#get_a_coffee_4">Figure 4-7</a>.</p>

<figure><div id="get_all_coffees" class="figure">
<img src="Images/sbur_0406.png" alt="sbur 0406" width="600" height="607"/>
<h6><span class="label">Figure 4-6. </span><code>GET</code>-ting all coffees</h6>
</div></figure>

<figure><div id="get_a_coffee_4" class="figure">
<img src="Images/sbur_0407.png" alt="sbur 0407" width="600" height="205"/>
<h6><span class="label">Figure 4-7. </span><code>GET</code>-ting a coffee</h6>
</div></figure>

<p><a data-type="indexterm" data-primary="POST" id="idm45693963114344"/><a data-type="indexterm" data-primary="JSON (JavaScript Object Notation)" data-secondary="POST" id="idm45693963113640"/><a data-type="indexterm" data-primary="HTTP verbs" data-secondary="POST" id="idm45693963112632"/>In <a data-type="xref" href="#post_a_new_coffee_to_the_list_4">Figure 4-8</a>, I <code>POST</code> a new coffee to the application and its database.</p>

<figure><div id="post_a_new_coffee_to_the_list_4" class="figure">
<img src="Images/sbur_0408.png" alt="sbur 0408" width="600" height="267"/>
<h6><span class="label">Figure 4-8. </span><code>POST</code>-ing a new coffee to the list</h6>
</div></figure>

<p>As discussed in the previous chapter, a <code>PUT</code> command should allow for updating an existing resource or adding a new one if the requested resource doesn’t already exist. In <a data-type="xref" href="#put_an_update_to_an_existing_coffee">Figure 4-9</a>, I specify the <code>id</code> of the coffee just added and pass to the command a JSON object with a change to that coffee’s name. After the update, the coffee with the <code>id</code> of “99999” now has a <code>name</code> of “Caribou Coffee” instead of “Kaldi’s Coffee”, and the return code is 200 (OK), as expected.</p>

<figure><div id="put_an_update_to_an_existing_coffee" class="figure">
<img src="Images/sbur_0409.png" alt="sbur 0409" width="600" height="227"/>
<h6><span class="label">Figure 4-9. </span><code>PUT</code>-ting an update to an existing coffee</h6>
</div></figure>
<div class="hard-pagebreak"/>

<p><a data-type="indexterm" data-primary="HTTP verbs" data-secondary="PUT" id="idm45693963101720"/><a data-type="indexterm" data-primary="PUT" id="idm45693963100744"/><a data-type="indexterm" data-primary="JSON (JavaScript Object Notation)" data-secondary="PUT" id="idm45693963100072"/>Next I initiate a similar <code>PUT</code> request but specify an <code>id</code> in the URI that doesn’t exist. The application adds a new coffee to the database in compliance with IETF-specified behavior and correctly returns an HTTP status of 201 (Created), as shown in <a data-type="xref" href="#put_a_new_coffee_4">Figure 4-10</a>.</p>

<figure><div id="put_a_new_coffee_4" class="figure">
<img src="Images/sbur_0410.png" alt="sbur 0410" width="600" height="228"/>
<h6><span class="label">Figure 4-10. </span><code>PUT</code>-ting a new coffee</h6>
</div></figure>

<p><a data-type="indexterm" data-primary="DELETE" id="idm45693963094472"/><a data-type="indexterm" data-primary="HTTP verbs" data-secondary="DELETE" id="idm45693963093768"/>Finally, I test deletion of a specified coffee by issuing a <code>DELETE</code> request, which returns only an HTTP status code of 200 (OK), indicating the resource was successfully deleted and nothing else, since the resource no longer exists, per <a data-type="xref" href="#delete_a_coffee_4">Figure 4-11</a>. To check our end state, we once again query the full list of coffees (<a data-type="xref" href="#get_all_coffees_now_in_the_list_4">Figure 4-12</a>).</p>

<figure><div id="delete_a_coffee_4" class="figure">
<img src="Images/sbur_0411.png" alt="sbur 0411" width="600" height="138"/>
<h6><span class="label">Figure 4-11. </span><code>DELETE</code>-ing a coffee</h6>
</div></figure>

<figure><div id="get_all_coffees_now_in_the_list_4" class="figure">
<img src="Images/sbur_0412.png" alt="sbur 0412" width="600" height="699"/>
<h6><span class="label">Figure 4-12. </span><code>GET</code>-ting all coffees now in the list</h6>
</div></figure>

<p>As before, we now have one additional coffee that wasn’t initially in our repository: Mötor Oil Coffee.<a data-type="indexterm" data-primary="" data-startref="ix_database_access_save" id="idm45693963085320"/><a data-type="indexterm" data-primary="" data-startref="ix_httpie_ch4" id="idm45693963084344"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="A Bit of Polishing"><div class="sect1" id="idm45693963128296">
<h1>A Bit of Polishing</h1>

<p><a data-type="indexterm" data-primary="database access" data-secondary="polishing the code" id="ix_database_access_polish"/>As always, there are many areas that could benefit from additional attention, but I’ll confine the focus to two: extracting the initial population of sample data to a separate component and a bit of condition reordering for clarity.</p>

<p>Last chapter I populated the list of coffees with some initial values in the <code>RestApiDemoController</code> class, so I maintained that same structure—until now—in this chapter after converting to a database with repository access. A better practice is to extract that functionality to a separate component that can be enabled or disabled quickly and easily.</p>

<p>There are many ways to execute code automatically upon application startup, including using a <code>CommandLineRunner</code> or <code>ApplicationRunner</code> and specifying a lambda to accomplish the desired goal: in this case, creating and saving sample data. <a data-type="indexterm" data-primary="@Component" id="idm45693963077320"/><a data-type="indexterm" data-primary="@PostConstruct" id="idm45693963076616"/>But I prefer using an <code>@Component</code> class and an <code>@PostConstruct</code> method to accomplish the same thing for the following reasons:</p>

<ul>
<li>
<p>When <code>CommandLineRunner</code> and <code>ApplicationRunner</code> bean-producing methods autowire a repository bean, unit tests that mock the repository bean within the test (as is typically the case) break.</p>
</li>
<li>
<p>If you mock the repository bean within the test or wish to run the application without creating sample data, it’s quick and easy to disable the actual data-populating bean simply by commenting out its <code>@Component</code> annotation.</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="DataLoader" id="idm45693963070792"/>I recommend creating a <code>DataLoader</code> class similar to the one shown in the following code block. <a data-type="indexterm" data-primary="loadData()" id="idm45693963069384"/>Extracting the logic to create sample data to the <code>DataLoader</code> class’s <code>loadData()</code> method and annotating it with <code>@PostContruct</code> <a data-type="indexterm" data-primary="RestApiDemoController" id="idm45693963067240"/>restores <code>RestApiDemoController</code> to its intended single purpose of providing an external API and makes the <code>DataLoader</code> responsible for <em>its</em> intended (and obvious) purpose:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Component</code>
<code class="kd">class</code> <code class="nc">DataLoader</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">CoffeeRepository</code> <code class="n">coffeeRepository</code><code class="o">;</code>

    <code class="kd">public</code> <code class="nf">DataLoader</code><code class="o">(</code><code class="n">CoffeeRepository</code> <code class="n">coffeeRepository</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">coffeeRepository</code> <code class="o">=</code> <code class="n">coffeeRepository</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="nd">@PostConstruct</code>
    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">loadData</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">coffeeRepository</code><code class="o">.</code><code class="na">saveAll</code><code class="o">(</code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Cereza"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Ganador"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Lareño"</code><code class="o">),</code>
                <code class="k">new</code> <code class="nf">Coffee</code><code class="o">(</code><code class="s">"Café Três Pontas"</code><code class="o">)</code>
        <code class="o">));</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>The other dab of polishing is an admittedly small adjustment to the boolean condition of the ternary operator within the <code>putCoffee()</code> method. After refactoring the method to use a repository, no compelling justification remains for evaluating the negative condition first. Removing the not (!) operator from the condition slightly improves clarity; swapping the true and false values of the ternary operator are of course required to maintain the original outcomes, as reflected in the following code:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@PutMapping</code><code class="o">(</code><code class="s">"/{id}"</code><code class="o">)</code>
<code class="n">ResponseEntity</code><code class="o">&lt;</code><code class="n">Coffee</code><code class="o">&gt;</code> <code class="nf">putCoffee</code><code class="o">(</code><code class="nd">@PathVariable</code> <code class="n">String</code> <code class="n">id</code><code class="o">,</code>
                                 <code class="nd">@RequestBody</code> <code class="n">Coffee</code> <code class="n">coffee</code><code class="o">)</code> <code class="o">{</code>

    <code class="k">return</code> <code class="o">(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">existsById</code><code class="o">(</code><code class="n">id</code><code class="o">))</code>
            <code class="o">?</code> <code class="k">new</code> <code class="n">ResponseEntity</code><code class="o">&lt;&gt;(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">),</code>
                <code class="n">HttpStatus</code><code class="o">.</code><code class="na">OK</code><code class="o">)</code>
            <code class="o">:</code> <code class="k">new</code> <code class="n">ResponseEntity</code><code class="o">&lt;&gt;(</code><code class="n">coffeeRepository</code><code class="o">.</code><code class="na">save</code><code class="o">(</code><code class="n">coffee</code><code class="o">),</code>
                <code class="n">HttpStatus</code><code class="o">.</code><code class="na">CREATED</code><code class="o">);</code>
<code class="o">}</code></pre>
<div data-type="tip"><h1>Code Checkout Checkup</h1>
<p>For complete chapter code, please check out branch <em>chapter4end</em> from the code repository.<a data-type="indexterm" data-primary="" data-startref="ix_database_access_ch4" id="idm45693962818680"/><a data-type="indexterm" data-primary="" data-startref="ix_database_access_polish" id="idm45693962817736"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm45693963082808">
<h1>Summary</h1>

<p>This chapter demonstrated how to add database access to the Spring Boot application created in the last chapter. While it was meant to be a concise introduction to Spring Boot’s data capabilities, I provided an overview of the following:</p>

<ul>
<li>
<p>Java database access</p>
</li>
<li>
<p>The Java Persistence API (JPA)</p>
</li>
<li>
<p>The H2 database</p>
</li>
<li>
<p>Spring Data JPA</p>
</li>
<li>
<p>Spring Data repositories</p>
</li>
<li>
<p>Mechanisms to create sample data via repositories</p>
</li>
</ul>

<p>Subsequent chapters will dive much deeper into Spring Boot database access, but the basics covered in this chapter supply a solid foundation upon which to build and, in many cases, are sufficient by themselves.</p>

<p>In the next chapter, I’ll discuss and demonstrate useful tools Spring Boot provides to gain insights into your applications when things aren’t functioning as expected or when you need to verify that they are.</p>
</div></section>







</div></section></div></body></html>