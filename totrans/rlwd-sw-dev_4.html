<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. The Document Management System"><div class="chapter" id="chapter_04">
<h1><span class="label">Chapter 4. </span>The Document Management System</h1>







<section data-type="sect1" data-pdf-bookmark="The Challenge"><div class="sect1" id="idm45816826832344">
<h1>The Challenge</h1>

<p>After successfully implementing an advanced Bank Statements Analyzer for
Mark Erbergzuck you decide to run some errands—including going to an
appointment with your dentist.<a data-type="indexterm" data-primary="document management system (example)" id="ix_docmg"/>
Dr. Avaj has run her practice successfully for many years. Her
happy patients retain their white teeth well into old age. The
downside of such a successful practice is that every year more and more
patient documents get generated. Every time she needs to find a record of
prior treatment, her assistants spend longer and longer searching their
filing cabinets.</p>

<p>She realizes that it’s time to automate the process of managing these documents
and keeping track of them. Luckily, she has a patient who can do that for her!
You are going to help by writing
software for her that manages these documents and enables her to find the
information that will allow her practice to thrive and grow.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="The Goal"><div class="sect1" id="idm45816826828328">
<h1>The Goal</h1>

<p>In this chapter you’ll be learning about a variety of different software
development principles. Key to the design of managing
documents is an inheritance relationship, which means extending a class or
implementing an interface. In order to do this the right way you’ll
get to understand the Liskov Substitution Principle, named after famed
computer scientist Barbara Liskov.<a data-type="indexterm" data-primary="Liskov substitution principle (LSP)" id="idm45816826826424"/></p>

<p>Your understanding of when to use inheritance will get fleshed out with a discussion
of the “Composition over Inheritance” principle.<a data-type="indexterm" data-primary="inheritance" data-secondary="favoring composition over inheritance" id="idm45816826825160"/><a data-type="indexterm" data-primary="composition over inheritance principle" id="idm45816826824168"/></p>

<p class="pagebreak-before">Finally, you’ll extend your knowledge of how to write automated test code
by understanding what makes a good and maintainable test. Now that we’ve spoiled
the plot of this chapter, let’s get back to understanding what requirements
Dr. Avaj has for the Document Management System.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If at any point you want to look at the source code for this
chapter, you can look at the package <code>com.iteratrlearning.shu_book.chapter_04</code>
in the book’s code repository.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Document Management System Requirements"><div class="sect1" id="idm45816826820680">
<h1>Document Management System Requirements</h1>

<p>A friendly cup of tea with Dr. Avaj has revealed that she has the documents that
she wants to manage as files on her computer.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="requirements" id="idm45816826819080"/> The Document Management System
needs to be able to import these files and record some information about each
file that can be indexed and searched. There are three types of documents that
she cares about:</p>
<dl>
<dt>Reports</dt>
<dd>
<p>A body of text detailing some consultation of operation on a patient.</p>
</dd>
<dt>Letters</dt>
<dd>
<p>A text document that gets sent to an address. (You’re probably familiar with these already, come to think of it.)</p>
</dd>
<dt>Images</dt>
<dd>
<p>The dental practice often records x-rays or photos of teeth and gums. These have a size.</p>
</dd>
</dl>

<p>In addition, all documents need to record the path to the file that is being
managed and what patient the document is about. Dr. Avaj needs to be able to
search these documents, and query whether each of the attributes about a
different type of document contains certain pieces of information; for example,
to search for letters where the body contains “Joe Bloggs.”</p>

<p>During the conversation, you also established that Dr. Avaj might wish to add other
types of documents in the future.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Fleshing Out the Design"><div class="sect1" id="idm45816826811448">
<h1>Fleshing Out the Design</h1>

<p>When approaching this problem, there are lots of big design choices to make and
modeling approaches that we could take.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" id="ix_docmgdes"/>  These choices are subjective, and
you’re welcome to try to code up a solution to Dr. Avaj’s problem before or
after reading this chapter. In <a data-type="xref" href="#alternative_approaches">“Alternative Approaches”</a> you can see the
reasons why we avoid different choices and the overarching principles behind
them.</p>

<p>One good first step to approaching<a data-type="indexterm" data-primary="test-driven development (TDD)" id="idm45816826806888"/> any program is to start with test-driven development (TDD), which is what we did when writing the book’s sample
solution. We won’t be covering TDD until <a data-type="xref" href="ch05.xhtml#chapter_05">Chapter 5</a>, so let’s begin with
thinking about the behaviors that your software needs to perform and
incrementally fleshing out the code that implements these behaviors.</p>

<p>The Document Management System should be able to import documents on request
and add them into its internal store of documents. In order to fulfill this
requirement, let’s create the <code>DocumentManagementSystem</code> class and add two
methods:</p>
<dl>
<dt><code>void importFile(String path)</code></dt>
<dd>
<p>Takes a path to a file that our user wants to
import to the Document Management System.<a data-type="indexterm" data-primary="paths" data-secondary="for imports in document management system" id="idm45816826802216"/> As this is a public API method that
might take input from users in a production system, we take our path as a
<code>String</code> rather than relying on a more type-safe class like <code>java.nio.Path</code> or
<code>java.io.File</code>.<a data-type="indexterm" data-primary="strings" data-secondary="String type as path in document imports" id="idm45816826799544"/></p>
</dd>
<dt><code>List&lt;Document&gt; contents()</code></dt>
<dd>
<p>Returns a list of all the documents that the
Document Management System currently stores.</p>
</dd>
</dl>

<p>You’ll notice that <code>contents()</code> returns a list of some <code>Document</code> class.
We’ve not said what this class entails yet, but it’ll reappear in due course.
For now, you can pretend that it’s an empty class.</p>








<section data-type="sect2" data-pdf-bookmark="Importers"><div class="sect2" id="idm45816826795112">
<h2>Importers</h2>

<p>A key characteristic of this system is that we need to be able to import
documents of different types.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" data-tertiary="importers" id="idm45816826793336"/><a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" id="idm45816826792008"/> For the purposes of this system you can rely on
the files’ extensions in order to decide how to import them, since Dr. Avaj has
been saving files with very specific extensions. All her letters have the
<em>.letter</em> extension, reports have <em>.report</em>, and <em>.jpg</em> is the only image format
used.</p>

<p>The simplest thing to do would be to just throw all the code
for the importing mechanism into<a data-type="indexterm" data-primary="switch statement" data-secondary="using for file extensions in document imports" id="idm45816826788872"/> a single method, as shown in <a data-type="xref" href="#bad_eg_switch">Example 4-1</a>.</p>
<div id="bad_eg_switch" data-type="example">
<h5><span class="label">Example 4-1. </span>Switch of extension example</h5>

<pre data-type="programlisting" data-code-language="java"><code class="k">switch</code><code class="o">(</code><code class="n">extension</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">case</code> <code class="s">"letter"</code><code class="o">:</code>
        <code class="c1">// code for importing letters.</code>
        <code class="k">break</code><code class="o">;</code>

    <code class="k">case</code> <code class="s">"report"</code><code class="o">:</code>
        <code class="c1">// code for importing reports.</code>
        <code class="k">break</code><code class="o">;</code>


    <code class="k">case</code> <code class="s">"jpg"</code><code class="o">:</code>
        <code class="c1">// code for importing images.</code>
        <code class="k">break</code><code class="o">;</code>

    <code class="k">default</code><code class="o">:</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nf">UnknownFileTypeException</code><code class="o">(</code><code class="s">"For file: "</code> <code class="o">+</code> <code class="n">path</code><code class="o">);</code>
<code class="o">}</code></pre></div>

<p>This approach would have solved the problem in question but would be hard to
extend. Every time you want to add another type of file that gets
processed you would need to implement another entry in the <code>switch</code> statement.
Over time this method would become intractably long and hard to read.</p>

<p>If you keep your main class nice and simple and split out different
implementation classes for importing different types of documents, then it’s
easy to locate and understand each importer in isolation.
In order to support different document types, an <code>Importer</code> interface is
defined. Each <code>Importer</code> will be a class that can import a different type of file.</p>

<p>Now that we know we need an interface to import the files, how should we represent
the file that is going to be imported?<a data-type="indexterm" data-primary="files imported into document management system, representing" id="idm45816826745320"/><a data-type="indexterm" data-primary="paths" data-secondary="String type representing file path" id="idm45816826744680"/><a data-type="indexterm" data-primary="java.io.File class" id="idm45816826743720"/><a data-type="indexterm" data-primary="File class" id="idm45816826743048"/> We have a couple of different options:
use a plain <code>String</code> to represent the path of the file, or use a class that represents
a file, like <code>java.io.File</code>.</p>

<p>You could make the case that we should apply the principle<a data-type="indexterm" data-primary="strong typing" id="idm45816826740712"/><a data-type="indexterm" data-primary="data types" data-secondary="strong typing" id="idm45816826739928"/> of strong typing here:
take a type that represents the file and reduce the scope for errors versus using a <code>String</code>.
Let’s take that approach and use a <code>java.io.File</code> object as the parameter
in our <code>Importer</code> interface to represent the file being imported, as shown in <a data-type="xref" href="#importer_definition">Example 4-2</a>.</p>
<div id="importer_definition" data-type="example">
<h5><span class="label">Example 4-2. </span>Importer</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">interface</code> <code class="nc">Importer</code> <code class="o">{</code>
    <code class="n">Document</code> <code class="nf">importFile</code><code class="o">(</code><code class="n">File</code> <code class="n">file</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code><code class="o">;</code>
<code class="o">}</code></pre></div>

<p>You might be asking, <em>Why don’t you use a <code>File</code> for
the public API of <code>DocumentManagementSystem</code> as well then?</em> Well, in the case
of this application, our public API would probably be wrapped up in some kind of
user interface, and we aren’t sure what form that is taking files in. As a
result we kept things simple and just used a <code>String</code> type.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="The Document Class"><div class="sect2" id="idm45816826794488">
<h2>The Document Class</h2>

<p>Let’s also define the <code>Document</code> class at this point in time.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" data-tertiary="Document class" id="ix_docmgdesDoc"/> Each document will have
multiple attributes that we can search on. Different documents have different
types of attributes. We have several different options that we can consider the
pros and cons of when defining the <code>Document</code>.</p>

<p>The first and simplest way to represent a document would be to use a
<code>Map&lt;String, String&gt;</code>, which is a map from attribute names to values associated
with those attributes.<a data-type="indexterm" data-primary="maps" data-secondary="of attribute names and associated values" id="idm45816826719880"/> So why not just pass a <code>Map&lt;String, String&gt;</code> around
through the <span class="keep-together">application</span>? Well, introducing a domain class to model a single
document is not just drinking the OOP Koolaid, but also provides a series of
practical improvements in application maintability and readability.</p>

<p>For a start, the value of giving concrete names to components within an
application cannot be overstated. Communication is King! Good teams of software
developers use a <em>Ubiquitous Language</em> to describe their software. Matching the
vocabulary that you use within the code of your application to the vocabulary
that you use to talk to clients like Dr. Avaj makes things a lot easier to
maintain.<a data-type="indexterm" data-primary="ubiquitous language (describing software)" id="idm45816826674968"/>  When you have a conversation with a colleague or client you will
invariably need to agree upon some common language with which to describe
different aspects of the software. By mapping this to the code itself, it makes
it really easy to know what part of the code to change.<a data-type="indexterm" data-primary="discoverability" id="idm45816826673816"/> This is called
<em>discoverability</em>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The term <em>Ubiquitous Language</em> was coined by Eric Evans and originates in <em>Domain
Driven Design</em>.  It refers to the use of a common language that is clearly
degined and shared between both developers and users.</p>
</div>

<p>Another principle that should encourage you to introduce a class to model
a document is strong typing. <a data-type="indexterm" data-primary="strong typing" data-secondary="using class to model a document" id="idm45816826669480"/>Many people use this term to refer to the nature of
a programming language, but here we’re talking about the more practical use
of strong typing in implementing your software. Types allow us to restrict the
way in which data is used.<a data-type="indexterm" data-primary="data types" data-secondary="restricting data use with" id="idm45816826668104"/> For example, our <code>Document</code> class is immutable: once
it has been created you can’t change, or <em>mutate</em>, any of its attributes.<a data-type="indexterm" data-primary="immutability" data-secondary="Document class" id="idm45816826666184"/><a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" id="idm45816826665208"/> Our
<code>Importer</code> implementations create the documents; nothing else modifies them. If
you ever see a <code>Document</code> with an error in one of its attributes, you can narrow
the source of the bug down to the specific <code>Importer</code> that created the <code>Document</code>.
You can also infer from the immutability that it’s possible to index or cache any
information associated with the <code>Document</code> and you know that it will be correct
forever, since documents are immutable.</p>

<p>Another design choice that developers might consider when modeling their
<code>Document</code> would be make the <code>Document</code> extend <code>HashMap&lt;String, String&gt;</code>.
At first that seems great because the <code>HashMap</code> has all the functionality you
need to model a <code>Document</code>. However, there are several reasons why this is a
bad choice.<a data-type="indexterm" data-primary="HashMap class, Document class extending" id="idm45816826644328"/></p>

<p>Software design is often as much about restricting functionality
that is undesirable as it is about building things that you do want. We would
have instantly thrown away the aforementioned benefits from immutability
by allowing anything in the application to modify the <code>Document</code> class if
it were just a subclass of <code>HashMap</code>. Wrapping the collection also gives us
an opportunity to give more meaningful names to the methods, instead of, for example, looking
up an attribute by calling the <code>get()</code> method, which doesn’t really mean anything!
Later on we’ll go into more detail about inheritance versus composition, because this is
really a specific example of that discussion.</p>

<p>In short, domain classes allow us to name a concept and restrict the possible
behaviors and values of this concept in order to improve discoverability and
reduce the scope for bugs.<a data-type="indexterm" data-primary="domain classes" data-secondary="advantages of using Document class" id="idm45816826640664"/> As a result, we’ve chosen to model the <code>Document</code>
as shown in <a data-type="xref" href="#document_definition">Example 4-3</a>. If you’re wondering why it isn’t <code>public</code>
like most interfaces, this is discussed later in <a data-type="xref" href="#importer_scoping">“Scoping and Encapsulation Choices”</a>.</p>
<div id="document_definition" data-type="example">
<h5><span class="label">Example 4-3. </span>Document</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Document</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">attributes</code><code class="o">;</code>

    <code class="n">Document</code><code class="o">(</code><code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">attributes</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">attributes</code> <code class="o">=</code> <code class="n">attributes</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getAttribute</code><code class="o">(</code><code class="kd">final</code> <code class="n">String</code> <code class="n">attributeName</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">attributes</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">attributeName</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre></div>

<p>One final thing to note about <code>Document</code> is that it has a package-scoped
constructor.<a data-type="indexterm" data-primary="scope" data-secondary="package vs. public scope for constuctors" id="idm45816826582296"/><a data-type="indexterm" data-primary="constructors" data-secondary="package scoped constructor for Document" id="idm45816826581432"/> Often Java classes make their constructor <code>public</code>, but this can
be a bad choice as it allows code anywhere in your project to create
objects of that type.<a data-type="indexterm" data-primary="public modifier" data-secondary="using with constructors" id="idm45816826579880"/> Only code in the Document Management System should
be able to create <code>Documents</code>, so we keep the constructor package scoped
and restrict access to only the package that the Document Management System
lives in.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" data-tertiary="Document class" data-startref="ix_docmgdesDoc" id="idm45816826578248"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Attributes and Hierarchical Documents"><div class="sect2" id="idm45816826724520">
<h2>Attributes and Hierarchical Documents</h2>

<p>In our <code>Document</code> class we used <code>Strings</code> for attributes. Doesn’t this go against
the principle of strong typing?<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" data-tertiary="attributes and hierarchical Documents" id="idm45816826574296"/> The answer here is yes and no.<a data-type="indexterm" data-primary="attributes" data-secondary="and hierarchical Documents" id="idm45816826572968"/> We are storing
attributes as text so that they can be searched through a text-based search.
Not only that, but we want to ensure that all attributes are created in a very
generic form that is independent of the <code>Importer</code> that created them. <code>Strings</code>
aren’t a bad choice as such in this context. It should be noted that passing
<code>Strings</code> around throughout an application in order to represent information is
often considered a bad idea.<a data-type="indexterm" data-primary="strings" data-secondary="String type as Document attributes" id="idm45816826570248"/><a data-type="indexterm" data-primary="strong typing" data-secondary="versus Strings as attributes for Document class" id="idm45816826569256"/> In contrast with something being strongly typed,
this is termed stringly typed!</p>

<p>In particular, if more complicated use was being made of the attribute values,
then having different attribute types parsed out would be useful. For example,
if we wanted to be able to find addresses within a certain distance or
images with a height and width less than a certain size, then having strongly
typed attributes would be a boon. It would be a lot easier to make comparisons
with a width value that is an integer. In the case of this Document Management
System, however, we simply don’t need that functionality.</p>

<p>You could design the Document Management System with a class hierarchy for
<code>Documents</code> that models the <code>Importer</code> hierarchy.<a data-type="indexterm" data-primary="Document class hierarchy, defining" id="idm45816826565848"/><a data-type="indexterm" data-primary="classes" data-secondary="class hierarchy for Documents" id="idm45816826565144"/> For example, a <code>ReportImporter</code>
imports instances of the <code>Report</code> class that extends the <code>Document</code> class. This
passes our basic sanity check for subclassing. In other words, it allows you to
say a <code>Report</code> is a <code>Document</code> and it makes sense as a sentence. We chose not
to go down that direction, however, as the right way to model classes in an OOP
setting is to think in terms of behavior and data.</p>

<p>The documents are all modeled very generically in terms of named
attributes, rather than specific fields that exist within different subclasses.
Additionally, as far as this system is concerned, documents have
very little behavior associated with them. There was simply no point in adding
a class hierarchy here when it provided no benefit.<a data-type="indexterm" data-primary="KISS principle" id="idm45816826561000"/> You might think that this
statement in and of itself is a little arbitrary, but it informs us of another
principle: KISS.</p>

<p>You learned about the KISS principle in <a data-type="xref" href="ch02.xhtml#chapter_02">Chapter 2</a>. KISS means that designs are better if they are kept simple.
It’s often very hard to avoid unnecessary complexity, but it’s worth trying hard
to do so. Whenever someone says, “we might need X” or “it would be cool if we
also did Y,” just say No. Bloated and complex designs are paved with good
intentions around extensibility and code that is a nice-to-have rather than
must-have.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Implementing and Registering Importers"><div class="sect2" id="idm45816826558264">
<h2>Implementing and Registering Importers</h2>

<p>You can implement the <code>Importer</code> interface to look up different types of files.
<a data-type="xref" href="#image_importer_definition">Example 4-4</a> shows the way that images are imported.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" data-tertiary="implementing and registering Importers" id="idm45816826555064"/><a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" data-tertiary="implementing and registering" id="idm45816826553800"/> One of the
great things about Java’s core library is that it provides a lot of built-in
functionality right out of the box.<a data-type="indexterm" data-primary="images" data-secondary="importer for in document management system" id="idm45816826552280"/> Here we read an image file using the
<code>ImageIO.read</code> method and then extract the width and height of the image from
the resulting <code>BufferedImage</code> object.</p>
<div id="image_importer_definition" data-type="example">
<h5><span class="label">Example 4-4. </span>ImageImporter</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kn">import</code> <code class="nn">static</code> <code class="n">com</code><code class="o">.</code><code class="na">iteratrlearning</code><code class="o">.</code><code class="na">shu_book</code><code class="o">.</code><code class="na">chapter_04</code><code class="o">.</code><code class="na">Attributes</code><code class="o">.*;</code>

<code class="kd">class</code> <code class="nc">ImageImporter</code> <code class="kd">implements</code> <code class="n">Importer</code> <code class="o">{</code>
    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">Document</code> <code class="nf">importFile</code><code class="o">(</code><code class="kd">final</code> <code class="n">File</code> <code class="n">file</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>
        <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">attributes</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;&gt;();</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">PATH</code><code class="o">,</code> <code class="n">file</code><code class="o">.</code><code class="na">getPath</code><code class="o">());</code>

        <code class="kd">final</code> <code class="n">BufferedImage</code> <code class="n">image</code> <code class="o">=</code> <code class="n">ImageIO</code><code class="o">.</code><code class="na">read</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">WIDTH</code><code class="o">,</code> <code class="n">String</code><code class="o">.</code><code class="na">valueOf</code><code class="o">(</code><code class="n">image</code><code class="o">.</code><code class="na">getWidth</code><code class="o">()));</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">HEIGHT</code><code class="o">,</code> <code class="n">String</code><code class="o">.</code><code class="na">valueOf</code><code class="o">(</code><code class="n">image</code><code class="o">.</code><code class="na">getHeight</code><code class="o">()));</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">TYPE</code><code class="o">,</code> <code class="s">"IMAGE"</code><code class="o">);</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">Document</code><code class="o">(</code><code class="n">attributes</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre></div>

<p>Attribute names are constants defined in the <code>Attributes</code> class.<a data-type="indexterm" data-primary="constants" data-secondary="defining in Java" id="idm45816826545896"/><a data-type="indexterm" data-primary="attributes" data-secondary="for importers in document management system" id="idm45816826409848"/> This avoids bugs
where different importers end up using different strings for the same attribute
name; for example, <code>"Path"</code> versus <code>"path"</code>. Java itself doesn’t have a direct concept
of a constant as such, <a data-type="xref" href="#constant_example">Example 4-5</a> shows the commonly used idiom. This
constant is <code>public</code> because we want to be able<a data-type="indexterm" data-primary="public modifier" data-secondary="for attributes in document management system" id="idm45816826406504"/> to use it from different importers,
though you may well have a <code>private</code> or <code>package</code> scoped constant instead. The use
of the <code>final</code> keyword ensures that it can’t be reassigned <a data-type="indexterm" data-primary="final keyword" data-secondary="using with attributes in document management system" id="idm45816826403992"/><a data-type="indexterm" data-primary="static modifier" id="idm45816826402920"/>to and <code>static</code> ensures
that there is only a single instance per class.</p>
<div id="constant_example" data-type="example">
<h5><span class="label">Example 4-5. </span>How to define a constant in Java</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">PATH</code> <code class="o">=</code> <code class="s">"path"</code><code class="o">;</code></pre></div>

<p>There are importers for all three different types of files and you will see the
other two implemented in <a data-type="xref" href="#extending_and_iterating">“Extending and Reusing Code”</a>. Don’t worry, we’re not
hiding anything up our sleeves.<a data-type="indexterm" data-primary="registering importers" id="idm45816826397224"/> In order to be able to use the <code>Importer</code> classes
when we import files, we also need to register the importers to look them up.
We use the extension of the file that we want to import as the key of the <code>Map</code>, as shown in <a data-type="xref" href="#importer_lookup">Example 4-6</a>.</p>
<div id="importer_lookup" data-type="example">
<h5><span class="label">Example 4-6. </span>Registering the importers</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Importer</code><code class="o">&gt;</code> <code class="n">extensionToImporter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;&gt;();</code>

    <code class="kd">public</code> <code class="nf">DocumentManagementSystem</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">extensionToImporter</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"letter"</code><code class="o">,</code> <code class="k">new</code> <code class="n">LetterImporter</code><code class="o">());</code>
        <code class="n">extensionToImporter</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"report"</code><code class="o">,</code> <code class="k">new</code> <code class="n">ReportImporter</code><code class="o">());</code>
        <code class="n">extensionToImporter</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"jpg"</code><code class="o">,</code> <code class="k">new</code> <code class="n">ImageImporter</code><code class="o">());</code>
    <code class="o">}</code></pre></div>

<p>Now that you know how to import documents, we can implement search.<a data-type="indexterm" data-primary="search" data-secondary="implementing in document management system" id="idm45816826337576"/> We won’t be
focusing on the most efficient way to implement searching of documents here
since we’re not trying to implement Google, just get the information to Dr. Avaj
that she requires. A conversation with Dr. Avaj revealed that she wanted to be
able to look up information about different attributes of a <code>Document</code>.<a data-type="indexterm" data-primary="attributes" data-secondary="searching on attributes of a Document" id="idm45816826263720"/></p>

<p>Her requirements could be met by just being able to find subsequences within
attribute values. For example, she might want to search for documents that have
a patient called Joe, and with <em>Diet Coke</em> in the body. We thus devised a very
simple query language that consisted of a series of attribute name and
substring pairs <span class="keep-together">separated</span> by commas. Our aforementioned query would be written
as <code>"patient:Joe,body:Diet Coke"</code>.</p>

<p>Since the search implementation keeps things simple rather than trying to be
highly optimized, it just does a linear scan over all the documents recorded in
the system and tests each one against the query.<a data-type="indexterm" data-primary="strings" data-secondary="query String passed to search method" id="idm45816826259752"/> The query <code>String</code> that is
passed to the <code>search</code> method is parsed into a <code>Query</code> object that can then
be tested against each <code>Document</code>.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="design and modeling approaches" data-startref="ix_docmgdes" id="idm45816826256984"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="The Liskov Substitution Principle (LSP)"><div class="sect1" id="idm45816826810984">
<h1>The Liskov Substitution Principle (LSP)</h1>

<p>We’ve talked about a few specific design decisions related to classes—for
example, modeling <a data-type="indexterm" data-primary="document management system (example)" data-secondary="Liskov substitution principle in design of" id="ix_docmgLSP"/><a data-type="indexterm" data-primary="Liskov substitution principle (LSP)" data-secondary="in document management system design" id="ix_LSPdoc"/>different <code>Importer</code> implementations with classes, and why we
didn’t introduce a class hierarchy for the <code>Document</code> class and why we didn’t
just make <code>Document</code> extend <code>HashMap</code>. But really there’s a broader principle
at stake here, one that allows us to generalize these examples into an approach
that you can use in any piece of software.  This is called the <em>Liskov
Substitution Principle</em> (LSP) and it helps us understand how to subclass and
implement interfaces correctly. LSP forms the L of the SOLID principles that
we’ve been referring to throughout this book.<a data-type="indexterm" data-primary="LSP" data-see="Liskov substitution principle" id="idm45816826248888"/><a data-type="indexterm" data-primary="SOLID principles" data-secondary="Liskov substitution principle (LSP)" id="idm45816826247880"/></p>

<p>The Liskov Substitution Principle is often stated in these very formal terms,
but is actually a very simple concept. Let’s demystify some of this
terminology.<a data-type="indexterm" data-primary="data types" data-secondary="types and subtypes in Liskov substitution principle" id="idm45816826246488"/>  If you hear <em>type</em> in this context, just think of a class or an
interface.<a data-type="indexterm" data-primary="subtypes" id="idm45816826244936"/> The term <em>subtype</em> means establish a parent-to-child relationship
between types; in other words, extend a class or implement an interface. So
informally you can think of this as meaning that child classes should maintain
the behavior they inherit from their parents. We know, we know—it sounds like
an obvious statement, but we can be more specific and split out LSP into four
distinct parts:</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45816826243160">
<h5>LSP</h5>
<p>Let <em>q</em>(<em>x</em>) be a property provable about objects <em>x</em> of type <em>T</em>. Then <em>q</em>(<em>y</em>) should be
true for objects <em>y</em> of type <em>S</em> where <em>S</em> is a subtype of <em>T</em>.</p>
</div></aside>
<dl>
<dt>Preconditions cannot be strengthened in a subtype</dt>
<dd>
<p>A precondition establishes
the conditions under which some code will work.<a data-type="indexterm" data-primary="preconditions, not strengthening in subtypes" id="idm45816826235400"/><a data-type="indexterm" data-primary="subtypes" data-secondary="no strengthening of preconditions in" id="idm45816826234600"/> You can’t just assume what you’ve written will work anyway, anyhow, anywhere.
For example, all our <code>Importer</code> implementations have the precondition that the
file being imported exists and is readable. As a result, the <code>importFile</code> method
has validation code before any <code>Importer</code> is invoked, as can be seen in
<a data-type="xref" href="#importFile_validation">Example 4-7</a>.</p>
<div id="importFile_validation" data-type="example">
<h5><span class="label">Example 4-7. </span>importFile definition</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">importFile</code><code class="o">(</code><code class="kd">final</code> <code class="n">String</code> <code class="n">path</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>
        <code class="kd">final</code> <code class="n">File</code> <code class="n">file</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="o">(</code><code class="n">path</code><code class="o">);</code>
        <code class="k">if</code> <code class="o">(!</code><code class="n">file</code><code class="o">.</code><code class="na">exists</code><code class="o">())</code> <code class="o">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">FileNotFoundException</code><code class="o">(</code><code class="n">path</code><code class="o">);</code>
        <code class="o">}</code>

        <code class="kd">final</code> <code class="kt">int</code> <code class="n">separatorIndex</code> <code class="o">=</code> <code class="n">path</code><code class="o">.</code><code class="na">lastIndexOf</code><code class="o">(</code><code class="sc">'.'</code><code class="o">);</code>
        <code class="k">if</code> <code class="o">(</code><code class="n">separatorIndex</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>
            <code class="k">if</code> <code class="o">(</code><code class="n">separatorIndex</code> <code class="o">==</code> <code class="n">path</code><code class="o">.</code><code class="na">length</code><code class="o">())</code> <code class="o">{</code>
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">UnknownFileTypeException</code><code class="o">(</code><code class="s">"No extension found For file: "</code> <code class="o">+</code> <code class="n">path</code><code class="o">);</code>
            <code class="o">}</code>
            <code class="kd">final</code> <code class="n">String</code> <code class="n">extension</code> <code class="o">=</code> <code class="n">path</code><code class="o">.</code><code class="na">substring</code><code class="o">(</code><code class="n">separatorIndex</code> <code class="o">+</code> <code class="mi">1</code><code class="o">);</code>
            <code class="kd">final</code> <code class="n">Importer</code> <code class="n">importer</code> <code class="o">=</code> <code class="n">extensionToImporter</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">extension</code><code class="o">);</code>
            <code class="k">if</code> <code class="o">(</code><code class="n">importer</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">UnknownFileTypeException</code><code class="o">(</code><code class="s">"For file: "</code> <code class="o">+</code> <code class="n">path</code><code class="o">);</code>
            <code class="o">}</code>

            <code class="kd">final</code> <code class="n">Document</code> <code class="n">document</code> <code class="o">=</code> <code class="n">importer</code><code class="o">.</code><code class="na">importFile</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>
            <code class="n">documents</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">document</code><code class="o">);</code>
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">UnknownFileTypeException</code><code class="o">(</code><code class="s">"No extension found For file: "</code> <code class="o">+</code> <code class="n">path</code><code class="o">);</code>
        <code class="o">}</code>
    <code class="o">}</code></pre></div>

<p>LSP means that you can’t require any more restrictive preconditions than your
parent required. So, for example, you can’t require your document to be smaller
than 100KB in size if your parent should be able to import any size of document.</p>
</dd>
<dt>Postconditions cannot be weakened in a subtype</dt>
<dd>
<p>This might sound a bit confusing
because it reads a lot like the first rule.<a data-type="indexterm" data-primary="postconditions, no weakening in subtypes" id="idm45816826189400"/><a data-type="indexterm" data-primary="subtypes" data-secondary="no weakening of postconditions in" id="idm45816826188776"/> Postconditions are things that have
to be true after some code has run. For example, after <code>importFile()</code> has run,
if the file in question is valid it must be in the list of documents returned by
<code>contents()</code>. So if the parent has some kind of side effect or returns some
value, then the child must do so as well.</p>
</dd>
<dt>Invariants of the supertype must be preserved in a subtype</dt>
<dd>
<p>An invariant is
something<a data-type="indexterm" data-primary="invariants of supertype, preserving in subtype" id="idm45816826057672"/><a data-type="indexterm" data-primary="subtypes" data-secondary="preserving supertype invariants in" id="idm45816826056936"/> that never changes, like the ebb and flow of the tides.<a data-type="indexterm" data-primary="inheritance" data-secondary="supertype invariants and" id="idm45816826055800"/> In the context
of inheritance, we want to make sure that any invariants that are expected to be
maintained by the parent class should also be maintained by the children.</p>
</dd>
<dt>The History Rule</dt>
<dd>
<p>This is the hardest aspect of LSP to understand.<a data-type="indexterm" data-primary="history rule (in LSP)" id="idm45816826053016"/> In essence,
the child class shouldn’t allow state changes that your parent disallowed. So, in
our example program we have an immutable <code>Document</code> class.<a data-type="indexterm" data-primary="immutability" data-secondary="Document class" id="idm45816826051640"/> In other words, once it
has been instantiated you can’t remove, add, or alter any of the attributes. You shouldn’t
subclass this <code>Document</code> class and create a mutable <code>Document</code> class. This is
because any user of the parent class would expect certain behavior in response
to calling methods on the <code>Document</code> class. If the child were mutable, it
could violate callers’ expectations about what calling those methods does.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="Liskov substitution principle in design of" data-startref="ix_docmgLSP" id="idm45816826048872"/><a data-type="indexterm" data-primary="Liskov substitution principle (LSP)" data-secondary="in document management system design" data-startref="ix_LSPdoc" id="idm45816826047512"/></p>
</dd>
</dl>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Alternative Approaches"><div class="sect1" id="alternative_approaches">
<h1>Alternative Approaches</h1>

<p>You could have taken a completely different approach when it comes to designing
the Document Management System.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="alternative approaches to" id="ix_docmgalt"/> We’ll take a look at some of these alternatives
now as we think they are instructive. None of the choices could be considered
wrong as such, but we do think the chosen approach is best.</p>








<section data-type="sect2" data-pdf-bookmark="Making Importer a Class"><div class="sect2" id="idm45816826042616">
<h2>Making Importer a Class</h2>

<p>You could have chosen to make a class hierarchy for importers, and have a class
at the top for the <code>Importer</code> rather than an interface.<a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" data-tertiary="making Importer a class" id="idm45816826040792"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="alternative approaches to" data-tertiary="making Importer a class" id="idm45816826039528"/><a data-type="indexterm" data-primary="interfaces" data-secondary="capabilities" id="idm45816826038280"/><a data-type="indexterm" data-primary="classes" data-secondary="capabilities" id="idm45816826037336"/> Interfaces and classes
provide a different set of capabilities. You can implement multiple interfaces,
while classes can contain instance fields and it’s more usual to have method
bodies in classes.</p>

<p>In this case the reason to have a hierarchy is to enable different importers
to be used. You’ve already heard about our motivation for avoiding brittle
class-based inheritance relationships, so it should be pretty clear that using
interfaces is a better choice here.<a data-type="indexterm" data-primary="inheritance" data-secondary="class-based" id="idm45816826035368"/></p>

<p>That’s not to say that classes wouldn’t be a better choice elsewhere. If you
want to model a strong <em>is a</em> relationship<a data-type="indexterm" data-primary="is a relationship" id="idm45816826033464"/> in your problem domain that involves
state or a lot of behavior, then class-based inheritance is more appropriate.
It’s just not the choice we think is most appropriate here.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Scoping and Encapsulation Choices"><div class="sect2" id="importer_scoping">
<h2>Scoping and Encapsulation Choices</h2>

<p>If you have taken the time to peruse the code you might notice that the
<code>Importer</code> interface, its <a data-type="indexterm" data-primary="encapsulation" data-secondary="choices in document management system" id="idm45816826029800"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="alternative approaches to" data-tertiary="scoping and encapsulation choices" id="idm45816826028776"/><a data-type="indexterm" data-primary="scope" data-secondary="scoping choices in document management system" id="idm45816826027512"/><a data-type="indexterm" data-primary="package scope" id="idm45816826026536"/>implementations, and our <code>Query</code> class are all
package scoped. Package scope is the default scope, so if you see a class file
with <code>class Query</code> at the top you know it’s package scoped, and if it says <code>public
class Query</code> it’s public scoped. Package scoping means that other classes
within the same package can <em>see</em> or <em>have access</em> to the class, but no one
else can. It’s a cloaking device.</p>

<p>A strange thing about the Java ecosystem is that even though package scope is
the default scope, whenever we’ve been involved in software development projects
there are always more <code>public</code>-scoped classes than package-scoped ones.<a data-type="indexterm" data-primary="public modifier" data-secondary="public scope versus package scope" id="idm45816826022536"/> Perhaps
the default should have been <code>public</code> all along, but either way package scope
is a really useful tool. It helps you encapsulate these kinds of design
decisions. A lot of this section has commented on the different choices that
are available to you around designing the system, and you may want to refactor
to one of these alternative designs when maintaining the system.  This would
be harder if we leaked details about this implementation outside of the package in
question. Through diligent use of package scoping you can stop classes outside
of the package making so many assumptions about that internal design.</p>

<p>We think it’s also worth reiterating that this is simply a justification and
explanation of these design choices. There’s nothing inherently wrong with making
other choices listed in this section—they may work out to be more appropriate
depending on how the application evolves over time.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="alternative approaches to" data-startref="ix_docmgalt" id="idm45816826019720"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Extending and Reusing Code"><div class="sect1" id="extending_and_iterating">
<h1>Extending and Reusing Code</h1>

<p>When it comes to software, the only constant is change.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="extending and reusing code" id="ix_docmgext"/><a data-type="indexterm" data-primary="code" data-secondary="extending and reusing in document management system" id="ix_codeext"/> Over time you may want to
add features to your product, customer requirements may change, and regulations
could force you alter your software. As we alluded to earlier, there may be more
documents that Dr. Avaj would like to add to our Document Management System. In
fact, when we first came to showcase the software that we’ve written for her she
immediately realized that invoicing clients was something that she also wanted
to keep track of in this system. An invoice is a document with a body and an
amount and has an <em>.invoice</em> extension. <a data-type="xref" href="#eg_invoice">Example 4-8</a> shows an example invoice.</p>
<div id="eg_invoice" data-type="example">
<h5><span class="label">Example 4-8. </span>Invoice example</h5>

<pre data-type="programlisting">Dear Joe Bloggs

Here is your invoice for the dental treatment that you received.

Amount: $100

regards,

  Dr Avaj
  Awesome Dentist</pre></div>

<p>Fortunately for us, all of Dr. Avaj’s
invoices are in the same format. As you can see, we need to extract an
amount of money from this, and the amount line starts with the <code>Amount:</code> prefix.
The person’s name is at the beginning of the letter on a line with <span class="keep-together">the prefix</span>
<code>Dear</code>. In fact, our system implements a general method of finding the suffix
of a line with a given prefix, shown in <a data-type="xref" href="#addLineSuffix">Example 4-9</a>. In this example,
the field <code>lines</code> has already been initialized with the lines of the file that
we’re importing. We pass this method a <code>prefix</code>—for example, “Amount:”—and it
associates the rest of the line, the suffix, with a provided attribute name.</p>
<div id="addLineSuffix" data-type="example">
<h5><span class="label">Example 4-9. </span>addLineSuffix definition</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="kt">void</code> <code class="nf">addLineSuffix</code><code class="o">(</code><code class="kd">final</code> <code class="n">String</code> <code class="n">prefix</code><code class="o">,</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">attributeName</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">for</code><code class="o">(</code><code class="kd">final</code> <code class="n">String</code> <code class="nl">line:</code> <code class="n">lines</code><code class="o">)</code> <code class="o">{</code>
            <code class="k">if</code> <code class="o">(</code><code class="n">line</code><code class="o">.</code><code class="na">startsWith</code><code class="o">(</code><code class="n">prefix</code><code class="o">))</code> <code class="o">{</code>
                <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">attributeName</code><code class="o">,</code> <code class="n">line</code><code class="o">.</code><code class="na">substring</code><code class="o">(</code><code class="n">prefix</code><code class="o">.</code><code class="na">length</code><code class="o">()));</code>
                <code class="k">break</code><code class="o">;</code>
            <code class="o">}</code>
        <code class="o">}</code>
    <code class="o">}</code></pre></div>

<p>We in fact have a similar concept when we try to import a letter. Consider the
example letter presented in <a data-type="xref" href="#eg_letter">Example 4-10</a>. Here you can extract the name of the
patient by looking for a line starting with <code>Dear</code>. Letters also have addresses
and bodies of text that you want to extract from the contents of the text file.</p>
<div id="eg_letter" data-type="example">
<h5><span class="label">Example 4-10. </span>Letter example</h5>

<pre data-type="programlisting">Dear Joe Bloggs

123 Fake Street
Westminster
London
United Kingdom

We are writing to you to confirm the re-scheduling of your appointment
with Dr. Avaj from 29th December 2016 to 5th January 2017.

regards,

  Dr Avaj
  Awesome Dentist</pre></div>

<p>We also have a similar problem when it comes to importing patient reports.
Dr. Avaj’s reports prefix the name of the patient with <code>Patient:</code> and have a body
of text to include, just like letters. You can see an example of a report in
<a data-type="xref" href="#eg_report">Example 4-11</a>.</p>
<div id="eg_report" data-type="example">
<h5><span class="label">Example 4-11. </span>Report example</h5>

<pre data-type="programlisting">Patient: Joe Bloggs

On 5th January 2017 I examined Joe's teeth.
We discussed his switch from drinking Coke to Diet Coke.
No new problems were noted with his teeth.</pre></div>

<p>So one option here would be to have all three text-based importers implement
the same method to find the suffixes of text lines with a given prefix that was
listed in <a data-type="xref" href="#addLineSuffix">Example 4-9</a>. Now if we were charging Dr. Avaj based on the
number of lines of code that we had written, this would be a great strategy. We
could triple the amount of money that we would make for basically the same
work!</p>

<p>Sadly (or maybe not so sadly, given the aforementioned incentives), customers
rarely pay based on the number of lines of code produced. What matters are
the requirements that the customer wants. So we really want to be able to
reuse this code across the three importers.<a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" data-tertiary="reusing code across" id="idm45816825967752"/> In order to reuse the code we need
to actually have it live in some class. You have essentially three options to
consider, each with pros and cons:</p>

<ul>
<li>
<p>Use a <em>utility</em> class</p>
</li>
<li>
<p>Use <em>inheritance</em></p>
</li>
<li>
<p>Use a domain class</p>
</li>
</ul>

<p>The simplest option to start with is to create a utility class.<a data-type="indexterm" data-primary="utility classes" id="idm45816825961992"/> You could
call this <code>ImportUtil</code>. Then every time you wanted to have a method that needs
to be shared between different importers it could go in this utility class. Your
utility class would end up being a bag of static methods.</p>

<p>While a utility class is nice and simple, it’s not exactly the pinnacle of
object-oriented programming.<a data-type="indexterm" data-primary="object-oriented programming" data-secondary="modeling real-world objects as classes" id="idm45816825959992"/><a data-type="indexterm" data-primary="classes" data-secondary="modeling real-world objects as" id="idm45816825959080"/> The object-oriented style involves having concepts
in your application be modeled by classes. If you want to create a thing, then
you invoke <code>new Thing()</code> for whatever your thing is. Attributes and behavior
associated with the thing should be methods on the <code>Thing</code> class.</p>

<p>If you follow this principle of modeling real-world objects as classes, it does genuinely make it easier to understand your
application because it gives you a structure and maps a mental model of your
domain onto your code. You want to alter the way that letters are imported?
Well then edit the <code>LetterImporter</code> class.</p>

<p>Utility classes violate this expectation and often end up
turning into bundles of procedural code with no single responsibility or concept.
Over time, this can often lead to the appearance of a God Class in our codebase; in other words, a single large class that ends up hogging a lot of responsibility.</p>

<p>So what should you do if you want to associate this behavior to a concept?
Well, the next most obvious approach might be to use inheritance.<a data-type="indexterm" data-primary="inheritance" data-secondary="for code reuse in document management system" id="idm45816825954376"/> In this approach
you would have the different importers extend a <code>TextImporter</code> class. You could
then place all the common functionality on that class and reuse it in subclasses.</p>

<p>Inheritance is a perfectly solid choice of design in many circumstances. You’ve
already seen the Liskov Substitution Principle and how it puts constraints
on the correctness of our inheritance relationship. In practice, inheritance is
often a poor choice when the inheritance fails to model some real-world relationship.</p>

<p>In this case, a <code>TextImporter</code> is an <code>Importer</code> and we can
ensure that our classes follow the LSP rules, but it doesn’t really seem like a
strong concept to work with. The issue with inheritance relationships that don’t
correspond to real-world relationships is that they tend to be brittle. As your
application evolves over time you want abstractions that evolve with the
application rather than against it. As a rule of thumb, it’s a bad idea to introduce
an inheritance relationship purely to enable code reuse.</p>

<p>Our final choice is to model the text file using a domain class.<a data-type="indexterm" data-primary="domain classes" data-secondary="using for code reuse in document management system" id="idm45816825949704"/> To use this
approach we would model some
underlying concept and build out our different importers by invoking methods on
top of the underlying concept. So what’s the concept in question here? Well,
what we’re really trying to do is manipulate the contents of a text file, so
let’s call the class a <code>TextFile</code>.<a data-type="indexterm" data-primary="TextFile class" id="idm45816825947864"/> It’s not original or creative, but that’s
the point. You know where the functionality for manipulating text files lies,
because the class is named in a really dead simple manner.</p>

<p><a data-type="xref" href="#textfile_definition">Example 4-12</a> shows the definition of the class and its fields.
Note that this isn’t a subclass of a <code>Document</code> because a document shouldn’t
be coupled to just text files—we may import binary files like images as well.
This is just a class that models the underlying concept of a text file and has
associated methods for extracting data from text files.</p>
<div id="textfile_definition" data-type="example">
<h5><span class="label">Example 4-12. </span>TextFile definition</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">class</code> <code class="nc">TextFile</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">attributes</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">lines</code><code class="o">;</code>

    <code class="c1">// class continues ...</code></pre></div>

<p>This is the approach that we pick in the case of importers. We think this allows
us to model our problem domain in a flexible way. It doesn’t tie us into a
brittle inheritance hierarchy, but still allows us to reuse the code.
<a data-type="xref" href="#invoice_importer_impl">Example 4-13</a> shows how to import invoices. The suffixes for
the name and amount are added, along with setting the type of the invoice to be
an amount.</p>
<div id="invoice_importer_impl" data-type="example">
<h5><span class="label">Example 4-13. </span>Importing invoices</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">Document</code> <code class="nf">importFile</code><code class="o">(</code><code class="kd">final</code> <code class="n">File</code> <code class="n">file</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>
        <code class="kd">final</code> <code class="n">TextFile</code> <code class="n">textFile</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TextFile</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>

        <code class="n">textFile</code><code class="o">.</code><code class="na">addLineSuffix</code><code class="o">(</code><code class="n">NAME_PREFIX</code><code class="o">,</code> <code class="n">PATIENT</code><code class="o">);</code>
        <code class="n">textFile</code><code class="o">.</code><code class="na">addLineSuffix</code><code class="o">(</code><code class="n">AMOUNT_PREFIX</code><code class="o">,</code> <code class="n">AMOUNT</code><code class="o">);</code>

        <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">attributes</code> <code class="o">=</code> <code class="n">textFile</code><code class="o">.</code><code class="na">getAttributes</code><code class="o">();</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">TYPE</code><code class="o">,</code> <code class="s">"INVOICE"</code><code class="o">);</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">Document</code><code class="o">(</code><code class="n">attributes</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>You can also see another example of an importer that uses the <code>TextFile</code> class
in <a data-type="xref" href="#letter_importer_impl">Example 4-14</a>. No need to worry about how <code>TextFile.addLines</code> is implemented;
you can see an explanation of that in <a data-type="xref" href="#addLines_definition">Example 4-15</a>.</p>
<div id="letter_importer_impl" data-type="example">
<h5><span class="label">Example 4-14. </span>Importing letters</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">Document</code> <code class="nf">importFile</code><code class="o">(</code><code class="kd">final</code> <code class="n">File</code> <code class="n">file</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>
        <code class="kd">final</code> <code class="n">TextFile</code> <code class="n">textFile</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TextFile</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>

        <code class="n">textFile</code><code class="o">.</code><code class="na">addLineSuffix</code><code class="o">(</code><code class="n">NAME_PREFIX</code><code class="o">,</code> <code class="n">PATIENT</code><code class="o">);</code>

        <code class="kd">final</code> <code class="kt">int</code> <code class="n">lineNumber</code> <code class="o">=</code> <code class="n">textFile</code><code class="o">.</code><code class="na">addLines</code><code class="o">(</code><code class="mi">2</code><code class="o">,</code> <code class="nl">String:</code><code class="o">:</code><code class="n">isEmpty</code><code class="o">,</code> <code class="n">ADDRESS</code><code class="o">);</code>
        <code class="n">textFile</code><code class="o">.</code><code class="na">addLines</code><code class="o">(</code><code class="n">lineNumber</code> <code class="o">+</code> <code class="mi">1</code><code class="o">,</code> <code class="o">(</code><code class="n">line</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">line</code><code class="o">.</code><code class="na">startsWith</code><code class="o">(</code><code class="s">"regards,"</code><code class="o">),</code> <code class="n">BODY</code><code class="o">);</code>

        <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">attributes</code> <code class="o">=</code> <code class="n">textFile</code><code class="o">.</code><code class="na">getAttributes</code><code class="o">();</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">TYPE</code><code class="o">,</code> <code class="s">"LETTER"</code><code class="o">);</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">Document</code><code class="o">(</code><code class="n">attributes</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>These classes weren’t first written like this, though. They evolved into their
current state. When we started coding up the Document Management System, the
first text-based importer, the <code>LetterImporter</code>, had all of its text
extraction logic written inline in the class. This is a good way to start.
Trying to seek out code to reuse often results in inappropriate abstractions.
Walk before you run.</p>

<p>As we started writing the <code>ReportImporter</code> it become increasingly apparent that
a lot of the text extraction logic could be shared between the two importers, and
that really they should be written in terms of method invocations upon some
common domain concept that we have introduced here—the <code>TextFile</code>. In fact, we
even copy and pasted the code that was to be shared between the two classes to
begin with.</p>

<p>That isn’t to say that copy and pasting code is good—far from it. But it’s
often better to duplicate a little bit of code when you start writing some
classes.  Once you’ve implemented more of the application, the right
abstraction—e.g., a <code>TextFile</code> class will become apparent. Only when you know a
little bit more about the right way to remove duplication should you go down
the route of removing the duplication.</p>

<p>In <a data-type="xref" href="#addLines_definition">Example 4-15</a> you can see how the <code>TextFile.addLines</code> method
was implemented.<a data-type="indexterm" data-primary="TextFile class" data-secondary="addLines method" id="idm45816825568968"/> This is common code used by different <code>Importer</code> implementations.
Its first argument is a <code>start</code> index, which tells you which line number to start on.<a data-type="indexterm" data-primary="start index" id="idm45816825567064"/><a data-type="indexterm" data-primary="isEnd predicate" id="idm45816825566360"/>
Then there’s an <code>isEnd</code> predicate that is applied to the line and returns <code>true</code> if we’ve
reached the end of the line. Finally, we have the name of the attribute that we’re going to associate
with this value.</p>
<div id="addLines_definition" data-type="example">
<h5><span class="label">Example 4-15. </span>addLines definition</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="kt">int</code> <code class="nf">addLines</code><code class="o">(</code>
        <code class="kd">final</code> <code class="kt">int</code> <code class="n">start</code><code class="o">,</code>
        <code class="kd">final</code> <code class="n">Predicate</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">isEnd</code><code class="o">,</code>
        <code class="kd">final</code> <code class="n">String</code> <code class="n">attributeName</code><code class="o">)</code> <code class="o">{</code>

        <code class="kd">final</code> <code class="n">StringBuilder</code> <code class="n">accumulator</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="o">();</code>
        <code class="kt">int</code> <code class="n">lineNumber</code><code class="o">;</code>
        <code class="k">for</code> <code class="o">(</code><code class="n">lineNumber</code> <code class="o">=</code> <code class="n">start</code><code class="o">;</code> <code class="n">lineNumber</code> <code class="o">&lt;</code> <code class="n">lines</code><code class="o">.</code><code class="na">size</code><code class="o">();</code> <code class="n">lineNumber</code><code class="o">++)</code> <code class="o">{</code>
            <code class="kd">final</code> <code class="n">String</code> <code class="n">line</code> <code class="o">=</code> <code class="n">lines</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">lineNumber</code><code class="o">);</code>
            <code class="k">if</code> <code class="o">(</code><code class="n">isEnd</code><code class="o">.</code><code class="na">test</code><code class="o">(</code><code class="n">line</code><code class="o">))</code> <code class="o">{</code>
                <code class="k">break</code><code class="o">;</code>
            <code class="o">}</code>

            <code class="n">accumulator</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">line</code><code class="o">);</code>
            <code class="n">accumulator</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"\n"</code><code class="o">);</code>
        <code class="o">}</code>
        <code class="n">attributes</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">attributeName</code><code class="o">,</code> <code class="n">accumulator</code><code class="o">.</code><code class="na">toString</code><code class="o">().</code><code class="na">trim</code><code class="o">());</code>
        <code class="k">return</code> <code class="n">lineNumber</code><code class="o">;</code>
    <code class="o">}</code></pre></div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Test Hygiene"><div class="sect1" id="idm45816826017352">
<h1>Test Hygiene</h1>

<p>As you learned in <a data-type="xref" href="ch02.xhtml#chapter_02">Chapter 2</a>, writing<a data-type="indexterm" data-primary="code" data-secondary="extending and reusing in document management system" data-startref="ix_codeext" id="idm45816825416648"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="extending and reusing code" data-startref="ix_docmgext" id="idm45816825415432"/> automated tests has a lot of benefits
in terms of software maintainability. <a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" id="ix_tstDMS"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" id="ix_docmgtst"/>It enables us to reduce the scope for
regressions and understand which commit caused them. It also enables us to
refactor our code with confidence. Tests aren’t a magic panacea, though. They
require that we write and maintain a lot of code in order to get these benefits.
As you know, writing and maintaining code is a difficult proposition, and many
developers find that when they first start writing automated tests that they
can take a lot of developer time.</p>

<p>In order to solve the problem of test maintainability you need to get to grips
with <em>test hygiene</em>. Test hygiene means to keep your test code clean and ensure
that it is maintained and improved along with your codebase under test. If you
don’t maintain and treat your tests, over time they will become a
burden on your developer productivity. In this section you’ll learn about a
few key points that can help to keep tests hygienic.</p>








<section data-type="sect2" data-pdf-bookmark="Test Naming"><div class="sect2" id="idm45816825409832">
<h2>Test Naming</h2>

<p>The first thing to think about when it comes to tests is their naming.<a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="naming tests" id="ix_tstDMSnm"/><a data-type="indexterm" data-primary="names" data-secondary="naming tests" id="idm45816825406744"/> Developers can get highly opinionated about naming—it’s an easy topic to talk
about a lot because everyone can relate to it and think about the problem. We
think the thing to <span class="keep-together">remember</span> is that there’s rarely a clear, really good name for
something, but there are many, many, bad names.</p>

<p>The first test we wrote for the Document Management System was testing that
we import a file and create a <code>Document</code>. This was written before we had
introduced the concept of an <code>Importer</code> and weren’t testing <code>Document</code>-specific
attributes.<a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" data-tertiary="test for importing files" id="idm45816825402664"/> The code is in <a data-type="xref" href="#shouldImportFile">Example 4-16</a>.</p>
<div id="shouldImportFile" data-type="example">
<h5><span class="label">Example 4-16. </span>Test for importing files</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@Test</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shouldImportFile</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code>
    <code class="o">{</code>
        <code class="n">system</code><code class="o">.</code><code class="na">importFile</code><code class="o">(</code><code class="n">LETTER</code><code class="o">);</code>

        <code class="kd">final</code> <code class="n">Document</code> <code class="n">document</code> <code class="o">=</code> <code class="n">onlyDocument</code><code class="o">();</code>

        <code class="n">assertAttributeEquals</code><code class="o">(</code><code class="n">document</code><code class="o">,</code> <code class="n">Attributes</code><code class="o">.</code><code class="na">PATH</code><code class="o">,</code> <code class="n">LETTER</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>This test was named <code>shouldImportFile</code>. The key driving principles when it
comes to test naming are readability, maintainability, and acting as <em>executable
documentation</em>. When you see a report of a test class being run, the names
should act as statements that document what functionality works and what does
not. This allows a developer to easily map from application behavior to a test
that asserts that this behavior is implemented. By reducing the impedence
mismatch between behavior and code, we make it easier for other developers to
understand what is happening in the future. This is a test that confirms that the
document management
system imports a file.</p>

<p>There are lots of naming anti-patterns, however.<a data-type="indexterm" data-primary="anti-patterns" data-secondary="in test naming" id="idm45816825274584"/> The worst anti-pattern is to
name a test something completely nondescript—for example, <code>test1</code>. What on earth
is <code>test1</code> testing? The reader’s patience? Treat people who are reading your code
like you would like them to treat you.</p>

<p>Another common test naming anti-pattern is just named after a concept or a noun—for example, <code>file</code> or <code>document</code>. Test names should describe
the behavior under test, not a concept.<a data-type="indexterm" data-primary="behavior" data-secondary="test names describing behavior under test, not concepts" id="idm45816825271112"/> Another test naming anti-pattern is to
simply name the test after a method that is invoked during testing, rather than
the behavior. In this case the test might be named <code>importFile</code>.</p>

<p>You might ask, by naming our test <code>shouldImportFile</code> haven’t we committed this
sin here? There’s some merit to the accusation, but here we’re just describing
the behavior under test. In fact, the <code>importFile</code> method is tested by various
tests; for example, <code>shouldImportLetterAttributes</code>,
<code>shouldImportReportAttributes</code>, and <code>shouldImportImageAttributes</code>. None of those
tests are called <code>importFile</code>—they are all describing more specific
behaviors.</p>

<p>OK, now you know what bad naming looks like, so what is good test naming?
You should follow three rules of thumb and use them to drive test naming:</p>
<dl>
<dt>Use domain terminology</dt>
<dd>
<p>Align the vocabulary used in your test names
with that used when describing the problem domain or referred by the application
itself.<a data-type="indexterm" data-primary="domains" data-secondary="using domain terminology in test naming" id="idm45816825363464"/></p>
</dd>
<dt>Use natural language</dt>
<dd>
<p>Every test name should be something that you can easily
read as a sentence. It should always describe some behavior in a readable way.</p>
</dd>
<dt>Be descriptive</dt>
<dd>
<p>Code will be read many times more often than it is written.
Don’t skimp on spending more time thinking of a good name that’s descriptive up
front and easier to understand later down the line. If you can’t think of a good
name, why not ask a colleague? In golf, you win by putting in the fewest shots.
Programming isn’t like that; shortest isn’t necessarily best.</p>
</dd>
</dl>

<p>You can follow the convention used in the <code>DocumentManagementSystemTest</code> of
prefixing test names with the word “should,” or choose not to; that’s merely a matter of
personal preference.<a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="naming tests" data-startref="ix_tstDMSnm" id="idm45816825358248"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Behavior Not Implementation"><div class="sect2" id="idm45816825409208">
<h2>Behavior Not Implementation</h2>

<p>If you’re writing a test for a class, a component, or even a system, then you
should only be testing the <em>public behavior</em> of whatever is being tested.<a data-type="indexterm" data-primary="behavior" data-secondary="testing public behavior, not implementation" id="ix_behtst"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="testing behavior, not implementation" id="ix_docmgtstbeh"/><a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="testing behavior, not implementation" id="ix_tstDMSbeh"/> In
the case of the Document Management System, we only have tests for the behavior
of our public API in the form of <code>DocumentManagementSystemTest</code>. In this test
we test the public API of the <code>DocumentManagementSystem</code> class and thus the
whole system. The API can be seen in <a data-type="xref" href="#dms_api">Example 4-17</a>.</p>
<div id="dms_api" data-type="example">
<h5><span class="label">Example 4-17. </span>Public API of the DocumentManagementSystem class</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DocumentManagementSystem</code>
<code class="o">{</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">importFile</code><code class="o">(</code><code class="kd">final</code> <code class="n">String</code> <code class="n">path</code><code class="o">)</code> <code class="o">{</code>
        <code class="o">...</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Document</code><code class="o">&gt;</code> <code class="nf">contents</code><code class="o">()</code> <code class="o">{</code>
        <code class="o">...</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Document</code><code class="o">&gt;</code> <code class="nf">search</code><code class="o">(</code><code class="kd">final</code> <code class="n">String</code> <code class="n">query</code><code class="o">)</code> <code class="o">{</code>
        <code class="o">...</code>
    <code class="o">}</code>
<code class="o">}</code></pre></div>

<p>Our tests should only invoke these public API methods and not try to inspect
the internal state of the objects or the design.<a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" data-tertiary="test for importing letters" id="idm45816825251704"/> This is one of the key
mistakes made by developers that leads to hard-to-maintain tests. Relying on
specific implementation details results in brittle tests because if you change
the implementation detail in question, the test can start to fail even if
the behavior is still working. Take a look at the test in <a data-type="xref" href="#shouldImportLetterAttributes">Example 4-18</a>.</p>
<div id="shouldImportLetterAttributes" data-type="example">
<h5><span class="label">Example 4-18. </span>Test for importing letters</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@Test</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shouldImportLetterAttributes</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code>
    <code class="o">{</code>
        <code class="n">system</code><code class="o">.</code><code class="na">importFile</code><code class="o">(</code><code class="n">LETTER</code><code class="o">);</code>

        <code class="kd">final</code> <code class="n">Document</code> <code class="n">document</code> <code class="o">=</code> <code class="n">onlyDocument</code><code class="o">();</code>

        <code class="n">assertAttributeEquals</code><code class="o">(</code><code class="n">document</code><code class="o">,</code> <code class="n">PATIENT</code><code class="o">,</code> <code class="n">JOE_BLOGGS</code><code class="o">);</code>
        <code class="n">assertAttributeEquals</code><code class="o">(</code><code class="n">document</code><code class="o">,</code> <code class="n">ADDRESS</code><code class="o">,</code>
            <code class="s">"123 Fake Street\n"</code> <code class="o">+</code>
                <code class="s">"Westminster\n"</code> <code class="o">+</code>
                <code class="s">"London\n"</code> <code class="o">+</code>
                <code class="s">"United Kingdom"</code><code class="o">);</code>
        <code class="n">assertAttributeEquals</code><code class="o">(</code><code class="n">document</code><code class="o">,</code> <code class="n">BODY</code><code class="o">,</code>
            <code class="s">"We are writing to you to confirm the re-scheduling of your appointment\n"</code> <code class="o">+</code>
            <code class="s">"with Dr. Avaj from 29th December 2016 to 5th January 2017."</code><code class="o">);</code>
        <code class="n">assertTypeIs</code><code class="o">(</code><code class="s">"LETTER"</code><code class="o">,</code> <code class="n">document</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>One way of testing this letter-importing functionality would have been to write the test as a
unit test on the <code>LetterImporter</code> class. This would have looked fairly similar:
importing an example file and then making an assert about the result returned
from the importer. In our tests, though, the mere existence of the
<code>LetterImporter</code> is an implementation detail. In <a data-type="xref" href="#extending_and_iterating">“Extending and Reusing Code”</a>,
you saw numerous other alternative choices for laying out our importer code. By
laying out our tests in this manner, we give ourselves the choice to refactor
our internals to a different design without breaking our tests.</p>

<p>So we’ve said that relying on the behavior of a class relies on using the public
API, but there’s also some parts of the behavior that aren’t usually restricted
just through making methods public or private. For example, we might not want
to rely on the order of documents being being returned from the <code>contents()</code>
method. That isn’t a property that’s restricted by the public API of the
<code>DocumentManagementSystem</code> class, but simply something that you need to be careful
to avoid doing.</p>

<p>A common anti-pattern in this regard is exposing otherwise private state
through a getter or setter in order to make testing easier.<a data-type="indexterm" data-primary="anti-patterns" data-secondary="exposing private state through getters/setters" id="idm45816825114840"/> You should try to
avoid doing this wherever possible as it makes your tests brittle. If you have
exposed this state to make testing superficially easier, then you end up
making maintaining your application harder in the long run. This is because
any change to your codebase that involves changing the way this internal state is
represented now also requires altering your tests. This is sometimes a good
indication that you need to refactor out a new class that can be more easily and
effectively tested.<a data-type="indexterm" data-primary="behavior" data-secondary="testing public behavior, not implementation" data-startref="ix_behtst" id="idm45816825113240"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="testing behavior, not implementation" data-startref="ix_docmgtstbeh" id="idm45816825111992"/><a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="testing behavior, not implementation" data-startref="ix_tstDMSbeh" id="idm45816825110424"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Don’t Repeat Yourself"><div class="sect2" id="idm45816825108760">
<h2>Don’t Repeat Yourself</h2>

<p><a data-type="xref" href="#extending_and_iterating">“Extending and Reusing Code”</a> extensively discusses how we can remove duplicate
code from our application and where to place the resulting code.<a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="Don't Repeat Yourself" id="idm45816825106232"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="Don't Repeat Yourself" id="idm45816825105016"/><a data-type="indexterm" data-primary="Don't Repeat Yourself" id="idm45816825103832"/> The exact
same reasoning around maintenance applies equally to test code. Sadly, developers
often simply don’t bother to remove duplication from tests in the same way as
they would for application code.<a data-type="indexterm" data-primary="importers" data-secondary="for files in document management system" data-tertiary="test for importing images" id="idm45816825102808"/><a data-type="indexterm" data-primary="images" data-secondary="importing, test for" id="idm45816825101560"/> If you take a look at <a data-type="xref" href="#shouldImportImageAttributes">Example 4-19</a> you’ll see a test that repeatedly makes asserts about the different
attributes that a resulting <code>Document</code> has.</p>
<div id="shouldImportImageAttributes" data-type="example">
<h5><span class="label">Example 4-19. </span>Test for importing images</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@Test</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shouldImportImageAttributes</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code>
    <code class="o">{</code>
        <code class="n">system</code><code class="o">.</code><code class="na">importFile</code><code class="o">(</code><code class="n">XRAY</code><code class="o">);</code>

        <code class="kd">final</code> <code class="n">Document</code> <code class="n">document</code> <code class="o">=</code> <code class="n">onlyDocument</code><code class="o">();</code>

        <code class="n">assertAttributeEquals</code><code class="o">(</code><code class="n">document</code><code class="o">,</code> <code class="n">WIDTH</code><code class="o">,</code> <code class="s">"320"</code><code class="o">);</code>
        <code class="n">assertAttributeEquals</code><code class="o">(</code><code class="n">document</code><code class="o">,</code> <code class="n">HEIGHT</code><code class="o">,</code> <code class="s">"179"</code><code class="o">);</code>
        <code class="n">assertTypeIs</code><code class="o">(</code><code class="s">"IMAGE"</code><code class="o">,</code> <code class="n">document</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>Normally you would have to look up the attribute name for every attribute and
assert that it is equal to an expected value.<a data-type="indexterm" data-primary="attributes" data-secondary="assertAttributeEquals method" id="idm45816825066952"/><a data-type="indexterm" data-primary="assertion statements" data-secondary="assertAttributeEquals method" id="idm45816825077688"/><a data-type="indexterm" data-primary="assertAttributeEquals method" id="idm45816825076840"/> In the case of the tests here, this is
a common enough operation that a common method, <code>assertAttributeEquals</code>, was
extracted with this logic. Its implementation is shown in
<a data-type="xref" href="#assertAttributeEquals">Example 4-20</a>.</p>
<div id="assertAttributeEquals" data-type="example">
<h5><span class="label">Example 4-20. </span>Implementing a new assertion</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">assertAttributeEquals</code><code class="o">(</code>
        <code class="kd">final</code> <code class="n">Document</code> <code class="n">document</code><code class="o">,</code>
        <code class="kd">final</code> <code class="n">String</code> <code class="n">attributeName</code><code class="o">,</code>
        <code class="kd">final</code> <code class="n">String</code> <code class="n">expectedValue</code><code class="o">)</code>
    <code class="o">{</code>
        <code class="n">assertEquals</code><code class="o">(</code>
            <code class="s">"Document has the wrong value for "</code> <code class="o">+</code> <code class="n">attributeName</code><code class="o">,</code>
            <code class="n">expectedValue</code><code class="o">,</code>
            <code class="n">document</code><code class="o">.</code><code class="na">getAttribute</code><code class="o">(</code><code class="n">attributeName</code><code class="o">));</code>
    <code class="o">}</code></pre></div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Good Diagnostics"><div class="sect2" id="idm45816824994248">
<h2>Good Diagnostics</h2>

<p>Tests would be no good if they didn’t fail.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="good diagnostics for test failures" id="ix_docmgtstdiag"/><a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="good diagnostics for test failures" id="ix_tstDMSdiag"/><a data-type="indexterm" data-primary="diagnostics, good, for failing tests" id="ix_diag"/> In fact, if you’ve never seen a test
fail how do you know if it’s working at all? When writing tests the best
thing to do is to optimize for failure. When we say optimize, we don’t mean make the
test run faster when it fails—we mean ensure that it is written in a way that
makes understanding why and how it failed as easy as possible. The trick to
this is good <em>diagnostics</em>.</p>

<p>By diagnostics we mean the message and information that gets printed out when <span class="keep-together">a test</span> fails. The clearer this message is about what has failed, the easier it
is to debug <span class="keep+together">the test</span> failure. You might ask why even bother with this when a
lot of the time Java tests are run from within modern IDEs that have debuggers
built in? Well, sometimes tests may be run within continuous integration
environments, and sometimes they may be from the command line. Even if you’re
running them within an IDE it is still helpful to have good diagnostic
information. Hopefully, we’ve convinced you of the need for good diagnostics, but
what do they look like in code?</p>

<p><a data-type="xref" href="#onlyDocument">Example 4-21</a> shows a method that asserts that the system only contains a
single document. We will explain the <code>hasSize()</code> method in a little bit.</p>
<div id="onlyDocument" data-type="example">
<h5><span class="label">Example 4-21. </span>Test that the system contains a single document</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="kd">private</code> <code class="n">Document</code> <code class="nf">onlyDocument</code><code class="o">()</code>
    <code class="o">{</code>
        <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Document</code><code class="o">&gt;</code> <code class="n">documents</code> <code class="o">=</code> <code class="n">system</code><code class="o">.</code><code class="na">contents</code><code class="o">();</code>
        <code class="n">assertThat</code><code class="o">(</code><code class="n">documents</code><code class="o">,</code> <code class="n">hasSize</code><code class="o">(</code><code class="mi">1</code><code class="o">));</code>
        <code class="k">return</code> <code class="n">documents</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>The simplest<a data-type="indexterm" data-primary="assertion statements" data-secondary="assertTrue method" id="idm45816824929048"/> type of assert that JUnit offers us is <code>assertTrue()</code>, which will
take a boolean value that it expects to be true. <a data-type="xref" href="#eg_assertTrue">Example 4-22</a> shows how we
could have just used <code>assertTrue</code> to implement the test. In this case the value
is being checked to equal <code>0</code> so that it will fail the <code>shouldImportFile</code> test
and thus demonstrate the failure diagnostics. The problem with this is that we
don’t get <a data-type="indexterm" data-primary="AssertionError" id="idm45816824904536"/>very good diagnostics—just an <code>AssertionError</code> with no information
in the message shown in <a data-type="xref" href="#fig0401">Figure 4-1</a>. You don’t know what failed, and you don’t know
what values were being compared. You know nothing, even if your name isn’t Jon
Snow.</p>
<div id="eg_assertTrue" data-type="example">
<h5><span class="label">Example 4-22. </span>assertTrue example</h5>

<pre data-type="programlisting" data-code-language="java"><code class="n">assertTrue</code><code class="o">(</code><code class="n">documents</code><code class="o">.</code><code class="na">size</code><code class="o">()</code> <code class="o">==</code> <code class="mi">0</code><code class="o">);</code></pre></div>

<figure><div id="fig0401" class="figure">
<img src="Images/rwsd_0401.png" alt="assertTrue example" width="1440" height="264"/>
<h6><span class="label">Figure 4-1. </span>Screenshot of assertTrue failing</h6>
</div></figure>

<p>The most commonly used assertion is <code>assertEquals</code>, which takes two values and
checks they are equal and is overloaded to support primitive values.<a data-type="indexterm" data-primary="assertion statements" data-secondary="assertEquals method" id="idm45816824810984"/> So here
we can assert that the size of the <code>documents</code> list is <code>0</code>, as shown in
<a data-type="xref" href="#eg_assertEquals">Example 4-23</a>. This produces a slightly better diagnostic as shown in
<a data-type="xref" href="#eg_assertEquals_img">Figure 4-2</a>, you know that
the expected value was <code>0</code> and the actual value was <code>1</code>, but it still doesn’t
give you any meaningful context.</p>
<div id="eg_assertEquals" data-type="example">
<h5><span class="label">Example 4-23. </span>assertEquals example</h5>

<pre data-type="programlisting" data-code-language="java"><code class="n">assertEquals</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">documents</code><code class="o">.</code><code class="na">size</code><code class="o">());</code></pre></div>

<figure><div id="eg_assertEquals_img" class="figure">
<img src="Images/rwsd_0402.png" alt="assertEquals example" width="1440" height="314"/>
<h6><span class="label">Figure 4-2. </span>Screenshot of assertEquals example failing</h6>
</div></figure>

<p>The best way of making an assert about the size itself is to use a
<em>matcher</em> for<a data-type="indexterm" data-primary="matchers" id="idm45816824859176"/> asserting the collection size as this provides the most
descriptive diagnostics. <a data-type="xref" href="#eg_assertThat">Example 4-24</a> has our example written in that
style and demonstrates the output as well. As <a data-type="xref" href="#eg_assertThat_img">Figure 4-3</a> shows, this
is much clearer as to what went wrong
without you needing to write any more code.<a data-type="indexterm" data-primary="assertion statements" data-secondary="assertThat method" id="idm45816824856600"/></p>
<div id="eg_assertThat" data-type="example">
<h5><span class="label">Example 4-24. </span>assertThat example</h5>

<pre data-type="programlisting" data-code-language="java"><code class="n">assertThat</code><code class="o">(</code><code class="n">documents</code><code class="o">,</code> <code class="n">hasSize</code><code class="o">(</code><code class="mi">0</code><code class="o">));</code></pre></div>

<figure><div id="eg_assertThat_img" class="figure">
<img src="Images/rwsd_0403.png" alt="assertThat example" width="1440" height="318"/>
<h6><span class="label">Figure 4-3. </span>Screenshot of assertThat example failing</h6>
</div></figure>

<p>What is going on here is that JUnit’s <code>assertThat()</code> is being used. The method <code>assertThat()</code>
takes a value as its first parameter and a <code>Matcher</code> as its second.<a data-type="indexterm" data-primary="matchers" data-secondary="Matchers utility class, hasSize method" id="idm45816824786360"/> The
<code>Matcher</code> encapsulates the concept of whether a value matches some property and
also its associated diagnostics. The <code>hasSize</code> matcher is statically imported
from a <code>Matchers</code> utility class that contains a bundle of different matchers
and checks that the size of a collection is equal to its parameter.  These
matchers come from the <a href="http://hamcrest.org/">Hamcrest library</a>, which is a very
commonly used Java library that enables cleaner testing.<a data-type="indexterm" data-primary="Hamcrest library, matchers from" id="idm45816824782136"/></p>

<p>Another example of how you can build better diagnostics was shown in
<a data-type="xref" href="#assertAttributeEquals">Example 4-20</a>. Here an <code>assertEquals</code> would have given us the
diagnostic for the attribute’s expected value and actual value. It wouldn’t
have told us what the name of the attribute was, so this was added into the
message string to help us understand failure.<a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="good diagnostics for test failures" data-startref="ix_docmgtstdiag" id="idm45816824779720"/><a data-type="indexterm" data-primary="diagnostics, good, for failing tests" data-startref="ix_diag" id="idm45816824752120"/><a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="good diagnostics for test failures" data-startref="ix_tstDMSdiag" id="idm45816824751160"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Testing Error Cases"><div class="sect2" id="idm45816824942200">
<h2>Testing Error Cases</h2>

<p>One of the absolute worst and most common mistakes to make when writing
software is only to test the beautiful, golden, happy path of your application—the code path that is executed when the sun is shining on you and nothing goes
wrong.<a data-type="indexterm" data-primary="errors" data-secondary="testing error cases in document management system" id="idm45816824747768"/><a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="testing error cases" id="idm45816824746824"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="testing error cases" id="idm45816824745576"/>  In practice lots of things can go wrong! If you don’t test how your
application behaves in these situations, you’re not going to end up with
software that will work reliably in a production setting.</p>

<p>When it comes to importing documents into our Document Management System there
are a couple of error cases that might happen. We might try to import a file
that doesn’t exist or can’t be read, or we might try to import a file that
we don’t know how to extract text from or read.</p>

<p>Our <code>DocumentManagementSystemTest</code> has a couple of tests, shown in
<a data-type="xref" href="#errorTests">Example 4-25</a>, that test these two scenarios. In both cases we try to import a
path file that will expose the problem. In order to make an assert about the
desired behavior we use the <code>expected =</code> attribute of JUnit’s  <code>@Test</code>
annotation.<a data-type="indexterm" data-primary="@Test annotation" data-secondary="expected =+ attribute" id="idm45816824740376"/> This enables you to say <em>Hey listen, JUnit, I’m expecting this test
to throw an exception, it’s of a certain type</em>.</p>
<div id="errorTests" data-type="example">
<h5><span class="label">Example 4-25. </span>Testing for error cases</h5>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@Test</code><code class="o">(</code><code class="n">expected</code> <code class="o">=</code> <code class="n">FileNotFoundException</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shouldNotImportMissingFile</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code>
    <code class="o">{</code>
        <code class="n">system</code><code class="o">.</code><code class="na">importFile</code><code class="o">(</code><code class="s">"gobbledygook.txt"</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@Test</code><code class="o">(</code><code class="n">expected</code> <code class="o">=</code> <code class="n">UnknownFileTypeException</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shouldNotImportUnknownFile</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code>
    <code class="o">{</code>
        <code class="n">system</code><code class="o">.</code><code class="na">importFile</code><code class="o">(</code><code class="n">RESOURCES</code> <code class="o">+</code> <code class="s">"unknown.txt"</code><code class="o">);</code>
    <code class="o">}</code></pre></div>

<p>You may want an alternative behavior to simply throwing an exception in the
case of an error, but it’s definitely helpful to know how to assert that an
exception is thrown.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Constants"><div class="sect2" id="idm45816824667192">
<h2>Constants</h2>

<p>Constants are values that do not change. Let’s
face it—they are one of the few well-named concepts when it comes to computer
programming.<a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-tertiary="constants" id="idm45816824665864"/><a data-type="indexterm" data-primary="constants" data-secondary="names that can be used in tests" id="idm45816824664584"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-tertiary="constants" id="idm45816824663672"/><a data-type="indexterm" data-primary="names" data-secondary="naming constants for use in tests" id="idm45816824662488"/> The Java programming language doesn’t use an explicit <code>const</code>
keyword like C++ does, but conventionally developers create <code>static
field</code> fields in order to represent constants. Since many tests consist of
examples of how a part of your computer program should be used, they often
consist of many constants.</p>

<p>It’s a good idea when it comes to constants that have some kind of nonobvious
meaning to give them a proper name that can be used within tests. We do that
extensively through the <code>DocumentManagementSystemTest</code>, and in fact, have a block
at the top dedicated to declaring constants, shown in <a data-type="xref" href="#eg_constants">Example 4-26</a>.</p>
<div id="eg_constants" data-type="example">
<h5><span class="label">Example 4-26. </span>Constants</h5>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DocumentManagementSystemTest</code>
<code class="o">{</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">RESOURCES</code> <code class="o">=</code>
        <code class="s">"src"</code> <code class="o">+</code> <code class="n">File</code><code class="o">.</code><code class="na">separator</code> <code class="o">+</code> <code class="s">"test"</code> <code class="o">+</code> <code class="n">File</code><code class="o">.</code><code class="na">separator</code> <code class="o">+</code> <code class="s">"resources"</code> <code class="o">+</code> <code class="n">File</code><code class="o">.</code><code class="na">separator</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">LETTER</code> <code class="o">=</code> <code class="n">RESOURCES</code> <code class="o">+</code> <code class="s">"patient.letter"</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">REPORT</code> <code class="o">=</code> <code class="n">RESOURCES</code> <code class="o">+</code> <code class="s">"patient.report"</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">XRAY</code> <code class="o">=</code> <code class="n">RESOURCES</code> <code class="o">+</code> <code class="s">"xray.jpg"</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">INVOICE</code> <code class="o">=</code> <code class="n">RESOURCES</code> <code class="o">+</code> <code class="s">"patient.invoice"</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">JOE_BLOGGS</code> <code class="o">=</code> <code class="s">"Joe Bloggs"</code><code class="o">;</code></pre></div>
</div></section>





</div></section>













<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="Takeaways"><div class="sect1" id="idm45816824654760">
<h1>Takeaways</h1>

<ul>
<li>
<p>You learned how to build a Document Management System.<a data-type="indexterm" data-primary="testing" data-secondary="test hygiene in document management system" data-startref="ix_tstDMS" id="idm45816824541848"/><a data-type="indexterm" data-primary="document management system (example)" data-secondary="test hygiene" data-startref="ix_docmgtst" id="idm45816824540504"/></p>
</li>
<li>
<p>You recognized the different trade-offs between different implementation
approaches.</p>
</li>
<li>
<p>You understood several principles that drive the design of software.</p>
</li>
<li>
<p>You were introduced to the Liskov Substitution Principle as a way to think about inheritance.</p>
</li>
<li>
<p>You learned about situations where inheritance wasn’t appropriate.</p>
</li>
</ul>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Iterating on You"><div class="sect1" id="idm45816824535400">
<h1>Iterating on You</h1>

<p>If you want to extend and solidify the knowledge from this section you could try one of these activities:</p>

<ul>
<li>
<p>Take the existing sample code and add an implementation for importing prescription documents. A prescription
should have a patient, a drug, a quantity, a date, and state the conditions for taking a drug. You should
also write a test that checks that the prescription import works.</p>
</li>
<li>
<p>Try implementing the <a href="https://oreil.ly/RrxJU">Game of Life Kata</a>.</p>
</li>
</ul>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Completing the Challenge"><div class="sect1" id="idm45816824530488">
<h1>Completing the Challenge</h1>

<p>Dr. Avaj is really pleased with your Document Management System and she now
uses it extensively. Her needs are effectively met by the features because you
drove your design from her requirements toward application behavior and into
your implementation details. This is a theme that you will return to when TDD is
introduced in the next chapter.<a data-type="indexterm" data-primary="document management system (example)" data-startref="ix_docmg" id="idm45816824528792"/></p>
</div></section>







</div></section></div>



  </body></html>