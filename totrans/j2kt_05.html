<html><head></head><body><section data-pdf-bookmark="Chapter 5. Beans to Values" data-type="chapter" epub:type="chapter"><div class="chapter" id="beans-to-values">&#13;
<h1><span class="label">Chapter 5. </span>Beans to Values</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Many Java projects have settled on mutable JavaBeans or POJO (plain old Java object) conventions for representing data.&#13;
Mutability brings complications, though.&#13;
Why are immutable values a better choice, and how can we reduce the cost of mutability in a codebase?</p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Beans" data-type="sect1"><div class="sect1" id="idm46393406553576">&#13;
<h1>Beans</h1>&#13;
&#13;
<p>As<a data-primary="JavaBeans" data-type="indexterm" id="idm46393406552008"/><a data-primary="mutability" data-secondary="JavaBeans" data-type="indexterm" id="idm46393406551272"/> we discussed in <a data-type="xref" href="ch01.html#bean-java-style">“Bean Style”</a>, JavaBeans were introduced to allow the development of drag-and-drop GUI builders in the Visual Basic style.&#13;
A developer could drop a button onto a form, change its title and icon, and then wire in an on-click handler.&#13;
Behind the scenes, the GUI builder would write code to instantiate a button object and then call setters for the properties that the developer had changed.</p>&#13;
&#13;
<p>To define a JavaBean, a class needs a default (no-argument) constructor, getters for its properties, and setters for its mutable properties. (We’ll gloss over the <code>Serializable</code> requirement, because even Sun never really took this seriously.)&#13;
This makes sense for objects that have a lot of properties.&#13;
GUI components typically have foreground and background colors, font, label, borders, size, alignments, paddings, and so on.&#13;
Mostly the defaults for these properties are fine, so calling setters for just the special values minimizes the amount of code to be generated.&#13;
Even today, a mutable component model is a solid choice for GUI toolkits.</p>&#13;
&#13;
<p>When JavaBeans were introduced, though, we thought of most objects as mutable, not just UI components.&#13;
I mean, why not? The point of objects was to encapsulate properties and manage the relationships between them.&#13;
They were <em>designed</em> to solve problems like updating the width of a component when its bounds are changed, or the total of a shopping cart as items are added.&#13;
Objects were the solution to the problem of managing mutable state.&#13;
Java was quite radical at the time in having an immutable <code>String</code> class (although it couldn’t help itself and still plumped for a mutable <code>Date</code>).</p>&#13;
&#13;
<p>As a profession, we have a more sophisticated understanding these days.&#13;
We appreciate that we can use objects to represent different types of things—values, entities, services, actions, transactions, and so on.&#13;
And yet the default pattern for a Java object is still the JavaBean, a mutable object with getters and setters for its properties.&#13;
Although it may be appropriate for a UI toolkit, this is not a good default pattern.&#13;
For most things that we want to represent with objects, a value would be better.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Values" data-type="sect1"><div class="sect1" id="idm46393406544232">&#13;
<h1>Values</h1>&#13;
&#13;
<p><em>Value</em> is<a data-primary="mutability" data-secondary="values and" data-type="indexterm" id="idm46393406542312"/><a data-primary="values" data-secondary="mutability and" data-type="indexterm" id="idm46393406541304"/> a much overloaded term in English.&#13;
In computing, we say that variables, parameters, and fields have values: the primitive or reference that they are bound to.&#13;
When we refer to <em>a value</em> in this book, we are referring to a specific type of primitive or reference: those with value semantics.&#13;
An object has value semantics if only its value is significant in its interactions, not its identity.&#13;
Java primitives all have value semantics: every <code>7</code> is equal to every other <code>7</code>.&#13;
Objects may or may not have value semantics though; in particular, mutable objects do not.&#13;
In later chapters we’ll look at finer distinctions, but for now, let’s just define a <em>value</em> to be an immutable piece of data, and a <em>value type</em> to be a type that defines the behavior of an immutable piece of data.</p>&#13;
&#13;
<p>So <code>7</code> is a value, and the boxed <code>Integer</code> is a value type (because boxed types are immutable), <code>banana</code> is a value (because <code>String</code>s are immutable), a <code>URI</code> is a value (because <code>URI</code>s are immutable), but <code>java.util.Date</code> is not a value type (because we can call <code>setYear</code> and others on the date).</p>&#13;
&#13;
<p>An instance of an immutable <code>DBConnectionInfo</code> is a value, but an instance of <code>Database</code> is not a value, even if all its properties are immutable. This is because it is not a piece of data; it is a means of accessing, and mutating, pieces of data.</p>&#13;
&#13;
<p>Are JavaBeans values?&#13;
UI component JavaBeans are not values because UI components aren’t just data—two otherwise identical buttons have different identities.&#13;
In the case of beans used to represent plain data, it will depend on whether they are immutable.&#13;
It is possible to create immutable beans, but most developers would think of these more as plain old java objects.</p>&#13;
&#13;
<p>Are POJOs values?&#13;
The<a data-primary="POJOs (plain old Java objects)" data-type="indexterm" id="POJO05"/> term was coined to refer to classes that don’t have to extend from framework types to be useful.&#13;
They usually represent data and conform to the JavaBeans conventions for accessor methods.&#13;
Many POJOs will not have a default constructor, but instead define constructors to initialize properties that don’t have sensible defaults.&#13;
Because of this, immutable POJOs are common and may have value semantics.&#13;
Mutable POJOs still seem to be the default though, so much so that many people consider that object-oriented programming in Java is synonymous with mutable objects.&#13;
Mutable POJOs are not values.</p>&#13;
&#13;
<p>In summary, a bean could technically be a value but rarely is.&#13;
POJOs more often have value semantics, especially in the modern Java age.&#13;
So whereas <em>Beans to Values</em> is snappy, in this chapter we’re really looking at refactoring from mutable objects to immutable data, so maybe we should have called it <em>Mutable POJOs to Values</em>.&#13;
We hope you’ll forgive the sloppy title.<a data-primary="" data-startref="POJO05" data-type="indexterm" id="idm46393406527480"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Why Should We Prefer Values?" data-type="sect1"><div class="sect1" id="idm46393406526376">&#13;
<h1>Why Should We Prefer Values?</h1>&#13;
&#13;
<p>A<a data-primary="values" data-secondary="benefits of immutable objects" data-type="indexterm" id="idm46393406525112"/> value is immutable data.&#13;
Why should we prefer immutable objects to mutable objects, and objects that represent data to other types of objects?&#13;
This is a theme that we will visit time and again in this book.&#13;
For now, let’s just say that immutable objects are easier to reason about because they don’t change, and so:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>We can put them into sets or use them as map keys.</p>&#13;
</li>&#13;
<li>&#13;
<p>We never have to worry about an immutable collection changing as we iterate over its contents.</p>&#13;
</li>&#13;
<li>&#13;
<p>We can explore different scenarios without having to deep-copy initial states (which also makes it easy to implement undo and redo).</p>&#13;
</li>&#13;
<li>&#13;
<p>We can safely share immutable objects between different threads.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring Beans to Values" data-type="sect1"><div class="sect1" id="idm46393406417928">&#13;
<h1>Refactoring Beans to Values</h1>&#13;
&#13;
<p>Let’s<a data-primary="mutability" data-secondary="refactoring JavaBeans to values" data-type="indexterm" id="Mjbtov05"/><a data-primary="refactoring" data-secondary="JavaBeans to values" data-type="indexterm" id="Rjbtov05"/><a data-primary="values" data-secondary="refactoring JavaBeans to values" data-type="indexterm" id="Vrefact05"/> look at refactoring a use of a mutable bean or POJO to a value.</p>&#13;
&#13;
<p>Travelator has a mobile app, and the Android version is written in Java.&#13;
In that code, we represent user preferences with a <code>UserPreferences</code> JavaBean:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">UserPreferences</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="n">String</code> <code class="n">greeting</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="n">Locale</code> <code class="n">locale</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="n">Currency</code> <code class="n">currency</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">UserPreferences</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">(</code><code class="s">"Hello"</code><code class="o">,</code> <code class="n">Locale</code><code class="o">.</code><code class="na">UK</code><code class="o">,</code> <code class="n">Currency</code><code class="o">.</code><code class="na">getInstance</code><code class="o">(</code><code class="n">Locale</code><code class="o">.</code><code class="na">UK</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">UserPreferences</code><code class="o">(</code><code class="n">String</code> <code class="n">greeting</code><code class="o">,</code> <code class="n">Locale</code> <code class="n">locale</code><code class="o">,</code> <code class="n">Currency</code> <code class="n">currency</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">greeting</code> <code class="o">=</code> <code class="n">greeting</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">locale</code> <code class="o">=</code> <code class="n">locale</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">currency</code> <code class="o">=</code> <code class="n">currency</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getGreeting</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">greeting</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setGreeting</code><code class="o">(</code><code class="n">String</code> <code class="n">greeting</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">greeting</code> <code class="o">=</code> <code class="n">greeting</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="o">...</code> <code class="n">getters</code> <code class="n">and</code> <code class="n">setters</code> <code class="k">for</code> <code class="n">locale</code> <code class="n">and</code> <code class="n">currency</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.1&amp;show=file">Example 5.1 [beans-to-values.0:src/main/java/travelator/mobile/UserPreferences.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The <code>Application</code> has a <code>preferences</code> property, which it passes to views that need it:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Application</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">UserPreferences</code> <code class="n">preferences</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Application</code><code class="o">(</code><code class="n">UserPreferences</code> <code class="n">preferences</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">preferences</code> <code class="o">=</code> <code class="n">preferences</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">showWelcome</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">WelcomeView</code><code class="o">(</code><code class="n">preferences</code><code class="o">).</code><code class="na">show</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">editPreferences</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">PreferencesView</code><code class="o">(</code><code class="n">preferences</code><code class="o">).</code><code class="na">show</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
    <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.2&amp;show=file">Example 5.2 [beans-to-values.0:src/main/java/travelator/mobile/Application.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>(Any similarity to an actual UI framework, living or dead, is purely coincidental.)</p>&#13;
&#13;
<p>Finally, <code>PreferencesView</code> updates its <code>preferences</code> when the user makes changes.&#13;
We know that there has been a change because <code>onThingChange()</code> will be called:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">PreferencesView</code> <code class="kd">extends</code> <code class="n">View</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">UserPreferences</code> <code class="n">preferences</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">GreetingPicker</code> <code class="n">greetingPicker</code> <code class="o">=</code> <code class="k">new</code> <code class="n">GreetingPicker</code><code class="o">();</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">LocalePicker</code> <code class="n">localePicker</code> <code class="o">=</code> <code class="k">new</code> <code class="n">LocalePicker</code><code class="o">();</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">CurrencyPicker</code> <code class="n">currencyPicker</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CurrencyPicker</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">PreferencesView</code><code class="o">(</code><code class="n">UserPreferences</code> <code class="n">preferences</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">preferences</code> <code class="o">=</code> <code class="n">preferences</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">show</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">greetingPicker</code><code class="o">.</code><code class="na">setGreeting</code><code class="o">(</code><code class="n">preferences</code><code class="o">.</code><code class="na">getGreeting</code><code class="o">());</code>&#13;
        <code class="n">localePicker</code><code class="o">.</code><code class="na">setLocale</code><code class="o">(</code><code class="n">preferences</code><code class="o">.</code><code class="na">getLocale</code><code class="o">());</code>&#13;
        <code class="n">currencyPicker</code><code class="o">.</code><code class="na">setCurrency</code><code class="o">(</code><code class="n">preferences</code><code class="o">.</code><code class="na">getCurrency</code><code class="o">());</code>&#13;
        <code class="kd">super</code><code class="o">.</code><code class="na">show</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onGreetingChange</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">preferences</code><code class="o">.</code><code class="na">setGreeting</code><code class="o">(</code><code class="n">greetingPicker</code><code class="o">.</code><code class="na">getGreeting</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onLocaleChange</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">preferences</code><code class="o">.</code><code class="na">setLocale</code><code class="o">(</code><code class="n">localePicker</code><code class="o">.</code><code class="na">getLocale</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCurrencyChange</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">preferences</code><code class="o">.</code><code class="na">setCurrency</code><code class="o">(</code><code class="n">currencyPicker</code><code class="o">.</code><code class="na">getCurrency</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
    <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.3&amp;show=file">Example 5.3 [beans-to-values.0:src/main/java/travelator/mobile/PreferencesView.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This design, though simple, is fraught with complications typical of mutable data, such as:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>If the <code>PreferencesView</code> and <code>WelcomeView</code> are both active, the <code>WelcomeView</code> can get out of sync with the current values.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>UserPreferences</code> equality and hash-code depend on the values of its properties, which may be changed.&#13;
So we can’t reliably use <code>UserPreferences</code> in sets or as keys in maps.</p>&#13;
</li>&#13;
<li>&#13;
<p>There is nothing to indicate that the <code>WelcomeView</code> only reads from the preferences.</p>&#13;
</li>&#13;
<li>&#13;
<p>If reading and writing occur on different threads, we have to manage synchronization at the preference property level.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Before we refactor to using an immutable value, let’s convert <code>Application</code> and <code>User​Pre⁠ferences</code> to Kotlin, which will help us see the nature of our model.&#13;
<code>Application</code> is &#13;
<span class="keep-together">simple</span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Application</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">preferences</code><code class="p">:</code> <code class="n">UserPreferences</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">showWelcome</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">WelcomeView</code><code class="p">(</code><code class="n">preferences</code><code class="p">).</code><code class="n">show</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">editPreferences</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">PreferencesView</code><code class="p">(</code><code class="n">preferences</code><code class="p">).</code><code class="n">show</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.4&amp;show=file">Example 5.4 [beans-to-values.1:src/main/java/travelator/mobile/Application.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>UserPreferences</code> is more complicated.&#13;
“Convert to Kotlin” in IntelliJ yields this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">UserPreferences</code> <code class="n">@JvmOverloads</code> <code class="n">constructor</code><code class="p">(</code>&#13;
    <code class="k">var</code> <code class="py">greeting</code><code class="p">:</code> <code class="n">String</code> <code class="p">=</code> <code class="s">"Hello"</code><code class="p">,</code>&#13;
    <code class="k">var</code> <code class="py">locale</code><code class="p">:</code> <code class="n">Locale</code> <code class="p">=</code> <code class="n">Locale</code><code class="p">.</code><code class="n">UK</code><code class="p">,</code>&#13;
    <code class="k">var</code> <code class="py">currency</code><code class="p">:</code> <code class="n">Currency</code> <code class="p">=</code> <code class="n">Currency</code><code class="p">.</code><code class="n">getInstance</code><code class="p">(</code><code class="n">Locale</code><code class="p">.</code><code class="n">UK</code><code class="p">)</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.5&amp;show=file">Example 5.5 [beans-to-values.1:src/main/java/travelator/mobile/UserPreferences.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is quite a sophisticated conversion.&#13;
The <code>@JVMOverloads</code> annotation tells the compiler to generate multiple constructors that allow combinations of <code>greeting</code>, <code>locale</code>, or <code>currency</code> to be defaulted. This wasn’t what our original Java did; it had just two constructors (one of which was the default, no-argument constructor).</p>&#13;
&#13;
<p>At this stage we haven’t changed the functioning of our application, just simplified its expression.&#13;
Those <code>var</code> (as opposed to <code>val</code>) properties are the sign that we have mutable data.&#13;
It’s worth reminding ourselves at this point that the Kotlin compiler is going to generate a private field, a getter method, and a setter method for each property, so that our Java continues to see the data class as a bean.&#13;
Kotlin embraces the beans naming convention, and <code>var</code> properties allow us to define mutable beans, for better or worse.</p>&#13;
&#13;
<p>Assuming<a data-primary="transformations" data-secondary="turning mutation into transformation" data-type="indexterm" id="idm46393405837560"/> worse, how now do we make <code>UserPreferences</code> immutable?&#13;
After all, we do need the preferences as seen in the app to reflect any changes the user makes.&#13;
The answer is to move the mutation.&#13;
In common with many of the refactorings in this book, we’re going to move the problematic thing (in this case mutation) up.&#13;
Which is to say, toward the entry point, or into the higher-level, more application-specific code.</p>&#13;
&#13;
<p>Instead of mutating the preferences, we are going to update the reference in the &#13;
<span class="keep-together"><code>Application</code></span>.&#13;
The reference we’re going to use will be an updated copy returned by &#13;
<span class="keep-together"><code>PreferencesView</code></span>.&#13;
In short, our strategy is to replace an immutable reference to a mutable object with a mutable reference to an immutable value.&#13;
Why?&#13;
Well, this reduces both the number and visibility of the potentially moving parts, and it is visibility of mutation that causes us problems.</p>&#13;
&#13;
<p>We’ll work our way there gradually, starting by converting <code>PreferencesView</code> to Kotlin:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">PreferencesView</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">preferences</code><code class="p">:</code> <code class="n">UserPreferences</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">View</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">greetingPicker</code> <code class="p">=</code> <code class="n">GreetingPicker</code><code class="p">()</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">localePicker</code> <code class="p">=</code> <code class="n">LocalePicker</code><code class="p">()</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">currencyPicker</code> <code class="p">=</code> <code class="n">CurrencyPicker</code><code class="p">()</code>&#13;
&#13;
    <code class="k">override</code> <code class="k">fun</code> <code class="nf">show</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">greeting</code>&#13;
        <code class="n">localePicker</code><code class="p">.</code><code class="n">locale</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">locale</code>&#13;
        <code class="n">currencyPicker</code><code class="p">.</code><code class="n">currency</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">currency</code>&#13;
        <code class="k">super</code><code class="p">.</code><code class="n">show</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">protected</code> <code class="k">fun</code> <code class="nf">onGreetingChange</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">preferences</code><code class="p">.</code><code class="n">greeting</code> <code class="p">=</code> <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code> <code class="n">onLocaleChange</code><code class="p">,</code> <code class="n">onCurrencyChange</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.6&amp;show=file">Example 5.6 [beans-to-values.3:src/main/java/travelator/mobile/PreferencesView.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>show()</code> overrides a method in <code>View</code> that makes the view visible and blocks the calling thread until it is dismissed.&#13;
To avoid mutation, we would like a version that returns a copy of the <code>UserPreferences</code> with any changes applied, but we can’t add a return type to the <code>View</code> method.&#13;
So instead, we’ll rename <code>show</code> to <code>showModal</code>, returning the existing mutable <code>preferences</code> property once <code>super.show()</code> has returned:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">showModal</code><code class="p">():</code> <code class="n">UserPreferences</code> <code class="p">{</code>&#13;
    <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">greeting</code>&#13;
    <code class="n">localePicker</code><code class="p">.</code><code class="n">locale</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">locale</code>&#13;
    <code class="n">currencyPicker</code><code class="p">.</code><code class="n">currency</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">currency</code>&#13;
    <code class="n">show</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">preferences</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.7&amp;show=file">Example 5.7 [beans-to-values.4:src/main/java/travelator/mobile/PreferencesView.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>Application.editPreferences()</code> was calling its <code>preferencesView.show()</code> and relying on the fact that it and <code>PreferencesView</code> shared a reference to a mutable object to see any edits.&#13;
We’ll now make <code>Application.preferences</code> a mutable property, set from the result of <code>showModal</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code><code> </code><code class="nc">Application</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="k">private</code><code> </code><code class="k">var</code><code> </code><code class="py">preferences</code><code class="p">:</code><code> </code><code class="n">UserPreferences</code><code> </code><a class="co" href="#callout_introduction_CO4-1" id="co_introduction_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">fun</code><code> </code><code class="nf">editPreferences</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">preferences</code><code> </code><code class="p">=</code><code> </code><code class="n">PreferencesView</code><code class="p">(</code><code class="n">preferences</code><code class="p">)</code><code class="p">.</code><code class="n">showModal</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.8&amp;show=file">Example 5.8 [beans-to-values.4:src/main/java/travelator/mobile/Application.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO4-1" id="callout_introduction_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Now a <code>var</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>The <code>showModal</code> method is currently returning the same object passed to the view in the constructor, so this doesn’t change anything really.&#13;
In fact, we have the worst of both worlds: a mutable reference to mutable data.</p>&#13;
&#13;
<p>We haven’t finished though; we can make things even worse by making the &#13;
<span class="keep-together"><code>preferences</code></span> property in <code>PreferencesView</code> mutable too, so that we can set it to a new <code>UserPreferences</code> object when any UI elements are updated:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">PreferencesView</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">var</code> <code class="py">preferences</code><code class="p">:</code> <code class="n">UserPreferences</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">View</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">greetingPicker</code> <code class="p">=</code> <code class="n">GreetingPicker</code><code class="p">()</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">localePicker</code> <code class="p">=</code> <code class="n">LocalePicker</code><code class="p">()</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">currencyPicker</code> <code class="p">=</code> <code class="n">CurrencyPicker</code><code class="p">()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">showModal</code><code class="p">():</code> <code class="n">UserPreferences</code> <code class="p">{</code>&#13;
        <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">greeting</code>&#13;
        <code class="n">localePicker</code><code class="p">.</code><code class="n">locale</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">locale</code>&#13;
        <code class="n">currencyPicker</code><code class="p">.</code><code class="n">currency</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">currency</code>&#13;
        <code class="n">show</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">preferences</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">protected</code> <code class="k">fun</code> <code class="nf">onGreetingChange</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">preferences</code> <code class="p">=</code> <code class="n">UserPreferences</code><code class="p">(</code>&#13;
            <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code><code class="p">,</code>&#13;
            <code class="n">preferences</code><code class="p">.</code><code class="n">locale</code><code class="p">,</code>&#13;
            <code class="n">preferences</code><code class="p">.</code><code class="n">currency</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code> <code class="n">onLocaleChange</code><code class="p">,</code> <code class="n">onCurrencyChange</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.9&amp;show=file">Example 5.9 [beans-to-values.5:src/main/java/travelator/mobile/PreferencesView.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Actually, we say “even worse,” but this has now removed all the uses of the setters on <code>UserPreferences</code>.&#13;
Without setters, we can make it a proper value, initializing its properties in its constructor and never modifying them.&#13;
In Kotlin this means changing the <code>var</code> properties to <code>val</code> and inlining any use of the default constructor.&#13;
This allows us to reduce <code>UserPreferences</code> to:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">UserPreferences</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">greeting</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">locale</code><code class="p">:</code> <code class="n">Locale</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">currency</code><code class="p">:</code> <code class="n">Currency</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.10&amp;show=file">Example 5.10 [beans-to-values.6:src/main/java/travelator/mobile/UserPreferences.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The eagle-eyed reader will notice that we sneakily made <code>UserPreferences</code> a data class.&#13;
We didn’t do that before now, because it was mutable.&#13;
While Kotlin <em>allows</em> mutable data classes, we should be even more wary of them than of other mutable classes, because data classes implement <code>equals</code> and <code>hashCode</code>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="object-equality">&#13;
<h5>Object Equality</h5>&#13;
<p>Data<a data-primary="object equality" data-type="indexterm" id="idm46393405418312"/><a data-primary="data classes" data-secondary="object equality" data-type="indexterm" id="idm46393405417576"/> classes derive <code>equals</code> and <code>hashCode</code> methods from the values of all the properties declared in their primary constructor.&#13;
So two instances of the same class will be equal when (and only when) all their corresponding properties have the same values.</p>&#13;
&#13;
<p>Maps and sets call <code>equals</code> and <code>hashCode</code> when they store objects, but if we subsequently mutate those objects, <a href="https://oreil.ly/keALT">strange things happen</a>.</p>&#13;
&#13;
<p>Don’t rely on equality and hash-code for mutable objects, and don’t define mutable data classes.</p>&#13;
</div></aside>&#13;
&#13;
<p>What have we achieved so far?&#13;
We’ve replaced two immutable references to shared mutable data with two mutable references to immutable values.&#13;
Now we can see at a glance which views can update the preferences, and if we had to manage updates across threads, we could do that at the application level.</p>&#13;
&#13;
<p>Having a mutable reference in <code>PreferencesView</code> is a bit irritating though.&#13;
We can fix that by not holding a reference at all, but instead passing the preferences into &#13;
<span class="keep-together"><code>showModal</code></span>.&#13;
<code>PreferencesView</code> doesn’t need a <code>UserPreferences</code> property; it can just distribute its values into the UI before it shows itself and gather them back in when it is done:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">PreferencesView</code> <code class="p">:</code> <code class="n">View</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">greetingPicker</code> <code class="p">=</code> <code class="n">GreetingPicker</code><code class="p">()</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">localePicker</code> <code class="p">=</code> <code class="n">LocalePicker</code><code class="p">()</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">currencyPicker</code> <code class="p">=</code> <code class="n">CurrencyPicker</code><code class="p">()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">showModal</code><code class="p">(</code><code class="n">preferences</code><code class="p">:</code> <code class="n">UserPreferences</code><code class="p">):</code> <code class="n">UserPreferences</code> <code class="p">{</code>&#13;
        <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">greeting</code>&#13;
        <code class="n">localePicker</code><code class="p">.</code><code class="n">locale</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">locale</code>&#13;
        <code class="n">currencyPicker</code><code class="p">.</code><code class="n">currency</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">currency</code>&#13;
        <code class="n">show</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">UserPreferences</code><code class="p">(</code>&#13;
            <code class="n">greeting</code> <code class="p">=</code> <code class="n">greetingPicker</code><code class="p">.</code><code class="n">greeting</code><code class="p">,</code>&#13;
            <code class="n">locale</code> <code class="p">=</code> <code class="n">localePicker</code><code class="p">.</code><code class="n">locale</code><code class="p">,</code>&#13;
            <code class="n">currency</code> <code class="p">=</code> <code class="n">currencyPicker</code><code class="p">.</code><code class="n">currency</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.11&amp;show=file">Example 5.11 [beans-to-values.7:src/main/java/travelator/mobile/PreferencesView.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>There is still mutation here, because we are setting values into the pickers, but these are UI components and only have default constructors, so this has to happen somewhere.&#13;
To finish the job, we also have to update <code>Application</code> to move the <code>preferences</code> argument from the <code>PreferencesView</code> constructor to <code>showModal</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Application</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">var</code> <code class="py">preferences</code><code class="p">:</code> <code class="n">UserPreferences</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">showWelcome</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">WelcomeView</code><code class="p">(</code><code class="n">preferences</code><code class="p">).</code><code class="n">show</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">editPreferences</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">preferences</code> <code class="p">=</code> <code class="n">PreferencesView</code><code class="p">().</code><code class="n">showModal</code><code class="p">(</code><code class="n">preferences</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=5.12&amp;show=file">Example 5.12 [beans-to-values.7:src/main/java/travelator/mobile/Application.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=5.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we have only one place that preferences can change, made clear by the assignment in <code>editPreferences</code>.&#13;
It is also clear that <code>showWelcome</code> can only read from the object.&#13;
It may seem a bit of a waste to create a new <code>UserPreferences</code> to return from <code>showModal</code> even if nothing has changed.&#13;
If you’re used to sharing mutable objects, it may even seem dangerous.&#13;
In the world of values, though, two <code>UserPreferences</code> with the same values are to almost all intents and purposes the same object (see <a data-type="xref" href="#object-equality">“Object Equality”</a>), and you would have to be in a very constrained environment to detect the extra allocation.<a data-primary="" data-startref="Mjbtov05" data-type="indexterm" id="idm46393405216456"/><a data-primary="" data-startref="Rjbtov05" data-type="indexterm" id="idm46393405215512"/><a data-primary="" data-startref="Vrefact05" data-type="indexterm" id="idm46393405214568"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393406416376">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>In this chapter we’ve seen some advantages of immutable values over mutable objects.&#13;
The refactoring example showed how to migrate mutation toward our application’s entry points and event handlers by replacing immutable references to mutable objects with mutable references to immutable objects.&#13;
The result is that less of our code has to deal with the consequences and complications of mutability.</p>&#13;
&#13;
<p>That said, JavaBeans were designed for use in user interface frameworks, and UIs are in many ways the last bastion of mutable objects.&#13;
If we had more exacting liveness requirements—for example, updating a <code>WelcomeView</code> when the greeting preference changed—we might prefer using shared objects with change events rather than using immutable values.</p>&#13;
&#13;
<p>Converting mutable objects to values and transformations is a repeating motif. <a data-type="xref" data-xrefstyle="chap-num-title" href="ch06.html#java-to-kotlin-collections">Chapter 6, <em>Java to Kotlin Collections</em></a>, continues the discussion with respect to collections. <a data-type="xref" data-xrefstyle="chap-num-title" href="ch14.html#accumulating-objects-to-transformations">Chapter 14, <em>Accumulating Objects to Transformations</em></a>, looks at how to translate code that uses accumulating parameters to use higher-order functions over collections instead.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>