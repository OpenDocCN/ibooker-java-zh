<html><head></head><body><section data-pdf-bookmark="Chapter 9. Accessing Data Reactively" data-type="chapter" epub:type="chapter"><div class="chapter" id="data">&#13;
<h1><span class="label">Chapter 9. </span>Accessing Data Reactively</h1>&#13;
&#13;
&#13;
<p><a data-primary="data access" data-type="indexterm" id="ix_data-adoc0"/>In <a data-type="xref" href="ch05.html#reactive-programming">Chapter 5</a>, we explained the scalability and robustness problems in the use of blocking I/O for applications.&#13;
This chapter focuses on interacting with databases&#13;
and how Quarkus ensures that the data layers of an application stack can be asynchronous&#13;
and utilize nonblocking I/O too.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Problem with Data Access" data-type="sect1"><div class="sect1" id="idm45358822916256">&#13;
<h1>The Problem with Data Access</h1>&#13;
&#13;
<p><a data-primary="blocking I/Os" data-secondary="data access and" data-type="indexterm" id="ix_data-adoc1"/><a data-primary="data access" data-secondary="blocking I/O problems" data-type="indexterm" id="ix_data-adoc2"/>Accessing relational data previously involved blocking I/O while communicating with a database.&#13;
As already discussed in <a data-type="xref" href="ch05.html#reactive-programming">Chapter 5</a>,&#13;
we want to avoid blocking I/O in our applications, at any level of the stack.&#13;
Interacting with a database often takes a non-trivial amount of time to complete,&#13;
depending on the number of records involved,&#13;
creating an even larger impact on our application with blocking I/O to access a database! What do we mean by this?&#13;
Let’s say we’ve developed a small database application;&#13;
we’ve all developed many of those over the years.&#13;
We often refer to them as <em>CRUD</em> applications because they provide create,&#13;
read, update, and delete operations for records in a database.</p>&#13;
&#13;
<p>Every exposed endpoint in our API needs to interact with the database.&#13;
We will ignore caches and how they reduce the number of requests made to a database in certain situations.&#13;
With each endpoint method calling the database,&#13;
every execution performs blocking I/O,&#13;
reducing concurrency.</p>&#13;
&#13;
<p>Why are we forced to use blocking I/O when interacting with databases?&#13;
APIs for interacting with databases,&#13;
such as Open Database Connectivity (ODBC) and Java Database Connectivity (JDBC),&#13;
were designed with a synchronous and blocking approach.&#13;
The Java Persistence API (JPA), which came many years later,&#13;
though coalescing the object-relational mapping (ORM) landscape around a common API,&#13;
was still designed on the existing synchronous and blocking behavior of JDBC.</p>&#13;
&#13;
<p>Without a reactive programming approach to data access,&#13;
the entirety of an application stack can never be truly reactive.&#13;
An application could be reactive only up to a point.&#13;
Though still beneficial,&#13;
concurrency and throughput are still prevented from reaching their full potential concurrency.</p>&#13;
&#13;
<p>That’s a lot of words explaining how database access with JDBC and JPA is not reactive,&#13;
and therefore blocking,&#13;
but what does that access look like?&#13;
As you saw in <a data-type="xref" href="ch06.html#quarkus-reactive::imperative-model">“The Imperative Model”</a> with application logic,&#13;
it’s a similar problem for the database interaction, as illustrated in <a data-type="xref" href="#image:database-blocking-client">Figure 9-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="image:database-blocking-client">&#13;
<img alt="Blocking database client" src="assets/rsij_0901.png"/>&#13;
<h6><span class="label">Figure 9-1. </span>Blocking database client</h6>&#13;
</div></figure>&#13;
&#13;
<p>When we’re communicating with a database over JDBC, or the higher abstraction JPA,&#13;
the JDBC driver uses a request-and-response interaction.&#13;
However, as shown in <a data-type="xref" href="#image:database-blocking-client">Figure 9-1</a>,&#13;
the <a data-primary="threads" data-secondary="data access and" data-type="indexterm" id="idm45358822902128"/>JDBC driver blocks the thread until any response is received.&#13;
This blocking approach occupies an entire thread for each database interaction.&#13;
Depending on how you’ve configured database connection pooling,&#13;
it’s possible to run out of threads for an application before reaching the maximum number of database &#13;
<span class="keep-together">connections</span>.</p>&#13;
&#13;
<p>When dealing with a large number of database records to search or retrieve,&#13;
and network latency between our application and the database, a problem with thread starvation or resource utilization will likely occur.<a data-startref="ix_data-adoc2" data-type="indexterm" id="idm45358822899360"/><a data-startref="ix_data-adoc1" data-type="indexterm" id="idm45358822898656"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Nonblocking Interactions with Relational Databases" data-type="sect1"><div class="sect1" id="idm45358822897856">&#13;
<h1>Nonblocking Interactions with Relational Databases</h1>&#13;
&#13;
<p><a data-primary="data access" data-secondary="nonblocking interactions with relational databases" data-type="indexterm" id="idm45358822896512"/><a data-primary="nonblocking I/O" data-secondary="interactions with relational databases" data-type="indexterm" id="idm45358822895440"/><a data-primary="relational databases, nonblocking interactions with" data-type="indexterm" id="idm45358822894480"/>With recent work by various projects,&#13;
such as <a href="https://oreil.ly/GSE6G">Vert.x client APIs</a>&#13;
for PostgreSQL, MySQL, IBM Db2, Oracle, and Microsoft SQL Server,&#13;
Java applications are now able to interact with databases in an asynchronous manner with nonblocking I/O.</p>&#13;
&#13;
<p>How are things different with these new clients compared to JDBC? When using nonblocking database clients, we’re able to avoid a blocked thread, as shown in <a data-type="xref" href="#image:database-non-blocking-client">Figure 9-2</a>.</p>&#13;
&#13;
<figure><div class="figure" id="image:database-non-blocking-client">&#13;
<img alt="Nonblocking database client" src="assets/rsij_0902.png"/>&#13;
<h6><span class="label">Figure 9-2. </span>Nonblocking database client</h6>&#13;
</div></figure>&#13;
&#13;
<p>In addition, it’s now possible for the database client, instead of a worker, to execute on the I/O thread.&#13;
Now we have a compounded benefit of using these new nonblocking clients: reducing the number of worker threads an application might need, as database communication with these&#13;
new clients can occur on the same thread as any reactive application code!</p>&#13;
&#13;
<p>In <a data-type="xref" href="#image:database-non-blocking-client">Figure 9-2</a>,&#13;
we see a single database connection being used for the database client to communicate.&#13;
However, when a client API and database supports it,&#13;
we can utilize pipelining to share a single database connection for several requests. <a data-type="xref" href="#image:database-non-blocking-client-pipelining">Figure 9-3</a> shows how pipelining in the database client works.</p>&#13;
&#13;
<figure><div class="figure" id="image:database-non-blocking-client-pipelining">&#13;
<img alt="Nonblocking database client with pipelining" src="assets/rsij_0903.png"/>&#13;
<h6><span class="label">Figure 9-3. </span>Nonblocking database client with pipelining</h6>&#13;
</div></figure>&#13;
&#13;
<p>Each color in <a data-type="xref" href="#image:database-non-blocking-client-pipelining">Figure 9-3</a> is a separate database request.&#13;
Though we have different reactive handlers calling the database,&#13;
the database client is able to utilize a single connection to the database instead of, in this case, three.&#13;
We want to take advantage of nonblocking advancements such as this whenever we can,&#13;
to squeeze more and more out of the same amount of resources for an application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using a Reactive ORM: Hibernate Reactive" data-type="sect1"><div class="sect1" id="idm45358822882144">&#13;
<h1>Using a Reactive ORM: Hibernate Reactive</h1>&#13;
&#13;
<p><a data-primary="data access" data-secondary="Hibernate ORM and" data-type="indexterm" id="ix_data-adoc3"/><a data-primary="Hibernate Reactive" data-type="indexterm" id="ix_data-adoc4"/><a data-primary="object-relational mapping (ORM)" data-type="indexterm" id="ix_data-adoc5"/><a data-primary="ORM (object-relational mapping)" data-type="indexterm" id="ix_data-adoc6"/><a data-primary="reactive ORM" data-type="indexterm" id="ix_data-adoc7"/><em>Hibernate ORM</em> enables developers to more easily write applications whose data outlives the application process.&#13;
As an ORM framework, Hibernate is concerned with data persistence as it applies to relational databases.&#13;
Hibernate provides both imperative and reactive APIs.</p>&#13;
&#13;
<p>These APIs support two facets: nonblocking database clients, covered in the previous section,&#13;
and reactive programming as a means of interacting with relational databases.&#13;
Most of the existing Hibernate internals are still utilized,&#13;
but Hibernate Reactive introduces a new layer for utilizing reactive and nonblocking APIs to communicate with database clients.&#13;
The reactive APIs work in concert with JPA annotations, Hibernate annotations, and Bean Validation as well.</p>&#13;
&#13;
<p>It’s time to dive in and use Hibernate with reactive APIs!&#13;
With Quarkus, Hibernate Reactive is even better,&#13;
because <a data-primary="Panache" data-type="indexterm" id="ix_data-adoc8"/>we have the option to use Hibernate Reactive with <em>Panache</em>.&#13;
This thin layer simplifies the use of the Hibernate ORM.&#13;
It provides two models.&#13;
Your entities can be managed as active records, as the entity class provides methods to retrieve, update, and query instances of that entity class.&#13;
You can also use a repository model, in which a repository class provides these functions, keeping the entity structure <em>pure</em>.&#13;
See the <em>chapter-9/hibernate-reactive</em> directory for all Hibernate Reactive project code.&#13;
First we need the dependency for Hibernate Reactive (<a data-type="xref" href="#data::dep">Example 9-1</a>).</p>&#13;
<div data-type="example" id="data::dep">&#13;
<h5><span class="label">Example 9-1. </span>Hibernate Reactive dependency (<em>chapter-9/hibernate-reactive/pom.xml</em>)</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-hibernate-reactive-panache<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p>Notice we used the Panache version of Hibernate Reactive.&#13;
If we didn’t want to use Panache,&#13;
we could have used the <code>quarkus-hibernate-reactive</code> dependency instead.&#13;
As mentioned previously,&#13;
we need a reactive database client too.&#13;
For this example, we will use the PostgreSQL client (<a data-type="xref" href="#data::dep-pg">Example 9-2</a>).</p>&#13;
<div data-type="example" id="data::dep-pg">&#13;
<h5><span class="label">Example 9-2. </span>PostgreSQL database client dependency (<em>chapter-9/hibernate-reactive/pom.xml</em>)</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-reactive-pg-client<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p><a data-primary="Dev Services" data-type="indexterm" id="idm45358822856160"/>With <a href="https://oreil.ly/eKY8W">Dev Services</a>, a Quarkus feature starting the required pieces of infrastructure automatically,&#13;
we don’t need the Docker Maven plug-in to start a database for running tests.&#13;
Quarkus will automatically start the database for us!&#13;
To take advantage of Dev Services, we need a database driver, which we just added in <a data-type="xref" href="#data::dep-pg">Example 9-2</a>,&#13;
and to set <code>db.kind</code> for informing Quarkus of the database type being used.&#13;
Let’s set that up now in <code>application.properties</code> (<a data-type="xref" href="#data::config-pg">Example 9-3</a>).</p>&#13;
<div data-type="example" id="data::config-pg">&#13;
<h5><span class="label">Example 9-3. </span>PostgreSQL database client config (<em>chapter-9/hibernate-reactive/src/main/resources/application.properties</em>)</h5>&#13;
&#13;
<pre data-code-language="properties" data-type="programlisting"><code class="na">quarkus.datasource.db-kind</code><code class="o">=</code><code class="s">postgresql</code>&#13;
<code class="na">%prod.quarkus.datasource.username</code><code class="o">=</code><code class="s">quarkus_test</code>&#13;
<code class="na">%prod.quarkus.datasource.password</code><code class="o">=</code><code class="s">quarkus_test</code>&#13;
<code class="na">%prod.quarkus.datasource.reactive.url</code><code class="o">=</code><code class="s">vertx-reactive:postgresql://</code>&#13;
    <code class="err">localhost/quarkus_test</code></pre></div>&#13;
&#13;
<p>With Dev Services,&#13;
all the properties except <code>db.kind</code> are specified with the <code>prod</code> configuration profile.&#13;
We could also remove the properties from the <code>prod</code> profile completely,&#13;
preferring to set them with environment variables, or a ConfigMap in Kubernetes.</p>&#13;
&#13;
<p>We have a <code>Customer</code> entity that extends <code>PanacheEntity</code>.&#13;
We won’t cover <code>Customer</code> in detail here,&#13;
as it utilizes the usual annotations from JPA, Bean Validation, and Hibernate Validator.&#13;
The full source can be viewed at <em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/Customer</em>.</p>&#13;
&#13;
<p>Let’s take a look at the implementation of a CRUD application using Hibernate Reactive and RESTEasy Reactive to expose a REST API.&#13;
First up is a method to retrieve all customers from the database (<a data-type="xref" href="#data::retrieve-cust">Example 9-4</a>).</p>&#13;
<div data-type="example" id="data::retrieve-cust">&#13;
<h5><span class="label">Example 9-4. </span>Retrieve all customers (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Customer</code><code class="o">&gt;</code> <code class="nf">findAll</code><code class="o">()</code> <code class="o">{</code>&#13;
  <code class="k">return</code> <code class="n">Customer</code><code class="o">.</code><code class="na">streamAll</code><code class="o">(</code><code class="n">Sort</code><code class="o">.</code><code class="na">by</code><code class="o">(</code><code class="s">"name"</code><code class="o">));</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>We use <code>streamAll</code> on <code>Customer</code>, from Panache, to retrieve all instances into <code>Multi</code>.&#13;
Each customer can have orders associated with them,&#13;
and when we retrieve a single customer, we also want to retrieve their orders.&#13;
Though we have a single application,&#13;
we will consider the orders to be coming from an external service.</p>&#13;
&#13;
<p>First we define <code>Uni</code> to retrieve <code>Customer</code> and throw an exception if one was not found, as shown in <a data-type="xref" href="#data::find-customer">Example 9-5</a>.</p>&#13;
<div data-type="example" id="data::find-customer">&#13;
<h5><span class="label">Example 9-5. </span>Find a customer (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">Customer</code><code class="o">&gt;</code> <code class="n">customerUni</code> <code class="o">=</code> <code class="n">Customer</code><code class="o">.&lt;</code><code class="n">Customer</code><code class="o">&gt;</code><code class="n">findById</code><code class="o">(</code><code class="n">id</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">ifNull</code><code class="o">().</code><code class="na">failWith</code><code class="o">(</code>&#13;
        <code class="k">new</code> <code class="nf">WebApplicationException</code><code class="o">(</code><code class="s">"Failed to find customer"</code><code class="o">,</code>&#13;
        <code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">NOT_FOUND</code><code class="o">)</code>&#13;
    <code class="o">);</code></pre></div>&#13;
&#13;
<p>Next the orders of a customer are retrieved as a <code>List</code> into a separate <code>Uni</code> (see <a data-type="xref" href="#data::retrieve-orders">Example 9-6</a>).</p>&#13;
<div data-type="example" id="data::retrieve-orders">&#13;
<h5><span class="label">Example 9-6. </span>Retrieve customer orders (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;&gt;</code> <code class="n">customerOrdersUni</code> <code class="o">=</code> <code class="n">orderService</code><code class="o">.</code><code class="na">getOrdersForCustomer</code><code class="o">(</code><code class="n">id</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>Lastly, the two are combined by a mapper, taking the results of each <code>Uni</code> to set the orders on the customer.&#13;
The resulting <code>Uni</code> is transformed into a JAX-RS <code>Response</code> to complete the endpoint execution (<a data-type="xref" href="#data::combine-customer-orders">Example 9-7</a>).</p>&#13;
<div data-type="example" id="data::combine-customer-orders">&#13;
<h5><span class="label">Example 9-7. </span>Combine <code>customer</code> and <code>orders</code> (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">combine</code><code class="o">()</code>&#13;
    <code class="o">.</code><code class="na">all</code><code class="o">().</code><code class="na">unis</code><code class="o">(</code><code class="n">customerUni</code><code class="o">,</code> <code class="n">customerOrdersUni</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">combinedWith</code><code class="o">((</code><code class="n">customer</code><code class="o">,</code> <code class="n">orders</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
      <code class="n">customer</code><code class="o">.</code><code class="na">orders</code> <code class="o">=</code> <code class="n">orders</code><code class="o">;</code>&#13;
      <code class="k">return</code> <code class="n">customer</code><code class="o">;</code>&#13;
    <code class="o">})</code>&#13;
    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">customer</code> <code class="o">-&gt;</code> <code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">(</code><code class="n">customer</code><code class="o">).</code><code class="na">build</code><code class="o">());</code></pre></div>&#13;
&#13;
<p>So far, everything we’ve done hasn’t required a transaction,&#13;
as we’ve only been reading database records.&#13;
<a data-type="xref" href="#data::create-customer">Example 9-8</a> shows how we can use transactions to store a new &#13;
<span class="keep-together">customer</span>.</p>&#13;
<div data-type="example" id="data::create-customer">&#13;
<h5><span class="label">Example 9-8. </span>Create a customer (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">return</code> <code class="n">Panache</code>&#13;
    <code class="o">.</code><code class="na">withTransaction</code><code class="o">(</code><code class="nl">customer:</code><code class="o">:</code><code class="n">persist</code><code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">replaceWith</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">(</code><code class="n">customer</code><code class="o">).</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">CREATED</code><code class="o">).</code><code class="na">build</code><code class="o">());</code></pre></div>&#13;
&#13;
<p>We use <code>Panache.withTransaction</code> to inform Panache that we want a transaction to wrap the&#13;
<code>Uni</code> <code>Supplier</code> we pass into it.&#13;
In this instance,&#13;
we use <code>customer.persist</code> as the code to be wrapped with a transaction.&#13;
Though <code>Uni&lt;Void&gt;</code> is returned on success,&#13;
we can use <code>replaceWith</code> to create the necessary <code>Uni&lt;Response&gt;</code>.</p>&#13;
&#13;
<p>Next we use <code>withTransaction</code> to update the customer name.&#13;
First we retrieve a customer by ID. Then, when we receive an item that is not <code>null</code>, we <code>invoke</code> a runnable to update the name on the retrieved entity (<a data-type="xref" href="#data::update-customer">Example 9-9</a>).</p>&#13;
<div data-type="example" id="data::update-customer">&#13;
<h5><span class="label">Example 9-9. </span>Update a customer (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">return</code> <code class="n">Panache</code>&#13;
    <code class="o">.</code><code class="na">withTransaction</code><code class="o">(</code>&#13;
        <code class="o">()</code> <code class="o">-&gt;</code> <code class="n">Customer</code><code class="o">.&lt;</code><code class="n">Customer</code><code class="o">&gt;</code><code class="n">findById</code><code class="o">(</code><code class="n">id</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">ifNotNull</code><code class="o">().</code><code class="na">invoke</code><code class="o">(</code><code class="n">entity</code> <code class="o">-&gt;</code> <code class="n">entity</code><code class="o">.</code><code class="na">name</code> <code class="o">=</code> <code class="n">customer</code><code class="o">.</code><code class="na">name</code><code class="o">)</code>&#13;
    <code class="o">)</code></pre></div>&#13;
&#13;
<p>We then utilize <code>onItem</code> to generate an outcome of a successful response or return&#13;
a <code>not found</code> response if the item is <code>null</code>.</p>&#13;
&#13;
<p>The last method we need for a CRUD application with Hibernate Reactive provides the ability to delete a customer.&#13;
Again we use <code>withTransaction</code>, passing it the Panache method to delete a customer by its ID.&#13;
Deleting an entity returns <code>Uni&lt;Boolean&gt;</code>. We need to use <code>map</code> to convert it to a JAX-RS response&#13;
based on its success (<a data-type="xref" href="#data::delete-customer">Example 9-10</a>).</p>&#13;
<div data-type="example" id="data::delete-customer">&#13;
<h5><span class="label">Example 9-10. </span>Delete a customer (<em>chapter-9/hibernate-reactive/src/main/java/org/acme/data/CustomerResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">return</code> <code class="n">Panache</code>&#13;
    <code class="o">.</code><code class="na">withTransaction</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">Customer</code><code class="o">.</code><code class="na">deleteById</code><code class="o">(</code><code class="n">id</code><code class="o">))</code>&#13;
    <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">deleted</code> <code class="o">-&gt;</code> <code class="n">deleted</code>&#13;
        <code class="o">?</code> <code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">().</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">NO_CONTENT</code><code class="o">).</code><code class="na">build</code><code class="o">()</code>&#13;
        <code class="o">:</code> <code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">().</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">NOT_FOUND</code><code class="o">).</code><code class="na">build</code><code class="o">());</code></pre></div>&#13;
&#13;
<p>You’ve now seen how to create, retrieve, update, and delete entities with Panache and Hibernate Reactive!<a data-startref="ix_data-adoc8" data-type="indexterm" id="idm45358822393280"/>&#13;
To see how the endpoints can be tested,&#13;
take a look at <em>/chapter-9/hibernate-reactive/src/test/java/org/acme/data/CustomerEndpointTest</em> in the book’s code examples.<a data-startref="ix_data-adoc7" data-type="indexterm" id="idm45358822315440"/><a data-startref="ix_data-adoc6" data-type="indexterm" id="idm45358822314832"/><a data-startref="ix_data-adoc5" data-type="indexterm" id="idm45358822314224"/><a data-startref="ix_data-adoc4" data-type="indexterm" id="idm45358822313552"/><a data-startref="ix_data-adoc3" data-type="indexterm" id="idm45358822312880"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What About NoSQL?" data-type="sect1"><div class="sect1" id="idm45358822881232">&#13;
<h1>What About NoSQL?</h1>&#13;
&#13;
<p><a data-primary="data access" data-secondary="NoSQL" data-type="indexterm" id="ix_data-adoc9"/><a data-primary="NoSQL databases" data-type="indexterm" id="ix_data-adoc10"/>We’ve shown how we can have reactive APIs with a traditional ORM such as Hibernate,&#13;
but what about NoSQL?&#13;
Are we able to take advantage of reactive APIs when an application needs a NoSQL database instead of a relational one?&#13;
Yes, we can!</p>&#13;
&#13;
<p>Quarkus has several extensions for communicating with NoSQL databases,&#13;
including MongoDB, Redis, and Apache Cassandra.&#13;
Do all these extensions support reactive APIs?&#13;
Currently, the MongoDB, Redis, and Cassandra clients have support for reactive APIs.</p>&#13;
&#13;
<p>In the next section, we will develop a CRUD application with the same functionality as the Hibernate Reactive&#13;
example in the previous section.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Interacting with Redis" data-type="sect1"><div class="sect1" id="idm45358822307376">&#13;
<h1>Interacting with Redis</h1>&#13;
&#13;
<p><a data-primary="data access" data-secondary="interacting with Redis" data-type="indexterm" id="ix_data-adoc11"/><a data-primary="Redis" data-type="indexterm" id="ix_data-adoc12"/>Let’s develop a customer CRUD application with Redis!&#13;
For this example,&#13;
we will extract interactions into a separate service we can inject into a REST resource.&#13;
Check out <em>/chapter-9/redis/src/main/java/org/acme/data/CustomerResource</em> in the code examples to see&#13;
how the service is used.</p>&#13;
&#13;
<p>First we need the Redis client dependency for the project; see <a data-type="xref" href="#data::redis-client-dep">Example 9-11</a>.</p>&#13;
<div data-type="example" id="data::redis-client-dep">&#13;
<h5><span class="label">Example 9-11. </span>Redis client dependency (<em>chapter-9/redis/pom.xml</em>)</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-redis-client<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p>As we did with the Hibernate Reactive example,&#13;
we will utilize <code>docker-maven-plugin</code> to run a Redis container for test execution.&#13;
Check out <em>chapter-9/redis/pom.xml</em> in the book source for the details.</p>&#13;
&#13;
<p>Next we configure the Redis client as to where the host of the server is located.&#13;
Include the config in <a data-type="xref" href="#data::redis-client-config">Example 9-12</a> in <code>application.properties</code>.</p>&#13;
<div data-type="example" id="data::redis-client-config">&#13;
<h5><span class="label">Example 9-12. </span>Redis client config (<em>chapter-9/redis/src/main/resources/application.properties</em>)</h5>&#13;
&#13;
<pre data-code-language="properties" data-type="programlisting"><code class="na">quarkus.redis.hosts</code><code class="o">=</code><code class="s">redis://localhost:6379</code></pre></div>&#13;
&#13;
<p>To be able to use the Redis client, we need to <code>@Inject</code> it, as shown in <a data-type="xref" href="#data::inject-redis-client">Example 9-13</a>.</p>&#13;
<div data-type="example" id="data::inject-redis-client">&#13;
<h5><span class="label">Example 9-13. </span>Inject Redis client (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Inject</code>&#13;
<code class="n">ReactiveRedisClient</code> <code class="n">reactiveRedisClient</code><code class="o">;</code></pre></div>&#13;
&#13;
<p>So we don’t create an unintentional key clash in Redis,&#13;
we will prefix a customer ID, as shown in <a data-type="xref" href="#data::key-prefix">Example 9-14</a>.</p>&#13;
<div data-type="example" id="data::key-prefix">&#13;
<h5><span class="label">Example 9-14. </span>Key prefix (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">CUSTOMER_HASH_PREFIX</code> <code class="o">=</code> <code class="s">"cust:"</code><code class="o">;</code></pre></div>&#13;
&#13;
<p>Let’s start out with retrieving a list of all the customers from Redis (<a data-type="xref" href="#data::retrieve-all-customers">Example 9-15</a>).</p>&#13;
<div data-type="example" id="data::retrieve-all-customers">&#13;
<h5><span class="label">Example 9-15. </span>Retrieve all customers (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Customer</code><code class="o">&gt;</code> <code class="nf">allCustomers</code><code class="o">()</code> <code class="o">{</code>&#13;
  <code class="k">return</code> <code class="n">reactiveRedisClient</code><code class="o">.</code><code class="na">keys</code><code class="o">(</code><code class="s">"*"</code><code class="o">)</code>&#13;
      <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMulti</code><code class="o">(</code><code class="n">response</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">iterable</code><code class="o">(</code><code class="n">response</code><code class="o">).</code><code class="na">map</code><code class="o">(</code><code class="nl">Response:</code><code class="o">:</code><code class="n">toString</code><code class="o">);</code>&#13;
      <code class="o">})</code>&#13;
      <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToUniAndMerge</code><code class="o">(</code><code class="n">key</code> <code class="o">-&gt;</code>&#13;
          <code class="n">reactiveRedisClient</code><code class="o">.</code><code class="na">hgetall</code><code class="o">(</code><code class="n">key</code><code class="o">)</code>&#13;
              <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">resp</code> <code class="o">-&gt;</code>&#13;
                  <code class="n">constructCustomer</code><code class="o">(</code>&#13;
                      <code class="n">Long</code><code class="o">.</code><code class="na">parseLong</code><code class="o">(</code>&#13;
                          <code class="n">key</code><code class="o">.</code><code class="na">substring</code><code class="o">(</code><code class="n">CUSTOMER_HASH_PREFIX</code><code class="o">.</code><code class="na">length</code><code class="o">())),</code>&#13;
                      <code class="n">resp</code><code class="o">)</code>&#13;
              <code class="o">)</code>&#13;
      <code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><code>ReactiveRedisClient</code> provides an API aligned with the commands available with Redis,&#13;
making it easier to use in Java if you are already familiar with using Redis commands.&#13;
In <a data-type="xref" href="#data::retrieve-all-customers">Example 9-15</a>, we use <code>keys</code> with a wildcard to retrieve all keys,&#13;
which returns <code>Uni&lt;Response&gt;</code>.&#13;
This particular <code>Response</code> class represents the response from Redis.</p>&#13;
&#13;
<p>On receiving the response (the item) from Redis, we use <code>transformToMulti</code> to separate the single response into individual keys.&#13;
In the lambda, we create a <code>Multi</code> of string keys from the response directly,&#13;
as it’s an <code>Iterable</code>,&#13;
and map the value to the string of the key.&#13;
The result of the execution is <code>Multi&lt;String&gt;</code>.</p>&#13;
&#13;
<p>We’re not done just yet; we need to convert the stream of keys into a stream of customers.&#13;
Reading the code provides a good idea of what happens.&#13;
Starting with <code>Multi&lt;String&gt;</code>,&#13;
on each item produced we call <code>transformToUniAndMerge</code>.&#13;
We use their key, or item, with the Redis client to retrieve all the fields and values matching the key,&#13;
or hash.&#13;
The response from <code>hgetall</code> is mapped to a <code>Customer</code> instance using <code>constructCustomer</code>.&#13;
Finally, the customer <code>Uni</code>s instances are merged into a <code>Multi</code> for returning.</p>&#13;
&#13;
<p>To retrieve a single customer,&#13;
we call <code>hgetall</code> and, depending on the size of the response, either return <code>null</code> or use <code>constructCustomer</code> to create a customer (<a data-type="xref" href="#data::retrieve-customer">Example 9-16</a>).&#13;
We need to check the size of the response to find out whether any fields and values were returned.&#13;
If the size is zero,&#13;
the response was empty because the key could not be found.</p>&#13;
<div data-type="example" id="data::retrieve-customer">&#13;
<h5><span class="label">Example 9-16. </span>Retrieve customer (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Customer</code><code class="o">&gt;</code> <code class="nf">getCustomer</code><code class="o">(</code><code class="n">Long</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">return</code> <code class="n">reactiveRedisClient</code><code class="o">.</code><code class="na">hgetall</code><code class="o">(</code><code class="n">CUSTOMER_HASH_PREFIX</code> <code class="o">+</code> <code class="n">id</code><code class="o">)</code>&#13;
      <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">resp</code> <code class="o">-&gt;</code> <code class="n">resp</code><code class="o">.</code><code class="na">size</code><code class="o">()</code> <code class="o">&gt;</code> <code class="mi">0</code>&#13;
          <code class="o">?</code> <code class="n">constructCustomer</code><code class="o">(</code><code class="n">id</code><code class="o">,</code> <code class="n">resp</code><code class="o">)</code>&#13;
          <code class="o">:</code> <code class="kc">null</code>&#13;
      <code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>To store a customer record into Redis,&#13;
we use <code>hmset</code> to store multiple fields and values for a single key.&#13;
From a Redis perspective,&#13;
it doesn’t matter whether we’re storing a new customer&#13;
or updating an existing one; we use <code>hmset</code> for both.&#13;
We should split the behavior into a separate method to reuse it in both places, as shown in <a data-type="xref" href="#data::store-customer">Example 9-17</a>.</p>&#13;
<div data-type="example" id="data::store-customer">&#13;
<h5><span class="label">Example 9-17. </span>Store customer (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">return</code> <code class="n">reactiveRedisClient</code><code class="o">.</code><code class="na">hmset</code><code class="o">(</code>&#13;
    <code class="n">Arrays</code><code class="o">.</code><code class="na">asList</code><code class="o">(</code><code class="n">CUSTOMER_HASH_PREFIX</code> <code class="o">+</code> <code class="n">customer</code><code class="o">.</code><code class="na">id</code><code class="o">,</code> <code class="s">"name"</code><code class="o">,</code> <code class="n">customer</code><code class="o">.</code><code class="na">name</code><code class="o">)</code>&#13;
<code class="o">)</code>&#13;
    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">resp</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
      <code class="k">if</code> <code class="o">(</code><code class="n">resp</code><code class="o">.</code><code class="na">toString</code><code class="o">().</code><code class="na">equals</code><code class="o">(</code><code class="s">"OK"</code><code class="o">))</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">customer</code><code class="o">;</code>&#13;
      <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
        <code class="k">throw</code> <code class="k">new</code> <code class="nf">NoSuchElementException</code><code class="o">();</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">});</code></pre></div>&#13;
&#13;
<p>Using <code>hmset</code>, we need to ensure that an odd number of arguments are passed to it.&#13;
The first argument is the hash for the record,&#13;
followed by matching pairs of field and value for as many fields to be set.&#13;
We get a simple reply of <code>OK</code> if it succeeds,&#13;
using <code>transform</code> to return the customer on success or throw an exception.</p>&#13;
&#13;
<p>With <code>storeCustomer</code> in place, let’s look at <code>createCustomer</code>; see <a data-type="xref" href="#data::create-customer-2">Example 9-18</a>.</p>&#13;
<div data-type="example" id="data::create-customer-2">&#13;
<h5><span class="label">Example 9-18. </span>Create customer (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Customer</code><code class="o">&gt;</code> <code class="nf">createCustomer</code><code class="o">(</code><code class="n">Customer</code> <code class="n">customer</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">return</code> <code class="nf">storeCustomer</code><code class="o">(</code><code class="n">customer</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>We have a nice clean method for <code>createCustomer</code> for responding with <code>Uni&lt;Customer&gt;</code>!&#13;
There wasn’t much to that one,&#13;
so let’s look at <code>updateCustomer</code> in <a data-type="xref" href="#data::update-customer-2">Example 9-19</a>.</p>&#13;
<div data-type="example" id="data::update-customer-2">&#13;
<h5><span class="label">Example 9-19. </span>Update customer (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Customer</code><code class="o">&gt;</code> <code class="nf">updateCustomer</code><code class="o">(</code><code class="n">Customer</code> <code class="n">customer</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">return</code> <code class="nf">getCustomer</code><code class="o">(</code><code class="n">customer</code><code class="o">.</code><code class="na">id</code><code class="o">)</code>&#13;
      <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToUni</code><code class="o">((</code><code class="n">cust</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">cust</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
          <code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">failure</code><code class="o">(</code><code class="k">new</code> <code class="n">NotFoundException</code><code class="o">());</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">cust</code><code class="o">.</code><code class="na">name</code> <code class="o">=</code> <code class="n">customer</code><code class="o">.</code><code class="na">name</code><code class="o">;</code>&#13;
        <code class="k">return</code> <code class="nf">storeCustomer</code><code class="o">(</code><code class="n">cust</code><code class="o">);</code>&#13;
      <code class="o">});</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>First we reuse <code>getCustomer</code> from the service to retrieve the existing customer from Redis.&#13;
When an item is returned from <code>getCustomer</code>,&#13;
we transform it into another <code>Uni</code> with a mapper.&#13;
The mapper first checks whether the item we received, the customer,&#13;
is null, returning a <code>Uni</code> failure containing an exception if it is.&#13;
Then we set the new name onto the customer before calling <code>storeCustomer</code>,&#13;
creating the <code>Uni</code> the mapper returns.</p>&#13;
&#13;
<p>Lastly, we need a way to delete a customer.&#13;
For this, we use <code>hdel</code> on the Redis client,&#13;
which returns the number of removed fields or <code>0</code> if the key could not be found (<a data-type="xref" href="#data::delete-customer-2">Example 9-20</a>).&#13;
We map <code>Uni&lt;Response&gt;</code> to <code>Uni&lt;Boolean&gt;</code>,&#13;
checking whether one field was removed (in this case, the customer name) to return <code>true</code>, or <code>null</code> if there were no responses.&#13;
On the produced item, we fail with <code>NotFoundException</code> if the item is <code>null</code>,&#13;
or succeed and transform the item into a null item.</p>&#13;
<div data-type="example" id="data::delete-customer-2">&#13;
<h5><span class="label">Example 9-20. </span>Delete a customer (<em>chapter-9/redis/src/main/java/org/acme/data/CustomerService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">deleteCustomer</code><code class="o">(</code><code class="n">Long</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="k">return</code> <code class="n">reactiveRedisClient</code><code class="o">.</code><code class="na">hdel</code><code class="o">(</code><code class="n">Arrays</code><code class="o">.</code><code class="na">asList</code><code class="o">(</code><code class="n">CUSTOMER_HASH_PREFIX</code> <code class="o">+</code> <code class="n">id</code><code class="o">,</code> <code class="s">"name"</code><code class="o">))</code>&#13;
      <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">resp</code> <code class="o">-&gt;</code> <code class="n">resp</code><code class="o">.</code><code class="na">toInteger</code><code class="o">()</code> <code class="o">==</code> <code class="mi">1</code> <code class="o">?</code> <code class="kc">true</code> <code class="o">:</code> <code class="kc">null</code><code class="o">)</code>&#13;
      <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">ifNull</code><code class="o">().</code><code class="na">failWith</code><code class="o">(</code><code class="k">new</code> <code class="n">NotFoundException</code><code class="o">())</code>&#13;
      <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">ifNotNull</code><code class="o">().</code><code class="na">transformToUni</code><code class="o">(</code><code class="n">r</code> <code class="o">-&gt;</code> <code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">nullItem</code><code class="o">());</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>This section gave a brief look into utilizing some methods of the reactive client for Redis.&#13;
There are many more methods we didn’t cover,&#13;
but this section provided guidance on how they can be generally used<a data-startref="ix_data-adoc12" data-type="indexterm" id="idm45358821733936"/><a data-startref="ix_data-adoc11" data-type="indexterm" id="idm45358821733328"/>.<a data-startref="ix_data-adoc10" data-type="indexterm" id="idm45358821627232"/><a data-startref="ix_data-adoc9" data-type="indexterm" id="idm45358821626528"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data-Related Events and Change Data Capture" data-type="sect1"><div class="sect1" id="idm45358822306432">&#13;
<h1>Data-Related Events and Change Data Capture</h1>&#13;
&#13;
<p><a data-primary="CDC (change data capture)" data-type="indexterm" id="ix_data-adoc13"/><a data-primary="data access" data-secondary="data-related events and change data capture" data-type="indexterm" id="ix_data-adoc14"/><em>Change data capture</em>, or <em>CDC</em>,&#13;
is an integration pattern for extracting events from sources that don’t typically operate with events and messaging,&#13;
such as databases.&#13;
CDC has many benefits, including being able to produce change events from a legacy application without modifying the application.</p>&#13;
&#13;
<p>Another benefit is that CDC doesn’t care about the languages an application is developed in,&#13;
as it interacts with the database.&#13;
This approach can greatly simplify the effort to produce a consistent-looking change event from a database&#13;
that has polyglot applications writing to it.&#13;
Having to update possibly dozens of applications written in &#13;
<span class="keep-together">different</span> languages to produce a consistent-looking&#13;
change event from them all can be challenging and time-consuming.</p>&#13;
&#13;
<p>Writing to a database involves transactions,&#13;
or usually should,&#13;
and poses an additional complexity when also writing an event to a messaging system. In <a data-type="xref" href="#image:database-message-transaction">Figure 9-4</a>, we need to make sure that if either the database update fails or producing a message fails,&#13;
everything rolls back and undoes any changes.</p>&#13;
&#13;
<figure><div class="figure" id="image:database-message-transaction">&#13;
<img alt="Writing to a database and message broker" src="assets/rsij_0904.png"/>&#13;
<h6><span class="label">Figure 9-4. </span>Writing to a database and message broker</h6>&#13;
</div></figure>&#13;
&#13;
<p>Such a situation can be particularly complex when transaction rollback can occur outside our application code because of a failure to return an HTTP response, for instance.&#13;
With CDC, this concern goes away because we worry only about writing to the database itself.</p>&#13;
&#13;
<p>Any change events can flow from the updated database with CDC,&#13;
ensuring that we’re never sending an event we shouldn’t because the transaction has been committed before CDC sees the change,&#13;
as shown in <a data-type="xref" href="#image:database-message-cdc">Figure 9-5</a>.</p>&#13;
&#13;
<figure><div class="figure" id="image:database-message-cdc">&#13;
<img alt="Writing to a database, with CDC triggering message creation" src="assets/rsij_0905.png"/>&#13;
<h6><span class="label">Figure 9-5. </span>Writing to a database, with CDC triggering message creation</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="strong consistency" data-type="indexterm" id="idm45358821611824"/>One impact for developers to be aware of is that CDC does not provide strong consistency.&#13;
<em>Strong consistency</em> means that any data viewed immediately after an update is consistent for all observers of the data,&#13;
regardless of whether the viewers are in parallel or distributed processes.&#13;
For relational databases, this is guaranteed as it’s part of the design of the database.&#13;
With CDC, there is a period of time between the update happening in the database,&#13;
and when the message of the update is received and processed by the furthest downstream system consuming the messages.</p>&#13;
&#13;
<p><a data-primary="eventual consistency" data-type="indexterm" id="idm45358821609728"/>The lack of strong consistency,&#13;
or <em>eventual consistency</em>,&#13;
is not a deterrent for the use of CDC.&#13;
We want developers to be aware of the consistency guarantees of the CDC pattern,&#13;
to bear it in mind during application design.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Debezium to Capture Change" data-type="sect1"><div class="sect1" id="idm45358821625600">&#13;
<h1>Using Debezium to Capture Change</h1>&#13;
&#13;
<p><a data-primary="CDC (change data capture)" data-type="indexterm" id="idm45358821606512"/><a data-primary="Debezium" data-type="indexterm" id="idm45358821605776"/><a data-primary="Hibernate Reactive" data-type="indexterm" id="idm45358821605104"/><a href="https://debezium.io/">Debezium</a> is a distributed platform for CDC.&#13;
Debezium is durable and fast,&#13;
enabling applications to respond promptly and never miss an event!</p>&#13;
&#13;
<p><a data-type="xref" href="#image:debezium-cdc">Figure 9-6</a> shows where Debezium fits in an application architecture using CDC.&#13;
Debezium provides Kafka Connect source connectors for several databases,&#13;
including MySQL, MongoDB, PostgreSQL, Oracle, Db2, and SQL Server.</p>&#13;
&#13;
<figure><div class="figure" id="image:debezium-cdc">&#13;
<img alt="CDC with Debezium" src="assets/rsij_0906.png"/>&#13;
<h6><span class="label">Figure 9-6. </span>CDC with Debezium</h6>&#13;
</div></figure>&#13;
&#13;
<p>We will briefly show how we can enhance the Hibernate Reactive example from the previous section with Debezium.&#13;
Full details can be found in the <a href="https://oreil.ly/XTQQp">source code</a> for the book.</p>&#13;
&#13;
<p>Though this example includes a copy of the code from Hibernate Reactive,&#13;
it would also work by using the example directly, as the application code is not impacted by the introduction of Debezium.&#13;
The main piece to understand is the <em>docker-compose.yml</em> file.&#13;
This file starts the Kafka containers, ZooKeeper as a dependency of Kafka, a PostgreSQL database, and Kafka Connect.&#13;
We will use the container images from the Debezium project to simplify the deployment process.&#13;
For example, the PostgreSQL container image already includes the logical decoding plug-ins necessary to communicate the change events to Kafka Connect.</p>&#13;
&#13;
<p>Start all the containers with <code>docker compose up</code>, and then build and start the application with <code>java -jar target/quarkus-app/quarkus-run.jar</code>.&#13;
Once all containers have started,&#13;
we install the Debezium source connector for PostgreSQL into Kafka Connect (<a data-type="xref" href="#data::install-source-connector">Example 9-21</a>).</p>&#13;
<div data-type="example" id="data::install-source-connector">&#13;
<h5><span class="label">Example 9-21. </span>Install the Debezium source connector</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">curl -i -X POST -H <code class="s2">"Accept:application/json"</code> -H <code class="s2">"Content-Type:application/json"</code> <code class="se">\</code>&#13;
    http://localhost:8083/connectors/ -d @register.json</pre></div>&#13;
&#13;
<p>Here, <em>register.json</em> is the data we’re passing to the Kafka Connect endpoint.&#13;
The file provides the details of the database to connect to and the Debezium connector to use, as shown in <a data-type="xref" href="#data::deb-source-connector-def">Example 9-22</a>.</p>&#13;
<div data-type="example" id="data::deb-source-connector-def">&#13;
<h5><span class="label">Example 9-22. </span>Debezium source connector definition</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="o">{</code>&#13;
  <code class="s2">"name"</code>: <code class="s2">"customer-connector"</code>,&#13;
  <code class="s2">"config"</code>: <code class="o">{</code>&#13;
    <code class="s2">"connector.class"</code>: <code class="s2">"io.debezium.connector.postgresql.PostgresConnector"</code>,&#13;
    <code class="s2">"tasks.max"</code>: <code class="s2">"1"</code>,&#13;
    <code class="s2">"database.hostname"</code>: <code class="s2">"postgres"</code>,&#13;
    <code class="s2">"database.port"</code>: <code class="s2">"5432"</code>,&#13;
    <code class="s2">"database.user"</code>: <code class="s2">"quarkus_test"</code>,&#13;
    <code class="s2">"database.password"</code>: <code class="s2">"quarkus_test"</code>,&#13;
    <code class="s2">"database.dbname"</code>: <code class="s2">"quarkus_test"</code>,&#13;
    <code class="s2">"database.server.name"</code>: <code class="s2">"quarkus-db-server"</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The installation of the source connector will trigger the creation of Kafka topics for the tables discovered by the connector.&#13;
We can verify what topics were created by running <code>docker exec -ti kafka bin/kafka-topics.sh --list --zookeeper zookeeper:2181</code>.</p>&#13;
&#13;
<p>Next we run an <em>exec</em> shell in the Kafka container to consume messages from the topic for the customer database,&#13;
<code>quarkus-db-server.public.customer</code> (<a data-type="xref" href="#data::kafka-customer-topic">Example 9-23</a>).</p>&#13;
<div data-type="example" id="data::kafka-customer-topic">&#13;
<h5><span class="label">Example 9-23. </span>Consume messages from Kafka</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code>docker-compose</code><code> </code><code class="nb">exec </code><code>kafka</code><code> </code><code>/kafka/bin/kafka-console-consumer.sh</code><code> </code><code class="se">\&#13;
</code><code>    </code><code>--bootstrap-server</code><code> </code><code>kafka:9092</code><code> </code><code class="se">\&#13;
</code><code>    </code><code>--from-beginning</code><code> </code><code class="se">\ </code><code>                             </code><a class="co" href="#callout_accessing_data_reactively_CO1-1" id="co_accessing_data_reactively_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code>--property</code><code> </code><code>print.key</code><code class="o">=</code><code class="nb">true</code><code> </code><code class="se">\&#13;
</code><code>    </code><code>--topic</code><code> </code><code>quarkus-db-server.public.customer</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_accessing_data_reactively_CO1-1" id="callout_accessing_data_reactively_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Remove this setting to skip the initial four messages created when the application started.</p></dd>&#13;
</dl>&#13;
&#13;
<p>When <a data-type="xref" href="#data::kafka-customer-topic">Example 9-23</a> is done,&#13;
create a new customer in a separate terminal window, as shown in <a data-type="xref" href="#data::create-new-customer">Example 9-24</a>.</p>&#13;
<div data-type="example" id="data::create-new-customer">&#13;
<h5><span class="label">Example 9-24. </span>Create a customer</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">curl -X POST -H <code class="s2">"Content-Type:application/json"</code> http://localhost:8080/customer <code class="se">\</code>&#13;
    -d <code class="s1">'{"name" : "Harry Houdini"}'</code></pre></div>&#13;
&#13;
<p>In the terminal running <a data-type="xref" href="#data::kafka-customer-topic">Example 9-23</a>,&#13;
we see the JSON message created by the connector (<a data-type="xref" href="#data::json-message">Example 9-25</a>).</p>&#13;
<div data-type="example" id="data::json-message">&#13;
<h5><span class="label">Example 9-25. </span>CDC message from creating a customer</h5>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code>&#13;
  </code><code class="nt">"schema"</code><code class="p">:</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nt">"type"</code><code class="p">:</code><code class="s2">"struct"</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"fields"</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">{</code><code>&#13;
      </code><code class="nt">"type"</code><code class="p">:</code><code class="s2">"int64"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"optional"</code><code class="p">:</code><code class="kc">false</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"field"</code><code class="p">:</code><code class="s2">"id"</code><code>&#13;
    </code><code class="p">}</code><code class="p">]</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"optional"</code><code class="p">:</code><code class="kc">false</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"quarkus_db_server.public.customer.Key"</code><code>&#13;
  </code><code class="p">}</code><code class="p">,</code><code>&#13;
  </code><code class="nt">"payload"</code><code class="p">:</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nt">"id"</code><code class="p">:</code><code class="mi">9</code><code>                    </code><a class="co" href="#callout_accessing_data_reactively_CO2-1" id="co_accessing_data_reactively_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="p">{</code><code>&#13;
  </code><code class="nt">"schema"</code><code class="p">:</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="err">/</code><code class="err">/</code><code> </code><code class="err">J</code><code class="err">S</code><code class="err">O</code><code class="err">N</code><code> </code><code class="err">d</code><code class="err">e</code><code class="err">f</code><code class="err">i</code><code class="err">n</code><code class="err">i</code><code class="err">n</code><code class="err">g</code><code> </code><code class="err">t</code><code class="err">h</code><code class="err">e</code><code> </code><code class="err">s</code><code class="err">c</code><code class="err">h</code><code class="err">e</code><code class="err">m</code><code class="err">a</code><code> </code><code class="err">o</code><code class="err">f</code><code> </code><code class="err">t</code><code class="err">h</code><code class="err">e</code><code> </code><code class="err">p</code><code class="err">a</code><code class="err">y</code><code class="err">l</code><code class="err">o</code><code class="err">a</code><code class="err">d</code><code> </code><code class="err">r</code><code class="err">e</code><code class="err">m</code><code class="err">o</code><code class="err">v</code><code class="err">e</code><code class="err">d</code><code> </code><code class="err">f</code><code class="err">o</code><code class="err">r</code><code> </code><code class="err">b</code><code class="err">r</code><code class="err">e</code><code class="err">v</code><code class="err">i</code><code class="err">t</code><code class="err">y</code><code>&#13;
&#13;
    </code><code class="nt">"optional"</code><code class="p">:</code><code> </code><code class="kc">false</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"name"</code><code class="p">:</code><code> </code><code class="s2">"quarkus_db_server.public.customer.Envelope"</code><code>&#13;
  </code><code class="p">}</code><code class="p">,</code><code>&#13;
  </code><code class="nt">"payload"</code><code class="p">:</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nt">"before"</code><code class="p">:</code><code> </code><code class="kc">null</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"after"</code><code class="p">:</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="nt">"id"</code><code class="p">:</code><code> </code><code class="mi">9</code><code class="p">,</code><code>                       </code><a class="co" href="#callout_accessing_data_reactively_CO2-1" id="co_accessing_data_reactively_CO2-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
      </code><code class="nt">"name"</code><code class="p">:</code><code> </code><code class="s2">"Harry Houdini"</code><code>        </code><a class="co" href="#callout_accessing_data_reactively_CO2-2" id="co_accessing_data_reactively_CO2-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"source"</code><code class="p">:</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="nt">"version"</code><code class="p">:</code><code> </code><code class="s2">"1.5.0.Final"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"connector"</code><code class="p">:</code><code> </code><code class="s2">"postgresql"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"name"</code><code class="p">:</code><code> </code><code class="s2">"quarkus-db-server"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"ts_ms"</code><code class="p">:</code><code> </code><code class="mi">1627865571265</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"snapshot"</code><code class="p">:</code><code> </code><code class="s2">"false"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"db"</code><code class="p">:</code><code> </code><code class="s2">"quarkus_test"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"sequence"</code><code class="p">:</code><code> </code><code class="s2">"[null,\"23870800\"]"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"schema"</code><code class="p">:</code><code> </code><code class="s2">"public"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"table"</code><code class="p">:</code><code> </code><code class="s2">"customer"</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"txId"</code><code class="p">:</code><code> </code><code class="mi">499</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"lsn"</code><code class="p">:</code><code> </code><code class="mi">23871232</code><code class="p">,</code><code>&#13;
      </code><code class="nt">"xmin"</code><code class="p">:</code><code> </code><code class="kc">null</code><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"op"</code><code class="p">:</code><code> </code><code class="s2">"c"</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"ts_ms"</code><code class="p">:</code><code> </code><code class="mi">1627865571454</code><code class="p">,</code><code>&#13;
    </code><code class="nt">"transaction"</code><code class="p">:</code><code> </code><code class="kc">null</code><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_accessing_data_reactively_CO2-1" id="callout_accessing_data_reactively_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The ID of the record created with the <code>POST</code></p></dd>&#13;
<dt><a class="co" href="#co_accessing_data_reactively_CO2-3" id="callout_accessing_data_reactively_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Name of the created customer</p></dd>&#13;
</dl>&#13;
&#13;
<p>Experiment with other HTTP commands, such as updating a customer name,&#13;
to compare the JSON received in the Kafka topic.<a data-startref="ix_data-adoc14" data-type="indexterm" id="idm45358821309872"/><a data-startref="ix_data-adoc13" data-type="indexterm" id="idm45358821309168"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45358821607424">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Data with reactive applications has been limited until recently, as there weren’t reactive database clients available.&#13;
With the introduction of Vert.x client APIs for databases such as PostgreSQL,&#13;
we can now create a reactive application that is reactive for the entirety of the stack.</p>&#13;
&#13;
<p>We don’t always want to utilize database client APIs directly.&#13;
We like simplified APIs such as that provided by Hibernate ORM.&#13;
Hibernate Reactive gives us such an ability,&#13;
building on the maturity of Hibernate ORM to add reactive-specific APIs.</p>&#13;
&#13;
<p>Relational databases aren’t the only option either.&#13;
We also have reactive clients for Redis and MongoDB.&#13;
With event-driven architecture,&#13;
we want to have the ability to create events from database interactions.&#13;
This is where CDC shines, with its ability to extract changes from database tables and create&#13;
change events to feed into Kafka.</p>&#13;
&#13;
<p>We’ve now reached the end of <a data-type="xref" href="part03.html#quarkus-part">Part III</a>!&#13;
We dove deeper into Quarkus and saw that it unifies the imperative and&#13;
reactive programming models, offering greater flexibility for developers in choosing their application stack.&#13;
We then journeyed through <code>Uni</code> and <code>Multi</code> to learn about the preferred reactive programming library in Quarkus, Mutiny.&#13;
Continuing with newer innovations in Quarkus,&#13;
we explored RESTEasy Reactive to develop JAX-RS resources in a completely nonblocking manner while still providing the ability to block when needed,&#13;
before finishing up with reactive database clients with Hibernate Reactive and Redis.</p>&#13;
&#13;
<p>In <a data-type="xref" href="part04.html#patterns-part">Part IV</a>,&#13;
we focus on typical patterns we need when developing reactive applications,&#13;
such as messaging with Kafka and AMQP.&#13;
Then we delve into aspects of the system’s underlying messaging to better appreciate the trade-offs and their abilities.&#13;
We take a look at communicating with external services with HTTP clients,&#13;
while still utilizing nonblocking I/O.&#13;
Lastly, though not necessarily an application pattern per se,&#13;
we will look at observability, as it is critical to understand and implement it for distributed systems.<a data-startref="ix_data-adoc0" data-type="indexterm" id="idm45358821134784"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>