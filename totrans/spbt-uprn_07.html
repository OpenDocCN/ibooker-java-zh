<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Creating Applications Using Spring MVC"><div class="chapter" id="sbur-07">
<h1><span class="label">Chapter 7. </span>Creating Applications Using Spring MVC</h1>


<p><a data-type="indexterm" data-primary="Spring MVC (Model-View-Controller)" id="ix_spring_mvc_ch7"/>This chapter demonstrates how to create Spring Boot applications using Spring MVC with REST interactions, messaging platforms, and other communications mechanisms and provides an introduction to templating language support. Although I introduced interservice interactions as part of last chapter’s dive into Spring Boot’s many options for handling data, this chapter shifts the primary focus from the application itself to the outside world: its interactions with other applications and/or services and with end users.</p>
<div data-type="tip"><h1>Code Checkout Checkup</h1>
<p>Please check out branch <em>chapter7begin</em> from the code repository to begin.</p>
</div>






<section data-type="sect1" data-pdf-bookmark="Spring MVC: What Does It Mean?"><div class="sect1" id="idm45693953115064">
<h1>Spring MVC: What Does It Mean?</h1>

<p>Like many other things in technology, the term <em>Spring MVC</em> is somewhat overloaded. When someone refers to Spring MVC, they could mean any of the following:</p>

<ul>
<li>
<p>Implementing (in some manner) the Model-View-Controller pattern in a Spring application</p>
</li>
<li>
<p>Creating an application specifically using Spring MVC component concepts like the <code>Model</code> interface, <code>@Controller</code> classes, and view technologies</p>
</li>
<li>
<p>Developing blocking/nonreactive applications using Spring</p>
</li>
</ul>

<p>Depending on context, Spring MVC can be considered both an approach and an implementation. It can also be used within or without Spring Boot. Generic application of the MVC pattern using Spring and Spring MVC use outside of Spring Boot both fall outside the scope of this book. I’ll focus specifically on the final two concepts previously listed using Spring Boot to implement them.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="End User Interactions Using Template Engines"><div class="sect1" id="idm45693953108104">
<h1>End User Interactions Using Template Engines</h1>

<p><a data-type="indexterm" data-primary="templates and template engines" data-secondary="end user interactions using" id="ix_template_enduser"/><a data-type="indexterm" data-primary="Spring MVC (Model-View-Controller)" data-secondary="end user interactions using template engines" id="ix_spring_mvc_template"/>While Spring Boot applications handle a lot of heavy-lifting chores on the backend, Boot also supports direct end-user interactions as well. Although long-established standards like Java Server Pages (JSP) are still supported by Boot for legacy applications, most current applications either leverage more powerful view technologies supported by still-evolving and -maintained template engines or shift frontend development to a combination of HTML and JavaScript. It’s even possible to mix the two options successfully and play to each one’s strengths.</p>

<p>Spring Boot works well with HTML and JavaScript frontends, as I demonstrate later in this chapter. For now, let’s take a closer look at template engines.</p>

<p>Template engines provide a way for a so-called server-side application to generate the final pages that will be displayed and executed in the end user’s browser. These view technologies differ in approaches but generally provide the following:</p>

<ul>
<li>
<p>A template language and/or collection of tags that define inputs used by the template engine to produce the expected outcome</p>
</li>
<li>
<p>A view resolver that determines the view/template to use to fulfill a requested resource</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="FreeMarker" id="idm45693953099640"/><a data-type="indexterm" data-primary="Groovy DSL" id="idm45693953098744"/><a data-type="indexterm" data-primary="Mustache" id="idm45693953098072"/>Among other lesser-used options, Spring Boot supports view technologies such as <a href="https://www.thymeleaf.org">Thymeleaf</a>, <a href="https://freemarker.apache.org">FreeMarker</a>, <a href="http://groovy-lang.org/templating.html">Groovy Markup</a>, and <a href="https://mustache.github.io">Mustache</a>. Thymeleaf is perhaps the most widely used of these for several reasons and provides excellent support for both Spring MVC and Spring WebFlux applications.</p>

<p><a data-type="indexterm" data-primary="Thymeleaf" id="idm45693953094152"/>Thymeleaf uses natural templates: files that incorporate code elements but that can be opened and viewed directly (and correctly) in any standard web browser. Being able to view the template files as HTML enables developers or designers to create and evolve Thymeleaf templates without any running server processes. Any code integrations that expect corresponding server-side elements are tagged as Thymeleaf-specific and simply don’t display what isn’t present.</p>

<p>Building on previous efforts, let’s build a simple web application using Spring Boot, Spring MVC, and Thymeleaf to present to the end user an interface for querying <span class="keep-together">PlaneFinder</span> for current aircraft positions and displaying the results. Initially this will be a rudimentary proof of concept to be evolved in subsequent chapters.</p>








<section data-type="sect2" data-pdf-bookmark="Initializing the Project"><div class="sect2" id="idm45693953091304">
<h2>Initializing the Project</h2>

<p>To begin, we return to the Spring Initializr. From there, I choose the following options:</p>

<ul>
<li>
<p>Maven project</p>
</li>
<li>
<p>Java</p>
</li>
<li>
<p>Current production version of Spring Boot</p>
</li>
<li>
<p>Packaging: Jar</p>
</li>
<li>
<p>Java: 11</p>
</li>
</ul>

<p>And for dependencies:</p>

<ul>
<li>
<p>Spring Web (<code>spring-boot-starter-web</code>)</p>
</li>
<li>
<p>Spring Reactive Web (<code>spring-boot-starter-webflux</code>)</p>
</li>
<li>
<p>Thymeleaf (<code>spring-boot-starter-thymeleaf</code>)</p>
</li>
<li>
<p>Spring Data JPA (<code>spring-boot-starter-data-jpa</code>)</p>
</li>
<li>
<p>H2 Database (<code>h2</code>)</p>
</li>
<li>
<p>Lombok (<code>lombok</code>)</p>
</li>
</ul>

<p>The next step is to generate the project and save it locally, unzip it, and open it in the IDE.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Developing the Aircraft Positions Application"><div class="sect2" id="idm45693953075000">
<h2>Developing the Aircraft Positions Application</h2>

<p><a data-type="indexterm" data-primary="Aircraft Positions" data-secondary="developing Spring MVC" id="ix_aircraftpos_spring_mvc"/>Since this application is concerned only with the current state—aircraft positions at the moment the request is made, not historically—an in-memory database seems a reasonable choice. One could instead use an <code>Iterable</code> of some kind, of course, but Spring Boot’s support for Spring Data repositories and the H2 database fulfill the current use case and position the application well for planned future expansion.</p>










<section data-type="sect3" data-pdf-bookmark="Defining the domain class"><div class="sect3" id="idm45693953071352">
<h3>Defining the domain class</h3>

<p>As with other projects interacting with <code>PlaneFinder</code>, I create an <code>Aircraft</code> domain class to serve as the primary (data) focus. Here is the <code>Aircraft</code> domain class structure for the <code>Aircraft Positions</code> application:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Entity</code>
<code class="nd">@Data</code>
<code class="nd">@NoArgsConstructor</code>
<code class="nd">@AllArgsConstructor</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Aircraft</code> <code class="o">{</code>
    <code class="nd">@Id</code>
    <code class="kd">private</code> <code class="n">Long</code> <code class="n">id</code><code class="o">;</code>
    <code class="kd">private</code> <code class="n">String</code> <code class="n">callsign</code><code class="o">,</code> <code class="n">squawk</code><code class="o">,</code> <code class="n">reg</code><code class="o">,</code> <code class="n">flightno</code><code class="o">,</code> <code class="n">route</code><code class="o">,</code> <code class="n">type</code><code class="o">,</code> <code class="n">category</code><code class="o">;</code>

    <code class="kd">private</code> <code class="kt">int</code> <code class="n">altitude</code><code class="o">,</code> <code class="n">heading</code><code class="o">,</code> <code class="n">speed</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"vert_rate"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kt">int</code> <code class="n">vertRate</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"selected_altitude"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kt">int</code> <code class="n">selectedAltitude</code><code class="o">;</code>

    <code class="kd">private</code> <code class="kt">double</code> <code class="n">lat</code><code class="o">,</code> <code class="n">lon</code><code class="o">,</code> <code class="n">barometer</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"polar_distance"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kt">double</code> <code class="n">polarDistance</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"polar_bearing"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kt">double</code> <code class="n">polarBearing</code><code class="o">;</code>

    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"is_adsb"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kt">boolean</code> <code class="n">isADSB</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"is_on_ground"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="kt">boolean</code> <code class="n">isOnGround</code><code class="o">;</code>

    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"last_seen_time"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="n">Instant</code> <code class="n">lastSeenTime</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"pos_update_time"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="n">Instant</code> <code class="n">posUpdateTime</code><code class="o">;</code>
    <code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"bds40_seen_time"</code><code class="o">)</code>
    <code class="kd">private</code> <code class="n">Instant</code> <code class="n">bds40SeenTime</code><code class="o">;</code>
<code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="JPA (Java Persistence API)" data-secondary="Spring MVC" id="idm45693953065288"/><a data-type="indexterm" data-primary="Lombok" data-secondary="template engines for end user interactions" id="idm45693953064344"/>This domain class is defined using JPA with H2 as the underlying JPA-compliant database and leveraging Lombok to create a data class with constructors having zero arguments and all arguments, one for every member variable.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Creating the repository interface"><div class="sect3" id="idm45693952954488">
<h3>Creating the repository interface</h3>

<p><a data-type="indexterm" data-primary="CrudRepository" id="idm45693952953384"/>Next, I define the required repository interface, extending Spring Data’s <code>CrudRepository</code> and providing the type of object to store and its key: <code>Aircraft</code> and <code>Long</code>, in this case:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">AircraftRepository</code> <code class="kd">extends</code> <code class="n">CrudRepository</code><code class="o">&lt;</code><code class="n">Aircraft</code><code class="o">,</code> <code class="n">Long</code><code class="o">&gt;</code> <code class="o">{}</code></pre>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Working with Model and Controller"><div class="sect3" id="idm45693952941800">
<h3>Working with Model and Controller</h3>

<p>I’ve defined the data behind the model with the <code>Aircraft</code> domain class; now it’s time to incorporate it into the <code>Model</code> and expose it via a <code>Controller</code>.</p>

<p><a data-type="indexterm" data-primary="@Controller" id="ix_controller_ch7"/><a data-type="indexterm" data-primary="@RestController" id="idm45693952930824"/>As discussed in <a data-type="xref" href="ch03.xhtml#sbur-03">Chapter 3</a>, <code>@RestController</code> is a convenience notation that combines <code>@Controller</code> with <code>@ResponseBody</code> into a single descriptive annotation, returning a formatted response as JavaScript Object Notation (JSON) or as other data-oriented format. This results in the Object/Iterable return value of a method being the <em>entire body</em> of the response to a web request, instead of being returned as a part of the <code>Model</code>. An <code>@RestController</code> enables the creation of an API, a specialized, but very common, use case.</p>

<p>The goal now is to create an application that also includes a user interface, and <code>@Controller</code> enables that. <a data-type="indexterm" data-primary="@RequestMapping" id="idm45693952925320"/>Within an <code>@Controller</code> class, each method annotated with <code>@RequestMapping</code> or one of its specialized aliases like <code>@GetMapping</code> will return a <code>String</code> value that corresponds to the name of a template file minus its extension. <a data-type="indexterm" data-primary="Thymeleaf" id="idm45693952922696"/><a data-type="indexterm" data-primary="@GetMapping" id="idm45693952921992"/>For example, Thymeleaf files have the <em>.html</em> file extension, so if an <code>@Controller</code> class’s <code>@GetMapping</code> method returns the <code>String</code> “myfavoritepage”, the Thymeleaf template engine will use the <em>myfavoritepage.html</em> template to create and return the generated page to the user’s browser.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>View technology templates are placed under the project’s <em>src/main/resources/templates</em> directory by default; the template engine will look here for them unless overridden via application properties or programmatic means.</p>
</div>

<p>Returning to the controller, I create a class <code>PositionController</code> as follows:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@RequiredArgsConstructor</code>
<code class="nd">@Controller</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PositionController</code> <code class="o">{</code>
    <code class="nd">@NonNull</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">AircraftRepository</code> <code class="n">repository</code><code class="o">;</code>
    <code class="kd">private</code> <code class="n">WebClient</code> <code class="n">client</code> <code class="o">=</code>
            <code class="n">WebClient</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="s">"http://localhost:7634/aircraft"</code><code class="o">);</code>

    <code class="nd">@GetMapping</code><code class="o">(</code><code class="s">"/aircraft"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getCurrentAircraftPositions</code><code class="o">(</code><code class="n">Model</code> <code class="n">model</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">repository</code><code class="o">.</code><code class="na">deleteAll</code><code class="o">();</code>

        <code class="n">client</code><code class="o">.</code><code class="na">get</code><code class="o">()</code>
                <code class="o">.</code><code class="na">retrieve</code><code class="o">()</code>
                <code class="o">.</code><code class="na">bodyToFlux</code><code class="o">(</code><code class="n">Aircraft</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
                <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">plane</code> <code class="o">-&gt;</code> <code class="o">!</code><code class="n">plane</code><code class="o">.</code><code class="na">getReg</code><code class="o">().</code><code class="na">isEmpty</code><code class="o">())</code>
                <code class="o">.</code><code class="na">toStream</code><code class="o">()</code>
                <code class="o">.</code><code class="na">forEach</code><code class="o">(</code><code class="nl">repository:</code><code class="o">:</code><code class="n">save</code><code class="o">);</code>

        <code class="n">model</code><code class="o">.</code><code class="na">addAttribute</code><code class="o">(</code><code class="s">"currentPositions"</code><code class="o">,</code> <code class="n">repository</code><code class="o">.</code><code class="na">findAll</code><code class="o">());</code>
        <code class="k">return</code> <code class="s">"positions"</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>This controller looks very similar to previous iterations but with a few key differences. First, of course, is the <code>@Controller</code> annotation previously discussed instead of <code>@RestController</code>. Second is that the <code>getCurrentAircraftPositions()</code> method has an automatically autowired parameter: <code>Model model</code>. This parameter is the <code>Model</code> bean that is leveraged by the template engine to provide access to the application’s components—their data and operations—once we add those components to the <code>Model</code> as an attribute. And third is the method’s return type of <code>String</code> instead of a class type and the actual return statement with the name of a template (sans <em>.html</em> extension).</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In a complex domain/application, I prefer to separate concerns a bit more by creating distinct <code>@Service</code> and <code>@Controller</code> classes. In this example, there is a single method making a single repository access, so I’ve placed all functionality to populate the underlying data, populate the <code>Model</code>, and hand it off to the appropriate <code>View</code> within the <code>Controller</code>.<a data-type="indexterm" data-primary="" data-startref="ix_controller_ch7" id="idm45693952499240"/><a data-type="indexterm" data-primary="@Service" id="idm45693952498232"/></p>
</div>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Creating the requisite View files"><div class="sect3" id="idm45693952497432">
<h3>Creating the requisite View files</h3>

<p>As a basic foundation for this and future chapters, I create one plain HTML file and one template file.</p>

<p><a data-type="indexterm" data-primary="index.html file" id="idm45693952495496"/>Since I want to display a plain HTML page to all visitors, and since this page requires no template support, I place <em>index.html</em> directly in the project’s <em>src/main/resources/static</em> directory:</p>

<pre data-type="programlisting" data-code-language="html"><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>
<code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;title&gt;</code>Retrieve Aircraft Position Report<code class="nt">&lt;/title&gt;</code>
<code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;body&gt;</code>
    <code class="nt">&lt;p&gt;&lt;a</code> <code class="na">href=</code><code class="s">"/aircraft"</code><code class="nt">&gt;</code>Click here<code class="nt">&lt;/a&gt;</code>
        to retrieve current aircraft positions in range of receiver.<code class="nt">&lt;/p&gt;</code>
<code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45693952423112">
<h5>Notes About index.html</h5>
<p>By default, a Spring Boot application will look for static pages in the classpath under <em>static</em> and <em>public</em> directories. To properly place them there during build, place them within one of those two directories under <em>src/main/resources</em> within the project.</p>

<p>Of particular interest to this application is the <code>href</code> hyperlink “/aircraft”. This link matches the <code>@GetMapping</code> annotation for the <code>PositionController</code> <code>getCurrentAircraftPositions()</code> method and points to the endpoint exposed by it, another example of the internal integration by Spring Boot across various components within the application. Clicking <em>Click here</em> from the page displayed by the running application will execute <code>getCurrentAircraftPositions()</code>, which will return “positions”, prompting the <code>ViewResolver</code> to generate and return the next page based on the template <em>positions.html</em>.</p>

<p>As a final note, if an <em>index.html</em> file is located in one of the searched classpath directories, Spring Boot will automatically load it for the user when the application’s <em>host:port</em> address is accessed from a browser or other user agent with no configuration required from the developer.</p>
</div></aside>

<p><a data-type="indexterm" data-primary="Thymeleaf" id="ix_thymeleaf_2"/>For the dynamic content, I create a template file, adding an XML namespace for Thymeleaf tags to the otherwise plain HTML file and then using those tags as content injection guidance for the Thymeleaf template engine, as shown in the following 
<span class="keep-together"><em>positions.html</em></span> file. To designate this as a template file for processing by the engine, I place it in the <em>src/main/resources/templates</em> project directory:</p>

<pre data-type="programlisting" data-code-language="html"><code class="cp">&lt;!DOCTYPE HTML&gt;</code>
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code> <code class="na">xmlns:th=</code><code class="s">"http://www.thymeleaf.org"</code><code class="nt">&gt;</code>
<code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;title&gt;</code>Position Report<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;meta</code> <code class="na">http-equiv=</code><code class="s">"Content-Type"</code> <code class="na">content=</code><code class="s">"text/html; charset=UTF-8"</code><code class="nt">/&gt;</code>
<code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;body&gt;</code>
<code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"positionlist"</code> <code class="na">th:unless=</code><code class="s">"${#lists.isEmpty(currentPositions)}"</code><code class="nt">&gt;</code>

    <code class="nt">&lt;h2&gt;</code>Current Aircraft Positions<code class="nt">&lt;/h2&gt;</code>

    <code class="nt">&lt;table&gt;</code>
        <code class="nt">&lt;thead&gt;</code>
        <code class="nt">&lt;tr&gt;</code>
            <code class="nt">&lt;th&gt;</code>Call Sign<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Squawk<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>AC Reg<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Flight #<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Route<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>AC Type<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Altitude<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Heading<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Speed<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Vert Rate<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Latitude<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Longitude<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;</code>Last Seen<code class="nt">&lt;/th&gt;</code>
            <code class="nt">&lt;th&gt;&lt;/th&gt;</code>
        <code class="nt">&lt;/tr&gt;</code>
        <code class="nt">&lt;/thead&gt;</code>
        <code class="nt">&lt;tbody&gt;</code>
        <code class="nt">&lt;tr</code> <code class="na">th:each=</code><code class="s">"ac : ${currentPositions}"</code><code class="nt">&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.callsign}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.squawk}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.reg}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.flightno}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.route}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.type}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.altitude}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.heading}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.speed}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.vertRate}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.lat}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.lon}"</code><code class="nt">&gt;&lt;/td&gt;</code>
            <code class="nt">&lt;td</code> <code class="na">th:text=</code><code class="s">"${ac.lastSeenTime}"</code><code class="nt">&gt;&lt;/td&gt;</code>
        <code class="nt">&lt;/tr&gt;</code>
        <code class="nt">&lt;/tbody&gt;</code>
    <code class="nt">&lt;/table&gt;</code>
<code class="nt">&lt;/div&gt;</code>
<code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>

<p>For the aircraft position report page, I reduce the information displayed to a select few elements of particular importance and interest. There are a few items of note in the <em>positions.html</em> Thymeleaf template:</p>

<p>First, as mentioned earlier, I add the Thymeleaf tags to the XML namespace with the <em>th</em> prefix with the following line:</p>

<pre data-type="programlisting">&lt;html lang="en" &gt;</pre>

<p>When defining the <code>division</code> that will display the current aircraft positions, I direct that the positionList division should be shown only if data is present; if the <code>currentPositions</code> element within the <code>Model</code> is empty, simply omit the entire division:</p>

<pre data-type="programlisting">&lt;div class="positionlist" th:unless="${#lists.isEmpty(currentPositions)}"&gt;</pre>

<p>Finally, I define a table using standard HTML table tags for the table itself and the header row and its contents. For the table body, I use Thymeleaf’s <code>each</code> to iterate through all <code>currentPositions</code> and populate each row’s columns using the Thymeleaf’s <code>text</code> tag and referencing each position object’s properties via the 
<span class="keep-together">“${object.property}”</span> variable expression syntax. With that, the application is ready for testing.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="The results"><div class="sect3" id="idm45693952496840">
<h3>The results</h3>

<p>With the <code>PlaneFinder</code> service running, I execute the <code>Aircraft Positions</code> application from the IDE. Once it has successfully started, I open a browser tab and enter <code>localhost:8080</code> in the address bar and hit enter. <a data-type="xref" href="#the_aircraft_positions_application_very_simple_landing_page">Figure 7-1</a> shows the resultant page.</p>

<figure><div id="the_aircraft_positions_application_very_simple_landing_page" class="figure">
<img src="Images/sbur_0701.png" alt="sbur 0701" width="600" height="74"/>
<h6><span class="label">Figure 7-1. </span>The Aircraft Positions application (very simple) landing page</h6>
</div></figure>

<p>From here, I click the <em>Click here</em> link to proceed to the Aircraft Position Report page, as shown in <a data-type="xref" href="#the_aircraft_positions_application_very_simple_landing_page">Figure 7-1</a>.</p>

<figure><div id="the_aircraft_position_report_page" class="figure">
<img src="Images/sbur_0702.png" alt="sbur 0702" width="600" height="190"/>
<h6><span class="label">Figure 7-2. </span>The Aircraft Position Report Page</h6>
</div></figure>

<p>Refreshing the page will requery <code>PlaneFinder</code> and update the report with current data on demand.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="A refreshing flourish"><div class="sect3" id="idm45693952207048">
<h3>A refreshing flourish</h3>

<p>Being able to request a listing of aircraft currently in the area along with their exact positions is a useful thing. But having to manually refresh the page could also become quite tedious and result in missing data of great interest, if one is so disposed. To add a timed refresh function to the Aircraft Position Report template, simply add a JavaScript function to the page <code>body</code> similar to the following, specifying the page refresh rate in milliseconds:</p>

<pre data-type="programlisting">&lt;script type="text/javascript"&gt;
    window.onload = setupRefresh;

    function setupRefresh() {
        setTimeout("refreshPage();", 5000); // refresh rate in milliseconds
    }

    function refreshPage() {
        window.location = location.href;
    }
&lt;/script&gt;</pre>

<p>The Thymeleaf template engine passes this code into the generated page untouched, and the user’s browser executes the script at the designated refresh rate. It isn’t the most elegant solution, but for simple use cases, it does the job.<a data-type="indexterm" data-primary="" data-startref="ix_spring_mvc_template" id="idm45693952203368"/><a data-type="indexterm" data-primary="" data-startref="ix_template_enduser" id="idm45693952202392"/><a data-type="indexterm" data-primary="" data-startref="ix_aircraftpos_spring_mvc" id="idm45693952201448"/><a data-type="indexterm" data-primary="" data-startref="ix_thymeleaf_2" id="idm45693952200440"/></p>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Passing Messages"><div class="sect1" id="idm45693953107480">
<h1>Passing Messages</h1>

<p><a data-type="indexterm" data-primary="Spring MVC (Model-View-Controller)" data-secondary="messages" id="ix_spring_mvc_messages"/><a data-type="indexterm" data-primary="PlaneFinder" data-secondary="messages" id="ix_planefinder_messages"/>When use cases are a bit more demanding, more sophisticated solutions may be required. The preceding code does provide dynamic updates reflecting the latest available position data, but among other potential concerns are that periodic requests for updated data can be somewhat chatty. If several clients are requesting and receiving updates constantly, network traffic can be substantial.</p>

<p>In order to fulfill more complex use cases while simultaneously addressing network demands, it’s helpful to shift perspectives: from a pull model to a push model, or some combination of the two.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This section and the next explore two different and incremental steps toward a push model, culminating in an <em>entirely</em> push-based model from the <code>PlaneFinder</code> service outward. Use cases will indicate (or dictate) conditions that may favor one of these approaches or something else entirely. I continue to explore and demonstrate additional alternatives in subsequent chapters, so stay tuned.</p>
</div>

<p><a data-type="indexterm" data-primary="Apache Kafka" id="idm45693952191768"/><a data-type="indexterm" data-primary="RabbitMQ" id="idm45693952191064"/>Messaging platforms were made to efficiently accept, route, and deliver messages between applications. Examples include <a href="https://www.rabbitmq.com">RabbitMQ</a> and <a href="https://kafka.apache.org">Apache Kafka</a> and numerous other offerings, both open source and commercial. Spring Boot and the Spring ecosystem provide a few different options for leveraging message pipelines, but my hands-down favorite is Spring Cloud Stream.</p>

<p><a data-type="indexterm" data-primary="SCSt (Spring Cloud Stream)" id="ix_scst_ch7"/>Spring Cloud Stream elevates the level of abstraction for developers while still providing access to supported platforms’ unique attributes via application properties, beans, and direct configuration. Binders form the connection between streaming platform drivers and Spring Cloud Stream (SCSt), allowing developers to maintain focus on the key tasks—sending, routing, and receiving messages—which don’t differ in concept regardless of the underlying plumbing.</p>








<section data-type="sect2" data-pdf-bookmark="Powering Up PlaneFinder"><div class="sect2" id="idm45693952186408">
<h2>Powering Up PlaneFinder</h2>

<p>The first order of business is to refactor the <code>PlaneFinder</code> service to use Spring Cloud Stream to publish messages for consumption by the <code>Aircraft Positions</code> (and any other applicable) application.</p>










<section data-type="sect3" data-pdf-bookmark="Required dependencies"><div class="sect3" id="idm45693952183912">
<h3>Required dependencies</h3>

<p>I add the following dependencies to <code>PlaneFinder</code> ’s <em>pom.xml</em> Maven build file:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.boot<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-boot-starter-amqp<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.cloud<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-cloud-stream<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.cloud<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-cloud-stream-binder-kafka<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.cloud<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-cloud-stream-binder-rabbit<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.kafka<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-kafka<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre>

<p>The first thing to note is actually the second dependency listed: <code>spring-cloud-stream</code>. This is the code dependency for Spring Cloud Stream, but it can’t do the job alone. As mentioned, SCSt uses binders to enable its powerful abstraction to work with various streaming platforms’ drivers seamlessly. <a data-type="indexterm" data-primary="Spring Initializr (start.spring.io)" id="idm45693952147464"/>There is even a helpful reminder on the Spring Cloud Stream entry accessible from the Spring Initializr to that effect:</p>
<blockquote>
<p>Framework for building highly scalable event-driven microservices connected with shared messaging systems (requires a binder, e.g., Apache Kafka, RabbitMQ, or Solace PubSub+)</p></blockquote>

<p><a data-type="indexterm" data-primary="RabbitMQ" id="ix_RabbitMQ_1"/>For Spring Cloud Stream to work with a messaging platform, it requires a messaging platform driver and the binder that works with it. In the preceding example, I include a binder+driver combination for RabbitMQ <em>and</em> for Apache Kafka.</p>
<div data-type="tip"><h6>Tip</h6>
<p>If only one binder+driver combination is included—for RabbitMQ, for example—Spring Boot’s autoconfiguration can unambiguously determine that your application should support communication with RabbitMQ instance(s) and associated <code>exchanges</code> and <code>queues</code> and create the appropriate supporting beans with no additional effort required on the developer’s part. Including more than one set of binders+drivers requires us to specify which one to use, but it also allows us to dynamically switch among all included platforms at runtime, with no change to the tested and deployed application. This is an extremely powerful and useful capability.</p>
</div>

<p>Two more additions to the <em>pom.xml</em> file are necessary. First is to indicate the project-level version of Spring Cloud to use by adding this line to the <code>&lt;properties&gt;&lt;/properties&gt;</code> section:</p>

<pre data-type="programlisting">&lt;spring-cloud.version&gt;2020.0.0-M5&lt;/spring-cloud.version&gt;</pre>

<p><a data-type="indexterm" data-primary="BOMs (Bills of Materials)" id="idm45693952138616"/>Second is to provide guidance on the Spring Cloud Bill of Materials (BOM), from which the build system can determine versions for any Spring Cloud components—in this case, Spring Cloud Stream—that are used in this project:</p>

<pre data-type="programlisting">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Versions of Spring component projects are updated frequently. An easy way to determine correct, synchronized versions tested with the current version of Spring Boot is to use the Spring Initializr. Selecting the desired dependencies and clicking the button to "<em>Explore CTRL+SPACE</em>" displays the build file with the appropriate elements and versions.</p>
</div>

<p>After refreshing the project’s dependencies, it’s on to the code.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Supplying aircraft positions"><div class="sect3" id="idm45693952183288">
<h3>Supplying aircraft positions</h3>

<p>Due to <code>PlaneFinder</code> ’s existing structure and Spring Cloud Stream’s clean, functional approach, only one small class is required to publish current aircraft positions to RabbitMQ for consumption by other applications:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@AllArgsConstructor</code>
<code class="nd">@Configuration</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PositionReporter</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">PlaneFinderService</code> <code class="n">pfService</code><code class="o">;</code>

    <code class="nd">@Bean</code>
    <code class="n">Supplier</code><code class="o">&lt;</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Aircraft</code><code class="o">&gt;&gt;</code> <code class="nf">reportPositions</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="o">()</code> <code class="o">-&gt;</code> <code class="o">{</code>
            <code class="k">try</code> <code class="o">{</code>
                <code class="k">return</code> <code class="n">pfService</code><code class="o">.</code><code class="na">getAircraft</code><code class="o">();</code>
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>
                <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>
            <code class="o">}</code>
            <code class="k">return</code> <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">();</code>
        <code class="o">};</code>
    <code class="o">}</code>
<code class="o">}</code></pre>
<div class="hard-pagebreak"/>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45693952129816">
<h5>A Few Thoughts on Application Design</h5>
<p>First, technically speaking, only the <code>reportPositions()</code> bean creation method is required, not the entire <code>PositionReporter</code> class. <a data-type="indexterm" data-primary="@Configuration" id="idm45693952020280"/><a data-type="indexterm" data-primary="@SpringBootApplication" id="idm45693952019544"/>Since the main application class is annotated with <code>@SpringBootApplication</code>, a meta-annotation that incorporates <code>@Configuration</code> within, one could simply place <code>reportPositions()</code> within the main application class, <code>PlanefinderApplication</code>. My preference is to place <code>@Bean</code> methods within relevant <code>@Configuration</code> classes, especially in cases where numerous beans are created.</p>

<p>Second, Spring Cloud Stream’s annotation-driven legacy API is still fully supported, but in this book I focus exclusively on the newer functional API. Spring Cloud Stream builds on the clean lines of Spring Cloud Function, which builds on <em>standard Java concepts/interfaces</em>: <code>Supplier&lt;T&gt;</code>, <code>Function&lt;T, R&gt;</code>, and <code>Consumer&lt;T&gt;</code>. This removes from SCSt the slightly leaky abstraction of Spring Integration concepts and supplants it with core language constructs; it also enables some new capabilities, as you might imagine.</p>

<p>Briefly stated, applications can either supply messages (<code>Supplier&lt;T&gt;</code>), transform messages (<code>Function&lt;T, R&gt;</code>) from one kind of thing to another, or consume messages (<code>Consumer&lt;T&gt;</code>). Any supported streaming platform can supply the connecting pipelines.</p>

<p><a data-type="indexterm" data-primary="Amazon Kinesis" id="idm45693952011704"/><a data-type="indexterm" data-primary="Apache Kafka" id="idm45693952011000"/><a data-type="indexterm" data-primary="Apache RocketMQ" id="idm45693952010328"/><a data-type="indexterm" data-primary="Azure Event Hubs" id="idm45693952009656"/><a data-type="indexterm" data-primary="Google Pub/Sub" id="idm45693952008984"/><a data-type="indexterm" data-primary="Solace PubSub+" id="idm45693952008312"/>Platforms currently supported by Spring Cloud Stream include the following:</p>

<ul>
<li>
<p>RabbitMQ</p>
</li>
<li>
<p>Apache Kafka</p>
</li>
<li>
<p>Kafka Streams</p>
</li>
<li>
<p>Amazon Kinesis</p>
</li>
<li>
<p>Google Pub/Sub (partner maintained)</p>
</li>
<li>
<p>Solace PubSub+ (partner maintained)</p>
</li>
<li>
<p>Azure Event Hubs (partner maintained)</p>
</li>
<li>
<p>Apache RocketMQ (partner maintained)</p>
</li>
</ul>
</div></aside>

<p>Since each poll by <code>PlaneFinder</code> of the upstream radio device produces a listing of positions of aircraft currently within range, the <code>PlaneFinder</code> service creates a message consisting of 1+ aircraft in an <code>Iterable&lt;Aircraft&gt;</code> by calling the <code>PlaneFinderService</code> <code>getAircraft()</code> method. An opinion—that a <code>Supplier</code> is called once per second by default (overridable via application property)—and some required/optional application properties inform Spring Boot’s autoconfiguration and set things in motion.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Application properties"><div class="sect3" id="idm45693951996264">
<h3>Application properties</h3>

<p>Only one property is required, although others are helpful. Here are the contents of the updated <code>PlaneFinder</code> ’s <em>application.properties</em> file:</p>

<pre data-type="programlisting">server.port=7634

spring.cloud.stream.bindings.reportPositions-out-0.destination=aircraftpositions
spring.cloud.stream.bindings.reportPositions-out-0.binder=rabbit</pre>

<p>The <code>server.port</code> remains from the first version and indicates the application should listen on port 7634.</p>

<p>Spring Cloud Stream’s functional API relies on minimal property configuration when necessary (as a baseline) to enable its functionality. A <code>Supplier</code> has only output channels, as it  produces only messages. A <code>Consumer</code> has only input channels, as it consumes only messages. A <code>Function</code> has both input and output channels, which are necessary due to its use in transforming one thing to another.</p>

<p>Each binding uses the interface (<code>Supplier</code>, <code>Function</code>, or <code>Consumer</code>) bean method’s name for the channel name, along with <code>in</code> or <code>out</code> and a channel number from <code>0</code> to <code>7</code>. Once concatenated in the form <code>&lt;method&gt;-&lt;in|out&gt;-n</code>, binding properties can be defined for the channel.</p>

<p>The only property required for this use case is <code>destination</code>, and even that is for convenience. Specifying the <code>destination</code> name results in RabbitMQ creating an exchange named <code>aircraftpositions</code> (in this example).</p>

<p>Since I included binders and drivers for both RabbitMQ and Kafka in the project dependencies, I must specify which binder the application should use. For this example, I choose <code>rabbit</code>.</p>

<p>With all required and desired application properties defined, <code>PlaneFinder</code> is ready to publish current aircraft positions each second to RabbitMQ for consumption by any applications desiring to do so.</p>
</div></section>



</div></section>













<section data-type="sect2" data-pdf-bookmark="Extending the Aircraft Positions Application"><div class="sect2" id="idm45693951981720">
<h2>Extending the Aircraft Positions Application</h2>

<p>Converting <code>Aircraft Positions</code> to consume messages from a RabbitMQ pipeline using Spring Cloud Stream is similarly straightforward. Only a few changes to the workings behind the scenes are necessary to replace frequent HTTP requests with a message-driven architecture.</p>










<section data-type="sect3" data-pdf-bookmark="Required dependencies"><div class="sect3" id="idm45693951979352">
<h3>Required dependencies</h3>

<p>Just as with <code>PlaneFinder</code>, I add the following dependencies to the <code>Aircraft Positions</code> application’s <em>pom.xml</em>:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.boot<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-boot-starter-amqp<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.cloud<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-cloud-stream<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.cloud<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-cloud-stream-binder-kafka<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.cloud<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-cloud-stream-binder-rabbit<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code>
<code class="nt">&lt;dependency&gt;</code>
    <code class="nt">&lt;groupId&gt;</code>org.springframework.kafka<code class="nt">&lt;/groupId&gt;</code>
    <code class="nt">&lt;artifactId&gt;</code>spring-kafka<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>As previously mentioned, I include binders and drivers for both RabbitMQ and Kafka for planned future use, but only the RabbitMQ set—<code>spring-boot-starter-amqp</code> and <code>spring-cloud-stream-binder-rabbit</code>—are required for the current use case in order for Spring Cloud Stream (<code>spring-cloud-stream</code>) to use RabbitMQ.</p>
</div>

<p>I also add the two additional required entries to <em>pom.xml</em>. First, this goes into the <code>&lt;properties&gt;&lt;/properties&gt;</code> section, with the <code>java.version</code>:</p>

<pre data-type="programlisting">&lt;spring-cloud.version&gt;2020.0.0-M5&lt;/spring-cloud.version&gt;</pre>

<p>Second is the Spring Cloud BOM information:</p>

<pre data-type="programlisting">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</pre>

<p>A quick refresh of the project’s dependencies and we’re on to the next step.<a data-type="indexterm" data-primary="" data-startref="ix_scst_ch7" id="idm45693951905800"/></p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Consuming aircraft positions"><div class="sect3" id="idm45693951904696">
<h3>Consuming aircraft positions</h3>

<p>In order to retrieve and store messages listing current aircraft positions, only one small additional class is required:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@AllArgsConstructor</code>
<code class="nd">@Configuration</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PositionRetriever</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">AircraftRepository</code> <code class="n">repo</code><code class="o">;</code>

    <code class="nd">@Bean</code>
    <code class="n">Consumer</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Aircraft</code><code class="o">&gt;&gt;</code> <code class="nf">retrieveAircraftPositions</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">acList</code> <code class="o">-&gt;</code> <code class="o">{</code>
            <code class="n">repo</code><code class="o">.</code><code class="na">deleteAll</code><code class="o">();</code>

            <code class="n">repo</code><code class="o">.</code><code class="na">saveAll</code><code class="o">(</code><code class="n">acList</code><code class="o">);</code>

            <code class="n">repo</code><code class="o">.</code><code class="na">findAll</code><code class="o">().</code><code class="na">forEach</code><code class="o">(</code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">::</code><code class="n">println</code><code class="o">);</code>
        <code class="o">};</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="@Configuration" id="idm45693951901128"/><a data-type="indexterm" data-primary="Consumer, RabbitMQ" id="idm45693951824968"/>Like its <code>PositionReporter</code> counterpart in <code>PlaneFinder</code>, the <code>PositionRetriever</code> class is an <code>@Configuration</code> class in which I define a bean for use with Spring Cloud Stream: in this case, a <code>Consumer</code> of messages, each consisting of a <code>List</code> of one or more <code>Aircraft</code>. With each incoming message, the <code>Consumer</code> bean deletes all positions in the (in-memory) datastore, saves all incoming positions, and then prints all stored positions to the console for verification. Note that the last statement printing all positions to the console is optional; it’s included only for confirmation as I develop the app.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Application properties"><div class="sect3" id="idm45693951820328">
<h3>Application properties</h3>

<p>In order to provide the application the few remaining bits of information necessary to connect to the incoming stream of messages, I add the following entries to the 
<span class="keep-together"><em>application.properties</em></span> file:</p>

<pre data-type="programlisting">spring.cloud.stream.bindings.retrieveAircraftPositions-in-0.destination=
   aircraftpositions
spring.cloud.stream.bindings.retrieveAircraftPositions-in-0.group=
   aircraftpositions
spring.cloud.stream.bindings.retrieveAircraftPositions-in-0.binder=
   rabbit</pre>

<p>As with <code>PlaneFinder</code>, the channel is defined by concatenating the following, separated by a hyphen (-):</p>

<ul>
<li>
<p>The bean name, in this case, a <code>Consumer&lt;T&gt;</code> bean</p>
</li>
<li>
<p><code>in</code>, since consumers only consume and thus have only input(s)</p>
</li>
<li>
<p>A number between <code>0</code> and <code>7</code> inclusive, supporting up to eight inputs</p>
</li>
</ul>

<p>The <code>destination</code> and <code>binder</code> properties match those of <code>PlaneFinder</code> because the <code>Aircraft Positions</code> application must point to the same destination as input that <code>PlaneFinder</code> used as output and because to do so, both must be using the same messaging platform—in this case, RabbitMQ. The <code>group</code> property is new, though.</p>

<p>For any kind of <code>Consumer</code> (including the receiving portion of a <code>Function&lt;T, R&gt;</code>), one can specify a <code>group</code>, but it isn’t required; in fact, including or omitting <code>group</code> forms a starting point for a particular routing pattern.</p>

<p>If a message-consuming application doesn’t specify a group, the RabbitMQ binder creates a randomized unique name and assigns it, and the consumer, to an auto-delete queue within the RabbitMQ instance or cluster. This results in each generated queue being serviced by one—and only one—consumer. Why is this important?</p>

<p>Whenever a message arrives at a RabbitMQ exchange, a copy is routed automatically to all queues assigned to that exchange by default. <a data-type="indexterm" data-primary="fan-out pattern, messaging" id="idm45693951804456"/>If an exchange has multiple queues, the same message is sent to every queue in what’s referred to as a <em>fan-out pattern</em>, a useful capability when each message must be delivered to numerous destinations to satisfy various requirements.</p>

<p><a data-type="indexterm" data-primary="Consumer, RabbitMQ" id="idm45693951802680"/>If an application specifies a consumer group to which it belongs, that group name is used to name the underlying queue within RabbitMQ. When multiple applications specify the same <code>group</code> property and thus connect to the same queue, together those applications fulfill the competing consumer pattern in which each message arriving in the designated queue is processed by only one of the consumers. This allows the number of consumers to scale to accommodate varying volumes of messages.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>It is also possible to employ partitioning and routing keys for even finer-grained and flexible routing options, if needed.</p>
</div>

<p>Specifying the <code>group</code> property for this application enables scaling, should multiple instances be needed to keep pace with the flow of arriving messages.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Contacting the Controller"><div class="sect3" id="idm45693951819704">
<h3>Contacting the Controller</h3>

<p>Since the <code>Consumer</code> bean automatically checks for and processes messages automatically, the <code>PositionController</code> class and its <code>getCurrentAircraftPositions()</code> method become dramatically leaner.</p>

<p>All references to <code>WebClient</code> can be removed, since getting a list of current positions is now only a matter of retrieving the current contents of the repository. The streamlined class now looks like this:</p>

<pre data-type="programlisting">@RequiredArgsConstructor
@Controller
public class PositionController {
    @NonNull
    private final AircraftRepository repository;

    @GetMapping("/aircraft")
    public String getCurrentAircraftPositions(Model model) {
        model.addAttribute("currentPositions", repository.findAll());
        return "positions";
    }
}</pre>

<p>With that, all changes to both message-producer (the <code>PlaneFinder</code> app) and message-consumer (the <code>Aircraft Positions</code> app) are now complete.</p>

<p><a data-type="indexterm" data-primary="Docker" id="idm45693951792120"/></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In order to use any external messaging platform, said platform must be running and accessible to the applications. I run a local instance of RabbitMQ using Docker; scripts for quick creation and startup/shutdown are provided in this book’s associated repositories.</p>
</div>
</div></section>













<section data-type="sect3" data-pdf-bookmark="The results"><div class="sect3" id="idm45693951789896">
<h3>The results</h3>

<p>After verifying that RabbitMQ is accessible, it’s time to start the applications and verify everything works as expected.</p>

<p>Although it isn’t a requirement to do so, I prefer to start the message-consuming application first so it’s ready and waiting for messages to arrive. In this case, that means executing <code>Aircraft Positions</code> from my IDE.</p>

<p>Next, I start up the new and improved <code>PlaneFinder</code> application. This initiates the flow of messages to the <code>Aircraft Positions</code> application, as shown in the <code>Aircraft Positions</code> app’s console. That’s gratifying, but we can follow this path of success all the way to the end user as well.</p>

<p>Returning to the browser and accessing <em>localhost:8080</em>, we’re presented with the landing page once again, and opting to <em>Click here</em>, are taken to the Positions Report. As before, the Positions Report is refreshed automatically and displays current aircraft positions; now however, those positions are pushed independently from <code>PlaneFinder</code> behind the scenes to the <code>Aircraft Positions</code> application, without first receiving an HTTP request for them, which brings the architecture one step closer to a fully event-driven system.<a data-type="indexterm" data-primary="" data-startref="ix_planefinder_messages" id="idm45693951782472"/><a data-type="indexterm" data-primary="" data-startref="ix_spring_mvc_messages" id="idm45693951781496"/><a data-type="indexterm" data-primary="" data-startref="ix_RabbitMQ_1" id="idm45693951780552"/></p>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Creating Conversations with WebSocket"><div class="sect1" id="idm45693951779608">
<h1>Creating Conversations with WebSocket</h1>

<p><a data-type="indexterm" data-primary="Spring MVC (Model-View-Controller)" data-secondary="WebSocket" id="ix_spring_mvc_websocket"/><a data-type="indexterm" data-primary="Aircraft Positions" data-secondary="WebSocket" id="ix_aircraftpos_websocket"/> In its first iteration, the distributed system we created to query and display current aircraft positions was entirely pull-based. A user requested (or re-requested with a refresh) the latest positions from the browser, which passed the request to the <code>Aircraft Positions</code> application, which in turn relayed the request to the <code>PlaneFinder</code> application. Responses then were returned from one to the next, to the next. The last chapter segment replaced the midsection of our distributed system with an event-driven architecture. Now whenever <code>PlaneFinder</code> retrieves positions from the upstream radio device, it pushes those positions to a streaming platform pipeline and the <code>Aircraft Positions</code> app consumes them. The last mile (or kilometer, if you prefer) is still pull-based, however; updates must be requested via browser refresh, either manually or automatically.</p>

<p>Standard request-response semantics work brilliantly for numerous use cases, but they largely lack the ability for the responding “server” side to, independent of any request, initiate a transmission to the requestor. There are various workarounds and clever ways to satisfy this use case—each of which has its own pros and cons, and some of the best of which I discuss in subsequent chapters—but one of the more versatile options is WebSocket.</p>








<section data-type="sect2" data-pdf-bookmark="What Is WebSocket?"><div class="sect2" id="idm45693951732744">
<h2>What Is WebSocket?</h2>

<p>In a nutshell, WebSocket is a full-duplex communications protocol that connects two systems over a single TCP connection. Once a WebSocket connection is established, either party can initiate a transmission to the other, and the designated server application can maintain numerous client connections, enabling low-overhead broadcast and chat types of systems. WebSocket connections are forged from standard HTTP connections using the HTTP upgrade header, and once the handshake is complete, the protocol used for the connection shifts from HTTP to WebSocket.</p>

<p><a data-type="indexterm" data-primary="IETF (Internet Engineering Task Force)" id="idm45693951730520"/>WebSocket was standardized by the IETF in 2011, and by now every major browser and programming language supports it. Compared to HTTP requests and responses, WebSocket is extremely low overhead; transmissions don’t have to identify themselves and the terms of their communication with each transmission, thus reducing WebSocket framing to a few bytes. With its full-duplex capabilities, the ability of a server to handle a multiple of the number of open connections other options can support, and its low overhead, WebSocket is a useful tool for developers to have in their toolbox.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Refactoring the Aircraft Positions Application"><div class="sect2" id="idm45693951728856">
<h2>Refactoring the Aircraft Positions Application</h2>

<p>Although I refer to the <code>Aircraft Positions</code> application as a single unit, the <em>aircraft-positions</em> project comprises both the backend Spring Boot+Java application and the frontend HTML+JavaScript functionality. During development, both portions execute in a single environment, usually the developer’s machine. While they are built, tested, and deployed as a single unit to production settings as well, execution in production settings is divided as follows:</p>

<ul>
<li>
<p>Backend Spring+Java code is run in the cloud, including the template engine (if applicable) that generates final webpages to deliver to the end user.</p>
</li>
<li>
<p>Frontend HTML+JavaScript—static and/or generated content—is displayed and run in the end user’s browser, wherever that browser may be located.</p>
</li>
</ul>

<p>In this section, I leave existing functionality intact and add the ability to the system to automatically display aircraft positions as they are reported via a live feed. With a WebSocket connection in place between frontend and backend applications, the backend app is free to push updates to the end user’s browser and update the display automatically, with no need to trigger a page refresh.</p>










<section data-type="sect3" data-pdf-bookmark="Additional dependencies"><div class="sect3" id="idm45693951722632">
<h3>Additional dependencies</h3>

<p>To add WebSocket capabilities to the <code>Aircraft Positions</code> application, I need add only a single dependency to its <em>pom.xml</em>:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;dependency&gt;</code>
	<code class="nt">&lt;groupId&gt;</code>org.springframework.boot<code class="nt">&lt;/groupId&gt;</code>
	<code class="nt">&lt;artifactId&gt;</code>spring-boot-starter-websocket<code class="nt">&lt;/artifactId&gt;</code>
<code class="nt">&lt;/dependency&gt;</code></pre>

<p>A quick refresh of the project’s dependencies and we’re on to the next step.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Handling WebSocket connections and messages"><div class="sect3" id="idm45693951715400">
<h3>Handling WebSocket connections and messages</h3>

<p><a data-type="indexterm" data-primary="WebSocketHandler" id="idm45693951713544"/>Spring offers a couple of different approaches for configuring and using WebSocket, but I recommend following the clean lines of a direct implementation based on the <code>WebSocketHandler</code> interface. Owing to the frequency of requirements for exchanging text-based, i.e., nonbinary, information, there is even a <code>TextWebSocketHandler</code> class. I build on that here:</p>

<pre data-type="programlisting">@RequiredArgsConstructor
@Component
public class WebSocketHandler extends TextWebSocketHandler {
    private final List&lt;WebSocketSession&gt; sessionList = new ArrayList&lt;&gt;();
    @NonNull
    private final AircraftRepository repository;

    public List&lt;WebSocketSession&gt; getSessionList() {
        return sessionList;
    }

    @Override
    public void afterConnectionEstablished(WebSocketSession session)
            throws Exception {
        sessionList.add(session);
        System.out.println("Connection established from " + session.toString() +
            " @ " + Instant.now().toString());
    }

    @Override
    protected void handleTextMessage(WebSocketSession session,
            TextMessage message) throws Exception {
        try {
            System.out.println("Message received: '" +
                message + "', from " + session.toString());

            for (WebSocketSession sessionInList : sessionList) {
                if (sessionInList != session) {
                    sessionInList.sendMessage(message);
                    System.out.println("--&gt; Sending message '"
                        + message + "' to " + sessionInList.toString());
                }
            }
        } catch (Exception e) {
                System.out.println("Exception handling message: " +
            e.getLocalizedMessage());
        }
    }

    @Override
    public void afterConnectionClosed(WebSocketSession session,
            CloseStatus status) throws Exception {
        sessionList.remove(session);
        System.out.println("Connection closed by " + session.toString() +
            " @ " + Instant.now().toString());
    }
}</pre>

<p>The preceding code implements two of the <code>WebSocketHandler</code> interface’s methods, <code>afterConnectionEstablished</code> and <code>afterConnectionClosed</code>, to maintain a <code>List</code> of active <code>WebSocketSession</code> and <code>log connections</code> and <code>disconnections</code>. I also implement <code>handleTextMessage</code>, broadcasting any incoming message to all other active sessions. This single class provides the WebSocket capability for the backend, ready to be activated when aircraft positions are received from <code>PlaneFinder</code> via RabbitMQ.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Broadcasting aircraft positions to WebSocket connections"><div class="sect3" id="idm45693951702168">
<h3>Broadcasting aircraft positions to WebSocket connections</h3>

<p><a data-type="indexterm" data-primary="RabbitMQ" id="idm45693951700888"/><a data-type="indexterm" data-primary="@Autowired" id="idm45693951699960"/>In its previous iteration, the <code>PositionRetriever</code> class consumed aircraft position lists received via RabbitMQ messages and stored them in the in-memory H2 database. I build on that now by replacing the logging confirmation 
<span class="keep-together"><code>System.out::println</code></span> call with a call to a new <code>sendPositions()</code> method, whose purpose is to use the newly added <code>@Autowired</code> <code>WebSocketHandler</code> bean to send the latest list of aircraft positions to all WebSocket-connected clients:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@AllArgsConstructor</code>
<code class="nd">@Configuration</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PositionRetriever</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">AircraftRepository</code> <code class="n">repository</code><code class="o">;</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">WebSocketHandler</code> <code class="n">handler</code><code class="o">;</code>

    <code class="nd">@Bean</code>
    <code class="n">Consumer</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Aircraft</code><code class="o">&gt;&gt;</code> <code class="nf">retrieveAircraftPositions</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">acList</code> <code class="o">-&gt;</code> <code class="o">{</code>
            <code class="n">repository</code><code class="o">.</code><code class="na">deleteAll</code><code class="o">();</code>

            <code class="n">repository</code><code class="o">.</code><code class="na">saveAll</code><code class="o">(</code><code class="n">acList</code><code class="o">);</code>

            <code class="n">sendPositions</code><code class="o">();</code>
        <code class="o">};</code>
    <code class="o">}</code>

    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">sendPositions</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">if</code> <code class="o">(</code><code class="n">repository</code><code class="o">.</code><code class="na">count</code><code class="o">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="o">)</code> <code class="o">{</code>
            <code class="k">for</code> <code class="o">(</code><code class="n">WebSocketSession</code> <code class="n">sessionInList</code> <code class="o">:</code> <code class="n">handler</code><code class="o">.</code><code class="na">getSessionList</code><code class="o">())</code> <code class="o">{</code>
                <code class="k">try</code> <code class="o">{</code>
                    <code class="n">sessionInList</code><code class="o">.</code><code class="na">sendMessage</code><code class="o">(</code>
                        <code class="k">new</code> <code class="nf">TextMessage</code><code class="o">(</code><code class="n">repository</code><code class="o">.</code><code class="na">findAll</code><code class="o">().</code><code class="na">toString</code><code class="o">())</code>
                    <code class="o">);</code>
                <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>
                    <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>
                <code class="o">}</code>
            <code class="o">}</code>
        <code class="o">}</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Now that we have WebSocket configured properly and have a way for the backend to broadcast aircraft positions to connected WebSocket clients as soon as a new position list is received, the next step is to provide a way for the backend application to listen for and accept connection requests. <a data-type="indexterm" data-primary="WebSocketConfigurer" id="idm45693963467912"/>This is accomplished by registering the 
<span class="keep-together"><code>WebSocketHandler</code></span> created earlier via the <code>WebSocketConfigurer</code> interface and annotating the new <code>@Configuration</code> class with <code>@EnableWebSocket</code> to direct the application to process WebSocket requests:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Configuration</code>
<code class="nd">@EnableWebSocket</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">WebSocketConfig</code> <code class="kd">implements</code> <code class="n">WebSocketConfigurer</code> <code class="o">{</code>
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">WebSocketHandler</code> <code class="n">handler</code><code class="o">;</code>

    <code class="n">WebSocketConfig</code><code class="o">(</code><code class="n">WebSocketHandler</code> <code class="n">handler</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">handler</code> <code class="o">=</code> <code class="n">handler</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">registerWebSocketHandlers</code><code class="o">(</code><code class="n">WebSocketHandlerRegistry</code> <code class="n">registry</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">registry</code><code class="o">.</code><code class="na">addHandler</code><code class="o">(</code><code class="n">handler</code><code class="o">,</code> <code class="s">"/ws"</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>
<span class="keep-together">In the <code>registerWebSocketHandlers(WebSocketHandlerRegistry registry)</code> method,</span> I tie the <code>WebSocketHandler</code> bean created earlier to the endpoint 
<span class="keep-together"><em>ws://&lt;hostname:hostport&gt;/ws</em></span>. The application will listen on this endpoint for HTTP requests with WebSocket upgrade headers and act accordingly when one is received.</p>

<p><a data-type="indexterm" data-primary="WebSocket Secure" id="idm45693951411864"/><a data-type="indexterm" data-primary="HTTPS" id="idm45693951411192"/></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If HTTPS is enabled for your application, <em>wss://</em> (WebSocket Secure) would be used in place of <em>ws://</em>.</p>
</div>
</div></section>













<section data-type="sect3" data-pdf-bookmark="WebSocket in back, WebSocket in front"><div class="sect3" id="idm45693951536952">
<h3>WebSocket in back, WebSocket in front</h3>

<p>With the backend work done, it’s time to collect the payoff in the frontend 
<span class="keep-together">functionality.</span></p>

<p>To create a simple example of how WebSocket enables the backend app to push updates unprompted by the user and their browser, I create the following file with a single HTML division and label and a few lines of JavaScript and place it in the project’s <em>src/main/resources/static</em> directory along with the existing <em>index.html</em>:</p>

<pre data-type="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Aircraft Position Report (Live Updates)&lt;/title&gt;
    &lt;script&gt;
        var socket = new WebSocket('ws://' + window.location.host + '/ws');

        socket.onopen = function () {
            console.log(
              'WebSocket connection is open for business, bienvenidos!');
        };

        socket.onmessage = function (message) {
            var text = "";
            var arrAC = message.data.split("Aircraft");
            var ac = "";

            for (i = 1; i &lt; arrAC.length; i++) {
                ac = (arrAC[i].endsWith(", "))
                    ? arrAC[i].substring(0, arrAC[i].length - 2)
                    : arrAC[i]

                text += "Aircraft" + ac + "\n\n";
            }

            document.getElementById("positions").innerText = text;
        };

        socket.onclose = function () {
            console.log('WebSocket connection closed, hasta la próxima!');
        };
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Current Aircraft Positions&lt;/h1&gt;
&lt;div style="border-style: solid; border-width: 2px; margin-top: 15px;
        margin-bottom: 15px; margin-left: 15px; margin-right: 15px;"&gt;
    &lt;label id="positions"&gt;&lt;/label&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

<p>As short as this page is, it could be shorter. The <code>socket.onopen</code> and <code>socket.onclose</code> function definitions are logging functions that could be omitted, and <code>socket.onmessage</code> could almost certainly be refactored by someone with actual JavaScript chops and the desire to do so. These are the key bits:</p>

<ul>
<li>
<p>The defined division and label in the HTML at bottom</p>
</li>
<li>
<p>The <code>socket</code> variable that establishes and references a WebSocket connection</p>
</li>
<li>
<p>The <code>socket.onmessage</code> function that parses the aircraft position list and assigns the reformatted output to the HTML “positions” label’s <code>innerText</code></p>
</li>
</ul>

<p>Once we rebuild and execute the project, it is of course possible to simply access the <em>wspositions.html</em> page directly from the browser. This is a poor way to create an application for actual users, though—providing no way to access a page and its functionality unless they know its location and enter it manually into the address bar—and it does nothing to set the table for upcoming chapters’ expansions to this example.</p>

<p>Keeping it simple for the time being, I add another line to the existing <em>index.html</em> to allow the user to navigate to the <em>wspositions.html</em> WebSocket-driven page in addition to the existing one:</p>

<pre data-type="programlisting" data-code-language="html"><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>
<code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;title&gt;</code>Retrieve Aircraft Position Report<code class="nt">&lt;/title&gt;</code>
<code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;body&gt;</code>
    <code class="nt">&lt;p&gt;&lt;a</code> <code class="na">href=</code><code class="s">"/aircraft"</code><code class="nt">&gt;</code>Click here<code class="nt">&lt;/a&gt;</code> to retrieve current aircraft positions
        in range of receiver.<code class="nt">&lt;/p&gt;</code>
    <code class="nt">&lt;p&gt;&lt;a</code> <code class="na">href=</code><code class="s">"/wspositions.html"</code><code class="nt">&gt;</code>Click here<code class="nt">&lt;/a&gt;</code> to retrieve a livestream of
        current aircraft positions in range of receiver.<code class="nt">&lt;/p&gt;</code>
<code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>

<p>With frontend work now complete, it’s time to test the WebSocket waters.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="The results"><div class="sect3" id="idm45693951334568">
<h3>The results</h3>

<p>From the IDE, I launch the <code>Aircraft Positions</code> application and <code>PlaneFinder</code>. Opening a browser window, I access the frontend application at <em>localhost:8080</em>, as shown in <a data-type="xref" href="#aircraft_positions_landing_page_now_with_two_options">Figure 7-3</a>.</p>

<figure><div id="aircraft_positions_landing_page_now_with_two_options" class="figure">
<img src="Images/sbur_0703.png" alt="sbur 0703" width="600" height="165"/>
<h6><span class="label">Figure 7-3. </span>Aircraft Positions landing page, now with two options</h6>
</div></figure>

<p>From the still rather rudimentary landing page, choosing the second option—<em>Click here</em> to retrieve a livestream of current aircraft positions in range of receiver—produces the <em>wspositions.html</em> page and results similar to those shown in <a data-type="xref" href="#aircraft_position_report_with_live_updates_via_websocket">Figure 7-4</a>.</p>

<figure><div id="aircraft_position_report_with_live_updates_via_websocket" class="figure">
<img src="Images/sbur_0704.png" alt="sbur 0704" width="600" height="391"/>
<h6><span class="label">Figure 7-4. </span>Aircraft Position report with live updates via WebSocket</h6>
</div></figure>

<p>It’s a trivial exercise to convert the database record format shown with JSON, and just a bit more involved to dynamically populate a table with results received live from the backend application via WebSocket. Please refer to this book’s code repositories for examples.</p>
<div data-type="tip"><h6>Tip</h6>
<p>It’s perfectly fine to build and run both the <code>PlaneFinder</code> and <code>Aircraft Positions</code> applications from the command line; while I do so on occasion, for most build/run cycles, I find it much faster to run (and debug) directly from within the IDE.<a data-type="indexterm" data-primary="" data-startref="ix_spring_mvc_ch7" id="idm45693951366840"/><a data-type="indexterm" data-primary="" data-startref="ix_aircraftpos_websocket" id="idm45693951365864"/><a data-type="indexterm" data-primary="" data-startref="ix_spring_mvc_websocket" id="idm45693951364952"/></p>
</div>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm45693951363752">
<h1>Summary</h1>

<p>Nearly every application must interact with end users or other applications in some manner to provide real utility, and that requires useful and efficient means of interaction.</p>

<p>This chapter introduced view technologies—template languages/tags like Thymeleaf and engines that process them—and how Spring Boot uses them to create and deliver functionality to an end user’s browser. Also introduced was how Spring Boot handles static content like standard HTML along with JavaScript that can be delivered directly without processing by template engines. The chapter’s first project iteration showed examples of both with a Thymeleaf-driven application that retrieved and displayed aircraft positions within range at the time of the request, an entirely pull-based model.</p>

<p>The chapter next showed how to harness the power of messaging platforms from Spring Boot using Spring Cloud Stream and RabbitMQ. The <code>PlaneFinder</code> application was refactored to push a list of current aircraft positions, each time retrieved from the upstream device, and the <code>Aircraft Positions</code> app was modified to accept new aircraft position listings as they arrived via the RabbitMQ pipeline. This replaced the pull-based model between the two applications with a push-based one, making the backend functionality of the <code>Aircraft Positions</code> app event-driven. The front end functionality still required a refresh (either manual or hard-coded) to update results shown to the user.</p>

<p>Finally, implementing a WebSocket connection and handler code within backend and frontend components of the <code>Aircraft Positions</code> application enabled the Spring+Java backend app to push aircraft position updates <em>as they are received</em> via a 
<span class="keep-together">RabbitMQ</span> pipeline from <code>PlaneFinder</code>. Position updates are shown live in a simple HTML+JavaScript page and require no update requests be issued by the end user or their browser, showcasing WebSocket’s bidirectional nature, lack of required request-response pattern (or workaround), and low communication overhead.</p>
<div data-type="tip"><h1>Code Checkout Checkup</h1>
<p>For complete chapter code, please check out branch <em>chapter7end</em> from the code repository.</p>
</div>

<p>The next chapter introduces reactive programming and describes how Spring is leading the development and advancement of numerous tools and technologies that make it one of the best possible solutions for numerous use cases. More specifically, I’ll demonstrate how to use Spring Boot and Project Reactor to drive database access, integrate reactive types with view technologies like Thymeleaf, and take interprocess communication to unexpected new levels.</p>
</div></section>







</div></section></div></body></html>