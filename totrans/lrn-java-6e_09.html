<html><head></head><body><section data-pdf-bookmark="Chapter 9. Threads" data-type="chapter" epub:type="chapter"><div class="chapter" id="learnjava6-CHP-9">&#13;
<h1><span class="label">Chapter 9. </span>Threads</h1>&#13;
&#13;
&#13;
<p>We take for <a data-primary="threads" data-type="indexterm" id="ix_thread_ch9"/>granted that modern computer systems can manage many applications and operating system (OS) tasks running concurrently and make it appear that all the software is running simultaneously. Most systems today have multiple processors or multiple cores or both, and they can achieve an impressive degree of concurrency. The OS still juggles applications at a higher level but turns its attention from one to the next so quickly that they also appear to run at once.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In programming, <em>concurrent</em> operation <a data-primary="concurrency" data-type="indexterm" id="id1754"/><a data-primary="parallel programming" data-type="indexterm" id="id1755"/>denotes multiple, typically unrelated tasks running at the same time. Think of a fast-food cook preparing multiple orders on a grill. <em>Parallel</em> operation usually involves breaking up a large task into related subtasks that can be run alongside each other to produce the final result more quickly. Our cook could prepare a bacon double cheeseburger “in parallel” by tossing two patties and some bacon on the grill at the same time. In either case, programmers talk more generally about these tasks and subtasks occurring <em>simultaneously</em>. That’s not to say everything starts and stops at the same exact instant, but it does mean that the execution times for those tasks overlap.</p>&#13;
</div>&#13;
&#13;
<p>In the old days, the unit of concurrency for an operating system was the application or <em>process</em>. To the OS, a process was more or less a black box that decided what to do on its own. If an application required greater concurrency, it could get it only by running multiple processes and communicating between them, but this was a heavyweight approach and not very elegant.</p>&#13;
&#13;
<p>Later, operating systems added the concept of threads. Conceptually, a <em>thread</em> is a flow of control within a program. (You may have heard of a “thread of execution,” for example.) Threads provide fine-grained concurrency within a process under the application’s own control. Threads have existed for a long time but have historically been tricky to use. The Java concurrency utilities address common patterns and practices in multithreaded applications and raise them to the level of tangible methods and classes. Collectively, this means that Java supports threading at both higher and lower levels.</p>&#13;
&#13;
<p>This broad support makes it easier for programmers to write multithreaded code, and for compilers and runtimes to optimize that code. It also means that Java’s APIs take full advantage of threading, so it’s important that you gain some degree of familiarity with these concepts early in your exploration of Java. Not all developers will need to write applications that explicitly use threads or concurrency, but most will use some feature that involves them.</p>&#13;
&#13;
<p>Threads are integral to the design of many Java APIs, especially those involved in client-side applications, graphics, and sound. For example, when we look at GUI programming in <a data-type="xref" href="ch12.html#learnjava6-CHP-12">Chapter 12</a>, you’ll see that a component’s <code>paint()</code> method isn’t called directly by the application but rather by a separate drawing thread within the Java runtime system. <a data-primary="threads" data-secondary="background" data-type="indexterm" id="id1756"/><a data-primary="background threads" data-type="indexterm" id="id1757"/>At any given time, many such background threads may be <span class="keep-together">performing</span> activities alongside your application—yet you still get timely updates to your screen. On the server side, Java threads are there as well, servicing every request and running your application. It’s important to understand how your code fits into that environment.</p>&#13;
&#13;
<p>In this chapter, we’ll talk about writing applications that create and use their own threads explicitly. We’ll talk about the low-level thread support built into the Java language first and then discuss the <code>java.util.concurrent</code> thread utilities package. We’ll also tackle the new virtual threads previewed in Java 19 under the moniker of Project Loom.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introducing Threads" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-1">&#13;
<h1>Introducing Threads</h1>&#13;
&#13;
<p>A thread is similar to the notion of a <em>process</em>, or running program, except that different threads within the same application are much more closely related and share much of the same state than different programs running on the same machine. It’s kind of like a golf course that many golfers use at the same time. The threads cooperate to share a working area. They take turns and wait for other threads. They have access to the same objects, including static and instance variables, within their application. However, threads have their own copies of local variables, just as players share the golf course or a golf cart but do not share clubs or balls.</p>&#13;
&#13;
<p>Multiple <a data-primary="threads" data-secondary="synchronization of" data-type="indexterm" id="id1758"/><a data-primary="synchronization, threads" data-type="indexterm" id="id1759"/>threads in an application have the same problems as golfers on a course—in a word, <em>synchronization</em>. Just as you can’t have two sets of players playing the same green at the same time, you can’t have several threads trying to access the same variables without some kind of coordination. Otherwise, someone is bound to get hurt. A thread can reserve the right to use an object until it’s finished with its task, just as a golf party gets exclusive rights to the green until each of that party’s players finishes. And a thread that is more important can raise its priority, asserting its right to “play through.”</p>&#13;
&#13;
<p>The devil is in the details, of course, and those details have long made threads difficult to use. Fortunately, Java makes creating, controlling, and coordinating threads simpler by integrating some of these concepts directly into the language.</p>&#13;
&#13;
<p>It’s common to stumble over threads when you first work with them. Creating a thread will exercise many of your new Java skills all at once. Just remember that two players are always involved in running a thread: a Java <code>Thread</code> object that represents the thread itself, and an arbitrary target object that contains the method the thread will execute. Later, we will see ways to combine these two roles, but those approaches just change the packaging, not the relationship.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Thread Class and the Runnable Interface" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-1.1">&#13;
<h2>The Thread Class and the Runnable Interface</h2>&#13;
&#13;
<p>All <a data-primary="Thread class" data-type="indexterm" id="ix_thread_class"/><a data-primary="Runnable interface" data-type="indexterm" id="ix_runnable_inter"/><a data-primary="java.lang package" data-secondary="Runnable interface" data-type="indexterm" id="ix_java_lang_runnable"/>execution in Java is associated with a <code>Thread</code> object, beginning with a “main” thread that the JVM starts to launch your application. A new thread is born when you create an instance of the <code>java.lang.Thread</code> class. The <code>Thread</code> object <span class="keep-together">represents</span> a real thread in the Java interpreter and serves as a handle for controlling and coordinating its execution. With it, you can start the thread, wait for it to complete, cause it to sleep for a time, or interrupt its activity.</p>&#13;
&#13;
<p>The constructor for the <code>Thread</code> class accepts information about where the thread should begin its execution. We would like to tell it what method to run. There are a number of ways to do this. The classic approach uses the <code>java.lang.Runnable</code> interface to mark an object that contains a “runnable” method.</p>&#13;
&#13;
<p><code>Runnable</code> defines a single, <a data-primary="run() method" data-secondary="Runnable interface" data-type="indexterm" id="id1760"/>general-purpose <code>run()</code> method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">interface</code> <code class="nc">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">abstract</code><code class="w"> </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Every thread begins its life by executing the <code>run()</code> method in a <code>Runnable</code> object, which is the “target object” passed to the thread’s constructor. The <code>run()</code> method can contain any code, but it must be public, take no arguments, have no return value, and throw no checked exceptions.</p>&#13;
&#13;
<p>Any class that contains an appropriate <code>run()</code> method can declare that it implements the <code>Runnable</code> interface. An instance of this class becomes a runnable object that can serve as the target of a new thread. If you don’t want to put the <code>run()</code> method directly in your object (and very often you don’t), you can always make an adapter class that serves as the <code>Runnable</code> for you. The adapter’s <code>run()</code> method can then call any method it wants after the thread is started. We’ll show examples of these options later.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating and starting threads" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-1.1.1">&#13;
<h3>Creating and starting threads</h3>&#13;
&#13;
<p>A newly born <a data-primary="start() method" data-secondary="Thread" data-type="indexterm" id="id1761"/>thread remains idle until we give it a figurative slap on the bottom by calling its <code>start()</code> method. The thread then wakes up and proceeds to execute the <code>run()</code> method of its target object. <code>start()</code> can be called only once in the lifetime of a thread. Once a thread starts, it continues running until the target object’s <code>run()</code> method either returns or throws an unchecked exception.</p>&#13;
&#13;
<p>The following <a data-primary="Animator class" data-type="indexterm" id="ix_animate_class"/><a data-primary="run() method" data-secondary="Animator class" data-type="indexterm" id="id1762"/>class, <code>Animator</code>, implements a <code>run()</code> method to drive a drawing loop. We could use something similar in our game to update the playing <code>Field</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Animator</code><code class="w"> </code><code class="kd">implements</code><code class="w"> </code><code class="n">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kt">boolean</code><code class="w"> </code><code class="n">animating</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">animating</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// move active apples one "frame"</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// repaint the field</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// pause</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// ...</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>To use it, create a <code>Thread</code> object, pass it an instance of <code>Animator</code> as its target object, and invoke its <code>start()</code> method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="n">Animator</code><code class="w"> </code><code class="n">myAnimator</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Animator</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">myThread</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">myAnimator</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">myThread</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/></pre>&#13;
&#13;
<p>We created an instance of our <code>Animator</code> class and passed it as the argument to the constructor for <code>myThread</code>. As shown in <a data-type="xref" href="#learnjava6-CHP-9-FIG-1">Figure 9-1</a>, when we call the <code>start()</code> method, <code>myThread</code> begins to execute <code>Animator</code>’s <code>run()</code> method.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-1">&#13;
<img alt="ljv6 0901" src="assets/ljv6_0901.png"/>&#13;
<h6><span class="label">Figure 9-1. </span>Animator as an implementation of <code>Runnable</code></h6>&#13;
</div></figure>&#13;
&#13;
<p>Let the show begin!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A natural-born thread" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-1.1.2">&#13;
<h3>A natural-born thread</h3>&#13;
&#13;
<p>The <code>Runnable</code> interface lets you make an arbitrary object the target of a thread, as in the previous example. This is the most important general usage of the <code>Thread</code> class. In most situations where you need to use threads, you’ll create a class (possibly a simple adapter class) that implements the <code>Runnable</code> interface.</p>&#13;
&#13;
<p>Another design option for creating a thread makes our target class a subclass of a type that is already runnable. As it turns out, the <code>Thread</code> class itself conveniently implements the <code>Runnable</code> interface; it has its own <code>run()</code> method, which we can override directly to do our bidding:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Animator</code><code class="w"> </code><code class="kd">extends</code><code class="w"> </code><code class="n">Thread</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kt">boolean</code><code class="w"> </code><code class="n">animating</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">animating</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// draw Frames</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// do other stuff ...</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The skeleton of our <code>Animator</code> class looks much the same as before, except that our class is now a subclass of <code>Thread</code>. To go along with this scheme, the default constructor of the <code>Thread</code> class makes itself the default target—that is, by default, the <code>Thread</code> executes its own <code>run()</code> method when we call the <code>start()</code> method, as shown in <a data-type="xref" href="#learnjava6-CHP-9-FIG-2">Figure 9-2</a>. Now our subclass can just override the <code>run()</code> method in the <code>Thread</code> class. (<code>Thread</code> itself defines an empty <code>run()</code> method.)</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-2">&#13;
<img alt="ljv6 0902" src="assets/ljv6_0902.png"/>&#13;
<h6><span class="label">Figure 9-2. </span>Animator as a subclass of <code>Thread</code></h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Next, we create an instance of <code>Animator</code> and call its <code>start()</code> method (which it also inherited from <code>Thread</code>):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="n">Animator</code><code class="w"> </code><code class="n">bouncy</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Animator</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">bouncy</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/></pre>&#13;
&#13;
<p>Extending <code>Thread</code> may seem like a convenient way to bundle a thread and its target <code>run()</code> method. However, this approach often isn’t the best design. If you extend <code>Thread</code> to implement a thread, you are saying you need a new type of object that is a kind of <code>Thread</code>, which exposes all of the public methods of the <code>Thread</code> class. While there is something satisfying about taking an object that’s primarily concerned with performing a task and making it a <code>Thread</code>, the actual situations where you’ll want to create a subclass of <code>Thread</code> should not be very common. In most cases, it is more natural to let the requirements of your program dictate the class structure and use <code>Runnable</code>s to connect the execution and logic of your program.<a data-primary="" data-startref="ix_java_lang_runnable" data-type="indexterm" id="id1763"/><a data-primary="" data-startref="ix_runnable_inter" data-type="indexterm" id="id1764"/><a data-primary="" data-startref="ix_thread_class" data-type="indexterm" id="id1765"/><a data-primary="" data-startref="ix_animate_class" data-type="indexterm" id="id1766"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controlling Threads" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-1.2">&#13;
<h2>Controlling Threads</h2>&#13;
&#13;
<p>Now that you have <a data-primary="threads" data-secondary="methods to control" data-type="indexterm" id="ix_thread_method"/><a data-primary="methods" data-secondary="threads" data-type="indexterm" id="ix_method_thread"/>seen the <code>start()</code> method used to begin executing a new thread, let’s look at instance methods that let you explicitly control a thread’s behavior at runtime:</p>&#13;
<dl>&#13;
<dt><code>Thread.sleep()</code> method</dt>&#13;
<dd>&#13;
<p>Causes the <a data-primary="sleep() method, Thread" data-type="indexterm" id="id1767"/>currently executing thread to wait for a designated period of time (give or take), without consuming much (or possibly any) CPU time.</p>&#13;
</dd>&#13;
<dt><code>wait()</code> and <code>join()</code> methods</dt>&#13;
<dd>&#13;
<p>Coordinate the <a data-primary="wait() method" data-type="indexterm" id="id1768"/><a data-primary="join() method, Thread" data-type="indexterm" id="id1769"/>execution of two or more threads. We’ll discuss them in detail when we talk about thread synchronization later in this chapter.</p>&#13;
</dd>&#13;
<dt><code>interrupt()</code> method</dt>&#13;
<dd>&#13;
<p>Wakes up a <a data-primary="interrupt() method, Thread" data-type="indexterm" id="id1770"/>thread that is sleeping in a <code>sleep()</code> or <code>wait()</code> operation or is otherwise blocked on a long I/O operation.<sup><a data-type="noteref" href="ch09.html#id1771" id="id1771-marker">1</a></sup></p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deprecated methods" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-1.2.1">&#13;
<h3>Deprecated methods</h3>&#13;
&#13;
<p>We should also <a data-primary="stop() method, Thread" data-type="indexterm" id="id1772"/><a data-primary="suspend() method, Thread" data-type="indexterm" id="id1773"/><a data-primary="start() method" data-secondary="Animator" data-type="indexterm" id="id1774"/><a data-primary="deprecated thread-control methods" data-type="indexterm" id="id1775"/><a data-primary="methods" data-secondary="deprecated thread-control" data-type="indexterm" id="id1776"/>mention three deprecated thread-control methods: <code>stop()</code>, &#13;
<span class="keep-together"><code>suspend()</code></span>, and <code>resume()</code>. The <code>stop()</code> method complements <code>start()</code>; it destroys the thread. <code>start()</code> and the deprecated <code>stop()</code> method can be called only once in the thread’s life cycle. By contrast, the deprecated <code>suspend()</code> and <code>resume()</code> methods arbitrarily pause and then restart the execution of a thread.</p>&#13;
&#13;
<p>Although these deprecated methods still exist in the latest version of Java (and will probably be there forever), they shouldn’t be used in new code development. The problem with both <code>stop()</code> and <code>suspend()</code> is that they seize control of a thread’s execution in an uncoordinated, harsh way.</p>&#13;
&#13;
<p>You can create and monitor a few variables as a better way to affect the execution of a thread (if these variables are <code>boolean</code>, you might see them referred to as “flags”). The early thread examples in this book use this technique in one way or another. Later examples will introduce some of the other control features available through the concurrency classes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The sleep() method" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-1.2.2">&#13;
<h3>The sleep() method</h3>&#13;
&#13;
<p>Programmers often <a data-primary="sleep() method, Thread" data-type="indexterm" id="id1777"/>need to tell a thread to sit idle, or “sleep,” for some period of time. You may need to wait for some external resource to become available, for example. Even our simple animation threads takes small pauses between frames. While a thread is asleep, or otherwise blocked from input of some kind, it doesn’t consume CPU time or compete with other threads for processing. For such pauses, we can call the static method <code>Thread.sleep()</code>, which affects the currently executing thread. The call causes the thread to go idle for a specified number of milliseconds:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// The current thread</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="mi">1000</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// someone woke us up prematurely</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The <code>sleep()</code> method may <a data-primary="InterruptedException" data-type="indexterm" id="id1778"/>throw an <code>InterruptedException</code> if it is interrupted by another thread via the <code>interrupt()</code> method (more below). As you saw in the previous code, the thread can catch this exception and take the opportunity to perform some action—such as checking a variable to determine whether or not the thread should exit—and then go back to sleep.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The join(), wait(), and notify() methods" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-1.2.3">&#13;
<h3>The join(), wait(), and notify() methods</h3>&#13;
&#13;
<p>If you need to <a data-primary="join() method, Thread" data-type="indexterm" id="id1779"/><a data-primary="notify() method, Thread" data-type="indexterm" id="id1780"/><a data-primary="wait() method" data-type="indexterm" id="id1781"/>coordinate a thread’s activities by waiting for another thread to complete its task, you can use the <code>join()</code> method. Calling a thread’s <code>join()</code> method causes that thread to block until the target thread completes. Alternatively, you can call <code>join()</code> with a number of milliseconds to wait as an argument. In this form, the calling thread waits until either the target thread completes or the specified period elapses. This is a very coarse form of thread synchronization.</p>&#13;
&#13;
<p>If you need to coordinate a thread’s activities with some other resource, such as checking the state of a file or network connection, you can use the <code>wait()</code> and <code>notify()</code> methods. Calling <code>wait()</code> on a thread will pause it, similar to using <code>join()</code>, but it will remain paused either until it gets <code>interrupt()</code>-ed by some other thread, or until you call <code>notify()</code> on the thread yourself.</p>&#13;
&#13;
<p>Java supports more general and powerful mechanisms for coordinating thread activity in the <code>java.util.concurrent</code> package. We’ll show you more of this package later in the chapter.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The interrupt() method" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-1.2.4">&#13;
<h3>The interrupt() method</h3>&#13;
&#13;
<p>The <code>interrupt()</code> method <a data-primary="interrupt() method, Thread" data-type="indexterm" id="id1782"/>does more or less what it says on the tin. It interrupts the normal flow of execution for a thread. If that thread was idle in a <code>sleep()</code>, <code>wait()</code>, or lengthy I/O operation, it will wake up. When you interrupt a thread, its <em>interrupt status</em> flag is set. You can test this flag with the <code>isInterrupted()</code> method. You can also use an alternate form, <code>isInterrupted(boolean)</code>, to indicate whether or not you want the thread to clear its interrupt status after retrieving the current value.</p>&#13;
&#13;
<p>While you probably won’t use <code>interrupt()</code> that often, it can definitely come in handy. If you have ever grown impatient while a desktop application tries—and fails—to connect to a server or database, you have experienced one of those moments where an interruption might be the right thing.</p>&#13;
&#13;
<p>Let’s simulate this scenario with a small graphical application. We’ll show a label on the screen and move it to a new, random location every five seconds. During that five-second pause, a click anywhere on the screen will interrupt the pause. We’ll change the message and then start the random move cycle again. You can run the full example from <em>ch09/examples/Interruption.java</em>, but <a data-type="xref" href="#learnjava6-CHP-9-FIG-interruption">Figure 9-3</a> highlights the flow and effect of calling <code>interrupt()</code>.<a data-primary="" data-startref="ix_method_thread" data-type="indexterm" id="id1783"/><a data-primary="" data-startref="ix_thread_method" data-type="indexterm" id="id1784"/></p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-interruption">&#13;
<img alt="ljv6 0903" src="assets/ljv6_0903.png"/>&#13;
<h6><span class="label">Figure 9-3. </span>Interrupting a thread</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Revisiting Animation with Threads" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-1.3">&#13;
<h2>Revisiting Animation with Threads</h2>&#13;
&#13;
<p>Managing <a data-primary="threads" data-secondary="animation with" data-type="indexterm" id="ix_thread_animate_ch9"/><a data-primary="animation" data-type="indexterm" id="ix_animate_ch9"/>animations is a common task in graphical interfaces. Sometimes the animations are subtle transitions; other times they are the focus of the application, as with our apple tossing game. We’ll look at two ways to handle the animation: using simple threads alongside the <code>sleep()</code> functions, and using a timer. Pairing one of those options with some type of stepping or “next frame” function is a popular approach that is also easy to understand.</p>&#13;
&#13;
<p>You can use a thread similar to <a data-type="xref" href="#learnjava6-CHP-9-SECT-1.1.1">“Creating and starting threads”</a> to produce real animation. The basic idea is to paint or position all of your animated objects, pause, move them to their next spots, and then repeat. Let’s take a look at how we draw some pieces of our game field without animation first. We’ll include a new <code>List</code> for any active apples in addition to the existing lists for trees and hedges. You can pull up this code in your editor from the <em>ch09/examples/game</em> folder:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// From the Field class...</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">protected</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">paintComponent</code><code class="p">(</code><code class="n">Graphics</code><code class="w"> </code><code class="n">g</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">g</code><code class="p">.</code><code class="na">setColor</code><code class="p">(</code><code class="n">fieldColor</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">g</code><code class="p">.</code><code class="na">fillRect</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="w"> </code><code class="n">getWidth</code><code class="p">(),</code><code class="w"> </code><code class="n">getHeight</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">physicist</code><code class="p">.</code><code class="na">draw</code><code class="p">(</code><code class="n">g</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">Tree</code><code class="w"> </code><code class="n">t</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">trees</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">t</code><code class="p">.</code><code class="na">draw</code><code class="p">(</code><code class="n">g</code><code class="p">);</code><code class="w"> </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">Hedge</code><code class="w"> </code><code class="n">h</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">hedges</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">h</code><code class="p">.</code><code class="na">draw</code><code class="p">(</code><code class="n">g</code><code class="p">);</code><code class="w"> </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">physicist</code><code class="p">.</code><code class="na">draw</code><code class="p">(</code><code class="n">g</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">Apple</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">apples</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="n">a</code><code class="p">.</code><code class="na">draw</code><code class="p">(</code><code class="n">g</code><code class="p">);</code><code class="w"> </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="c1">// And from the Apple class...</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">draw</code><code class="p">(</code><code class="n">Graphics</code><code class="w"> </code><code class="n">g</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Make sure our apple will be red, then paint it!</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">g</code><code class="p">.</code><code class="na">setColor</code><code class="p">(</code><code class="n">Color</code><code class="p">.</code><code class="na">RED</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">g</code><code class="p">.</code><code class="na">fillOval</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="w"> </code><code class="n">y</code><code class="p">,</code><code class="w"> </code><code class="n">scaledLength</code><code class="p">,</code><code class="w"> </code><code class="n">scaledLength</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We start by painting the <a data-primary="background threads" data-type="indexterm" id="id1785"/><a data-primary="threads" data-secondary="background" data-type="indexterm" id="id1786"/>background field, then the trees and hedges, then our physicist, and finally any apples. Painting the apples last guarantees that they will show “on top” of the other elements.</p>&#13;
&#13;
<p>What changes on the screen as you play? There are really only two “moveable” items: the apple our physicist is aiming, and any apples actively flying after being tossed. The physicist aims in response to user input (by moving the mouse or clicking a button). That doesn’t require separate animation, so we’ll add this functionality in <a data-type="xref" href="ch12.html#learnjava6-CHP-12">Chapter 12</a>. For now, we can concentrate on handling flying apples.</p>&#13;
&#13;
<p class="pagebreak-before">Our game’s animation step should move every apple that is active, according to the rules of gravity. First, we add a <code>toss()</code> method to our <code>Apple</code> class where we can set up the initial conditions for our apple using information from our physicist. (Since the physicist is not yet interactive, we’ll fake some data.) Then we make one move for a given apple in the <code>step()</code> method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// File: ch09/examples/game/Apple.java</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="c1">// Parameters provided by the physicist</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">toss</code><code class="p">(</code><code class="kt">float</code><code class="w"> </code><code class="n">angle</code><code class="p">,</code><code class="w"> </code><code class="kt">float</code><code class="w"> </code><code class="n">velocity</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">lastStep</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">System</code><code class="p">.</code><code class="na">currentTimeMillis</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="kt">double</code><code class="w"> </code><code class="n">radians</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">angle</code><code class="w"> </code><code class="o">/</code><code class="w"> </code><code class="mi">180</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="n">Math</code><code class="p">.</code><code class="na">PI</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">velocityX</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="kt">float</code><code class="p">)(</code><code class="n">velocity</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="n">Math</code><code class="p">.</code><code class="na">cos</code><code class="p">(</code><code class="n">radians</code><code class="p">)</code><code class="w"> </code><code class="o">/</code><code class="w"> </code><code class="n">mass</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Start negative since "up" means smaller values of y</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">velocityY</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="kt">float</code><code class="p">)(</code><code class="o">-</code><code class="n">velocity</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="n">Math</code><code class="p">.</code><code class="na">sin</code><code class="p">(</code><code class="n">radians</code><code class="p">)</code><code class="w"> </code><code class="o">/</code><code class="w"> </code><code class="n">mass</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">step</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Make sure the apple is still moving</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// using our lastStep tracker as a sentinel</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">lastStep</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Apply the law of gravity to the apple's vertical position</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">long</code><code class="w"> </code><code class="n">now</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">System</code><code class="p">.</code><code class="na">currentTimeMillis</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">float</code><code class="w"> </code><code class="n">slice</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="n">now</code><code class="w"> </code><code class="o">-</code><code class="w"> </code><code class="n">lastStep</code><code class="p">)</code><code class="w"> </code><code class="o">/</code><code class="w"> </code><code class="mf">1000.0f</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">velocityY</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">velocityY</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="p">(</code><code class="n">slice</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="n">Field</code><code class="p">.</code><code class="na">GRAVITY</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">int</code><code class="w"> </code><code class="n">newX</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="p">)(</code><code class="n">centerX</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">velocityX</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">int</code><code class="w"> </code><code class="n">newY</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="p">)(</code><code class="n">centerY</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">velocityY</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">setPosition</code><code class="p">(</code><code class="n">newX</code><code class="p">,</code><code class="w"> </code><code class="n">newY</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We start by calculating how fast the apple will move (the <code>velocityX</code> and <code>velocityY</code> variables) in the <code>toss()</code> method. In our <code>step()</code> method, we update the apple’s position based on those two velocities, then adjust the vertical velocity based on how strong our gravity is. It’s not very fancy, but it will produce a nice arc for the apples. We then put that code in a loop that will do the update calculations, repaint the field and apples, pause, and repeat:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// File: ch09/examples/game/Field.java</code><code class="w"/>&#13;
&#13;
<code class="c1">// duration of an animation frame in milliseconds</code><code class="w"/>&#13;
<code class="kd">public</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kd">final</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="n">STEP</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">40</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="c1">// ...</code><code class="w"/>&#13;
<code class="c1">// A simple inner class with our run() method</code><code class="w"/>&#13;
<code class="kd">class</code> <code class="nc">Animator</code><code class="w"> </code><code class="kd">implements</code><code class="w"> </code><code class="n">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// "animating" is a global variable that allows us</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// to stop animating and conserve resources</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// if there are no active apples to move</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">animating</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Stepping "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">apples</code><code class="p">.</code><code class="na">size</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">          </code><code class="s">" apples"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">Apple</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">apples</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">a</code><code class="p">.</code><code class="na">step</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Reach back to our outer class instance to repaint</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">Field</code><code class="p">.</code><code class="na">this</code><code class="p">.</code><code class="na">repaint</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// And get rid of any apples on the ground</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">cullFallenApples</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="n">STEP</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">ie</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Animation interrupted"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">animating</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We’ll use this implementation of <code>Runnable</code> in a simple thread. Our <code>Field</code> class will keep an instance of the thread around and contains the following simple <code>start</code> method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// File: ch09/examples/game/Field.java</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">Thread</code><code class="w"> </code><code class="n">animationThread</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="c1">// other state and methods ...</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kt">void</code><code class="w"> </code><code class="nf">startAnimation</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">animationThread</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">Animator</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">animationThread</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We’ll discuss events in <a data-type="xref" href="ch12.html#learnjava6-CHP-12-SECT-3">“Events”</a>; you’ll use those events to launch an apple on command. <a data-primary="" data-startref="ix_animate_ch9" data-type="indexterm" id="id1787"/><a data-primary="" data-startref="ix_thread_animate_ch9" data-type="indexterm" id="id1788"/>For now, we’ll just launch one apple automatically, as shown in <a data-type="xref" href="#learnjava6-CHP-9-FIG-3">Figure 9-4</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-3">&#13;
<img alt="ljv6 0904" src="assets/ljv6_0904.png"/>&#13;
<h6><span class="label">Figure 9-4. </span>Tossable apples in action</h6>&#13;
</div></figure>&#13;
&#13;
<p>It doesn’t look like much as a still screenshot, but it is amazing in person. ;^)</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Death of a Thread" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-2">&#13;
<h1>Death of a Thread</h1>&#13;
&#13;
<p>All good things come to an end. A <a data-primary="threads" data-secondary="termination of" data-type="indexterm" id="ix_thread_termin"/>thread continues to execute until one of the following three things happens:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It explicitly returns from its target <code>run()</code> method.</p>&#13;
</li>&#13;
<li>&#13;
<p>It encounters an uncaught runtime exception.</p>&#13;
</li>&#13;
<li>&#13;
<p>The nasty, deprecated <code>stop()</code> method is called.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>What happens if <a data-primary="run() method" data-secondary="Thread class" data-type="indexterm" id="id1789"/>none of these things occurs, and the <code>run()</code> method for a thread never terminates? The thread can live on, even after the code that created it has finished. You have to be aware of how threads eventually terminate, or your application can end up leaving orphaned threads running that consume resources unnecessarily, or even keep the application alive when it would otherwise quit.</p>&#13;
&#13;
<p>In many cases, you want <a data-primary="background threads" data-type="indexterm" id="id1790"/><a data-primary="threads" data-secondary="background" data-type="indexterm" id="id1791"/>background threads that do simple, periodic tasks in an application. <a data-primary="setDaemon() method, Thread" data-type="indexterm" id="id1792"/>You can create one of these background workers using the <code>setDaemon()</code> method  to mark a thread as a <em>daemon</em> thread. Daemon threads can terminate like other threads, but if the application that started them is quitting, they should be killed and discarded when no other nondaemon application threads remain.<sup><a data-type="noteref" href="ch09.html#id1793" id="id1793-marker">2</a></sup> Normally, the Java interpreter continues to run until all threads have completed. But when daemon threads are the only threads still alive, the interpreter will exit.</p>&#13;
&#13;
<p>Here’s a “devilish” outline using daemon threads:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Devil</code><code class="w"> </code><code class="kd">extends</code><code class="w"> </code><code class="n">Thread</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">Devil</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">setDaemon</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// perform some tasks</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>In this example, the <code>Devil</code> thread sets its daemon status when it is created. If any <code>Devil</code> threads remain when our application is otherwise complete, the runtime system terminates them for us. We don’t have to worry about cleaning them up.</p>&#13;
&#13;
<p>One final <a data-primary="Swing API" data-secondary="and thread death hangups" data-secondary-sortas="thread death hangups" data-type="indexterm" id="id1794"/>note about killing threads gracefully. New developers often encounter a common problem the first time they create an application using a graphical Swing component: their application never exits. The Java VM seems to hang indefinitely after everything is finished and the application window is closed. Java creates a UI thread to process input and painting events. This UI thread is not a daemon thread, so it doesn’t exit automatically when other application threads have completed. <a data-primary="exit() method" data-type="indexterm" id="id1795"/>The developer must call <code>System.exit()</code> explicitly. If you think about it, this makes sense. Because most GUI applications are event-driven and wait for user input, they would otherwise exit after their startup code completes.<a data-primary="" data-startref="ix_thread_termin" data-type="indexterm" id="id1796"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Virtual Threads" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-3">&#13;
<h1>Virtual Threads</h1>&#13;
&#13;
<p>Previewed in Java 19 and finalized in Java 21, Project Loom<sup><a data-type="noteref" href="ch09.html#id1797" id="id1797-marker">3</a></sup> brings lightweight, virtual threads to Java. One of the <a data-primary="virtual threads" data-type="indexterm" id="ix_virt_thread"/><a data-primary="threads" data-secondary="virtual" data-type="indexterm" id="ix_thread_virt"/>main goals of <a data-primary="Project Loom" data-type="indexterm" id="id1798"/>Project Loom is to improve the thread ecosystem in Java so that developers can put less energy into keeping multithreaded applications stable and more energy into solving higher-level problems.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview Feature Tangent" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-3.1">&#13;
<h2>Preview Feature Tangent</h2>&#13;
&#13;
<p>What do we mean by “previewed in Java 19”? Starting with Java 12, Oracle began <a data-primary="preview features" data-type="indexterm" id="ix_preview_feat"/>introducing some language features as <em>previews</em>. These preview features are well-specified and fully implemented but not wholly baked. Oracle may still make substantial modifications in future releases. Eventually, these features will either become permanent parts of the JDK or they will be removed. Oracle produces a language update page for each new release of Java that contains a nice history of recent changes to the language as well as an <a href="https://oreil.ly/5MuMw">overview of preview features</a> in general.</p>&#13;
&#13;
<p>Because any given preview feature may end up being dropped from Java, Oracle requires you to include special flags when you compile or run an application that uses it. This requirement is a small guardrail to make sure you don’t accidentally use code that may not work with a future release of Java.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuring IDEs for preview features" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-3.1.1">&#13;
<h3>Configuring IDEs for preview features</h3>&#13;
&#13;
<p>If you use an <a data-primary="IDE (Integrated Development Environment)" data-type="indexterm" id="id1799"/><a data-primary="Integrated Development Environment (IDE)" data-type="indexterm" id="id1800"/><a data-primary="IntelliJ IDEA" data-type="indexterm" id="id1801"/><a data-primary="IDEA (IntelliJ IDEA)" data-type="indexterm" id="id1802"/>IDE for the demos and exercises, you may need to configure it to support preview features. IntelliJ IDEA, for example, does not support preview features by default. You need to change a setting in the File → Project Structure dialog, as shown in <a data-type="xref" href="#learnjava6-CHP-9-FIG-idea-preview">Figure 9-5</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-idea-preview">&#13;
<img alt="ljv6 0905" src="assets/ljv6_0905.png"/>&#13;
<h6><span class="label">Figure 9-5. </span>Enabling Java’s preview features in IntelliJ IDEA</h6>&#13;
</div></figure>&#13;
&#13;
<p>After choosing the version of Java you want in the SDK drop-down, you can enable preview feature support by choosing the appropriate option under the Language level drop-down. (The features that IDEA lists next to the version numbers is not an exhaustive list.) Click OK after setting the language level, and IDEA should be ready to compile and run any code with preview features.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Renaming preview source files" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-3.1.2">&#13;
<h3>Renaming preview source files</h3>&#13;
&#13;
<p>The <code>VirtualDemo</code> class (<em>ch09/examples/VirtualDemo.java.preview</em>) uses a <a data-primary="VirtualDemo class" data-type="indexterm" id="id1803"/>virtual thread to pause briefly before issuing our favorite “Hello Java” greeting. Before you can compile or run it, you’ll need to rename it. We added the <em>.preview</em> suffix to any file that includes a preview feature in the code. The suffix stops IDEs like IntelliJ IDEA from proactively compiling them until you’ve had a chance to configure preview support, as we mentioned in the previous section.</p>&#13;
&#13;
<p>You can use the context (right-click) menu in IntelliJ IDEA to rename the file under the Refactor menu item. You can also rename a file quickly from a terminal in Linux or macOS using the <em>mv</em> command:</p>&#13;
&#13;
<pre data-type="programlisting">% cd ch09/examples&#13;
% mv VirtualDemo.java.preview VirtualDemo.java&#13;
% cd ../..</pre>&#13;
&#13;
<p>In a Windows terminal or command prompt, you can use the <em>rename</em> command:</p>&#13;
&#13;
<pre data-type="programlisting">C:\&gt; cd ch09\examples&#13;
C:\&gt; rename VirtualDemo.java.preview VirtualDemo.java&#13;
C:\&gt; cd ..\..</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Compiling classes with preview features" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-3.1.3">&#13;
<h3>Compiling classes with preview features</h3>&#13;
&#13;
<p>Oracle added a pair of <a data-primary="classes" data-secondary="compiling" data-type="indexterm" id="id1804"/><a data-primary="compiler" data-secondary="classes with preview features" data-type="indexterm" id="id1805"/><a data-primary="error handling" data-secondary="compiling a class with preview features" data-type="indexterm" id="id1806"/>command-line options for compiling code with preview features. If you try to compile our <code>VirtualDemo</code> source file with Java 19, for example, you’ll likely see an error similar to this:</p>&#13;
&#13;
<pre data-type="programlisting">% javac --version&#13;
javac 19.0.1&#13;
&#13;
% javac VirtualDemo.java&#13;
VirtualDemo.java:4: error: startVirtualThread(Runnable)&#13;
 is a preview API and is disabled by default.&#13;
    Thread thread = Thread.startVirtualThread(runnable);&#13;
                          ^&#13;
  (use --enable-preview to enable preview APIs)</pre>&#13;
&#13;
<p>The error gives us a hint as to how we should proceed. Let’s try adding the suggested flag and compiling again:</p>&#13;
&#13;
<pre data-type="programlisting">% javac --enable-preview VirtualDemo.java&#13;
error: --enable-preview must be used with either -source or --release</pre>&#13;
&#13;
<p>Rats! Another, different error. <a data-primary="--enable-preview flag" data-primary-sortas="enable-preview flag" data-type="indexterm" id="id1807"/><a data-primary="--release flag" data-primary-sortas="release flag" data-type="indexterm" id="id1808"/><a data-primary="-source flag" data-primary-sortas="source flag" data-type="indexterm" id="id1809"/>At least it also includes some hints. To compile, you need to provide <em>two</em> flags: <code>--enable-preview</code> and then either <code>-source</code> or <code>--release</code>.<sup><a data-type="noteref" href="ch09.html#id1810" id="id1810-marker">4</a></sup> The compiler uses <code>-source</code> to specify which language rules apply to the source code being compiled. (The compiled bytecode is still targeted at the same version of Java as your JDK.) You can use the <code>--release</code> option to specify both the source version and the bytecode version.</p>&#13;
&#13;
<p>While there are many scenarios where you might need to compile for older systems, preview features are meant for use with the current version of the JDK. As such, when we use any preview features in the book, we’ll be pairing <code>--enable-preview</code> with <code>--release</code> and simply give the same release version as our version of Java. Returning to our virtual thread preview feature, for example, we can use Java 19 to try it out. Our final, correct <em>javac</em> call looks like this:</p>&#13;
&#13;
<pre data-type="programlisting">% javac --version&#13;
javac 19.0.1&#13;
&#13;
% javac --enable-preview --release 19 VirtualDemo.java&#13;
Note: VirtualDemo.java uses preview features of Java SE 19.&#13;
Note: Recompile with -Xlint:preview for details.</pre>&#13;
&#13;
<p>The “notes” that appear after your compilation completes are purely informational. They remind you that your code relies on an unstable feature that may not be available in the future. The note is not meant to dissuade you from using these features, but if you are planning to share your code with other users or developers, you will have some extra compatibility contraints to remember.</p>&#13;
&#13;
<p>If you’re curious, <a data-primary="-Xlint:preview" data-primary-sortas="Xlint:preview" data-type="indexterm" id="id1811"/>you can use the <code>-Xlint:preview</code> option mentioned in the notes to see exactly what preview code caused the warning:</p>&#13;
&#13;
<pre data-type="programlisting">src$ javac --enable-preview --release 19 -Xlint:preview VirtualDemo.java&#13;
VirtualDemo.java:4: warning: [preview] startVirtualThread(Runnable)&#13;
 is a preview API and may be removed in a future release.&#13;
    Thread thread = Thread.startVirtualThread(runnable);&#13;
                          ^&#13;
1 warning</pre>&#13;
&#13;
<p>No surprises there, but then again, this is just a tiny demo program. With larger programs or code developed in teams, that extra <code>-Xlint:preview</code> flag can be very handy.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running preview class files" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-3.1.4">&#13;
<h3>Running preview class files</h3>&#13;
&#13;
<p>Running Java <a data-primary="classes" data-secondary="running preview class files" data-type="indexterm" id="id1812"/>classes that include preview features also requires the <code>--enable-preview</code> flag. If you try to run <code>VirtualDemo</code> with Java 19 as you would any other class, you’ll get an error like this:</p>&#13;
&#13;
<pre data-type="programlisting">% java VirtualDemo&#13;
Error: LinkageError occurred while loading main class VirtualDemo&#13;
        java.lang.UnsupportedClassVersionError: Preview features are not&#13;
        enabled for VirtualDemo (class file version 63.65535).&#13;
        Try running with '--enable-preview'</pre>&#13;
&#13;
<p>Again, you can use the flag mentioned in the error, <code>--enable-preview</code>, and you’re good to go:</p>&#13;
&#13;
<pre data-type="programlisting">% java --enable-preview VirtualDemo&#13;
Hello virtual thread! ID: 20</pre>&#13;
&#13;
<p>If you want to play with a preview feature in <em>jshell</em>, you can also provide the same <code>--enable-preview</code> flag:</p>&#13;
&#13;
<pre data-type="programlisting">% jshell --enable-preview</pre>&#13;
&#13;
<p>Including that flag would allow a Java 19 <em>jshell</em> session to use virtual threads, just as it allowed us to run our demo program above.<a data-primary="" data-startref="ix_preview_feat" data-type="indexterm" id="id1813"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Quick Comparison" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-3.2">&#13;
<h2>A Quick Comparison</h2>&#13;
&#13;
<p>The Loom team designed its virtual threads to be easy to use if you already have some skill with Java threads. Let’s rework the trivial thread example that we used to test the <code>--enable-preview</code> flag to show both types of thread:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code class="w"> </code><code class="kd">class</code> <code class="nc">VirtualDemo2</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">args</code><code class="o">[]</code><code class="p">)</code><code class="w"> </code><code class="kd">throws</code><code class="w"> </code><code class="n">Exception</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Runnable</code><code class="w"> </code><code class="n">runnable</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Runnable</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Thread</code><code class="w"> </code><code class="n">t</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">currentThread</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Hello thread! "</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">(</code><code class="n">t</code><code class="p">.</code><code class="na">isVirtual</code><code class="p">()</code><code class="w"> </code><code class="o">?</code><code class="w"> </code><code class="s">"virtual "</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="s">"platform "</code><code class="p">)</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">            </code><code class="s">"ID: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">t</code><code class="p">.</code><code class="na">threadId</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">};</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">thread1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">runnable</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">thread1</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">thread2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">startVirtualThread</code><code class="p">(</code><code class="n">runnable</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">thread1</code><code class="p">.</code><code class="na">join</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">thread2</code><code class="p">.</code><code class="na">join</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>In this reworking, we expanded our anonymous <code>Runnable</code> inner class to do a little sleuthing on the current thread. We print out the thread’s identification number and whether or not it’s a virtual thread. But look how similar (and simple) the lines are that launch the two threads: they both accept our <code>runnable</code> object and “fit” in the <code>Thread</code> class. For developers with established code, switching to use these virtual threads should be straightforward. Here’s the output after compiling and running (with the appropriate preview flags, of course):</p>&#13;
&#13;
<pre data-type="programlisting">$ javac --enable-preview --source 19 VirtualDemo2.java&#13;
Note: VirtualDemo.java uses preview features of Java SE 19.&#13;
Note: Recompile with -Xlint:preview for details.&#13;
&#13;
$ java --enable-preview VirtualDemo2&#13;
Hello thread! virtual ID: 21&#13;
Hello thread! platform ID: 20</pre>&#13;
&#13;
<p>Both threads run as expected. One thread does indeed report itself as a virtual thread. We use the word <em>platform</em> to describe the other thread, since that’s what the Oracle documentation calls them. Platform threads represent a direct, one-to-one relationship with the <em>native</em> threads your operating system (the platform) provides. Virtual threads, on the other hand, have an indirect, many-to-one relationship with native threads from the operating system, as shown in <a data-type="xref" href="#learnjava6-CHP-9-FIG-loom-threads">Figure 9-6</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-loom-threads">&#13;
<img alt="ljv6 0906" src="assets/ljv6_0906.png"/>&#13;
<h6><span class="label">Figure 9-6. </span>Platform and virtual threads map differently to native threads</h6>&#13;
</div></figure>&#13;
&#13;
<p>This separation is one of the key design features of virtual threads. It allows Java to have many (many!) threads going at once without the performance costs of creating and managing corresponding native threads. Virtual threads are designed to be inexpensive to create and highly performant once they are up and running.<a data-primary="" data-startref="ix_thread_virt" data-type="indexterm" id="id1814"/><a data-primary="" data-startref="ix_virt_thread" data-type="indexterm" id="id1815"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Synchronization" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-4">&#13;
<h1>Synchronization</h1>&#13;
&#13;
<p>Every <a data-primary="threads" data-secondary="synchronization of" data-type="indexterm" id="ix_thread_sync"/><a data-primary="time-slicing, threads" data-type="indexterm" id="id1816"/><a data-primary="synchronization, threads" data-type="indexterm" id="ix_sync_thread"/>thread has a mind of its own. Normally, a thread goes about its business without any regard for what other threads in the application are doing. Threads may be <em>time-sliced</em>, which means they can run in arbitrary spurts and bursts as directed by the OS. On a multiprocessor or multicore system, it is even possible for many different threads to be running simultaneously on different CPUs. This section is about coordinating the activities of two or more threads so that they can work together and use the same variables and methods (without colliding, like players on the golf course).</p>&#13;
&#13;
<p>Java provides a few simple structures for synchronizing the activities of threads. They are all based on the concept of monitors, a widely used synchronization scheme. You don’t have to know the details about how monitors work to be able to use them, but it may help you to have <a data-type="xref" href="#learnjava6-CHP-9-FIG-thread-monitor">Figure 9-7</a> in mind.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-thread-monitor">&#13;
<img alt="ljv6 0907" src="assets/ljv6_0907.png"/>&#13;
<h6><span class="label">Figure 9-7. </span>Synchronizing access with a monitor</h6>&#13;
</div></figure>&#13;
&#13;
<p>A <em>monitor</em> is <a data-primary="monitors, thread synchronization" data-type="indexterm" id="id1817"/>essentially a lock. The lock is attached to a resource that many threads may need to access but that should be accessed by only one thread at a time. It’s very much like a restroom with a lock on the door; if it’s unlocked, you can enter, and you lock the door while you are using it. If the resource is not being used, a thread can acquire the lock and access the resource. When the thread is done, it relinquishes the lock, just as you unlock the restroom door and leave it open for the next person (or thread).</p>&#13;
&#13;
<p>If another thread already has the lock for the resource, however, all other threads must wait until the current thread is done and releases the lock. This is just like when the restroom is occupied when you arrive: you have to wait until the current user is done and unlocks the door.</p>&#13;
&#13;
<p>Java makes it fairly easy to synchronize access to resources. The language handles setting up and acquiring locks; all you need to do is specify the resources to synchronize.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Serializing Access to Methods" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-4.1">&#13;
<h2>Serializing Access to Methods</h2>&#13;
&#13;
<p>The most <a data-primary="serializing/serialized methods" data-type="indexterm" id="ix_serial_method"/><a data-primary="methods" data-secondary="serializing/serialized" data-type="indexterm" id="ix_method_serial"/>common reason to synchronize threads in Java is to serialize their access to a resource (like an object or variable)—in other words, to make sure that only one thread at a time can manipulate that object.<sup><a data-type="noteref" href="ch09.html#id1818" id="id1818-marker">5</a></sup> In <a data-primary="synchronized keyword" data-type="indexterm" id="ix_sync_key"/>Java, every class and every instance of a class has its own lock. The <code>synchronized</code> keyword marks places where a thread must acquire the lock before proceeding.</p>&#13;
&#13;
<p>For example, suppose we implement a <code>SpeechSynthesizer</code> class that contains a <code>say()</code> method. We don’t want multiple threads calling <code>say()</code> at the same time because we wouldn’t be able to understand anything the synthesizer says. <a data-primary="locking threads" data-type="indexterm" id="id1819"/><a data-primary="threads" data-secondary="locking" data-type="indexterm" id="id1820"/>So we mark the <code>say()</code> method as <code>synchronized</code>, which means that a thread must acquire the lock on the <code>SpeechSynthesizer</code> object before it can speak:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">SpeechSynthesizer</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">synchronized</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">say</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">words</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// speak the supplied words</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>When <code>say()</code> has completed, the calling thread gives up the lock, which allows the next waiting thread to acquire the lock and run the method. It doesn’t matter whether the thread is owned by the <code>SpeechSynthesizer</code> itself or some other object; every thread must acquire the same lock from the <code>SpeechSynthesizer</code> instance. If <code>say()</code> were a class (static) method instead of an instance method, we could still mark it as <code>synchronized</code>. In this case, because no instance object is involved, the lock is on the <code>SpeechSynthesizer</code> class object itself.</p>&#13;
&#13;
<p>Often, you want to synchronize multiple methods of the same class so that only one method modifies or examines the data in the class at a time. All static synchronized methods in a class use the same class-object lock. By the same token, all instance methods in a class use the same instance-object lock. This guarantees that only one of a set of synchronized methods is running at a time. For example, a <code>SpreadSheet</code> class might contain several instance variables that represent cell values, as well as some methods that manipulate all of the cells in a row:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">SpreadSheet</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kt">int</code><code class="w"> </code><code class="n">cellA1</code><code class="p">,</code><code class="w"> </code><code class="n">cellA2</code><code class="p">,</code><code class="w"> </code><code class="n">cellA3</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">synchronized</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="nf">sumRow</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="n">cellA1</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">cellA2</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">cellA3</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">synchronized</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">setRow</code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">a1</code><code class="p">,</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="n">a2</code><code class="p">,</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="n">a3</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">cellA1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">a1</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">cellA2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">a2</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">cellA3</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">a3</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="c1">// other spreadsheet stuff ...</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The methods <code>setRow()</code> and <code>sumRow()</code> both access the cell values. You can see that problems might arise if one thread was changing the values of the variables in <code>setRow()</code> at the same moment another thread was reading the values in <code>sumRow()</code>. To prevent this, we mark both methods as <code>synchronized</code>. When threads encounter synchronized resources, only one thread runs at a time. If a thread is in the middle of executing <code>setRow()</code> when another thread attempts to call <code>sumRow()</code>, the second thread must wait until the first one finishes executing <code>setRow()</code> before it runs <code>sumRow()</code>. This synchronization allows us to preserve the consistency of the <code>SpreadSheet</code>. The best part is that all this locking and waiting is handled by Java; it’s invisible to the programmer.</p>&#13;
&#13;
<p>In addition to synchronizing entire methods, the <code>synchronized</code> keyword can be used in a special construct to guard smaller blocks of code inside a method. In this form, it also takes an explicit argument that specifies which object’s lock to acquire:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="kd">synchronized</code><code class="w"> </code><code class="p">(</code><code class="n">myObject</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Functionality that needs exclusive access to resources</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>This synchronized block can appear in any method. When a thread reaches it, the thread must acquire the lock on <code>myObject</code> before proceeding. In this way, we can synchronize methods (or parts of methods) in different classes in the same way as methods in the same class.<a data-primary="" data-startref="ix_sync_key" data-type="indexterm" id="id1821"/></p>&#13;
&#13;
<p>This means that a synchronized instance method is equivalent to a method with its statements synchronized on the current object:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="kd">synchronized</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">myMethod</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// method body</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>is equivalent to:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="kt">void</code><code class="w"> </code><code class="nf">myMethod</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">synchronized</code><code class="w"> </code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// method body</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We can demonstrate the basics of synchronization with a classic “producer/consumer” scenario. Say we have some producers creating new resources and consumers grabbing and using those same resources: for instance a series of web crawlers picking up images online. The “producer” in this could be a thread (or multiple threads) doing the actual work of loading and parsing web pages to look for images and their URLs. We can tell it to place those URLs in a common queue. The “consumer” thread(s) would pick up the next URL in the queue and download the image to the filesystem or a database. We won’t try to do all of the real I/O here (more on URLs and networking in <a data-type="xref" href="ch13.html#learnjava6-CHP-13">Chapter 13</a>), but let’s set up some producing and consuming threads to show you how the synchronization works.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Synchronizing a queue of URLs" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-4.1.1">&#13;
<h3>Synchronizing a queue of URLs</h3>&#13;
&#13;
<p>Let’s <a data-primary="LinkedList class" data-type="indexterm" id="id1822"/>look first at the queue where the URLs will be stored. It’s just a list where we can append URLs (as <code>String</code>s) to the end and pull them off from the front. We’ll use a <code>LinkedList</code> similar to the <code>ArrayList</code> we saw in <a data-type="xref" href="ch07.html#learnjava6-CHP-7">Chapter 7</a>. We want a structure designed for efficient access and manipulation:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code><code class="w"> </code><code class="nn">ch09.examples</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="kn">import</code><code class="w"> </code><code class="nn">java.util.LinkedList</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="kd">public</code><code class="w"> </code><code class="kd">class</code> <code class="nc">URLQueue</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">LinkedList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="w"> </code><code class="n">urlQueue</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">LinkedList</code><code class="o">&lt;&gt;</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">synchronized</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">addURL</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">url</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">urlQueue</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">url</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">synchronized</code><code class="w"> </code><code class="n">String</code><code class="w"> </code><code class="nf">getURL</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="o">!</code><code class="n">urlQueue</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="n">urlQueue</code><code class="p">.</code><code class="na">removeFirst</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="kc">null</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">boolean</code><code class="w"> </code><code class="nf">isEmpty</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="n">urlQueue</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Note that not every method is synchronized! Any thread can ask if the queue is empty without holding up other threads that might be adding or removing items. This <em>does</em> mean that <code>isEmpty()</code> might report a wrong answer—if the timing of different threads is exactly wrong. Fortunately, our system is somewhat fault-tolerant, so the efficiency of not locking the queue just to check its size wins out over more perfect knowledge.<sup><a data-type="noteref" href="ch09.html#id1823" id="id1823-marker">6</a></sup></p>&#13;
&#13;
<p>Now that we <a data-primary="run() method" data-secondary="URL Producer" data-type="indexterm" id="id1824"/><a data-primary="URLProducer class" data-type="indexterm" id="id1825"/>know how we’ll be storing and retrieving the URLs, we can create the producer and consumer classes. The producer will run a loop to simulate a web crawler by making up fake URLs. It will prefix those URLs with a producer ID, and then store them in our queue. Here’s the <code>run()</code> method for <code>URLProducer</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">&lt;=</code><code class="w"> </code><code class="n">urlCount</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="o">++</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s">"https://some.url/at/path/"</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">i</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">queue</code><code class="p">.</code><code class="na">addURL</code><code class="p">(</code><code class="n">producerID</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">producerID</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" produced "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="n">delay</code><code class="p">.</code><code class="na">nextInt</code><code class="p">(</code><code class="mi">500</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">ie</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Producer "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">producerID</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" interrupted. Quitting."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The consumer class is similar, with the obvious exception of taking URLs out of the queue. It will pull a URL out, prefix it with a consumer ID, and start over until the producers are done producing and the queue is empty:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">keepWorking</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="o">!</code><code class="n">queue</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">queue</code><code class="p">.</code><code class="na">getURL</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">url</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">consumerID</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" consumed "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">consumerID</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" skipped empty queue"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="n">delay</code><code class="p">.</code><code class="na">nextInt</code><code class="p">(</code><code class="mi">1000</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">ie</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Consumer "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">consumerID</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">            </code><code class="s">" interrupted. Quitting."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We can start by running our simulation with very small numbers: two producers and two consumers. Each producer will create only three URLs:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code class="w"> </code><code class="kd">class</code> <code class="nc">URLDemo</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">args</code><code class="o">[]</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URLQueue</code><code class="w"> </code><code class="n">queue</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLQueue</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URLProducer</code><code class="w"> </code><code class="n">p1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLProducer</code><code class="p">(</code><code class="s">"P1"</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="n">queue</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URLProducer</code><code class="w"> </code><code class="n">p2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLProducer</code><code class="p">(</code><code class="s">"P2"</code><code class="p">,</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"> </code><code class="n">queue</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URLConsumer</code><code class="w"> </code><code class="n">c1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLConsumer</code><code class="p">(</code><code class="s">"C1"</code><code class="p">,</code><code class="w"> </code><code class="n">queue</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URLConsumer</code><code class="w"> </code><code class="n">c2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLConsumer</code><code class="p">(</code><code class="s">"C2"</code><code class="p">,</code><code class="w"> </code><code class="n">queue</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Starting..."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">tp1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">p1</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">tp1</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">tp2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">p2</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">tp2</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">tc1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">c1</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">tc1</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">tc2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">c2</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">tc2</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Wait for the producers to finish creating urls</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">tp1</code><code class="p">.</code><code class="na">join</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">tp2</code><code class="p">.</code><code class="na">join</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">ie</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Interrupted waiting for producers to finish"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">c1</code><code class="p">.</code><code class="na">setKeepWorking</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">c2</code><code class="p">.</code><code class="na">setKeepWorking</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Now wait for the workers to clean out the queue</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">tc1</code><code class="p">.</code><code class="na">join</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">tc2</code><code class="p">.</code><code class="na">join</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">ie</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Interrupted waiting for consumers to finish"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Done"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Even with these tiny numbers involved, you can still see the effects of using multiple threads to do the work:</p>&#13;
&#13;
<pre data-type="programlisting">Starting...&#13;
C1 skipped empty queue&#13;
C2 skipped empty queue&#13;
P2 produced https://some.url/at/path/1&#13;
P1 produced https://some.url/at/path/1&#13;
P1 produced https://some.url/at/path/2&#13;
P2 produced https://some.url/at/path/2&#13;
C2 consumed P2 https://some.url/at/path/1&#13;
P2 produced https://some.url/at/path/3&#13;
P1 produced https://some.url/at/path/3&#13;
C1 consumed P1 https://some.url/at/path/1&#13;
C1 consumed P1 https://some.url/at/path/2&#13;
C2 consumed P2 https://some.url/at/path/2&#13;
C1 consumed P2 https://some.url/at/path/3&#13;
C1 consumed P1 https://some.url/at/path/3&#13;
Done</pre>&#13;
&#13;
<p>The threads don’t take perfect, round-robin turns, but every thread does get at least some work time. And the consumers are not locked to specific producers. The idea is to make efficient use of limited resources. Producers can keep adding tasks without worrying about how long each task will take or whom to assign it to. Consumers, in turn, can grab a task without worry about other consumers. If one consumer gets handed a simple task and finishes before other consumers, it can go back and get a new task right away.</p>&#13;
&#13;
<p>Try running this example yourself and bump up some of those numbers. What happens with hundreds of URLs? What happens with hundreds of producers or consumers? At scale, this type of multitasking is almost required. You won’t find large programs out there that don’t use threads to manage at least some of their background work. Java’s own graphical package, Swing, needs a separate thread to keep the UI responsive and correct, no matter how small your application is.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Synchronizing virtual threads" data-type="sect3"><div class="sect3" id="learnjava6-CHP-9-SECT-4.1.2">&#13;
<h3>Synchronizing virtual threads</h3>&#13;
&#13;
<p>What about <a data-primary="threads" data-secondary="virtual" data-type="indexterm" id="id1826"/><a data-primary="virtual threads" data-type="indexterm" id="id1827"/>virtual threads? Do they have the same concurrency concerns? Mostly yes. Though lightweight, virtual threads still represent the standard “thread of execution” concept. They can still interrupt each other in messy ways and must still coordinate access to shared resources. But happily, the design goals of Project Loom come to the rescue. We can reuse all of our synchronizing tricks with virtual threads. In fact, to virtual thread-ify our URL producing-and-consuming demo, all we need to do is replace the chunk of code in the <code>main()</code> method that starts the threads:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// file: URLDemo2.java</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Starting virtual threads..."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Convert these two-step lines:</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">//Thread tp1 = new Thread(p1);</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">//tp1.start();</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// To these simpler, create-and-start lines:</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">vp1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">startVirtualThread</code><code class="p">(</code><code class="n">p1</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">vp2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">startVirtualThread</code><code class="p">(</code><code class="n">p2</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">vc1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">startVirtualThread</code><code class="p">(</code><code class="n">c1</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">vc2</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">startVirtualThread</code><code class="p">(</code><code class="n">c2</code><code class="p">);</code><code class="w"/></pre>&#13;
&#13;
<p>The virtual threads honor the <code>synchronized</code> keyword in our <code>URLQueue</code> methods and understand the <code>join()</code> calls just like platform threads. If you compile <code>URLDemo2.java</code> and run it (don’t forget you may need to enable preview features), you will see the same output as before, with small variations from the random pauses, of course.</p>&#13;
&#13;
<p>We said virtual threads <em>mostly</em> have the same concurrency concerns as platform threads. We added that because creating and running virtual threads is a lot cheaper than managing a pool of platform threads so you don’t overwhelm the operating system. (Recall that each platform thread is mapped to one native thread.) You don’t pool virtual threads—you just make more.<a data-primary="" data-startref="ix_method_serial" data-type="indexterm" id="id1828"/><a data-primary="" data-startref="ix_serial_method" data-type="indexterm" id="id1829"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Accessing Class and Instance Variables from Multiple Threads" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-4.2">&#13;
<h2>Accessing Class and Instance Variables from Multiple Threads</h2>&#13;
&#13;
<p>In the <code>SpreadSheet</code> example, we <a data-primary="threads" data-secondary="multithreading" data-type="indexterm" id="id1830"/><a data-primary="variables" data-secondary="instance" data-type="indexterm" id="id1831"/><a data-primary="variables" data-secondary="static" data-type="indexterm" id="id1832"/><a data-primary="instance variables" data-type="indexterm" id="id1833"/><a data-primary="class (static) variables" data-type="indexterm" id="id1834"/><a data-primary="multithreading" data-type="indexterm" id="id1835"/><a data-primary="static (class) variables" data-type="indexterm" id="id1836"/><a data-primary="accessor methods" data-type="indexterm" id="id1837"/>guarded access to a set of instance variables with a synchronized method in order to avoid a thread changing one of the variables while another thread was reading the others, to keep them coordinated.</p>&#13;
&#13;
<p>But what about <a data-primary="references" data-secondary="and threads" data-secondary-sortas="threads" data-type="indexterm" id="id1838"/>individual variable types? Do they need to be synchronized? Normally, no. Almost all operations on primitives and object reference types in Java happen <span class="keep-together"><em>atomically</em>:</span> that is, the JVM handles them in one step, with no opportunity for two threads to collide. This prevents threads from looking at references while other threads are accessing them.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Watch out—the <a data-primary="atomic operations" data-type="indexterm" id="id1839"/><a data-primary="JVM (Java Virtual Machine)" data-type="indexterm" id="id1840"/>JVM specification does not guarantee it will handle <code>double</code> and <code>long</code> primitive types atomically. Both of these types represent 64-bit values. The problem has to do with how the JVM’s stack works. You should synchronize access to your <code>double</code> and <code>long</code> instance variables through accessor methods or use an atomic wrapper class, which we’ll describe in <a data-type="xref" href="#learnjava6-CHP-9-SECT-7">“Concurrency Utilities”</a>.<a data-primary="" data-startref="ix_sync_thread" data-type="indexterm" id="id1841"/><a data-primary="" data-startref="ix_thread_sync" data-type="indexterm" id="id1842"/></p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scheduling and Priority" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-5">&#13;
<h1>Scheduling and Priority</h1>&#13;
&#13;
<p>Java makes few <a data-primary="scheduling and priority, threads" data-type="indexterm" id="ix_sched_priorit_thread"/><a data-primary="threads" data-secondary="scheduling and priority" data-type="indexterm" id="ix_thread_sched"/><a data-primary="priorities, threads" data-type="indexterm" id="ix_priorit_thread"/>guarantees about how it schedules threads. Almost all thread scheduling is left up to the Java implementation and, to some degree, the application. Java’s designers could have specified a scheduling algorithm, but a single algorithm isn’t suitable for all the roles that Java can play. Instead, Java’s designers put the burden on you to write robust code that works no matter the scheduling algorithm, and let the implementation tune the algorithm for the best fit.</p>&#13;
&#13;
<p>The priority rules in the Java language specification are carefully worded to be a general guideline for thread scheduling. You should be able to rely on this behavior overall (statistically), but it is not a good idea to write code that relies on very specific features of the scheduler to work properly. Instead, use the control and synchronization tools described in this chapter to coordinate your threads.<sup><a data-type="noteref" href="ch09.html#id1843" id="id1843-marker">7</a></sup></p>&#13;
&#13;
<p>Every <a data-primary="round-robin thread scheduling" data-type="indexterm" id="id1844"/>thread has a priority. In general, any time a thread of a higher priority than the current thread becomes runnable (is started, stops sleeping, or is notified), it preempts the lower-priority thread and begins executing. On some systems, threads with the same priority are scheduled <em>round-robin</em>, which means once a thread starts to run, it continues until it does one of the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Sleeps, by calling <code>Thread.sleep()</code> or <code>wait()</code></p>&#13;
</li>&#13;
<li>&#13;
<p>Waits for a lock, in order to run a <code>synchronized</code> method</p>&#13;
</li>&#13;
<li>&#13;
<p>Blocks an I/O, for example, in a <code>read()</code> or <code>accept()</code> call</p>&#13;
</li>&#13;
<li>&#13;
<p>Explicitly yields control, by calling <code>yield()</code></p>&#13;
</li>&#13;
<li>&#13;
<p>Terminates by completing its target method<sup><a data-type="noteref" href="ch09.html#id1845" id="id1845-marker">8</a></sup></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>This situation looks something like <a data-type="xref" href="#learnjava6-CHP-9-FIG-4">Figure 9-8</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-4">&#13;
<img alt="ljv6 0908" src="assets/ljv6_0908.png"/>&#13;
<h6><span class="label">Figure 9-8. </span>Priority-preemptive round-robin scheduling</h6>&#13;
</div></figure>&#13;
&#13;
<p>You can set a <a data-primary="getPriority() method, Thread" data-type="indexterm" id="id1846"/><a data-primary="setPriority() method, Thread" data-type="indexterm" id="id1847"/>priority on a platform thread with the <code>setPriority()</code> method and you can see a thread’s current priority using the complementary <code>getPriority()</code> call. The priorities must fall within a range, bounded by the <code>Thread</code> class constants <code>MIN_PRIORITY</code> and <code>MAX_PRIORITY</code>. The default priority is held in the constant <code>NORM_PRIORITY</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Virtual <a data-primary="threads" data-secondary="virtual" data-type="indexterm" id="id1848"/><a data-primary="virtual threads" data-type="indexterm" id="id1849"/>threads all run with <code>NORM_PRIORITY</code>. If you call <code>setPriority()</code> on a virtual thread, the new priority you pass will simply be ignored.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Thread State" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-5.1">&#13;
<h2>Thread State</h2>&#13;
&#13;
<p>At any <a data-primary="getState() method, Thread" data-type="indexterm" id="id1850"/><a data-primary="threads" data-secondary="thread state" data-type="indexterm" id="id1851"/>given time in its life cycle, a thread is in one of five general states. You can query them using the <code>getState()</code> method of the <code>Thread</code> class:</p>&#13;
<dl>&#13;
<dt><code>NEW</code></dt>&#13;
<dd>&#13;
<p>The thread has been created but has not yet started.</p>&#13;
</dd>&#13;
<dt><code>RUNNABLE</code></dt>&#13;
<dd>&#13;
<p>The thread is in its normal active state, even if it is blocked in an I/O operation, like a read or write to a file or a network connection.</p>&#13;
</dd>&#13;
<dt><code>BLOCKED</code></dt>&#13;
<dd>&#13;
<p>The thread is blocked, waiting to enter a synchronized method or code block. This includes times when a thread has been awakened by a <code>notify()</code> and is attempting to reacquire its lock after a <code>wait()</code>.</p>&#13;
</dd>&#13;
<dt><code>WAITING, TIMED_WAITING</code></dt>&#13;
<dd>&#13;
<p>The thread is waiting for another thread via a call to <code>wait()</code> or <code>join()</code>. In the case of <code>TIMED_WAITING</code>, the call has a timeout.</p>&#13;
</dd>&#13;
<dt><code>TERMINATED</code></dt>&#13;
<dd>&#13;
<p>The thread has completed due to a return, an exception, or being stopped.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>You can show the state of all platform threads in the current thread group with the following snippet of code:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="o">[]</code><code class="w"> </code><code class="n">threads</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="w"> </code><code class="o">[</code><code class="w"> </code><code class="mi">64</code><code class="w"> </code><code class="o">]</code><code class="p">;</code><code class="w"> </code><code class="c1">// max threads to show</code><code class="w"/>&#13;
<code class="w">    </code><code class="kt">int</code><code class="w"> </code><code class="n">num</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Thread</code><code class="p">.</code><code class="na">enumerate</code><code class="p">(</code><code class="n">threads</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="n">num</code><code class="p">;</code><code class="w"> </code><code class="n">i</code><code class="o">++</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">       </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">threads</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="w"> </code><code class="o">+</code><code class="s">":"</code><code class="o">+</code><code class="w"> </code><code class="n">threads</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">.</code><code class="na">getState</code><code class="p">());</code><code class="w"/></pre>&#13;
&#13;
<p>The <code>Thread.enumerate()</code> call will <a data-primary="enumerate() method, Thread" data-type="indexterm" id="id1852"/>populate our <code>threads</code> array up to its length. You probably won’t use this method in general programming, but it is interesting and useful for experimenting and learning about Java threads.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Time-Slicing" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-5.2">&#13;
<h2>Time-Slicing</h2>&#13;
&#13;
<p>In addition to <a data-primary="time-slicing, threads" data-type="indexterm" id="ix_time_slice_thread"/><a data-primary="threads" data-secondary="time-slicing" data-type="indexterm" id="ix_thread_time_slice"/>prioritization, all modern systems (with the exception of some embedded and “micro” Java environments) implement thread <em>time-slicing</em>. In a time-sliced system, thread processing is chopped up so that each thread runs for a short period of time before the context is switched to the next thread, as shown in <a data-type="xref" href="#learnjava6-CHP-9-FIG-5">Figure 9-9</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-9-FIG-5">&#13;
<img alt="ljv6 0909" src="assets/ljv6_0909.png"/>&#13;
<h6><span class="label">Figure 9-9. </span>Priority-preemptive time-sliced scheduling</h6>&#13;
</div></figure>&#13;
&#13;
<p>Higher-priority threads still preempt lower-priority threads in this scheme. Adding time-slicing mixes up the processing among threads of the same priority; on a multiprocessor machine, threads may even be run simultaneously. This can change the behavior of applications that don’t use threads and synchronization properly.</p>&#13;
&#13;
<p>Strictly <a data-primary="round-robin thread scheduling" data-type="indexterm" id="id1853"/>speaking, because Java doesn’t guarantee time-slicing, you shouldn’t write code that relies on this type of scheduling; any software you write should function under round-robin scheduling. If you’re wondering what your particular flavor of Java does, try the following experiment:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code class="w"> </code><code class="kd">class</code> <code class="nc">Thready</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">args</code><code class="w"> </code><code class="o">[]</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">ShowThread</code><code class="p">(</code><code class="s">"Foo"</code><code class="p">)).</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">ShowThread</code><code class="p">(</code><code class="s">"Bar"</code><code class="p">)).</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">static</code><code class="w"> </code><code class="kd">class</code> <code class="nc">ShowThread</code><code class="w"> </code><code class="kd">implements</code><code class="w"> </code><code class="n">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">message</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="n">ShowThread</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">message</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">this</code><code class="p">.</code><code class="na">message</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">message</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">message</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>When you run this example, you will see how your Java implementation does its scheduling. The <code>Thready</code> class starts up two <code>ShowThread</code> objects. <code>ShowThread</code> is a thread that goes into an unending loop<sup><a data-type="noteref" href="ch09.html#id1854" id="id1854-marker">9</a></sup> (generally bad form, but useful for this demonstration) and prints its message. Because we don’t specify a priority for either thread, they both inherit the priority of their creator, so they have the same priority. Under a round-robin scheme, only <code>Foo</code> should be printed; <code>Bar</code> should never appear. In a time-slicing implementation, you should occasionally see the <code>Foo</code> and <code>Bar</code> messages alternate.</p>&#13;
&#13;
<p>The <em>ch09/examples</em> folder also contains a <code>VirtualThready</code> example if you want to see how virtual threads behave. They run with a “work-stealing” scheduler. (Feel free to dive into the <a href="https://oreil.ly/qzfe0">official Oracle docs</a> on the fork/join framework where this algorithm is laid out.) We had to add some <code>join()</code> calls to the virtual thread version. Unlike the platform threads, virtual threads will not keep the JVM “awake” without these explicit requests to wait for the threads to complete.<a data-primary="" data-startref="ix_thread_time_slice" data-type="indexterm" id="id1855"/><a data-primary="" data-startref="ix_time_slice_thread" data-type="indexterm" id="id1856"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Priorities" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-5.3">&#13;
<h2>Priorities</h2>&#13;
&#13;
<p>Thread priorities are a general guideline for how the JVM should allocate time among competing threads. Unfortunately, Java platform threads are mapped to native threads in such complex ways that you can’t rely upon the exact meaning of priorities. Instead, consider them a hint to the JVM.</p>&#13;
&#13;
<p>Let’s play with the priority of our threads:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Thready2</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kd">static</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">args</code><code class="w"> </code><code class="o">[]</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">foo</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">ShowThread</code><code class="p">(</code><code class="s">"Foo"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">foo</code><code class="p">.</code><code class="na">setPriority</code><code class="p">(</code><code class="n">Thread</code><code class="p">.</code><code class="na">MIN_PRIORITY</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Thread</code><code class="w"> </code><code class="n">bar</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">ShowThread</code><code class="p">(</code><code class="s">"Bar"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">bar</code><code class="p">.</code><code class="na">setPriority</code><code class="p">(</code><code class="n">Thread</code><code class="p">.</code><code class="na">MAX_PRIORITY</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="n">foo</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">bar</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>You might expect that with this change to our <code>Thready2</code> class, the <code>Bar</code> thread will take over completely. If you run this code on an old Solaris implementation of Java 5.0, that’s exactly what happens. The same is not true on most modern versions of Java. Similarly, if you change the priorities to values other than min and max, you may not see any difference at all. The subtleties of priority and performance relate to how Java threads and priorities are mapped to real threads in the OS. <a data-primary="" data-startref="ix_priorit_thread" data-type="indexterm" id="id1857"/><a data-primary="" data-startref="ix_sched_priorit_thread" data-type="indexterm" id="id1858"/><a data-primary="" data-startref="ix_thread_sched" data-type="indexterm" id="id1859"/>For this reason, you should generally reserve adjusting thread priorities for system and framework <span class="keep-together">development.</span></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Thread Performance" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-6">&#13;
<h1>Thread Performance</h1>&#13;
&#13;
<p>The use of <a data-primary="threads" data-secondary="performance" data-type="indexterm" id="ix_thread_perf"/><a data-primary="performance" data-secondary="threads" data-type="indexterm" id="ix_perf_thread"/>threads has dictated the form and functionality of several Java packages.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Cost of Synchronization" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-6.1">&#13;
<h2>The Cost of Synchronization</h2>&#13;
&#13;
<p>Acquiring locks to <a data-primary="threads" data-secondary="synchronization of" data-type="indexterm" id="id1860"/><a data-primary="locking threads" data-type="indexterm" id="id1861"/><a data-primary="threads" data-secondary="locking" data-type="indexterm" id="id1862"/><a data-primary="JVM (Java Virtual Machine)" data-type="indexterm" id="id1863"/><a data-primary="concurrency" data-type="indexterm" id="ix_concurr_ch9"/>synchronize threads takes time, even when there is no contention. In older implementations of Java, this time could be significant. With newer JVMs, it is almost negligible. However, unnecessary low-level synchronization can still slow applications by blocking threads where concurrent access could be allowed. <a data-primary="Swing API" data-seealso="desktop applications" data-type="indexterm" id="id1864"/>To avoid this penalty, two important APIs, the Java collections framework and the Swing API, were specifically crafted to put synchronization under the developer’s control.</p>&#13;
&#13;
<p>The <code>java.util</code> collections framework replaces earlier, simple Java aggregate types—namely, <code>Vector</code> and <code>Hashtable</code>—with more fully featured and, notably, unsynchronized types (<code>List</code> and <code>Map</code>). The collections framework instead defers to application code to synchronize access to collections when necessary, and provides special “fail fast” functionality to help detect concurrent access and throw an exception. It also provides synchronization “wrappers” that can provide safe access in the old style. <a data-primary="java.util.concurrent package" data-type="indexterm" id="ix_java_concurr_pkg"/>Special concurrent-access-friendly implementations of the <code>Map</code> and <code>Queue</code> collections are included as part of the <code>java.util.concurrent</code> package. These implementations go even further and allow a high degree of concurrent access without any user synchronization.</p>&#13;
&#13;
<p>The Java Swing API takes a <a data-primary="event dispatch thread (event queue)" data-type="indexterm" id="id1865"/>different approach to providing speed and safety. Swing uses a single thread to modify its components, with an exception: the <em>event dispatch thread</em>, also called the event queue. Swing solves performance problems and any event ordering issues by forcing a single super-thread to control the GUI. The application accesses the event dispatch thread indirectly by pushing commands onto a queue through a simple interface. We’ll see how to do just that in <a data-type="xref" href="ch12.html#learnjava6-CHP-12">Chapter 12</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Thread Resource Consumption" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-6.2">&#13;
<h2>Thread Resource Consumption</h2>&#13;
&#13;
<p>A fundamental <a data-primary="resources" data-secondary="thread consumption" data-type="indexterm" id="id1866"/><a data-primary="java.nio package" data-secondary="and thread resource consumption" data-secondary-sortas="thread resource consumption" data-type="indexterm" id="id1867"/>pattern in Java is to start many threads to handle asynchronous external resources, such as socket connections. For maximum efficiency, a web developer might be tempted to create a thread for each client connection on a server. When each client has its own thread, I/O operations can block and resume as needed. But as efficient as this may be in terms of throughput for a given client, it is a very inefficient use of server resources.</p>&#13;
&#13;
<p>Threads <a data-primary="context switching" data-type="indexterm" id="id1868"/>consume memory; each thread has its own “stack” for local variables, and switching between running threads (known as <em>context switching</em>) adds overhead to the CPU. Threads are relatively lightweight. It is possible to have hundreds or thousands running on a large server. But after a certain point, the cost of managing the existing threads starts to outweigh the benefits of starting more threads. Creating a thread per client is not always a scalable option.</p>&#13;
&#13;
<p>An alternative <a data-primary="thread pools" data-type="indexterm" id="id1869"/>approach is to create “thread pools” where a fixed number of threads pull tasks from a queue and return for more work when they are finished. This recycling of threads makes for solid scalability, but it has often been difficult to implement efficiently for servers in Java. Basic I/O (for things like sockets) in Java does not fully support nonblocking operations. The <code>java.nio</code> package, New I/O (or simply NIO), has asynchronous I/O channels. Channels can perform nonblocking reads and writes. They also have the ability to test the readiness of streams for moving data. Threads can close channels asynchronously, making for graceful interactions. We’ll discuss NIO in the coming chapters on working with files and network connections.</p>&#13;
&#13;
<p>Java provides thread pools and job “executor” services as part of the <code>java.util.concurrent</code> package. This means you don’t have to write these yourself. We’ll summarize them when we discuss the concurrency utilities in Java.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Virtual Thread Performance" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-6.3">&#13;
<h2>Virtual Thread Performance</h2>&#13;
&#13;
<p>Project <a data-primary="threads" data-secondary="virtual" data-type="indexterm" id="id1870"/><a data-primary="virtual threads" data-type="indexterm" id="id1871"/><a data-primary="Project Loom" data-type="indexterm" id="id1872"/>Loom set out to improve thread performance—especially when thousands or millions of threads are involved. The code of a <code>run()</code> method isn’t any faster or slower when you run it on a platform thread versus a virtual thread. What is faster, though, is creating and managing those threads.</p>&#13;
&#13;
<p>Let’s take another look at our <code>URLDemo</code> class. Rather than four threads total, let’s crank that number up to several thousand. We’ll drop our producers and prepopulate the queue with URLs so we can focus on our new consumers. We’ll make consumers whose only job is to consume one URL—no random, artificial delay before going back for another URL. This behavior mimics a real use case for virtual threads: a single server that handles millions of small requests in a short period. We’ll also modify our print statements to show up at milestones rather than after every single URL is consumed. Our new <code>URLDemo3</code> will take two optional command-line arguments: the number of URLs to create (default is 100,000) and whether to use platform or virtual threads (default is platform), so we can compare the difference in performance.</p>&#13;
&#13;
<p>Check out the source code for <code>URLConsumer3</code> in the <em>ch09/examples</em> folder to see the tweaks we made for this new variation. Then let’s look more carefully at the processing loop in the <code>main()</code> method to see how it handles the new consumers. Here’s the relevant section:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// Create and populate our shared queue object</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URLQueue</code><code class="w"> </code><code class="n">queue</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLQueue</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">u</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"> </code><code class="n">u</code><code class="w"> </code><code class="o">&lt;=</code><code class="w"> </code><code class="n">count</code><code class="p">;</code><code class="w"> </code><code class="n">u</code><code class="o">++</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">queue</code><code class="p">.</code><code class="na">addURL</code><code class="p">(</code><code class="s">"http://some.url/path/"</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">u</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// Now the fun begins! Make one consumer for every URL</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kt">int</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">0</code><code class="p">;</code><code class="w"> </code><code class="n">c</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="n">count</code><code class="p">;</code><code class="w"> </code><code class="n">c</code><code class="o">++</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">URLConsumer3</code><code class="w"> </code><code class="n">consumer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URLConsumer3</code><code class="p">(</code><code class="s">"C"</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">c</code><code class="p">,</code><code class="w"> </code><code class="n">queue</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">useVirtual</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Thread</code><code class="p">.</code><code class="na">startVirtualThread</code><code class="p">(</code><code class="n">consumer</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">consumer</code><code class="p">).</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>This code doesn’t try to reuse consumers. There are valid reasons not to reuse threads in the real world, by the way. You have to manually clean up some shared data between uses, for example. Forget that bit of “administrivia” and you might leak sensitive information. (If you were processing bank transactions, you wouldn’t want to accidentally use the previous account number.) You can often simplify your code by assuming a single thread will do all of the work and then terminate. This is true whether or not you’re using virtual threads.</p>&#13;
&#13;
<p>We tried this version with 1,000,000 URLs on a middling Linux desktop system. The platform threads cleared the queue in just under one minute (58.661 s according to the coarse <code>time</code> utility). Not bad! The virtual threads, on the other hand, cleared the queue in just under <em>2 seconds</em> (1.867 s). The testing for a milestone URL to print is trivial. It’s not the task each consumer does that slows things down. The real bottleneck with platform threads is asking the operating system for a new, expensive resource thousands of times. Project Loom removes a lot of that expense. Using virtual threads is not a guarantee of better performance, but in cases like this, it certainly can be a benefit!<a data-primary="" data-startref="ix_perf_thread" data-type="indexterm" id="id1873"/><a data-primary="" data-startref="ix_thread_perf" data-type="indexterm" id="id1874"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Concurrency Utilities" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-7">&#13;
<h1>Concurrency Utilities</h1>&#13;
&#13;
<p>So far in this <a data-primary="threads" data-secondary="concurrency utilities" data-type="indexterm" id="ix_thread_concurr_util"/>chapter, we’ve demonstrated how to create and synchronize threads at a low level, using Java language primitives. The <code>java.util.concurrent</code> package and subpackages build on this functionality, adding important threading utilities and codifying some common design patterns by supplying standard implementations. Roughly in order of generality, these areas include:</p>&#13;
<dl>&#13;
<dt><em>Thread-aware Collections implementations</em></dt>&#13;
<dd>&#13;
<p>The <code>java.util.concurrent</code> package <a data-primary="Map interface" data-type="indexterm" id="id1875"/><a data-primary="Queue interface" data-type="indexterm" id="id1876"/><a data-primary="Collections API" data-type="indexterm" id="id1877"/>augments the Java Collections API in <a data-type="xref" href="ch07.html#learnjava6-CHP-7">Chapter 7</a> with several implementations for specific threading models. These include timed wait and blocking implementations of the <code>Queue</code> interface, as well as nonblocking, concurrent-access optimized implementations of the <code>Queue</code> and <code>Map</code> interfaces. The package also adds “copy on write” <code>List</code> and <code>Set</code> implementations for extremely efficient “almost always read” cases. These may sound complex, but they cover some common cases very well.</p>&#13;
</dd>&#13;
<dt><code>Executors</code></dt>&#13;
<dd>&#13;
<p><code>Executor</code>s run <a data-primary="Callable interface" data-type="indexterm" id="id1878"/><a data-primary="Future interface" data-type="indexterm" id="id1879"/><a data-primary="Executors interface" data-type="indexterm" id="id1880"/>tasks, including <code>Runnable</code>s, and abstract the concept of thread creation and pooling from the user (meaning you don’t have to write your own). <code>Executors</code> are intended to be a high-level replacement for creating new threads to service a series of jobs. Along with <code>Executor</code>, the <code>Callable</code> and <code>Future</code> interfaces allow management, value return, and exception handling.</p>&#13;
</dd>&#13;
<dt><em>Low-level synchronization constructs</em></dt>&#13;
<dd>&#13;
<p>The <code>java.util.concurrent.locks</code> package holds a set of <a data-primary="LockSupport class" data-type="indexterm" id="id1881"/><a data-primary="Condition class" data-type="indexterm" id="id1882"/><a data-primary="Lock class" data-type="indexterm" id="id1883"/><a data-primary="synchronization, threads" data-type="indexterm" id="id1884"/><a data-primary="threads" data-secondary="synchronization of" data-type="indexterm" id="id1885"/>classes, including <code>Lock</code> and <code>Condition</code>, that parallels the Java language-level synchronization primitives and promotes them to the level of a concrete API. For example, the <code>LockSupport</code> helper class includes two methods, <code>park()</code> and <code>unpark()</code>, that replace the deprecated <code>suspend()</code> and <code>resume()</code> methods from the <code>Thread</code> class. The locks package also adds the concept of nonexclusive reader/writer locks, allowing for greater concurrency in synchronized data access.</p>&#13;
</dd>&#13;
<dt><em>High-level synchronization constructs</em></dt>&#13;
<dd>&#13;
<p>This includes the <a data-primary="Exchanger class" data-type="indexterm" id="id1886"/><a data-primary="CyclicBarrier class" data-type="indexterm" id="id1887"/><a data-primary="CountDownLatch class" data-type="indexterm" id="id1888"/><a data-primary="Semaphore class" data-type="indexterm" id="id1889"/>classes <code>CyclicBarrier</code>, <code>CountDownLatch</code>, <code>Semaphore</code>, and <code>Exchanger</code>. These classes implement common synchronization patterns drawn from other languages and systems, and they can serve as the basis for new high-level tools.</p>&#13;
</dd>&#13;
<dt><em>Atomic operations (sounds very James Bond, doesn’t it?)</em></dt>&#13;
<dd>&#13;
<p>The <code>java.util.concurrent.atomic</code> package <a data-primary="atomic operations" data-type="indexterm" id="id1890"/>provides wrappers and utilities for atomic, “all-or-nothing” operations on primitive types and references. This includes simple combination atomic operations like testing a value before setting it, and getting and incrementing a number in one operation.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>With the possible exception of optimizations done by the Java VM for the <code>atomic</code> operations package, all of these utilities are implemented in pure Java, on top of the standard Java language synchronization constructs. This means that they are in a sense only convenience utilities and don’t truly add new capabilities to the language. Their main role is to offer standard patterns and idioms in Java threading, making them safer and more efficient to use. A good example of this is the <code>Executor</code> utility, which allows a user to manage a set of tasks in a predefined threading model without having to delve into creating threads at all. Higher-level APIs like this both simplify coding and allow for greater optimization of the common cases.<a data-primary="" data-startref="ix_concurr_ch9" data-type="indexterm" id="id1891"/><a data-primary="" data-startref="ix_java_concurr_pkg" data-type="indexterm" id="id1892"/></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Upgrading Our Queue Demo" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-7.1">&#13;
<h2>Upgrading Our Queue Demo</h2>&#13;
&#13;
<p>Many of the <a data-primary="ConcurrentLinkedQueue class" data-type="indexterm" id="id1893"/>concurrency features built into Java will be more useful to you on larger, more complex projects. But we can still upgrade our meager URL processing demo by using the thread-safe <code>ConcurrentLinkedQueue</code> class from the <code>java.util.concurrent</code> package. We can parameterize its type and do away with our custom <code>URLQueue</code> class entirely:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// Directory: ch09/examples</code><code class="w"/>&#13;
<code class="c1">// in URLDemo4.java</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">ConcurrentLinkedQueue</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="w"> </code><code class="n">queue</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">new</code><code class="w"> </code><code class="n">ConcurrentLinkedQueue</code><code class="o">&lt;&gt;</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="c1">// in URLProducer4.java, just "add" instead of "addURL"</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">queue</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">producerID</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">url</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="c1">// in URLConsumer4.java, "poll" rather than "getURL"</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">queue</code><code class="p">.</code><code class="na">poll</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// ...</code><code class="w"/></pre>&#13;
&#13;
<p>We do have to tweak the consumer and producer code a little, but only a little, and mostly just to use the normal queue operation names of <code>add</code> and <code>poll</code> instead of our custom, URL-centric method names. But we don’t have to worry about the <code>URLQueue</code> class at all. Sometimes you will need custom data structures because the real world is messy. But if you can use one of the synchronized storage options built in, you know you’re getting robust storage and access that you can safely use in your multithreaded application.</p>&#13;
&#13;
<p>Another <a data-primary="atomic convenience classes" data-type="indexterm" id="id1894"/><a data-primary="AtomicBoolean class" data-type="indexterm" id="id1895"/>upgrade to consider is the atomic convenience classes. You might recall that our consumer class has a Boolean flag that can be set to false to end the consumer’s processing loop. Since it’s reasonable to assume that multiple threads might have access to our consumer, we can remake that flag as an instance of the <code>AtomicBoolean</code> class to make sure that warring threads can’t clobber our poor flag. (We could make our accessor method <code>synchronized</code>, of course, but we want to highlight some of the existing options already in the JDK.) Here’s a look at the interesting parts of <code>URLConsumer4</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="n">AtomicBoolean</code><code class="w"> </code><code class="n">keepWorking</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="c1">//...</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">keepWorking</code><code class="p">.</code><code class="na">get</code><code class="p">()</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="o">!</code><code class="n">queue</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">queue</code><code class="p">.</code><code class="na">poll</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">//...</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">setKeepWorking</code><code class="p">(</code><code class="kt">boolean</code><code class="w"> </code><code class="n">newState</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">keepWorking</code><code class="p">.</code><code class="na">set</code><code class="p">(</code><code class="n">newState</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Using <code>AtomicBoolean</code> requires a smidge more typing—calling set/get methods rather than simple assignments or comparisons—but you get all the safe handling you could wish for. When you have complex, multithreaded logic everywhere, you might do your own state management. In situations where you don’t have much other code that requires synchronization, though, these convenience classes can be very convenient indeed.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Structured Concurrency" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-7.2">&#13;
<h2>Structured Concurrency</h2>&#13;
&#13;
<p>Beyond the <a data-primary="structured concurrency" data-type="indexterm" id="id1896"/><a data-primary="Project Loom" data-type="indexterm" id="id1897"/><a data-primary="parallel programming" data-type="indexterm" id="id1898"/>impressive improvements that virtual threads bring to highly concurrent applications, Project Loom also brings structured concurrency to Java. You may have heard about “parallel programming” in the threaded world. You have the option of pursuing a parallel programming solution when you can break a larger problem into smaller problems that can be solved separately and at the same time (in parallel, &#13;
<span class="keep-together">get it</span>?).</p>&#13;
&#13;
<p>This <a data-primary="error handling" data-secondary="and structured concurrency" data-secondary-sortas="structured concurrency" data-type="indexterm" id="id1899"/>notion of a large task that can be turned into subtasks shares many similarities with our demo that uses producers and consumers, but the two types of problems are not entirely the same. One big difference lies in how to handle errors. If we failed to create a consumer in our <code>URLDemo</code> classes, for example, we could just create another one and continue on. But if a subtask fails in a parallel computation, it isn’t as obvious how to recover. Should all of the other subtasks be canceled? What if some of them have already completed? What if we want to cancel the larger “parent” task?</p>&#13;
&#13;
<p>Java 19 introduced an <a data-primary="StructuredTaskScope class" data-type="indexterm" id="id1900"/>incubator feature, the <code>StructuredTaskScope</code> class, to better encapsulate the work done with subtasks. (If you were to call a preview feature like virtual threads a “beta” enhancement, incubator features would be an “alpha” enhancement.) You can read about the design goals and implementation details in <a href="https://oreil.ly/HBbfE">JEP 428</a>. We won’t work with structured concurrency or executors in this book, but it is important to know that Java has many tools available to developers who are working with parallel and concurrent applications. Indeed, the support it provides to developers in this arena is precisely why Java remains such a popular workhorse in production backends.<a data-primary="" data-startref="ix_thread_concurr_util" data-type="indexterm" id="id1901"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="So Many Threads to Pull" data-type="sect1"><div class="sect1" id="learnjava6-CHP-9-SECT-8">&#13;
<h1>So Many Threads to Pull</h1>&#13;
&#13;
<p>While we won’t be <a data-primary="Java Concurrency in Practice (Goetz)" data-type="indexterm" id="id1902"/><a data-primary="Goetz, Brian" data-type="indexterm" id="id1903"/>looking any deeper at the concurrency packages in this chapter, we want you to know where you might dig next if concurrency is interesting to you or proves useful in the type of problems you encounter at work. As we (foot)noted in <a data-type="xref" href="#learnjava6-CHP-9-SECT-4.1.1">“Synchronizing a queue of URLs”</a>, <em><a href="https://jcip.net">Java Concurrency In Practice</a></em> by Brian Goetz, is required reading for real-world, multithreaded projects. We also want to give a shout-out to Doug Lea, the author of <em>Concurrent Programming in Java</em> (Addison-Wesley), who led the group that added these packages to Java and is largely responsible for creating them.</p>&#13;
&#13;
<p>Alongside threads, Java’s native support for basic file input and output (I/O) figures prominently in production applications. We’ll look at the main classes for typical I/O in the next chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review Questions" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-8.1">&#13;
<h2>Review Questions</h2>&#13;
<ol>&#13;
<li>&#13;
<p>What is a thread?</p>&#13;
</li>&#13;
<li>&#13;
<p>What keyword can you add to a method if you want threads to “take turns” when calling it? (Meaning no two threads should be executing the method at the same time to avoid corrupting shared data.)</p>&#13;
</li>&#13;
<li>&#13;
<p>What flags allow you to compile a Java program that includes preview feature code?</p>&#13;
</li>&#13;
<li>&#13;
<p>What flags allow you to run a Java program that includes preview feature code?</p>&#13;
</li>&#13;
<li>&#13;
<p>How many platform threads can one native thread support?</p>&#13;
</li>&#13;
<li>&#13;
<p>How many virtual threads can one native thread support?</p>&#13;
</li>&#13;
<li>&#13;
<p>Is the statement <code>x = x + 1;</code> an atomic action for the variable <code>x</code>?</p>&#13;
</li>&#13;
<li>&#13;
<p>What package includes thread-safe versions of popular collection classes like <code>Queue</code> and <code>Map</code>?</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Code Exercises" data-type="sect2"><div class="sect2" id="learnjava6-CHP-9-SECT-8.2">&#13;
<h2>Code Exercises</h2>&#13;
<ol>&#13;
<li>&#13;
<p>Let’s build a clock! Using a needle and thread—er, a <code>JLabel</code> and a <code>Thread</code>—make a small graphical clock application. The <em>Clock.java</em> file in the <em>ch09/exercises</em> folder contains a skeleton app that puts up a small window with a simple <code>JLabel</code> object. We bumped up the size of the label’s font to make things more readable. Your clock should show hours, minutes, and seconds, at a minimum. Create a thread that will sleep for one second and then increment the clock’s display. Feel free to revisit the date and time formatting examples from <a data-type="xref" href="ch08.html#learnjava6-CHP-8-SECT-5.5">“Formatting Dates and Times”</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>The apple tossing game in the <em>ch09/exercises/game</em> folder currently uses a platform thread for its first foray into the world of animation following the discussion in <a data-type="xref" href="#learnjava6-CHP-9-SECT-1.3">“Revisiting Animation with Threads”</a>. Compile and run it to see an apple launch itself when the game starts. The apple won’t hit anything, but it will move in an arc as though tossed. We’ll make this animation more interesting and more interactive in <a data-type="xref" href="ch12.html#learnjava6-CHP-12">Chapter 12</a>.<a data-primary="" data-startref="ix_thread_ch9" data-type="indexterm" id="id1904"/></p>&#13;
&#13;
<p>Once you have a feel for the intended animation, convert the platform thread to a virtual thread. Compile your new version and verify it still works as expected. (Remember that, depending on your version of Java, you may need to compile and run with the extra preview flags.)</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id1771"><sup><a href="ch09.html#id1771-marker">1</a></sup> Historically, <code>interrupt()</code> has not worked consistently in all Java implementations.</p><p data-type="footnote" id="id1793"><sup><a href="ch09.html#id1793-marker">2</a></sup> The term daemon (often pronounced day-mun in Unix circles) was inspired by <a href="https://oreil.ly/YGQMt">Maxwell’s demon</a> and refers to the Greek term for a lesser deity, not a malevolent spirit.</p><p data-type="footnote" id="id1797"><sup><a href="ch09.html#id1797-marker">3</a></sup> Many Java enhancements start out as works-in-progress with spiffy names like “Loom.”</p><p data-type="footnote" id="id1810"><sup><a href="ch09.html#id1810-marker">4</a></sup> Sadly, the single- versus double-dash prefixes on these options are not typos. Command-line arguments have quite a storied history in their own right, and Java and its tools are old enough to have inherited some of the legacy patterns while still needing to accommodate modern approaches. Most options work with either prefix, but occasionally you have to obey what seems like an unwritten rule. When in doubt, tools like <em>javac</em> support another option: <code>-help</code> (or <code>--help</code>). Supplying that argument will print out a concise list of options and relevant details.</p><p data-type="footnote" id="id1818"><sup><a href="ch09.html#id1818-marker">5</a></sup> Don’t confuse the term <em>serialize</em> in this context with Java <em>object serialization</em>, which is a mechanism for making objects persistent. The underlying meaning (to place one thing after another) is the same, however. In the case of object serialization, the object’s data is laid out, byte for byte, in a certain order. With threads, each thread gets access to the synchronized resource in turn.</p><p data-type="footnote" id="id1823"><sup><a href="ch09.html#id1823-marker">6</a></sup> Even with the ability to tolerate minor discrepancies in the state of objects, modern, multicore systems can wreak havoc without perfect knowledge of the application. And perfection is difficult! If you expect to work with threads in the real world, <a href="https://jcip.net"><em>Java Concurrency in Practice</em></a> by Brian Goetz et al. (Addison-Wesley) is <em>required</em> reading.</p><p data-type="footnote" id="id1843"><sup><a href="ch09.html#id1843-marker">7</a></sup> <em>Java Threads</em> by Scott Oaks and Henry Wong (O’Reilly) includes a detailed discussion of synchronization, scheduling, and other thread-related issues.</p><p data-type="footnote" id="id1845"><sup><a href="ch09.html#id1845-marker">8</a></sup> Technically, a thread can also terminate with the <a href="https://oreil.ly/AbbQk">deprecated <code>stop()</code> call</a>, but as we noted at the start of the chapter, this is bad for myriad reasons.</p><p data-type="footnote" id="id1854"><sup><a href="ch09.html#id1854-marker">9</a></sup> You can type Control-C to exit the demo when you get tired of seeing <code>Foos</code> fly by.</p></div></div></section></body></html>