<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Integrating with Kubernetes"><div class="chapter" id="integrating_with_kubernetes_chapter">
<h1><span class="label">Chapter 10. </span>Integrating with Kubernetes</h1>


<p><a data-type="indexterm" data-primary="Kubernetes" data-secondary="about" id="idm45128510601976"/><a data-type="indexterm" data-primary="Kubernetes" id="kub_ch"/>So far, you’ve been learning how to develop and run Quarkus applications on bare-metal, but where Quarkus really shines is when it is running in a Kubernetes cluster.</p>

<p>In this chapter, you’ll learn about the integration between Quarkus and Kubernetes, and how several extensions can help develop and deploy a Quarkus service for Kubernetes.</p>

<p>Kubernetes is becoming the de facto platform to deploy applications; for this reason it is important to have a good understanding of Kubernetes and how to correctly develop and deploy applications on it.</p>

<p>In this chapter, you’ll learn how to accomplish the following tasks:</p>

<ul>
<li>
<p>Build and push container images</p>
</li>
<li>
<p>Generate Kubernetes resources</p>
</li>
<li>
<p>Deploy a Quarkus service</p>
</li>
<li>
<p>Develop a Kubernetes operator</p>
</li>
<li>
<p>Deploy a service in Knative</p>
</li>
</ul>






<section data-type="sect1" data-pdf-bookmark="10.1 Building and Pushing Container Images"><div class="sect1" id="building-and-pushing-container-images">
<h1>10.1 Building and Pushing Container Images</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128510591832">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="container images" id="cont_ab"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="building container images" id="kub_bui"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="pushing container images" id="kub_pus"/>You want to build and push container images.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128510586696">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="pod" id="idm45128510585192"/>The working unit in Kubernetes is a <em>pod</em>.
A pod represents a group of containers that are running in the same host machine and share resources like IP and ports.
To deploy a service to Kubernetes, you need to create a pod. Since a pod is composed by one or more containers, you need to build a container image of your service.</p>

<p>Quarkus provides extensions for building and optionally pushing container images.
<a data-type="indexterm" data-primary="Jib" id="idm45128510583256"/><a data-type="indexterm" data-primary="Docker" id="idm45128510582552"/><a data-type="indexterm" data-primary="S2I" id="idm45128510581880"/>At the time of writing, the following container build strategies are supported:</p>
<dl>
<dt>Jib</dt>
<dd>
<p>Jib builds Docker and OCI container images for your Java applications without a Docker daemon (Dockerless). This makes it perfect for building Docker images when running the process inside a container because you avoid the hassle of the Docker-in-Docker (DinD) process. Further, using Jib with Quarkus caches all dependencies in a different layer than the actual application, making rebuilds fast and small. This improves push times as well as build times.</p>
</dd>
<dt>Docker</dt>
<dd>
<p>Using the Docker strategy builds container images using the <code>docker</code> binary, which is installed locally and by default uses <code>Dockerfiles</code> located under <em>src/main/docker</em> to build the images.</p>
</dd>
<dt>S2I</dt>
<dd>
<p>The Source-to-Image (S2I) strategy uses <code>s2i</code> binary builds to perform container builds inside an OpenShift cluster. S2I builds require creating a <code>BuildConfig</code> and two <code>ImageStream</code> resources. The creation of these resources is leveraged by the Quarkus Kubernetes extension.</p>
</dd>
</dl>

<p>In this recipe, we’re going to build and push the container using Jib; the “Discussion” section of this recipe will address Docker and S2I.</p>

<p>To build and push a container image using Jib, first you need to add the Jib extension:</p>

<pre data-type="programlisting" data-code-language="bash">./mvnw quarkus:add-extensions -Dextensions<code class="o">=</code><code class="s2">"quarkus-container-image-jib"</code></pre>

<p>Then you can customize the container image build process.
You can set these properties in the <em>application.properties</em>, system properties, or environment variables, just as any other configuration parameter in Quarkus:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.container-image.group</code><code class="o">=</code><code class="s">lordofthejars </code><a class="co" id="co_integrating_with_kubernetes_CO1-1" href="#callout_integrating_with_kubernetes_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.registry</code><code class="o">=</code><code class="s">quay.io </code><a class="co" id="co_integrating_with_kubernetes_CO1-2" href="#callout_integrating_with_kubernetes_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.username</code><code class="o">=</code><code class="s">lordofthejars </code><a class="co" id="co_integrating_with_kubernetes_CO1-3" href="#callout_integrating_with_kubernetes_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="c">#quarkus.container-image.password= </code><a class="co" id="co_integrating_with_kubernetes_CO1-4" href="#callout_integrating_with_kubernetes_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO1-1" href="#co_integrating_with_kubernetes_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the group part of the image; by default this is <code>${user.name}</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO1-2" href="#co_integrating_with_kubernetes_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Registry where to push the image; by default, images are pushed to <code>docker.io</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO1-3" href="#co_integrating_with_kubernetes_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The username to log into the container registry</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO1-4" href="#co_integrating_with_kubernetes_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The password to log into the container registry</p></dd>
</dl>

<p>To build and push the container image for the project, you need to set the <code>quarkus.container-image.push</code> parameter to <code>true</code>, and during the <code>package</code> stage, the container is created and pushed:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -Dquarkus.container-image.push=true
</code><code class="go">
</code><code class="go">...
</code><code class="go">[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ greeting-jib ---
</code><code class="go">[INFO] Building jar: /greeting-jib/target/greeting-jib-1.0-SNAPSHOT.jar
</code><code class="go">[INFO]
</code><code class="go">[INFO] --- quarkus-maven-plugin:1.3.0.CR2:build (default) @ greeting-jib ---
</code><code class="go">[INFO] [org.jboss.threads] JBoss Threads version 3.0.1.Final
</code><code class="go">[INFO] [io.quarkus.deployment.pkg.steps.JarResultBuildStep] Building thin jar:
</code><code class="go">    greeting-jib/target/greeting-jib-1.0-SNAPSHOT-runner.jar
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor]
</code><code class="go">    Starting container image build </code><a class="co" id="co_integrating_with_kubernetes_CO2-1" href="#callout_integrating_with_kubernetes_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">[WARNING] [io.quarkus.container.image.jib.deployment.JibProcessor]
</code><code class="go">    Base image 'fabric8/java-alpine-openjdk8-jre' does not use a specific image
</code><code class="go">    digest - build may not be reproducible
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor] LogEvent
</code><code class="go">    [level=INFO, message=trying docker-credential-desktop for quay.io]
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor] LogEvent
</code><code class="go">    [level=LIFECYCLE, message=Using credentials from Docker config
</code><code class="go">    ($HOME/.docker/config.json) for
</code><code class="go">    quay.io/lordofthejars/greeting-jib:1.0-SNAPSHOT]
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor] The base image
</code><code class="go">    requires auth. Trying again for fabric8/java-alpine-openjdk8-jre...
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor] Using base
</code><code class="go">    image with digest:
</code><code class="go">    sha256:a5d31f17d618032812ae85d12426b112279f02951fa92a7ff8a9d69a6d3411b1
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor] Container
</code><code class="go">    entrypoint set to [java, -Dquarkus.http.host=0.0.0.0,
</code><code class="go">    -Djava.util.logging.manager=org.jboss.logmanager.LogManager,
</code><code class="go">    -cp, /app/resources:/app/classes:/app/libs/*,
</code><code class="go">        io.quarkus.runner.GeneratedMain]
</code><code class="go">[INFO] [io.quarkus.container.image.jib.deployment.JibProcessor] Pushed
</code><code class="go">container image quay.io/lordofthejars/greeting-jib:1.0-SNAPSHOT
</code><code class="go">(sha256:e173e0b49bd5ec1f500016f46f2cde03a055f558f72ca8ee1d6cb034a385a657)</code><a class="co" id="co_integrating_with_kubernetes_CO2-2" href="#callout_integrating_with_kubernetes_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed
</code><code class="go">    in 12980ms</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO2-1" href="#co_integrating_with_kubernetes_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The container image is built</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO2-2" href="#co_integrating_with_kubernetes_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The container image is pushed to quay.io</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128510586104">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="Docker" id="idm45128510410712"/><a data-type="indexterm" data-primary="S2I" id="idm45128510481896"/>Apart from Jib, there are two other options available to build a container image; to use them you simply need to register the extension:</p>
<dl>
<dt>Docker</dt>
<dd>
<p><code>quarkus-container-image-docker</code></p>
</dd>
<dt>S2I</dt>
<dd>
<p><code>quarkus-container-image-s2i</code></p>
</dd>
</dl>

<p>Each of the extensions provides specific configuration parameters to change the build process.
These parameters let you change the base images used for building the container image and let you set environment variables, the arguments to pass to the executable, or the location of the Dockerfiles.</p>

<p>You can also build the image but not push it to a registry.
To do this, you need to set the <code>quarkus.container-image.build</code> property to <code>true</code> and not set the <code>quarkus.container-image.push</code> property:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -Dquarkus.container-image.build=true</code></pre>
<div data-type="important"><h6>Important</h6>
<p>If <code>Jib</code> is used and <code>push</code> is set to <code>false</code>, the extension creates a container image and registers it with the Docker daemon.
This means that although Docker isn’t used to build the image, it is still 
<span class="keep-together">necessary</span>.</p>
</div>

<p>The container image extensions can create a container from a JAR package (for use in JVM mode) and from a native executable, depending on what is found in the <em>build/output</em> directory.
If you want to create a native executable that can be run from a Linux container and then create a container image with the resulting native executable inside, you can run the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -Dquarkus.container-image.push=true -Pnative \</code>
<code class="go">    -Dquarkus.native.container-build=true</code></pre>

<p>Setting the <code>quarkus.native.container-build</code> property to <code>true</code> creates the native executable inside a Docker container.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128510411688">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="cont_ab" id="idm45128510447240"/><a data-type="indexterm" data-primary="" data-startref="kub_bui" id="idm45128510446264"/><a data-type="indexterm" data-primary="" data-startref="kub_pus" id="idm45128510445320"/><a data-type="indexterm" data-primary="Jib" id="idm45128510444376"/>For more information, visit the following pages on GitHub:</p>

<ul>
<li>
<p><a href="https://oreil.ly/6vrh5">Google Container Tools: Jib</a></p>
</li>
<li>
<p><a href="https://oreil.ly/8PEgn">Source-To-Image</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.2 Generating Kubernetes Resources"><div class="sect1" id="generate-kubernetes-resources">
<h1>10.2 Generating Kubernetes Resources</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128510422328">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Kubernetes" data-secondary="generating resources" id="kub_gen"/><a data-type="indexterm" data-primary="resources" id="res_ab"/>You want to generate Kubernetes resources automatically.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128510418552">
<h2>Solution</h2>

<p>Quarkus has a Kubernetes extension that is able to generate Kubernetes resources automatically with sane defaults and optional user-supplied configuration.
Currently, the extension can produce resources for Kubernetes and OpenShift.</p>

<p>To enable the generation of Kubernetes resources, you need to register the <code>quarkus-kubernetes</code> extension:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-kubernetes"</code></pre>

<p>To generate the Kubernetes resources, execute in a new terminal <code>./mvnw package</code>.
Then among the usual files generated by the build tool in the <code>target</code> directory, two new files are created inside the <em>target/kubernetes</em> directory. These new files are named <em>kubernetes.json</em> and <em>kubernetes.yaml</em>, and they each contain the definition of both a <code>Deployment</code> and a <code>Service</code>:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code><code>
  </code><code class="nt">"apiVersion"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"v1"</code><code class="p">,</code><code>
  </code><code class="nt">"kind"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"List"</code><code class="p">,</code><code>
  </code><code class="nt">"items"</code><code> </code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><code class="p">{</code><code>
    </code><code class="nt">"apiVersion"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"v1"</code><code class="p">,</code><code>
    </code><code class="nt">"kind"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"Service"</code><code class="p">,</code><code>
    </code><code class="nt">"metadata"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
      </code><code class="nt">"labels"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"app"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code class="p">,</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO3-1" href="#callout_integrating_with_kubernetes_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
        </code><code class="nt">"version"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO3-2" href="#callout_integrating_with_kubernetes_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
        </code><code class="nt">"group"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"alex"</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO3-3" href="#callout_integrating_with_kubernetes_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code>
    </code><code class="p">}</code><code class="p">,</code><code>
    </code><code class="nt">"spec"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
      </code><code class="nt">"ports"</code><code> </code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"http"</code><code class="p">,</code><code>
        </code><code class="nt">"port"</code><code> </code><code class="p">:</code><code> </code><code class="mi">8080</code><code class="p">,</code><code>
        </code><code class="nt">"targetPort"</code><code> </code><code class="p">:</code><code> </code><code class="mi">8080</code><code>
      </code><code class="p">}</code><code> </code><code class="p">]</code><code class="p">,</code><code>
      </code><code class="nt">"selector"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"app"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code class="p">,</code><code>
        </code><code class="nt">"version"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code><code>
        </code><code class="nt">"group"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"alex"</code><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="nt">"type"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"ClusterIP"</code><code>
    </code><code class="p">}</code><code>
  </code><code class="p">}</code><code class="p">,</code><code> </code><code class="p">{</code><code>
    </code><code class="nt">"apiVersion"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"apps/v1"</code><code class="p">,</code><code>
    </code><code class="nt">"kind"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"Deployment"</code><code class="p">,</code><code>
    </code><code class="nt">"metadata"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
      </code><code class="nt">"labels"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"app"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code class="p">,</code><code>
        </code><code class="nt">"version"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code><code>
        </code><code class="nt">"group"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"alex"</code><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code>
    </code><code class="p">}</code><code class="p">,</code><code>
    </code><code class="nt">"spec"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
      </code><code class="nt">"replicas"</code><code> </code><code class="p">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code>
      </code><code class="nt">"selector"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"matchLabels"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
          </code><code class="nt">"app"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code class="p">,</code><code>
          </code><code class="nt">"version"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code><code>
          </code><code class="nt">"group"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"alex"</code><code>
        </code><code class="p">}</code><code>
      </code><code class="p">}</code><code class="p">,</code><code>
      </code><code class="nt">"template"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"metadata"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
          </code><code class="nt">"labels"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
            </code><code class="nt">"app"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code class="p">,</code><code>
            </code><code class="nt">"version"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code><code>
            </code><code class="nt">"group"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"alex"</code><code>
          </code><code class="p">}</code><code>
        </code><code class="p">}</code><code class="p">,</code><code>
        </code><code class="nt">"spec"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
          </code><code class="nt">"containers"</code><code> </code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><code class="p">{</code><code>
            </code><code class="nt">"env"</code><code> </code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><code class="p">{</code><code>
              </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"KUBERNETES_NAMESPACE"</code><code class="p">,</code><code>
              </code><code class="nt">"valueFrom"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
                </code><code class="nt">"fieldRef"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
                  </code><code class="nt">"fieldPath"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"metadata.namespace"</code><code>
                </code><code class="p">}</code><code>
              </code><code class="p">}</code><code>
            </code><code class="p">}</code><code> </code><code class="p">]</code><code class="p">,</code><code>
            </code><code class="nt">"image"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"alex/getting-started:1.0-SNAPSHOT"</code><code class="p">,</code><code>
            </code><code class="nt">"imagePullPolicy"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"IfNotPresent"</code><code class="p">,</code><code>
            </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"getting-started"</code><code class="p">,</code><code>
            </code><code class="nt">"ports"</code><code> </code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><code class="p">{</code><code>
              </code><code class="nt">"containerPort"</code><code> </code><code class="p">:</code><code> </code><code class="mi">8080</code><code class="p">,</code><code>
              </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"http"</code><code class="p">,</code><code>
              </code><code class="nt">"protocol"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"TCP"</code><code>
            </code><code class="p">}</code><code> </code><code class="p">]</code><code>
          </code><code class="p">}</code><code> </code><code class="p">]</code><code>
        </code><code class="p">}</code><code>
      </code><code class="p">}</code><code>
    </code><code class="p">}</code><code>
  </code><code class="p">}</code><code> </code><code class="p">]</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO3-1" href="#co_integrating_with_kubernetes_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Defaults to project name</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO3-2" href="#co_integrating_with_kubernetes_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Defaults to version field</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO3-3" href="#co_integrating_with_kubernetes_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Defaults to OS username</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128508344984">
<h2>Discussion</h2>

<p>You can customize the group and the name used in the generated manifest by adding these properties to <em>application.properties</em>:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.container-image.group</code><code class="o">=</code><code class="s">redhat</code>
<code class="na">quarkus.application.name</code><code class="o">=</code><code class="s">message-app</code></pre>

<p>The Kubernetes extension allows user customizations to be supplied to different parts of the manifest:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.kubernetes.replicas</code><code class="o">=</code><code class="s">3 </code><a class="co" id="co_integrating_with_kubernetes_CO4-1" href="#callout_integrating_with_kubernetes_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>

</code><code class="na">quarkus.container-image.registry</code><code class="o">=</code><code class="s">http://my.docker-registry.net </code><a class="co" id="co_integrating_with_kubernetes_CO4-2" href="#callout_integrating_with_kubernetes_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.labels.environment</code><code class="o">=</code><code class="s">prod </code><a class="co" id="co_integrating_with_kubernetes_CO4-3" href="#callout_integrating_with_kubernetes_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>

</code><code class="na">quarkus.kubernetes.readiness-probe.initial-delay-seconds</code><code class="o">=</code><code class="s">10 </code><a class="co" id="co_integrating_with_kubernetes_CO4-4" href="#callout_integrating_with_kubernetes_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.readiness-probe.period-seconds</code><code class="o">=</code><code class="s">30</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO4-1" href="#co_integrating_with_kubernetes_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the number of replicas</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO4-2" href="#co_integrating_with_kubernetes_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Adds the Docker registry to pull images</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO4-3" href="#co_integrating_with_kubernetes_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Adds new labels</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO4-4" href="#co_integrating_with_kubernetes_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets readiness probe</p></dd>
</dl>

<p>You can generate different resources by setting the property as <code>quarkus.kubernetes.deployment-target</code> in the <em>application.properties</em> file or as a system property.</p>

<p>The default value of this property is <code>kubernetes</code>, but the following values are also supported at the time of writing: <code>kubernetes</code>, <code>openshift</code>, and <code>knative</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128508399016">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="kub_gen" id="idm45128508397896"/><a data-type="indexterm" data-primary="" data-startref="res_ab" id="idm45128510256664"/>The following web page provides a list of all Kubernetes configuration options to modify the generated file:</p>

<ul>
<li>
<p><a href="https://oreil.ly/oLxhT">Quarkus: Kubernetes Extension</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.3 Generating Kubernetes Resources with Health Checks"><div class="sect1" id="idm45128510423480">
<h1>10.3 Generating Kubernetes Resources with Health Checks</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128508342888">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="health checks" data-secondary="generating resources with" id="idm45128508341688"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="generating resources with health checks" id="idm45128508340744"/>You want to automatically generate Kubernetes resources with liveness and readiness probes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128508409192">
<h2>Solution</h2>

<p>By default, health probes are not generated in the output file, but if the <code>quarkus-smallrye-health</code> extension is present (as explained in <a data-type="xref" href="ch09.xhtml#using-automatic-health-checks">Recipe 9.1</a>), then readiness and liveness probe sections are generated automatically:</p>

<pre data-type="programlisting" data-code-language="json"><code class="s2">"image"</code><code> </code><code class="err">:</code><code> </code><code class="s2">"alex/getting-started:1.0-SNAPSHOT"</code><code class="err">,</code><code>
</code><code class="s2">"imagePullPolicy"</code><code> </code><code class="err">:</code><code> </code><code class="s2">"IfNotPresent"</code><code class="err">,</code><code>
</code><code class="s2">"livenessProbe"</code><code> </code><code class="err">:</code><code> </code><code class="p">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO5-1" href="#callout_integrating_with_kubernetes_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
    </code><code class="nt">"failureThreshold"</code><code> </code><code class="p">:</code><code> </code><code class="mi">3</code><code class="p">,</code><code>
    </code><code class="nt">"httpGet"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"path"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"/health/live"</code><code class="p">,</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO5-2" href="#callout_integrating_with_kubernetes_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
        </code><code class="nt">"port"</code><code> </code><code class="p">:</code><code> </code><code class="mi">8080</code><code class="p">,</code><code>
        </code><code class="nt">"scheme"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"HTTP"</code><code>
        </code><code class="p">}</code><code class="p">,</code><code>
    </code><code class="nt">"initialDelaySeconds"</code><code> </code><code class="p">:</code><code> </code><code class="mi">0</code><code class="p">,</code><code>
    </code><code class="nt">"periodSeconds"</code><code> </code><code class="p">:</code><code> </code><code class="mi">30</code><code class="p">,</code><code>
    </code><code class="nt">"successThreshold"</code><code> </code><code class="p">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code>
    </code><code class="nt">"timeoutSeconds"</code><code> </code><code class="p">:</code><code> </code><code class="mi">10</code><code>
</code><code class="p">}</code><code class="err">,</code><code>
</code><code class="s2">"name"</code><code> </code><code class="err">:</code><code> </code><code class="s2">"getting-started"</code><code class="err">,</code><code>
</code><code class="s2">"ports"</code><code> </code><code class="err">:</code><code> </code><code class="p">[</code><code> </code><code class="p">{</code><code>
    </code><code class="nt">"containerPort"</code><code> </code><code class="p">:</code><code> </code><code class="mi">8080</code><code class="p">,</code><code>
    </code><code class="nt">"name"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"http"</code><code class="p">,</code><code>
    </code><code class="nt">"protocol"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"TCP"</code><code>
    </code><code class="p">}</code><code> </code><code class="p">]</code><code class="err">,</code><code>
</code><code class="s2">"readinessProbe"</code><code> </code><code class="err">:</code><code> </code><code class="p">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO5-3" href="#callout_integrating_with_kubernetes_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
    </code><code class="nt">"failureThreshold"</code><code> </code><code class="p">:</code><code> </code><code class="mi">3</code><code class="p">,</code><code>
    </code><code class="nt">"httpGet"</code><code> </code><code class="p">:</code><code> </code><code class="p">{</code><code>
        </code><code class="nt">"path"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"/health/ready"</code><code class="p">,</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO5-4" href="#callout_integrating_with_kubernetes_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
        </code><code class="nt">"port"</code><code> </code><code class="p">:</code><code> </code><code class="mi">8080</code><code class="p">,</code><code>
        </code><code class="nt">"scheme"</code><code> </code><code class="p">:</code><code> </code><code class="s2">"HTTP"</code><code>
    </code><code class="p">}</code><code class="p">,</code><code>
    </code><code class="nt">"initialDelaySeconds"</code><code> </code><code class="p">:</code><code> </code><code class="mi">0</code><code class="p">,</code><code>
    </code><code class="nt">"periodSeconds"</code><code> </code><code class="p">:</code><code> </code><code class="mi">30</code><code class="p">,</code><code>
    </code><code class="nt">"successThreshold"</code><code> </code><code class="p">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code>
    </code><code class="nt">"timeoutSeconds"</code><code> </code><code class="p">:</code><code> </code><code class="mi">10</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO5-1" href="#co_integrating_with_kubernetes_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Defines the liveness probe</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO5-2" href="#co_integrating_with_kubernetes_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The path is the one defined by MicroProfile Health spec</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO5-3" href="#co_integrating_with_kubernetes_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Defines the readiness probe</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO5-4" href="#co_integrating_with_kubernetes_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The path is the one defined by MicroProfile Health spec</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128508479880">
<h2>Discussion</h2>

<p>Kubernetes uses probes to determine the health state of a service and take automatic actions to solve any problem.</p>

<p>Quarkus automatically generates two Kubernetes probes:</p>
<dl>
<dt><a data-type="indexterm" data-primary="liveness health check" id="idm45128508430792"/>Liveness</dt>
<dd>
<p>Kubernetes uses a liveness probe to decide if a service must be restarted. If the application becomes unresponsive, perhaps because of a deadlock or memory problem, restarting the container might be a good solution to fix the problem.</p>
</dd>
<dt><a data-type="indexterm" data-primary="readiness health check" id="idm45128508418520"/>Readiness</dt>
<dd>
<p>Kubernetes uses a readiness probe to decide if a service is available for accepting traffic. Sometimes a service might need to execute some operations before accepting requests. Examples include updating local caching system, populating a change to the database schema, applying a batch process, or connecting to an external service like Kafka Streams.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128508506888">
<h2>See Also</h2>

<p>For more information, see the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/PWl_B">Kubernetes: Configure Liveness, Readiness, and Startup Probes</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.4 Deploying Services on Kubernetes"><div class="sect1" id="idm45128508447160">
<h1>10.4 Deploying Services on Kubernetes</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128508446184">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="services" data-secondary="deploying on Kubernetes" id="idm45128508444984"/><a data-type="indexterm" data-primary="deploying" data-secondary="services on Kubernetes" id="idm45128508422472"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying services on" id="idm45128508421528"/>You want to deploy services on Kubernetes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128508420200">
<h2>Solution</h2>

<p>Use <code>kubectl</code> and all the features offered by Quarkus to create and deploy a service on Kubernetes.</p>

<p>Quarkus makes it really easy to create and deploy a Java application into Kubernetes by doing the following:</p>
<ol>
<li>
<p>Generating a container native executable of your enterprise application, as explained in <a data-type="xref" href="ch06.xhtml#building-a-docker-container-native-file">Recipe 6.6</a></p>
</li>
<li>
<p>Providing a <em>Dockerfile.native</em> file to build the Docker container</p>
</li>
<li>
<p>Generating a Kubernetes resources file by using <code>quarkus-kubernetes</code> extension, as explained in <a data-type="xref" href="#generate-kubernetes-resources">Recipe 10.2</a></p>
</li>

</ol>

<p>It is time to see all these steps working together.</p>

<p>To create a native executable that can be run within a container:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw package -DskipTests -Pnative -Dquarkus.native.container-build=true </code><a class="co" id="co_integrating_with_kubernetes_CO6-1" href="#callout_integrating_with_kubernetes_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">docker build -f src/main/docker/Dockerfile.native \
</code><code class="go">    -t alex/geeting-started:1.0-SNAPSHOT . </code><a class="co" id="co_integrating_with_kubernetes_CO6-2" href="#callout_integrating_with_kubernetes_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">docker push docker build -f src/main/docker/Dockerfile.native \
</code><code class="go">    -t alex/getting-started:1.0-SNAPSHOT . </code><a class="co" id="co_integrating_with_kubernetes_CO6-3" href="#callout_integrating_with_kubernetes_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">kubectl apply -f target/kubernetes/kubernetes.json </code><a class="co" id="co_integrating_with_kubernetes_CO6-4" href="#callout_integrating_with_kubernetes_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">kubectl patch svc getting-started --type='json' \
</code><code class="go">    -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]' </code><a class="co" id="co_integrating_with_kubernetes_CO6-5" href="#callout_integrating_with_kubernetes_CO6-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">curl $(minikube service getting-started --url)/hello </code><a class="co" id="co_integrating_with_kubernetes_CO6-6" href="#callout_integrating_with_kubernetes_CO6-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO6-1" href="#co_integrating_with_kubernetes_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Creates the native executable inside a Docker container</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO6-2" href="#co_integrating_with_kubernetes_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Creates a Docker image with the native executable generated previously</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO6-3" href="#co_integrating_with_kubernetes_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Pushes image to the Docker registry (in minikube, this is <code>eval $(minikube docker-env)</code>, so no push.)</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO6-4" href="#co_integrating_with_kubernetes_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Deploys the application to Kubernetes</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO6-5" href="#co_integrating_with_kubernetes_CO6-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Changes to <code>NodePort</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO6-6" href="#co_integrating_with_kubernetes_CO6-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Gets the URL to access the service</p></dd>
</dl>

<p>Notice that steps 5 and 6 are required only because the service is deployed in minikube.
Depending on the Kubernetes platform you are using to deploy the service to, you might need to do different things.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128508633880">
<h2>Discussion</h2>

<p>Steps 1 and 2 could be simplified into one if you use the multi-stage Docker build feature.
In the first stage, the native executable is generated, and the second stage 
<span class="keep-together">creates</span> the runtime image:</p>

<pre data-type="programlisting" data-code-language="docker"><code class="k">FROM</code><code class="s"> quay.io/quarkus/centos-quarkus-maven:19.2.1 AS build </code><a class="co" id="co_integrating_with_kubernetes_CO7-1" href="#callout_integrating_with_kubernetes_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>COPY</code><code> </code><code>src</code><code> </code><code>/usr/src/app/src</code><code>
</code><code>COPY</code><code> </code><code>pom.xml</code><code> </code><code>/usr/src/app</code><code>
</code><code>USER</code><code> </code><code>root</code><code>
</code><code class="k">RUN</code><code> </code><code>chown</code><code> </code><code>-R</code><code> </code><code>quarkus</code><code> </code><code>/usr/src/app</code><code>
</code><code>USER</code><code> </code><code>quarkus</code><code>
</code><code class="k">RUN</code><code> </code><code>mvn</code><code> </code><code>-f</code><code> </code><code>/usr/src/app/pom.xml</code><code> </code><code>-Pnative</code><code> </code><code>clean</code><code> </code><code>package</code><code>
</code><code>
</code><code class="k">FROM</code><code class="s"> registry.access.redhat.com/ubi8/ubi-minimal </code><a class="co" id="co_integrating_with_kubernetes_CO7-2" href="#callout_integrating_with_kubernetes_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="k">WORKDIR</code><code class="s"> /work/</code><code>
</code><code>COPY</code><code> </code><code>--from</code><code class="o">=</code><code>build</code><code> </code><code>/usr/src/app/target/*-runner</code><code> </code><code>/work/application</code><code>
</code><code class="k">RUN</code><code> </code><code>chmod</code><code> </code><code class="m">775</code><code> </code><code>/work</code><code>
</code><code class="k">EXPOSE</code><code class="s"> 8080</code><code>
</code><code class="k">CMD</code><code class="s"> ["./application", "-Dquarkus.http.host=0.0.0.0"]</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO7-1" href="#co_integrating_with_kubernetes_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Generates the native executable</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO7-2" href="#co_integrating_with_kubernetes_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Creates the runtime image from the output of the previous stage</p></dd>
</dl>

<p>Remove the <em>.dockerignore</em> file from the root directory of the project (<code>rm .dockerignore</code>).
This is necessary because, by default, the <em>src</em> directory is ignored, and to build the native executable, the <em>src</em> directory is required:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker build -f src/main/docker/Dockerfile.multistage -t docker \
</code><code class="go">    build -f src/main/docker/Dockerfile.multistage -t </code><a class="co" id="co_integrating_with_kubernetes_CO8-1" href="#callout_integrating_with_kubernetes_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO8-1" href="#co_integrating_with_kubernetes_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Creates the runtime image with native executable bundled</p></dd>
</dl>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.5 Deploying Services on OpenShift"><div class="sect1" id="idm45128510113288">
<h1>10.5 Deploying Services on OpenShift</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128510112344">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="deploying" data-secondary="services on OpenShift" id="idm45128510111144"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying services on OpenShift" id="idm45128510110168"/><a data-type="indexterm" data-primary="OpenShift" id="idm45128510109256"/>You want to deploy services on OpenShift.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128510108200">
<h2>Solution</h2>

<p>OpenShift works perfectly with the resources generated in the previous recipe, so even though you are using OpenShift, you can still use everything provided previously.
But if you want to use some of the capabilities offered by OpenShift, you can set the <code>kubernetes.deployment.target</code> property to <code>openshift</code>.</p>

<p>The two generated files are placed at <em>target/kubernetes/openshift.json</em> and <em>target/kubernetes/openshift.yaml</em>:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code>
  <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"v1"</code><code class="p">,</code>
  <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"List"</code><code class="p">,</code>
  <code class="nt">"items"</code> <code class="p">:</code> <code class="p">[</code> <code class="p">{</code>
    <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"v1"</code><code class="p">,</code>
    <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"Service"</code><code class="p">,</code>
    <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started"</code>
    <code class="p">},</code>
    <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"ports"</code> <code class="p">:</code> <code class="p">[</code> <code class="p">{</code>
        <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"http"</code><code class="p">,</code>
        <code class="nt">"port"</code> <code class="p">:</code> <code class="mi">8080</code><code class="p">,</code>
        <code class="nt">"targetPort"</code> <code class="p">:</code> <code class="mi">8080</code>
      <code class="p">}</code> <code class="p">],</code>
      <code class="nt">"selector"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"type"</code> <code class="p">:</code> <code class="s2">"ClusterIP"</code>
    <code class="p">}</code>
  <code class="p">},</code> <code class="p">{</code>
    <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"image.openshift.io/v1"</code><code class="p">,</code>
    <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"ImageStream"</code><code class="p">,</code>
    <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started"</code>
    <code class="p">}</code>
  <code class="p">},</code> <code class="p">{</code>
    <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"image.openshift.io/v1"</code><code class="p">,</code>
    <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"ImageStream"</code><code class="p">,</code>
    <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"s2i-java"</code>
    <code class="p">},</code>
    <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"dockerImageRepository"</code> <code class="p">:</code> <code class="s2">"fabric8/s2i-java"</code>
    <code class="p">}</code>
  <code class="p">},</code> <code class="p">{</code>
    <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"build.openshift.io/v1"</code><code class="p">,</code>
    <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"BuildConfig"</code><code class="p">,</code>
    <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started"</code>
    <code class="p">},</code>
    <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"output"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"to"</code> <code class="p">:</code> <code class="p">{</code>
          <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"ImageStreamTag"</code><code class="p">,</code>
          <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started:1.0-SNAPSHOT"</code>
        <code class="p">}</code>
      <code class="p">},</code>
      <code class="nt">"source"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"binary"</code> <code class="p">:</code> <code class="p">{</code> <code class="p">}</code>
      <code class="p">},</code>
      <code class="nt">"strategy"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"sourceStrategy"</code> <code class="p">:</code> <code class="p">{</code>
          <code class="nt">"from"</code> <code class="p">:</code> <code class="p">{</code>
            <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"ImageStreamTag"</code><code class="p">,</code>
            <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"s2i-java:2.3"</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">},</code> <code class="p">{</code>
    <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"apps.openshift.io/v1"</code><code class="p">,</code>
    <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"DeploymentConfig"</code><code class="p">,</code>
    <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started"</code>
    <code class="p">},</code>
    <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"replicas"</code> <code class="p">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="nt">"selector"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
        <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
        <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
      <code class="p">},</code>
      <code class="nt">"template"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
          <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
            <code class="nt">"app"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
            <code class="nt">"version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code><code class="p">,</code>
            <code class="nt">"group"</code> <code class="p">:</code> <code class="s2">"alex"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
          <code class="nt">"containers"</code> <code class="p">:</code> <code class="p">[</code> <code class="p">{</code>
            <code class="nt">"env"</code> <code class="p">:</code> <code class="p">[</code> <code class="p">{</code>
              <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"KUBERNETES_NAMESPACE"</code><code class="p">,</code>
              <code class="nt">"valueFrom"</code> <code class="p">:</code> <code class="p">{</code>
                <code class="nt">"fieldRef"</code> <code class="p">:</code> <code class="p">{</code>
                  <code class="nt">"fieldPath"</code> <code class="p">:</code> <code class="s2">"metadata.namespace"</code>
                <code class="p">}</code>
              <code class="p">}</code>
            <code class="p">},</code> <code class="p">{</code>
              <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"JAVA_APP_JAR"</code><code class="p">,</code>
              <code class="nt">"value"</code> <code class="p">:</code> <code class="s2">"/deployments/getting-started-1.0-SNAPSHOT.jar"</code>
            <code class="p">}</code> <code class="p">],</code>
            <code class="nt">"image"</code> <code class="p">:</code> <code class="s2">""</code><code class="p">,</code>
            <code class="nt">"imagePullPolicy"</code> <code class="p">:</code> <code class="s2">"IfNotPresent"</code><code class="p">,</code>
            <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started"</code><code class="p">,</code>
            <code class="nt">"ports"</code> <code class="p">:</code> <code class="p">[</code> <code class="p">{</code>
              <code class="nt">"containerPort"</code> <code class="p">:</code> <code class="mi">8080</code><code class="p">,</code>
              <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"http"</code><code class="p">,</code>
              <code class="nt">"protocol"</code> <code class="p">:</code> <code class="s2">"TCP"</code>
            <code class="p">}</code> <code class="p">],</code>
          <code class="p">}</code> <code class="p">]</code>
        <code class="p">}</code>
      <code class="p">},</code>
      <code class="nt">"triggers"</code> <code class="p">:</code> <code class="p">[</code> <code class="p">{</code>
        <code class="nt">"imageChangeParams"</code> <code class="p">:</code> <code class="p">{</code>
          <code class="nt">"automatic"</code> <code class="p">:</code> <code class="kc">true</code><code class="p">,</code>
          <code class="nt">"containerNames"</code> <code class="p">:</code> <code class="p">[</code> <code class="s2">"getting-started"</code> <code class="p">],</code>
          <code class="nt">"from"</code> <code class="p">:</code> <code class="p">{</code>
            <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"ImageStreamTag"</code><code class="p">,</code>
            <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"getting-started:1.0-SNAPSHOT"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="nt">"type"</code> <code class="p">:</code> <code class="s2">"ImageChange"</code>
      <code class="p">}</code> <code class="p">]</code>
    <code class="p">}</code>
  <code class="p">}</code> <code class="p">]</code>
<code class="p">}</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.6 Building and Deploying a Container Image Automatically"><div class="sect1" id="build-deploy-container-image-automatically">
<h1>10.6 Building and Deploying a Container Image Automatically</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128509103816">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Kubernetes" data-secondary="building container images" id="idm45128509102648"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying container images" id="idm45128509101656"/><a data-type="indexterm" data-primary="container images" id="idm45128509100696"/><a data-type="indexterm" data-primary="deploying" data-secondary="container images" id="idm45128509100024"/>You want to build, push, and deploy container images automatically.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128509098696">
<h2>Solution</h2>

<p>Quarkus provides extensions for building and pushing container images with the <code>container-image</code> extensions and for deploying to Kubernetes using the <code>kubernetes</code> extension.</p>

<p>To build, push, and deploy a container image, you need to first add the required extensions:</p>

<pre data-type="programlisting" data-code-language="bash">./mvnw quarkus:add-extensions <code class="se">\</code>
    -Dextensions<code class="o">=</code><code class="s2">"quarkus-container-image-jib, quarkus-kubernetes"</code></pre>

<p>Then you can customize the container image build process.
You can set these properties in the <em>application.properties</em>, system properties, or environment variables as any other configuration parameter in Quarkus:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.container-image.group</code><code class="o">=</code><code class="s">lordofthejars </code><a class="co" id="co_integrating_with_kubernetes_CO9-1" href="#callout_integrating_with_kubernetes_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.registry</code><code class="o">=</code><code class="s">quay.io </code><a class="co" id="co_integrating_with_kubernetes_CO9-2" href="#callout_integrating_with_kubernetes_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.username</code><code class="o">=</code><code class="s">lordofthejars </code><a class="co" id="co_integrating_with_kubernetes_CO9-3" href="#callout_integrating_with_kubernetes_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="c">#quarkus.container-image.password= </code><a class="co" id="co_integrating_with_kubernetes_CO9-4" href="#callout_integrating_with_kubernetes_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO9-1" href="#co_integrating_with_kubernetes_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the group part of the image; by default this is <code>${user.name}</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO9-2" href="#co_integrating_with_kubernetes_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Registry where to push the image; by default, images are pushed to <code>docker.io</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO9-3" href="#co_integrating_with_kubernetes_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The username to log into the container registry</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO9-4" href="#co_integrating_with_kubernetes_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The password to log into the container registry</p></dd>
</dl>

<p>Finally, deploy to Kubernetes using the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -Dquarkus.kubernetes.deploy=true</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128509310264">
<h2>Discussion</h2>

<p>Notice that setting <code>quarkus.kubernetes.deploy</code> to <code>true</code> implicitly sets the <code>quarkus.container-image.push</code> property to <code>true</code>, so you do not need to set it 
<span class="keep-together">manually</span>.</p>

<p>The Kubernetes extension uses the standard <code>kubectl</code> configuration file located at <em>~/.kube/config</em> to know where to deploy the application.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can also use <code>-Pnative -Dquarkus.native.container-build=true</code> flags to create and deploy a container image with native compilation.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.7 Configuring an Application from Kubernetes"><div class="sect1" id="idm45128509295448">
<h1>10.7 Configuring an Application from Kubernetes</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128509294232">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="configuration" data-secondary="applications from Kubernetes" id="idm45128509305624"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="configuring applications from" id="idm45128509304680"/>You want to configure your application through (or via) Kubernetes instead of the configuration file.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128509303272">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="ConfigMaps" id="idm45128509301704"/>Use <code>ConfigMaps</code> to configure the applications running inside a pod.</p>

<p>In this example, you are going to configure a service using a <code>ConfigMap</code> and Kubernetes extension.
To enable the generation of Kubernetes resources with the <code>ConfigMap</code> injection in the <code>Pod</code>, you need to register the <code>quarkus-kubernetes</code> extension:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-kubernetes"</code></pre>

<p>The service returns the <code>greeting.message</code> configuration value when the <code>/hello</code> endpoint is called:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code> <code class="o">=</code> <code class="s">"greeting.message"</code><code class="o">)</code>
<code class="n">String</code> <code class="n">message</code><code class="o">;</code>

<code class="nd">@GET</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="s">"hello "</code> <code class="o">+</code> <code class="n">message</code><code class="o">;</code>
<code class="o">}</code></pre>

<p>Create the <code>ConfigMap</code> resource with the key-value pairs:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ConfigMap</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO10-1" href="#callout_integrating_with_kubernetes_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">greeting-config</code><code>
</code><code class="nt">data</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">greeting</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">Kubernetes</code><code class="s">"</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO10-2" href="#callout_integrating_with_kubernetes_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO10-1" href="#co_integrating_with_kubernetes_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Defines the <code>ConfigMap</code> type</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO10-2" href="#co_integrating_with_kubernetes_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>For the key <code>greeting</code> defines the value <code>Kubernetes</code></p></dd>
</dl>

<p>Then the resource must be applied to the Kubernetes cluster by running the next command in a terminal window:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl apply -f src/main/kubernetes/config-greeting.yaml</code></pre>

<p>Finally, set the Kubernetes extension properties in the <em>application.properties</em> so that the generated Kubernetes deployment file contains the segments to inject the config map as an environment variable:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">greeting.message</code><code class="o">=</code><code class="s">local</code><code>
</code><code class="na">quarkus.container-image.group</code><code class="o">=</code><code class="s">quarkus </code><a class="co" id="co_integrating_with_kubernetes_CO11-1" href="#callout_integrating_with_kubernetes_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.name</code><code class="o">=</code><code class="s">greeting-app</code><code>
</code><code class="na">quarkus.container-image.tag</code><code class="o">=</code><code class="s">1.0-SNAPSHOT</code><code>
</code><code class="na">quarkus.kubernetes.env-vars.greeting-message.value</code><code class="o">=</code><code class="s">greeting </code><a class="co" id="co_integrating_with_kubernetes_CO11-2" href="#callout_integrating_with_kubernetes_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.env-vars.greeting-message.configmap</code><code class="o">=</code><code class="s">greeting-config </code><a class="co" id="co_integrating_with_kubernetes_CO11-3" href="#callout_integrating_with_kubernetes_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.image-pull-policy</code><code class="o">=</code><code class="s">if-not-present</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO11-1" href="#co_integrating_with_kubernetes_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Configures Docker image</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO11-2" href="#co_integrating_with_kubernetes_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the environment variable to override the <code>greeting.message</code> property</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO11-3" href="#co_integrating_with_kubernetes_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the config map resource name to load</p></dd>
</dl>

<p>The generation of the Kubernetes file will contain a new entry defining the key-value pairs in the container definition called <code>configMapKeyRef</code>.</p>

<p>To deploy the application, open a new terminal window, package the application, 
<span class="keep-together">create</span> the Docker container, and apply the generated Kubernetes resources:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -DskipTests</code>

<code class="go">docker build -f src/main/docker/Dockerfile.jvm \</code>
<code class="go">    -t quarkus/greeting-app:1.0-SNAPSHOT .</code>
<code class="go">kubectl apply -f target/kubernetes/kubernetes.yml</code>

<code class="go">kubectl patch svc greeting-app --type='json' \</code>
<code class="go">    -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]'</code>
<code class="go">curl $(minikube service greeting-app --url)/hello</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128509302808">
<h2>Discussion</h2>

<p><code>ConfigMap</code> consists of key-value pairs that Kubernetes injects into pods’ containers in the form of files or environment variables so the application can read them and configure accordingly.
With <code>ConfigMaps</code>, you can decouple the configuration of the application from the business logic, making it portable across environments.</p>
<div data-type="important"><h6>Important</h6>
<p><code>ConfigMaps</code> are meant to be used for storing and sharing non-sensitive configuration properties.</p>
</div>

<p><a data-type="indexterm" data-primary="MicroProfile Config specification" id="idm45128508818504"/>The MicroProfile Config spec permits the override of any configuration property using the equivalent environment variable (in uppercase and changing dots [<code>.</code>] to underscores [<code>_</code>]).
The <code>ConfigMap</code> contains the configuration properties. In <em>application.properties</em>, the Kubernetes extension is configured to generate a deployment descriptor that sets these properties as environment variables so that when the 
<span class="keep-together">container</span> is started inside the Kubernetes cluster, the specific configuration applied to this cluster is used.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128508830120">
<h2>See Also</h2>

<p>To learn more about <code>ConfigMaps</code> in Kubernetes, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/BPmo5">Kubernetes: Configure a Pod to Use a ConfigMap</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.8 Configuring an Application from Kubernetes with Config Extension"><div class="sect1" id="idm45128508826216">
<h1>10.8 Configuring an Application from Kubernetes with Config Extension</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128508825240">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Config extension, configuring application from Kubernetes with" id="idm45128508824040"/><a data-type="indexterm" data-primary="configuration" data-secondary="applications from Kubernetes" id="idm45128508883304"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="configuring applications from" id="idm45128508882392"/>You want to configure your application through (or via) Kubernetes instead of the configuration file using the MicroProfile Config specification.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128508880936">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="@ConfigProperty annotation" id="idm45128508879048"/>Quarkus has a Kubernetes Configuration extension that can read the secrets and config maps elements from the Kubernetes API Server and inject them using <code>@ConfigProperty</code> annotation.</p>

<p>To enable the generation of Kubernetes resources, you need to register the <code>quarkus-kubernetes-config</code> extension.</p>

<p>The extension supports injecting <code>ConfigMaps</code>, either as a single key/value form 
<span class="keep-together">or in the form</span> in which the key is a filename (where only <code>application.properties</code> or 
<span class="keep-together"><code>application.yaml</code></span> is supported) and the value is the content of that file.</p>

<p>Let’s create a config map with a single key/value:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ConfigMap</code><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">my-config</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO12-1" href="#callout_integrating_with_kubernetes_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nt">data</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">greeting</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">Kubernetes</code><code class="s">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO12-1" href="#co_integrating_with_kubernetes_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Config name is important for the extension</p></dd>
</dl>

<p>Then register the previous <code>ConfigMap</code> resource:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl apply -f src/main/kubernetes/my-config.yaml</code></pre>

<p>For this example, an <em>application.properties</em> file as <code>ConfigMap</code> is also registered.</p>

<p>The configuration file added contains the following:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">some.property1</code><code class="o">=</code><code class="s">prop1</code>
<code class="na">some.property2</code><code class="o">=</code><code class="s">prop2</code></pre>

<p>Then register the previous file in a <code>ConfigMap</code> named <code>my-file-config</code>:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl create configmap my-file-config \</code>
<code class="go">    --from-file=./src/main/kubernetes/application.properties</code></pre>

<p>The last step before you can inject these values is to configure the extension to read values from these <code>ConfigMaps</code>:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.kubernetes-config.enabled</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_integrating_with_kubernetes_CO13-1" href="#callout_integrating_with_kubernetes_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes-config.config-maps</code><code class="o">=</code><code class="s">my-config,my-file-config </code><a class="co" id="co_integrating_with_kubernetes_CO13-2" href="#callout_integrating_with_kubernetes_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO13-1" href="#co_integrating_with_kubernetes_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Enables the extension</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO13-2" href="#co_integrating_with_kubernetes_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the <code>ConfigMap</code> names</p></dd>
</dl>

<p>These configuration values are injected like any other configuration value:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s">"greeting"</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO14-1" href="#callout_integrating_with_kubernetes_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">String</code><code> </code><code class="n">greeting</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s">"some.property1"</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO14-2" href="#callout_integrating_with_kubernetes_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">String</code><code> </code><code class="n">property1</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s">"some.property2"</code><code class="o">)</code><code>
</code><code class="n">String</code><code> </code><code class="n">property2</code><code class="o">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO14-1" href="#co_integrating_with_kubernetes_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Simple key is injected</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO14-2" href="#co_integrating_with_kubernetes_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Keys from the <em>application.properties</em> file are injected too</p></dd>
</dl>

<p>To deploy the application, open a new terminal window, package the application, 
<span class="keep-together">create</span> the Docker container, and apply the generated Kubernetes resources:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -DskipTests</code>

<code class="go">docker build -f src/main/docker/Dockerfile.jvm \</code>
<code class="go">    -t quarkus/greeting-app:1.0-SNAPSHOT .</code>
<code class="go">kubectl apply -f target/kubernetes/kubernetes.yml</code>

<code class="go">kubectl patch svc greeting-app-config-ext --type='json' \</code>
<code class="go">    -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]'</code>

<code class="go">curl $(minikube service greeting-app-config-ext --url)/hello</code>
<code class="go">Kubernetes</code>

<code class="go">curl $(minikube service greeting-app-config-ext --url)/hello/p1</code>
<code class="go">prop1</code>

<code class="go">curl $(minikube service greeting-app-config-ext --url)/hello/p2</code>
<code class="go">prop2</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.9 Interacting with a Kubernetes Cluster Programmatically"><div class="sect1" id="idm45128509829304">
<h1>10.9 Interacting with a Kubernetes Cluster Programmatically</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128509844712">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="clusters, interacting with Kubernetes" id="clu_int"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="interacting with clusters programmatically" id="kub_clu"/>You want to interact with a Kubernetes API server programmatically.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128509840968">
<h2>Solution</h2>

<p>Use the <code>kubernetes-client</code> extension to start watching and reacting to changes on Kubernetes resources.</p>

<p>To add the <code>kubernetes-extension</code>, run the following:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="kubernetes-client"</code></pre>

<p>The main class to connect to the Kubernetes cluster is <code>io.fabric8.kubernetes.client.KubernetesClient</code>.
The extension produces this instance so it can be injected in the code.
The client can be configured using various properties, setting them in <em>application.properties</em>.</p>

<p>The example developed here is an endpoint that returns the name of all deployed pods on the given namespace:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.List</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.stream.Collectors</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.inject.Inject</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.GET</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Path</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.PathParam</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Produces</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.KubernetesClient</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/pod"</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">PodResource</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>    </code><code class="nd">@Inject</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO15-1" href="#callout_integrating_with_kubernetes_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">KubernetesClient</code><code> </code><code class="n">kubernetesClient</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code><code>
</code><code>    </code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/{namespace}"</code><code class="o">)</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="nf">getPods</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"namespace"</code><code class="o">)</code><code> </code><code class="n">String</code><code> </code><code class="n">namespace</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">kubernetesClient</code><code class="o">.</code><code class="na">pods</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO15-2" href="#callout_integrating_with_kubernetes_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>                                </code><code class="o">.</code><code class="na">inNamespace</code><code class="o">(</code><code class="n">namespace</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO15-3" href="#callout_integrating_with_kubernetes_CO15-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>                                </code><code class="o">.</code><code class="na">list</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getItems</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                                </code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                                </code><code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">p</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">p</code><code class="o">.</code><code class="na">getMetadata</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getGenerateName</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO15-4" href="#callout_integrating_with_kubernetes_CO15-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>                                </code><code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">Collectors</code><code class="o">.</code><code class="na">toList</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO15-1" href="#co_integrating_with_kubernetes_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The <code>KubernetesClient</code> is injected like any other CDI bean</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO15-2" href="#co_integrating_with_kubernetes_CO15-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Select all pods</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO15-3" href="#co_integrating_with_kubernetes_CO15-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>From given namespace</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO15-4" href="#co_integrating_with_kubernetes_CO15-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Gets only the generated name of the pod</p></dd>
</dl>

<p>The recommended way to access the REST API of Kubernetes is by using <code>kubectl</code> in proxy mode because no man-in-the-middle attack is possible.</p>

<p>The other way is by providing the location and the credentials directly, but to avoid man-in-the-middle attacks you might need to import the root certificate.</p>

<p>Because the proxy mode is the recommended way, this is the method used for this example.</p>

<p>Pointing <code>kubectl</code> to the cluster that the application must connect with, open a new terminal window and run the next command:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl proxy --port=8090</code></pre>

<p>This command runs <code>kubectl</code> as a reverse proxy, exposing the remote Kubernetes API server at 
<span class="orm:hideurl"><a href="http://localhost:8090"><em class="hyperlink">http://localhost:8090</em></a></span>.</p>

<p>Configure <code>KubernetesClient</code> to connect to 
<span class="orm:hideurl"><a href="http://localhost:8090"><em class="hyperlink">http://localhost:8090</em></a></span> by using the <code>quarkus.kubernetes-client.master-url</code> property in <em>application.properties</em>:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">%dev.quarkus.kubernetes-client.master-url</code><code class="o">=</code><code class="s">http://localhost:8090 </code><a class="co" id="co_integrating_with_kubernetes_CO16-1" href="#callout_integrating_with_kubernetes_CO16-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO16-1" href="#co_integrating_with_kubernetes_CO16-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the URL of the Kubernetes API server</p></dd>
</dl>

<p>Finally, run the service and make a request to the <code>/pod/default</code> endpoint to get all the pods deployed in the default namespace:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw compile quarkus:dev</code>

<code class="go">curl http://localhost:8080/pod/default</code>
<code class="go">["getting-started-5cd97ddd4d-"]</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128509840376">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="Kubernetes Operator" id="idm45128507801032"/>In some circumstances, you need to create new Kubernetes resources programmatically or get some information about Kubernetes clusters/resources (what pods 
<span class="keep-together">are deployed,</span> configuration parameters, set secrets, and so on).
Where <code>kubernetes-client</code> really shines is in implementing a <em>Kubernetes Operator</em> in Java.
Thanks to 
<span class="keep-together">the capabilities</span> of Quarkus to generate a native executable, this is a great way to 
<span class="keep-together">implement</span> Kubernetes Operators in Java.</p>

<p>In this example, the service was deployed outside the Kubernetes cluster, and you connect to it using the Kubernetes API server.</p>

<p>If the service was deployed into the Kubernetes cluster that needs to be accessed, then the <code>quarkus.kubernetes-client.master-url</code> property must be set to <code>https://kubernetes.default.svc</code>.</p>

<p>The creation of <code>KubernetesClient</code> can be overridden by simply declaring a CDI 
<span class="keep-together">provider</span> factory method returning the configured instance of <code>KubernetesClient</code>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@ApplicationScoped</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">KubernetesClientProducer</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>    </code><code class="nd">@Produces</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">KubernetesClient</code><code> </code><code class="nf">kubernetesClient</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">Config</code><code> </code><code class="n">config</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ConfigBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                              </code><code class="o">.</code><code class="na">withMasterUrl</code><code class="o">(</code><code class="s">"https://mymaster.com"</code><code class="o">)</code><code>
</code><code>                              </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO17-1" href="#callout_integrating_with_kubernetes_CO17-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">DefaultKubernetesClient</code><code class="o">(</code><code class="n">config</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO17-2" href="#callout_integrating_with_kubernetes_CO17-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO17-1" href="#co_integrating_with_kubernetes_CO17-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Configures the client</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO17-2" href="#co_integrating_with_kubernetes_CO17-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Creates an instance of <code>KubernetesClient</code></p></dd>
</dl>

<p>In most cases, to access the Kubernetes API server, a <code>ServiceAccount</code>, <code>Role</code>, and <code>RoleBinding</code> are necessary.
The following might be a starting point to work the example provided in this section:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nn">---</code>
<code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">v1</code>
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">ServiceAccount</code>
<code class="nt">metadata</code><code class="p">:</code>
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">greeting-started</code>
  <code class="nt">namespace</code><code class="p">:</code> <code class="l-Scalar-Plain">default</code>
<code class="nn">---</code>
<code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code>
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Role</code>
<code class="nt">metadata</code><code class="p">:</code>
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">greeting-started</code>
  <code class="nt">namespace</code><code class="p">:</code> <code class="l-Scalar-Plain">default</code>
<code class="nt">rules</code><code class="p">:</code>
  <code class="p-Indicator">-</code> <code class="nt">apiGroups</code><code class="p">:</code> <code class="p-Indicator">[</code><code class="s">""</code><code class="p-Indicator">]</code>
    <code class="nt">resources</code><code class="p">:</code> <code class="p-Indicator">[</code><code class="s">"pods"</code><code class="p-Indicator">]</code>
    <code class="nt">verbs</code><code class="p">:</code> <code class="p-Indicator">[</code><code class="s">"list"</code><code class="p-Indicator">]</code>
<code class="nn">---</code>
<code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code>
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">RoleBinding</code>
<code class="nt">metadata</code><code class="p">:</code>
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">greeting-started</code>
  <code class="nt">namespace</code><code class="p">:</code> <code class="l-Scalar-Plain">default</code>
<code class="nt">roleRef</code><code class="p">:</code>
  <code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Role</code>
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">greeting-started</code>
  <code class="nt">apiGroup</code><code class="p">:</code> <code class="l-Scalar-Plain">rbac.authorization.k8s.io</code>
<code class="nt">subjects</code><code class="p">:</code>
  <code class="p-Indicator">-</code> <code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">ServiceAccount</code>
    <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">greeting-started</code>
    <code class="nt">namespace</code><code class="p">:</code> <code class="l-Scalar-Plain">default</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128507633768">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="clu_int" id="idm45128507632760"/><a data-type="indexterm" data-primary="" data-startref="kub_clu" id="idm45128507535048"/>To learn more about Fabric8 Kubernetes Client, visit the following page on GitHub:</p>

<ul>
<li>
<p><a href="https://oreil.ly/_QNSL">Kubernetes &amp; OpenShift Java Client</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.10 Testing Kubernetes Client Interactions"><div class="sect1" id="idm45128507532008">
<h1>10.10 Testing Kubernetes Client Interactions</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128507531032">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="testing" data-secondary="Kubernetes client interactions" id="idm45128507529832"/><a data-type="indexterm" data-primary="client interactions, testing" id="idm45128507528888"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="testing client interactions" id="idm45128507528248"/>You want to test Kubernetes Client code.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128507526952">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="Quarkus Test Resource extension" id="idm45128507525544"/>Quarkus implements a Quarkus Test Resource that launches a mock of the Kubernetes API server and sets the correct configuration to make the Kubernetes Client use the mock server instance instead of the value provided in <em>application.properties</em>.
Moreover, you can set up the mock server to respond to any canned request required for any particular test:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.Pod</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.PodBuilder</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.PodListBuilder</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.server.mock.KubernetesMockServer</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.test.common.QuarkusTestResource</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.test.junit.QuarkusTest</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.test.kubernetes.client.KubernetesMockServerTestResource</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.test.kubernetes.client.MockServer</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.junit.jupiter.api.BeforeEach</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.junit.jupiter.api.Test</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">static</code><code> </code><code class="n">io</code><code class="o">.</code><code class="na">restassured</code><code class="o">.</code><code class="na">RestAssured</code><code class="o">.</code><code class="na">given</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">static</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">hamcrest</code><code class="o">.</code><code class="na">CoreMatchers</code><code class="o">.</code><code class="na">is</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@QuarkusTest</code><code>
</code><code class="nd">@QuarkusTestResource</code><code class="o">(</code><code class="n">KubernetesMockServerTestResource</code><code class="o">.</code><code class="na">class</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO18-1" href="#callout_integrating_with_kubernetes_CO18-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">PodResourceTest</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>    </code><code class="nd">@MockServer</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO18-2" href="#callout_integrating_with_kubernetes_CO18-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">KubernetesMockServer</code><code> </code><code class="n">mockServer</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="nd">@BeforeEach</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO18-3" href="#callout_integrating_with_kubernetes_CO18-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">prepareKubernetesServerAPI</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="kd">final</code><code> </code><code class="n">Pod</code><code> </code><code class="n">pod1</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">PodBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">withNewMetadata</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">withName</code><code class="o">(</code><code class="s">"pod1"</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">withNamespace</code><code class="o">(</code><code class="s">"test"</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">withGenerateName</code><code class="o">(</code><code class="s">"pod1-12345"</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">and</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO18-4" href="#callout_integrating_with_kubernetes_CO18-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>
</code><code>        </code><code class="n">mockServer</code><code>
</code><code>                </code><code class="o">.</code><code class="na">expect</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                  </code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">withPath</code><code class="o">(</code><code class="s">"/api/v1/namespaces/test/pods"</code><code class="o">)</code><code>
</code><code>                    </code><code class="o">.</code><code class="na">andReturn</code><code class="o">(</code><code class="mi">200</code><code class="o">,</code><code> </code><code class="k">new</code><code> </code><code class="n">PodListBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                        </code><code class="o">.</code><code class="na">withNewMetadata</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                        </code><code class="o">.</code><code class="na">withResourceVersion</code><code class="o">(</code><code class="s">"1"</code><code class="o">)</code><code>
</code><code>                        </code><code class="o">.</code><code class="na">endMetadata</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                        </code><code class="o">.</code><code class="na">withItems</code><code class="o">(</code><code class="n">pod1</code><code class="o">)</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO18-5" href="#callout_integrating_with_kubernetes_CO18-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>                </code><code class="o">.</code><code class="na">always</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@Test</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">testHelloEndpoint</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">given</code><code class="o">(</code><code class="o">)</code><code>
</code><code>          </code><code class="o">.</code><code class="na">when</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"/pod/test"</code><code class="o">)</code><code>
</code><code>          </code><code class="o">.</code><code class="na">then</code><code class="o">(</code><code class="o">)</code><code>
</code><code>             </code><code class="o">.</code><code class="na">statusCode</code><code class="o">(</code><code class="mi">200</code><code class="o">)</code><code>
</code><code>             </code><code class="o">.</code><code class="na">body</code><code class="o">(</code><code class="n">is</code><code class="o">(</code><code class="s">"[\"pod1-12345\"]"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code class="o">}</code></pre>
<div style="page-break-after: always;"/>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO18-1" href="#co_integrating_with_kubernetes_CO18-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets Kubernetes Test Resource mock server</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO18-2" href="#co_integrating_with_kubernetes_CO18-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Injects Kubernetes mock server instance to record any interaction</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO18-3" href="#co_integrating_with_kubernetes_CO18-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>To maintain test isolation, before every test, the interaction is recorded again</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO18-4" href="#co_integrating_with_kubernetes_CO18-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Builds the pod to be returned</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO18-5" href="#co_integrating_with_kubernetes_CO18-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>The pod is returned as a result of querying all pods from <code>test</code> namespace</p></dd>
</dl>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.11 Implementing a Kubernetes Operator"><div class="sect1" id="idm45128507372936">
<h1>10.11 Implementing a Kubernetes Operator</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128507476312">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Kubernetes" data-secondary="implementing Kubernetes Operator" id="kub_kub"/><a data-type="indexterm" data-primary="Kubernetes Operator" id="ko_ab"/>You want to implement a Kubernetes Operator to extend Kubernetes using custom resources to manage applications in Java.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128507472440">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="kubernetes-client extension" id="idm45128507471272"/>Use the <code>kubernetes-client</code> extension and Quarkus to implement a Kubernetes 
<span class="keep-together">operator</span> in Java and compile it into a native executable.</p>

<p><a data-type="indexterm" data-primary="templates" id="idm45128507467640"/><a data-type="indexterm" data-primary="custom resource" id="idm45128507466936"/>One of the use cases for an operator is to create a template (<em>custom resource</em>) where some values are set in the creation time.
The biggest difference between a file template and an operator is that the common content (in the case of a <em>template</em>) is static, whereas in an operator it is set programmatically, which means that you’ve got the freedom to change the definition of the common part dynamically.
This is known as a <em>custom resource</em>, in which, instead of using a well-known Kubernetes resource, you implement your own custom Kubernetes resource with your own fields.</p>

<p>Another use case might be to react/operate when something happens inside the 
<span class="keep-together">cluster</span>.
Suppose you’ve got some in-memory data grids deployed on the cluster, and one of these instances dies.
Maybe in this case what you want is to notify all living 
<span class="keep-together">instances</span> that one of the elements of the data grid cluster has been stopped.</p>

<p>As you can see, it is about not only the creation of a resource but also applying some tasks that are specific to your application that need to be done atop one of the tasks that Kubernetes is already doing.</p>

<p>The Kubernetes Operator uses Kubernetes API to decide when and how to run some of these customizations.</p>

<p>The following simple example does not make a lot of sense from the point of view 
<span class="keep-together">of the</span> logic it implements, but it will help you understand the basics of writing a 
<span class="keep-together">Kubernetes</span> Operator. Use it as a starting point for implementing your own Kubernetes Operators.</p>

<p>To write a Kubernetes Operator, the following elements may be needed:</p>
<ol>
<li>
<p>Classes that parse custom resources.</p>
</li>
<li>
<p>Factory method that registers and generates a client to operate with custom resources.</p>
</li>
<li>
<p>A watcher that reacts when a custom resource is applied to the cluster. You can think of it as the operator controller or the operator implementation.</p>
</li>
<li>
<p>Docker image with all previous code.</p>
</li>
<li>
<p>YAML/JSON file to define the custom resource (<code>CustomResourceDefinition</code>).</p>
</li>
<li>
<p>Deployment file to deploy the custom operator.</p>
</li>

</ol>

<p>Let’s implement a simple Kubernetes Operator that configures the command to run in the container and instantiates the pod with this configuration.</p>

<p>The base image used for the example is <a href="https://oreil.ly/98T7t">Whalesay</a>, which basically prints in the container console the message you passed as argument in the <code>run</code> command, like this:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker run docker/whalesay cowsay boo</code>
<code class="go"> _____</code>
<code class="go">&lt; boo &gt;</code>
<code class="go"> -----</code>
<code class="go">    \</code>
<code class="go">     \</code>
<code class="go">      \</code>
<code class="go">                    ##        .</code>
<code class="go">              ## ## ##       ==</code>
<code class="go">           ## ## ## ##      ===</code>
<code class="go">       /""""""""""""""""___/ ===</code>
<code class="go">  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~</code>
<code class="go">       \______ o          __/</code>
<code class="go">        \    \        __/</code>
<code class="go">          \____\______/</code></pre>

<p>An example of a pod resource using this image could look like the following:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Pod</code><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">whalesay</code><code>
</code><code class="nt">spec</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">containers</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">whalesay</code><code>
</code><code>    </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">docker/whalesay</code><code>
</code><code>    </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">IfNotPresent</code><code class="s">"</code><code>
</code><code>    </code><code class="nt">command</code><code class="p">:</code><code> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">cowsay</code><code class="s">"</code><code class="p-Indicator">,</code><code class="s">"</code><code class="s">Hello</code><code class="nv"> </code><code class="s">Alex</code><code class="s">"</code><code class="p-Indicator">]</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO19-1" href="#callout_integrating_with_kubernetes_CO19-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO19-1" href="#co_integrating_with_kubernetes_CO19-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the output message</p></dd>
</dl>

<p>The goal of this operator is that only the message to be printed must be provided. The rest of the content (e.g., Docker image, container configuration, etc.) is set by the Kubernetes Operator automatically.</p>

<p><a data-type="indexterm" data-primary="Kubernetes Client" id="idm45128507397464"/><a data-type="indexterm" data-primary="Jackson" id="idm45128507396904"/>To create a custom operator, the Kubernetes Client and Jackson dependencies are required:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension \</code>
<code class="go">-Dextensions="io.quarkus:quarkus-kubernetes-client, io.quarkus:quarkus-jackson"</code></pre>

<p>The first thing to do is define what the custom resource looks like.
For this example, it looks like the following:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">acme.org/v1alpha1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Hello</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO20-1" href="#callout_integrating_with_kubernetes_CO20-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">example-hello</code><code>
</code><code class="nt">spec</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">message</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Hello</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Alex</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO20-2" href="#callout_integrating_with_kubernetes_CO20-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO20-1" href="#co_integrating_with_kubernetes_CO20-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Uses custom <code>kind</code> schema (defined later in this recipe)</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO20-2" href="#co_integrating_with_kubernetes_CO20-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the message to print</p></dd>
</dl>

<p>An object model is required to parse the custom resource.
In this case, the Jackson library is used to map from YAML to Java Object.
Three classes are required, one for the whole resource, another one for the <code>spec</code> section, and another one for the <code>status</code> section, which is empty but required because it might be filled automatically by the cluster.</p>

<p>Create all of them at <em>src/main/java</em> inside package <code>org.acme.quickstart.cr</code>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">.</code><code class="na">cr</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">com.fasterxml.jackson.databind.annotation.JsonDeserialize</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.CustomResource</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@JsonDeserialize</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO21-1" href="#callout_integrating_with_kubernetes_CO21-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">HelloResource</code><code> </code><code class="kd">extends</code><code> </code><code class="n">CustomResource</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO21-2" href="#callout_integrating_with_kubernetes_CO21-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">HelloResourceSpec</code><code> </code><code class="n">spec</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO21-3" href="#callout_integrating_with_kubernetes_CO21-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">HelloResourceStatus</code><code> </code><code class="n">status</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO21-4" href="#callout_integrating_with_kubernetes_CO21-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">HelloResourceStatus</code><code> </code><code class="nf">getStatus</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">status</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">setStatus</code><code class="o">(</code><code class="n">HelloResourceStatus</code><code> </code><code class="n">status</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">status</code><code> </code><code class="o">=</code><code> </code><code class="n">status</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">HelloResourceSpec</code><code> </code><code class="nf">getSpec</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">spec</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">setSpec</code><code class="o">(</code><code class="n">HelloResourceSpec</code><code> </code><code class="n">spec</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">spec</code><code> </code><code class="o">=</code><code> </code><code class="n">spec</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@Override</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">toString</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="s">"name="</code><code> </code><code class="o">+</code><code> </code><code class="n">getMetadata</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">+</code><code> </code><code class="s">", version="</code><code> </code><code class="o">+</code><code> </code><code class="n">getMetadata</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getResourceVersion</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">+</code><code> </code><code class="s">", spec="</code><code> </code><code class="o">+</code><code> </code><code class="n">spec</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO21-1" href="#co_integrating_with_kubernetes_CO21-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets POJO as deserializable</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO21-2" href="#co_integrating_with_kubernetes_CO21-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Inherits common custom resource fields like <code>kind</code>, <code>apiVersion</code>, or <code>metadata</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO21-3" href="#co_integrating_with_kubernetes_CO21-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Custom <code>spec</code> section</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO21-4" href="#co_integrating_with_kubernetes_CO21-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p><code>status</code> section</p></dd>
</dl>

<p>The <code>spec</code> section is mapped as follows:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">.</code><code class="na">cr</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">com.fasterxml.jackson.annotation.JsonProperty</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">com.fasterxml.jackson.databind.annotation.JsonDeserialize</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@JsonDeserialize</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">HelloResourceSpec</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>    </code><code class="nd">@JsonProperty</code><code class="o">(</code><code class="s">"message"</code><code class="o">)</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO22-1" href="#callout_integrating_with_kubernetes_CO22-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">String</code><code> </code><code class="n">message</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">getMessage</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">message</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">setMessage</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">message</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">message</code><code> </code><code class="o">=</code><code> </code><code class="n">message</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@Override</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">toString</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="s">"HelloResourceSpec [message="</code><code> </code><code class="o">+</code><code> </code><code class="n">message</code><code> </code><code class="o">+</code><code> </code><code class="s">"]"</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO22-1" href="#co_integrating_with_kubernetes_CO22-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The custom spec contains only a <code>message</code> field</p></dd>
</dl>

<p>And the empty <code>status</code> section is mapped as follows:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">.</code><code class="na">cr</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">com.fasterxml.jackson.databind.annotation.JsonDeserialize</code><code class="o">;</code>

<code class="nd">@JsonDeserialize</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">HelloResourceStatus</code> <code class="o">{</code>
<code class="o">}</code></pre>

<p>Still, two classes are required from the model point of view.</p>

<p>One class is used when, instead of applying a single custom resource (as shown previously) to the cluster, a list of the custom resources is provided (using the <code>items</code> array):</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">.</code><code class="na">cr</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">com.fasterxml.jackson.databind.annotation.JsonDeserialize</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.CustomResourceList</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@JsonDeserialize</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">HelloResourceList</code><code> </code><code class="kd">extends</code><code> </code><code class="n">CustomResourceList</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO23-1" href="#callout_integrating_with_kubernetes_CO23-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO23-1" href="#co_integrating_with_kubernetes_CO23-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p><code>CustomResourceList</code> inherits all fields required to support a list of custom resources</p></dd>
</dl>

<p>The other class is used to make the custom resource editable from the operator implementation:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">.</code><code class="na">cr</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.builder.Function</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.CustomResourceDoneable</code><code class="o">;</code><code>
</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">HelloResourceDoneable</code><code>
</code><code>    </code><code class="kd">extends</code><code> </code><code class="n">CustomResourceDoneable</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">&gt;</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO24-1" href="#callout_integrating_with_kubernetes_CO24-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">HelloResourceDoneable</code><code class="o">(</code><code class="n">HelloResource</code><code> </code><code class="n">resource</code><code class="o">,</code><code> </code><code class="n">Function</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">,</code><code>
</code><code>                                 </code><code class="n">HelloResource</code><code class="o">&gt;</code><code> </code><code class="n">function</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="kd">super</code><code class="o">(</code><code class="n">resource</code><code class="o">,</code><code> </code><code class="n">function</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO24-1" href="#co_integrating_with_kubernetes_CO24-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p><code>CustomResourceDoneable</code> class makes the resource editable</p></dd>
</dl>

<p>The next big thing that is required is a CDI factory bean that provides all the machinery required by the operator.
Create this class at <em>src/main/java</em> inside package <code>org.acme.quickstart</code>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.io.IOException</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.nio.file.Files</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.nio.file.Paths</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.enterprise.inject.Produces</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.inject.Named</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.inject.Singleton</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.acme.quickstart.cr.HelloResource</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.acme.quickstart.cr.HelloResourceDoneable</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.acme.quickstart.cr.HelloResourceList</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.apiextensions.CustomResourceDefinition</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.DefaultKubernetesClient</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.KubernetesClient</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.dsl.MixedOperation</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.dsl.Resource</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.internal.KubernetesDeserializer</code><code class="o">;</code><code>
</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">KubernetesProducer</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>  </code><code class="nd">@Produces</code><code>
</code><code>  </code><code class="nd">@Singleton</code><code>
</code><code>  </code><code class="nd">@Named</code><code class="o">(</code><code class="s">"namespace"</code><code class="o">)</code><code>
</code><code>  </code><code class="n">String</code><code> </code><code class="nf">findMyCurrentNamespace</code><code class="o">(</code><code class="o">)</code><code> </code><code class="kd">throws</code><code> </code><code class="n">IOException</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO25-1" href="#callout_integrating_with_kubernetes_CO25-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">String</code><code class="o">(</code><code class="n">Files</code><code class="o">.</code><code class="na">readAllBytes</code><code class="o">(</code><code>
</code><code>          </code><code class="n">Paths</code><code>
</code><code>            </code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"/var/run/secrets/kubernetes.io/serviceaccount/namespace"</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>  </code><code class="o">}</code><code>
</code><code>
</code><code>  </code><code class="nd">@Produces</code><code>
</code><code>  </code><code class="nd">@Singleton</code><code>
</code><code>  </code><code class="n">KubernetesClient</code><code> </code><code class="nf">makeDefaultClient</code><code class="o">(</code><code class="nd">@Named</code><code class="o">(</code><code class="s">"namespace"</code><code class="o">)</code><code> </code><code class="n">String</code><code> </code><code class="n">namespace</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">DefaultKubernetesClient</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">inNamespace</code><code class="o">(</code><code class="n">namespace</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO25-2" href="#callout_integrating_with_kubernetes_CO25-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>  </code><code class="o">}</code><code>
</code><code>
</code><code>  </code><code class="nd">@Produces</code><code>
</code><code>  </code><code class="nd">@Singleton</code><code>
</code><code>  </code><code class="n">MixedOperation</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">,</code><code>
</code><code>                 </code><code class="n">HelloResourceList</code><code class="o">,</code><code>
</code><code>                 </code><code class="n">HelloResourceDoneable</code><code class="o">,</code><code>
</code><code>                 </code><code class="n">Resource</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">,</code><code> </code><code class="n">HelloResourceDoneable</code><code class="o">&gt;</code><code class="o">&gt;</code><code>
</code><code>  </code><code class="n">makeCustomHelloResourceClient</code><code class="o">(</code><code class="n">KubernetesClient</code><code> </code><code class="n">defaultClient</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO25-3" href="#callout_integrating_with_kubernetes_CO25-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">KubernetesDeserializer</code><code>
</code><code>        </code><code class="o">.</code><code class="na">registerCustomKind</code><code class="o">(</code><code class="s">"acme.org/v1alpha1"</code><code class="o">,</code><code>
</code><code>                            </code><code class="s">"Hello"</code><code class="o">,</code><code> </code><code class="n">HelloResource</code><code class="o">.</code><code class="na">class</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO25-4" href="#callout_integrating_with_kubernetes_CO25-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">CustomResourceDefinition</code><code> </code><code class="n">crd</code><code> </code><code class="o">=</code><code> </code><code class="n">defaultClient</code><code class="o">.</code><code class="na">customResourceDefinitions</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                                      </code><code class="o">.</code><code class="na">list</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                                      </code><code class="o">.</code><code class="na">getItems</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                                      </code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                                      </code><code class="o">.</code><code class="na">findFirst</code><code class="o">(</code><code class="o">)</code><code>
</code><code>      </code><code class="o">.</code><code class="na">orElseThrow</code><code class="o">(</code><code class="nl">RuntimeException:</code><code class="o">:</code><code class="k">new</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO25-5" href="#callout_integrating_with_kubernetes_CO25-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">defaultClient</code><code class="o">.</code><code class="na">customResources</code><code class="o">(</code><code class="n">crd</code><code class="o">,</code><code> </code><code class="n">HelloResource</code><code class="o">.</code><code class="na">class</code><code class="o">,</code><code>
</code><code>        </code><code class="n">HelloResourceList</code><code class="o">.</code><code class="na">class</code><code class="o">,</code><code>
</code><code>        </code><code class="n">HelloResourceDoneable</code><code class="o">.</code><code class="na">class</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO25-6" href="#callout_integrating_with_kubernetes_CO25-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>  </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO25-1" href="#co_integrating_with_kubernetes_CO25-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Gets the namespace where the operator is running</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO25-2" href="#co_integrating_with_kubernetes_CO25-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Configures <code>KubernetesClient</code> with the current namespace; defaults fit for Kubernetes Operator development</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO25-3" href="#co_integrating_with_kubernetes_CO25-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p><code>MixedOperation</code> is used for watching events about the custom resource (e.g., when a new custom resource is applied)</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO25-4" href="#co_integrating_with_kubernetes_CO25-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Registers the <code>apiVersion</code> and <code>Kind</code> to be parsed by <code>org.acme.quickstart.cr.HelloResource</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO25-5" href="#co_integrating_with_kubernetes_CO25-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Gets the definition of the custom resource; because there is only one (i.e., the one we are developing), <code>findFirst</code> can be used</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO25-6" href="#co_integrating_with_kubernetes_CO25-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Registers for the customer resource, the parser, the list parser, and the <code>doneable</code> class</p></dd>
</dl>

<p>The last Java class to implement is the controller.
This controller (or watcher/operator) is responsible for inspecting what’s going on inside the cluster and reacting to the subscribed events—for example, a new pod has been created/destroyed or a custom resource of kind <code>Hello</code> has been applied.</p>

<p>In this implementation, the controller is watching when a new resource of kind <code>Hello</code> is added.
When the custom resource is applied, then the message is retrieved from the model, and the pod definition is created using all the builders provided by the 
<span class="keep-together">Kubernetes</span> Client API.
Finally, the pod is deployed into the Kubernetes cluster.</p>

<p>Create this class at <em>src/main/java</em> inside package <code>org.acme.quickstart</code>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.HashMap</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.Map</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.enterprise.event.Observes</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.inject.Inject</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.acme.quickstart.cr.HelloResource</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.acme.quickstart.cr.HelloResourceDoneable</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.acme.quickstart.cr.HelloResourceList</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.ContainerBuilder</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.HasMetadata</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.ObjectMetaBuilder</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.Pod</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.PodBuilder</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.api.model.PodSpecBuilder</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.KubernetesClient</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.KubernetesClientException</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.Watcher</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.dsl.MixedOperation</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.fabric8.kubernetes.client.dsl.Resource</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.runtime.StartupEvent</code><code class="o">;</code><code>
</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">HelloResourceWatcher</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>  </code><code class="nd">@Inject</code><code>
</code><code>  </code><code class="n">KubernetesClient</code><code> </code><code class="n">defaultClient</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-1" href="#callout_integrating_with_kubernetes_CO26-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code>  </code><code class="nd">@Inject</code><code>
</code><code>  </code><code class="n">MixedOperation</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">,</code><code>
</code><code>    </code><code class="n">HelloResourceList</code><code class="o">,</code><code>
</code><code>    </code><code class="n">HelloResourceDoneable</code><code class="o">,</code><code>
</code><code>    </code><code class="n">Resource</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">,</code><code>
</code><code>    </code><code class="n">HelloResourceDoneable</code><code class="o">&gt;</code><code class="o">&gt;</code><code> </code><code class="n">crClient</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-2" href="#callout_integrating_with_kubernetes_CO26-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code>  </code><code class="kt">void</code><code> </code><code class="nf">onStartup</code><code class="o">(</code><code class="nd">@Observes</code><code> </code><code class="n">StartupEvent</code><code> </code><code class="n">event</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-3" href="#callout_integrating_with_kubernetes_CO26-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">crClient</code><code class="o">.</code><code class="na">watch</code><code class="o">(</code><code class="k">new</code><code> </code><code class="n">Watcher</code><code class="o">&lt;</code><code class="n">HelloResource</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-4" href="#callout_integrating_with_kubernetes_CO26-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>      </code><code class="nd">@Override</code><code>
</code><code>      </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">eventReceived</code><code class="o">(</code><code class="n">Action</code><code> </code><code class="n">action</code><code class="o">,</code><code> </code><code class="n">HelloResource</code><code> </code><code class="n">resource</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received "</code><code> </code><code class="o">+</code><code> </code><code class="n">action</code><code>
</code><code>            </code><code class="o">+</code><code> </code><code class="s">" event for resource "</code><code> </code><code class="o">+</code><code> </code><code class="n">resource</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">action</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="n">Action</code><code class="o">.</code><code class="na">ADDED</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">String</code><code> </code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">resource</code><code class="o">.</code><code class="na">getMetadata</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-5" href="#callout_integrating_with_kubernetes_CO26-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">String</code><code> </code><code class="n">message</code><code> </code><code class="o">=</code><code> </code><code class="n">resource</code><code class="o">.</code><code class="na">getSpec</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getMessage</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code><code> </code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="n">labels</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">HashMap</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-6" href="#callout_integrating_with_kubernetes_CO26-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>          </code><code class="n">labels</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"app"</code><code class="o">,</code><code> </code><code class="n">app</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">ObjectMetaBuilder</code><code> </code><code class="n">objectMetaBuilder</code><code> </code><code class="o">=</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">ObjectMetaBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">withName</code><code class="o">(</code><code class="n">app</code><code> </code><code class="o">+</code><code> </code><code class="s">"-pod"</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withNamespace</code><code class="o">(</code><code class="n">resource</code><code class="o">.</code><code class="na">getMetadata</code><code class="o">(</code><code class="o">)</code><code>
</code><code>                </code><code class="o">.</code><code class="na">getNamespace</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withLabels</code><code class="o">(</code><code class="n">labels</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">ContainerBuilder</code><code> </code><code class="n">containerBuilder</code><code> </code><code class="o">=</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">ContainerBuilder</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">withName</code><code class="o">(</code><code class="s">"whalesay"</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withImage</code><code class="o">(</code><code class="s">"docker/whalesay"</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withCommand</code><code class="o">(</code><code class="s">"cowsay"</code><code class="o">,</code><code> </code><code class="n">message</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-7" href="#callout_integrating_with_kubernetes_CO26-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">PodSpecBuilder</code><code> </code><code class="n">podSpecBuilder</code><code> </code><code class="o">=</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">PodSpecBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withContainers</code><code class="o">(</code><code class="n">containerBuilder</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withRestartPolicy</code><code class="o">(</code><code class="s">"Never"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">PodBuilder</code><code> </code><code class="n">podBuilder</code><code> </code><code class="o">=</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">PodBuilder</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withMetadata</code><code class="o">(</code><code class="n">objectMetaBuilder</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">withSpec</code><code class="o">(</code><code class="n">podSpecBuilder</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>
</code><code>          </code><code class="kd">final</code><code> </code><code class="n">Pod</code><code> </code><code class="n">pod</code><code> </code><code class="o">=</code><code> </code><code class="n">podBuilder</code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-8" href="#callout_integrating_with_kubernetes_CO26-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code>          </code><code class="n">HasMetadata</code><code> </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">defaultClient</code><code>
</code><code>            </code><code class="o">.</code><code class="na">resource</code><code class="o">(</code><code class="n">pod</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">createOrReplace</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-9" href="#callout_integrating_with_kubernetes_CO26-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a><code>
</code><code>
</code><code>          </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">result</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Pod "</code><code> </code><code class="o">+</code><code> </code><code class="n">pod</code><code>
</code><code>                </code><code class="o">+</code><code> </code><code class="s">" couldn't be created"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>          </code><code class="o">}</code><code> </code><code class="k">else</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Pod "</code><code> </code><code class="o">+</code><code> </code><code class="n">pod</code><code> </code><code class="o">+</code><code> </code><code class="s">" created"</code><code class="o">)</code><code class="o">;</code><code>
</code><code>          </code><code class="o">}</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>      </code><code class="o">}</code><code>
</code><code>
</code><code>      </code><code class="nd">@Override</code><code>
</code><code>      </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">onClose</code><code class="o">(</code><code class="n">KubernetesClientException</code><code> </code><code class="n">e</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO26-10" href="#callout_integrating_with_kubernetes_CO26-10"><img src="Images/10.png" alt="10" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">e</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>          </code><code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>          </code><code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="o">-</code><code class="mi">1</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>      </code><code class="o">}</code><code>
</code><code>    </code><code class="o">}</code><code class="o">)</code><code class="o">;</code><code>
</code><code>  </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-1" href="#co_integrating_with_kubernetes_CO26-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Injects KubernetesClient</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-2" href="#co_integrating_with_kubernetes_CO26-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Injects operations specific to the developed custom resource</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-3" href="#co_integrating_with_kubernetes_CO26-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Executes logic when the application is started</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-4" href="#co_integrating_with_kubernetes_CO26-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Watches for any operation that <code>HelloResource</code> is implied</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-5" href="#co_integrating_with_kubernetes_CO26-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Gets the information provided in the custom resource</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-6" href="#co_integrating_with_kubernetes_CO26-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Starts the creation of the pod definition programmatically</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-7" href="#co_integrating_with_kubernetes_CO26-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Sets the message provided by the custom resource</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-8" href="#co_integrating_with_kubernetes_CO26-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Builds the pod</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-9" href="#co_integrating_with_kubernetes_CO26-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt>
<dd><p>Adds the pod to the cluster</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO26-10" href="#co_integrating_with_kubernetes_CO26-10"><img src="Images/10.png" alt="10" width="12" height="12"/></a></dt>
<dd><p>If there is any critical error when closing, then stop the container</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128505485384">
<h2>Discussion</h2>

<p>On the Java side, this is all you need to do; however, there are still some remaining parts, such as packaging and containerizing the operator, or defining the custom operator inside the cluster.</p>

<p>The first thing to take into consideration when developing a Kubernetes Operator is that the communication with the Kubernetes API server is done through HTTPS, and this means that crypto libraries must be provided in the Docker image if they are not provided by default.</p>

<p>At the time of writing, the <em>Dockerfile.jvm</em> file provided by Quarkus does not contain the crypto libraries required to communicate to the Kubernetes server.
To fix this, just open <em>src/main/docker/Dockerfile.jvm</em> and add the <code>nss</code> (Network Security Services) package:</p>

<pre data-type="programlisting" data-code-language="docker"><code class="k">FROM</code><code class="s"> fabric8/java-alpine-openjdk8-jre</code>

<code class="k">RUN</code> apk add --no-cache nss</pre>

<p>Then containerize the operator by running Maven and Docker:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package</code>

<code class="go">docker build -f src/main/docker/Dockerfile.jvm \</code>
<code class="go">  -t lordofthejars/quarkus-operator-example:1.0.0 .</code></pre>

<p>Then register the custom resource definition into the Kubernetes cluster so that it is aware of the new kind, the scope of the custom resource, or the group name, among other things.</p>

<p>Create a new file at <em>src/main/kubernetes</em> with name <em>custom-resource-definition.yaml</em> that defines all the information required by the cluster to register a new resource:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apiextensions.k8s.io/v1beta1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">CustomResourceDefinition</code><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">hellos.acme.org</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-1" href="#callout_integrating_with_kubernetes_CO27-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nt">spec</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">group</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">acme.org</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-2" href="#callout_integrating_with_kubernetes_CO27-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>  </code><code class="nt">names</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Hello</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-3" href="#callout_integrating_with_kubernetes_CO27-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="nt">listKind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">HelloList</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-4" href="#callout_integrating_with_kubernetes_CO27-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>    </code><code class="nt">plural</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">hellos</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-5" href="#callout_integrating_with_kubernetes_CO27-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>    </code><code class="nt">singular</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">hello</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-6" href="#callout_integrating_with_kubernetes_CO27-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>  </code><code class="nt">scope</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Namespaced</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-7" href="#callout_integrating_with_kubernetes_CO27-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code>  </code><code class="nt">subresources</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">status</code><code class="p">:</code><code> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code>
</code><code>  </code><code class="nt">version</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1alpha1</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO27-8" href="#callout_integrating_with_kubernetes_CO27-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-1" href="#co_integrating_with_kubernetes_CO27-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p><code>plural</code> plus <code>group</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-2" href="#co_integrating_with_kubernetes_CO27-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the group of the custom resource (used in the <code>apiVersion</code> field of the custom resource)</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-3" href="#co_integrating_with_kubernetes_CO27-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Name of the <code>kind</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-4" href="#co_integrating_with_kubernetes_CO27-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Name when the kind is a list of this custom resource</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-5" href="#co_integrating_with_kubernetes_CO27-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>The plural name</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-6" href="#co_integrating_with_kubernetes_CO27-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>The singular name</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-7" href="#co_integrating_with_kubernetes_CO27-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Scope of the resource</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO27-8" href="#co_integrating_with_kubernetes_CO27-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>The version of the resource (used in the <code>apiVersion</code> field of the custom resource)</p></dd>
</dl>

<p>And the last thing to create is a deployment file that deploys the operator.
Create a new file named <em>deploy.yaml</em> at <em>src/main/kubernetes</em>:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ClusterRole</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO28-1" href="#callout_integrating_with_kubernetes_CO28-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code class="nt">rules</code><code class="p">:</code><code>
</code><code class="p-Indicator">-</code><code> </code><code class="nt">apiGroups</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="s">'</code><code class="s">'</code><code>
</code><code>  </code><code class="nt">resources</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">pods</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO28-2" href="#callout_integrating_with_kubernetes_CO28-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>  </code><code class="nt">verbs</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">get</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">list</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">watch</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">create</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">update</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">delete</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">patch</code><code>
</code><code class="p-Indicator">-</code><code> </code><code class="nt">apiGroups</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">apiextensions.k8s.io</code><code>
</code><code>  </code><code class="nt">resources</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">customresourcedefinitions</code><code>
</code><code>  </code><code class="nt">verbs</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">list</code><code>
</code><code class="p-Indicator">-</code><code> </code><code class="nt">apiGroups</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">acme.org</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO28-3" href="#callout_integrating_with_kubernetes_CO28-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>  </code><code class="nt">resources</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">hellos</code><code>
</code><code>  </code><code class="nt">verbs</code><code class="p">:</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">list</code><code>
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">watch</code><code>
</code><code class="nn">---</code><code>
</code><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ServiceAccount</code><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code class="nn">---</code><code>
</code><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ClusterRoleBinding</code><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code class="nt">subjects</code><code class="p">:</code><code>
</code><code class="p-Indicator">-</code><code> </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ServiceAccount</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code>  </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">default</code><code>
</code><code class="nt">roleRef</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ClusterRole</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code>  </code><code class="nt">apiGroup</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io</code><code>
</code><code class="nn">---</code><code>
</code><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apps/v1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Deployment</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO28-4" href="#callout_integrating_with_kubernetes_CO28-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code class="nt">spec</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">selector</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">matchLabels</code><code class="p">:</code><code>
</code><code>      </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code>  </code><code class="nt">replicas</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">1</code><code>
</code><code>  </code><code class="nt">template</code><code class="p">:</code><code>
</code><code>    </code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>      </code><code class="nt">labels</code><code class="p">:</code><code>
</code><code>        </code><code class="nt">app</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code>    </code><code class="nt">spec</code><code class="p">:</code><code>
</code><code>      </code><code class="nt">serviceAccountName</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO28-5" href="#callout_integrating_with_kubernetes_CO28-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>      </code><code class="nt">containers</code><code class="p">:</code><code>
</code><code>      </code><code class="p-Indicator">-</code><code> </code><code class="nt">image</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">lordofthejars/quarkus-operator-example:1.0.0</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO28-6" href="#callout_integrating_with_kubernetes_CO28-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>        </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">quarkus-operator-example</code><code>
</code><code>        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">IfNotPresent</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO28-1" href="#co_integrating_with_kubernetes_CO28-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Defines a cluster role for the role-based access control (RBAC) for 
<span class="keep-together">Kubernetes</span> resources</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO28-2" href="#co_integrating_with_kubernetes_CO28-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Adds rights to get, list, watch, create, update, delete, and patch pods</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO28-3" href="#co_integrating_with_kubernetes_CO28-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>For the custom resource (<code>hellos.acme.org</code>), the required operations are <code>list</code> and <code>watch</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO28-4" href="#co_integrating_with_kubernetes_CO28-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>An operator is deployed with a <code>Deployment</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO28-5" href="#co_integrating_with_kubernetes_CO28-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Sets the service account linked to the cluster role defined in the file</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO28-6" href="#co_integrating_with_kubernetes_CO28-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Sets the container image containing the operator</p></dd>
</dl>

<p>The last step before having the operator up and running is to apply all these created resources:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl apply -f src/main/kubernetes/custom-resource-definition.yaml</code>
<code class="go">kubectl apply -f src/main/kubernetes/deploy.yaml</code>

<code class="go">kubectl get pods</code>

<code class="go">NAME                                       READY   STATUS    RESTARTS   AGE</code>
<code class="go">quarkus-operator-example-fb77dc468-8v9xk   1/1     Running   0          5s</code></pre>

<p>The operator is now installed and running. To test the operator, just create a custom resource of kind <code>Hello</code> with the message to show:</p>

<pre data-type="programlisting" data-code-language="yaml"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">acme.org/v1alpha1</code><code>
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Hello</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO29-1" href="#callout_integrating_with_kubernetes_CO29-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nt">metadata</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">example-hello</code><code>
</code><code class="nt">spec</code><code class="p">:</code><code>
</code><code>  </code><code class="nt">message</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Hello</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Alex</code><code> </code><a class="co" id="co_integrating_with_kubernetes_CO29-2" href="#callout_integrating_with_kubernetes_CO29-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO29-1" href="#co_integrating_with_kubernetes_CO29-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Uses custom <code>kind</code> schema</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO29-2" href="#co_integrating_with_kubernetes_CO29-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the message to print</p></dd>
</dl>

<p>And apply it as follows:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl apply -f src/main/kubernetes/custom-resource.yaml</code>

<code class="go">kubectl get pods</code>

<code class="go">NAME                                       READY   STATUS      RESTARTS   AGE</code>
<code class="go">example-hello-pod                          0/1     Completed   0          2m57s</code>
<code class="go">quarkus-operator-example-fb77dc468-8v9xk   1/1     Running     0          3m24s</code></pre>

<p>When it’s completed, check the pod logs to validate that the message has been printed on the console:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl logs example-hello-pod</code>

<code class="go"> ____________</code>
<code class="go">&lt; Hello Alex &gt;</code>
<code class="go"> ------------</code>
<code class="go">    \</code>
<code class="go">     \</code>
<code class="go">      \</code>
<code class="go">                    ##        .</code>
<code class="go">              ## ## ##       ==</code>
<code class="go">           ## ## ## ##      ===</code>
<code class="go">       /""""""""""""""""___/ ===</code>
<code class="go">  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~</code>
<code class="go">       \______ o          __/</code>
<code class="go">        \    \        __/</code>
<code class="go">          \____\______/</code></pre>

<p>Although an operator and a custom resource are usually related, an operator without a custom resource definition is still possible—for example, to create a watcher class to intercept any event that affects a pod and apply some logic.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128505657176">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="kub_kub" id="idm45128504798824"/><a data-type="indexterm" data-primary="" data-startref="ko_ab" id="idm45128504797848"/>To learn more about operators, check out the following websites:</p>

<ul>
<li>
<p><a href="https://oreil.ly/NV2dN">CoreOS: Operators</a></p>
</li>
<li>
<p><a href="https://oreil.ly/6Z77K">Kubernetes: Operator pattern</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="10.12 Deploying and Managing Serverless Workloads with Knative"><div class="sect1" id="idm45128504682360">
<h1>10.12 Deploying and Managing Serverless Workloads with Knative</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128504681144">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="deploying" data-secondary="serverless workloads with Knative" id="dep_kn"/><a data-type="indexterm" data-primary="Knative" id="kn_ab"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="deploying serverless workloads with Knative" id="kub_dep"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="managing serverless workloads with Knative" id="kub_man"/><a data-type="indexterm" data-primary="serverless worloads, deploying/managing with Knative" id="ser_kn"/>You want to deploy and manage serverless workloads.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128504674072">
<h2>Solution</h2>

<p>Use Knative, the Kubernetes-based platform to deploy and manage modern serverless workloads.</p>

<p>The <code>quarkus-kubernetes</code> extension provides support for generating Knative resources automatically with sane defaults and optional user-supplied configuration.</p>

<p>To enable the generation of Kubernetes resources, you need to register the <code>quarkus-kubernetes</code> extension:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension \</code>
<code class="go">  -Dextensions="quarkus-kubernetes, quarkus-container-image-docker"</code></pre>

<p>For this example, the <code>quarkus-container-image-docker</code> extension is used to build the container image using <code>docker</code> binary, so the image is built directly inside the 
<span class="keep-together"><code>minikube</code></span> cluster and registered inside the internal registry, so no external registry is required.</p>

<p>You need to run <code>eval $(minikube docker-env)</code> to configure <code>docker</code> to use the 
<span class="keep-together">minikube</span> docker host.</p>

<p>Then you need to set the <code>quarkus.kubernetes.deployment-target</code> property to 
<span class="keep-together"><code>knative</code></span> and set it to build a Docker container during package phase, among other configuration properties regarding container image creation:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.kubernetes.deployment-target</code><code class="o">=</code><code class="s">knative </code><a class="co" id="co_integrating_with_kubernetes_CO30-1" href="#callout_integrating_with_kubernetes_CO30-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.build</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_integrating_with_kubernetes_CO30-2" href="#callout_integrating_with_kubernetes_CO30-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.group</code><code class="o">=</code><code class="s">lordofthejars</code><code>
</code><code class="na">quarkus.container-image.registry</code><code class="o">=</code><code class="s">dev.local </code><a class="co" id="co_integrating_with_kubernetes_CO30-3" href="#callout_integrating_with_kubernetes_CO30-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_integrating_with_kubernetes_CO30-1" href="#co_integrating_with_kubernetes_CO30-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets target deployment to <code>knative</code></p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO30-2" href="#co_integrating_with_kubernetes_CO30-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Builds the container image with <code>lordofthejars</code> group</p></dd>
<dt><a class="co" id="callout_integrating_with_kubernetes_CO30-3" href="#co_integrating_with_kubernetes_CO30-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets to <code>dev.local</code> when deploying local container images</p></dd>
</dl>

<p>The Knative controller resolves image tags to digests in order to guarantee the immutability of revisions.
This works well when using a normal registry; however, it can cause problems when used with minikube and local images.</p>

<p>By default, the Knative controller skips resolving digests with images prefixed with <code>dev.local</code> or <code>ko.local</code>.
If you are running this example in minikube, you must set the registry property to any of these two options to make Knative find the images to deploy.</p>

<p>To generate the Kubernetes resources, execute in a new terminal <code>./mvnw package</code>.
Then, among the usual files generated by the build tool in the <em>target</em> directory, two new files are created inside the <em>target/kubernetes</em> directory named <em>knative.json</em> and <em>knative.yaml</em> containing a Knative service definition:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code>
  <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"v1"</code><code class="p">,</code>
  <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"ServiceAccount"</code><code class="p">,</code>
  <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
    <code class="nt">"annotations"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"app.quarkus.io/vcs-url"</code> <code class="p">:</code>
       <code class="s2">"https://github.com/lordofthejars/quarkus-cookbook.git"</code><code class="p">,</code>
      <code class="nt">"app.quarkus.io/build-timestamp"</code> <code class="p">:</code> <code class="s2">"2020-03-10 - 22:55:08 +0000"</code><code class="p">,</code>
      <code class="nt">"app.quarkus.io/commit-id"</code> <code class="p">:</code> <code class="s2">"17b19a409c41cc933770b20009f635a65f69440e"</code>
    <code class="p">},</code>
    <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"app.kubernetes.io/name"</code> <code class="p">:</code> <code class="s2">"greeting-knative"</code><code class="p">,</code>
      <code class="nt">"app.kubernetes.io/version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code>
    <code class="p">},</code>
    <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"greeting-knative"</code>
  <code class="p">}</code>
<code class="p">}{</code>
  <code class="nt">"apiVersion"</code> <code class="p">:</code> <code class="s2">"serving.knative.dev/v1alpha1"</code><code class="p">,</code>
  <code class="nt">"kind"</code> <code class="p">:</code> <code class="s2">"Service"</code><code class="p">,</code>
  <code class="nt">"metadata"</code> <code class="p">:</code> <code class="p">{</code>
    <code class="nt">"annotations"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"app.quarkus.io/vcs-url"</code> <code class="p">:</code>
        <code class="s2">"https://github.com/lordofthejars/quarkus-cookbook.git"</code><code class="p">,</code>
      <code class="nt">"app.quarkus.io/build-timestamp"</code> <code class="p">:</code> <code class="s2">"2020-03-10 - 22:55:08 +0000"</code><code class="p">,</code>
      <code class="nt">"app.quarkus.io/commit-id"</code> <code class="p">:</code> <code class="s2">"17b19a409c41cc933770b20009f635a65f69440e"</code>
    <code class="p">},</code>
    <code class="nt">"labels"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"app.kubernetes.io/name"</code> <code class="p">:</code> <code class="s2">"greeting-knative"</code><code class="p">,</code>
      <code class="nt">"app.kubernetes.io/version"</code> <code class="p">:</code> <code class="s2">"1.0-SNAPSHOT"</code>
    <code class="p">},</code>
    <code class="nt">"name"</code> <code class="p">:</code> <code class="s2">"greeting-knative"</code>
  <code class="p">},</code>
  <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
    <code class="nt">"runLatest"</code> <code class="p">:</code> <code class="p">{</code>
      <code class="nt">"configuration"</code> <code class="p">:</code> <code class="p">{</code>
        <code class="nt">"revisionTemplate"</code> <code class="p">:</code> <code class="p">{</code>
          <code class="nt">"spec"</code> <code class="p">:</code> <code class="p">{</code>
            <code class="nt">"container"</code> <code class="p">:</code> <code class="p">{</code>
              <code class="nt">"image"</code> <code class="p">:</code><code class="s2">"dev.local/lordofthejars/greeting-knative:1.0-SNAPSHOT"</code><code class="p">,</code>
              <code class="nt">"imagePullPolicy"</code> <code class="p">:</code> <code class="s2">"IfNotPresent"</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Then deploy the generated Knative service:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl apply -f target/kubernetes/knative.json</code>

<code class="go">serviceaccount/greeting-knative created</code>
<code class="go">service.serving.knative.dev/greeting-knative created</code>

<code class="go">kubectl get ksvc</code>
<code class="go">NAME               URL                                                \</code>
<code class="go">greeting-knative   http://greeting-knative.default.127.0.0.1.nip.io   \</code>

<code class="go">LATESTCREATED            LATESTREADY              READY   REASON</code>
<code class="go">greeting-knative-j8n76   greeting-knative-j8n76   True</code></pre>

<p>It can take a few seconds to move the <code>ready</code> state from <code>Unknown</code> to <code>True</code>.
If there is a failure, which means that <code>ready</code> state remains in <code>false</code>, you can check the reason and the sequence of events by running the following:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl get events --sort-by=.metadata.creationTimestamp</code></pre>

<p>To test that the service has been deployed correctly, open a new terminal window and do a port forward between the local machine and Knative gateway:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl port-forward --namespace kourier-system $(kubectl get pod \</code>
<code class="go">  -n kourier-system -l "app=3scale-kourier-gateway" \</code>
<code class="go">  --output=jsonpath="{.items[0].metadata.name}") \</code>
<code class="go">  8080:8080 19000:19000 8443:8443</code>

<code class="go">Forwarding from 127.0.0.1:8080 -&gt; 8080</code>
<code class="go">Forwarding from [::1]:8080 -&gt; 8080</code>
<code class="go">Forwarding from 127.0.0.1:19000 -&gt; 19000</code>
<code class="go">Forwarding from [::1]:19000 -&gt; 19000</code>
<code class="go">Forwarding from 127.0.0.1:8443 -&gt; 8443</code>
<code class="go">Forwarding from [::1]:8443 -&gt; 8443</code>
<code class="go">Handling connection for 8080</code>
<code class="go">Handling connection for 8080</code></pre>

<p>Notice that this is required only because the service is deployed in minikube.
Depending on the Kubernetes platform on which you are deploying the service, you might need to do different things.</p>

<p>Finally, you can send a request to the service:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">curl -v -H "Host: greeting-knative.default.127.0.0.1.nip.io" \</code>
<code class="go">  http://localhost:8080/greeting</code>

<code class="go">hello</code></pre>

<p>To undeploy the example, you need to run the following:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl delete -f target/kubernetes/knative.json</code>

<code class="go">serviceaccount "greeting-knative" deleted</code>
<code class="go">service.serving.knative.dev "greeting-knative" deleted</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128504673160">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="container-image extension" id="idm45128504370184"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="extension" id="idm45128504369320"/>You can combine the <code>container-image</code> and <code>kubernetes</code> extensions to build the container image and push it to Kubernetes automatically, as shown in <a data-type="xref" href="#build-deploy-container-image-automatically">Recipe 10.6</a>, so no manual steps are required.<a data-type="indexterm" data-primary="" data-startref="dep_kn" id="idm45128504327224"/><a data-type="indexterm" data-primary="" data-startref="kn_ab" id="idm45128504326280"/><a data-type="indexterm" data-primary="" data-startref="kub_dep" id="idm45128504422312"/><a data-type="indexterm" data-primary="" data-startref="kub_man" id="idm45128504421368"/><a data-type="indexterm" data-primary="" data-startref="ser_kn" id="idm45128504420424"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128504419352">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="kub_ch" id="idm45128504261288"/>To learn more, visit the following web pages:</p>

<ul>
<li>
<p><a href="https://oreil.ly/RBv52">Knative Serving</a></p>
</li>
<li>
<p><a href="https://oreil.ly/3bSDL">GitHub: Kourier</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div>



  </body></html>