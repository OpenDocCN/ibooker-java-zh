<html><head></head><body><section data-pdf-bookmark="Chapter 6. Java to Kotlin Collections" data-type="chapter" epub:type="chapter"><div class="chapter" id="java-to-kotlin-collections">&#13;
<h1><span class="label">Chapter 6. </span>Java to Kotlin Collections</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>On the face of it, Java and Kotlin have very similar collections libraries; they certainly interoperate suspiciously seamlessly.&#13;
What are the differences, what motivates them, and where do we have to take care as we move from Java to Kotlin collections?</p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Java Collections" data-type="sect1"><div class="sect1" id="java-collections">&#13;
<h1>Java Collections</h1>&#13;
&#13;
<p>In<a data-primary="collections" data-secondary="Java collections" data-type="indexterm" id="Cjava06"/><a data-primary="Java" data-secondary="Java collections" data-type="indexterm" id="JPScollect06"/> <a data-type="xref" href="ch05.html#beans-to-values">Chapter 5</a> we saw how Java grew up in the days when we saw objects as fundamentally stateful and mutable.&#13;
This was particularly true for collections—I mean, what is the point of a list if you can’t add to it?&#13;
We build collections by creating an empty one and adding to it.&#13;
Need to remove an item from a shopping cart?&#13;
Mutate the list.&#13;
Shuffle a pack of cards?&#13;
Obviously that changes the order of the deck.&#13;
We wouldn’t create a new paper to-do list every time we need milk or take the cat to the vet. Mutable collections mirror our real world experience.</p>&#13;
&#13;
<p>On its release, the quality of its built-in collections was a good reason to adopt Java.&#13;
In those days many languages had no resizable collections in their standard library.&#13;
Object technology allowed us to define and use mutable collections safely.&#13;
It was only natural to use this superpower now that it had been given to us, so we went ahead and used <code>Vector</code> and <code>HashTable</code> as Sun intended.&#13;
Which is to say, we created them and then mutated them.&#13;
There was no choice, because all the constructors created empty &#13;
<span class="keep-together">collections</span>.</p>&#13;
&#13;
<p>Java 2 (which was version 1.2 until Java had to compete with C# version numbers) introduced a revised collections library.&#13;
This tidied up the ad hoc <code>Vector</code>, <code>Stack</code>, and <code>Hashtable</code> classes and created a common <code>Collection</code> interface with more useful implementations, including <code>ArrayList</code> and <code>HashSet</code>.&#13;
It was now possible to create a collection as a copy of another collection.&#13;
The static <code>Collections</code> class provided some helpful utility operations, like <code>sort</code> and <code>reverse</code>.&#13;
Java 5 introduced generics, and &#13;
<span class="keep-together">cleverly</span> retrofitted them to the existing collections, so that now we could declare types like <code>List&lt;Journey&gt;</code>.</p>&#13;
&#13;
<p>The Java collections remained mutable, though—very mutable.&#13;
Not only are there operations to add and remove items, but also operations like sort are defined <em>only</em> as mutations; there is no standard library function to return a sorted copy of a <code>List</code>.</p>&#13;
&#13;
<p>As we will keep on saying, mutation is the source of many of our problems with complexity, because it allows state in one place to get out of sync with respect to state in another.&#13;
For example, in Travelator we can represent a route as a <code>List</code> of <code>Journey</code>.&#13;
There is also the concept of a suffer-score: the lower the suffer-score, the more pleasant a route is likely to be.&#13;
Here is how we calculate a suffer-score for a route:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="kt">int</code> <code class="nf">sufferScoreFor</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">Location</code> <code class="n">start</code> <code class="o">=</code> <code class="n">getDepartsFrom</code><code class="o">(</code><code class="n">route</code><code class="o">);</code>&#13;
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">longestJourneys</code> <code class="o">=</code> <code class="n">longestJourneysIn</code><code class="o">(</code><code class="n">route</code><code class="o">,</code> <code class="mi">3</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="nf">sufferScore</code><code class="o">(</code><code class="n">longestJourneys</code><code class="o">,</code> <code class="n">start</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.1&amp;show=file">Example 6.1 [collections.0:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That <code>start</code> local variable doesn’t add much, so we decide to inline it:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="kt">int</code> <code class="nf">sufferScoreFor</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">longestJourneys</code> <code class="o">=</code> <code class="n">longestJourneysIn</code><code class="o">(</code><code class="n">route</code><code class="o">,</code> <code class="mi">3</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="nf">sufferScore</code><code class="o">(</code><code class="n">longestJourneys</code><code class="o">,</code> <code class="n">getDepartsFrom</code><code class="o">(</code><code class="n">route</code><code class="o">));</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.2&amp;show=file">Example 6.2 [collections.1:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Our tests pass, we push to production, but we get bug reports suggesting that all is not well.&#13;
Drilling down we find:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="n">Location</code> <code class="nf">getDepartsFrom</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">route</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">getDepartsFrom</code><code class="o">();</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.3&amp;show=file">Example 6.3 [collections.0:src/main/java/travelator/Routes.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="nf">longestJourneysIn</code><code class="o">(</code><code>&#13;
</code><code>    </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">journeys</code><code class="o">,</code><code>&#13;
</code><code>    </code><code class="kt">int</code><code> </code><code class="n">limit</code><code>&#13;
</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="n">journeys</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">comparing</code><code class="o">(</code><code class="nl">Journey:</code><code class="o">:</code><code class="n">getDuration</code><code class="o">)</code><code class="o">.</code><code class="na">reversed</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" href="#callout_introduction_CO5-1" id="co_introduction_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">var</code><code> </code><code class="n">actualLimit</code><code> </code><code class="o">=</code><code> </code><code class="n">Math</code><code class="o">.</code><code class="na">min</code><code class="o">(</code><code class="n">journeys</code><code class="o">.</code><code class="na">size</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code> </code><code class="n">limit</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">journeys</code><code class="o">.</code><code class="na">subList</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code><code> </code><code class="n">actualLimit</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.4&amp;show=file">Example 6.4 [collections.0:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO5-1" id="callout_introduction_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>journeys</code> parameter mutated by <code>sort</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>Ah, now<a data-primary="aliasing errors" data-type="indexterm" id="idm46393404836024"/> we can see that finding the longest journeys has changed the apparent departure <code>Location</code>.&#13;
A developer called methods on a parameter (<code>journeys</code>) to solve a problem, and that turned out to break code somewhere else in the system!&#13;
You only have to spend several hundred hours of your life debugging the problems caused by <a href="https://oreil.ly/PeqKs">aliasing errors</a> like this to come to the conclusion that immutable data would be a better default.&#13;
For the JDK developers, this point evidently came after the introduction of Java 2, so we have forever been stuck with mutable collections interfaces.</p>&#13;
&#13;
<p>To be fair, although Java’s collections are mutable in theory, they have, over the years, become less and less so in practice.&#13;
Even at the start, it was possible to wrap a collection with, for example, <code>Collections.unmodifiableList</code>.&#13;
The result is still a <code>List</code>; it still has all the mutation methods, but they all throw <code>UnsupportedOperationException</code>.&#13;
We could have found out about the problem of <code>shortestJourneyIn</code> mutating our list by wrapping the result from <code>loadJourneys</code> in an <code>UnmodifiableList</code>.&#13;
The tests of any code that combined the two would quickly fail, albeit only when run as opposed to when compiled.&#13;
It’s a shame that we cannot depend on the type system to ensure correctness, but we can’t go back in time, so this is a pragmatic patch.</p>&#13;
&#13;
<p>Wrapping<a data-primary="List.copyOf(collection)" data-type="indexterm" id="idm46393404797768"/><a data-primary="UnmodifiableList" data-type="indexterm" id="idm46393404797160"/> a list in an <code>UnmodifiableList</code> solves the problems of depended-on code mutating our collection.&#13;
If it’s possible for the <em>original list</em> to be modified, we can still have issues though, because the wrapper reads through to its underlying collection.&#13;
So an <code>UnmodifiableList</code> doesn’t guarantee that it never changes, just that it cannot be modified through the wrapper.&#13;
In these cases we have to take a defensive copy of the original list if we are to be isolated from changes.&#13;
<code>List.copyOf(collection)</code> was added in Java 10 to copy an underlying collection as an <code>AbstractImmutableList</code>, which is neither modifiable nor subject to changes in the original collection.</p>&#13;
&#13;
<p>All this second-guessing of whether the source or destination of a collection is likely to modify it, and taking appropriate action, is tedious and error-prone.&#13;
The problem applies to any mutable data, but changing collections is particularly pernicious, because we often derive values (such as <code>departsFrom</code>) that can get out of date if we change the collection that we extracted them from.&#13;
Rather than taking defensive copies at every function boundary, many teams, your authors’ included, adopted a simpler and more efficient strategy.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="dont-mutate-shared-collections">&#13;
<h5>Don’t Mutate Shared Collections</h5>&#13;
<p>Treat<a data-primary="mutability" data-secondary="shared collections" data-type="indexterm" id="idm46393404791320"/><a data-primary="collections" data-secondary="shared collections" data-type="indexterm" id="idm46393404790472"/> any collection shared between separate pieces of code as immutable.&#13;
Sharing includes references received as a parameter, returned as a result, or assigned to a shared variable.&#13;
This applies even if the collection started life as mutable, and despite the mutation operations present in the Java interfaces.</p>&#13;
&#13;
<p>When code that we don’t own does not respect this convention, we can use copies to insulate our code from mutation.</p>&#13;
</div></aside>&#13;
&#13;
<p>This<a data-primary="Collections.unmodifiableList(…)" data-type="indexterm" id="idm46393404788152"/> strategy doesn’t stop us from creating mutable collections and populating them within a function, but code should only change a collection that it has just created.&#13;
As soon as we return a reference as a result, we should treat it as immutable—<em>create, don’t mutate</em>.&#13;
We might occasionally enforce this immutability by wrapping with &#13;
<span class="keep-together"><code>Collections.unmodifiableList(…)</code></span> etc., but in an aligned development team this is unnecessary, because no one would treat a shared collection as mutable.</p>&#13;
&#13;
<p>There will of course be exceptions to the rule, places where, usually for reasons of efficiency, we want to share a collection as a mutable collection.&#13;
In these cases we can get dispensation by naming (<code>accumulator</code> is a good start) and by limiting the scope of the sharing as much as possible.&#13;
Within a function is ideal, between private methods in a class acceptable, across module boundaries very rarely so.&#13;
<a data-type="xref" href="ch14.html#accumulating-objects-to-transformations">Chapter 14</a> discusses ways to avoid (visibly) mutable collections in these situations.</p>&#13;
&#13;
<p>Project teams that adopt this convention can produce simple and reliable software in spite of collections’ mutability.&#13;
On the whole, the benefits of treating collections as immutable outweigh the problems of a type system that is lying to you, because values are just so valuable.&#13;
The JVM’s libraries may hark back to the days when mutability was the norm, but this is a case where the grain of Java is shifting to the immutable, and it’s better to be ahead of this change than behind it.<a data-primary="" data-startref="Cjava06" data-type="indexterm" id="idm46393404783032"/><a data-primary="" data-startref="JPScollect06" data-type="indexterm" id="idm46393404782184"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kotlin Collections" data-type="sect1"><div class="sect1" id="idm46393405204632">&#13;
<h1>Kotlin Collections</h1>&#13;
&#13;
<p>In<a data-primary="collections" data-secondary="Kotlin collections" data-type="indexterm" id="Ckotling06"/><a data-primary="Kotlin" data-secondary="Kotlin collections" data-type="indexterm" id="Kcollect06"/> contrast to Java, Kotlin and its standard library were designed in an age when mutability had fallen out of fashion.&#13;
However, smooth interoperation with Java was a key goal, and Java has mutable collections.&#13;
Scala had tried introducing its own sophisticated persistent (immutable but data-sharing) collections, but this forced developers to copy information between collections on the interop boundary, which was both inefficient and annoying.&#13;
How could Kotlin square the circle and have immutable collections interoperate seamlessly with Java?</p>&#13;
&#13;
<p>The Kotlin developers removed the mutation methods from the Jave collections interfaces and published them in the <code>kotlin.collections</code> package as <code>Collection&lt;E&gt;</code>, <code>List&lt;E&gt;</code>, and so on.&#13;
These were then extended by <code>MutableCollection&lt;E&gt;</code>, <code>Mutable​L⁠ist&lt;E&gt;</code>, etc., which add back in the Java mutation methods.&#13;
So<a data-primary="MutableList" data-type="indexterm" id="idm46393404773928"/><a data-primary="MutableCollection" data-type="indexterm" id="idm46393404773320"/> in Kotlin we have &#13;
<span class="keep-together"><code>MutableList</code></span>, which is a subtype of <code>List</code>, which is a subtype of <code>Collection</code>.&#13;
<code>MutableList</code> also implements <code>MutableCollection</code>.</p>&#13;
&#13;
<p>On the face of it, this is a simple scheme.&#13;
Mutable collections have the same operations as collections that are not mutable, plus the mutation methods.&#13;
It is safe to pass a <code>MutableList</code> as an argument to code that expects a <code>List</code>, because all the <code>List</code> methods will be present and can be invoked.&#13;
In terms of the <a href="https://oreil.ly/8A8KO">Liskov Substitution Principle</a>, we can substitute a <code>MutableList</code> for a <code>List</code> without affecting our program correctness.</p>&#13;
&#13;
<p>A little compiler magic allows Kotlin code to accept a <code>java.util.List</code> as a <code>kotlin.​col⁠lections.List</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">aList</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">SomeJavaCode</code><code class="p">.</code><code class="n">mutableListOfStrings</code><code class="p">(</code><code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
<code class="n">aList</code><code class="p">.</code><code class="n">removeAt</code><code class="p">(</code><code class="m">1</code><code class="p">)</code> <code class="c1">// doesn't compile</code></pre>&#13;
&#13;
<p>That magic also allows Kotlin to accept the Java <code>List</code> as a <code>kotlin.collections.​Muta⁠bleList</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">aMutableList</code><code class="p">:</code> <code class="n">MutableList</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">SomeJavaCode</code><code class="p">.</code><code class="n">mutableListOfStrings</code><code class="p">(</code>&#13;
    <code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
<code class="n">aMutableList</code><code class="p">.</code><code class="n">removeAt</code><code class="p">(</code><code class="m">1</code><code class="p">)</code>&#13;
<code class="n">assertEquals</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code><code class="s">"0"</code><code class="p">),</code> <code class="n">aMutableList</code><code class="p">)</code></pre>&#13;
&#13;
<p>In fact, because the Java <code>List</code> is actually mutable here, we could (but almost always shouldn’t) downcast to Kotlin’s <code>MutableList</code> and mutate:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">aList</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">SomeJavaCode</code><code class="p">.</code><code class="n">mutableListOfStrings</code><code class="p">(</code><code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
<code class="k">val</code> <code class="py">aMutableList</code><code class="p">:</code> <code class="n">MutableList</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">aList</code> <code class="k">as</code> <code class="n">MutableList</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="n">aMutableList</code><code class="p">.</code><code class="n">removeAt</code><code class="p">(</code><code class="m">1</code><code class="p">)</code>&#13;
<code class="n">assertEquals</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code><code class="s">"0"</code><code class="p">),</code> <code class="n">aMutableList</code><code class="p">)</code></pre>&#13;
&#13;
<p>In the other direction, the compiler will allow both a <code>kotlin.collections.MutableList</code> and a <code>kotlin.collections.List</code> where a <code>java.util.List</code> is needed:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">aMutableList</code><code class="p">:</code> <code class="n">MutableList</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">mutableListOf</code><code class="p">(</code><code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
<code class="n">SomeJavaCode</code><code class="p">.</code><code class="n">needsAList</code><code class="p">(</code><code class="n">aMutableList</code><code class="p">)</code></pre>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">aList</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
<code class="n">SomeJavaCode</code><code class="p">.</code><code class="n">needsAList</code><code class="p">(</code><code class="n">aList</code><code class="p">)</code></pre>&#13;
&#13;
<p>At face value, so far everything has been very plausible.&#13;
Unfortunately, when it comes to mutability, there is more to substitution than Barbara Liskov’s principle.&#13;
As we saw in <a data-type="xref" href="#java-collections">“Java Collections”</a>, just because we can’t see mutators on our reference of type <code>kotlin.collections.List</code>, it doesn’t mean that the contents cannot change.&#13;
The actual type could be a <code>java.util.List</code>, which <em>is</em> mutable.&#13;
In some ways it’s worse in Kotlin, because we can convert a <code>MutableList</code> to a <code>List</code> in passing:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">aMutableList</code> <code class="p">=</code> <code class="n">mutableListOf</code><code class="p">(</code><code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
<code class="k">val</code> <code class="py">aList</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">aMutableList</code></pre>&#13;
&#13;
<p>Now let’s say that we accept a <code>List&lt;String&gt;</code> somewhere, and take its immutabilty at face value:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">AValueType</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">strings</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">first</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="n">strings</code><code class="p">.</code><code class="n">firstOrNull</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Everything seems fine:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">holdsState</code> <code class="p">=</code> <code class="n">AValueType</code><code class="p">(</code><code class="n">aList</code><code class="p">)</code>&#13;
<code class="n">assertEquals</code><code class="p">(</code><code class="n">holdsState</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">holdsState</code><code class="p">.</code><code class="n">strings</code><code class="p">.</code><code class="n">first</code><code class="p">())</code></pre>&#13;
&#13;
<p>But wait, don’t we still have a reference to a <code>MutableList</code>?</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">aMutableList</code><code class="p">[</code><code class="m">0</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="s">"banana"</code><code>&#13;
</code><code class="n">assertEquals</code><code class="p">(</code><code class="n">holdsState</code><code class="p">.</code><code class="n">first</code><code class="p">,</code><code> </code><code class="n">holdsState</code><code class="p">.</code><code class="n">strings</code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO6-1" id="co_introduction_CO6-1"><img alt="1" src="assets/1.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO6-1" id="callout_introduction_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>Expected "0", actual "banana"</code></p></dd>&#13;
</dl>&#13;
&#13;
<p><code>AValueType</code> turns out to be mutable after all!&#13;
Because of this, <code>first</code>, which is initialized on construction, can get out of date.&#13;
Having nonmutable collections interfaces has not resulted in immutable collections!</p>&#13;
<div data-type="tip"><h1>Immutable, Read-Only, Mutable</h1>&#13;
<p>The<a data-primary="read-only views" data-type="indexterm" id="idm46393404327528"/> official line is that a nonmutable Kotlin collection is not <em>immutable</em>, but rather a <em>read-only view</em> of a collection.&#13;
As with the Java <code>UnmodifiableList</code>, a read-only collection can’t be changed through its interface, but may be changed through some other mechanism.&#13;
Only true <em>immutable</em> collections are guaranteed never to change.</p>&#13;
&#13;
<p>It is possible to have true immutable collections on the JVM, (the result of <code>java.util.List.of(...)</code>, for example), but this is not (yet) a standard Kotlin feature.</p>&#13;
</div>&#13;
&#13;
<p>This is the unfortunate consequence of having your mutable collections extend your otherwise nonmutable collections; the recipient of a nonmutable collection cannot modify it, but cannot know that it won’t change, because a reference of type nonmutable <code>List</code> may in fact be pointing to an object of type <code>MutableList</code>.</p>&#13;
&#13;
<p>The rigorous solution to this problem is to separate mutable from immutable collections by not having a subtype relationship.&#13;
In this scheme, if we have a mutable list and want an immutable copy of it, we have to copy the data.&#13;
A<a data-primary="StringBuilder" data-type="indexterm" id="idm46393404300504"/> good analogy is a <code>StringBuilder</code>.&#13;
This is effectively a mutable <code>String</code>, but is not a subtype of <code>String</code>.&#13;
Once we have a result we want to publish, we need to call <code>.toString()</code>,&#13;
and subsequent modifications to the <code>StringBuilder</code> will not affect previous results.&#13;
Both Clojure and Scala adopted this builder approach for their mutable collections—why doesn’t Kotlin?</p>&#13;
&#13;
<p>We<a data-primary="collections" data-secondary="shared collections" data-type="indexterm" id="idm46393404297112"/> suspect that the answer is: because the Kotlin designers, like your authors, had adopted the convention described in <a data-type="xref" href="#dont-mutate-shared-collections">“Don’t Mutate Shared Collections”</a>.&#13;
If you treat any collection received as a parameter, returned as a result, or otherwise shared between code as immutable, then having mutable collections extend nonmutable collections turns out to be quite safe.&#13;
Admittedly <em>quite</em> in the sense of <em>mainly</em>, rather than <em>completely</em>, but still the benefits outweigh the costs.</p>&#13;
&#13;
<p>The Kotlin collections make this scheme even more powerful.&#13;
In Java, we have the situation where we can, in theory, mutate any collections, so the type system doesn’t tell us when this is safe or otherwise.&#13;
In Kotlin, if we declare all normal references as the nonmutable versions, we can use a <code>MutableCollection</code> to document when we do, in fact, consider that the collection is subject to change.&#13;
In return for accepting a largely theoretical risk, we reap the rewards of very simple and efficient interoperation with Java.&#13;
Pragmatism is typical of the grain of Kotlin; in this case it might be expressed as “be as safe as is sensible, but no safer.”</p>&#13;
&#13;
<p>We said that another way to express the “Don’t Mutate Shared Collections” is that our code should only mutate a collection that it has just created.&#13;
We see this in action if we look into the Kotlin standard library.&#13;
Here, for example, is (a simplified version of) the definition of <code>map</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">inline</code> <code class="k">fun</code> <code class="err">&lt;</code><code class="nf">T</code><code class="p">,</code> <code class="n">R</code><code class="p">&gt;</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;.</code><code class="n">map</code><code class="p">(</code><code class="n">transform</code><code class="p">:</code> <code class="p">(</code><code class="n">T</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">R</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">R</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">result</code> <code class="p">=</code> <code class="n">ArrayList</code><code class="p">&lt;</code><code class="n">R</code><code class="p">&gt;()</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">item</code> <code class="k">in</code> <code class="k">this</code><code class="p">)</code>&#13;
        <code class="n">result</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">transform</code><code class="p">(</code><code class="n">item</code><code class="p">))</code>&#13;
    <code class="k">return</code> <code class="n">result</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Here the list is built in place by mutation and then returned as read-only.&#13;
This is simple <em>and</em> efficient.&#13;
Technically, we <em>could</em> downcast the result to <code>MutableList</code> and change the result, but we shouldn’t.&#13;
Instead, we should take the result type at face value.&#13;
That way, any code sharing this collection will not have to worry about it changing.<a data-primary="" data-startref="Kcollect06" data-type="indexterm" id="idm46393404244312"/><a data-primary="" data-startref="Ckotling06" data-type="indexterm" id="idm46393404243432"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring from Java to Kotlin Collections" data-type="sect1"><div class="sect1" id="idm46393404780424">&#13;
<h1>Refactoring from Java to Kotlin Collections</h1>&#13;
&#13;
<p>Because<a data-primary="collections" data-secondary="refactoring from Java to Kotlin collections" data-type="indexterm" id="Crefact06"/><a data-primary="refactoring" data-secondary="Java to Kotlin collections" data-type="indexterm" id="RjavatoK06"/> of the smooth interop between Java and Kotlin collections described earlier, converting code with collections is usually seamless, at least at the syntactic level.&#13;
If our Java code relies on mutating collections, though, we may have to take extra care to avoid ending up breaking invariants in Kotlin.</p>&#13;
&#13;
<p>A good approach is to refactor your Java code to the convention used in <a data-type="xref" href="#dont-mutate-shared-collections">“Don’t Mutate Shared Collections”</a>  before converting it to Kotlin.&#13;
That’s what we’ll do here.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fix Up the Java" data-type="sect2"><div class="sect2" id="idm46393404237016">&#13;
<h2>Fix Up the Java</h2>&#13;
&#13;
<p>Let’s have a look at the code from Travelator we saw earlier.&#13;
The static methods we’ve been looking at are in a class called <code>Suffering</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Suffering</code><code> </code><code class="o">{</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="kt">int</code><code> </code><code class="nf">sufferScoreFor</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">route</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">Location</code><code> </code><code class="n">start</code><code> </code><code class="o">=</code><code> </code><code class="n">getDepartsFrom</code><code class="o">(</code><code class="n">route</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">longestJourneys</code><code> </code><code class="o">=</code><code> </code><code class="n">longestJourneysIn</code><code class="o">(</code><code class="n">route</code><code class="o">,</code><code> </code><code class="mi">3</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">sufferScore</code><code class="o">(</code><code class="n">longestJourneys</code><code class="o">,</code><code> </code><code class="n">start</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="nf">longestJourneysIn</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">journeys</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="kt">int</code><code> </code><code class="n">limit</code><code>&#13;
</code><code>    </code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">journeys</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">comparing</code><code class="o">(</code><code class="nl">Journey:</code><code class="o">:</code><code class="n">getDuration</code><code class="o">)</code><code class="o">.</code><code class="na">reversed</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" href="#callout_introduction_CO7-1" id="co_introduction_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">actualLimit</code><code> </code><code class="o">=</code><code> </code><code class="n">Math</code><code class="o">.</code><code class="na">min</code><code class="o">(</code><code class="n">journeys</code><code class="o">.</code><code class="na">size</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code> </code><code class="n">limit</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">journeys</code><code class="o">.</code><code class="na">subList</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code><code> </code><code class="n">actualLimit</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code class="o">&gt;</code><code> </code><code class="nf">routesToShowFor</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">itineraryId</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">routes</code><code> </code><code class="o">=</code><code> </code><code class="n">routesFor</code><code class="o">(</code><code class="n">itineraryId</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">removeUnbearableRoutes</code><code class="o">(</code><code class="n">routes</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">routes</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">static</code><code> </code><code class="kt">void</code><code> </code><code class="nf">removeUnbearableRoutes</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code class="o">&gt;</code><code> </code><code class="n">routes</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">routes</code><code class="o">.</code><code class="na">removeIf</code><code class="o">(</code><code class="n">route</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">sufferScoreFor</code><code class="o">(</code><code class="n">route</code><code class="o">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">10</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">static</code><code> </code><code class="kt">int</code><code> </code><code class="nf">sufferScore</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">longestJourneys</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="n">Location</code><code> </code><code class="n">start</code><code>&#13;
</code><code>    </code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">SOME_COMPLICATED_RESULT</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.5&amp;show=file">Example 6.5 [collections.0:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO7-1" id="callout_introduction_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>longestJourneysIn</code> breaks our rule by mutating its parameter.</p></dd>&#13;
</dl>&#13;
&#13;
<p>As we saw previously, because <code>longestJourneysIn</code> mutates its parameter, we can’t change the order of evaluation of <code>getDepartsFrom</code>, and <code>longestJourneysIn</code> in <code>sufferScoreFor</code>.&#13;
Before we can fix this, we have to be sure that no other code depends on this mutation.&#13;
This can be hard, which is itself a good reason not to allow modifying collections from the outset.&#13;
If we have confidence in our tests, we can try making the edit and seeing whether anything breaks.&#13;
Otherwise, we may have to add tests and/or reason with our code and dependency analysis.&#13;
Let’s decide that it’s safe to go ahead and make the change in Travelator.</p>&#13;
&#13;
<p>We don’t want to sort the collection in place, so we need a function that returns a sorted copy of a list without modifying the original.&#13;
Even Java 16 doesn’t seem to have a function to do this.&#13;
Curiously, <code>List.sort</code> actually creates a sorted version of itself and then mutates itself to match:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@SuppressWarnings</code><code class="o">({</code><code class="s">"unchecked"</code><code class="o">,</code> <code class="s">"rawtypes"</code><code class="o">})</code>&#13;
<code class="k">default</code> <code class="kt">void</code> <code class="nf">sort</code><code class="o">(</code><code class="n">Comparator</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">E</code><code class="o">&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">Object</code><code class="o">[]</code> <code class="n">a</code> <code class="o">=</code> <code class="k">this</code><code class="o">.</code><code class="na">toArray</code><code class="o">();</code>&#13;
    <code class="n">Arrays</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">a</code><code class="o">,</code> <code class="o">(</code><code class="n">Comparator</code><code class="o">)</code> <code class="n">c</code><code class="o">);</code>&#13;
    <code class="n">ListIterator</code><code class="o">&lt;</code><code class="n">E</code><code class="o">&gt;</code> <code class="n">i</code> <code class="o">=</code> <code class="k">this</code><code class="o">.</code><code class="na">listIterator</code><code class="o">();</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="n">Object</code> <code class="n">e</code> <code class="o">:</code> <code class="n">a</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">i</code><code class="o">.</code><code class="na">next</code><code class="o">();</code>&#13;
        <code class="n">i</code><code class="o">.</code><code class="na">set</code><code class="o">((</code><code class="n">E</code><code class="o">)</code> <code class="n">e</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This just goes to show how mutable thinking was the grain of Java, back in the Java 8 days when this was written.&#13;
There<a data-primary="Stream.sorted" data-type="indexterm" id="idm46393403896984"/> is now <code>Stream.sorted</code>, but in our experience streams rarely perform well with small collections (see <a data-type="xref" href="ch13.html#streams-to-sequences">Chapter 13</a>).&#13;
Maybe we shouldn’t care about performance, but we can’t help ourselves!&#13;
We justify our indulgence by reasoning that we know of several places in the code that currently sort in place, so will have to be changed to remove the mutation of shared collections.&#13;
Reasoning that the authors of <code>List.sort</code> actually knew a thing or two about Java efficiency, we copy their code and write:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"unchecked"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">static</code> <code class="o">&lt;</code><code class="n">E</code><code class="o">&gt;</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">E</code><code class="o">&gt;</code> <code class="n">sorted</code><code class="o">(</code>&#13;
    <code class="n">Collection</code><code class="o">&lt;</code><code class="n">E</code><code class="o">&gt;</code> <code class="n">collection</code><code class="o">,</code>&#13;
    <code class="n">Comparator</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">E</code><code class="o">&gt;</code> <code class="n">by</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">result</code> <code class="o">=</code> <code class="o">(</code><code class="n">E</code><code class="o">[])</code> <code class="n">collection</code><code class="o">.</code><code class="na">toArray</code><code class="o">();</code>&#13;
    <code class="n">Arrays</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">result</code><code class="o">,</code> <code class="n">by</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">Arrays</code><code class="o">.</code><code class="na">asList</code><code class="o">(</code><code class="n">result</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.6&amp;show=file">Example 6.6 [collections.3:src/main/java/travelator/Collections.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Before we go on, it’s worth considering how we can be confident that this code is correct.&#13;
Because of mutation, it’s really quite hard.&#13;
We have to be sure that <code>Arrays.sort</code> won’t affect the input collection, which means checking the documentation for &#13;
<span class="keep-together"><code>Collection.toArray</code></span>.&#13;
When we do, we find the magic words “The caller is thus free to modify the returned array,” so that’s OK; we’ve decoupled the input from the output.&#13;
This function is a classic example of accepting mutation in the scope where we create a collection, but not outside—create, don’t mutate.</p>&#13;
&#13;
<p>While we’re pulling this thread, what are we returning, and is it mutable?&#13;
<code>Arrays.​as⁠L⁠ist</code> returns an <code>ArrayList</code>, but not the standard one.&#13;
This one is private inside &#13;
<span class="keep-together"><code>Arrays</code></span> and writes through to our <code>result</code>.&#13;
Because it is backed by an array, though, we cannot add or remove items. It isn’t resizable.&#13;
It turns out that Java collections aren’t just mutable, nonmutable, or immutable; they are sometimes mutable provided that we don’t change their structure!&#13;
None of these distinctions are reflected in the type system, so it is possible to make type-preserving changes that break at runtime, depending on which code path yields a collection that we subsequently try to modify, and how we try to modify it.&#13;
This is yet another reason to sidestep the issue altogether and just never modify a shared collection.</p>&#13;
&#13;
<p>Returning to our refactoring, we can use our new <code>sorted</code> in <code>longestJourneysIn</code> to stop modifying the shared collection.</p>&#13;
&#13;
<p class="pagebreak-before">Using <code>sort</code>, we had:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="nf">longestJourneysIn</code><code class="o">(</code>&#13;
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">journeys</code><code class="o">,</code>&#13;
    <code class="kt">int</code> <code class="n">limit</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">journeys</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">comparing</code><code class="o">(</code><code class="nl">Journey:</code><code class="o">:</code><code class="n">getDuration</code><code class="o">).</code><code class="na">reversed</code><code class="o">());</code>&#13;
    <code class="n">var</code> <code class="n">actualLimit</code> <code class="o">=</code> <code class="n">Math</code><code class="o">.</code><code class="na">min</code><code class="o">(</code><code class="n">journeys</code><code class="o">.</code><code class="na">size</code><code class="o">(),</code> <code class="n">limit</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">journeys</code><code class="o">.</code><code class="na">subList</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">actualLimit</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.7&amp;show=file">Example 6.7 [collections.2:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Our new <code>sorted</code> function allows us to write:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="nf">longestJourneysIn</code><code class="o">(</code>&#13;
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">journeys</code><code class="o">,</code>&#13;
    <code class="kt">int</code> <code class="n">limit</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">actualLimit</code> <code class="o">=</code> <code class="n">Math</code><code class="o">.</code><code class="na">min</code><code class="o">(</code><code class="n">journeys</code><code class="o">.</code><code class="na">size</code><code class="o">(),</code> <code class="n">limit</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="nf">sorted</code><code class="o">(</code>&#13;
        <code class="n">journeys</code><code class="o">,</code>&#13;
        <code class="n">comparing</code><code class="o">(</code><code class="nl">Journey:</code><code class="o">:</code><code class="n">getDuration</code><code class="o">).</code><code class="na">reversed</code><code class="o">()</code>&#13;
    <code class="o">).</code><code class="na">subList</code><code class="o">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">actualLimit</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.8&amp;show=file">Example 6.8 [collections.3:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that <code>sufferScoreFor</code> won’t be subject to the side effect in <code>longestJourneysIn</code>, we can inline its local variables:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="kt">int</code> <code class="nf">sufferScoreFor</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="nf">sufferScore</code><code class="o">(</code>&#13;
        <code class="n">longestJourneysIn</code><code class="o">(</code><code class="n">route</code><code class="o">,</code> <code class="mi">3</code><code class="o">),</code>&#13;
        <code class="n">getDepartsFrom</code><code class="o">(</code><code class="n">route</code><code class="o">));</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.9&amp;show=file">Example 6.9 [collections.4:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Inlining local variables might not seem much of a payoff, but it’s a small example of a bigger theme.&#13;
In <a data-type="xref" href="ch07.html#actions-to-calculations">Chapter 7</a>, we’ll look at how avoiding mutation allows us to refactor code in ways that just aren’t safe otherwise.</p>&#13;
&#13;
<p>Stepping out to look at the callers of <code>sufferScoreFor</code>, we find:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">routesToShowFor</code><code class="o">(</code><code class="n">String</code> <code class="n">itineraryId</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">routes</code> <code class="o">=</code> <code class="n">routesFor</code><code class="o">(</code><code class="n">itineraryId</code><code class="o">);</code>&#13;
    <code class="n">removeUnbearableRoutes</code><code class="o">(</code><code class="n">routes</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="kd">private</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">removeUnbearableRoutes</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="n">routes</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">routes</code><code class="o">.</code><code class="na">removeIf</code><code class="o">(</code><code class="n">route</code> <code class="o">-&gt;</code> <code class="n">sufferScoreFor</code><code class="o">(</code><code class="n">route</code><code class="o">)</code> <code class="o">&gt;</code> <code class="mi">10</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.10&amp;show=file">Example 6.10 [collections.4:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Hmmm, that’s so pathologically mutating that it might have been written as an example in a book!&#13;
At least <code>removeUnbearableRoutes</code> is telling us that it must mutate something by returning <code>void</code>.&#13;
We can take baby steps by changing the function to return the parameter it is mutating and using the result—another case of making something worse before making it better:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">routesToShowFor</code><code class="o">(</code><code class="n">String</code> <code class="n">itineraryId</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">routes</code> <code class="o">=</code> <code class="n">routesFor</code><code class="o">(</code><code class="n">itineraryId</code><code class="o">);</code>&#13;
    <code class="n">routes</code> <code class="o">=</code> <code class="n">removeUnbearableRoutes</code><code class="o">(</code><code class="n">routes</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="kd">private</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">removeUnbearableRoutes</code>&#13;
    <code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="n">routes</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">routes</code><code class="o">.</code><code class="na">removeIf</code><code class="o">(</code><code class="n">route</code> <code class="o">-&gt;</code> <code class="n">sufferScoreFor</code><code class="o">(</code><code class="n">route</code><code class="o">)</code> <code class="o">&gt;</code> <code class="mi">10</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="o">;</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.11&amp;show=file">Example 6.11 [collections.5:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This time we’ll use <code>Stream.filter</code> to replace the mutation in <code>removeUnbearableRoutes</code>.&#13;
In passing, we can take the opportunity to rename it:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">routesToShowFor</code><code class="o">(</code><code class="n">String</code> <code class="n">itineraryId</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">routes</code> <code class="o">=</code> <code class="n">routesFor</code><code class="o">(</code><code class="n">itineraryId</code><code class="o">);</code>&#13;
    <code class="n">routes</code> <code class="o">=</code> <code class="n">bearable</code><code class="o">(</code><code class="n">routes</code><code class="o">);</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="kd">private</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">bearable</code>&#13;
    <code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="n">routes</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="o">.</code><code class="na">stream</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">route</code> <code class="o">-&gt;</code> <code class="n">sufferScoreFor</code><code class="o">(</code><code class="n">route</code><code class="o">)</code> <code class="o">&lt;=</code> <code class="mi">10</code><code class="o">)</code>&#13;
        <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toUnmodifiableList</code><code class="o">());</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.12&amp;show=file">Example 6.12 [collections.6:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Note how it is now easier to find a nice short name for our function; <code>removeUnbearableRoutes</code> becomes <code>bearable</code>.</p>&#13;
&#13;
<p>The reassignment to <code>routes</code> in <code>routesToShowFor</code> is ugly, but deliberate, because it allows us to draw parallels with the refactor in <a data-type="xref" href="ch05.html#beans-to-values">Chapter 5</a>.&#13;
There, we changed mutating-some-data-in-place to replacing-the-reference-with-a-mutated-value, and that is what we have done here too.&#13;
Of course, we don’t need the local variable at all really, so let’s get rid of it.&#13;
Invoking the Inline refactoring twice does it nicely:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">routesToShowFor</code><code class="o">(</code><code class="n">String</code> <code class="n">itineraryId</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="nf">bearable</code><code class="o">(</code><code class="n">routesFor</code><code class="o">(</code><code class="n">itineraryId</code><code class="o">));</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="kd">private</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="nf">bearable</code>&#13;
    <code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;&gt;</code> <code class="n">routes</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="o">.</code><code class="na">stream</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">route</code> <code class="o">-&gt;</code> <code class="n">sufferScoreFor</code><code class="o">(</code><code class="n">route</code><code class="o">)</code> <code class="o">&lt;=</code> <code class="mi">10</code><code class="o">)</code>&#13;
        <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toUnmodifiableList</code><code class="o">());</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.13&amp;show=file">Example 6.13 [collections.7:src/main/java/travelator/Suffering.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Convert to Kotlin" data-type="sect2"><div class="sect2" id="idm46393404236104">&#13;
<h2>Convert to Kotlin</h2>&#13;
&#13;
<p>Now that we’ve removed all the mutation from our Java collections, it’s time to convert to Kotlin.&#13;
“Convert Java File to Kotlin File” on our <code>Suffering</code> class does a reasonable job, but when we wrote this, it got confused, inferring the nullability of collections and their generic types.&#13;
After conversion, we had to remove <code>?</code>s from some hairy types like <code>List&lt;List&lt;Journey?&gt;&gt;?</code> to have:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">object</code> <code class="nc">Suffering</code> <code class="p">{</code>&#13;
    <code class="n">@JvmStatic</code>&#13;
    <code class="k">fun</code> <code class="nf">sufferScoreFor</code><code class="p">(</code><code class="n">route</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;):</code> <code class="n">Int</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">sufferScore</code><code class="p">(</code>&#13;
            <code class="n">longestJourneysIn</code><code class="p">(</code><code class="n">route</code><code class="p">,</code> <code class="m">3</code><code class="p">),</code>&#13;
            <code class="n">Routes</code><code class="p">.</code><code class="n">getDepartsFrom</code><code class="p">(</code><code class="n">route</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">@JvmStatic</code>&#13;
    <code class="k">fun</code> <code class="nf">longestJourneysIn</code><code class="p">(</code>&#13;
        <code class="n">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;,</code>&#13;
        <code class="n">limit</code><code class="p">:</code> <code class="n">Int</code>&#13;
    <code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">actualLimit</code> <code class="p">=</code> <code class="n">Math</code><code class="p">.</code><code class="n">min</code><code class="p">(</code><code class="n">journeys</code><code class="p">.</code><code class="n">size</code><code class="p">,</code> <code class="n">limit</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">sorted</code><code class="p">(</code>&#13;
            <code class="n">journeys</code><code class="p">,</code>&#13;
            <code class="n">comparing</code> <code class="p">{</code> <code class="n">obj</code><code class="p">:</code> <code class="n">Journey</code> <code class="p">-&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">duration</code> <code class="p">}.</code><code class="n">reversed</code><code class="p">()</code>&#13;
        <code class="p">).</code><code class="n">subList</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">actualLimit</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">routesToShowFor</code><code class="p">(</code><code class="n">itineraryId</code><code class="p">:</code> <code class="n">String</code><code class="p">?):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">bearable</code><code class="p">(</code><code class="n">Other</code><code class="p">.</code><code class="n">routesFor</code><code class="p">(</code><code class="n">itineraryId</code><code class="p">))</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">bearable</code><code class="p">(</code><code class="n">routes</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">routes</code><code class="p">.</code><code class="n">stream</code><code class="p">()</code>&#13;
            <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">route</code> <code class="p">-&gt;</code> <code class="n">sufferScoreFor</code><code class="p">(</code><code class="n">route</code><code class="p">)</code> <code class="p">&lt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="n">Collectors</code><code class="p">.</code><code class="n">toUnmodifiableList</code><code class="p">())</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">sufferScore</code><code class="p">(</code>&#13;
        <code class="n">longestJourneys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;,</code>&#13;
        <code class="n">start</code><code class="p">:</code> <code class="n">Location</code>&#13;
    <code class="p">):</code> <code class="n">Int</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">SOME_COMPLICATED_RESULT</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.14&amp;show=file">Example 6.14 [collections.8:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We have also reformatted and tidied some imports.&#13;
On the plus side, the Java code calling our Kotlin hasn’t had to change. Here, for example, is a test passing a plain Java <code>List</code> to the Kotlin <code>longestJourneyIn</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code> <code class="kd">public</code> <code class="kt">void</code> <code class="n">returns_limit_results</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">assertEquals</code><code class="o">(</code>&#13;
        <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">longJourney</code><code class="o">,</code> <code class="n">mediumJourney</code><code class="o">),</code>&#13;
        <code class="n">longestJourneysIn</code><code class="o">(</code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">shortJourney</code><code class="o">,</code> <code class="n">mediumJourney</code><code class="o">,</code> <code class="n">longJourney</code><code class="o">),</code> <code class="mi">2</code><code class="o">)</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.15&amp;show=file">Example 6.15 [collections.8:src/test/java/travelator/LongestJourneyInTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Returning to the Kotlin, we can now take advantage of the many utilities available on Kotlin collections to simplify the code.&#13;
Take <code>longestJourneysIn</code>, for example.&#13;
This was:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@JvmStatic</code>&#13;
<code class="k">fun</code> <code class="nf">longestJourneysIn</code><code class="p">(</code>&#13;
    <code class="n">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;,</code>&#13;
    <code class="n">limit</code><code class="p">:</code> <code class="n">Int</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">actualLimit</code> <code class="p">=</code> <code class="n">Math</code><code class="p">.</code><code class="n">min</code><code class="p">(</code><code class="n">journeys</code><code class="p">.</code><code class="n">size</code><code class="p">,</code> <code class="n">limit</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">sorted</code><code class="p">(</code>&#13;
        <code class="n">journeys</code><code class="p">,</code>&#13;
        <code class="n">comparing</code> <code class="p">{</code> <code class="n">obj</code><code class="p">:</code> <code class="n">Journey</code> <code class="p">-&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">duration</code> <code class="p">}.</code><code class="n">reversed</code><code class="p">()</code>&#13;
    <code class="p">).</code><code class="n">subList</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">actualLimit</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.16&amp;show=file">Example 6.16 [collections.8:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Replacing <code>sorted</code> with <code>sortedByDescending</code>, and <code>subList</code> with <code>take</code> gives:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@JvmStatic</code>&#13;
<code class="k">fun</code> <code class="nf">longestJourneysIn</code><code class="p">(</code><code class="n">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;,</code> <code class="n">limit</code><code class="p">:</code> <code class="n">Int</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="n">journeys</code><code class="p">.</code><code class="n">sortedByDescending</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">duration</code> <code class="p">}.</code><code class="n">take</code><code class="p">(</code><code class="n">limit</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.17&amp;show=file">Example 6.17 [collections.9:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now if we convert <code>longestJourneysIn</code> to an extension function (see <a data-type="xref" href="ch10.html#functions-to-extension-functions">Chapter 10</a>), we can simplify its name to <code>longestJourneys</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@JvmStatic</code>&#13;
<code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;.</code><code class="n">longestJourneys</code><code class="p">(</code><code class="n">limit</code><code class="p">:</code> <code class="n">Int</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="n">sortedByDescending</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">duration</code> <code class="p">}.</code><code class="n">take</code><code class="p">(</code><code class="n">limit</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.18&amp;show=file">Example 6.18 [collections.10:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Because <code>longestJourneys</code> doesn’t modify its parameter, we’ve made it a single-expression function (<a data-type="xref" href="ch09.html#multi-to-single-expression-functions">Chapter 9</a>).&#13;
It can still be called from Java as a static method, but reads particularly nicely when called from Kotlin, especially if we name the argument:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@JvmStatic</code><code>&#13;
</code><code class="k">fun</code><code> </code><code class="nf">sufferScoreFor</code><code class="p">(</code><code class="n">route</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">Int</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">sufferScore</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="n">route</code><code class="p">.</code><code class="n">longestJourneys</code><code class="p">(</code><code class="n">limit</code><code> </code><code class="p">=</code><code> </code><code class="m">3</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_introduction_CO8-1" id="co_introduction_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">Routes</code><code class="p">.</code><code class="n">getDepartsFrom</code><code class="p">(</code><code class="n">route</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.19&amp;show=file">Example 6.19 [collections.10:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO8-1" id="callout_introduction_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Named argument</p></dd>&#13;
</dl>&#13;
&#13;
<p>Moving on to <code>bearable</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">bearable</code><code class="p">(</code><code class="n">routes</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">routes</code><code class="p">.</code><code class="n">stream</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">route</code> <code class="p">-&gt;</code> <code class="n">sufferScoreFor</code><code class="p">(</code><code class="n">route</code><code class="p">)</code> <code class="p">&lt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="n">Collectors</code><code class="p">.</code><code class="n">toUnmodifiableList</code><code class="p">())</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.20&amp;show=file">Example 6.20 [collections.10:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Here we can use the techniques in <a data-type="xref" href="ch13.html#streams-to-sequences">Chapter 13</a> to convert the <code>Stream</code> to Kotlin.&#13;
We remove the call to <code>.stream()</code> as Kotlin makes <code>filter</code> available as an extension function on <code>List</code>.&#13;
Then we don’t need the terminal <code>toUnmodifiableList</code>, because Kotlin <code>filter</code> returns a <code>List</code> directly:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">bearable</code><code class="p">(</code><code class="n">routes</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">routes</code><code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">sufferScoreFor</code><code class="p">(</code><code class="n">it</code><code class="p">)</code> <code class="p">&lt;=</code> <code class="m">10</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.21&amp;show=file">Example 6.21 [collections.11:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Interestingly, this is a place where the result is potentially more mutable than our Java was.&#13;
In Java, we were collecting with <code>Collectors.toUnmodifiableList()</code>.&#13;
Kotlin <code>filter</code> declares its return type as <code>List</code> (the read-only view), but the actual runtime type is the mutable <code>ArrayList</code>.&#13;
Provided we never downcast, this shouldn’t be an issue, especially because we are now treating our shared collections as immutable even in Java.</p>&#13;
&#13;
<p>Here then is the final code:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">object</code> <code class="nc">Suffering</code> <code class="p">{</code>&#13;
    <code class="n">@JvmStatic</code>&#13;
    <code class="k">fun</code> <code class="nf">sufferScoreFor</code><code class="p">(</code><code class="n">route</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;):</code> <code class="n">Int</code> <code class="p">=</code>&#13;
        <code class="n">sufferScore</code><code class="p">(</code>&#13;
            <code class="n">route</code><code class="p">.</code><code class="n">longestJourneys</code><code class="p">(</code><code class="n">limit</code> <code class="p">=</code> <code class="m">3</code><code class="p">),</code>&#13;
            <code class="n">Routes</code><code class="p">.</code><code class="n">getDepartsFrom</code><code class="p">(</code><code class="n">route</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
&#13;
    <code class="n">@JvmStatic</code>&#13;
    <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;.</code><code class="n">longestJourneys</code><code class="p">(</code><code class="n">limit</code><code class="p">:</code> <code class="n">Int</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
        <code class="n">sortedByDescending</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">duration</code> <code class="p">}.</code><code class="n">take</code><code class="p">(</code><code class="n">limit</code><code class="p">)</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">routesToShowFor</code><code class="p">(</code><code class="n">itineraryId</code><code class="p">:</code> <code class="n">String</code><code class="p">?):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
        <code class="n">bearable</code><code class="p">(</code><code class="n">routesFor</code><code class="p">(</code><code class="n">itineraryId</code><code class="p">))</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">bearable</code><code class="p">(</code><code class="n">routes</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
        <code class="n">routes</code><code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">sufferScoreFor</code><code class="p">(</code><code class="n">it</code><code class="p">)</code> <code class="p">&lt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">sufferScore</code><code class="p">(</code>&#13;
        <code class="n">longestJourneys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;,</code>&#13;
        <code class="n">start</code><code class="p">:</code> <code class="n">Location</code>&#13;
    <code class="p">):</code> <code class="n">Int</code> <code class="p">=</code> <code class="n">SOME_COMPLICATED_RESULT</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=6.22&amp;show=file">Example 6.22 [collections.11:src/main/java/travelator/Suffering.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=6.22&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We say final, but in practice we probably wouldn’t finish this refactoring at this point.&#13;
Those <code>List&lt;List&lt;Journey&gt;&gt;</code> types are hinting at some type trying to get out, and in Kotlin we don’t usually publish static methods in an object like this; we prefer top-level function definitions.&#13;
<a data-type="xref" href="ch08.html#static-methods-to-top-level-functions">Chapter 8</a> will fix the latter at least.<a data-primary="" data-startref="RjavatoK06" data-type="indexterm" id="idm46393402066232"/><a data-primary="" data-startref="Crefact06" data-type="indexterm" id="idm46393402065288"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393403005640">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>Java at one time favored programming with mutability.&#13;
That has fallen out of vogue, but more by convention than by enforcement.&#13;
Kotlin has taken a very pragmatic approach to mutability in its collections, giving smooth operation and a simple programming model, but only where your Java conventions align with its approach.</p>&#13;
&#13;
<p>To<a data-primary="collections" data-secondary="assuring smooth interoperation" data-type="indexterm" id="idm46393402062408"/> help your Java and Kotlin interoperate smoothly:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Beware that Java can mutate a collection that it has passed to Kotlin.</p>&#13;
</li>&#13;
<li>&#13;
<p>Beware that Java can (at least try to) mutate a collection that it has received from Kotlin.</p>&#13;
</li>&#13;
<li>&#13;
<p>Remove mutation from your use of Java collections. Where you can’t, take defensive copies.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>We have more to say about collections in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15, <em>Encapsulated Collections to Type Aliases</em></a>.&#13;
In terms of this code example, <a data-type="xref" data-xrefstyle="chap-num-title" href="ch08.html#static-methods-to-top-level-functions">Chapter 8, <em>Static Methods to Top-Level Functions</em></a>, continues where this chapter leaves off.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>