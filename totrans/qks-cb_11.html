<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Authentication and Authorization"><div class="chapter" id="authentication_authorization">
<h1><span class="label">Chapter 11. </span>Authentication and Authorization</h1>


<p><a data-type="indexterm" data-primary="authentication and authorization" data-secondary="about" id="idm45128504255384"/><a data-type="indexterm" data-primary="authentication and authorization" id="aa_ch"/>In this chapter, you will learn about how authorization and authentication, the backbone of application security, work within a Quarkus application.
We’ll discuss the 
<span class="keep-together">following</span> topics:</p>

<ul>
<li>
<p>File-backed authentication and authorization schemes</p>
</li>
<li>
<p>Databased-backed authentication and authorization schemes</p>
</li>
<li>
<p>External-service-backed authentication and authorization schemes</p>
</li>
</ul>






<section data-type="sect1" class="orm:non-recipe" data-pdf-bookmark="Quarkus Security Basics"><div class="sect1" id="idm45128504318856">
<h1>Quarkus Security Basics</h1>

<p><a data-type="indexterm" data-primary="RBAC (role-based access control)" id="idm45128504317144"/>Before we get to our first recipe, this section will show you the basics of Quarkus and security, the security extensions you will use to load authentication sources, and how to protect resources using a <em>role-based access control</em> (RBAC) approach.</p>

<p>The examples shown in this section are not meant to be runnable, but they will be the basis for the upcoming recipes in which we are going to see the security extensions in action.</p>

<p>The following are the two main concepts regarding security:</p>
<dl>
<dt>Authentication</dt>
<dd>
<p>Validate your credentials (i.e., username/password) to verify your identity so that the system knows who you are.</p>
</dd>
<dt>Authorization</dt>
<dd>
<p>Verify your rights to be granted access to a protected resource. This happens after the authentication process.</p>
</dd>
</dl>








<section data-type="sect2" data-pdf-bookmark="Authentication"><div class="sect2" id="idm45128504235128">
<h2>Authentication</h2>

<p><a data-type="indexterm" data-primary="OpenID Connect" data-secondary="server" id="idm45128504233880"/><a data-type="indexterm" data-primary="BASIC method" id="idm45128504233032"/><a data-type="indexterm" data-primary="FORM method" id="idm45128504232424"/><a data-type="indexterm" data-primary="Keycloak" id="idm45128504231816"/>Quarkus provides two authenticating mechanisms for HTTP, the well-known <code>BASIC</code> and <code>FORM</code> methods.
These mechanisms can be extended by any Quarkus extension to provide a custom authentication method.
An example of these mechanisms is found in the form of the Quarkus extension to authenticate against an OpenID Connect server such as Keycloak.
We are going to explore how to do this in this section.</p>

<p>To use authentication, an identity provider is required to validate the credentials (i.e., username/password) provided by the user.
Quarkus provides the following identity providers out of the box, but you can implement your own, too<a data-type="indexterm" data-primary="Elytron properties file" id="idm45128504229352"/><a data-type="indexterm" data-primary="Elytron JDBC" id="idm45128504228744"/><a data-type="indexterm" data-primary="JPA" id="idm45128504228136"/><a data-type="indexterm" data-primary="SmallRye JWT" id="idm45128504227528"/><a data-type="indexterm" data-primary="OIDC" id="idm45128504226920"/><a data-type="indexterm" data-primary="Keycloak Authorization" id="idm45128504226312"/>:</p>
<dl>
<dt>Elytron properties file</dt>
<dd>
<p>Provides a mapping between user/password/role in the form of the properties file. The information can be embedded either in <em>application.properties</em> file or in a specific file for this purpose.</p>
</dd>
<dt>Elytron JDBC</dt>
<dd>
<p>Provides a mapping between user/password/role based on JDBC queries.</p>
</dd>
<dt>JPA</dt>
<dd>
<p>Provides support for authenticating via JPA.</p>
</dd>
<dt>SmallRye JWT</dt>
<dd>
<p>Provides authentication using JSON Web Tokens (JWT) spec.</p>
</dd>
<dt>OIDC</dt>
<dd>
<p>Provides authentication using an OpenID Connect (OIDC) provider like 
<span class="keep-together">Keycloak.</span></p>
</dd>
<dt>Keycloak authorization</dt>
<dd>
<p>Provides support for a policy enforcer using Keycloak Authorization Services.</p>
</dd>
</dl>










<section data-type="sect3" data-pdf-bookmark="Basic authentication"><div class="sect3" id="idm45128504224856">
<h3>Basic authentication</h3>

<p>To authenticate using <em>basic</em> access authentication, the <code>quarkus.http.auth.basic</code> configuration property must be set to <code>true</code>.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Form-based authentication"><div class="sect3" id="idm45128504214424">
<h3>Form-based authentication</h3>

<p>The <code>quarkus.http.auth.form.enabled</code> configuration property must be set to <code>true</code> in order to authenticate using <em>form</em> access authentication.</p>
<div data-type="important"><h6>Important</h6>
<p>Quarkus does not store the authenticated user in an HTTP session because there is no clustered HTTP session support. Instead, the authentication information is stored in an encrypted cookie.</p>
</div>

<p><a data-type="indexterm" data-primary="encryption key" id="idm45128504210664"/>The encryption key can be set using the <code>quarkus.http.auth.session.encryption-key</code> property, and it must be at least 16 characters long.
The key is hashed using SHA-256, and the result is used as a key for AES-256 encryption of the cookie value.
This cookie contains an expiry time as part of the encrypted value, generating a new cookie in one-minute intervals with an updated expiry time if the session is in use.</p>
</div></section>



</div></section>













<section data-type="sect2" data-pdf-bookmark="Authorization"><div class="sect2" id="idm45128504208936">
<h2>Authorization</h2>

<p><a data-type="indexterm" data-primary="Java EE Security annotations" id="idm45128504207240"/>Quarkus integrates with <a href="https://oreil.ly/ATPpq">Java EE Security annotations</a> to define RBAC on RESTful web endpoints and CDI beans.</p>

<p>Moreover, you can define the authorization of RESTful Web Endpoints using a 
<span class="keep-together">configuration</span> file (<em>application.properties</em>) instead of annotations.</p>

<p>Both approaches can coexist in the same application, but configuration file checks are executed before any annotation check and are not mutually exclusive, which means that in case of overlap, both checks must pass.</p>

<p>The following snippet shows how to secure a JAX-RS endpoint using the Java EE Security annotations:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.annotation.security.DenyAll</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.annotation.security.PermitAll</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.annotation.security.RolesAllowed</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.security.Authenticated</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.GET</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Path</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/hello"</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">GreetingResource</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/secured"</code><code class="o">)</code><code>
</code><code>    </code><code class="nd">@RolesAllowed</code><code class="o">(</code><code class="s">"Tester"</code><code class="o">)</code><code>  </code><a class="co" id="co_authentication_and_authorization_CO1-1" href="#callout_authentication_and_authorization_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">greetingSecured</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/unsecured"</code><code class="o">)</code><code>
</code><code>    </code><code class="nd">@PermitAll</code><code> </code><a class="co" id="co_authentication_and_authorization_CO1-2" href="#callout_authentication_and_authorization_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">greetingUnsecured</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/denied"</code><code class="o">)</code><code>
</code><code>    </code><code class="nd">@DenyAll</code><code> </code><a class="co" id="co_authentication_and_authorization_CO1-3" href="#callout_authentication_and_authorization_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">greetingDenied</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/authenticated"</code><code class="o">)</code><code>
</code><code>    </code><code class="nd">@Authenticated</code><code> </code><a class="co" id="co_authentication_and_authorization_CO1-4" href="#callout_authentication_and_authorization_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">greetingAuthenticated</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO1-1" href="#co_authentication_and_authorization_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Requires an authenticated user with role <code>Tester</code></p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO1-2" href="#co_authentication_and_authorization_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Unauthenticated users have access to the method</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO1-3" href="#co_authentication_and_authorization_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>No user can access whether authenticated or not</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO1-4" href="#co_authentication_and_authorization_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Permit any authenticated user to access; it is an alias of <code>@RolesAllowed("*")</code> and is provided by Quarkus, not the spec</p></dd>
</dl>

<p>The <code>javax.ws.rs.core.Context</code> annotation can be used to inject the <code>javax.ws.rs.core.SecurityContext</code> instance to get information about the user that was authenticated:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/secured"</code><code class="o">)</code><code>
</code><code class="nd">@RolesAllowed</code><code class="o">(</code><code class="s">"Tester"</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">greetingSecured</code><code class="o">(</code><code class="nd">@Context</code><code> </code><code class="n">SecurityContext</code><code> </code><code class="n">sec</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" id="co_authentication_and_authorization_CO2-1" href="#callout_authentication_and_authorization_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">Principal</code><code> </code><code class="n">user</code><code> </code><code class="o">=</code><code> </code><code class="n">sec</code><code class="o">.</code><code class="na">getUserPrincipal</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_authentication_and_authorization_CO2-2" href="#callout_authentication_and_authorization_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">String</code><code> </code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="n">user</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="kc">null</code><code> </code><code class="o">?</code><code> </code><code class="n">user</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">:</code><code> </code><code class="s">"anonymous"</code><code class="o">;</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">name</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO2-1" href="#co_authentication_and_authorization_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Injects <code>SecurityContext</code> for current request</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO2-2" href="#co_authentication_and_authorization_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Gets the current logged user</p></dd>
</dl>
<div data-type="important"><h6>Important</h6>
<p>Security annotations are not restricted only to JAX-RS resources. They can be used in CDI beans to protect method calls, too.</p>
</div>

<p>Quarkus supports configuring RESTful web endpoints using the configuration file instead of annotations.
The equivalent security annotation example can be expressed using the configuration file:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.http.auth.policy.role-policy1.roles-allowed</code><code class="o">=</code><code class="s">Tester </code><a class="co" id="co_authentication_and_authorization_CO3-1" href="#callout_authentication_and_authorization_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>

</code><code class="na">quarkus.http.auth.permission.roles1.paths</code><code class="o">=</code><code class="s">/hello/secured   </code><a class="co" id="co_authentication_and_authorization_CO3-2" href="#callout_authentication_and_authorization_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.http.auth.permission.roles1.policy</code><code class="o">=</code><code class="s">role-policy1    </code><a class="co" id="co_authentication_and_authorization_CO3-3" href="#callout_authentication_and_authorization_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.http.auth.permission.roles1.methods</code><code class="o">=</code><code class="s">GET  </code><a class="co" id="co_authentication_and_authorization_CO3-4" href="#callout_authentication_and_authorization_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>

</code><code class="na">quarkus.http.auth.permission.deny1.paths</code><code class="o">=</code><code class="s">/hello/denied</code><code>
</code><code class="na">quarkus.http.auth.permission.deny1.policy</code><code class="o">=</code><code class="s">deny </code><a class="co" id="co_authentication_and_authorization_CO3-5" href="#callout_authentication_and_authorization_CO3-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>

</code><code class="na">quarkus.http.auth.permission.permit1.paths</code><code class="o">=</code><code class="s">/hello/unsecured</code><code>
</code><code class="na">quarkus.http.auth.permission.permit1.policy</code><code class="o">=</code><code class="s">permit </code><a class="co" id="co_authentication_and_authorization_CO3-6" href="#callout_authentication_and_authorization_CO3-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code class="na">quarkus.http.auth.permission.permit1.methods</code><code class="o">=</code><code class="s">GET</code><code>

</code><code class="na">quarkus.http.auth.permission.roles2.paths</code><code class="o">=</code><code class="s">/hello/authenticated</code><code>
</code><code class="na">quarkus.http.auth.permission.roles2.policy</code><code class="o">=</code><code class="s">authenticated</code><code>
</code><code class="na">quarkus.http.auth.permission.roles2.methods</code><code class="o">=</code><code class="s">GET</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO3-1" href="#co_authentication_and_authorization_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Defines the roles of the application; <code>role-policy1</code> is used as reference value</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO3-2" href="#co_authentication_and_authorization_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the permission to the resource; <code>roles1</code> is an arbitrary name to avoid 
<span class="keep-together">repeating</span> keys</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO3-3" href="#co_authentication_and_authorization_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the role policy</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO3-4" href="#co_authentication_and_authorization_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Restricts permission to the <code>GET</code> method</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO3-5" href="#co_authentication_and_authorization_CO3-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Denies access</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO3-6" href="#co_authentication_and_authorization_CO3-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Permits access</p></dd>
</dl>

<p>It is important to note that the <code>paths</code> attribute supports multiple values separated by a comma, and also the <code>*</code> wildcard to match any subpath.
For example, <code>quarkus.http.auth.permission.permit1.paths=/public/_,/robots.txt</code> sets permission for any resource placed at <em>/public</em> and any of its subpaths and the file <em>/robots.txt</em>.</p>

<p>In the same way, the <code>methods</code> attribute allows multiple values separated by a comma.</p>

<p>There are two configuration properties that affect the RBAC behavior:</p>
<dl>
<dt><code>quarkus.security.jaxrs.deny-unannotated-endpoints</code></dt>
<dd>
<p>If it is set to <code>true</code>, then all JAX-RS endpoints not annotated with security annotations are denied by default. This property is <code>false</code> by default.</p>
</dd>
<dt><code>quarkus.security.deny-unannotated-members</code></dt>
<dd>
<p>If it is set to <code>true</code>, then all JAX-RS endpoints and CDI methods not annotated with security annotations are denied by default. This property is <code>false</code> by default.</p>
</dd>
</dl>

<p>So far, you’ve seen that in Quarkus you can set authorization procedure (basic, form, or other provided by extension) and define the authentication roles using security annotations or specifying them in the configuration file.</p>

<p>The recipes in this chapter will explore the different Quarkus extensions to provide authentication and authorization identity providers.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="11.1 Authentication and Authorization with Elytron Properties File Config"><div class="sect1" id="authentication-and-authorization-with-elytron-properties-file-config">
<h1>11.1 Authentication and Authorization with Elytron Properties File Config</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128503813336">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="authentication and authorization" data-secondary="with Elytron Properties File config" id="aa_epf"/><a data-type="indexterm" data-primary="Elytron properties file" id="epf_ab"/>You want to secure the application by storing identities in files.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128503809512">
<h2>Solution</h2>

<p>Quarkus security provides support to store identities in files using the Elytron properties file config as an identity provider.</p>

<p><a data-type="indexterm" data-primary="RBAC (role-based access control)" id="idm45128503807048"/>You’ve seen how to define the authentication mechanism and how to protect the resources with RBAC, either with security annotations or in <em>application.properties</em>, but you’ve not seen how to register an identity provider and how to store the user information like username, password, or roles where it belongs.</p>

<p>Let’s see how to define identity information using the Elytron properties file config extension.
This extension is based on the properties file to define all identity information, and its main purpose is for development and testing.
It is not recommended that this be used in production because passwords can be expressed only in plain text or in MD5 hashed.</p>

<p>To enable the Elytron properties file config, you need to register the <code>quarkus-elytron-security-properties-file</code> extension:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension \</code>
<code class="go">	-Dextensions="quarkus-elytron-security-properties-file"</code></pre>

<p>This extension supports the mapping of users to passwords and users to roles with a combination of properties files.</p>

<p>Protect the endpoint with allowing only the <code>Tester</code> role to access the resource:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="nd">@RolesAllowed</code><code class="o">(</code><code class="s">"Tester"</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="s">"hello"</code><code class="o">;</code>
<code class="o">}</code></pre>

<p>To register identities, two properties files are required, one for mapping user and password, and another one for mapping the user and the list of roles they belong in.</p>

<p>The user configuration properties file defines for each line the pair of user and password that are registered in the system:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">alex</code><code class="o">=</code><code class="s">soto</code></pre>

<p>In the users’ properties file, the key part is the username, and the value part is the password.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p><a data-type="indexterm" data-primary="MD5" id="idm45128503752776"/>Notice that the password is in plain text. You can hash the password with MD5 following this pattern: <code>HEX(MD5(username:realm:password)</code>.</p>
</div>

<p>The roles configuration file defines for each line the pair of username and the roles (separated by commas) that the user belongs in:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">alex</code><code class="o">=</code><code class="s">Tester</code></pre>

<p>In the roles properties file, the key part is the username, and the value is the roles assigned to the user.</p>

<p>Finally, the Elytron Security properties file extension needs to be configured with the classpath locations of the users and roles properties files:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.http.auth.basic</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_authentication_and_authorization_CO4-1" href="#callout_authentication_and_authorization_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>

</code><code class="na">quarkus.security.users.file.enabled</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_authentication_and_authorization_CO4-2" href="#callout_authentication_and_authorization_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.users.file.plain-text</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_authentication_and_authorization_CO4-3" href="#callout_authentication_and_authorization_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.users.file.users</code><code class="o">=</code><code class="s">users.properties </code><a class="co" id="co_authentication_and_authorization_CO4-4" href="#callout_authentication_and_authorization_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.users.file.roles</code><code class="o">=</code><code class="s">roles.properties</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO4-1" href="#co_authentication_and_authorization_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Enables basic authentication method</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO4-2" href="#co_authentication_and_authorization_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Enables security with the properties file extension</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO4-3" href="#co_authentication_and_authorization_CO4-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the password that is not hashed with MD5</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO4-4" href="#co_authentication_and_authorization_CO4-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets the classpath location of the users and roles properties files</p></dd>
</dl>

<p>Run the generated test to validate the protection of the endpoint:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean test</code>

<code class="go">...</code>
<code class="go">INFO  [io.quarkus] (main) Installed features:</code>
<code class="go">	[cdi, resteasy, security, security-properties-file]</code>
<code class="go">[ERROR] Tests run: 2, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 8.485 s</code>
<code class="go">	&lt;&lt;&lt; FAILURE! - in org.acme.quickstart.GreetingResourceTest</code>
<code class="go">[ERROR] testHelloEndpoint  Time elapsed: 0.076 s  &lt;&lt;&lt; FAILURE!</code>
<code class="go">java.lang.AssertionError:</code>
<code class="go">1 expectation failed.</code>
<code class="go">Expected status code &lt;200&gt; but was &lt;401&gt;.</code>
<code class="go">	at org.acme.quickstart.GreetingResourceTest.testHelloEndpoint</code>
<code class="go">		(GreetingResourceTest.java:17)</code></pre>

<p><a data-type="indexterm" data-primary="HTTP 401 Unauthorized error" id="idm45128503605368"/>The test is failing with an HTTP 401 Unauthorized error because the test is not 
<span class="keep-together">providing</span> any identity using the Basic authentication method.
Modify the test to 
<span class="keep-together">authenticate</span> with a configured username and password:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Test</code><code>
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">testSecuredHelloEndpoint</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="n">given</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">auth</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO5-1" href="#callout_authentication_and_authorization_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">basic</code><code class="o">(</code><code class="s">"alex"</code><code class="o">,</code><code> </code><code class="s">"soto"</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO5-2" href="#callout_authentication_and_authorization_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">when</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"/hello"</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">then</code><code class="o">(</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">statusCode</code><code class="o">(</code><code class="mi">200</code><code class="o">)</code><code>
</code><code>            </code><code class="o">.</code><code class="na">body</code><code class="o">(</code><code class="n">is</code><code class="o">(</code><code class="s">"hello"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO5-1" href="#co_authentication_and_authorization_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets authentication part</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO5-2" href="#co_authentication_and_authorization_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Basic authentication with a given username and password</p></dd>
</dl>

<p>Now, with valid authenticating parameters, the test passes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128503808520">
<h2>Discussion</h2>

<p>The Elytron properties file config extension also supports embedding the mapping between user/password/roles in the Quarkus configuration file (<em>application.properties</em>) instead of using different files.</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.security.users.embedded.enabled</code><code class="o">=</code><code class="s">true</code>
<code class="na">quarkus.security.users.embedded.plain-text</code><code class="o">=</code><code class="s">true</code>
<code class="na">quarkus.security.users.embedded.users.alex</code><code class="o">=</code><code class="s">soto</code>
<code class="na">quarkus.security.users.embedded.roles.alex</code><code class="o">=</code><code class="s">Admin,Tester</code></pre>

<p>Passwords stored in a file can be hashed using the formula <code>HEX(MD5(username ":" realm ":" password))</code>.</p>

<p>An embedded Elytron properties file config can be configured by using the properties listed in <a data-type="xref" href="#embeded-elytron-properties-config-table">Table 11-1</a><a data-type="indexterm" data-primary="" data-startref="aa_epf" id="idm45128503477320"/><a data-type="indexterm" data-primary="" data-startref="epf_ab" id="idm45128503476408"/>.</p>
<table id="embeded-elytron-properties-config-table">
<caption><span class="label">Table 11-1. </span>Embeded Elytron properties</caption>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><div>
<p><code>quarkus.security.users.embedded.realm-name</code></p></div></td>
<td><div>
<p>The realm name used when generating a hashed password (defaults to <code>Quarkus</code>).</p></div></td>
</tr>
<tr>
<td><div>
<p><code>quarkus.security.users.embedded.enabled</code></p></div></td>
<td><div>
<p>Enables security with the properties file extension (defaults to <code>false</code>).</p></div></td>
</tr>
<tr>
<td><div>
<p><code>quarkus.security.users.embedded.plain-text</code></p></div></td>
<td><div>
<p>Sets if the password is hashed or not. If <code>true</code>, the hashed password must be in the form of <code>HEX(MD5(username:realm:password)</code> (defaults to <code>false</code>).</p></div></td>
</tr>
<tr>
<td><div>
<p><code>quarkus.security.users.embedded.users.&lt;user&gt;</code></p></div></td>
<td><div>
<p>The user information. The key part is the username, and the value part is the password.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>quarkus.security.users.embedded.roles.&lt;user&gt;</code></p></div></td>
<td><div>
<p>The role information. The key part is the username, and the value part is the password.</p></div></td>
</tr>
</tbody>
</table>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="11.2 Authentication and Authorization with Elytron Security JDBC Config"><div class="sect1" id="idm45128503452520">
<h1>11.2 Authentication and Authorization with Elytron Security JDBC Config</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128503451576">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="authentication and authorization" data-secondary="with Elytron Security JDBC config" id="aa_jdbc"/><a data-type="indexterm" data-primary="Elytron Security JDBC" id="jdbc_ab"/>You want to secure the application and store user identities in a database.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128503429896">
<h2>Solution</h2>

<p>Quarkus security provides support to store user identities in a data source using 
<span class="keep-together">Elytron</span> Security JDBC config as an identity provider.</p>

<p>You’ve seen how to define identities in properties files using the Elytron properties file config extension in <a data-type="xref" href="#authentication-and-authorization-with-elytron-properties-file-config">Recipe 11.1</a>.
However, as noted there, this method is more for testing/dev purposes and should not be used in production environments.</p>

<p>The Elytron Security JDBC extension can be used to store the user identities in a database, supporting password encryption using bcrypt password mapper, and being versatile enough to not lock you into any predefined database schema.</p>

<p>To enable the Elytron Security JDBC extension, you need to register the <code>quarkus-elytron-security-jdbc</code> extension, the JDBC driver used to connect to the database, and optionally Flyway to populate schema and some default users:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension \</code>
<code class="go">    -Dextensions="quarkus-elytron-security-jdbc,quarkus-jdbc-h2,quarkus-flyway"</code></pre>

<p>Protect the endpoint with allowing only the <code>Tester</code> role to access the resource:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code>
<code class="nd">@RolesAllowed</code><code class="o">(</code><code class="s">"Tester"</code><code class="o">)</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="s">"hello"</code><code class="o">;</code>
<code class="o">}</code></pre>

<p>The next step is to define the database schema to store all RBAC information.
For the sake of simplicity, a simple table with user, password, and role is used in this example:</p>

<pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">test_user</code> <code class="p">(</code>
  <code class="n">id</code> <code class="nb">INT</code><code class="p">,</code>
  <code class="n">username</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">),</code>
  <code class="n">password</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">),</code>
  <code class="k">role</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">)</code>
<code class="p">);</code>

<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">test_user</code> <code class="p">(</code><code class="n">id</code><code class="p">,</code> <code class="n">username</code><code class="p">,</code> <code class="n">password</code><code class="p">,</code> <code class="k">role</code><code class="p">)</code>
  <code class="k">VALUES</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'alex'</code><code class="p">,</code> <code class="s1">'soto'</code><code class="p">,</code> <code class="s1">'Tester'</code><code class="p">);</code></pre>

<p>Finally, the extension must be configured to specify which query to execute to 
<span class="keep-together">validate</span> the user and retrieve the roles they belong in:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.url</code><code class="o">=</code><code class="s">jdbc:h2:mem:mydb</code><code>
</code><code class="na">quarkus.datasource.driver</code><code class="o">=</code><code class="s">org.h2.Driver</code><code>
</code><code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">sa</code><code>
</code><code class="na">quarkus.datasource.password</code><code class="o">=</code><code>

</code><code class="na">quarkus.flyway.migrate-at-start</code><code class="o">=</code><code class="s">true</code><code>

</code><code class="na">quarkus.security.jdbc.enabled</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_authentication_and_authorization_CO6-1" href="#callout_authentication_and_authorization_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.sql</code><code class="o">=</code><code class="s">\
  SELECT u.password, u.role FROM test_user u WHERE u.username=? </code><a class="co" id="co_authentication_and_authorization_CO6-2" href="#callout_authentication_and_authorization_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.clear-password-mapper.enabled</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_authentication_and_authorization_CO6-3" href="#callout_authentication_and_authorization_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="err">q</code><code class="err">u</code><code class="err">a</code><code class="err">r</code><code class="err">k</code><code class="err">u</code><code class="err">s</code><code class="err">.</code><code class="err">s</code><code class="err">e</code><code class="err">c</code><code class="err">u</code><code class="err">r</code><code class="err">i</code><code class="err">t</code><code class="err">y</code><code class="err">.</code><code class="err">j</code><code class="err">d</code><code class="err">b</code><code class="err">c</code><code class="err">.</code><code class="err">p</code><code class="err">r</code><code class="err">i</code><code class="err">n</code><code class="err">c</code><code class="err">i</code><code class="err">p</code><code class="err">a</code><code class="err">l</code><code class="err">-</code><code class="err">q</code><code class="err">u</code><code class="err">e</code><code class="err">r</code><code class="err">y</code><code class="err">.</code><code class="err">c</code><code class="err">l</code><code class="err">e</code><code class="err">a</code><code class="err">r</code><code class="err">-</code><code class="err">p</code><code class="err">a</code><code class="err">s</code><code class="err">s</code><code class="err">w</code><code class="err">o</code><code class="err">r</code><code class="err">d</code><code class="err">-</code><code class="err">m</code><code class="err">a</code><code class="err">p</code><code class="err">p</code><code class="err">e</code><code class="err">r</code><code class="err">\</code><code>
  </code><code class="na">.password-index</code><code class="o">=</code><code class="s">1</code><a class="co" id="co_authentication_and_authorization_CO6-4" href="#callout_authentication_and_authorization_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.attribute-mappings.0.index</code><code class="o">=</code><code class="s">2 </code><a class="co" id="co_authentication_and_authorization_CO6-5" href="#callout_authentication_and_authorization_CO6-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.attribute-mappings.0.to</code><code class="o">=</code><code class="s">groups</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO6-1" href="#co_authentication_and_authorization_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Enables Elytron Security JDBC</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO6-2" href="#co_authentication_and_authorization_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Defines the query to validate the user and get the roles; the query must contain exactly one parameter (the username) and return at least the password, and the value should be on the same line as the key</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO6-3" href="#co_authentication_and_authorization_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The password is stored in cleartext</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO6-4" href="#co_authentication_and_authorization_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets the index of the password; this should all be on the same line</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO6-5" href="#co_authentication_and_authorization_CO6-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Sets the index of the role and specifies the field as role</p></dd>
</dl>
<div data-type="important"><h6>Important</h6>
<p>Index is 1-based.</p>
</div>
<div data-type="tip"><h6>Tip</h6>
<p>The query to retrieve the password (and optionally the roles) can be as complex as required by your model (i.e., SQL joins).</p>
</div>

<p>Now, the authentication and authorization data are retrieved from the database instead of a file.
When the username and password are provided (e.g., using the basic <code>auth</code> method), the query is executed to retrieve all required information for the authentication process (matching provided password against the retrieved password from the database) and to get roles for the authorization process.</p>

<p>Remember to update the test (if not done before) to make it pass:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Test</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">testSecuredHelloEndpoint</code><code class="o">()</code> <code class="o">{</code>
    <code class="n">given</code><code class="o">()</code>
      <code class="o">.</code><code class="na">auth</code><code class="o">().</code><code class="na">basic</code><code class="o">(</code><code class="s">"alex"</code><code class="o">,</code> <code class="s">"soto"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">when</code><code class="o">()</code>
      <code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"/hello"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">then</code><code class="o">()</code>
      <code class="o">.</code><code class="na">statusCode</code><code class="o">(</code><code class="mi">200</code><code class="o">)</code>
      <code class="o">.</code><code class="na">body</code><code class="o">(</code><code class="n">is</code><code class="o">(</code><code class="s">"hello"</code><code class="o">));</code>
<code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128503429304">
<h2>Discussion</h2>

<p>In this recipe, you’ve used a cleartext password, which obviously should not be used in a production environment.
The extension provides an integration to the <code>bcrypt</code> password mapper, so the authentication process also works for hashing passwords.<a data-type="indexterm" data-primary="bcrypt" id="idm45128503009592"/><a data-type="indexterm" data-primary="iteration count" id="idm45128503008888"/></p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45128503008088">
<h5>About bcrypt</h5>
<p><code>bcrypt</code> is a password hashing function designed by Niels Provos and David Mazières that incorporates several protections like a <em>salt</em> to protect against rainbow table attacks and an <em>iteration count</em> to be resistant against brute-force search attacks.</p>
</div></aside>

<p>You need to extend the configuration file with some extra parameters 
<span class="keep-together">to indicate</span> to Elytron Security JDBC that the password is using <code>bcrypt</code> and should not be 
<span class="keep-together">compared</span> as cleartext.</p>

<p>Instead of configuring <code>clear-password-mapper</code>, the <code>bcrypt-password-mapper</code> is used.
The following is an example of a configuration file using <code>bcrypt</code>:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.security.jdbc.enabled</code><code class="o">=</code><code class="s">true</code><code>
</code><code class="na">quarkus.security.jdbc.principal-query.sql</code><code class="o">=</code><code class="s">\
    SELECT u.password, u.role, u.salt, u.iteration \
    FROM test_user u WHERE u.username=?</code><code>

</code><code class="na">quarkus.security.jdbc.principal-query.clear-password-mapper.enabled</code><code class="o">=</code><code class="s">false</code><code>
</code><code class="na">quarkus.security.jdbc.principal-query.bcrypt-password-mapper.enabled</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_authentication_and_authorization_CO7-1" href="#callout_authentication_and_authorization_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.bcrypt-password-mapper.password-index</code><code class="o">=</code><code class="s">\
    1         </code><a class="co" id="co_authentication_and_authorization_CO7-2" href="#callout_authentication_and_authorization_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.bcrypt-password-mapper.hash-encoding</code><code class="o">=</code><code class="s">\
    BASE64    </code><a class="co" id="co_authentication_and_authorization_CO7-3" href="#callout_authentication_and_authorization_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.bcrypt-password-mapper.salt-index</code><code class="o">=</code><code class="s">\
    3         </code><a class="co" id="co_authentication_and_authorization_CO7-4" href="#callout_authentication_and_authorization_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.bcrypt-password-mapper.salt-encoding</code><code class="o">=</code><code class="s">\
    BASE64    </code><a class="co" id="co_authentication_and_authorization_CO7-5" href="#callout_authentication_and_authorization_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="err">q</code><code class="err">u</code><code class="err">a</code><code class="err">r</code><code class="err">k</code><code class="err">u</code><code class="err">s</code><code class="err">.</code><code class="err">s</code><code class="err">e</code><code class="err">c</code><code class="err">u</code><code class="err">r</code><code class="err">i</code><code class="err">t</code><code class="err">y</code><code class="err">.</code><code class="err">j</code><code class="err">d</code><code class="err">b</code><code class="err">c</code><code class="err">.</code><code class="err">p</code><code class="err">r</code><code class="err">i</code><code class="err">n</code><code class="err">c</code><code class="err">i</code><code class="err">p</code><code class="err">a</code><code class="err">l</code><code class="err">-</code><code class="err">q</code><code class="err">u</code><code class="err">e</code><code class="err">r</code><code class="err">y</code><code class="err">.</code><code class="err">b</code><code class="err">c</code><code class="err">r</code><code class="err">y</code><code class="err">p</code><code class="err">t</code><code class="err">-</code><code class="err">p</code><code class="err">a</code><code class="err">s</code><code class="err">s</code><code class="err">w</code><code class="err">o</code><code class="err">r</code><code class="err">d</code><code class="err">-</code><code class="err">m</code><code class="err">a</code><code class="err">p</code><code class="err">p</code><code class="err">e</code><code class="err">r</code><code class="err">.</code><code class="err">\</code><code>
    </code><code class="na">iteration-count-index</code><code class="o">=</code><code class="s">4 </code><a class="co" id="co_authentication_and_authorization_CO7-6" href="#callout_authentication_and_authorization_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>

</code><code class="na">quarkus.security.jdbc.principal-query.attribute-mappings.0.index</code><code class="o">=</code><code class="s">2</code><code>
</code><code class="na">quarkus.security.jdbc.principal-query.attribute-mappings.0.to</code><code class="o">=</code><code class="s">groups</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO7-1" href="#co_authentication_and_authorization_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Enables bcrypt</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO7-2" href="#co_authentication_and_authorization_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets password index; this should be on the same line</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO7-3" href="#co_authentication_and_authorization_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets password hash encoding; this should be on the same line</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO7-4" href="#co_authentication_and_authorization_CO7-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets salt index; this should be on the same line</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO7-5" href="#co_authentication_and_authorization_CO7-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Sets salt encoding; this should be on the same line</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO7-6" href="#co_authentication_and_authorization_CO7-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Sets iteration count index; this should be on the same line</p></dd>
</dl>

<p>After this change, the password matching between the provided password and the password retrieved by query does not happen in cleartext. Rather, the provided password is hashed using bcrypt and then compared with the stored password:<a data-type="indexterm" data-primary="" data-startref="aa_jdbc" id="idm45128502810696"/><a data-type="indexterm" data-primary="" data-startref="jdbc_ab" id="idm45128502809848"/></p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.security.jdbc.enabled</code><code class="o">=</code><code class="s">true</code><code>

</code><code class="na">quarkus.security.jdbc.principal-query.sql</code><code class="o">=</code><code class="s">\
    SELECT u.password FROM test_user u WHERE u.username=? </code><a class="co" id="co_authentication_and_authorization_CO8-1" href="#callout_authentication_and_authorization_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.clear-password-mapper.enabled</code><code class="o">=</code><code class="s">true</code><code>
</code><code class="na">quarkus.security.jdbc.principal-query.clear-password-mapper.password-index</code><code class="o">=</code><code class="s">1</code><code>

</code><code class="na">quarkus.security.jdbc.principal-query.roles.sql</code><code class="o">=</code><code class="s">\
    SELECT r.role_name FROM test_role r, test_user_role ur \
    WHERE ur.username=? AND ur.role_id = r.id </code><a class="co" id="co_authentication_and_authorization_CO8-2" href="#callout_authentication_and_authorization_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="s"> </code><a class="co" id="co_authentication_and_authorization_CO8-3" href="#callout_authentication_and_authorization_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.roles.datasource</code><code class="o">=</code><code class="s">permissions </code><a class="co" id="co_authentication_and_authorization_CO8-4" href="#callout_authentication_and_authorization_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.security.jdbc.principal-query.roles.attribute-mappings.0.index</code><code class="o">=</code><code class="s">1</code><code>
</code><code class="na">quarkus.security.jdbc.principal-query.roles.attribute-mappings.0.to</code><code class="o">=</code><code class="s">groups</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO8-1" href="#co_authentication_and_authorization_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Default data source is used to retrieve the password</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO8-2" href="#co_authentication_and_authorization_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p><code>roles</code> is used as a name to identify the second query; the query should all be on the same line</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO8-3" href="#co_authentication_and_authorization_CO8-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Gets the role from another query</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO8-4" href="#co_authentication_and_authorization_CO8-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Role query is executed against a data source named <code>permissions</code></p></dd>
</dl>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="11.3 Authorization with MicroProfile JWT"><div class="sect1" id="authorization-with-microprofile-jwt">
<h1>11.3 Authorization with MicroProfile JWT</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128502733656">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="authentication and authorization" data-secondary="with MicroProfile JWT" id="aa_jwt"/><a data-type="indexterm" data-primary="MicroProfile JWT" id="jwt_ab"/>You want to save security context in RESTful web services and stateless services in general.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128502729960">
<h2>Solution</h2>

<p>Use JSON Web Tokens.</p>

<p><a data-type="indexterm" data-primary="JWT (JSON Web Token)" id="idm45128502726984"/>JWT (JSON Web Token) is a standard specified under RFC-7519 that is used for exchanging information between services.
The particularity of JWT is that the token content is formatted in JSON instead of in plain text or any other binary format.</p>

<p>Quarkus integrates with the <a href="https://oreil.ly/IU0-d">MicroProfile JWT specification</a> to 
<span class="keep-together">consume</span> and validate JWT tokens and retrieve the claims.</p>

<p>A JWT token is formed by <em>claims</em>, which are the information to transmit—for example, the username, the expiration of the token, or the roles of the user.
The token is digitally signed so the information contained in the token can be trusted and verified.</p>

<p><a data-type="indexterm" data-primary="headers" id="idm45128502722712"/><a data-type="indexterm" data-primary="claims" id="idm45128502722008"/><a data-type="indexterm" data-primary="signature" id="idm45128502721336"/>A JWT token is composed of three sections. All of them are encoded in the Base64 format:</p>
<dl>
<dt>Header</dt>
<dd>
<p>It contains some metadata, like the algorithm used to sign the token; custom information of the token, like the type of token; or unencrypted claims if using JSON Web Encryption (JWE).</p>
</dd>
<dt>Claims</dt>
<dd>
<p>Information to store inside the token. Some claims are mandatory, others are options, and some are custom to our application.</p>
</dd>
<dt>Signature</dt>
<dd>
<p>The signature of the token.</p>
</dd>
</dl>

<p>Then the three sections are encoded to Base64 and concatenated with a period sign (<code>.</code>), so the final token looks like  <code>base64(Header).base64(Claims).base64(Signature)</code>.</p>

<p>For this example, the following JWT token is used:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code><code> </code><a class="co" id="co_authentication_and_authorization_CO9-1" href="#callout_authentication_and_authorization_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
  </code><code class="nt">"kid"</code><code class="p">:</code><code> </code><code class="s2">"/privateKey.pem"</code><code class="p">,</code><code>
  </code><code class="nt">"typ"</code><code class="p">:</code><code> </code><code class="s2">"JWT"</code><code class="p">,</code><code>
  </code><code class="nt">"alg"</code><code class="p">:</code><code> </code><code class="s2">"RS256"</code><code>
</code><code class="p">}</code><code class="err">,</code><code>
</code><code class="p">{</code><code> </code><a class="co" id="co_authentication_and_authorization_CO9-2" href="#callout_authentication_and_authorization_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
  </code><code class="nt">"sub"</code><code class="p">:</code><code> </code><code class="s2">"jdoe-using-jwt-rbac"</code><code class="p">,</code><code>
  </code><code class="nt">"aud"</code><code class="p">:</code><code> </code><code class="s2">"using-jwt-rbac"</code><code class="p">,</code><code>
  </code><code class="nt">"upn"</code><code class="p">:</code><code> </code><code class="s2">"jdoe@quarkus.io"</code><code class="p">,</code><code>
  </code><code class="nt">"birthdate"</code><code class="p">:</code><code> </code><code class="s2">"2001-07-13"</code><code class="p">,</code><code>
  </code><code class="nt">"auth_time"</code><code class="p">:</code><code> </code><code class="mi">1570094171</code><code class="p">,</code><code>
  </code><code class="nt">"iss"</code><code class="p">:</code><code> </code><code class="s2">"https://quarkus.io/using-jwt-rbac"</code><code class="p">,</code><code> </code><a class="co" id="co_authentication_and_authorization_CO9-3" href="#callout_authentication_and_authorization_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
  </code><code class="nt">"roleMappings"</code><code class="p">:</code><code> </code><code class="p">{</code><code>
    </code><code class="nt">"group2"</code><code class="p">:</code><code> </code><code class="s2">"Group2MappedRole"</code><code class="p">,</code><code>
    </code><code class="nt">"group1"</code><code class="p">:</code><code> </code><code class="s2">"Group1MappedRole"</code><code>
  </code><code class="p">}</code><code class="p">,</code><code>
  </code><code class="nt">"groups"</code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><a class="co" id="co_authentication_and_authorization_CO9-4" href="#callout_authentication_and_authorization_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
    </code><code class="s2">"Echoer"</code><code class="p">,</code><code>
    </code><code class="s2">"Tester"</code><code class="p">,</code><code>
    </code><code class="s2">"Subscriber"</code><code class="p">,</code><code>
    </code><code class="s2">"group2"</code><code>
  </code><code class="p">]</code><code class="p">,</code><code>
  </code><code class="nt">"preferred_username"</code><code class="p">:</code><code> </code><code class="s2">"jdoe"</code><code class="p">,</code><code>
  </code><code class="nt">"exp"</code><code class="p">:</code><code> </code><code class="mi">2200814171</code><code class="p">,</code><code>
  </code><code class="nt">"iat"</code><code class="p">:</code><code> </code><code class="mi">1570094171</code><code class="p">,</code><code>
  </code><code class="nt">"jti"</code><code class="p">:</code><code> </code><code class="s2">"a-123"</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO9-1" href="#co_authentication_and_authorization_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Header part</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO9-2" href="#co_authentication_and_authorization_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Claims part</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO9-3" href="#co_authentication_and_authorization_CO9-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The issuer of the token</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO9-4" href="#co_authentication_and_authorization_CO9-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Groups (or roles) that the owner of the token belongs in</p></dd>
</dl>

<p>The following is the serialized version of the same token:</p>

<pre data-type="programlisting" data-code-language="bash">eyJraWQiOiJcL3ByaXZhdGVLZXkucGVtIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYifQ.
eyJzdWIiOiJqZG9lLXVzaW5nLWp3dC1yYmFjIiwiYXVkIjoidXNpbmctand0LXJiYWMiLCJ
1cG4iOiJqZG9lQHF1YXJrdXMuaW8iLCJiaXJ0aGRhdGUiOiIyMDAxLTA3LTEzIiwiYXV0aF
90aW1lIjoxNTcwMDk0MTcxLCJpc3MiOiJodHRwczpcL1wvcXVhcmt1cy5pb1wvdXNpbmcta
nd0LXJiYWMiLCJyb2xlTWFwcGluZ3MiOnsiZ3JvdXAyIjoiR3JvdXAyTWFwcGVkUm9sZSIs
Imdyb3VwMSI6Ikdyb3VwMU1hcHBlZFJvbGUifSwiZ3JvdXBzIjpbIkVjaG9lciIsIlRlc3R
lciIsIlN1YnNjcmliZXIiLCJncm91cDIiXSwicHJlZmVycmVkX3VzZXJuYW1lIjoiamRvZS
IsImV4cCI6MjIwMDgxNDE3MSwiaWF0IjoxNTcwMDk0MTcxLCJqdGkiOiJhLTEyMyJ9.
Hzr41h3_uewy-g2B-sonOiBObtcpkgzqmF4bT3cO58v45AIOiegl7HIx7QgEZHRO4PdUtR3
4x9W23VJY7NJ545ucpCuKnEV1uRlspJyQevfI-mSRg1bHlMmdDt661-V3KmQES8WX2B2uqi
rykO5fCeCp3womboilzCq4VtxbmM2qgf6ag8rUNnTCLuCgEoulGwTn0F5lCrom-7dJOTryW
1KI0qUWHMMwl4TX5cLmqJLgBzJapzc5_yEfgQZ9qXzvsT8zeOWSKKPLm7LFVt2YihkXa80l
Wcjewwt61rfQkpmqSzAHL0QIs7CsM9GfnoYc0j9po83-P3GJiBMMFmn-vg</pre>

<p>Notice how the sections are divided by periods.</p>

<p>MicroProfile JWT spec performs the following operations when a request is received:</p>
<div style="page-break-after: always;"/>
<ol>
<li>
<p>Extract security token from the request, usually from the <code>Authorization</code> header.</p>
</li>
<li>
<p>Validate the token to make sure that the token is valid. These checks might involve things like verifying the signature to trust on the token or verifying that the token has not expired.</p>
</li>
<li>
<p>Extract token information.</p>
</li>
<li>
<p>Create a security context with identity information so it can be used in case of authorization (RBAC).</p>
</li>

</ol>

<p>Moreover, the MicroProfile JWT spec sets a list of mandatory claims that every token must provide:</p>
<table>

<thead>
<tr>
<th>Claim</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><div>
<p><code>typ</code></p></div></td>
<td><div>
<p>The token format. It must be <code>JWT</code>.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>alg</code></p></div></td>
<td><div>
<p>Identifies the cryptographic algorithm to secure the token. It must be <code>RS256</code>.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>kid</code></p></div></td>
<td><div>
<p>Indicates which key was used to secure the token.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>iss</code></p></div></td>
<td><div>
<p>The token issuer.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>sub</code></p></div></td>
<td><div>
<p>Identifies the principal subjected to the token.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>aud</code></p></div></td>
<td><div>
<p>Identifies the recipients that the token is intended for.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>exp</code></p></div></td>
<td><div>
<p>Sets the expiration time.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>iat</code></p></div></td>
<td><div>
<p>Provides the time at which the token was issued.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>jti</code></p></div></td>
<td><div>
<p>Unique identifier of the token.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>upn</code></p></div></td>
<td><div>
<p>The user-principal name used in the <code>java.security.Principal</code> interface.</p></div></td>
</tr>
<tr>
<td><div>
<p><code>groups</code></p></div></td>
<td><div>
<p>The list of group names that have been assigned to the principal of the token. They are the roles in which the user belongs.</p></div></td>
</tr>
</tbody>
</table>

<p>These are the minimal claims that are required by the MicroProfile JWT specification, but additional claims can be added, such as <code>preferred_username</code> or any other information that your application might need to transmit between services.</p>

<p>Register the <code>quarkus-smallrye-jwt</code> extension to start using the MicroProfile JWT specification:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-smallrye-jwt"</code></pre>

<p>Configure the extension to set the public key used to verify that the token has not been modified and that the issuer (<code>iss</code>) claim of the token the server accepts is valid.</p>

<p>The following are public key formats supported by the specification:</p>

<ul>
<li>
<p>Public Key Cryptography Standards #8 (PKCS#8) Privacy-Enhanced Mail (PEM)</p>
</li>
<li>
<p>JSON Web Key (JWK)</p>
</li>
<li>
<p>JSON Web Key Set (JWKS)</p>
</li>
<li>
<p>JSON Web Key (JWK) Base64 URL encoded</p>
</li>
<li>
<p>JSON Web Key Set (JWKS) Base64 URL encoded</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="JWKS (JSON Web Key Set)" id="idm45128502489736"/>For this example, we choose the JSON Web Key Set (JWKS) format to specify the public key used to validate the token.</p>

<p>The JWKS file containing the public key is placed inside the project directory:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code>
    <code class="nt">"keys"</code><code class="p">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="nt">"kty"</code><code class="p">:</code> <code class="s2">"RSA"</code><code class="p">,</code>
            <code class="nt">"kid"</code><code class="p">:</code> <code class="s2">"/privateKey.pem"</code><code class="p">,</code>
            <code class="nt">"e"</code><code class="p">:</code> <code class="s2">"AQAB"</code><code class="p">,</code>
            <code class="nt">"n"</code><code class="p">:</code> <code class="s2">"livFI8qB4D0y2jy0CfEqFyy46R0o7S8TKpsx5xbHKoU1VWg6QkQm-ntyIv1</code>
<code class="s2">                  p4kE1sPEQO73-HY8-Bzs75XwRTYL1BmR1w8J5hmjVWjc6R2BTBGAYRPFRho</code>
<code class="s2">                  r3kpM6ni2SPmNNhurEAHw7TaqszP5eUF_F9-KEBWkwVta-PZ37bwqSE4sCb</code>
<code class="s2">                  1soZFrVz_UT_LF4tYpuVYt3YbqToZ3pZOZ9AX2o1GCG3xwOjkc4x0W7ezbQ</code>
<code class="s2">                  ZdC9iftPxVHR8irOijJRRjcPDtA6vPKpzLl6CyYnsIYPd99ltwxTHjr3npf</code>
<code class="s2">                  v_3Lw50bAkbT4HeLFxTx4flEoZLKO_g0bAoV2uqBhkA9xnQ"</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre>

<p>The configuration file pointing to this data is the following:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">mp.jwt.verify.publickey.location</code><code class="o">=</code><code class="s">quarkus.pub.jwk.json </code><a class="co" id="co_authentication_and_authorization_CO10-1" href="#callout_authentication_and_authorization_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">mp.jwt.verify.issuer</code><code class="o">=</code><code class="s">https://quarkus.io/using-jwt-rbac </code><a class="co" id="co_authentication_and_authorization_CO10-2" href="#callout_authentication_and_authorization_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO10-1" href="#co_authentication_and_authorization_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Location of the public key</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO10-2" href="#co_authentication_and_authorization_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The issuer accepted by the service</p></dd>
</dl>

<p>Apart from handling the verification process of the token, the MicroProfile JWT integrates with existing Java EE security APIs providing the data from the token.
The integration happens in the following annotations:</p>

<pre data-type="programlisting" data-code-language="java"><code class="n">javax</code><code class="o">.</code><code class="na">ws</code><code class="o">.</code><code class="na">rs</code><code class="o">.</code><code class="na">core</code><code class="o">.</code><code class="na">SecurityContext</code><code class="o">.</code><code class="na">getUserPrincipal</code><code class="o">()</code>
<code class="n">javax</code><code class="o">.</code><code class="na">ws</code><code class="o">.</code><code class="na">rs</code><code class="o">.</code><code class="na">core</code><code class="o">.</code><code class="na">SecurityContext</code><code class="o">.</code><code class="na">isUserInRole</code><code class="o">(</code><code class="n">String</code><code class="o">)</code>
<code class="n">javax</code><code class="o">.</code><code class="na">servlet</code><code class="o">.</code><code class="na">http</code><code class="o">.</code><code class="na">HttpServletRequest</code><code class="o">.</code><code class="na">getUserPrincipal</code><code class="o">()</code>
<code class="n">javax</code><code class="o">.</code><code class="na">servlet</code><code class="o">.</code><code class="na">http</code><code class="o">.</code><code class="na">HttpServletRequest</code><code class="o">.</code><code class="na">isUserInRole</code><code class="o">(</code><code class="n">String</code><code class="o">)</code>
<code class="n">javax</code><code class="o">.</code><code class="na">ejb</code><code class="o">.</code><code class="na">SessionContext</code><code class="o">.</code><code class="na">getCallerPrincipal</code><code class="o">()</code>
<code class="n">javax</code><code class="o">.</code><code class="na">ejb</code><code class="o">.</code><code class="na">SessionContext</code><code class="o">.</code><code class="na">isCallerInRole</code><code class="o">(</code><code class="n">String</code><code class="o">)</code>
<code class="n">javax</code><code class="o">.</code><code class="na">security</code><code class="o">.</code><code class="na">jacc</code><code class="o">.</code><code class="na">PolicyContext</code>
  <code class="o">.</code><code class="na">getContext</code><code class="o">(</code><code class="s">"javax.security.auth.Subject.container"</code><code class="o">)</code>
<code class="n">javax</code><code class="o">.</code><code class="na">security</code><code class="o">.</code><code class="na">enterprise</code><code class="o">.</code><code class="na">identitystore</code><code class="o">.</code><code class="na">IdentityStore</code>
  <code class="o">.</code><code class="na">getCallerGroups</code><code class="o">(</code><code class="n">CredentialValidationResult</code><code class="o">)</code>
<code class="nd">@javax.annotation.security.RolesAllowed</code></pre>

<p>Furthermore, the MicroProfile JWT spec provides two classes to accommodate JWT data inside CDI or JAX-RS classes:</p>
<dl>
<dt><code>org.eclipse.microprofile.jwt.JsonWebToken</code></dt>
<dd>
<p>Interface that exposes the raw token and offers methods to get the claims</p>
</dd>
<dt><code>@org.eclipse.microprofile.jwt.Claim</code></dt>
<dd>
<p>Annotation to provide injection of claims into classes</p>
</dd>
</dl>

<p>For example:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.annotation.security.RolesAllowed</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.enterprise.context.RequestScoped</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.inject.Inject</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.GET</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Path</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.Produces</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.eclipse.microprofile.jwt.Claim</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.eclipse.microprofile.jwt.Claims</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.eclipse.microprofile.jwt.JsonWebToken</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/hello"</code><code class="o">)</code><code>
</code><code class="nd">@RequestScoped</code><code> </code><a class="co" id="co_authentication_and_authorization_CO11-1" href="#callout_authentication_and_authorization_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">GreetingResource</code><code> </code><code class="o">{</code><code>
</code><code>
</code><code>    </code><code class="nd">@Inject</code><code>
</code><code>    </code><code class="n">JsonWebToken</code><code> </code><code class="n">callerPrincipal</code><code class="o">;</code><code> </code><a class="co" id="co_authentication_and_authorization_CO11-2" href="#callout_authentication_and_authorization_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="nd">@Claim</code><code class="o">(</code><code class="n">standard</code><code> </code><code class="o">=</code><code> </code><code class="n">Claims</code><code class="o">.</code><code class="na">preferred_username</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO11-3" href="#callout_authentication_and_authorization_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">String</code><code> </code><code class="n">username</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="nd">@GET</code><code>
</code><code>    </code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">hello</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="s">"hello "</code><code> </code><code class="o">+</code><code> </code><code class="n">username</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO11-1" href="#co_authentication_and_authorization_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>A JWT token is, by nature, request-scoped; if you expect to use the token, the class must be <code>RequestScoped</code> to avoid mixing tokens in classes</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO11-2" href="#co_authentication_and_authorization_CO11-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Injects <code>JsonWebToken</code> interface that represents the full JWT token</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO11-3" href="#co_authentication_and_authorization_CO11-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Injects the <code>preferred_username</code> claim</p></dd>
</dl>

<p>Claim annotation also supports the injection of private claim names.
These claims are not official claim names provided by the RFC but claims that are specific to the 
<span class="keep-together">service</span> (custom claims).
To inject a private claim, use the annotation value as the name of the claim: <code>@Claim("<em>my_claim</em>")</code>.
Moreover, in case of nonmandatory claims, the <code>java.util.Optional</code> class can be used to indicate that the claim is nullable:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Claim</code><code class="o">(</code><code class="n">standard</code> <code class="o">=</code> <code class="n">Claims</code><code class="o">.</code><code class="na">birthdate</code><code class="o">)</code>
<code class="n">Optional</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">birthdate</code><code class="o">;</code></pre>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45128502232952">
<h5>The ClaimValue Interface</h5>
<p><a data-type="indexterm" data-primary="ClaimValue interface" id="idm45128502254680"/>To support beans/resources that are <em>not</em> <code>@RequestScoped</code>, the MicroProfile JWT spec introduces the <code>org.eclipse.microprofile.jwt.ClaimValue</code> interface that, used together with <code>@Claim</code>, makes the injection of the value safe from concurrent requests:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Claim</code><code class="o">(</code><code class="n">standard</code><code> </code><code class="o">=</code><code> </code><code class="n">Claims</code><code class="o">.</code><code class="na">exp</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO12-1" href="#callout_authentication_and_authorization_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">ClaimValue</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code><code> </code><code class="n">username</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Claim</code><code class="o">(</code><code class="n">standard</code><code> </code><code class="o">=</code><code> </code><code class="n">Claims</code><code class="o">.</code><code class="na">groups</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO12-2" href="#callout_authentication_and_authorization_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="n">ClaimValue</code><code class="o">&lt;</code><code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="o">&gt;</code><code> </code><code class="n">groups</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@Claim</code><code class="o">(</code><code class="s">"raw_token"</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO12-3" href="#callout_authentication_and_authorization_CO12-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">ClaimValue</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="n">rawToken</code><code class="o">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO12-1" href="#co_authentication_and_authorization_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Expiration time injected</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO12-2" href="#co_authentication_and_authorization_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Groups are injected in the form of <code>java.util.Set</code></p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO12-3" href="#co_authentication_and_authorization_CO12-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p><code>raw_token</code> is a special claim that represents the JWT token in raw format; the raw token can be used to propagate it across other services</p></dd>
</dl>
</div></aside>

<p>Update the test to send a bearer JWT token to the defined endpoint:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Test</code><code>
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">testHelloEndpoint</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="n">given</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">header</code><code class="o">(</code><code class="s">"Authorization"</code><code class="o">,</code><code> </code><code class="s">"Bearer "</code><code> </code><code class="o">+</code><code> </code><code class="n">validToken</code><code class="o">)</code><code> </code><a class="co" id="co_authentication_and_authorization_CO13-1" href="#callout_authentication_and_authorization_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">when</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"/hello"</code><code class="o">)</code><code class="o">.</code><code class="na">then</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">statusCode</code><code class="o">(</code><code class="mi">200</code><code class="o">)</code><code class="o">.</code><code class="na">body</code><code class="o">(</code><code class="n">is</code><code class="o">(</code><code class="s">"hello jdoe"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO13-1" href="#co_authentication_and_authorization_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>JWT token is sent as bearer token in <code>Authorization</code> header</p></dd>
</dl>

<p>With the current solution, these assumptions are true:</p>

<ul class="less-space-list">
<li>
<p>If a valid token is provided, the <code>preferred_username</code> is extracted.</p>
</li>
<li>
<p>If an invalid token is provided (expired, signature not valid, modified by third party, etc.), then a 401 Unauthorized Error error code is sent back to the caller.</p>
</li>
<li>
<p>If no token is provided, then the request is processed but the <code>preferred_username</code> field is null.</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="isCallerInRole() method" id="idm45128501888552"/>The MicroProfile JWT spec also provides support for the authorization process by integrating with the <code>@RolesAllowed</code> annotation.
The <code>groups</code> claim value is used any time the <code>isCallerInRole()</code> method is called, which effectively means that any value in <code>groups</code> can be used as a role in the application.</p>

<p>The <code>groups</code> claim in the JWT token used in this example contains the following values: <code>"groups": ["Echoer", "Tester", "Subscriber", "group2"]</code>.
Protect the call to <code>/hello</code> by using <code>@RolesAllowed</code> with one of the group values present in the token:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="nd">@RolesAllowed</code><code class="o">(</code><code class="s">"Tester"</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{}</code></pre>

<p>Now, you can assume the following:</p>

<ul>
<li>
<p>If a valid token is provided and the <code>groups</code> claim contains the <code>Tester</code> group, then the <code>preferred_username</code> is extracted.</p>
</li>
<li>
<p>If a valid token is provided and the <code>groups</code> claim does not contain the <code>Tester</code> group, then a 403 Forbidden error code is sent back to the caller.</p>
</li>
<li>
<p>If an invalid token is provided (expired, signature not valid, modified by third party, etc.), then a 401 Unauthorized Error error code is sent back to the caller.</p>
</li>
<li>
<p>If no token is provided, then a 401 Unauthorized Error error code is sent back to the caller.</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128502728344">
<h2>Discussion</h2>

<p>In the past, the security context was saved in the HTTP session, which works well until you start scaling up the services and things start to become more and more complicated.
To avoid this problem, one of the possible solutions is to pass this information in all calls using a token, especially a JSON token.</p>

<p>It is important to note that the token is signed and not encrypted, which means that the information can be seen by anyone but not modified.
An encryption layer can be added using JSON Web Encryption so that the claims are not in cleartext but instead are encrypted.</p>

<p>The intent of this section is not for you to master JWT but for you learn how to use it in Quarkus, so we are assuming that you already have some knowledge about JWT.
We are also providing some links in the  following “See Also” to help you become more familiar with JWT.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128501827416">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="aa_jwt" id="idm45128501826216"/><a data-type="indexterm" data-primary="" data-startref="jwt_ab" id="idm45128501825240"/><a data-type="indexterm" data-primary="JWT (JSON Web Token)" id="idm45128501824296"/>To learn about JWT, visit the following web pages:</p>

<ul>
<li>
<p><a href="https://jwt.io">JSON Web Tokens</a></p>
</li>
<li>
<p><a href="https://oreil.ly/tXP9d">GitHub: JWT RBAC for MicroProfile</a></p>
</li>
<li>
<p><a href="https://oreil.ly/p9jUC">IETF: JSON Web Token</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="11.4 Authorization and Authentication with OpenId Connect"><div class="sect1" id="idm45128501818968">
<h1>11.4 Authorization and Authentication with OpenId Connect</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128501817960">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="authentication and authorization" data-secondary="with OpenID Connect" id="aa_open"/><a data-type="indexterm" data-primary="OpenID Connect" data-secondary="authentication and authorization with" id="open_aa"/>You want to protect your RESTful Web API with OpenId Connect.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128501813976">
<h2>Solution</h2>

<p>Use bearing token authorization where the token is issued by OpenId Connect.</p>

<p>In the previous section, you learned how to use the JWT token for protecting resources, but the generation of the token was not covered because the token was generated up front and provided in a text file.</p>

<p><a data-type="indexterm" data-primary="Keycloak" id="idm45128501811032"/>In real-world applications, you need an identity provider that issues the token.
The de facto protocol for distributed services is OpenId Connect and OAuth 2.0 and an authorization-compliant server with the protocol, such as <a href="https://www.keycloak.org">Keycloak</a>.</p>

<p>Register the <code>quarkus-oidc</code> extension to protect resources with OpenId Connect:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-oidc"</code></pre>

<p>Configure the location of the OpenId Connect server to validate the token:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.oidc.auth-server-url</code><code class="o">=</code><code class="s">http://localhost:8180/auth/realms/quarkus </code><a class="co" id="co_authentication_and_authorization_CO14-1" href="#callout_authentication_and_authorization_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.oidc.client-id</code><code class="o">=</code><code class="s">backend-service </code><a class="co" id="co_authentication_and_authorization_CO14-2" href="#callout_authentication_and_authorization_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO14-1" href="#co_authentication_and_authorization_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The base URL of the OpenID Connect server</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO14-2" href="#co_authentication_and_authorization_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Each application has a client ID used to identify the application</p></dd>
</dl>

<p>Protect the endpoint using the <code>@RolesAllowed</code> annotation:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code><code>
</code><code class="n">io</code><code class="o">.</code><code class="na">quarkus</code><code class="o">.</code><code class="na">security</code><code class="o">.</code><code class="na">identity</code><code class="o">.</code><code class="na">SecurityIdentity</code><code> </code><code class="n">securityIdentity</code><code class="o">;</code><code> </code><a class="co" id="co_authentication_and_authorization_CO15-1" href="#callout_authentication_and_authorization_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="nd">@GET</code><code>
</code><code class="nd">@RolesAllowed</code><code class="o">(</code><code class="s">"user"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">hello</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="s">"hello "</code><code> </code><code class="o">+</code><code> </code><code class="n">securityIdentity</code><code class="o">.</code><code class="na">getPrincipal</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO15-1" href="#co_authentication_and_authorization_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Quarkus interface that represents the currently logged in user</p></dd>
</dl>

<p>The test must be updated to get the access token from OpenId Connect and provide it as the bearer token:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Test</code>
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">testHelloEndpoint</code><code class="o">()</code> <code class="o">{</code>
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">accessToken</code><code class="o">);</code>
    <code class="n">given</code><code class="o">()</code>
      <code class="o">.</code><code class="na">auth</code><code class="o">().</code><code class="na">oauth2</code><code class="o">(</code><code class="n">accessToken</code><code class="o">)</code>
      <code class="o">.</code><code class="na">when</code><code class="o">().</code><code class="na">get</code><code class="o">(</code><code class="s">"/hello"</code><code class="o">)</code>
      <code class="o">.</code><code class="na">then</code><code class="o">()</code>
         <code class="o">.</code><code class="na">statusCode</code><code class="o">(</code><code class="mi">200</code><code class="o">)</code>
         <code class="o">.</code><code class="na">body</code><code class="o">(</code><code class="n">is</code><code class="o">(</code><code class="s">"hello alice"</code><code class="o">));</code>
<code class="o">}</code></pre>

<p>The access token is generated in the OpenId Connect server. To generate it, some parameters must be provided, such as the username and password, to access the server and to generate a token representing the user:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">quickstart</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.net.URI</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.net.URISyntaxException</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.restassured.RestAssured</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.restassured.builder.RequestSpecBuilder</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.restassured.response.Response</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.restassured.response.ResponseOptions</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.restassured.specification.RequestSpecification</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">RestAssuredExtension</code> <code class="o">{</code>

  <code class="kd">public</code> <code class="kd">static</code> <code class="n">ResponseOptions</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">getAccessToken</code><code class="o">(</code><code class="n">String</code> <code class="n">url</code><code class="o">,</code>
                                                         <code class="n">String</code> <code class="n">clientId</code><code class="o">,</code>
                                                         <code class="n">String</code> <code class="n">clientIdPwd</code><code class="o">,</code>
                                                         <code class="n">String</code> <code class="n">username</code><code class="o">,</code>
                                                         <code class="n">String</code> <code class="n">password</code><code class="o">)</code> <code class="o">{</code>
    <code class="kd">final</code> <code class="n">RequestSpecification</code> <code class="n">request</code> <code class="o">=</code> <code class="n">prepareRequest</code><code class="o">(</code><code class="n">url</code><code class="o">);</code>
    <code class="k">try</code> <code class="o">{</code>
      <code class="k">return</code> <code class="n">request</code>
        <code class="o">.</code><code class="na">auth</code><code class="o">()</code>
        <code class="o">.</code><code class="na">preemptive</code><code class="o">()</code>
        <code class="o">.</code><code class="na">basic</code><code class="o">(</code><code class="n">clientId</code><code class="o">,</code> <code class="n">clientIdPwd</code><code class="o">)</code>
        <code class="o">.</code><code class="na">contentType</code><code class="o">(</code><code class="s">"application/x-www-form-urlencoded; charset=UTF-8"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">urlEncodingEnabled</code><code class="o">(</code><code class="kc">true</code><code class="o">)</code>
        <code class="o">.</code><code class="na">formParam</code><code class="o">(</code><code class="s">"username"</code><code class="o">,</code> <code class="n">username</code><code class="o">)</code>
        <code class="o">.</code><code class="na">and</code><code class="o">()</code>
        <code class="o">.</code><code class="na">formParam</code><code class="o">(</code><code class="s">"password"</code><code class="o">,</code> <code class="n">password</code><code class="o">)</code>
        <code class="o">.</code><code class="na">and</code><code class="o">()</code>
        <code class="o">.</code><code class="na">formParam</code><code class="o">(</code><code class="s">"grant_type"</code><code class="o">,</code> <code class="s">"password"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">post</code><code class="o">(</code><code class="k">new</code> <code class="n">URI</code><code class="o">(</code><code class="n">url</code><code class="o">));</code>
    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">URISyntaxException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>
      <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>
    <code class="o">}</code>
  <code class="o">}</code>

  <code class="kd">private</code> <code class="kd">static</code> <code class="n">RequestSpecification</code> <code class="nf">prepareRequest</code><code class="o">(</code><code class="n">String</code> <code class="n">url</code><code class="o">)</code> <code class="o">{</code>
    <code class="kd">final</code> <code class="n">RequestSpecBuilder</code> <code class="n">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">RequestSpecBuilder</code><code class="o">();</code>
    <code class="kd">final</code> <code class="n">RequestSpecification</code> <code class="n">requestSpec</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="na">build</code><code class="o">();</code>
    <code class="k">return</code> <code class="n">RestAssured</code><code class="o">.</code><code class="na">given</code><code class="o">().</code><code class="na">spec</code><code class="o">(</code><code class="n">requestSpec</code><code class="o">);</code>
  <code class="o">}</code>
<code class="o">}</code></pre>

<p>The code is essentially an implementation of the next <code>curl</code> command but using REST-Assured:</p>

<pre data-type="programlisting">curl -X POST \
    http://localhost:8180/auth/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=alice&amp;password=alice&amp;grant_type=password'</pre>

<p>Now, when running the test, something completely different is shown than in <a data-type="xref" href="#authorization-with-microprofile-jwt">Recipe 11.3</a>.</p>

<p>First of all, the token (JWT token) is not static; it is issued by OpenID Connect (Keycloak) for the <code>alice</code> username.</p>

<p>The following is example of an issued token for <code>alice</code>:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code>
  <code class="nt">"alg"</code><code class="p">:</code> <code class="s2">"RS256"</code><code class="p">,</code>
  <code class="nt">"typ"</code><code class="p">:</code> <code class="s2">"JWT"</code><code class="p">,</code>
  <code class="nt">"kid"</code><code class="p">:</code> <code class="s2">"cfIADN_xxCJmVkWyN-PNXEEvMUWs2r68CxtmhEDNzXU"</code>
<code class="p">}</code><code class="err">,</code>
<code class="p">{</code>
  <code class="nt">"jti"</code><code class="p">:</code> <code class="s2">"cc54b9db-5f2f-4609-8a6b-4f76026e63ae"</code><code class="p">,</code>
  <code class="nt">"exp"</code><code class="p">:</code> <code class="mi">1578935775</code><code class="p">,</code>
  <code class="nt">"nbf"</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="nt">"iat"</code><code class="p">:</code> <code class="mi">1578935475</code><code class="p">,</code>
  <code class="nt">"iss"</code><code class="p">:</code> <code class="s2">"http://localhost:8180/auth/realms/quarkus"</code><code class="p">,</code>
  <code class="nt">"sub"</code><code class="p">:</code> <code class="s2">"eb4123a3-b722-4798-9af5-8957f823657a"</code><code class="p">,</code>
  <code class="nt">"typ"</code><code class="p">:</code> <code class="s2">"Bearer"</code><code class="p">,</code>
  <code class="nt">"azp"</code><code class="p">:</code> <code class="s2">"backend-service"</code><code class="p">,</code>
  <code class="nt">"auth_time"</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="nt">"session_state"</code><code class="p">:</code> <code class="s2">"5b674175-a2a9-4a45-a3da-394923125e55"</code><code class="p">,</code>
  <code class="nt">"acr"</code><code class="p">:</code> <code class="s2">"1"</code><code class="p">,</code>
  <code class="nt">"realm_access"</code><code class="p">:</code> <code class="p">{</code>
    <code class="nt">"roles"</code><code class="p">:</code> <code class="p">[</code>
      <code class="s2">"user"</code>
    <code class="p">]</code>
  <code class="p">},</code>
  <code class="nt">"scope"</code><code class="p">:</code> <code class="s2">"email profile"</code><code class="p">,</code>
  <code class="nt">"email_verified"</code><code class="p">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="nt">"preferred_username"</code><code class="p">:</code> <code class="s2">"alice"</code>
<code class="p">}</code></pre>

<p>Second, the OpenID Connect is responsible for providing everything to validate the token; the public key is not configured manually.</p>

<p>The following validations are performed by Keycloak when the token is provided:</p>

<ul>
<li>
<p>If a valid token is provided and the <code>roles</code> claim contains the <code>user</code> group, then the <code>preferred_username</code> is extracted.</p>
</li>
<li>
<p>If a valid token is provided and the <code>roles</code> claim does not contain the <code>user</code> group, then a 403 Forbidden error code is sent back to the caller.</p>
</li>
<li>
<p>If an invalid token is provided (expired, signature not valid, modified by third party, etc.), then a 403 Forbidden error code is sent back to the caller.</p>
</li>
<li>
<p>If no token is provided, then a 401 Unauthorized Error error code is sent back to the caller.</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128501813064">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="Keycloak" id="idm45128501298728"/><a data-type="indexterm" data-primary="OpenID Connect" data-secondary="website" id="idm45128501298024"/><a data-type="indexterm" data-primary="" data-startref="aa_open" id="idm45128501297080"/><a data-type="indexterm" data-primary="" data-startref="open_aa" id="idm45128501296136"/>To learn more about OpenId Connect protocol, see the following websites:</p>

<ul>
<li>
<p><a href="https://openid.net/connect">OpenID Connect</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org">Keycloak</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="11.5 Protecting Web Resources with OpenId Connect"><div class="sect1" id="idm45128501291496">
<h1>11.5 Protecting Web Resources with OpenId Connect</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128501290424">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="web resources, protecting with OpenID Connect" id="idm45128501289224"/><a data-type="indexterm" data-primary="authentication and authorization" data-secondary="protecting web resources with OpenID Connect" id="idm45128501288424"/><a data-type="indexterm" data-primary="OpenID Connect" data-secondary="protecting web resources with" id="idm45128501287432"/>You want to protect your web resources.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128501286088">
<h2>Solution</h2>

<p>Use OpenId Connect and file-based role definitions to protect web resources.</p>

<p>Web resources can be protected using OpenId Connect protocol and Quarkus.
The OpenId Connect extension enables authentication to web resources by implementing the well-known authorization code flow, where any unauthenticated user that is 
<span class="keep-together">trying</span> to access a protected resource is redirected to the OpenId Connect Provider 
<span class="keep-together">website</span> to authenticate. After the authentication process is completed, the user is sent back to the application.</p>

<p>Register the <code>quarkus-oidc</code> extension to protect resources with OpenId Connect:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-oidc"</code></pre>

<p>Configure the location of the OpenId Connect server to validate the token:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.oidc.auth-server-url</code><code class="o">=</code><code class="s">http://localhost:8180/auth/realms/quarkus </code><a class="co" id="co_authentication_and_authorization_CO16-1" href="#callout_authentication_and_authorization_CO16-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.oidc.client-id</code><code class="o">=</code><code class="s">frontend </code><a class="co" id="co_authentication_and_authorization_CO16-2" href="#callout_authentication_and_authorization_CO16-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.oidc.application-type</code><code class="o">=</code><code class="s">web-app </code><a class="co" id="co_authentication_and_authorization_CO16-3" href="#callout_authentication_and_authorization_CO16-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.http.auth.permission.authenticated.paths</code><code class="o">=</code><code class="s">/* </code><a class="co" id="co_authentication_and_authorization_CO16-4" href="#callout_authentication_and_authorization_CO16-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.http.auth.permission.authenticated.policy</code><code class="o">=</code><code class="s">authenticated</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_authentication_and_authorization_CO16-1" href="#co_authentication_and_authorization_CO16-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The base URL of the OpenID Connect server</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO16-2" href="#co_authentication_and_authorization_CO16-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Each application has a client ID used to identify the application</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO16-3" href="#co_authentication_and_authorization_CO16-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Enables OpenID Connect Authorization Code Flow</p></dd>
<dt><a class="co" id="callout_authentication_and_authorization_CO16-4" href="#co_authentication_and_authorization_CO16-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets permission to web resources</p></dd>
</dl>

<p>Start the application, open a browser, and enter the following URL: 
<span class="orm:hideurl"><a href="http://localhost:8080"><em class="hyperlink">http://localhost:8080</em></a></span>:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean compile quarkus:dev</code></pre>

<p>The default <em>index.html</em> page is not shown, but you are redirected to the authentication page of Keycloak.
Enter the following valid credentials (login: <strong><code>alice</code></strong>, password: <strong><code>alice</code></strong>) to gain access to the web resource.
After pushing the Login button, the page is redirected back to the login page.<a data-type="indexterm" data-primary="" data-startref="aa_ch" id="idm45128501058408"/></p>
</div></section>





</div></section>







</div></section></div>



  </body></html>