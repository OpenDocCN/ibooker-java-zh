<html><head></head><body><section data-pdf-bookmark="Chapter 7. Actions to Calculations" data-type="chapter" epub:type="chapter"><div class="chapter" id="actions-to-calculations">&#13;
<h1><span class="label">Chapter 7. </span>Actions to Calculations</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Neither Java nor Kotlin makes any formal distinction between imperative and functional code, although Kotlin’s emphasis on immutability and expressions generally leads to more functional programs.&#13;
Can we improve our code by making more of it functional?</p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Functions" data-type="sect1"><div class="sect1" id="functions">&#13;
<h1>Functions</h1>&#13;
&#13;
<p>As<a data-primary="actions to calculations" data-secondary="functions" data-type="indexterm" id="idm46393402049976"/><a data-primary="functions" data-secondary="defined" data-type="indexterm" id="idm46393402048968"/><a data-primary="subroutines" data-type="indexterm" id="idm46393402048024"/><a data-primary="procedures" data-type="indexterm" id="idm46393402047352"/><a data-primary="methods" data-type="indexterm" id="idm46393402046680"/> an industry, we have invented a lot of phrases to describe callable subprograms within a larger program.&#13;
We have the very generic <em>subroutine</em>.&#13;
Some languages (notably Pascal) distinguish between <em>functions</em> that return a result, and <em>procedures</em>, which don’t; but most developers use the terms interchangeably.&#13;
Then there are <em>methods</em>, which are subroutines associated with an object (or a class, in the case of static &#13;
<span class="keep-together">methods</span>).</p>&#13;
&#13;
<p>The<a data-primary="void type" data-type="indexterm" id="idm46393402043096"/> C language calls them all functions but has a special <code>void</code> type to represent the absence of a return value.&#13;
This was carried forward into Java.&#13;
Kotlin uses <code>Unit</code> in almost the same way, except that <code>Unit</code> is not the absence of a return value, but rather a singleton value that is returned instead.</p>&#13;
&#13;
<p>In this book we use the term <em>function</em> to refer to both result-returning and non-result-returning subroutines, whether freestanding or associated with an object.&#13;
Where it’s significant that they are associated with an object, we’ll call them as &#13;
<span class="keep-together">methods</span>.</p>&#13;
&#13;
<p>Whatever we call them, functions are one of the fundamental building blocks of our software.&#13;
We define them with some sort of notation, generally the programming language we are using.&#13;
They are also generally fixed during a run of the program; in static languages, at least, we don’t usually redefine functions on the fly.</p>&#13;
&#13;
<p class="pagebreak-before">This<a data-primary="variables" data-type="indexterm" id="idm46393402037480"/> is in contrast to the other fundamental building block: data.&#13;
We expect data to vary as we run our program, and different data is bound to variables.&#13;
Variables are called variables because they are, wait for it, variable.&#13;
Even when they are <code>final</code>, or <code>val</code>, they are usually bound to different data in different invocations of a function.</p>&#13;
&#13;
<p>We hinted earlier at a subdivision of functions into those that return a result and those that do not.&#13;
This might seem like a fundamental difference, but in practice there is a more useful way to divide functions: into <em>calculations</em> and <em>actions</em>.</p>&#13;
&#13;
<p>Actions are functions that depend on when or how many times they are run; calculations are functions that don’t—they are timeless.&#13;
Most functions that we write are actions, because we have to take special care to write code that doesn’t depend on when it is run.&#13;
How would we go about doing that?</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Calculations" data-type="sect1"><div class="sect1" id="calculations">&#13;
<h1>Calculations</h1>&#13;
&#13;
<p>To<a data-primary="functions" data-secondary="calculations" data-type="indexterm" id="idm46393402031112"/><a data-primary="calculations" data-secondary="defined" data-type="indexterm" id="idm46393402030104"/><a data-primary="actions to calculations" data-secondary="calculations defined" data-type="indexterm" id="idm46393402029160"/> be a calculation, a function must always return the same result given the same inputs.&#13;
The inputs to a function are its parameters, which are bound to arguments when the function is called.&#13;
So a calculation always returns the same result when called with the same arguments.</p>&#13;
&#13;
<p>Take a <code>fullName</code> function:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">fullName</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">Customer</code><code class="p">)</code> <code class="p">=</code> <code class="s">"${customer.givenName} ${customer.familyName}"</code></pre>&#13;
&#13;
<p><code>fullName</code> is a calculation: it will always return the same value when supplied the same <code>Customer</code>.&#13;
This is true only if <code>Customer</code> is immutable, or at least <code>givenName</code> and <code>familyName</code> cannot change.&#13;
To keep things simple, we’ll say that calculations can only have parameters that are values, as defined in <a data-type="xref" href="ch05.html#beans-to-values">Chapter 5</a>.</p>&#13;
&#13;
<p>Methods, and the disguised methods that are member properties, can also be &#13;
<span class="keep-together">calculations</span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Customer</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">givenName</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">familyName</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">upperCaseGivenName</code><code class="p">()</code> <code class="p">=</code> <code class="n">givenName</code><code class="p">.</code><code class="n">toUpperCase</code><code class="p">()</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">fullName</code> <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$givenName $familyName"</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>For<a data-primary="this keyword" data-type="indexterm" id="idm46393401965656"/> a method or extension, the receiver <code>this</code>, and any property accessed via <code>this</code>, is also an input.&#13;
So both <code>upperCaseGivenName</code> and <code>fullName</code> are calculations because <code>givenName</code> and <code>familyName</code> are both values.</p>&#13;
&#13;
<p class="pagebreak-before">An extension function or property can also be a calculation if the data it depends on is a value:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Customer</code><code class="p">.</code><code class="n">fullName</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$givenName $familyName"</code>&#13;
&#13;
<code class="k">val</code> <code class="py">Customer</code><code class="p">.</code><code class="n">fullName</code> <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$givenName $familyName"</code></pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393401913400">&#13;
<h5>Computed Property or Function?</h5>&#13;
<p>You<a data-primary="computed properties" data-type="indexterm" id="idm46393401906280"/><a data-primary="functions" data-secondary="versus computed properties" data-secondary-sortas="computed properties" data-type="indexterm" id="idm46393401905576"/> may have wondered when to define a computed property and when to have a function that returns a result.&#13;
Computed properties are confusing if they return different results at different times, at least when defined on value types (and you’ll be realizing by now that your authors think that most of our types should be value types).&#13;
So a good rule of thumb is to reserve computed properties for calculations.</p>&#13;
&#13;
<p>We expand on this topic in <a data-type="xref" href="ch11.html#methods-to-properties">Chapter 11</a>.</p>&#13;
</div></aside>&#13;
&#13;
<p>The result of a calculation may depend on data that is not passed as parameters, but only if that data does not change.&#13;
Otherwise, the function’s result would be different before and after the change, which would make it an action.&#13;
Even if a function always returns the same result for the same parameters, it may still be an action if it mutates something (either a parameter or an external resource such as a global variable or a database).&#13;
For example:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">println</code><code class="p">(</code><code class="s">"hello"</code><code class="p">)</code></pre>&#13;
&#13;
<p><code>println</code> always returns the same <code>Unit</code> result given the same <code>hello</code> input, but it is not a calculation.&#13;
It is an action.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Actions" data-type="sect1"><div class="sect1" id="actions">&#13;
<h1>Actions</h1>&#13;
&#13;
<p><code>println</code> is<a data-primary="println" data-type="indexterm" id="idm46393401872008"/><a data-primary="functions" data-secondary="actions" data-type="indexterm" id="idm46393401871272"/><a data-primary="actions to calculations" data-secondary="actions defined" data-type="indexterm" id="idm46393401870328"/> an action because it <em>does</em> depend on when and how many times it is run.&#13;
If we don’t call it, nothing is output, which is different from calling it once, which is different from calling it twice.&#13;
The order that we call <code>println</code> with different arguments also matters to the results we see on the console.</p>&#13;
&#13;
<p>We<a data-primary="side effects" data-type="indexterm" id="idm46393401866776"/><a data-primary="outside effects" data-type="indexterm" id="idm46393401866040"/> call <code>println</code> for its <em>side effect</em>—the effect it has on its environment.&#13;
Side effect is a bit of a misleading term because, unlike drug side effects, they are often exactly the thing that we want to happen.&#13;
Maybe <em>outside effect</em> would be a better name, to emphasize that they are external to a function’s parameters, local variables, and return value.&#13;
In any case, functions with observable side effects are actions not calculations.&#13;
Functions returning <code>void</code> or <code>Unit</code> are almost always actions, because if they do anything, they have to do it by side effect.</p>&#13;
&#13;
<p>As we saw previously, code that reads from external mutable state must also be an action (provided that anything does actually mutate the state).</p>&#13;
&#13;
<p>Let’s look at a <code>Customers</code> service:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Customers</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">save</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">CustomerData</code><code class="p">):</code> <code class="n">Customer</code> <code class="p">{</code>&#13;
        <code class="p">...</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">fun</code> <code class="nf">find</code><code class="p">(</code><code class="n">id</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Customer</code><code class="p">?</code> <code class="p">{</code>&#13;
        <code class="p">...</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Both <code>save</code> and <code>find</code> are actions; <code>save</code> creates a new customer record in our database and returns it.&#13;
This is an action because the state of our database depends on when we call it.&#13;
The result of <code>find</code> is also time sensitive, because it depends on previous calls to <code>save</code>.</p>&#13;
&#13;
<p>Functions that have no parameters (this doesn’t include methods or extension functions, which can have implicit parameters accessed via <code>this</code>) must either be returning a constant or be reading from some other source and so be categorized as actions.&#13;
Without looking at its source, we can deduce that a top-level function <code>requestRate</code> is almost certainly an action, reading from some global mutable state:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">requestRate</code><code class="p">():</code> <code class="n">Double</code> <code class="p">{</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If a function with the same apparent signature is defined as a method, it is probably a calculation that depends on properties of <code>Metrics</code> (provided <code>Metrics</code> is immutable):</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Metrics</code><code class="p">(</code>&#13;
   <code class="p">...</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">requestRate</code><code class="p">():</code> <code class="n">Double</code> <code class="p">{</code>&#13;
        <code class="p">...</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We say <em>probably</em> because in languages like Java or Kotlin that allow input, output, or accessing global mutable data from any code, there is no way to be sure whether a function represents a calculation or action short of examining it and all the functions that it calls.&#13;
We’ll return to that problem soon.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Why Should We Care?" data-type="sect1"><div class="sect1" id="idm46393401873560">&#13;
<h1>Why Should We Care?</h1>&#13;
&#13;
<p>We<a data-primary="actions to calculations" data-secondary="importance of each" data-type="indexterm" id="idm46393401711112"/><a data-primary="calculations" data-secondary="versus actions" data-secondary-sortas="actions" data-type="indexterm" id="idm46393401710104"/> should obviously pay special attention to some actions in our software.&#13;
Sending the same email to every user twice is a bug, as is not sending it at all.&#13;
We care exactly how many times it is sent.&#13;
We may even care that it is sent at exactly 8:07 a.m., so that our offer for a free first-class upgrade is at the top of our customer’s inbox when they read their email over breakfast.</p>&#13;
&#13;
<p>Other seemingly innocuous actions may be more nocuous than we think.&#13;
Changing the order of read and write actions causes concurrency bugs.&#13;
Error handling is much more complicated if the second of two sequential actions fails after the first succeeded.&#13;
Actions prevent us from having free rein to refactor our code, because doing so may change when or whether they are invoked.</p>&#13;
&#13;
<p>Calculations, on the other hand, can be invoked at any time, with no consequences for calling them again and again with the same arguments except a waste of time and energy.&#13;
If we are refactoring code and find that we don’t need the result of a calculation, we can safely not invoke it.&#13;
If it is an expensive calculation, we can safely cache its result; if it is inexpensive, we can safely recalculate it on demand if that simplifies things.&#13;
It is this feeling of safety that puts the smug smile on the faces of functional programmers (well, that and knowing that a monad is just a monoid in the category of endofunctors).&#13;
Those<a data-primary="referential transparency" data-type="indexterm" id="idm46393401706520"/> functional programmers also have a term for the property of a function that makes it a calculation: <em>referential transparency</em>.&#13;
If a function is referentially transparent, we can replace its call with its result, and we can only do that if it doesn’t matter when or if we call it.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393401704920">&#13;
<h5>Procedural Code</h5>&#13;
<p>Nat and Duncan are both old enough to have learned to program in Sinclair BASIC on the ZX81.&#13;
This dialect had no immutable data, and no support for subroutines, parameters, or local variables.&#13;
It requires real discipline to program in such a system, because practically every line of code is an action and so potentially affects the functioning of every other statement.</p>&#13;
&#13;
<p>This is in fact very close to the way that our computers actually work, with mutable values held in registers and global memory, manipulated by machine-code actions.&#13;
The evolution of programming languages has been a process of restricting the ultimate flexibility of this model, so that humans can better reason with the code that they create.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Why Prefer Calculations?" data-type="sect1"><div class="sect1" id="idm46393401702216">&#13;
<h1>Why Prefer Calculations?</h1>&#13;
&#13;
<p>We<a data-primary="actions to calculations" data-secondary="benefits of calculations" data-type="indexterm" id="idm46393401701032"/><a data-primary="calculations" data-secondary="benefits of" data-type="indexterm" id="idm46393401700056"/> like calculations because they are so much easier to work with, but ultimately our software needs to have an effect on the world, which is an action.&#13;
There is no overlap though; code can’t be an action and a calculation, both timeless and time-dependent.&#13;
If we take some code that is a calculation and have it invoke an action, then it becomes an action, because it will now depend on when or whether it is called.&#13;
We can think of calculations as the purer code, where code inherits the most tainted level of all of its dependencies.&#13;
We see the same thing with susceptibility to errors in <a data-type="xref" href="ch19.html#throwing-to-returning">Chapter 19</a>.&#13;
If we value purity (which in all these cases brings ease of reasoning and refactoring), we must strive to pull the boundary between impure and pure code to the outer layers of our system—those closest to the entry points.&#13;
If we succeed, then a significant proportion of our code can be calculations and, hence, easily tested, reasoned with, and refactored.</p>&#13;
&#13;
<p>What if we don’t succeed in keeping actions at the bottom of our call stack?&#13;
Then we can fix things with refactoring!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring Actions to Calculations" data-type="sect1"><div class="sect1" id="idm46393401696424">&#13;
<h1>Refactoring Actions to Calculations</h1>&#13;
&#13;
<p>Let’s<a data-primary="calculations" data-secondary="refactoring actions to calculations" data-type="indexterm" id="Cref07"/><a data-primary="actions to calculations" data-secondary="refactoring actions to calculations" data-type="indexterm" id="ACref07"/><a data-primary="refactoring" data-secondary="actions to calculations" data-type="indexterm" id="Ractcalc07"/> have a look at recognizing and refactoring actions in existing code.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Existing Code" data-type="sect2"><div class="sect2" id="idm46393401690936">&#13;
<h2>Existing Code</h2>&#13;
&#13;
<p>There is an HTTP endpoint in Travelator that allows the client app to fetch information about the customer’s current trip:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CurrentTripsHandler</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">ITrackTrips</code> <code class="n">tracking</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">ObjectMapper</code> <code class="n">objectMapper</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ObjectMapper</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">CurrentTripsHandler</code><code class="o">(</code><code class="n">ITrackTrips</code> <code class="n">tracking</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">tracking</code> <code class="o">=</code> <code class="n">tracking</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">Response</code> <code class="nf">handle</code><code class="o">(</code><code class="n">Request</code> <code class="n">request</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">var</code> <code class="n">customerId</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="na">getQueryParam</code><code class="o">(</code><code class="s">"customerId"</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
                <code class="o">.</code><code class="na">findFirst</code><code class="o">();</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">())</code>&#13;
                <code class="k">return</code> <code class="k">new</code> <code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_BAD_REQUEST</code><code class="o">);</code>&#13;
            <code class="n">var</code> <code class="n">currentTrip</code> <code class="o">=</code> <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">get</code><code class="o">());</code>&#13;
            <code class="k">return</code> <code class="n">currentTrip</code><code class="o">.</code><code class="na">isPresent</code><code class="o">()</code> <code class="o">?</code>&#13;
                <code class="k">new</code> <code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_OK</code><code class="o">,</code>&#13;
                    <code class="n">objectMapper</code><code class="o">.</code><code class="na">writeValueAsString</code><code class="o">(</code><code class="n">currentTrip</code><code class="o">))</code> <code class="o">:</code>&#13;
                <code class="k">new</code> <code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_NOT_FOUND</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">x</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_INTERNAL_ERROR</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.1&amp;show=file">Example 7.1 [actions.0:src/main/java/travelator/handlers/CurrentTripsHandler.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Actions are code that is sensitive to time, so words like <em>current</em> in <code>CurrentTripsHandler</code> are a dead giveaway.&#13;
The <code>handle</code> method is an action, and that’s OK: things on the edge of our systems often are.</p>&#13;
&#13;
<p>The handler delegates to some business logic, implemented in <code>Tracking</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Tracking</code> <code class="kd">implements</code> <code class="n">ITrackTrips</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Trips</code> <code class="n">trips</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Tracking</code><code class="o">(</code><code class="n">Trips</code> <code class="n">trips</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">trips</code> <code class="o">=</code> <code class="n">trips</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="n">Optional</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">candidates</code> <code class="o">=</code> <code class="n">trips</code><code class="o">.</code><code class="na">currentTripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">filter</code><code class="o">((</code><code class="n">trip</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">trip</code><code class="o">.</code><code class="na">getBookingStatus</code><code class="o">()</code> <code class="o">==</code> <code class="n">BOOKED</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toList</code><code class="o">());</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">candidates</code><code class="o">.</code><code class="na">size</code><code class="o">()</code> <code class="o">==</code> <code class="mi">1</code><code class="o">)</code>&#13;
            <code class="k">return</code> <code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">candidates</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">));</code>&#13;
        <code class="k">else</code> <code class="nf">if</code> <code class="o">(</code><code class="n">candidates</code><code class="o">.</code><code class="na">size</code><code class="o">()</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code>&#13;
            <code class="k">return</code> <code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">();</code>&#13;
        <code class="k">else</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalStateException</code><code class="o">(</code>&#13;
                <code class="s">"Unexpectedly more than one current trip for "</code> <code class="o">+</code> <code class="n">customerId</code>&#13;
            <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.2&amp;show=file">Example 7.2 [actions.0:src/main/java/travelator/Tracking.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Using the <em>current</em> rule, <code>Tracking.currentTripFor</code> is evidently an action too, as is <code>Trips.currentTripsFor</code>.&#13;
Here is its implementation in <code>InMemoryTrips</code>, which is used for testing in place of a version implemented with database queries:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">InMemoryTrips</code> <code class="kd">implements</code> <code class="n">Trips</code> <code class="o">{</code>&#13;
&#13;
    <code class="o">...</code>&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="nf">tripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">trip</code> <code class="o">-&gt;</code> <code class="n">trip</code><code class="o">.</code><code class="na">isPlannedToBeActiveAt</code><code class="o">(</code><code class="n">clock</code><code class="o">.</code><code class="na">instant</code><code class="o">()))</code>&#13;
            <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toSet</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.3&amp;show=file">Example 7.3 [actions.0:src/test/java/travelator/InMemoryTrips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The conversions from <code>Set&lt;Trip&gt;</code> (the result of <code>Trips.currentTripsFor</code>) and to <code>Optional&lt;Trip&gt;</code> (returned from <code>Tracking.currentTripFor</code>) seem to be because there is some business rule around there being only one active trip at any time—a rule that is not enforced in the persistence layer.</p>&#13;
&#13;
<p>Until we got here, we were relying on our knowledge of the meanings of words (in particular <em>current</em>) to deduce that Java methods represent actions rather than calculations.&#13;
Here, though, there is a smoking gun.&#13;
Can you spot it?</p>&#13;
&#13;
<p>Yes: <code>clock.instant()</code>.&#13;
That definitely depends on when we call it.&#13;
(If you found another action, well done, but keep it to yourself for now.&#13;
We’ll come back to it.)</p>&#13;
&#13;
<p>Even if we chose not go on with the rest of this refactoring, there is one change that we should make now.&#13;
We have discussed calculations and actions as applying to named blocks of code, but they also apply at the expression level.&#13;
Once you start to differentiate actions from calculations, it makes sense not to throw a random action into an otherwise pure calculation.&#13;
Let’s pull the action out so that the remainder of the expression is pure: select <code>clock.instant()</code> and “Introduce Variable”, calling it <code>now</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Override</code>&#13;
<code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="nf">tripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">trip</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
            <code class="n">Instant</code> <code class="n">now</code> <code class="o">=</code> <code class="n">clock</code><code class="o">.</code><code class="na">instant</code><code class="o">();</code>&#13;
            <code class="k">return</code> <code class="n">trip</code><code class="o">.</code><code class="na">isPlannedToBeActiveAt</code><code class="o">(</code><code class="n">now</code><code class="o">);</code>&#13;
        <code class="o">})</code>&#13;
        <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toSet</code><code class="o">());</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.4&amp;show=file">Example 7.4 [actions.1:src/test/java/travelator/InMemoryTrips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That’s still in the middle of the expression, so let’s move it up (and convert to a <code>var</code> on the way):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Override</code>&#13;
<code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">now</code> <code class="o">=</code> <code class="n">clock</code><code class="o">.</code><code class="na">instant</code><code class="o">();</code>&#13;
    <code class="k">return</code> <code class="nf">tripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
        <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">trip</code> <code class="o">-&gt;</code> <code class="n">trip</code><code class="o">.</code><code class="na">isPlannedToBeActiveAt</code><code class="o">(</code><code class="n">now</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toSet</code><code class="o">());</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.5&amp;show=file">Example 7.5 [actions.2:src/test/java/travelator/InMemoryTrips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This simple act has allowed us to realize that we were previously comparing every trip against a slightly different time!&#13;
Was that a problem?&#13;
Probably not here, but you may have worked on systems where it would be.&#13;
Duncan, for one, has recently finished diagnosing an issue where half of a banking transaction could be accounted for in one day, and the other half in the next.</p>&#13;
&#13;
<p>As well as making it harder to refactor our code, actions make it harder to test too.&#13;
Let’s see how that is manifested:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">TrackingTests</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">final</code> <code class="n">StoppedClock</code> <code class="n">clock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StoppedClock</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">final</code> <code class="n">InMemoryTrips</code> <code class="n">trips</code> <code class="o">=</code> <code class="k">new</code> <code class="n">InMemoryTrips</code><code class="o">(</code><code class="n">clock</code><code class="o">);</code>&#13;
    <code class="kd">final</code> <code class="n">Tracking</code> <code class="n">tracking</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Tracking</code><code class="o">(</code><code class="n">trips</code><code class="o">);</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_empty_when_no_trip_planned_to_happen_now</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">clock</code><code class="o">.</code><code class="na">now</code> <code class="o">=</code> <code class="n">anInstant</code><code class="o">();</code>&#13;
        <code class="n">assertEquals</code><code class="o">(</code>&#13;
            <code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">(),</code>&#13;
            <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"aCustomer"</code><code class="o">)</code>&#13;
        <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_single_active_booked_trip</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">diwaliTrip</code> <code class="o">=</code> <code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="s">"Diwali"</code><code class="o">,</code>&#13;
            <code class="s">"2020-11-13"</code><code class="o">,</code> <code class="s">"2020-11-15"</code><code class="o">,</code> <code class="n">BOOKED</code><code class="o">);</code>&#13;
        <code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="s">"Christmas"</code><code class="o">,</code>&#13;
            <code class="s">"2020-12-24"</code><code class="o">,</code> <code class="s">"2020-11-26"</code><code class="o">,</code> <code class="n">BOOKED</code><code class="o">);</code>&#13;
&#13;
        <code class="n">clock</code><code class="o">.</code><code class="na">now</code> <code class="o">=</code> <code class="n">diwaliTrip</code><code class="o">.</code><code class="na">getPlannedStartTime</code><code class="o">().</code><code class="na">toInstant</code><code class="o">();</code>&#13;
        <code class="n">assertEquals</code><code class="o">(</code>&#13;
            <code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">diwaliTrip</code><code class="o">),</code>&#13;
            <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">)</code>&#13;
        <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.6&amp;show=file">Example 7.6 [actions.0:src/test/java/travelator/TrackingTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>To give predictable results, we have had to use a fake clock, injected into <code>InMemoryTrips</code>.&#13;
Having previously said that <code>clock.instant()</code> depends on when we call it; in our tests it doesn’t (at least, not in the same way).&#13;
We could instead have set up trips relative to the time that the tests are being run, but this would make our tests harder to understand, and subject to failure if you run them around midnight.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393400919320">&#13;
<h5>2015 Was the End of Time</h5>&#13;
<p>Duncan and Nat returned to work after the Christmas holidays at the beginning of 2015 to find a slew of previously passing unit tests now failing.&#13;
It turns out that 2015-01-01T00:00:00 had been used as a time that would always be in the future.&#13;
When 2015 arrived, all the tests that relied on before and after relationships began failing.</p>&#13;
&#13;
<p>They fixed the tests with the refactoring in this chapter.</p>&#13;
</div></aside>&#13;
&#13;
<p>Is having to inject a clock <a href="https://oreil.ly/YZx1T">test-induced design damage</a>?&#13;
In this case it is.&#13;
The fake clock has allowed us to solve a testing problem, but at the expense of making the code more complicated.&#13;
It has also allowed us to avoid a rethink that might lead to…</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Better Design" data-type="sect2"><div class="sect2" id="idm46393401670840">&#13;
<h2>A Better Design</h2>&#13;
&#13;
<p>What would a better design look like here?</p>&#13;
&#13;
<p>To make this code less time dependant, we can supply the time as an argument to the method.&#13;
Although this forces the <em>caller</em> to know the time, it is as easy for our caller to ask the time as it is for this method.&#13;
This is a special case of the way that we refactor to avoid dependencies on other global state; instead of reading a value within a function, we pass the value into it.</p>&#13;
&#13;
<p>The function we want to pass the time into overrides <code>Trips.currentTripsFor</code>, so we start by adding an <code>Instant</code> parameter to that.&#13;
Before, this was:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">Trips</code> <code class="o">{</code>&#13;
    <code class="o">...</code>&#13;
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.7&amp;show=file">Example 7.7 [actions.0:src/main/java/travelator/Trips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We<a data-primary="IntelliJ IDE" data-secondary="Change Signature refactoring" data-type="indexterm" id="idm46393400844616"/> use IntelliJ’s “Change Signature” refactoring to add the parameter, calling it <code>at</code>.&#13;
When we add a parameter, we need to tell IntelliJ what value it should use when updating the callers of our function.&#13;
Because we aren’t using the value in the method yet (and this is Java), we should be able to use <code>null</code> without breaking anything.&#13;
Running the tests shows that we are right—they still pass.</p>&#13;
&#13;
<p><code>Trips</code> now looks like this:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">Trips</code> <code class="o">{</code>&#13;
    <code class="o">...</code>&#13;
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">,</code> <code class="n">Instant</code> <code class="n">at</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.8&amp;show=file">Example 7.8 [actions.3:src/main/java/travelator/Trips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Here is the method being called:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code><code> </code><code class="nc">Tracking</code><code> </code><code class="kd">implements</code><code> </code><code class="n">ITrackTrips</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="nd">@Override</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Optional</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code><code> </code><code class="nf">currentTripFor</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">customerId</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">candidates</code><code> </code><code class="o">=</code><code> </code><code class="n">trips</code><code class="o">.</code><code class="na">currentTripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO9-1" id="co_introduction_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>            </code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="o">(</code><code class="n">trip</code><code class="o">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">trip</code><code class="o">.</code><code class="na">getBookingStatus</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="n">BOOKED</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toList</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">candidates</code><code class="o">.</code><code class="na">size</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="mi">1</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">candidates</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="mi">0</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">else</code><code> </code><code class="nf">if</code><code> </code><code class="o">(</code><code class="n">candidates</code><code class="o">.</code><code class="na">size</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="mi">0</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">else</code><code>&#13;
</code><code>            </code><code class="k">throw</code><code> </code><code class="k">new</code><code> </code><code class="nf">IllegalStateException</code><code class="o">(</code><code>&#13;
</code><code>                </code><code class="s">"Unexpectedly more than one current trip for "</code><code> </code><code class="o">+</code><code> </code><code class="n">customerId</code><code>&#13;
</code><code>            </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.9&amp;show=file">Example 7.9 [actions.3:src/main/java/travelator/Tracking.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO9-1" id="callout_introduction_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>IntelliJ introduced <code>null</code> as the argument value</p></dd>&#13;
</dl>&#13;
&#13;
<p>Remember that we aren’t using the value of the time in our implementations of <code>Trips</code> yet; we’re just trying to supply it on the outside of our system to convert as much code as possible to calculations.&#13;
<code>Tracking</code> isn’t the outside of our interaction, so we select the <code>null</code> <code>Instant</code> and “Introduce Parameter” to add it to the signature of <code>Tracking.​cur⁠rentTripFor</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Override</code><code>&#13;
</code><code class="kd">public</code><code> </code><code class="n">Optional</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code><code> </code><code class="nf">currentTripFor</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">customerId</code><code class="o">,</code><code> </code><code class="n">Instant</code><code> </code><code class="n">at</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="#callout_introduction_CO10-1" id="co_introduction_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">var</code><code> </code><code class="n">candidates</code><code> </code><code class="o">=</code><code> </code><code class="n">trips</code><code class="o">.</code><code class="na">currentTripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">,</code><code> </code><code class="n">at</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO10-1" id="co_introduction_CO10-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>&#13;
</code><code>        </code><code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="o">(</code><code class="n">trip</code><code class="o">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">trip</code><code class="o">.</code><code class="na">getBookingStatus</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="n">BOOKED</code><code class="o">)</code><code>&#13;
</code><code>        </code><code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toList</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.10&amp;show=file">Example 7.10 [actions.4:src/main/java/travelator/Tracking.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO10-1" id="callout_introduction_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Our new <code>Instant</code> parameter</p></dd>&#13;
</dl>&#13;
&#13;
<p>When we “Introduce Parameter”, IntelliJ moves the expression (<code>null</code> in this case) from the body of the method to the callers, so <code>CurrentTripsHandler</code> still compiles:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="n">Response</code><code> </code><code class="nf">handle</code><code class="o">(</code><code class="n">Request</code><code> </code><code class="n">request</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="k">try</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">customerId</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="na">getQueryParam</code><code class="o">(</code><code class="s">"customerId"</code><code class="o">)</code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="o">.</code><code class="na">findFirst</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_BAD_REQUEST</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">currentTrip</code><code> </code><code class="o">=</code><code> </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" href="#callout_introduction_CO11-1" id="co_introduction_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">currentTrip</code><code class="o">.</code><code class="na">isPresent</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">?</code><code>&#13;
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_OK</code><code class="o">,</code><code>&#13;
</code><code>                </code><code class="n">objectMapper</code><code class="o">.</code><code class="na">writeValueAsString</code><code class="o">(</code><code class="n">currentTrip</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">:</code><code>&#13;
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_NOT_FOUND</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">Exception</code><code> </code><code class="n">x</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_INTERNAL_ERROR</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.11&amp;show=file">Example 7.11 [actions.4:src/main/java/travelator/handlers/CurrentTripsHandler.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO11-1" id="callout_introduction_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>null</code> argument value</p></dd>&#13;
</dl>&#13;
&#13;
<p><code>TrackingTests</code> is similarly fixed up:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code><code>&#13;
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">returns_empty_when_no_trip_planned_to_happen_now</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="n">clock</code><code class="o">.</code><code class="na">now</code><code> </code><code class="o">=</code><code> </code><code class="n">anInstant</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">assertEquals</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO12-1" id="co_introduction_CO12-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@Test</code><code>&#13;
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">returns_single_active_booked_trip</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="n">var</code><code> </code><code class="n">diwaliTrip</code><code> </code><code class="o">=</code><code> </code><code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="s">"Diwali"</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="s">"2020-11-13"</code><code class="o">,</code><code> </code><code class="s">"2020-11-15"</code><code class="o">,</code><code> </code><code class="n">BOOKED</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="s">"Christmas"</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="s">"2020-12-24"</code><code class="o">,</code><code> </code><code class="s">"2020-11-26"</code><code class="o">,</code><code> </code><code class="n">BOOKED</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="n">clock</code><code class="o">.</code><code class="na">now</code><code> </code><code class="o">=</code><code> </code><code class="n">diwaliTrip</code><code class="o">.</code><code class="na">getPlannedStartTime</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">toInstant</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">assertEquals</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">diwaliTrip</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO12-1" id="co_introduction_CO12-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.12&amp;show=file">Example 7.12 [actions.4:src/test/java/travelator/TrackingTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO12-1" id="callout_introduction_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>null</code> argument value</p></dd>&#13;
</dl>&#13;
&#13;
<p>At this point everything compiles and passes the tests, but we aren’t actually using the (<code>null</code>) time that we are passing down from our handler.&#13;
Let’s fix that in <code>InMemoryTrips</code>, where we started.&#13;
We did have:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">InMemoryTrips</code> <code class="kd">implements</code> <code class="n">Trips</code> <code class="o">{</code>&#13;
&#13;
    <code class="o">...</code>&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">,</code> <code class="n">Instant</code> <code class="n">at</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">now</code> <code class="o">=</code> <code class="n">clock</code><code class="o">.</code><code class="na">instant</code><code class="o">();</code>&#13;
        <code class="k">return</code> <code class="nf">tripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">trip</code> <code class="o">-&gt;</code> <code class="n">trip</code><code class="o">.</code><code class="na">isPlannedToBeActiveAt</code><code class="o">(</code><code class="n">now</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toSet</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.13&amp;show=file">Example 7.13 [actions.4:src/test/java/travelator/InMemoryTrips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that we have the time as a parameter, we can use that rather than asking the <code>clock</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">InMemoryTrips</code> <code class="kd">implements</code> <code class="n">Trips</code> <code class="o">{</code>&#13;
&#13;
    <code class="o">...</code>&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">Trip</code><code class="o">&gt;</code> <code class="nf">currentTripsFor</code><code class="o">(</code><code class="n">String</code> <code class="n">customerId</code><code class="o">,</code> <code class="n">Instant</code> <code class="n">at</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="nf">tripsFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">).</code><code class="na">stream</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">trip</code> <code class="o">-&gt;</code> <code class="n">trip</code><code class="o">.</code><code class="na">isPlannedToBeActiveAt</code><code class="o">(</code><code class="n">at</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toSet</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.14&amp;show=file">Example 7.14 [actions.5:src/test/java/travelator/InMemoryTrips.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This causes the tests that use <code>InMemoryTrips</code> to fail with a <code>NullPointerException</code>, because the method is now using the value of the parameter, and the tests are passing in <code>null</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code><code>&#13;
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">returns_empty_when_no_trip_planned_to_happen_now</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="n">clock</code><code class="o">.</code><code class="na">now</code><code> </code><code class="o">=</code><code> </code><code class="n">anInstant</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">assertEquals</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO13-1" id="co_introduction_CO13-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@Test</code><code>&#13;
</code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">returns_single_active_booked_trip</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="n">var</code><code> </code><code class="n">diwaliTrip</code><code> </code><code class="o">=</code><code> </code><code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="s">"Diwali"</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="s">"2020-11-13"</code><code class="o">,</code><code> </code><code class="s">"2020-11-15"</code><code class="o">,</code><code> </code><code class="n">BOOKED</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="s">"Christmas"</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="s">"2020-12-24"</code><code class="o">,</code><code> </code><code class="s">"2020-11-26"</code><code class="o">,</code><code> </code><code class="n">BOOKED</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="n">clock</code><code class="o">.</code><code class="na">now</code><code> </code><code class="o">=</code><code> </code><code class="n">diwaliTrip</code><code class="o">.</code><code class="na">getPlannedStartTime</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">toInstant</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">assertEquals</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">diwaliTrip</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO13-1" id="co_introduction_CO13-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.15&amp;show=file">Example 7.15 [actions.5:src/test/java/travelator/TrackingTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO13-1" id="callout_introduction_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>These <code>nulls</code> are now being dereferenced inside <code>InMemoryTrips</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Instead of <code>null</code>, we need to pass the value that the tests were setting into the <code>clock</code>.&#13;
A cunning refactor is to replace the <code>null</code>s with <code>clock.now</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_empty_when_no_trip_planned_to_happen_now</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">clock</code><code class="o">.</code><code class="na">now</code> <code class="o">=</code> <code class="n">anInstant</code><code class="o">();</code>&#13;
    <code class="n">assertEquals</code><code class="o">(</code>&#13;
        <code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">(),</code>&#13;
        <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="n">clock</code><code class="o">.</code><code class="na">now</code><code class="o">)</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_single_active_booked_trip</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">var</code> <code class="n">diwaliTrip</code> <code class="o">=</code> <code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="s">"Diwali"</code><code class="o">,</code>&#13;
        <code class="s">"2020-11-13"</code><code class="o">,</code> <code class="s">"2020-11-15"</code><code class="o">,</code> <code class="n">BOOKED</code><code class="o">);</code>&#13;
    <code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="s">"Christmas"</code><code class="o">,</code>&#13;
        <code class="s">"2020-12-24"</code><code class="o">,</code> <code class="s">"2020-11-26"</code><code class="o">,</code> <code class="n">BOOKED</code><code class="o">);</code>&#13;
&#13;
    <code class="n">clock</code><code class="o">.</code><code class="na">now</code> <code class="o">=</code> <code class="n">diwaliTrip</code><code class="o">.</code><code class="na">getPlannedStartTime</code><code class="o">().</code><code class="na">toInstant</code><code class="o">();</code>&#13;
    <code class="n">assertEquals</code><code class="o">(</code>&#13;
        <code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">diwaliTrip</code><code class="o">),</code>&#13;
        <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="n">clock</code><code class="o">.</code><code class="na">now</code><code class="o">)</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.16&amp;show=file">Example 7.16 [actions.6:src/test/java/travelator/TrackingTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This gets our tests to pass, because we are now passing the correct time as the argument, albeit via setting and immediately reading a field in the <code>StoppedClock</code>.&#13;
To fix that, we replace the <code>clock.now</code> reads with the values from the <code>clock.now</code> writes.&#13;
Then the <code>clock</code> is unused, and we can delete it:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">TrackingTests</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">final</code> <code class="n">InMemoryTrips</code> <code class="n">trips</code> <code class="o">=</code> <code class="k">new</code> <code class="n">InMemoryTrips</code><code class="o">();</code>&#13;
    <code class="kd">final</code> <code class="n">Tracking</code> <code class="n">tracking</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Tracking</code><code class="o">(</code><code class="n">trips</code><code class="o">);</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_empty_when_no_trip_planned_to_happen_now</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">assertEquals</code><code class="o">(</code>&#13;
            <code class="n">Optional</code><code class="o">.</code><code class="na">empty</code><code class="o">(),</code>&#13;
            <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="n">anInstant</code><code class="o">())</code>&#13;
        <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_single_active_booked_trip</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">diwaliTrip</code> <code class="o">=</code> <code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="s">"Diwali"</code><code class="o">,</code>&#13;
            <code class="s">"2020-11-13"</code><code class="o">,</code> <code class="s">"2020-11-15"</code><code class="o">,</code> <code class="n">BOOKED</code><code class="o">);</code>&#13;
        <code class="n">givenATrip</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code> <code class="s">"Christmas"</code><code class="o">,</code>&#13;
            <code class="s">"2020-12-24"</code><code class="o">,</code> <code class="s">"2020-11-26"</code><code class="o">,</code> <code class="n">BOOKED</code><code class="o">);</code>&#13;
&#13;
        <code class="n">assertEquals</code><code class="o">(</code>&#13;
            <code class="n">Optional</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">diwaliTrip</code><code class="o">),</code>&#13;
            <code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="s">"cust1"</code><code class="o">,</code>&#13;
                <code class="n">diwaliTrip</code><code class="o">.</code><code class="na">getPlannedStartTime</code><code class="o">().</code><code class="na">toInstant</code><code class="o">())</code>&#13;
        <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.17&amp;show=file">Example 7.17 [actions.8:src/test/java/travelator/TrackingTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is a pattern we often see as we refactor toward more functional code.&#13;
As we reduce the scope of actions, our tests become simpler, because they can express more of their variation in parameters rather than preparing test state.&#13;
We’ll see this again in <a data-type="xref" href="ch17.html#mocks-to-maps">Chapter 17</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="End Game" data-type="sect2"><div class="sect2" id="idm46393400914264">&#13;
<h2>End Game</h2>&#13;
&#13;
<p>We’re almost done now. (Refactoring is never completely done.)</p>&#13;
&#13;
<p>With all this focus on the tests, we were about to check in before we realized that we haven’t completed our refactor in <code>CurrentTripsHandler</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="n">Response</code><code> </code><code class="nf">handle</code><code class="o">(</code><code class="n">Request</code><code> </code><code class="n">request</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="k">try</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">customerId</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="na">getQueryParam</code><code class="o">(</code><code class="s">"customerId"</code><code class="o">)</code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="o">.</code><code class="na">findFirst</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_BAD_REQUEST</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">currentTrip</code><code> </code><code class="o">=</code><code> </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" href="#callout_introduction_CO14-1" id="co_introduction_CO14-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">currentTrip</code><code class="o">.</code><code class="na">isPresent</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">?</code><code>&#13;
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_OK</code><code class="o">,</code><code>&#13;
</code><code>                </code><code class="n">objectMapper</code><code class="o">.</code><code class="na">writeValueAsString</code><code class="o">(</code><code class="n">currentTrip</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">:</code><code>&#13;
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_NOT_FOUND</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">Exception</code><code> </code><code class="n">x</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_INTERNAL_ERROR</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.18&amp;show=file">Example 7.18 [actions.8:src/main/java/travelator/handlers/CurrentTripsHandler.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO14-1" id="callout_introduction_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>We’re still passing <code>null</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>Now that neither of our <code>currentTripFor</code> methods fetch the time, <code>CurrentTripHandler</code> is the only action—the place that we need to call <code>Instant.now()</code>.&#13;
We can fix things by inserting the call, leaving us with:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">CurrentTripsHandler</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">final</code><code> </code><code class="n">ITrackTrips</code><code> </code><code class="n">tracking</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">final</code><code> </code><code class="n">ObjectMapper</code><code> </code><code class="n">objectMapper</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ObjectMapper</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">CurrentTripsHandler</code><code class="o">(</code><code class="n">ITrackTrips</code><code> </code><code class="n">tracking</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">tracking</code><code> </code><code class="o">=</code><code> </code><code class="n">tracking</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Response</code><code> </code><code class="nf">handle</code><code class="o">(</code><code class="n">Request</code><code> </code><code class="n">request</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">try</code><code> </code><code class="o">{</code><code>&#13;
</code><code>            </code><code class="n">var</code><code> </code><code class="n">customerId</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="na">getQueryParam</code><code class="o">(</code><code class="s">"customerId"</code><code class="o">)</code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="o">)</code><code>&#13;
</code><code>                </code><code class="o">.</code><code class="na">findFirst</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">customerId</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code>&#13;
</code><code>                </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_BAD_REQUEST</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="n">var</code><code> </code><code class="n">currentTrip</code><code> </code><code class="o">=</code><code> </code><code class="n">tracking</code><code class="o">.</code><code class="na">currentTripFor</code><code class="o">(</code><code>&#13;
</code><code>                </code><code class="n">customerId</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>                </code><code class="n">Instant</code><code class="o">.</code><code class="na">now</code><code class="o">(</code><code class="o">)</code><code> </code><a class="co" href="#callout_introduction_CO15-1" id="co_introduction_CO15-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>            </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="n">currentTrip</code><code class="o">.</code><code class="na">isPresent</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">?</code><code>&#13;
</code><code>                </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_OK</code><code class="o">,</code><code>&#13;
</code><code>                    </code><code class="n">objectMapper</code><code class="o">.</code><code class="na">writeValueAsString</code><code class="o">(</code><code class="n">currentTrip</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">:</code><code>&#13;
</code><code>                </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_NOT_FOUND</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="o">}</code><code> </code><code class="k">catch</code><code> </code><code class="o">(</code><code class="n">Exception</code><code> </code><code class="n">x</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">Response</code><code class="o">(</code><code class="n">HTTP_INTERNAL_ERROR</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="o">}</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.19&amp;show=file">Example 7.19 [actions.9:src/main/java/travelator/handlers/CurrentTripsHandler.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO15-1" id="callout_introduction_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Now our action is at the application entry point.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Looking through our code, we find (scream) that we don’t have any unit tests for the handler.&#13;
If we want to add them, this is the level at which we would now inject a <code>Clock</code>, rather than into the individual services.&#13;
Mocks or stubs allow us to test actions, but are rarely required to test calculations.</p>&#13;
&#13;
<p>We won’t show it, but we also have to consider the production implementation of <code>Trips</code>, the one that reads from our database.&#13;
We are lucky and find that this passes the current time into its SQL query, so now we can just use the value of the <code>at</code> parameter in <code>Trips.currentTripsFor(String customerId, Instant at)</code> instead.&#13;
It would have been more complicated if the SQL query was using the current time of the database server from a database-specific expression such as <code>CURRENT_TIMESTAMP</code> or <code>NOW</code>.&#13;
As with non-SQL code, actions are so pervasive that this is a common practice even though it makes testing more complicated and the code itself less versatile.&#13;
If our query had used the database time, we would have to rewrite it to receive the time from our function as a parameter, and make a mental note not to make the same mistake again.</p>&#13;
&#13;
<p>With that done, we review our changes and find that we haven’t converted any code to Kotlin!</p>&#13;
&#13;
<p>This is significant.&#13;
This way of thinking about calculations and actions doesn’t depend on our implementation language, and the grain of Java is becoming more functional with time.&#13;
We find, though, that Kotlin’s more natural support for immutable data and other functional constructs means that the costs of making the distinction are lower, and so the cost/benefit ratio looks more favorable.&#13;
Note also that a lot of the refactoring steps taken in this chapter (and others) are safe only because we are moving around the invocation of calculations and not actions.</p>&#13;
&#13;
<p>Before we finish this chapter, what about the other action we hinted at?&#13;
Here is the implementation of <code>InMemoryTrips</code>, now converted to Kotlin:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">InMemoryTrips</code> <code class="p">:</code> <code class="n">Trips</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">trips</code><code class="p">:</code> <code class="n">MutableMap</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">MutableSet</code><code class="p">&lt;</code><code class="n">Trip</code><code class="p">&gt;&gt;</code> <code class="p">=</code> <code class="n">mutableMapOf</code><code class="p">()</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">addTrip</code><code class="p">(</code><code class="n">trip</code><code class="p">:</code> <code class="n">Trip</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">existingTrips</code> <code class="p">=</code> <code class="n">trips</code><code class="p">.</code><code class="n">getOrDefault</code><code class="p">(</code><code class="n">trip</code><code class="p">.</code><code class="n">customerId</code><code class="p">,</code> <code class="n">mutableSetOf</code><code class="p">())</code>&#13;
        <code class="n">existingTrips</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">trip</code><code class="p">)</code>&#13;
        <code class="n">trips</code><code class="p">[</code><code class="n">trip</code><code class="p">.</code><code class="n">customerId</code><code class="p">]</code> <code class="p">=</code> <code class="n">existingTrips</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">override</code> <code class="k">fun</code> <code class="nf">tripsFor</code><code class="p">(</code><code class="n">customerId</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code>&#13;
        <code class="n">trips</code><code class="p">.</code><code class="n">getOrDefault</code><code class="p">(</code><code class="n">customerId</code><code class="p">,</code> <code class="n">emptySet</code><code class="p">&lt;</code><code class="n">Trip</code><code class="p">&gt;())</code>&#13;
&#13;
    <code class="k">override</code> <code class="k">fun</code> <code class="nf">currentTripsFor</code><code class="p">(</code><code class="n">customerId</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code> <code class="n">at</code><code class="p">:</code> <code class="n">Instant</code><code class="p">):</code> <code class="n">Set</code><code class="p">&lt;</code><code class="n">Trip</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
        <code class="n">tripsFor</code><code class="p">(</code><code class="n">customerId</code><code class="p">)</code>&#13;
            <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">isPlannedToBeActiveAt</code><code class="p">(</code><code class="n">at</code><code class="p">)</code> <code class="p">}</code>&#13;
            <code class="p">.</code><code class="n">toSet</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=7.20&amp;show=file">Example 7.20 [actions.10:src/test/java/travelator/InMemoryTrips.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=7.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That <code>MutableMap</code> of <code>MutableSet</code>s is a sign that something can change over time.&#13;
If they have the same customer, the result of <code>tripsFor</code> will be different after we have called <code>addTrip</code>.&#13;
So <code>tripsFor</code> is an action, not a calculation.&#13;
If <code>tripsFor</code> is an action, then anything that calls it is an action, including our <code>currentTripsFor</code>.&#13;
The same will obviously be true of the production version of <code>Trips</code> that reads and writes to the database.&#13;
After all this work, we haven’t actually promoted our action to a calculation after all!</p>&#13;
&#13;
<p>Should we be downhearted?&#13;
No.&#13;
Despite our previous assertion that functions are either calculations <em>or</em> actions, the truth is that in practice actionness is graduated, and actions can be more or less susceptible to time.&#13;
In this case, unless other code <em>in this interaction</em> is also going to fetch the trips for a customer and find an inconsistency, we can treat <code>Trips</code> as effectively immutable.&#13;
So <code>tripsFor</code>, and by extension <code>currentTripsFor</code>, are effectively calculations.&#13;
In this respect our <code>InMemoryTrips</code> is less safe than our database implementation because, if accessed on multiple threads, it can mutate the collection returned by <code>tripsFor</code>, leading to potential <code>ConcurrentModification​Excep⁠tions</code> in the <code>filter</code> implementation.&#13;
Categorizing our code into calculations and actions has helped us see these issues and given us a framework for deciding whether they are important in context.</p>&#13;
&#13;
<p>Lastly, note that Kotlin’s preference for immutable data makes this categorization easier.&#13;
For example, when you see <code>List</code> in Java, you have to find the places in which it is created or referenced to establish its mutability and, hence, the likelihood that code accessing it can be an action.&#13;
In Kotlin, when you see <code>MutableList</code> you can infer an action, although as we have seen with <code>InMemoryTrips</code>, exposing a mutable collection with a read-only alias can lead to actions pretending to be calculations.<a data-primary="" data-startref="Cref07" data-type="indexterm" id="idm46393399052456"/><a data-primary="" data-startref="ACref07" data-type="indexterm" id="idm46393399051480"/><a data-primary="" data-startref="Ractcalc07" data-type="indexterm" id="idm46393399050536"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393399556760">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>Categorizing code into calculations and actions (along with data) is a formalism introduced by Eric Normand in his book, <a href="bibliography01.html#N_GSTCSWFT_2021"><em>Grokking Simplicity: Taming Complex Software with Functional Thinking</em></a> (Manning Publications).&#13;
As developers, we intuit the difference and soon learn to rely on our intuition, but often without realizing how or why.&#13;
Giving names to the categories, and studying their qualities, allows us to reason at a more conscious and effective level.</p>&#13;
&#13;
<p>In <a data-type="xref" data-xrefstyle="chap-num-title" href="ch05.html#beans-to-values">Chapter 5, <em>Beans to Values</em></a>, we refactored from a mutable bean to an immutable value.&#13;
Similarly, in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch06.html#java-to-kotlin-collections">Chapter 6, <em>Java to Kotlin Collections</em></a>, we refactored from mutable to immutable collections.&#13;
In both cases, we trade mutating an object for returning an amended copy, converting an action into a calculation.&#13;
In doing so, we gain the advantages we’ve seen in this chapter: better comprehension, easier testing, and predictable refactoring.&#13;
The more of our code that is calculations, the better off we are.</p>&#13;
&#13;
<p>We will return to the topic of moving from actions to calculations in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch14.html#accumulating-objects-to-transformations">Chapter 14, <em>Accumulating Objects to Transformations</em></a>.&#13;
In <a data-type="xref" data-xrefstyle="chap-num-title" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15, <em>Encapsulated Collections to Type Aliases</em></a>, we’ll see how immutable data combines with Kotlin’s extension functions and type aliases and lets us organize our code in ways not possible in Java.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>