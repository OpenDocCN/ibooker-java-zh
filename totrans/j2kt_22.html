<html><head></head><body><section data-pdf-bookmark="Chapter 22. Classes to Functions" data-type="chapter" epub:type="chapter"><div class="chapter" id="classes-to-functions">&#13;
<h1><span class="label">Chapter 22. </span>Classes to Functions</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Object-oriented programmers are adept at solving problems by creating types.&#13;
Functional programmers tend to augment existing types with functions.&#13;
How far can we go without defining new types?</p>&#13;
</blockquote>&#13;
&#13;
<p>In <a data-type="xref" data-xrefstyle="chap-num-title" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15, <em>Encapsulated Collections to Type Aliases</em></a>, we saw the advantages of working with raw collections, and in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch16.html#interfaces-to-functions">Chapter 16, <em>Interfaces to Functions</em></a>, we looked at using built-in function types rather than creating new ones.&#13;
In this chapter, we’ll apply the lessons we’ve learned to write some Kotlin from scratch.</p>&#13;
&#13;
<p>Even in these days of REST APIs and webhooks, much of automatic business-to-business communication is in the form of tabular text data exchanged by<a data-primary="Secure File Transfer Protocol (SFTP)" data-type="indexterm" id="idm46393351500216"/><a data-primary="SFTP (Secure File Transfer Protocol)" data-type="indexterm" id="idm46393351499544"/> Secure File Transfer Protocol (SFTP).&#13;
Travelator has to import data for campsite locations, points of interest, unsettled bills, and more, all in regular rows and columns, with different  column separators, and with and without a header naming the columns for the remaining rows.&#13;
In <a data-type="xref" href="ch20.html#performing-io-to-passing-data">Chapter 20</a>, we<a data-primary="Commons CSV library" data-type="indexterm" id="idm46393351497704"/><a data-primary="Apache Commons CSV library" data-type="indexterm" id="idm46393351497000"/> saw that one team had created its own parser; in other places, we use the tried-and-trusted <a href="https://oreil.ly/jnI4h">Apache Commons CSV library</a>.&#13;
Honestly, for most uses, we would still use Commons CSV, because it works out of the box, is nicely configurable for special cases, and plays really well with Kotlin.</p>&#13;
&#13;
<p>Today though we’re going to see what a clean-room Kotlin parser would look like.&#13;
When we’re done, we’ll compare what we come up with to the Commons CSV functionality so that we can see how the grains of Java and Kotlin lead to different APIs and implementations.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="An Acceptance Test" data-type="sect1"><div class="sect1" id="idm46393351494600">&#13;
<h1>An Acceptance Test</h1>&#13;
&#13;
<p>As<a data-primary="classes to functions" data-secondary="acceptance tests" data-type="indexterm" id="CFacc22"/><a data-primary="acceptance tests" data-type="indexterm" id="accept22"/><a data-primary="XP (Extreme Programming)" data-type="indexterm" id="idm46393351490008"/><a data-primary="Extreme Programming (XP)" data-type="indexterm" id="idm46393351489320"/> you might have been able to tell from the preceding chapters, the Travelator developers are Extreme Programmers (<a href="bibliography01.html#B_EPEEC_1999"><em>Extreme Programming Explained: Embrace Change</em></a>).&#13;
We write code test first, starting with a high-level acceptance test.&#13;
We’re working on a table reader, so we create a class <code>TableReaderAcceptanceTests</code> with a stub method and check that it runs:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">TableReaderAcceptanceTests</code> <code class="p">{</code>&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="nf">test</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.1&amp;show=file">Example 22.1 [table-reader.1:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It does run (it even passes!), so now we can start coding proper.</p>&#13;
&#13;
<p>Part of the acceptance test’s job is to help us decide what our interface should look like.&#13;
Having parsed a few files in our time, we know that what we almost always want to do is read a file and return a list of values of some domain type, one for each (nonheader) row.&#13;
Let’s sketch that as our test, with <code>Measurement</code> as our domain type:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">TableReaderAcceptanceTests</code> <code class="p">{</code>&#13;
    <code class="n">data</code> <code class="k">class</code> <code class="nc">Measurement</code><code class="p">(</code>&#13;
        <code class="k">val</code> <code class="py">t</code><code class="p">:</code> <code class="n">Double</code><code class="p">,</code>&#13;
        <code class="k">val</code> <code class="py">x</code><code class="p">:</code> <code class="n">Double</code><code class="p">,</code>&#13;
        <code class="k">val</code> <code class="py">y</code><code class="p">:</code> <code class="n">Double</code><code class="p">,</code>&#13;
    <code class="p">)</code>&#13;
&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="err">`</code><code class="nf">acceptance</code> <code class="n">test</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">input</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="s">"time,x,y"</code><code class="p">,</code>&#13;
            <code class="s">"0.0,  1,  1"</code><code class="p">,</code>&#13;
            <code class="s">"0.1,1.1,1.2"</code><code class="p">,</code>&#13;
            <code class="s">"0.2,1.2,1.4"</code><code class="p">,</code>&#13;
        <code class="p">)</code>&#13;
        <code class="k">val</code> <code class="py">expected</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">Measurement</code><code class="p">(</code><code class="m">0.0</code><code class="p">,</code> <code class="m">1.0</code><code class="p">,</code> <code class="m">1.0</code><code class="p">),</code>&#13;
            <code class="n">Measurement</code><code class="p">(</code><code class="m">0.1</code><code class="p">,</code> <code class="m">1.1</code><code class="p">,</code> <code class="m">1.2</code><code class="p">),</code>&#13;
            <code class="n">Measurement</code><code class="p">(</code><code class="m">0.2</code><code class="p">,</code> <code class="m">1.2</code><code class="p">,</code> <code class="m">1.4</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code>&#13;
            <code class="n">expected</code><code class="p">,</code>&#13;
            <code class="n">someFunction</code><code class="p">(</code><code class="n">input</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">someFunction</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Measurement</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
        <code class="n">TODO</code><code class="p">(</code><code class="s">"Not yet implemented"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.2&amp;show=file">Example 22.2 [table-reader.2:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Here <code>Measurement</code> is a value type that represents the data that we want to extract from each row of the table.&#13;
In<a data-primary="calculations" data-secondary="reading tables" data-type="indexterm" id="idm46393351286472"/> Java, we would probably start by creating a <code>TableReader</code> class, but we can see from the test that reading a table is simply a calculation: a mapping of the input lines to a list of the data that we want (<a data-type="xref" href="ch07.html#calculations">“Calculations”</a>).&#13;
So we’ll default to using a top-level <code>someFunction</code> until we are forced to do something more complicated.</p>&#13;
&#13;
<p>We can imagine all sorts of magic ways that our API could implement <code>someFunction</code>, but unless it has some special knowledge of the <code>Measurement</code> type (and libraries don’t have knowledge of <em>our</em> types, that’s the wrong way around), we will have to tell it how to map from some representation of a row to a <code>Measurement</code>.</p>&#13;
&#13;
<p>That’s twice we’ve used the word <em>map</em>.&#13;
Maybe <em>map</em> holds the key?&#13;
(An accidental pun, that one.)&#13;
What if <code>someFunction</code> looked like this?</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code><code> </code><code class="k">fun</code><code> </code><code class="nf">someFunction</code><code class="p">(</code><code class="n">input</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Measurement</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code>&#13;
</code><code>    </code><code class="n">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO49-1" id="co_introduction_CO49-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="p">.</code><code class="n">map</code><code> </code><code class="p">{</code><code> </code><code class="n">record</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_introduction_CO49-2" id="co_introduction_CO49-2"><img alt="2" src="assets/2.png"/></a><code> </code><a class="co" href="#callout_introduction_CO49-3" id="co_introduction_CO49-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="n">Measurement</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="p">.</code><code class="n">toDouble</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_introduction_CO49-4" id="co_introduction_CO49-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>            </code><code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="p">.</code><code class="n">toDouble</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_introduction_CO49-4" id="co_introduction_CO49-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>            </code><code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="p">.</code><code class="n">toDouble</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_introduction_CO49-4" id="co_introduction_CO49-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.3&amp;show=file">Example 22.3 [table-reader.3:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO49-1" id="callout_introduction_CO49-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>readTable</code> is our table reading API entry point</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO49-2" id="callout_introduction_CO49-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>It returns something that has a <code>map</code> implementation.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO49-3" id="callout_introduction_CO49-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p><code>record</code> is our representation of a row in the table.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO49-4" id="callout_introduction_CO49-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>We can index into <code>record</code> by field name, yielding a <code>String</code> that we can convert to other types.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This doesn’t compile, because we don’t have <code>readTable</code> yet, but if we Alt-Enter on the error, IntelliJ will create the function for us:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">Any</code> <code class="p">{</code>&#13;
    <code class="n">TODO</code><code class="p">(</code><code class="s">"Not yet implemented"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.4&amp;show=file">Example 22.4 [table-reader.3:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We haven’t given IntelliJ enough clues about the return type of <code>readTable</code>, so it chose <code>Any</code>, and so <code>someFunction</code> still doesn’t compile.&#13;
What type could we return to fix that?&#13;
Well, if we return a <code>List</code> from <code>readTable</code>, then <code>map</code> is an operation on <code>List</code>.&#13;
And if that <code>List</code> contained <code>Map&lt;String, String&gt;</code>, our <code>record</code> variable would be <code>Map&lt;String, String&gt;</code>, so we could call <code>record["time"]</code>, and so on.&#13;
The only issue is that <code>Map.get</code> returns a nullable value.&#13;
That’s close enough—let’s take account of it in <code>someFunction</code> by raising errors if <code>get</code> returns <code>null</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">someFunction</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Measurement</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="n">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code>&#13;
            <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
            <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
            <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="n">TODO</code><code class="p">(</code><code class="s">"Not yet implemented"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.5&amp;show=file">Example 22.5 [table-reader.4:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This compiles, although obviously the <code>TODO</code> fails the test.&#13;
(You might ask why we are taking such a cavalier attitude toward errors compared to our forensic <a data-type="xref" href="ch21.html#exceptions-to-values">Chapter 21</a>.&#13;
The answer is that this is just test code: the API of <code>Map.get</code> is forcing us to consider what to do in the case of errors, and our test is choosing to throw.)</p>&#13;
&#13;
<p>We put our client hats on to write the acceptance tests, and these tests have shown that we can at least use a function with the signature of <code>readTable</code> to convert lines to a list of <code>Measurement</code>.&#13;
Now that we have a plausible API, we can move the definition of <code>readTable</code> into <em>src/main/travelator/tablereader/table-reading.kt</em>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="n">TODO</code><code class="p">(</code><code class="s">"Not yet implemented"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.6&amp;show=file">Example 22.6 [table-reader.5:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Finally in this first stage, we can inline <code>someFunction</code> to give our acceptance test:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Disabled</code>&#13;
<code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">acceptance</code> <code class="n">test</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">input</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
        <code class="s">"time,x,y"</code><code class="p">,</code>&#13;
        <code class="s">"0.0,  1,  1"</code><code class="p">,</code>&#13;
        <code class="s">"0.1,1.1,1.2"</code><code class="p">,</code>&#13;
        <code class="s">"0.2,1.2,1.4"</code><code class="p">,</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">expected</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code><code class="m">0.0</code><code class="p">,</code> <code class="m">1.0</code><code class="p">,</code> <code class="m">1.0</code><code class="p">),</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code><code class="m">0.1</code><code class="p">,</code> <code class="m">1.1</code><code class="p">,</code> <code class="m">1.2</code><code class="p">),</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code><code class="m">0.2</code><code class="p">,</code> <code class="m">1.2</code><code class="p">,</code> <code class="m">1.4</code><code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">expected</code><code class="p">,</code>&#13;
        <code class="n">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
            <code class="n">Measurement</code><code class="p">(</code>&#13;
                <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
                <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
                <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.7&amp;show=file">Example 22.7 [table-reader.5:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Note that we have disabled the test because it will be some time before we get it running.&#13;
That’s OK with acceptance tests.&#13;
We don’t expect to get them to pass quickly, more tell us when we are done.&#13;
For now, it has done its job, helping us sketch a simple API that we can now implement.</p>&#13;
&#13;
<p>Before we do go on, let’s reflect on the fact that we have managed to define the interface to our parser without defining any new types, instead using <code>List</code> and <code>Map</code> of <code>String</code>.&#13;
By using standard types, we know that we have rich Kotlin APIs to supply the <code>List</code> that we are reading from, and to interpret the <code>List</code> of <code>Map</code>s that we are returning.<a data-primary="" data-startref="CFacc22" data-type="indexterm" id="idm46393350760744"/><a data-primary="" data-startref="accept22" data-type="indexterm" id="idm46393350759768"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unit Testing" data-type="sect1"><div class="sect1" id="idm46393351493656">&#13;
<h1>Unit Testing</h1>&#13;
&#13;
<p>Now<a data-primary="classes to functions" data-secondary="unit testing" data-type="indexterm" id="CFunit22"/><a data-primary="unit testing" data-type="indexterm" id="unit22"/> that we have an interface to implement, we can park the acceptance test and write a minimal unit test.&#13;
What is minimal?&#13;
We like to start with empty: what should happen if we read an empty file?</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">TableReaderTests</code> <code class="p">{</code>&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="err">`</code><code class="nf">empty</code> <code class="n">list</code> <code class="n">returns</code> <code class="n">empty</code> <code class="n">list</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="k">val</code> <code class="py">expectedResult</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code>&#13;
            <code class="n">expectedResult</code><code class="p">,</code>&#13;
            <code class="n">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.8&amp;show=file">Example 22.8 [table-reader.6:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The simplest way to get this to pass is to hard-code the result in <code>readTable</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.9&amp;show=file">Example 22.9 [table-reader.7:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This passes.&#13;
It may seem trivial, but it’s always a good idea to have a test for empty input. The more complicated our algorithm, the more likely it is to fail in this case.&#13;
It’s a poor parser that always returns an empty result, though, so let’s crack on.&#13;
Following<a data-primary="TDD (Test Driven Development)" data-type="indexterm" id="idm46393350702504"/> TDD (<a href="bibliography01.html#B_TDDBE_2002"><em>Test-Driven Development By Example</em></a>), we need to add a failing test first to give us a reason to change the implementation.&#13;
We choose to add the case of reading a table with no header and one line of data.</p>&#13;
&#13;
<p>Why this rather than a header and one line of data?&#13;
To be honest, this is just the first thing that came to mind; maybe if we were actually pairing at this point, you would have suggested using a header row.&#13;
Our choice leaves us having to decide how to name the columns, and we decide to use the <code>String</code> representation of their index, <code>"0"</code> for the first column, <code>"1"</code> for the second, and so on; this feels like the simplest way that we can generate a <code>String</code> key:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">empty</code> <code class="n">list</code> <code class="n">returns</code> <code class="n">empty</code> <code class="n">list</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">emptyList</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;(),</code>&#13;
        <code class="n">readTable</code><code class="p">(</code><code class="n">emptyList</code><code class="p">())</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">one</code> <code class="n">line</code> <code class="n">of</code> <code class="n">input</code> <code class="n">with</code> <code class="n">default</code> <code class="n">field</code> <code class="n">names</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTable</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="s">"field0,field1"</code>&#13;
        <code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.10&amp;show=file">Example 22.10 [table-reader.8:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We <em>could</em> instead have made <code>readTable</code> return <code>&lt;Map&lt;Int, String&gt;&gt;</code> when we don’t have a header row.&#13;
If you have some spare time, that might be a path worth following to see where it leads.</p>&#13;
&#13;
<p>Back in our current predicament, we have a failing test, and we can be clever or we can be quick.&#13;
We choose quick, to get the test passing straightaway by hardcoding the result again:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">if</code> <code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">())</code>&#13;
        <code class="n">emptyList</code><code class="p">()</code>&#13;
    <code class="k">else</code> <code class="n">listOf</code><code class="p">(</code>&#13;
        <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.11&amp;show=file">Example 22.11 [table-reader.8:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that our tests are passing, we can simplify the implementation by noticing that we want a line in the output for every line in the input.&#13;
<code>Iterable::map</code> will do this, allowing us to remove the <code>if</code> expression:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.12&amp;show=file">Example 22.12 [table-reader.9:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This continues to pass the tests and would now work for more lines (of identical data)!&#13;
It’s only a stepping-stone though, allowing us to extract the lambda as a &#13;
<span class="keep-together">function</span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">lines</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">::</code><code class="n">parseLine</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code> <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.13&amp;show=file">Example 22.13 [table-reader.10:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we’ll start removing the hard-coded values by splitting the pairs into <code>keys</code> and <code>values</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"0"</code><code class="p">,</code> <code class="s">"1"</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"field0"</code><code class="p">,</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.14&amp;show=file">Example 22.14 [table-reader.11:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We’re still resolutely cheating, but we can now see the pattern in the <code>keys</code> and generate these from the <code>values</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"field0"</code><code class="p">,</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.15&amp;show=file">Example 22.15 [table-reader.12:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>For the <code>values</code>, we can split the line around the commas:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.16&amp;show=file">Example 22.16 [table-reader.13:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Success: we have removed the hard-coded keys and values, and the tests still pass.&#13;
Because we used <code>lines.map</code> in <code>readTable</code>, we believe the function will work for any numbers of lines, but it would be good to have a test to confirm that.</p>&#13;
&#13;
<p>We make a note to add it, because something is bothering us that we’d like to look at first.&#13;
If you are as old as your authors (or younger and gifted) you may have developed spidey senses for code, and they may be tingling when you look at that <code>split</code>.&#13;
What will happen if we try to split an empty line?&#13;
For that matter, what should &#13;
<span class="keep-together"><code>readTable</code></span> return when fed an empty line?</p>&#13;
&#13;
<p>Discussing it, we come to the conclusion that an empty line should yield an empty <code>Map</code>.&#13;
That feels clean, so we write a test to both document our decision and check that it works:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">empty</code> <code class="n">line</code> <code class="n">returns</code> <code class="n">empty</code> <code class="n">map</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">emptyMap</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;()</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTable</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="s">""</code>&#13;
        <code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.17&amp;show=file">Example 22.17 [table-reader.14:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Aha!</p>&#13;
&#13;
<pre data-type="programlisting">org.opentest4j.AssertionFailedError:&#13;
Expected :[{}]&#13;
Actual   :[{0=}]</pre>&#13;
&#13;
<p>After a little investigation, we discover that calling <code>split</code> on an empty <code>String</code> returns a <code>List</code> of a single empty <code>String</code>.&#13;
Maybe that makes sense in other circumstances.&#13;
Maybe, but it messes up our algorithm, so we have to work around it with a special case in <code>parseLine</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">line</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">())</code> <code class="n">emptyList</code><code class="p">()</code> <code class="k">else</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.18&amp;show=file">Example 22.18 [table-reader.14:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That gets the tests passing but muddies the waters of the <code>parseLine</code> function.&#13;
So we extract the muddy line to a function called <code>splitFields</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">splitFields</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">splitFields</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">line</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">())</code> <code class="n">emptyList</code><code class="p">()</code> <code class="k">else</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">","</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.19&amp;show=file">Example 22.19 [table-reader.15:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>If we make <code>splitFields</code> an extension function and introduce a <code>separators</code> parameter, we get the function we always really wanted <code>split</code> to be:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">String</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="n">separators</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">isEmpty</code><code class="p">())</code> <code class="n">emptyList</code><code class="p">()</code> <code class="k">else</code> <code class="n">split</code><code class="p">(</code><code class="n">separators</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.20&amp;show=file">Example 22.20 [table-reader.16:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>So far, we have gotten the code working with an empty input and then an input of a single line.&#13;
If we had written an imperative solution, we might now have to add a loop to handle more input, but <code>map</code> has our back, because it will always return as many items as we give it.&#13;
We believe that <code>readTable</code> should work for all the numbers known to programmers: 0, 1, and infinity (well, OK, 2<sup>31</sup> - 1 rather than actual infinity).</p>&#13;
&#13;
<p>“Trust but verify” they say though, so we add a test:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">two</code> <code class="n">lines</code> <code class="n">of</code> <code class="n">input</code> <code class="n">with</code> <code class="n">default</code> <code class="n">field</code> <code class="n">names</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"row0field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"row0field1"</code><code class="p">),</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"row1field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"row1field1"</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTable</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="s">"row0field0,row0field1"</code><code class="p">,</code>&#13;
            <code class="s">"row1field0,row1field1"</code>&#13;
        <code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.21&amp;show=file">Example 22.21 [table-reader.17:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It passes, and we reason that <code>(0, 1, 2)</code> is close enough to <code>(0, 1, 2147483647)</code> that we are done for now.&#13;
This seems like a good place to check in, make a fresh coffee, and dispose of the last one before getting back to work.<a data-primary="" data-startref="CFunit22" data-type="indexterm" id="idm46393349565672"/><a data-primary="" data-startref="unit22" data-type="indexterm" id="idm46393349564696"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Headers" data-type="sect1"><div class="sect1" id="idm46393349563496">&#13;
<h1>Headers</h1>&#13;
&#13;
<p>Ready<a data-primary="classes to functions" data-secondary="headers" data-type="indexterm" id="CFheader22"/><a data-primary="header lines" data-type="indexterm" id="header22"/> to go again?&#13;
OK, what about a header line?</p>&#13;
&#13;
<p>First, how should our API know to expect one?&#13;
We could add a flag to <code>readTable</code> to tell it that our data has a header, or we can add another function.&#13;
Generally we prefer a different function for different functionality, so let’s add a function named <code>readTableWithHeader</code>.</p>&#13;
&#13;
<p>As with <code>readTable</code>, we first add a test that calls the function that we wish we had:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">takes</code> <code class="n">headers</code> <code class="n">from</code> <code class="n">header</code> <code class="n">line</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code><code class="s">"H0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"H1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
            <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="s">"H0,H1"</code><code class="p">,</code>&#13;
                <code class="s">"field0,field1"</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.22&amp;show=file">Example 22.22 [table-reader.18:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.22&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Alt-Enter on the compilation error at <code>readTableWithHeader</code> and IntelliJ will create it for us.&#13;
Then we can name the parameters and delegate to our original function for now:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">lines</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">::</code><code class="n">parseLine</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.23&amp;show=file">Example 22.23 [table-reader.18:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.23&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This compiles but fails the tests, as we expect:</p>&#13;
&#13;
<pre data-type="programlisting">org.opentest4j.AssertionFailedError:&#13;
Expected :[{H0=field0, H1=field1}]&#13;
Actual   :[{0=H0, 1=H1}, {0=field0, 1=field1}]</pre>&#13;
&#13;
<p>To get the tests to pass, we could hard-code the result as before, but this time we’re going to modify the code to make room for the functionality.&#13;
When we say <em>make room</em>, what we are aiming for is code that does the current thing (using <code>Int::toString</code> field names) and which we are able to <em>augment</em> rather than modify to support the new functionality.&#13;
The new feature will then be an addition <em>rather</em> than a modification (the <a href="https://oreil.ly/MwO5l">open–closed principle</a>).</p>&#13;
&#13;
<p>Currently, the field name information is buried in <code>parseLine</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.24&amp;show=file">Example 22.24 [table-reader.18:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.24&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We’re going to pull it out from here to a place where we can use the header line to supply it.</p>&#13;
&#13;
<p><code>Int::toString</code> is our current mapping from index to key.&#13;
Let’s prepare to make this configurable by introducing a variable named <code>headerProvider</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">headerProvider</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.25&amp;show=file">Example 22.25 [table-reader.19:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.25&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This still passes our tests, except for the new <code>takes headers from header line</code>, which is still failing.&#13;
We shouldn’t really be refactoring with a failing test, because every time we run the tests, we will have to check that any failure is actually the one we expect.&#13;
So we <code>@Disabled</code> it for now to only run tests for completed features while we are &#13;
<span class="keep-together">refactoring</span>.</p>&#13;
&#13;
<p>“Introduce Parameter” on the <code>headerProvider</code> line and naming it <code>headerProvider</code> will allow us to support different behaviors:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code>&#13;
    <code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code>&#13;
<code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">headerProvider</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.26&amp;show=file">Example 22.26 [table-reader.20:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.26&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Unfortunately, IntelliJ currently fails to make this refactor work, breaking <code>readTable</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="k">fun</code><code> </code><code class="nf">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">lines</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="o">::</code><code class="n">parseLine</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO50-1" id="co_introduction_CO50-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.27&amp;show=file">Example 22.27 [table-reader.20:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.27&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO50-1" id="callout_introduction_CO50-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>We could use the function reference when <code>parseLine</code> only had one parameter. Now it needs two arguments, but <code>map</code> can only supply one.</p></dd>&#13;
</dl>&#13;
&#13;
<p>“Replace function reference with lambda” <em>before</em> the refactor would have made everything work now, but we’ll fail forward by expanding the lambda now and adding <code>Int::toString</code> as the <code>headerProvider</code> to get things compiling again:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">)</code> <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.28&amp;show=file">Example 22.28 [table-reader.21:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.28&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>All our tests still pass, so we’re quietly confident that we haven’t broken anything.</p>&#13;
&#13;
<p>Where are we going with this?&#13;
Our plan is to have the new <code>readTableWithHeader</code> read the header line to create a <code>headerProvider</code> to pass to <code>parseLine</code>.&#13;
Sitting between &#13;
<span class="keep-together"><code>readTableWithHeader</code></span> and <code>parseLine</code> is the call to our old <code>readTable</code>, so it needs a <code>headerProvider</code> parameter too, so that it can relay the value.&#13;
So it’s “Introduce Parameter” (with “Introduce Default Value”) again, this time on <code>Int::toString</code> in <code>readTable</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="k">fun</code><code> </code><code class="nf">readTable</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">headerProvider</code><code class="p">:</code><code> </code><code class="n">KFunction1</code><code class="p">&lt;</code><code class="n">Int</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code> </code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code> </code><a class="co" href="#callout_introduction_CO51-1" id="co_introduction_CO51-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">lines</code><code class="p">.</code><code class="n">map</code><code> </code><code class="p">{</code><code> </code><code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code><code> </code><code class="n">headerProvider</code><code class="p">)</code><code> </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.29&amp;show=file">Example 22.29 [table-reader.22:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.29&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO51-1" id="callout_introduction_CO51-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Doesn’t compile: <code>Unresolved reference: KFunction1</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>It’s hard to say why IntelliJ (at the time of writing) sometimes uses function types and sometimes <code>KFunctionN</code> types when refactoring.&#13;
It would be nice if it was consistent, or at least generated code that compiled.&#13;
We’ll fix this one by translating the <code>KFunction1</code> to an <code>(Int) -&gt; String</code> by hand and hold just a little grudge for this second failed refactor in a row:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">readTable</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">)</code> <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.30&amp;show=file">Example 22.30 [table-reader.23:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.30&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>On the plus side, because the <code>headerProvider</code> parameter has a default value, our tests are unchanged and continue to pass.</p>&#13;
&#13;
<p>Now we’re in a position to parse the header line;&#13;
<code>readTableWithHeader</code> will need to read the header, create a <code>headerProvider</code> (an <code>(Int) -&gt; String</code> remember), and then delegate to <code>readTable</code>.&#13;
It needs to split the lines into the header (<code>Iterable.first()</code>) and the rest (<code>Iterable.drop(1)</code>).&#13;
<code>Iterable.first</code> will fail if there are no lines, so we make a note to add a test for this case.&#13;
As for converting the header line into a <code>header​Pro⁠vider</code>, we’ll pretend that we have a function to do that called <code>headerProviderFrom(String)</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">readTable</code><code class="p">(</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
        <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">())</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.31&amp;show=file">Example 22.31 [table-reader.24:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.31&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Alt-Enter on the new function’s invocation allows us to create it, giving:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">headerProviderFrom</code><code class="p">(</code><code class="n">header</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="n">TODO</code><code class="p">(</code><code class="s">"Not yet implemented"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.32&amp;show=file">Example 22.32 [table-reader.24:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.32&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is a function that needs to return a function type.&#13;
We can implement the return value with a lambda that takes an <code>Int</code> index and returns a <code>String</code>.&#13;
The <code>String</code> we need to return is the header field at that index.&#13;
We can use our <code>splitFields</code> again here:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">headerProviderFrom</code><code class="p">(</code><code class="n">header</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">header</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">{</code> <code class="n">index</code> <code class="p">-&gt;</code> <code class="n">headers</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.33&amp;show=file">Example 22.33 [table-reader.25:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.33&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We’ve taken care to split the <code>header</code> outside the lambda; otherwise, it will happen for every other row of the table.&#13;
Our tests still pass, and if we’re right, so will the test for <code>readTableWithHeader</code> that we disabled previously.&#13;
Let’s un-<code>@Disabled</code> it:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">takes</code> <code class="n">headers</code> <code class="n">from</code> <code class="n">header</code> <code class="n">line</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code><code class="s">"H0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"H1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
            <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="s">"H0,H1"</code><code class="p">,</code>&#13;
                <code class="s">"field0,field1"</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.34&amp;show=file">Example 22.34 [table-reader.26:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.34&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This passes, hooray!&#13;
We are about to say that we’re done for now, until we look down at our to-do list and remember that we predicted <code>readTableWithHeader</code> should fail given an empty input.&#13;
So we write a test asserting the desired behavior, which is to return an empty <code>List</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">readTableWithHeader</code> <code class="n">on</code> <code class="n">empty</code> <code class="n">list</code> <code class="n">returns</code> <code class="n">empty</code> <code class="n">list</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">emptyList</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;(),</code>&#13;
        <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
            <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.35&amp;show=file">Example 22.35 [table-reader.26:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.35&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>As we thought, this fails with <code>java.util.NoSuchElementException: List is empty.</code>, because <code>readTableWithHeader</code> is trying to call <code>lines.first()</code> on an empty <code>List</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">readTable</code><code class="p">(</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
        <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">())</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.36&amp;show=file">Example 22.36 [table-reader.25:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.36&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Our irritation at not being finished is mitigated by being right about there being a problem!&#13;
The simplest fix is to split our function into two definitions, with a <code>when</code> to choose between them.&#13;
This passes all the tests and empties our to-do list.&#13;
Here, then, is our public API:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">())</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">)</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.37&amp;show=file">Example 22.37 [table-reader.26:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.37&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is nice.&#13;
Our clients now can read with or without a header row.&#13;
But wait!&#13;
Looking at the code, we realize that if they want to specify their own field names for <code>read​Ta⁠ble</code>, they can do this by overriding the default <code>headerProvider</code> in <code>readTable</code>.&#13;
We have a feature for free!&#13;
Let’s write a test to demonstrate it:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">can</code> <code class="n">specify</code> <code class="n">header</code> <code class="n">names</code> <code class="k">when</code> <code class="n">there</code> <code class="k">is</code> <code class="n">no</code> <code class="n">header</code> <code class="n">row</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"apple"</code><code class="p">,</code> <code class="s">"banana"</code><code class="p">)</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code>&#13;
                <code class="s">"apple"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code>&#13;
                <code class="s">"banana"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">,</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">listOf</code><code class="p">(</code><code class="s">"field0,field1"</code><code class="p">),</code>&#13;
            <code class="n">headers</code><code class="o">::</code><code class="k">get</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.38&amp;show=file">Example 22.38 [table-reader.27:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.38&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>See how easy it is to convert from a <code>List&lt;String&gt;</code> to our header provider function <code>(Int) -&gt; String</code> with the method reference<a data-primary="headers::get" data-type="indexterm" id="idm46393348013512"/> <code>headers::get</code>?&#13;
This is an interesting way to view collections.&#13;
We can view:</p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th>Type</th>&#13;
<th>as function type</th>&#13;
<th>by</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>List&lt;T&gt;</code></p></td>&#13;
<td><p><code>(index: Int) -&gt; T</code></p></td>&#13;
<td><p><code>List.get(index)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Set&lt;T&gt;</code></p></td>&#13;
<td><p><code>(item: T) -&gt; Boolean</code></p></td>&#13;
<td><p><code>Set.contains(item)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Map&lt;K, V&gt;</code></p></td>&#13;
<td><p><code>(key: K) -&gt; V?</code></p></td>&#13;
<td><p><code>Map.get(key)</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>If we are able to express a dependency as one of these function types, then our clients, and our tests, can use standard collections to provide an implementation.</p>&#13;
&#13;
<p>Now that we have implemented reading a table with a header, we are in a position to try running our acceptance test.&#13;
This was:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Disabled</code>&#13;
<code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">acceptance</code> <code class="n">test</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">input</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
        <code class="s">"time,x,y"</code><code class="p">,</code>&#13;
        <code class="s">"0.0,  1,  1"</code><code class="p">,</code>&#13;
        <code class="s">"0.1,1.1,1.2"</code><code class="p">,</code>&#13;
        <code class="s">"0.2,1.2,1.4"</code><code class="p">,</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">expected</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code><code class="m">0.0</code><code class="p">,</code> <code class="m">1.0</code><code class="p">,</code> <code class="m">1.0</code><code class="p">),</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code><code class="m">0.1</code><code class="p">,</code> <code class="m">1.1</code><code class="p">,</code> <code class="m">1.2</code><code class="p">),</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code><code class="m">0.2</code><code class="p">,</code> <code class="m">1.2</code><code class="p">,</code> <code class="m">1.4</code><code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">expected</code><code class="p">,</code>&#13;
        <code class="n">readTable</code><code class="p">(</code><code class="n">input</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
            <code class="n">Measurement</code><code class="p">(</code>&#13;
                <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
                <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
                <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.39&amp;show=file">Example 22.39 [table-reader.26:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.39&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The function that we thought we would call <code>readTable</code> when we wrote the test turns out to be <code>readTableWithHeader</code>, so we make the change and run the test:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">assertEquals</code><code class="p">(</code>&#13;
    <code class="n">expected</code><code class="p">,</code>&#13;
    <code class="n">readTableWithHeader</code><code class="p">(</code><code class="n">input</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
        <code class="n">Measurement</code><code class="p">(</code>&#13;
            <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
            <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
            <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.40&amp;show=file">Example 22.40 [table-reader.27:src/test/java/travelator/tablereader/TableReaderAcceptanceTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.40&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It passes, and we ride the little dopamine hit to check in the code and take a coffee break.<a data-primary="" data-startref="CFheader22" data-type="indexterm" id="idm46393347708552"/><a data-primary="" data-startref="header22" data-type="indexterm" id="idm46393347815608"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Different Field Separators" data-type="sect1"><div class="sect1" id="idm46393349521336">&#13;
<h1>Different Field Separators</h1>&#13;
&#13;
<p>Returning<a data-primary="classes to functions" data-secondary="different field separators" data-type="indexterm" id="CFdiff22"/><a data-primary="field separators" data-type="indexterm" id="field22"/> from coffee, we make a quick survey of the different places in Travelator that read tables.&#13;
Interestingly, we only have one use case that reads classic “comma”,“separated”,“variables” (with the quotes), but several need to use a semicolon as the field separator.&#13;
It seems that some French SQL Server export job is using semicolons and then saving the file with a <em>.CSV</em> extension; maybe the <em>C</em> is for çemicolon?&#13;
We’ll address reading those next, but try to find an interface that will work with more complicated quoting and escaping rules.&#13;
To add flexibility, we need to identify an abstraction, as we did with the <code>headerProvider</code> previously.&#13;
What is the abstraction here?</p>&#13;
&#13;
<p>Looking at the code, we see that the header and body parsing both call <code>splitFields</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">headerProviderFrom</code><code class="p">(</code><code class="n">header</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">header</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">{</code> <code class="n">index</code> <code class="p">-&gt;</code> <code class="n">headers</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code>&#13;
    <code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code>&#13;
<code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">headerProvider</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">String</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="n">separators</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">isEmpty</code><code class="p">())</code> <code class="n">emptyList</code><code class="p">()</code> <code class="k">else</code> <code class="n">split</code><code class="p">(</code><code class="n">separators</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.41&amp;show=file">Example 22.41 [table-reader.28:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.41&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Neither the header parsing nor the body parsing really want to depend on the details of how the splitting should happen, so let’s abstract that behind a function <code>(String)</code> &#13;
<span class="keep-together"><code>-&gt; List&lt;String&gt;</code></span>.&#13;
Why that signature rather than just parameterizing the character?</p>&#13;
&#13;
<p>That’s an interesting question, thank you for asking it.&#13;
Introducing a <code>separators</code> parameter to <code>parseLine</code> and <code>headerProviderFrom</code>, and eventually their callers <code>readTable</code> and <code>readTableWithHeader</code>, would be the simplest thing that we could do.&#13;
We get a lot more flexibility from using a function type, though, because we can hide all the details of separating, quoting, and escaping behind that signature.&#13;
In pre-lambda Java, the benefit of the flexibility wouldn’t have been worth the cost of introducing and implementing a SAM interface, at least not until we really needed all that control.&#13;
With lambdas in Java, the equation feels more balanced but probably not natural for most Java programmers.&#13;
In Kotlin, designed from the outset with function types as part of the language, we use them even more readily.&#13;
As soon as we need to parameterize an aspect of our code, it is natural to ask whether a function would provide more value than, erm, a simple value.</p>&#13;
&#13;
<p>Let’s start in <code>parseLine</code>.&#13;
To extract the current splitting implementation, we can select <code>line.splitFields(",")</code> and “Introduce Functional Parameter”, choosing the parameter name <code>splitter</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">readTable</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">headerProvider</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">Int</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">String</code><code> </code><code class="p">=</code><code> </code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">.</code><code class="n">map</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code><code> </code><code class="n">headerProvider</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><code class="n">line</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_introduction_CO52-1" id="co_introduction_CO52-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>            </code><code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code>&#13;
</code><code class="k">private</code><code> </code><code class="k">fun</code><code> </code><code class="nf">parseLine</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">line</code><code class="p">:</code><code> </code><code class="n">String</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">headerProvider</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">Int</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">String</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">splitter</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">String</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">,</code><code> </code><a class="co" href="#callout_introduction_CO52-2" id="co_introduction_CO52-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">val</code><code> </code><code class="py">values</code><code> </code><code class="p">=</code><code> </code><code class="n">splitter</code><code class="p">(</code><code class="n">line</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">val</code><code> </code><code class="py">keys</code><code> </code><code class="p">=</code><code> </code><code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">headerProvider</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">)</code><code class="p">.</code><code class="n">toMap</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.42&amp;show=file">Example 22.42 [table-reader.29:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.42&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO52-1" id="callout_introduction_CO52-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This lambda…</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO52-2" id="callout_introduction_CO52-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>…implements the splitter.</p></dd>&#13;
</dl>&#13;
&#13;
<p>We could continue this process, extracting the splitter lambda to the top level.&#13;
Our lives will be made a bit easier, though, if we have a global value for the splitter, so we select the lambda in <code>readTable</code> and “Introduce Variable” named <code>splitOnComma</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code> <code class="p">-&gt;</code>&#13;
            <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitOnComma</code><code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.43&amp;show=file">Example 22.43 [table-reader.30:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.43&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we can cut the <code>val</code> from the function and move it to the top level.&#13;
It feels like there should be an automated refactor for this, but nothing works at the time of &#13;
<span class="keep-together">writing</span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitOnComma</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.44&amp;show=file">Example 22.44 [table-reader.31:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.44&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that <code>splitOnComma</code> is a global property, we can conveniently use it as a default.&#13;
We select the reference to it in <code>readTable</code> and then “Introduce Parameter”, with “Introduce default value”, calling the new parameter <code>splitter</code>.&#13;
This yields:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitter</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.45&amp;show=file">Example 22.45 [table-reader.32:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.45&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Because of the default value, we haven’t had to change any of the clients, and the tests continue to pass.&#13;
As it stands, <code>readTable</code> is now using the supplied <code>splitter</code>, but <code>headerProviderFrom</code> is not:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">headerProviderFrom</code><code class="p">(</code><code class="n">header</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">header</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">{</code> <code class="n">index</code> <code class="p">-&gt;</code> <code class="n">headers</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.46&amp;show=file">Example 22.46 [table-reader.32:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.46&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Introducing a functional parameter for <code>header.splitFields(...)</code> yields:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">readTableWithHeader</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code>&#13;
</code><code>    </code><code class="k">when</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">emptyList</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">else</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">readTable</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><code class="n">header</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_introduction_CO53-1" id="co_introduction_CO53-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>                </code><code class="n">header</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code><code>&#13;
</code><code>            </code><code class="p">}</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code>&#13;
</code><code class="k">val</code><code> </code><code class="py">splitOnComma</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">String</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code> </code><code class="p">{</code><code> </code><code class="n">line</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code>&#13;
</code><code>    </code><code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="k">private</code><code> </code><code class="k">fun</code><code> </code><code class="nf">headerProviderFrom</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">header</code><code class="p">:</code><code> </code><code class="n">String</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">splitter</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">String</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_introduction_CO53-2" id="co_introduction_CO53-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">Int</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">String</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">val</code><code> </code><code class="py">headers</code><code> </code><code class="p">=</code><code> </code><code class="n">splitter</code><code class="p">(</code><code class="n">header</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code> </code><code class="n">index</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">headers</code><code class="p">[</code><code class="n">index</code><code class="p">]</code><code> </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.47&amp;show=file">Example 22.47 [table-reader.33:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.47&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO53-1" id="callout_introduction_CO53-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This lambda…</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO53-2" id="callout_introduction_CO53-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>…implements the splitter.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now the lambda in <code>readTableWithHeader</code> is the same code as <code>splitOnComma</code>, so we use that instead:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitOnComma</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="p">...</code>&#13;
&#13;
<code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.48&amp;show=file">Example 22.48 [table-reader.34:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.48&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>You can see the pattern here.&#13;
Now we make a parameter from the <code>splitOnComma</code> reference, again with a default to avoid breaking existing clients:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.49&amp;show=file">Example 22.49 [table-reader.35:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.49&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Finally, in <code>readTableWithHeader</code>, we are calling <code>readTable</code> without providing a <code>splitter</code>, so it will use its default (<code>splitOnComma</code>).&#13;
We don’t want this, so we pass the parameter down.&#13;
The header and body should be using the same splitter, so we pass it from <code>readTableWithHeader</code> to the inner <code>readTable</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">readTableWithHeader</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">splitter</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">String</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code> </code><code class="n">splitOnComma</code><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code>&#13;
</code><code>    </code><code class="k">when</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">emptyList</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">else</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">readTable</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">splitter</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">splitter</code><code> </code><a class="co" href="#callout_introduction_CO54-1" id="co_introduction_CO54-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="k">fun</code><code> </code><code class="nf">readTable</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">headerProvider</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">Int</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">String</code><code> </code><code class="p">=</code><code> </code><code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">splitter</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">String</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code> </code><code class="n">splitOnComma</code><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">.</code><code class="n">map</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code><code> </code><code class="n">headerProvider</code><code class="p">,</code><code> </code><code class="n">splitter</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.50&amp;show=file">Example 22.50 [table-reader.36:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.50&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO54-1" id="callout_introduction_CO54-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Pass on the <code>splitter</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Some test-driven developers might insist on a failing test to show the need for that last step.&#13;
We certainly should write a test to demonstrate the use of the splitter, but before we do, let’s make it more convenient to make one.&#13;
Here is <code>splitOnComma</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.51&amp;show=file">Example 22.51 [table-reader.36:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.51&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It would be nice to be able to create splitters without having to define a lambda every time.&#13;
That way, our French clients could call <code>readTable</code> with, for example, <code>splitter = splitOn(";")</code>.&#13;
The <code>splitOn</code> function would take the separators and return a value of function type <code>(String) -&gt; List&lt;String&gt;</code>.&#13;
We could try to extract this function from our current <code>splitOnComma</code> lambda, but the refactoring is tedious, so instead let’s just define the function and call it:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">splitOn</code><code class="p">(</code>&#13;
    <code class="n">separators</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">):</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code><code class="p">:</code> <code class="n">String</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="n">separators</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOn</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="k">val</code> <code class="py">splitOnTab</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOn</code><code class="p">(</code><code class="s">"\t"</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.52&amp;show=file">Example 22.52 [table-reader.37:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.52&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>You can see that we have taken the opportunity to define a <code>splitOnTab</code>, too, so that we can use it in the new test we promised ourselves that we would write:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">can</code> <code class="n">specify</code> <code class="n">splitter</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">mapOf</code><code class="p">(</code>&#13;
                <code class="s">"header1"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code>&#13;
                <code class="s">"header2"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">,</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
            <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="s">"header1\theader2"</code><code class="p">,</code>&#13;
                <code class="s">"field0\tfield1"</code>&#13;
            <code class="p">),</code>&#13;
            <code class="n">splitOnTab</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.53&amp;show=file">Example 22.53 [table-reader.38:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.53&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This passes, giving us both reassurance and documentation.&#13;
Let’s check it in and take a break for a few minutes before coming back to take stock.<a data-primary="" data-startref="CFdiff22" data-type="indexterm" id="idm46393346125256"/><a data-primary="" data-startref="field22" data-type="indexterm" id="idm46393346124280"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sequences" data-type="sect1"><div class="sect1" id="idm46393347813112">&#13;
<h1>Sequences</h1>&#13;
&#13;
<p>We<a data-primary="classes to functions" data-secondary="sequences" data-type="indexterm" id="CFseq22"/><a data-primary="sequences" data-type="indexterm" id="seq22"/> now have the basics of a table parser, and we haven’t introduced any new types beyond those in the standard Kotlin runtime.&#13;
This is often the way with a more functional approach.&#13;
The grain of Kotlin is to leverage the rich abstractions provided by the standard library, where Java programs are more likely to define new types.&#13;
As we saw in <a data-type="xref" href="ch06.html#java-to-kotlin-collections">Chapter 6</a> and <a data-type="xref" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15</a>, one reason for the difference is that Kotlin allows us to treat collections as values, which makes them more safely composable than Java’s mutable objects.&#13;
We are able to define an API that takes and returns collection types without worrying about aliasing.</p>&#13;
&#13;
<p>Value types may make for APIs composed of predictable calculations, but they can bring their own problems.&#13;
Our naïve API suffers from the same issue as we saw in <a data-type="xref" href="ch20.html#performing-io-to-passing-data">Chapter 20</a>: it works on a <code>List&lt;String&gt;</code> loaded into memory and produces a <code>List&lt;Map&lt;String, String&gt;&gt;</code> also in memory.&#13;
Even discounting the cost of the data structures, the memory footprint of <code>readTable</code> is twice the number of bytes of the input, which is (probably) twice the size of a UTF-8 encoded file containing the data.&#13;
To process large files, it would be nice to work in terms of sequences rather than in terms of lists, since if-necessary sequences can keep only one item in each stage of a pipeline in memory at a time.</p>&#13;
&#13;
<p>As we saw in <a data-type="xref" href="ch13.html#streams-to-sequences">Chapter 13</a>, we can convert a <code>Sequence</code> to a <code>List</code> and back (with some caveats) very easily, so we could implement <code>Sequence</code> functions by delegating to our existing <code>List</code> API.&#13;
This wouldn’t reduce our memory footprint though, so instead we’ll write the <code>Sequence</code> versions and delegate the <code>List</code> versions to them.&#13;
If we’re clever, we can test through the convenient <code>List</code> API, thus getting two sets of tests for the price of one.</p>&#13;
&#13;
<p><code>readTable</code> currently looks like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitter</code><code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.54&amp;show=file">Example 22.54 [table-reader.39:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.54&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can try out our plan by converting to and from <code>Sequence</code> in the middle of the pipeline:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
            <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitter</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">toList</code><code class="p">()</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.55&amp;show=file">Example 22.55 [table-reader.40:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.55&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That passes the tests, and they all funnel through this function, so that’s reassuring.&#13;
Now we can extract the inner workings into a function taking and returning a <code>Sequence</code>; this is extracting part of a chain as described in <a data-type="xref" href="ch13.html#extracting-part-of-a-pipeline">“Extracting Part of a Pipeline”</a>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">readTable</code><code class="p">(</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">(),</code>&#13;
        <code class="n">headerProvider</code><code class="p">,</code>&#13;
        <code class="n">splitter</code>&#13;
    <code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">)</code> <code class="p">=</code> <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitter</code><code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.56&amp;show=file">Example 22.56 [table-reader.41:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.56&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This gives us a <code>Sequence</code> version of <code>readTable</code> that the <code>List</code> version calls, and the <code>List</code> version is well tested.&#13;
Now for the outer <code>readTableWithHeader</code>.&#13;
It looks like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.57&amp;show=file">Example 22.57 [table-reader.42:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.57&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Currently, <code>readTableWithHeader</code> is delegating to the <code>List</code> version of <code>readTable</code>.&#13;
If we want to produce a <code>Sequence</code> version (and we do), it should call the <code>Sequence</code> version of <code>readTable</code>, so we inline the call here to give:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">).</code><code class="n">asSequence</code><code class="p">(),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.58&amp;show=file">Example 22.58 [table-reader.43:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.58&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now, by hand, create a <code>linesAsSequence</code> as a variable and use it in place of <code>lines</code>.&#13;
This nearly works:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">readTableWithHeader</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">lines</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">splitter</code><code class="p">:</code><code> </code><code class="p">(</code><code class="n">String</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code><code> </code><code class="p">=</code><code> </code><code class="n">splitOnComma</code><code>&#13;
</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code><code> </code><code class="n">String</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">val</code><code> </code><code class="py">linesAsSequence</code><code> </code><code class="p">=</code><code> </code><code class="n">lines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="k">when</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">linesAsSequence</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="n">emptySequence</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO55-1" id="co_introduction_CO55-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">else</code><code> </code><code class="p">-</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code>&#13;
</code><code>            </code><code class="n">readTable</code><code class="p">(</code><code>&#13;
</code><code>                </code><code class="n">linesAsSequence</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">linesAsSequence</code><code class="p">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">splitter</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="n">splitter</code><code>&#13;
</code><code>            </code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="p">}</code><code class="p">.</code><code class="n">toList</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.59&amp;show=file">Example 22.59 [table-reader.44:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.59&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO55-1" id="callout_introduction_CO55-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Doesn’t compile because there is no <code>Sequence&lt;T&gt;.isEmpty()</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>How do we tell if a <code>Sequence</code> is empty?&#13;
<code>linesAsSequence.firstOrNull() == null</code> does the trick:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">linesAsSequence</code> <code class="p">=</code> <code class="n">lines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">linesAsSequence</code><code class="p">.</code><code class="n">firstOrNull</code><code class="p">()</code> <code class="p">==</code> <code class="k">null</code> <code class="p">-&gt;</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="p">{</code>&#13;
            <code class="n">readTable</code><code class="p">(</code>&#13;
                <code class="n">linesAsSequence</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
                <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">linesAsSequence</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
                <code class="n">splitter</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}.</code><code class="n">toList</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.60&amp;show=file">Example 22.60 [table-reader.45:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.60&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This passes the tests, so we can again extract the expression between the <code>return</code> and <code>.toList()</code> as the function we are looking for.&#13;
After extracting it and tidying up, we have the <code>Sequence</code> version of <code>readTableWithHeader</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">(),</code>&#13;
        <code class="n">splitter</code>&#13;
    <code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">)</code> <code class="p">=</code> <code class="k">when</code> <code class="p">{</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">firstOrNull</code><code class="p">()</code> <code class="p">==</code> <code class="k">null</code> <code class="p">-&gt;</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
    <code class="k">else</code> <code class="p">-&gt;</code> <code class="p">{</code>&#13;
        <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.61&amp;show=file">Example 22.61 [table-reader.46:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.61&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>At this point, we have two versions of <code>readTable</code> and <code>readTableWithHeader</code>: a <code>List</code> and a <code>Sequence</code> version of each.&#13;
Given how easy it is to convert a <code>List</code> argument to a <code>Sequence</code>, and a <code>Sequence</code> result to a <code>List</code>, maybe the <code>List</code> variants aren’t paying their way?&#13;
Let’s just move their definitions into the tests while we don’t have any production uses.&#13;
That way, the tests can use them to stay simple, and the production code is kept minimal.</p>&#13;
&#13;
<p>Here, then, is the entire public interface to our<a data-primary="table parsers" data-type="indexterm" id="idm46393345094168"/> table parser:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">firstOrNull</code><code class="p">()</code> <code class="p">==</code> <code class="k">null</code> <code class="p">-&gt;</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitter</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOn</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="k">val</code> <code class="py">splitOnTab</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOn</code><code class="p">(</code><code class="s">"\t"</code><code class="p">)</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">splitOn</code><code class="p">(</code>&#13;
    <code class="n">separators</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code><code class="p">:</code> <code class="n">String</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="n">separators</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.62&amp;show=file">Example 22.62 [table-reader.47:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.62&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is supported by three utility functions:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">headerProviderFrom</code><code class="p">(</code>&#13;
    <code class="n">header</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">):</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">splitter</code><code class="p">(</code><code class="n">header</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">{</code> <code class="n">index</code> <code class="p">-&gt;</code> <code class="n">headers</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">parseLine</code><code class="p">(</code>&#13;
    <code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
<code class="p">):</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">values</code> <code class="p">=</code> <code class="n">splitter</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">keys</code> <code class="p">=</code> <code class="n">values</code><code class="p">.</code><code class="n">indices</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">headerProvider</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">keys</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">toMap</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Necessary because String.split returns a list of an empty string</code>&#13;
<code class="c1">// when called on an empty string.</code>&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">String</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="n">separators</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">isEmpty</code><code class="p">())</code> <code class="n">emptyList</code><code class="p">()</code> <code class="k">else</code> <code class="n">split</code><code class="p">(</code><code class="n">separators</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.63&amp;show=file">Example 22.63 [table-reader.47:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.63&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>When we looked back at the code, we realized that it wasn’t clear <em>why</em> we needed <code>splitFields</code>, so we added a comment.&#13;
It’s often easier to do this in retrospect when we are trying to understand code we are returning to, rather than code we have just written.&#13;
Apart from that, we think that the code is pretty self-explanatory.&#13;
Sometimes we’re wrong about that.&#13;
If it takes us more than a glance to work out what is going on next time we read this code, we’ll take the opportunity then to add more comments or, better, refactor to be more expressive.<a data-primary="" data-startref="CFseq22" data-type="indexterm" id="idm46393344605112"/><a data-primary="" data-startref="seq22" data-type="indexterm" id="idm46393344604136"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reading from a File" data-type="sect1"><div class="sect1" id="idm46393347812856">&#13;
<h1>Reading from a File</h1>&#13;
&#13;
<p>This<a data-primary="classes to functions" data-secondary="reading from files" data-type="indexterm" id="CFread22"/><a data-primary="files, reading from" data-type="indexterm" id="fread22"/> seems a fine interface in the abstract, but the first time we come to use it in anger, we hit on a snag.&#13;
Let’s illustrate the problem with a test.&#13;
This calls the <code>Sequence</code> version of <code>readTableWithHeader</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">read</code> <code class="n">from</code> <code class="n">reader</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">fileContents</code> <code class="p">=</code> <code class="s">"""</code>&#13;
        <code class="n">H0</code><code class="p">,</code><code class="n">H1</code>&#13;
        <code class="n">row0field0</code><code class="p">,</code><code class="n">row0field1</code>&#13;
        <code class="n">row1field0</code><code class="p">,</code><code class="n">row1field1</code>&#13;
    <code class="s">""".trimIndent()</code>&#13;
    <code class="n">StringReader</code><code class="p">(</code><code class="n">fileContents</code><code class="p">).</code><code class="n">useLines</code> <code class="p">{</code> <code class="n">lines</code> <code class="p">-&gt;</code>&#13;
        <code class="k">val</code> <code class="py">result</code> <code class="p">=</code> <code class="n">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code>&#13;
            <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="n">mapOf</code><code class="p">(</code><code class="s">"H0"</code> <code class="n">to</code> <code class="s">"row0field0"</code><code class="p">,</code> <code class="s">"H1"</code> <code class="n">to</code> <code class="s">"row0field1"</code><code class="p">),</code>&#13;
                <code class="n">mapOf</code><code class="p">(</code><code class="s">"H0"</code> <code class="n">to</code> <code class="s">"row1field0"</code><code class="p">,</code> <code class="s">"H1"</code> <code class="n">to</code> <code class="s">"row1field1"</code><code class="p">)</code>&#13;
            <code class="p">),</code>&#13;
            <code class="n">result</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.64&amp;show=file">Example 22.64 [table-reader.48:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.64&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Can you see why this fails?&#13;
What if we say that it fails with <code>java.lang.IllegalState​Ex⁠ception: This sequence can be consumed only once.</code>?</p>&#13;
&#13;
<p>Yes, once again (<a data-type="xref" href="ch13.html#sequences-multiple-operations">“Multiple Iterations”</a>), <code>Sequence</code>s bite us because we didn’t test both types—those that can and can’t be consumed twice—as input:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">firstOrNull</code><code class="p">()</code> <code class="p">==</code> <code class="k">null</code> <code class="p">-&gt;</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.65&amp;show=file">Example 22.65 [table-reader.47:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.65&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>So <code>lines.firstOrNull()</code> consumes the sequence, and when reading from a <code>Reader</code> we can’t just go back and start again in order to evaluate <code>lines.drop(1)</code> and <code>lines.first()</code>.&#13;
Our unit tests were all starting from a <code>List</code> of all the file lines; those sequences  <em>can</em> be consumed again, because they are held in memory.</p>&#13;
&#13;
<p>To use our <code>Sequence</code> interface on data in files, we will either have to load it all into memory or find a way to fetch the first and rest of a <code>Sequence</code> without trying to read it twice.&#13;
Given that we introduced the <code>Sequence</code> specifically to avoid loading all the data into memory at once, we choose the latter.&#13;
All we need to do then is to check whether a <code>Sequence</code> has any items without consuming it.&#13;
Can you see how?</p>&#13;
&#13;
<p>Ah, that one was a trick question.&#13;
To check, we <em>have</em> to call <code>iterator()</code> on the <code>Sequence</code>, which is the very thing that consumes it.&#13;
We cannot see whether the <code>Sequence</code> is empty and then use it again later.&#13;
Sometimes in logic though, when we can’t do a thing that we want in isolation, we can do it and another thing that we want together.&#13;
In this case, we don’t just want to see whether the <code>Sequence</code> is empty; we want to split it into its head and tail if it isn’t.&#13;
We can achieve that wider goal by destructuring the <code>Sequence</code> with a function like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="err">&lt;</code><code class="nf">T</code><code class="p">&gt;</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;.</code><code class="n">destruct</code><code class="p">()</code>&#13;
    <code class="p">:</code> <code class="n">Pair</code><code class="p">&lt;</code><code class="n">T</code><code class="p">,</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;&gt;?</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">iterator</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">iterator</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">iterator</code><code class="p">.</code><code class="n">hasNext</code><code class="p">()</code> <code class="p">-&gt;</code>&#13;
            <code class="n">iterator</code><code class="p">.</code><code class="n">next</code><code class="p">()</code> <code class="n">to</code> <code class="n">iterator</code><code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="k">null</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.66&amp;show=file">Example 22.66 [table-reader.49:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.66&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This <code>destruct</code> returns <code>null</code> if the <code>Sequence</code> is empty; otherwise, it returns a <code>Pair</code> of the head and the tail (where the tail may be an empty <code>Sequence</code>).&#13;
It consumes the original (by calling <code>iterator()</code>) but provides a fresh <code>Sequence</code> to continue processing.&#13;
We can use it to refactor <code>readTableWithHeader</code>, currently:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">firstOrNull</code><code class="p">()</code> <code class="p">==</code> <code class="k">null</code> <code class="p">-&gt;</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">),</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">lines</code><code class="p">.</code><code class="n">first</code><code class="p">(),</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.67&amp;show=file">Example 22.67 [table-reader.48:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.67&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It certainly isn’t a trivial rearrangement, but we can transform this into:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">firstAndRest</code> <code class="p">=</code> <code class="n">lines</code><code class="p">.</code><code class="n">destruct</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="k">when</code> <code class="p">{</code>&#13;
        <code class="n">firstAndRest</code> <code class="p">==</code> <code class="k">null</code> <code class="p">-&gt;</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
        <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">firstAndRest</code><code class="p">.</code><code class="n">second</code><code class="p">,</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">firstAndRest</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.68&amp;show=file">Example 22.68 [table-reader.49:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.68&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The new form passes all the tests, because it doesn’t consume <code>lines</code> more than once.&#13;
If<a data-primary="?.let expression" data-type="indexterm" id="idm46393344082072"/> it feels a little clunky, we can combine a <code>?.let</code>, destructuring, and an Elvis operator to give a single expression that you may or may not find acceptably terse.&#13;
The result is this public API:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">destruct</code><code class="p">()</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="p">(</code><code class="n">first</code><code class="p">,</code> <code class="n">rest</code><code class="p">)</code> <code class="p">-&gt;</code>&#13;
        <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">rest</code><code class="p">,</code>&#13;
            <code class="n">headerProviderFrom</code><code class="p">(</code><code class="n">first</code><code class="p">,</code> <code class="n">splitter</code><code class="p">),</code>&#13;
            <code class="n">splitter</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code> <code class="o">?:</code> <code class="n">emptySequence</code><code class="p">()</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">headerProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code>&#13;
        <code class="n">parseLine</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">headerProvider</code><code class="p">,</code> <code class="n">splitter</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">val</code> <code class="py">splitOnComma</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOn</code><code class="p">(</code><code class="s">","</code><code class="p">)</code>&#13;
<code class="k">val</code> <code class="py">splitOnTab</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOn</code><code class="p">(</code><code class="s">"\t"</code><code class="p">)</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">splitOn</code><code class="p">(</code>&#13;
    <code class="n">separators</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code> <code class="p">=</code> <code class="p">{</code> <code class="n">line</code><code class="p">:</code> <code class="n">String</code> <code class="p">-&gt;</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">splitFields</code><code class="p">(</code><code class="n">separators</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.69&amp;show=file">Example 22.69 [table-reader.50:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.69&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We are almost done, we promise.</p>&#13;
&#13;
<p>The last step, now that the API has crystallized around two functions, is to take the opportunity to make the tests more expressive:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">TableReaderTests</code> <code class="p">{</code>&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="err">`</code><code class="nf">empty</code> <code class="n">input</code> <code class="n">returns</code> <code class="n">empty</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">checkReadTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">(),</code>&#13;
            <code class="n">shouldReturn</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="err">`</code><code class="nf">one</code> <code class="n">line</code> <code class="n">of</code> <code class="n">input</code> <code class="n">with</code> <code class="n">default</code> <code class="n">field</code> <code class="n">names</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">checkReadTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"field0,field1"</code><code class="p">),</code>&#13;
            <code class="n">shouldReturn</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="n">mapOf</code><code class="p">(</code><code class="s">"0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="err">`</code><code class="nf">can</code> <code class="n">specify</code> <code class="n">header</code> <code class="n">names</code> <code class="k">when</code> <code class="n">there</code> <code class="k">is</code> <code class="n">no</code> <code class="n">header</code> <code class="n">row</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"apple"</code><code class="p">,</code> <code class="s">"banana"</code><code class="p">)</code>&#13;
        <code class="n">checkReadTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"field0,field1"</code><code class="p">),</code>&#13;
            <code class="n">withHeaderProvider</code> <code class="p">=</code> <code class="n">headers</code><code class="o">::</code><code class="k">get</code><code class="p">,</code>&#13;
            <code class="n">shouldReturn</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="n">mapOf</code><code class="p">(</code>&#13;
                    <code class="s">"apple"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code>&#13;
                    <code class="s">"banana"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">,</code>&#13;
                <code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="err">`</code><code class="nf">readTableWithHeader</code> <code class="n">takes</code> <code class="n">headers</code> <code class="n">from</code> <code class="n">header</code> <code class="n">line</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">checkReadTableWithHeader</code><code class="p">(</code>&#13;
            <code class="n">lines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="s">"H0,H1"</code><code class="p">,</code>&#13;
                <code class="s">"field0,field1"</code>&#13;
            <code class="p">),</code>&#13;
            <code class="n">shouldReturn</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="n">mapOf</code><code class="p">(</code><code class="s">"H0"</code> <code class="n">to</code> <code class="s">"field0"</code><code class="p">,</code> <code class="s">"H1"</code> <code class="n">to</code> <code class="s">"field1"</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">checkReadTable</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">withHeaderProvider</code><code class="p">:</code> <code class="p">(</code><code class="n">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code> <code class="n">Int</code><code class="o">::</code><code class="n">toString</code><code class="p">,</code>&#13;
    <code class="n">shouldReturn</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;,</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">shouldReturn</code><code class="p">,</code>&#13;
        <code class="n">readTable</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">().</code><code class="n">constrainOnce</code><code class="p">(),</code>&#13;
            <code class="n">headerProvider</code> <code class="p">=</code> <code class="n">withHeaderProvider</code><code class="p">,</code>&#13;
            <code class="n">splitter</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
        <code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">checkReadTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">withSplitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code><code class="p">,</code>&#13;
    <code class="n">shouldReturn</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;,</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">shouldReturn</code><code class="p">,</code>&#13;
        <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
            <code class="n">lines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">().</code><code class="n">constrainOnce</code><code class="p">(),</code>&#13;
            <code class="n">splitter</code> <code class="p">=</code> <code class="n">withSplitter</code>&#13;
        <code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.70&amp;show=file">Example 22.70 [table-reader.52:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.70&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is an important step.&#13;
As we saw in <a data-type="xref" href="ch17.html#mocks-to-maps">Chapter 17</a>, finding the patterns in our tests and expressing them in functions (like <code>checkReadTable</code>) both help readers of the tests to see what the code is doing and can help us find gaps in our test coverage.&#13;
For example, what is the behavior of our parser when there are more fields than headers or vice versa?&#13;
The tests that we write for quick feedback while we are test-driving our implementation are unlikely to be optimally effective for communicating about the API, finding issues, or catching regressions if we return to the implementation and modify it.&#13;
If we use TDD as a design technique, we mustn’t forget to make sure that the final tests are fit for determining correctness, adding documentation, and preventing regression.<a data-primary="" data-startref="fread22" data-type="indexterm" id="idm46393343884552"/><a data-primary="" data-startref="CFread22" data-type="indexterm" id="idm46393343496232"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Comparison with Commons CSV" data-type="sect1"><div class="sect1" id="idm46393344602280">&#13;
<h1>Comparison with Commons CSV</h1>&#13;
&#13;
<p>We<a data-primary="classes to functions" data-secondary="comparison with Commons CSV" data-type="indexterm" id="CFcomp22"/><a data-primary="Commons CSV library" data-type="indexterm" id="commonsCSV22"/><a data-primary="Apache Commons CSV library" data-type="indexterm" id="acoommonsCSV22"/> started this chapter by saying that in most real-world situations, we would reach for Apache Commons CSV rather than rolling our own parser.&#13;
Before we finish the chapter, let’s compare our API with that of the Commons equivalent.</p>&#13;
&#13;
<p>The most common use case for a table parser is to read a file with known columns, translating each row into some data class.&#13;
Here is how we do that with our parser:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="nf">example</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">reader</code><code class="p">.</code><code class="n">useLines</code> <code class="p">{</code> <code class="n">lines</code> <code class="p">-&gt;</code>&#13;
        <code class="k">val</code> <code class="py">measurements</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Measurement</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
            <code class="n">readTableWithHeader</code><code class="p">(</code><code class="n">lines</code><code class="p">,</code> <code class="n">splitOnComma</code><code class="p">)</code>&#13;
                <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
                    <code class="n">Measurement</code><code class="p">(</code>&#13;
                        <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                            <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
                        <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                            <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
                        <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                            <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
                    <code class="p">)</code>&#13;
                <code class="p">}</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code>&#13;
            <code class="n">expected</code><code class="p">,</code>&#13;
            <code class="n">measurements</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.71&amp;show=file">Example 22.71 [table-reader.53:src/test/java/travelator/tablereader/CsvExampleTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.71&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Real-world code would probably need more error handling (we see how in <a data-type="xref" href="ch21.html#exceptions-to-values">Chapter 21</a>), but this shows the basic use case.&#13;
We use the Kotlin <code>Reader.useLines</code> extension function to produce a <code>Sequence&lt;String&gt;</code>, which our parser transforms into a <code>Sequence&lt;Map&lt;String, String&gt;&gt;</code>.&#13;
We can <code>map</code> over the <code>Map</code>s, indexing by field name to extract the data we need and transform it to the type (<code>Measurement</code>) that we actually want.&#13;
This design didn’t happen by accident—it was the decisions that we made at the very start, albeit with <code>List</code> rather than with <code>Sequence</code> at the time.</p>&#13;
&#13;
<p>Here is the Commons CSV version:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">commons</code> <code class="n">csv</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">reader</code><code class="p">.</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="k">val</code> <code class="py">parser</code> <code class="p">=</code> <code class="n">CSVParser</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code>&#13;
            <code class="n">reader</code><code class="p">,</code>&#13;
            <code class="n">CSVFormat</code><code class="p">.</code><code class="n">DEFAULT</code><code class="p">.</code><code class="n">withFirstRecordAsHeader</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
        <code class="k">val</code> <code class="py">measurements</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Measurement</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">parser</code>&#13;
            <code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
                <code class="n">Measurement</code><code class="p">(</code>&#13;
                    <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                        <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
                    <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                        <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
                    <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                        <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
                <code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code>&#13;
            <code class="n">expected</code><code class="p">,</code>&#13;
            <code class="n">measurements</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.72&amp;show=file">Example 22.72 [table-reader.53:src/test/java/travelator/tablereader/CsvExampleTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.72&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It too has a static function entry point, <code>CSVParser.parse</code>, which also takes configuration about the table format (in this case, <code>CSVFormat.DEFAULT.withFirstRecord​A⁠sHeader()</code>; in ours, <code>splitOnComma</code>).&#13;
We have two functions to differentiate between files with or without headers; the Apache API rolls this into the <code>CSVFormat</code>.</p>&#13;
&#13;
<p>The Commons <code>parse</code> takes a <code>Reader</code> though, rather than our <code>Sequence&lt;String&gt;</code>.&#13;
This allows it to handle record separators other than newline, and cope with having new lines in the middle of fields, but leads to a proliferation of <code>parse</code> methods. There are variants taking <code>Path</code>, <code>File</code>, <code>InputStream</code>, <code>String</code>, and <code>URL</code>.&#13;
The developers probably felt these were necessary because Java provides so little support for converting between these types of sources and disposing of them safely.&#13;
The <code>CSVParser</code> returned by the <code>parse</code> static method has a lot of code to manage resources.&#13;
Our API delegates these to the workings of <code>Sequence</code> and Kotlin life cycle functions like <code>use</code> and <code>useLines</code>.</p>&#13;
&#13;
<p>On the subject of lines, you have to read between them in the code example to see it, but <code>CSVParser</code> implements <code>Iterable&lt;CSVRecord&gt;</code>.&#13;
This is a clever design choice, because it allows Java developers to use a <code>for</code> statement to loop over the records, and Kotlin developers to convert to a <code>Sequence</code> with <code>.asSequence</code>.&#13;
In fact, the Kotlin usability is due to the design of the Kotlin standard library, which builds on the same <code>Iterable</code> abstraction that the Apache developers also leverage.</p>&#13;
&#13;
<p>Moving on, the code to create an individual <code>Measurement</code> looks identical in both &#13;
<span class="keep-together">examples</span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
    <code class="n">Measurement</code><code class="p">(</code>&#13;
        <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
            <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
        <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
            <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
        <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
            <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.73&amp;show=file">Example 22.73 [table-reader.53:src/test/java/travelator/tablereader/CsvExampleTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.73&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Although the type of <code>record</code> in our parser is <code>Map&lt;String, String&gt;</code>, in the Commons case it is <code>CSVRecord</code>.&#13;
<code>CSVRecord</code> has a <code>get(String)</code> method, which is how <code>record["time"]</code> and so on are resolved.&#13;
It also has methods: <code>get(int)</code> to retrieve a field by index, where we could use <code>Map.values.get(Int)</code>;&#13;
<code>size()</code> rather than <code>Map.size()</code>; and <code>isSet(String)</code> to substitute for <code>Map.hasKey(String)</code>.</p>&#13;
&#13;
<p>Basically, <code>CSVRecord</code> is having to reproduce the <code>Map</code> interface by hand rather than just <em>being</em> a <code>Map</code>.&#13;
Why?&#13;
Because, as we discussed in <a data-type="xref" href="ch06.html#java-to-kotlin-collections">Chapter 6</a>, the Java <code>Map</code> interface is mutable, and mutation makes no sense in the context of reading fields from a file; mutations certainly aren’t going to be written back to the source.&#13;
When programming in Java, we find ourselves having to create new types to solve problems, where in Kotlin we can express ourselves in standard types and then enjoy the richness of the Kotlin API on those types.</p>&#13;
&#13;
<p>One area in which the Commons CSV library Excels™️ is its provision of ready-made parser defaults.&#13;
These are expressed as constants in the <code>CSVFormat</code> class.&#13;
We’ve seen <code>CSVFormat.DEFAULT</code>, but there are many others, including <code>CSVFormat.EXCEL</code>.&#13;
Armed with a <code>CSVFormat</code>, you can pass it to the <code>CSVParser.parse</code> method as we saw, or use it directly, for example, <code>CSVFormat.EXCEL.parse(reader)</code>.&#13;
Can we provide this facility without defining new types in our API?&#13;
How about using <code>splitOnComma</code> as if it was our configuration:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">configuration</code> <code class="n">example</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">reader</code><code class="p">.</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="k">val</code> <code class="py">measurements</code> <code class="p">=</code> <code class="n">splitOnComma</code><code class="p">.</code><code class="n">readTableWithHeader</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code>&#13;
            <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">record</code> <code class="p">-&gt;</code>&#13;
                <code class="n">Measurement</code><code class="p">(</code>&#13;
                    <code class="n">t</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"time"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                        <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in time"</code><code class="p">),</code>&#13;
                    <code class="n">x</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"x"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                        <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in x"</code><code class="p">),</code>&#13;
                    <code class="n">y</code> <code class="p">=</code> <code class="n">record</code><code class="p">[</code><code class="s">"y"</code><code class="p">]</code><code class="o">?.</code><code class="n">toDoubleOrNull</code><code class="p">()</code>&#13;
                        <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"in y"</code><code class="p">),</code>&#13;
                <code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code>&#13;
            <code class="n">expected</code><code class="p">,</code>&#13;
            <code class="n">measurements</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.74&amp;show=file">Example 22.74 [table-reader.54:src/test/java/travelator/tablereader/CsvExampleTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.74&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can achieve this by defining <code>splitOnComma.readTableWithHeader(reader)</code> as an extension function on the function type:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="err">((</code><code class="nf">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;).</code><code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">reader</code><code class="p">:</code> <code class="n">StringReader</code>&#13;
<code class="p">):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="p">=</code>&#13;
    <code class="n">readTableWithHeader</code><code class="p">(</code><code class="n">reader</code><code class="p">.</code><code class="n">buffered</code><code class="p">().</code><code class="n">lineSequence</code><code class="p">(),</code> <code class="k">this</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.75&amp;show=file">Example 22.75 [table-reader.54:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.75&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>In reality, <code>CSVFormat</code> represents a whole package of strategies for escaping rules, what to do with blank lines, and so on, not just how to split a line.&#13;
When our parser grows these facilities, then we will probably want to create a data class to collect them.&#13;
Until that point, we have been able to progress using just the built-in types and Kotlin language features.</p>&#13;
&#13;
<p>There is another useful feature that the Commons interface provides that ours doesn’t, and that we will finally need to create a type to implement.&#13;
Commons CSV has <code>CSVParser.getHeaderNames</code> to provide access to the header information.&#13;
Can we add this facility without modifying our current API, or at least requiring changes to our client code?</p>&#13;
&#13;
<p>For many inputs, we could just call <code>Map.keys</code> on the first of the output <code>Sequence</code>, but this won’t work if the table has no data rows, only a header.&#13;
To return header information <em>and</em> the parsed records, we could return a <code>Pair&lt;List&lt;String&gt;, Sequence&lt;Map&lt;String, String&gt;&gt;</code>, but this will force our current clients to discard the first of the pair.&#13;
Instead, we can return a type <code>Table</code> that implements <code>Sequence&lt;Map&lt;String, String&gt;&gt;</code> but also has a header property.&#13;
This way, all our current callers remain unchanged, but we can access <code>headers</code> when required:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">Table</code> <code class="n">contains</code> <code class="n">headers</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">result</code><code class="p">:</code> <code class="n">Table</code> <code class="p">=</code> <code class="n">readTableWithHeader</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="s">"H0,H1"</code><code class="p">,</code>&#13;
            <code class="s">"field0,field1"</code>&#13;
        <code class="p">).</code><code class="n">asSequence</code><code class="p">()</code>&#13;
    <code class="p">)</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code><code class="s">"H0"</code><code class="p">,</code> <code class="s">"H1"</code><code class="p">),</code>&#13;
        <code class="n">result</code><code class="p">.</code><code class="n">headers</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="err">`</code><code class="nf">Table</code> <code class="n">contains</code> <code class="n">empty</code> <code class="n">headers</code> <code class="k">for</code> <code class="n">empty</code> <code class="n">input</code><code class="err">`</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">emptyList</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;(),</code>&#13;
        <code class="n">readTableWithHeader</code><code class="p">(</code><code class="n">emptySequence</code><code class="p">()).</code><code class="n">headers</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.76&amp;show=file">Example 22.76 [table-reader.55:src/test/java/travelator/tablereader/TableReaderTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.76&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We’ll spare you the refactoring steps, but here is the implementation:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Table</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">headers</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">records</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">Map</code><code class="p">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="p">&gt;&gt;</code> <code class="k">by</code> <code class="n">records</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">readTableWithHeader</code><code class="p">(</code>&#13;
    <code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">splitOnComma</code>&#13;
<code class="p">):</code> <code class="n">Table</code> <code class="p">=</code>&#13;
    <code class="n">lines</code><code class="p">.</code><code class="n">destruct</code><code class="p">()</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="p">(</code><code class="n">first</code><code class="p">,</code> <code class="n">rest</code><code class="p">)</code> <code class="p">-&gt;</code>&#13;
        <code class="n">tableOf</code><code class="p">(</code><code class="n">splitter</code><code class="p">,</code> <code class="n">first</code><code class="p">,</code> <code class="n">rest</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="o">?:</code> <code class="n">Table</code><code class="p">(</code><code class="n">emptyList</code><code class="p">(),</code> <code class="n">emptySequence</code><code class="p">())</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">tableOf</code><code class="p">(</code>&#13;
    <code class="n">splitter</code><code class="p">:</code> <code class="p">(</code><code class="n">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">first</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">rest</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">):</code> <code class="n">Table</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">headers</code> <code class="p">=</code> <code class="n">splitter</code><code class="p">(</code><code class="n">first</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">sequence</code> <code class="p">=</code> <code class="n">readTable</code><code class="p">(</code>&#13;
        <code class="n">lines</code> <code class="p">=</code> <code class="n">rest</code><code class="p">,</code>&#13;
        <code class="n">headerProvider</code> <code class="p">=</code> <code class="n">headers</code><code class="o">::</code><code class="k">get</code><code class="p">,</code>&#13;
        <code class="n">splitter</code> <code class="p">=</code> <code class="n">splitter</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">Table</code><code class="p">(</code><code class="n">headers</code><code class="p">,</code> <code class="n">sequence</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=22.77&amp;show=file">Example 22.77 [table-reader.55:src/main/java/travelator/tablereader/table-reading.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=22.77&amp;show=diff">(diff)</a>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393343494504">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>In<a data-primary="" data-startref="CFcomp22" data-type="indexterm" id="idm46393342532536"/><a data-primary="" data-startref="commonsCSV22" data-type="indexterm" id="idm46393342531528"/><a data-primary="" data-startref="acoommonsCSV22" data-type="indexterm" id="idm46393342530584"/> this final leg of our journey, we allowed ourselves the luxury of writing Kotlin from scratch rather than refactoring our existing Java.&#13;
Even then, we started from the tests and then just copied the test data into our implementation and refactored from there.&#13;
We can’t write all code this way, but it does work well when our code is just calculations, and the more of it that is just calculations, the better our code works, too.</p>&#13;
&#13;
<p>We saw the power of reusing built-in types in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15, <em>Encapsulated Collections to Type Aliases</em></a>, and <a data-type="xref" data-xrefstyle="chap-num-title" href="ch16.html#interfaces-to-functions">Chapter 16, <em>Interfaces to Functions</em></a>, and defining APIs as extension functions in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch10.html#functions-to-extension-functions">Chapter 10, <em>Functions to Extension Functions</em></a>.&#13;
In this example, both collection and function types came together nicely, and we even managed to define an extension function on a function type!&#13;
Where we would have had to define new classes to encapsulate Java’s mutable collections, and methods to manipulate those collections, we passed Kotlin’s immutable collections between our functions and wrote application-specific extensions on those collection types.&#13;
Where we would have needed to define interfaces in Java, we used Kotlin’s function types.</p>&#13;
&#13;
<p>Again, not all problems can or should be solved this way, but your authors have found that while it is hard to make Java bend in this direction, Kotlin features combine to actively encourage this style.&#13;
We shouldn’t get hung up on not defining new types, but neither should we leap to solve every problem with a new class.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>