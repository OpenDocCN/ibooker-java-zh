<html><head></head><body>
<div id="sbo-rt-content" class="calibre2"><section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3"><div class="preface" id="ch_app_monitoring">
<h1 class="calibre17" id="5N3C4-2d714b853a094e9a910510217e0e3d73"><span class="keep-together">Chapter 2. </span>Application Metrics</h1>


<p class="author1"><a data-type="indexterm" data-primary="application metrics" id="ix_ch02-asciidoc0" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The complexity of distributed systems comprised of many communicating microservices means it is especially important to be able to observe the state of the system. The rate of change is high, including new code releases, independent scaling events with changing load, changes to infrastructure (cloud provider changes), and dynamic configuration changes propagating through the system. In this chapter, we will focus on how to measure and alert on the performance of the distributed system and some industry best practices to adopt.</p>

<p class="author1">An organization must commit at a minimum to one or more monitoring solutions. There are a wide range of choices including open source, commercial on-premises, and SaaS offerings with a broad spectrum of capabilities. The market is mature enough that an organization of any size and complexity can find a solution that fits its requirements.</p>

<p class="author1">The choice of monitoring system is important to preserve the fixed-cost characteristic of metrics data. The StatsD protocol, for example, requires an emission to a StatsD agent from an application on a per-event basis. Even if this agent is running as a sidecar process on the same host, the application still suffers the allocation cost of creating the payload on a per-event basis, so this protocol breaks at least this advantage of metrics telemetry. This isn’t always (or even commonly) catastrophic, but be aware of this cost.</p>






</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" class="calibre3" data-pdf-bookmark="Black Box Versus White Box Monitoring"><div class="preface" id="blackbox_whitebox">
<h1 class="calibre19" id="calibre_pb_1">Black Box Versus White Box Monitoring</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="black box versus white box monitoring" id="ix_ch02-asciidoc1" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="black box monitoring" id="ix_ch02-asciidoc2" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="monitoring" data-secondary="black box versus white box" id="ix_ch02-asciidoc3" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="white box monitoring" data-secondary="black box monitoring versus" id="ix_ch02-asciidoc4" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Approaches to metrics collection can be categorized according to what the method is able to observe:</p>
<dl class="calibre20">
<dt class="calibre21">Black box</dt>
<dd class="calibre22">
<p class="calibre23">The collector can observe inputs and outputs (e.g., HTTP requests into a system and responses out of it), but the mechanism of the operation is not known to the collector. Black box collectors somehow intercept or wrap the observed process to measure it.</p>
</dd>
<dt class="calibre21">White box</dt>
<dd class="calibre22">
<p class="calibre23">The collector can observe inputs and outputs and also the internal mechanisms of the operation. White box collectors do this in application code.</p>
</dd>
</dl>

<p class="author1">Many monitoring system vendors provide agents that can be attached to application processes and that provide black box monitoring. Sometimes these agent collectors reach so deep into well-known application frameworks that they start to resemble white box collectors in some ways. Still, black box monitoring in whatever form is limited to what the writer of the agent can generalize about all applications that might apply the agent. For example, an agent might be able to intercept and time Spring Boot’s mechanism for database transactions. An agent will never be able to reason that a <code class="calibre24">java.util.Map</code> field in some class represents a form of near-cache and instrument it as such.</p>

<p class="author1"><a data-type="indexterm" data-primary="service mesh" data-secondary="instrumentation as black box" id="idm45139279506440" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Service-mesh-based instrumentation is also black box and is generally less capable than an agent. While agents can observe and decorate individual method invocations, a service mesh’s finest-grained observation is at the RPC level.</p>

<p class="author1">On the other side, white box collection sounds like a lot of work. Some useful metrics are truly generalizable across applications (e.g., HTTP request timings, CPU utilization) and are well instrumented by black box approaches. A white box instrumentation library with some of these generalizations encapsulated when paired with an application autoconfiguration mechanism resembles a black box approach. White box instrumentation autoconfigured requires the same level of developer effort as black box instrumentation: specifically <em class="calibre12">none</em>!</p>

<p class="author1">Good white box metrics collectors should capture everything that a black box collector does but also support capturing more internal details that black box collectors by definition cannot. The difference between the two for your engineering practices are minimal. For a black box agent, you must alter your delivery practice to package and configure the agent (or couple yourself to a runtime platform integration that does this for you). For autoconfigured white box metrics collection that captures the same set of detail, you must include a binary dependency at build time.</p>

<p class="author1">Vendor-specific instrumentation libraries don’t tend to have this black box feel with a white box approach because framework and library authors aren’t inclined to add a wide range of proprietary instrumentation clients even as optional dependencies and instrument their code N different times. A vendor-neutral instrumentation facade like Micrometer has the advantage of the “write once, publish anywhere” experience for framework and library authors.</p>

<p class="author1">Black box and white box collectors can of course be complementary, even when there is some overlap between them. There is no across-the-boards requirement to choose one over the other.<a data-type="indexterm" data-startref="ix_ch02-asciidoc4" id="idm45139279501160" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc3" id="idm45139279500456" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc2" id="idm45139279499784" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc1" id="idm45139279499112" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Dimensional Metrics" class="calibre3"><div class="preface" id="dimensional_metrics_instrumentation">
<h1 class="calibre19" id="calibre_pb_2">Dimensional Metrics</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="dimensional metrics" id="idm45139279496952" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="dimensional metrics" id="idm45139279495976" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Most modern monitoring systems employ a dimensional naming scheme that consists of a metric name and a series of key-value tags.</p>

<p class="author1">While the storage mechanism varies substantially from one monitoring system to another, in general every unique combination of name and tags is represented as a distinct entry or row in storage. The total cost in storage terms of a metric then is the product of the cardinality of its tag set (meaning the total number of unique key-value tag pairs).</p>

<p class="author1">For example, an application-wide counter metric named <code class="calibre24">http.server.requests</code> that contains a tag for an HTTP method of which only GET and POST are ever observed, an HTTP status code where the service returns one of three status codes, and a URI of which there are two in the application results in up to <math alttext="2 asterisk 3 asterisk 2 equals 12">
  <mrow>
    <mn>2</mn>
    <mo>*</mo>
    <mn>3</mn>
    <mo>*</mo>
    <mn>2</mn>
    <mo>=</mo>
    <mn>12</mn>
  </mrow>
</math> distinct time series sent to and stored in the monitoring system. This metric could be represented in storage roughly like in <a data-type="xref" href="part0006_split_002.html#storage_dimensional_metric" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-1</a>. Coordination between tags, like the fact that only endpoint <code class="calibre24">/a1</code> will ever have a <code class="calibre24">GET</code> method and only <code class="calibre24">/a2</code> will ever have a <code class="calibre24">POST</code> method can limit the total number of unique time series below the theoretical maximum, to only six rows in this example. In many dimensional time series databases, for each row representing a unique set of name and tags, there will be a value <a data-type="indexterm" data-primary="ring buffer" id="idm45139279485560" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>ring buffer that holds the samples for this metric over a defined period of time. When the system contains a bounded ring buffer like this, the total cost of your metrics is fixed to the product of the number of permutations of unique metric names/tags and the size of the ring buffer.</p>
<table id="storage_dimensional_metric" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-1. </span>The storage of a dimensional metric</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric name and tags</th>
<th class="calibre44">Values</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http.server.requests{method=GET,status=200,uri=/a1}</p></td>
<td class="calibre47"><p class="calibre48">[10,11,10,10]</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">http.server.requests{method=GET,status=400,uri=/a1}</p></td>
<td class="calibre47"><p class="calibre48">[1,0,0,0]</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http.server.requests{method=GET,status=500,uri=/a1}</p></td>
<td class="calibre47"><p class="calibre48">[0,0,0,4]</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">http.server.requests{method=POST,status=200,uri=/a2}</p></td>
<td class="calibre47"><p class="calibre48">[10,11,10,10]</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http.server.requests{method=POST,status=400,uri=/a2}</p></td>
<td class="calibre47"><p class="calibre48">[0,0,0,1]</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">http.server.requests{method=POST,status=500,uri=/a2}</p></td>
<td class="calibre47"><p class="calibre48">[1,1,1,1]</p></td>
</tr>
</tbody>
</table>

<p class="author1">In some cases, metrics are periodically moved to long-term storage. At this point, there is an opportunity to squash or drop tags to reduce storage cost at the expense of some dimensional granularity.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Hierarchical Metrics" class="calibre3"><div class="preface" id="hierarchical_metrics">
<h1 class="calibre19" id="calibre_pb_3">Hierarchical Metrics</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="hierarchical metrics" id="idm45139279468488" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="hierarchical metrics" id="idm45139279467288" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Before dimensional metrics systems became popular, many monitoring systems employed a hierarchical scheme. In these systems, metrics were defined only by name, with no key-value tag pairs. Tags are so useful that a convention emerged to append tag-like data to metric names with something like dot separators. So a dimensional metric like <code class="calibre24">httpServerRequests</code>, which has a <code class="calibre24">method</code> tag of <code class="calibre24">GET</code> in a dimensional system, might be represented as <code class="calibre24">httpServerRequests.method.GET</code> in a hierarchical system. Out of this arose query features like wildcard operators to allow simple aggregation across “tags,” as in <a data-type="xref" href="part0006_split_003.html#hierarchical_metrics_aggregation" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-2</a>.</p>
<table id="hierarchical_metrics_aggregation" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-2. </span>Aggregation of hierarchical metrics with wildcards</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric query</th>
<th class="calibre44">Value</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">httpServerRequests.method.GET</p></td>
<td class="calibre47"><p class="calibre48">10</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">httpServerRequests.method.POST</p></td>
<td class="calibre47"><p class="calibre48">20</p></td>
</tr>
<tr class="calibre59">
<td class="calibre47"><p class="calibre48">httpServerRequests.method.*</p></td>
<td class="calibre47"><p class="calibre48">30</p></td>
</tr>
</tbody>
</table>

<p class="author1">Still, tags are not a first-class citizen in hierarchical systems, and wildcarding like this breaks down. In particular, when an organization decides that a metric like <code class="calibre24">httpServerRequests</code> that is common to many applications across the stack should receive a new tag, it has the potential to break existing queries. In <a data-type="xref" href="part0006_split_003.html#hierarchical_metrics_aggregation_failures" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-3</a>, the true number of requests independent of method is 40, but since some application in the stack has introduced a new status tag in the metric name, it is no longer included in the aggregation. Even assuming we can agree as a whole organization to standardize on this new tag, our wildcarding queries (and therefore any dashboards or alerts built off of them) misrepresent the state of the system from the time the tag is introduced in the first application until it is fully propagated through the codebase and redeployed everywhere.</p>
<table id="hierarchical_metrics_aggregation_failures" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-3. </span>Failures of aggregation of hierarchical metrics with wildcards</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric query</th>
<th class="calibre44">Value</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">httpServerRequests.method.GET</p></td>
<td class="calibre47"><p class="calibre48">10</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">httpServerRequests.method.POST</p></td>
<td class="calibre47"><p class="calibre48">20</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">httpServerRequests.status.200.method.GET</p></td>
<td class="calibre47"><p class="calibre48">10</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">httpServerRequests.method.*</p></td>
<td class="calibre47"><p class="calibre48">30 (!!)</p></td>
</tr>
</tbody>
</table>

<p class="author1">Effectively, the hierarchical approach has forced an ordering of tags when they are really independent key-value pairs.</p>

<p class="author1">If you are starting with real-time application monitoring now, you should be using a dimensional monitoring system. This means you will also have to use a dimensional metrics instrumentation library in order to record metrics in a way that fully takes advantage of the name/tag combination that makes these systems so powerful. If you already have some instrumentation using a hierarchical collector, the most popular being Dropwizard Metrics, you are going to have to ultimately rewrite this instrumentation. It’s possible to flatten dimensional metrics into hierarchical metrics by developing a naming convention that in some way iterates over all the tags and combines them with the metric name. Going the other direction is difficult to generalize, because the lack of consistency in naming schemes makes it difficult to split a hierarchical name into dimensional metrics.</p>

<p class="author1">From this point on, we’ll be examining dimensional metrics instrumentation alone.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Micrometer Meter Registries" class="calibre3"><div class="preface" id="idm45139279440456">
<h1 class="calibre19" id="5N3E9-2d714b853a094e9a910510217e0e3d73">Micrometer Meter Registries</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="Micrometer meter registries" id="ix_ch02-asciidoc5" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="Micrometer" data-secondary="meter registries" id="ix_ch02-asciidoc6" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The <a data-type="indexterm" data-primary="Micrometer" data-seealso="application metrics" id="ix_ch02-asciidoc7" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>remainder of this chapter will use <a href="https://micrometer.io" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Micrometer</a>, a dimensional metrics instrumentation library for Java that supports many of the most popular monitoring systems on the market. There are only two main alternatives to Micrometer available:</p>
<dl class="calibre20">
<dt class="calibre21">Monitoring system vendors often provide Java API clients</dt>
<dd class="calibre22">
<p class="calibre23">While these work for white box instrumentation at the application level, there is little to no chance that the remainder of the Java ecosystem, especially of third-party open source libraries, will adopt a particular vendor’s instrumentation client for its metrics collection. Probably the closest we have come to this is some spotty adoption in open source libraries of the Prometheus client.</p>
</dd>
<dt class="calibre21"><a href="https://oreil.ly/xV0Aa" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">OpenTelemetry</a></dt>
<dd class="calibre22">
<p class="calibre23">OpenTelemetry is a hybrid metrics and tracing library. At the time of this writing, OpenTelemetry does not have a 1.0 release, and its focus has certainly been more on tracing than metrics, so metrics support is much more basic.</p>
</dd>
</dl>

<p class="author1">While there is some variation in capabilities from one dimensional metrics instrumentation library to another, most of the key concepts described apply to each of them, or at least you should develop an idea of how alternatives should be expected to mature.</p>

<p class="author1">In Micrometer, a <code class="calibre24">Meter</code> is the interface for collecting a set of measurements (which we individually call metrics) about your application.</p>

<p class="author1"><a data-type="indexterm" data-primary="MeterRegistry" id="ix_ch02-asciidoc8" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Meters are created from and held in a <code class="calibre24">MeterRegistry</code>. Each supported monitoring system has an implementation of <code class="calibre24">MeterRegistry</code>. How a registry is created varies for each implementation.</p>

<p class="author1">Each <code class="calibre24">MeterRegistry</code> implementation that is supported by the Micrometer project has a library published to Maven Central and JCenter (e.g., <code class="calibre24">io.micrometer:micrometer-registry-prometheus</code>, <code class="calibre24">io.micrometer:micrometer-registry-atlas</code>):</p>

<pre data-type="programlisting" data-code-language="java" class="calibre60"><code class="n">MeterRegistry</code> <code class="n">registry</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrometheusMeterRegistry</code><code class="o">(</code><code class="n">PrometheusConfig</code><code class="o">.</code><code class="na">DEFAULT</code><code class="o">);</code></pre>

<p class="author1"><code class="calibre24">MeterRegistry</code> implementations with more options contain a fluent builder as well, for example the InfluxDB registry shown in <a data-type="xref" href="part0006_split_004.html#influx_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-1</a>.</p>
<div id="influx_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-1. </span>Influx fluent builder</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">MeterRegistry</code> <code class="n">registry</code> <code class="o">=</code> <code class="n">InfluxMeterRegistry</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="n">InfluxConfig</code><code class="o">.</code><code class="na">DEFAULT</code><code class="o">)</code>
  <code class="o">.</code><code class="na">httpClient</code><code class="o">(</code><code class="n">myCustomizedHttpClient</code><code class="o">)</code>
  <code class="o">.</code><code class="na">build</code><code class="o">();</code></pre></div>

<p class="author1">Metrics can be published to multiple monitoring systems simultaneously with <code class="calibre24">CompositeMeterRegistry</code>.</p>

<p class="author1">In <a data-type="xref" href="part0006_split_004.html#composite_meter_registry" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-2</a>, a composite registry is created that ships metrics to both Prometheus and Atlas. Meters should be created with the composite.</p>
<div id="composite_meter_registry" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-2. </span>Composite meter registry that ships to Prometheus and Atlas</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">MeterRegistry</code> <code class="n">prometheusMeterRegistry</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrometheusMeterRegistry</code><code class="o">(</code>
  <code class="n">PrometheusConfig</code><code class="o">.</code><code class="na">DEFAULT</code><code class="o">);</code>
<code class="n">MeterRegistry</code> <code class="n">atlasMeterRegistry</code> <code class="o">=</code> <code class="k">new</code> <code class="n">AtlasMeterRegistry</code><code class="o">(</code><code class="n">AtlasConfig</code><code class="o">.</code><code class="na">DEFAULT</code><code class="o">);</code>

<code class="n">MeterRegistry</code> <code class="n">registry</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CompositeMeterRegistry</code><code class="o">();</code>
<code class="n">registry</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">prometheusMeterRegistry</code><code class="o">);</code>
<code class="n">registry</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">atlasMeterRegistry</code><code class="o">);</code>

<code class="c">// Create meters like counters against the composite,</code>
<code class="c">// not the individual registries that make up the composite</code>
<code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"my.counter"</code><code class="o">);</code></pre></div>

<p class="author1">Micrometer packs with a global static <code class="calibre24">CompositeMeterRegistry</code> that can be used in a similar way that we use an SLF4J <code class="calibre24">LoggerFactory</code>. The purpose of this static registry is to allow for instrumentation in components that cannot leak Micrometer as an API dependency by offering a way to dependency-inject a <code class="calibre24">MeterRegistry</code>. <a data-type="xref" href="part0006_split_004.html#using_static_registry" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-3</a> shows the similarity between the use of the global static registry and what we are used to from logging libraries like SLF4J.</p>
<div id="using_static_registry" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-3. </span>Using the static global registry</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">class</code> <code class="nc">MyComponent</code> <code class="o">{</code>
  <code class="n">Timer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">Timer</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"time.something"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"time some operation"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">Metrics</code><code class="o">.</code><code class="na">globalRegistry</code><code class="o">);</code>

  <code class="n">Logger</code> <code class="n">logger</code> <code class="o">=</code> <code class="n">LoggerFactory</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">MyComponent</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>

  <code class="k">public</code> <code class="kt">void</code> <code class="nf">something</code><code class="o">()</code> <code class="o">{</code>
    <code class="n">timer</code><code class="o">.</code><code class="na">record</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="o">{</code>
      <code class="c">// Do something</code>
      <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"I did something"</code><code class="o">);</code>
    <code class="o">});</code>
  <code class="o">}</code>
<code class="o">}</code></pre></div>

<p class="author1">By adding any <code class="calibre24">MeterRegistry</code> implementations that you wire in your application to the global static registry, any low-level libraries using the global registry like this wind up registering metrics to your implementations. Composite registries can be added to other composite registries. In <a data-type="xref" href="part0006_split_004.html#global_registry_relationship" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-1</a>, we’ve created a composite registry in our application that publishes metrics to both Prometheus and Stackdriver (i.e., we’ve called <code class="calibre24">CompositeMeterRegistry#add(MeterRegistry)</code> for both the Prometheus and Stackdriver registries). Then we’ve added <em class="calibre12">that</em> composite to the global static composite. The composite registry you created can be dependency-injected by something like Spring, CDI, or Guice throughout your application for your components to register metrics against. But other libraries are often outside of this dependency-injection context, and since they don’t want Micrometer to leak through their API signatures, they register with the static global registry. In the end, metrics registration flows down this hierarchy of registries. So library metrics flow down from the global composite to your application composite to the individual registries. Application metrics flow down from the application composite to the individual Prometheus and Stackdriver registries.</p>

<figure class="calibre32"><div id="global_registry_relationship" class="figure">
<img src="../images/00111.png" alt="srej 0201" class="calibre64"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-1. </span>Relationship between global static registry and your application’s registries</h6>
</div></figure>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Micrometer Meter Registries" class="calibre3">
<div class="preface" id="idm45139279440456">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_5">Spring Boot Autoconfiguration of MeterRegistry</h1>
<p class="author1"><a data-type="indexterm" data-primary="MeterRegistry" data-secondary="Spring Boot autoconfiguration" id="idm45139275886216" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="Spring Boot" data-secondary="MeterRegistry autoconfiguration" id="idm45139275885048" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Spring Boot autoconfigures a composite registry and adds a registry for each supported implementation that it finds on the classpath. A dependency on <code class="calibre24">micrometer-registry-{system}</code> in your runtime classpath along with any required configuration for that system causes Spring Boot to configure the registry. Spring Boot also adds any <code class="calibre24">MeterRegistry</code> found as a <code class="calibre24">@Bean</code> to the global static composite. In this way, any libraries that you add to your application that provide Micrometer instrumentation automatically ship their metrics to your monitoring system! This is how the black-box-like experience is achieved through white box instrumentation. As the developer, you don’t need to explicitly register these metrics; just their presence in your application makes it work<a data-type="indexterm" data-startref="ix_ch02-asciidoc8" id="idm45139275882024" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>.<a data-type="indexterm" data-startref="ix_ch02-asciidoc7" id="idm45139275881192" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc6" id="idm45139275880488" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Creating Meters" class="calibre3"><div class="preface" id="idm45139279439832">
<h1 class="calibre19" id="calibre_pb_6">Creating Meters</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="creating meters" id="idm45139275878408" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Micrometer provides two styles to register metrics for each supported <code class="calibre24">Meter</code> type, depending on how many options you need. The fluent builder, as shown in <a data-type="xref" href="part0006_split_006.html#meter_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-4</a>, provides the most options. Generally, core libraries should use the fluent builder because the extra verbosity required to provide robust description and base unit detail adds value to all of their users. In instrumentation for a particular microservice with a small set of engineers, opting for more compact code and less detail is fine. Some monitoring systems support attaching description text and base units to metrics, and for those, Micrometer will publish this data. Furthermore, some monitoring systems will use base unit information on a metric to automatically scale and label the <em class="calibre12">y</em>-axis of charts in a way that is human readable. So if you publish a <span class="keep-together">metric</span> with a base unit of “bytes,” a sophisticated monitoring system will recognize this and scale the <em class="calibre12">y</em>-axis to megabytes or gigabytes, or whatever is the most human-readable value for the range of this metric. It’s much easier to read “2 GB” than “2147483648 bytes.” Even for those monitoring systems that don’t fundamentally support base units, charting user interfaces like <a href="https://grafana.com" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Grafana</a> allow you to manually specify the units of a chart, and Grafana will do this kind of intelligent human-readable scaling for you.</p>
<div id="meter_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-4. </span>Meter fluent builder</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Counter</code> <code class="n">counter</code> <code class="o">=</code> <code class="n">Counter</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code> <code class="c">// Name</code>
  <code class="o">.</code><code class="na">tag</code><code class="o">(</code><code class="s">"status"</code><code class="o">,</code> <code class="s">"200"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">tags</code><code class="o">(</code><code class="s">"method"</code><code class="o">,</code> <code class="s">"GET"</code><code class="o">,</code> <code class="s">"outcome"</code><code class="o">,</code> <code class="s">"SUCCESS"</code><code class="o">)</code> <code class="c">// Multiple tags</code>
  <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"http requests"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1"><code class="calibre24">MeterRegistry</code> contains convenience methods to construct <code class="calibre24">Meter</code> instances with a shorter form, as in <a data-type="xref" href="part0006_split_006.html#meter_short_form" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-5</a>.</p>
<div id="meter_short_form" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-5. </span>Meter construction convenience methods</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Counter</code> <code class="n">counter</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"requests"</code><code class="o">,</code>
  <code class="s">"status"</code><code class="o">,</code> <code class="s">"200"</code><code class="o">,</code> <code class="s">"method"</code><code class="o">,</code> <code class="s">"GET"</code><code class="o">,</code> <code class="s">"outcome"</code><code class="o">,</code> <code class="s">"SUCCESS"</code><code class="o">);</code></pre></div>

<p class="author1">Regardless of which of the two methods you use to construct a meter, you will have to decide on its name and which tags to apply.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Naming Metrics" class="calibre3"><div class="preface" id="naming_metrics">
<h1 class="calibre19" id="5N3ND-2d714b853a094e9a910510217e0e3d73">Naming Metrics</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="naming metrics" id="ix_ch02-asciidoc9" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="naming conventions" data-secondary="metrics and" id="ix_ch02-asciidoc10" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>To get the most out of metrics, they need to be structured in such a way that selecting just the name and aggregating over all tags yields a meaningful (if not always useful) value. For example, if a metric is named <code class="calibre24">http.server.requests</code>, then tags may identify application, region (in the public cloud sense), API endpoint, HTTP method, response status code, etc. An aggregate measure like throughput for this metric of all unique combinations of tags yields a measure of throughput for every interaction with many applications across your application stack. The ability to pivot on this name into various tags makes this useful. We could explode this metric dimensionally by region and observe a regional outage or drill down on a particular application—for example, for successful responses to a particular API endpoint to reason about throughput through that one key endpoint.</p>

<p class="author1">Assuming many applications are instrumented with some metric such as <code class="calibre24">http.server.requests</code>, when building a visualization on <code class="calibre24">http.server.requests</code> the monitoring system will display an aggregate of the performance of all of the <code class="calibre24">http.server.requests</code> across all applications, regions, etc. until you decide to dimensionally drill down on something.</p>

<p class="author1">Not everything should be a tag, however. Suppose we are trying to measure the number of HTTP requests and the number of database calls separately.</p>

<p class="author1"><a data-type="indexterm" data-primary=". (dot) character" id="idm45139279169352" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="dot (.) character" id="idm45139279168648" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Micrometer employs a naming convention that separates lowercase words with a <span class="keep-together">. (dot)</span> character. The naming shown in <a data-type="xref" href="part0006_split_007.html#recommended_naming" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-6</a> provides enough context so that if just the name is selected the value is at least potentially meaningful. For example, if we select <code class="calibre24">database.queries</code> we can see the total number of calls to all databases. Then we can group by or select by database to drill down further or perform comparative analysis on the contribution of calls to each database.</p>
<div id="recommended_naming" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-6. </span>Recommended approach</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"database.queries"</code><code class="o">,</code> <code class="s">"db"</code><code class="o">,</code> <code class="s">"users"</code><code class="o">)</code>
<code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"http.requests"</code><code class="o">,</code> <code class="s">"uri"</code><code class="o">,</code> <code class="s">"/api/users"</code><code class="o">)</code></pre></div>

<p class="author1">With the approach shown in <a data-type="xref" href="part0006_split_007.html#bad_naming" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-7</a>, if we select the metric <code class="calibre24">calls</code> we will get a value that is an aggregate of the number of calls to the database and HTTP requests. This value is not useful without dimensionally drilling down further.</p>
<div id="bad_naming" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-7. </span>Bad practice: using a type tag where the meter name should be different instead</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"calls"</code><code class="o">,</code>
    <code class="s">"type"</code><code class="o">,</code> <code class="s">"database"</code><code class="o">,</code>
    <code class="s">"db"</code><code class="o">,</code> <code class="s">"users"</code><code class="o">);</code>

<code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"calls"</code><code class="o">,</code>
    <code class="s">"type"</code><code class="o">,</code> <code class="s">"http"</code><code class="o">,</code>
    <code class="s">"uri"</code><code class="o">,</code> <code class="s">"/api/users"</code><code class="o">);</code></pre></div>

<p class="author1"><a data-type="xref" href="part0006_split_007.html#bad_metric_naming" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-2</a> shows the effect of this bad naming. Suppose for every HTTP request you make 10 database calls. If you just chart <code class="calibre24">calls</code>, you get the top-line rate of approximately 11,000 calls. But 11,000 is an awkward sum of two types of calls which are always an order of magnitude off in frequency. To get any utility out of this, we need to break down by type dimensionally, at which point we discover the 10x relationship of database calls to HTTP requests. Having to drill down right away to build an intelligible chart is a sign that something isn’t right about the metric naming scheme.</p>

<figure class="calibre32"><div id="bad_metric_naming" class="figure">
<img src="../images/00020.png" alt="srej 0202" class="calibre65"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-2. </span>The effect of bad naming on chart usability</h6>
</div></figure>

<p class="author1">It is a good practice to group related data together, such as by prefixing metric names with namespaces like “jvm” or “db.” For example, a suite of metrics related to JVM garbage collection could be prefixed with <code class="calibre24">jvm.gc</code>:</p>

<pre data-type="programlisting" class="calibre60">jvm.gc.live.data.size
jvm.gc.memory.promoted
jvm.gc.memory.allocated</pre>

<p class="author1">This namespacing not only helps group related metrics alphabetically in many monitoring system UIs and dashboarding utilities, but also can be used to affect a group of metrics in one pass with a <code class="calibre24">MeterFilter</code>. For example, to disable all <code class="calibre24">jvm.gc</code> metrics, we can apply a deny <code class="calibre24">MeterFilter</code> on this name:</p>

<pre data-type="programlisting" data-code-language="java" class="calibre60"><code class="n">MeterRegistry</code> <code class="n">registry</code> <code class="o">=</code> <code class="o">...;</code>
<code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">().</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">denyNameStartsWith</code><code class="o">(</code><code class="s">"jvm.gc"</code><code class="o">));</code></pre>

<p class="author1">Different monitoring systems have different recommendations regarding naming convention, and some naming conventions may be incompatible for one system and not another. Recall that Micrometer employs a naming convention that separates lowercase words with a <em class="calibre12">.</em> (dot) character. Each Micrometer implementation for a monitoring system comes with a naming convention that transforms lowercase dot notation names into the monitoring system’s recommended naming convention.</p>

<p class="author1">Additionally, this naming convention sanitizes metric names and tags of special characters that are disallowed by the monitoring system. The convention turns out to be more than just a play at appearing more idiomatic. If shipped in this form without any naming convention normalization two metrics, <code class="calibre24">http.server.requests</code> and <code class="calibre24">http.client.requests</code>, would break Elasticsearch indexing, which treats dots as a form of hierarchy for the purpose of indexing. If these metrics were <em class="calibre12">not</em> shipped with dots to SignalFx, we wouldn’t be able to take advantage of UI presentation in SignalFx that hierarchizes metrics with dot separators in them. These two differing opinions on the dot character are mutually exclusive. With naming convention normalization, these metrics are shipped as <code class="calibre24">httpServerRequests</code> and <code class="calibre24">httpClientRequests</code> to Elastic and with the dot notation to SignalFx. So the application code maintains <span class="keep-together">maximum</span> portability without having to change instrumentation. When using Micrometer, meter names and tag keys should follow these guidelines:</p>

<ul class="printings">
<li class="calibre15">
<p class="calibre18">Always use dots to separate parts of the name.</p>
</li>
<li class="calibre15">
<p class="calibre18">Avoid adding unit names or words like <code class="calibre24">total</code> to meter names.</p>
</li>
</ul>

<p class="author1">So choose <code class="calibre24">jvm.gc.memory.promoted</code> instead of <code class="calibre24">jvmGcMemoryPromoted</code> or <code class="calibre24">jvm_gc_memory_promoted</code>. If you prefer one of the latter (or if your monitoring system requires it), configure the naming convention on the registry to do this conversion. But using dot separators in metric names up and down the whole software stack yields consistent outcomes for a variety of monitoring systems.</p>

<p class="author1">For some monitoring systems, the presence of unit names and the like are part of the idiomatic naming scheme. Again, naming conventions can add these bits where appropriate. For example, Prometheus’s naming convention adds <code class="calibre24">_total</code> to the suffix of counters and <code class="calibre24">_seconds</code> to the end of timers. Also, the base unit of time varies based on the monitoring system. With a Micrometer <code class="calibre24">Timer</code>, you record in whatever granularity you’d like and the time values are scaled at publishing time. Even if you always record in a certain granularity, including the unit name in the meter name is inaccurate. For example, <a data-type="xref" href="part0006_split_007.html#timer_with_unit_in_name" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-8</a> shows up as <code class="calibre24">requests_millis_seconds</code> in Prometheus, which is awkward.</p>
<div id="timer_with_unit_in_name" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-8. </span>Bad practice: adding a unit to the meter name</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"requests.millis"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">record</code><code class="o">(</code><code class="n">responseTime</code><code class="o">,</code> <code class="n">TimeUnit</code><code class="o">.</code><code class="na">MILLISECONDS</code><code class="o">);</code></pre></div>

<p class="author1">The default naming convention of a <code class="calibre24">MeterRegistry</code> can be overridden with a custom one, which can build upon some basic building blocks provided in the <code class="calibre24">NamingConvention</code> interface, as shown in <a data-type="xref" href="part0006_split_007.html#custom_naming_convention" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-9</a>.</p>
<div id="custom_naming_convention" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-9. </span>A custom naming convention that adds base units as a suffix</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">.</code><code class="na">namingConvention</code><code class="o">(</code><code class="k">new</code><code class="calibre24"> </code><code class="n">NamingConvention</code><code class="o">(</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO1-1" href="part0006_split_007.html#callout_application_metrics_CO1-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">      </code><code class="nd">@Override</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="k">public</code><code class="calibre24"> </code><code class="n">String</code><code class="calibre24"> </code><code class="nf">name</code><code class="o">(</code><code class="n">String</code><code class="calibre24"> </code><code class="n">name</code><code class="o">,</code><code class="calibre24"> </code><code class="n">Meter</code><code class="o">.</code><code class="na">Type</code><code class="calibre24"> </code><code class="n">type</code><code class="o">,</code><code class="calibre24"> </code><code class="n">String</code><code class="calibre24"> </code><code class="n">baseUnit</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">          </code><code class="n">String</code><code class="calibre24"> </code><code class="n">camelCased</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">NamingConvention</code><code class="o">.</code><code class="na">snakeCase</code><code class="o">.</code><code class="na">name</code><code class="o">(</code><code class="n">name</code><code class="o">,</code><code class="calibre24"> </code><code class="n">type</code><code class="o">,</code><code class="calibre24"> </code><code class="n">baseUnit</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">          </code><code class="k">return</code><code class="calibre24"> </code><code class="n">baseUnit</code><code class="calibre24"> </code><code class="o">=</code><code class="o">=</code><code class="calibre24"> </code><code class="k">null</code><code class="calibre24"> </code><code class="o">?</code><code class="calibre24"> </code><code class="n">camelCased</code><code class="calibre24"> </code><code class="o">:</code><code class="calibre24">
</code><code class="calibre24">                  </code><code class="n">camelCased</code><code class="calibre24"> </code><code class="o">+</code><code class="calibre24"> </code><code class="s">"_"</code><code class="calibre24"> </code><code class="o">+</code><code class="calibre24"> </code><code class="n">baseUnit</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="o">)</code><code class="o">;</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO1-1" href="part0006_split_007.html#co_application_metrics_CO1-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68"><code class="calibre24">NamingConvention</code> is a functional interface, so this can be simplified to a lambda, but for the sake of clarity here we leave the anonymous class.</p></dd>
</dl>

<p class="author1">As mentioned in <a data-type="xref" href="part0006_split_002.html#dimensional_metrics_instrumentation" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Dimensional Metrics”</a>, the total storage cost of a metric is the product of the cardinality of the value set of each of its tags. Choose tag names that help identify the failure mode of a piece of software. For example, if monitoring an auto insurance rating application, tagging policy metrics with vehicle class is more useful than tagging with a unique vehicle identification number. As a result of a bug or downstream service outage, a class of vehicles like classic trucks may start failing. Responding to an alert on a policy rating error ratio that exceeds a predetermined threshold, an engineer may quickly identify that the handling of classic trucks is problematic based on the top three rating failures by vehicle class.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Naming Metrics" class="calibre3">
<div class="preface" id="naming_metrics">
<div data-type="warning" type="warning" class="calibre30"><h1 class="calibre69" id="calibre_pb_8">Limit Total Unique Tag Values to Control Storage Cost</h1>
<p class="author1"><a data-type="indexterm" data-primary="tag values" id="idm45139278818216" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Beware of the potential for tag values coming from user-supplied sources to blow up the cardinality of a metric. You should always carefully normalize and bound user-supplied input. Sometimes the cause is sneaky. Consider the URI tag for recording HTTP requests on service endpoints. If we don’t constrain 404s to a value like “NOT_FOUND,” the dimensionality of the metric would grow with each resource that can’t be found. Even more tricky, an application that redirects all nonauthenticated requests to a login endpoint could return a 403 for a resource that ultimately will not be found once authenticated, and so a reasonable URI tag for a 403 might be “REDIRECTION.” Allowing a tag value set to grow without bound can result in an overrun of storage in your monitoring system, increasing cost and potentially destabilizing a core part of your observability stack.</p>
</div>

<p class="author1">In general, avoid recording tags on unique values like user ID unless it is known that the population is small.</p>

<p class="author1">Tag values must be nonnull and ideally nonblank. Even though Micrometer technically supports blank tag values in limited situations, like for the Datadog registry implementation, blank tag values are not portable to other monitoring systems that don’t support them.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Naming Metrics" class="calibre3">
<div class="preface" id="naming_metrics">
<div data-type="warning" type="warning" class="calibre30"><h1 class="calibre69" id="calibre_pb_9">Limit Total Unique Tag Values to Control Query Cost</h1>
<p class="author1">In addition to increases to storage costs with an increasing number of unique tag values, query costs (in both time and resources) also increase as more and more time series need to be aggregated in query results.</p>
</div>








</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Naming Metrics" class="calibre3">
<div class="preface" id="naming_metrics">
<section data-type="sect2" data-pdf-bookmark="Common Tags" class="calibre3"><div class="preface" id="idm45139278812296">
<h2 class="calibre37" id="5N409-2d714b853a094e9a910510217e0e3d73">Common Tags</h2>

<p class="author1"><a data-type="indexterm" data-primary="naming conventions" data-secondary="common tags" id="ix_ch02-asciidoc11" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="tags, common" id="ix_ch02-asciidoc12" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>When lower-level libraries provide common instrumentation (Micrometer provides meter binders out of the box—see <a data-type="xref" href="part0007_split_023.html#meter_binders" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Meter Binders”</a>), they cannot know the context of the application this instrumentation will be collected in. Is the app running in a private datacenter on one of a small set of named VMs whose names never change? On infrastructure-as-a-service public cloud resources? In Kubernetes? In virtually every case, there is more than one running copy of a particular application that might ship metrics, even if there is just one copy in production and one in a lower-level testing environment. It’s useful if we can partition in some way the metrics streaming out of these various instances of an application by some dimensions that allow us to attribute a behavior back to a particular instance.</p>

<p class="author1">Meter filters (covered in more detail in <a data-type="xref" href="part0007_split_016.html#6LLJE-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Meter Filters”</a>) allow you to add common tags to accomplish exactly this, enriching every metric published from an application with additional tags. Pick common tags that help turn your metrics data into action. Following are common tags that are always useful:</p>
<dl class="calibre20">
<dt class="calibre21">Application name</dt>
<dd class="calibre22">
<p class="calibre23">Consider that some metrics, like HTTP request metrics instrumented by the framework, will have the same name across various applications, e.g., <code class="calibre24">http.server.requests</code> for HTTP endpoints served by the application, and <code class="calibre24">http.client.requests</code> for outbound requests to other services. By tagging with application name, you could then, for example, reason about all outbound requests to some particular service endpoint across multiple callers.</p>
</dd>
<dt class="calibre21">Cluster and server group name</dt>
<dd class="calibre22">
<p class="calibre23">In <a data-type="xref" href="part0010_split_003.html#delivery_definitions" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Delivery Pipelines”</a> we talk more about the formal definition of a cluster and server group. If you have such a topology, tagging with cluster and server group is always useful. Some organizations don’t have this level of complexity, and that’s OK too.</p>
</dd>
<dt class="calibre21">Instance name</dt>
<dd class="calibre22">
<p class="calibre23">This may be the machine’s host name in some situations, but not always (and this helps explain why Micrometer doesn’t preemptively tag with things like host name, because it really does depend on the deployed environment). In public cloud environments, host name may not be the right tag. AWS EC2, for example, has local and external host names that are distinct from the instance ID. Instance ID is actually the easiest of these three to locate a particular instance with in the AWS console, and it does uniquely identify the instance. So in this context, instance ID is a better tag than host name. In Kubernetes, the pod ID is the right instance-level tag.</p>
</dd>
<dt class="calibre21">Stack</dt>
<dd class="calibre22">
<p class="calibre23">“Stack” in this context means development versus production. You may have multiple levels of nonproduction environments. Shelter Insurance at one point had “devl,” “test,” “func,” and “stage” nonproduction environments, each of which served its own purpose (and I might be forgetting one or two). It’s nice to practice monitoring even on unstable lower-level environments to baseline your expectations about the performance and number of errors produced by a piece of code as it progresses along its promotion path on the route to production.</p>
</dd>
</dl>

<p class="author1">Some other ideas for tags for different deployed environments are included in <a data-type="xref" href="part0006_split_010.html#tags_per_provider" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-4</a>.</p>
<table id="tags_per_provider" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-4. </span>Common tags by cloud provider</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Provider</th>
<th class="calibre44">Common tags</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">AWS</p></td>
<td class="calibre47"><p class="calibre48">Instance ID, ASG name, region, zone, AMI ID, account</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">Kubernetes</p></td>
<td class="calibre47"><p class="calibre48">Pod ID, namespace, cluster name, Deployment/StatefulSet name, ReplicaSet name</p></td>
</tr>
<tr class="calibre59">
<td class="calibre47"><p class="calibre48">Cloud Foundry</p></td>
<td class="calibre47"><p class="calibre48">CF app name (which may be distinct from the application name), organization name, space name, instance ordinal, foundation name</p></td>
</tr>
</tbody>
</table>

<p class="author1">This table illustrates why Micrometer doesn’t add these tags by default. The singular concept of “namespace” has three different names across these cloud providers: region, namespace, and organization/space. Where AWS and Kubernetes have a single-value namespace concept, CloudFoundry has two: organization and space!</p>

<p class="author1">The application of common tags is a great place to begin thinking as a platform engineering organization about how to encapsulate and standardize for your <span class="keep-together">organization.</span></p>

<p class="author1"><a data-type="xref" href="part0006_split_010.html#property_based_common_tags" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-10</a> shows how in Spring Boot, you can apply common tags via property-based configuration.</p>
<div id="property_based_common_tags" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-10. </span>Adding common tags by property in Spring Boot</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre63"><code class="nt">management.metrics.tags</code><code class="p">:</code>
  <code class="nt">application</code><code class="p">:</code> <code class="calibre24">${spring.application.name}</code>
  <code class="nt">region</code><code class="p">:</code> <code class="calibre24">us-east-1</code>
  <code class="nt">stack</code><code class="p">:</code> <code class="calibre24">prod</code></pre></div>

<p class="author1">Alternatively, you could apply tags in an autoconfigurable <code class="calibre24">@Configuration</code> class, as in <a data-type="xref" href="part0006_split_010.html#programmatic_common_tags" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-11</a>.</p>
<div id="programmatic_common_tags" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-11. </span>Adding common tags programmatically in Spring Boot</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="nd">@Configuration</code><code class="calibre24">
</code><code class="k">public</code><code class="calibre24"> </code><code class="k">class</code><code class="calibre24"> </code><code class="nc">MetricsConfiguration</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Bean</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="n">MeterFilter</code><code class="calibre24"> </code><code class="nf">commonTags</code><code class="o">(</code><code class="nd">@Value</code><code class="o">(</code><code class="s">"${spring.application.name}"</code><code class="o">)</code><code class="calibre24"> </code><code class="n">String</code><code class="calibre24"> </code><code class="n">appName</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">return</code><code class="calibre24"> </code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">commonTags</code><code class="o">(</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="s">"application"</code><code class="o">,</code><code class="calibre24"> </code><code class="n">appName</code><code class="o">,</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="s">"region"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"us-east-1"</code><code class="o">,</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO2-1" href="part0006_split_010.html#callout_application_metrics_CO2-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">      </code><code class="s">"stack"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"prod"</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO2-1" href="part0006_split_010.html#co_application_metrics_CO2-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">This should be sourced from the environment as well.</p></dd>
</dl>

<p class="author1">Assuming you have some central dynamic configuration server, like Spring Cloud Config Server, that applications interrogate at startup for properties, the property-based configuration allows you to deliver these common tag opinions across your application stack immediately and with no code changes or dependency requirements for each application.</p>

<p class="author1">The programmatic form can be delivered via an explicit runtime binary dependency from each app or by injecting a dependency into the deployed form of the app or a container running it, like Tomcat<a data-type="indexterm" data-startref="ix_ch02-asciidoc12" id="idm45139278650312" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc11" id="idm45139278653048" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>.<a data-type="indexterm" data-startref="ix_ch02-asciidoc10" id="idm45139278652248" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc9" id="idm45139278655240" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>





</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Classes of Meters" class="calibre3"><div class="preface" id="idm45139279109864">
<h1 class="calibre19" id="calibre_pb_11">Classes of Meters</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="classes of meters" id="idm45139278654040" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="classes, of meters" id="idm45139278656632" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Many metrics collectors provide several classes of meters, each of which may emit one or more metrics or statistics. The most common are gauges, counters, and timers/summaries. More specialized meters include long task timers, time gauges, and interval counters. Strive to use the most specialized meter available for the task. Timers, for example, always emit a count to measure throughput. There is little advantage to counting executions of a particular block of code, when timing it would have generated the same count statistic but also richer information about the latency distribution of that block of code.</p>

<p class="author1">A decision guide for which built-in meter type to choose follows the introduction of each type in <a data-type="xref" href="part0007_split_011.html#choosing_meter_type" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Choosing the Right Meter Type”</a>.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" class="calibre3" data-pdf-bookmark="Gauges"><div class="preface" id="idm45139278571592">
<h1 class="calibre19" id="5N44L-2d714b853a094e9a910510217e0e3d73">Gauges</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="gauges" id="ix_ch02-asciidoc13" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="gauges" id="ix_ch02-asciidoc14" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Gauges are a measure of an instantaneous value that may increase and decrease over time. A time series plot of a gauge is a collection of samples of instantaneous values at intervals where metrics were published from the application. Because they are sampled instantaneous values, it is possible and even likely that the value would have been higher or lower if it had been sampled at a different point in time.</p>

<p class="author1">The speedometer and fuel level on a vehicle are classic examples of gauges. As you drive along the road, you periodically glance at the speedometer (hopefully). Seeing a periodic instantaneous measurement of your speed is enough to keep speed under control, but it is still true that you miss the variations in speed that occurred between looks.</p>

<p class="author1">In applications, typical examples for gauges would be the size of a collection or map or the number of threads in a running state. Memory and CPU measurements are also taken using gauges. <a data-type="xref" href="part0006_split_012.html#jvm_memory_used" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-3</a> is a gauge time series of a single metric, <code class="calibre24">jvm.memory.used</code>, that is tagged with several dimensions, including the memory space. This stack chart shows one way in which making a single concept like memory consumption dimensional provides richness to its representation in a chart.</p>

<figure class="calibre32"><div id="jvm_memory_used" class="figure">
<img src="../images/00017.png" alt="An image of JVM heap usage, one meter with several tags represented in a stack chart" class="calibre70"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-3. </span>Heap used by space</h6>
</div></figure>

<p class="author1">Micrometer takes the stance that gauges should be sampled and not be set, so there is no information about what might have occurred between samples. After all, any intermediate values set on a gauge are lost by the time the gauge value is reported to a metrics backend anyway, so there seems to be little value in setting those intermediate values in the first place.</p>

<p class="author1">Think of a gauge as a meter that only changes when it is observed. Every other class of meter accumulates intermediate counts toward the point where the data is sent to the metrics backend.</p>

<p class="author1"><a data-type="indexterm" data-primary="MeterRegistry" data-secondary="gauge creation" id="idm45139278543992" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The <code class="calibre24">MeterRegistry</code> interface contains methods, some of which are shown in <a data-type="xref" href="part0006_split_012.html#gauge_create" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-12</a>, for building gauges to observe numeric values, functions, collections, and maps.</p>
<div id="gauge_create" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-12. </span>Creating gauges</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">list</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">gauge</code><code class="o">(</code>
  <code class="s">"listGauge"</code><code class="o">,</code> <code class="n">Collections</code><code class="o">.</code><code class="na">emptyList</code><code class="o">(),</code>
  <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;(),</code> <code class="nd">List:</code><code class="o">:</code><code class="n">size</code><code class="o">);</code>

<code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">list2</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">gaugeCollectionSize</code><code class="o">(</code>
  <code class="s">"listSize2"</code><code class="o">,</code> <code class="n">Tags</code><code class="o">.</code><code class="na">empty</code><code class="o">(),</code>
  <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;());</code>

<code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">Integer</code><code class="o">&gt;</code> <code class="n">map</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">gaugeMapSize</code><code class="o">(</code>
  <code class="s">"mapGauge"</code><code class="o">,</code> <code class="n">Tags</code><code class="o">.</code><code class="na">empty</code><code class="o">(),</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;&gt;());</code></pre></div>

<p class="author1">In the first case, a slightly more common form of gauge is one that monitors some nonnumeric object. The last argument establishes the function that is used to determine the value of the gauge when the gauge is observed. Micrometer provides convenience methods for monitoring map and collection size, since these are such common cases.</p>

<p class="author1">Most forms of creating a gauge maintain only a <em class="calibre12">weak reference</em> to the object being observed, so as not to prevent garbage collection of the object. It is your responsibility to hold a strong reference to the state object that you are measuring with a gauge. Micrometer is careful to not create strong references to objects that would otherwise be garbage collected. Once the object being gauged is de-referenced and is garbage collected, Micrometer will start reporting a NaN or nothing for a gauge, depending on the registry implementation.</p>

<p class="author1">Generally the returned <code class="calibre24">Gauge</code> instance is not useful except in testing, as the gauge is already set up to track a value automatically upon registration.</p>

<p class="author1">In addition to the shortcut methods for creating a gauge directly from a <code class="calibre24">MeterRegistry</code>, Micrometer provides a gauge fluent builder (see <a data-type="xref" href="part0006_split_012.html#gauge_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-13</a>) as well, which has more options. Notice the <code class="calibre24">strongReference</code> option, which does prevent garbage collection of the monitored object, contrary to the default behavior.</p>
<div id="gauge_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-13. </span>Fluent builder for gauges</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Gauge</code> <code class="n">gauge</code> <code class="o">=</code> <code class="n">Gauge</code>
    <code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"gauge"</code><code class="o">,</code> <code class="n">myObj</code><code class="o">,</code> <code class="nd">myObj:</code><code class="o">:</code><code class="n">gaugeValue</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"a description of what this gauge does"</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"speed"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">tags</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"test"</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">strongReference</code><code class="o">(</code><code class="n">IS_STRONG</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1">Micrometer has built-in metrics that include several gauges. Some examples are given in <a data-type="xref" href="part0006_split_012.html#gauge_examples" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-5</a>.</p>
<table id="gauge_examples" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-5. </span>Examples of gauges in Micrometer built-in instrumentation</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric name</th>
<th class="calibre44">Description</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">jvm.threads.live</p></td>
<td class="calibre47"><p class="calibre48">The current number of live threads, including both daemon and nondaemon threads</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">jvm.memory.used</p></td>
<td class="calibre47"><p class="calibre48">The amount of used memory in bytes</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">db.table.size</p></td>
<td class="calibre47"><p class="calibre48">The total number of rows in a database table</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">jetty.requests.active</p></td>
<td class="calibre47"><p class="calibre48">Number of requests currently active</p></td>
</tr>
</tbody>
</table>

<p class="author1"><a data-type="indexterm" data-primary="TimeGauge" id="idm45139278367624" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>A special kind of <code class="calibre24">Gauge</code> called a <code class="calibre24">TimeGauge</code> is specifically used for gauging values that are measuring time (see <a data-type="xref" href="part0006_split_012.html#time_gauge_examples" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-6</a>). Like a <code class="calibre24">Gauge</code>, there is no need to set a <code class="calibre24">TimeGauge</code>, since its value changes when observed. The only difference between them is that the value of a <code class="calibre24">TimeGauge</code> will be scaled to the monitoring system’s base unit of time as it is published. In other cases, follow the general rule that values should be measured in whatever the natural base unit is (e.g., bytes for storage, connections for connection pool utilization). Monitoring systems only differ in their expectation of what the base unit is when describing time.</p>
<table id="time_gauge_examples" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-6. </span>Examples of time gauges in Micrometer built-in instrumentation</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric name</th>
<th class="calibre44">Description</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">process.uptime</p></td>
<td class="calibre47"><p class="calibre48">The uptime of the Java virtual machine, as reported by Java’s Runtime MXBean</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">kafka.consumer.fetch.latency.avg</p></td>
<td class="calibre47"><p class="calibre48">The average time taken for a group sync, as calculated and reported by the Kafka Java client</p></td>
</tr>
</tbody>
</table>

<p class="author1">Kafka consumer fetch latency average is an example of where sometimes Java client libraries only provide coarse statistics like average where, if we could affect the Kafka client code directly, a timer would have been more suitable. In addition to seeing the average, we’d have information about decaying max latency, percentiles, etc.</p>

<p class="author1"><a data-type="indexterm" data-primary="MultiGauge" id="idm45139278355608" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>One last special type of <code class="calibre24">Gauge</code> is a <code class="calibre24">MultiGauge</code>, which helps manage the gauging of a growing or shrinking list of criteria. Often this feature is used when we want to select a well-bounded but slightly changing set of criteria from something like a SQL query and report some metric for each row as a <code class="calibre24">Gauge</code>. It doesn’t have to be data fetched from a database, of course. The gauge could be built off a map-like structure in memory, or any other structure with rows containing a number of columns with at least one numeric column to use for the gauge value. <a data-type="xref" href="part0006_split_012.html#multi_gauge" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-14</a> shows how a <code class="calibre24">MultiGauge</code> is created.</p>
<div id="multi_gauge" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-14. </span>Creating a multi-gauge</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="c">// SELECT count(*), city from customers group by city WHERE country = 'US'</code>
<code class="n">MultiGauge</code> <code class="n">statuses</code> <code class="o">=</code> <code class="n">MultiGauge</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"customers"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">tag</code><code class="o">(</code><code class="s">"country"</code><code class="o">,</code> <code class="s">"US"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"The number of customers by city"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"customers"</code><code class="o">)</code>
        <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code>

<code class="o">...</code>

<code class="c">// Run this periodically whenever you rerun your query</code>
<code class="n">statuses</code><code class="o">.</code><code class="na">register</code><code class="o">(</code>
  <code class="n">resultSet</code><code class="o">.</code><code class="na">stream</code><code class="o">().</code><code class="na">map</code><code class="o">(</code><code class="n">result</code> <code class="o">-&gt;</code>
    <code class="n">Row</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>
      <code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"city"</code><code class="o">,</code> <code class="n">result</code><code class="o">.</code><code class="na">getAsString</code><code class="o">(</code><code class="s">"city"</code><code class="o">)),</code>
      <code class="n">result</code><code class="o">.</code><code class="na">getAsInt</code><code class="o">(</code><code class="s">"count"</code><code class="o">)</code>
    <code class="o">)</code>
  <code class="o">)</code>
<code class="o">);</code></pre></div>

<p class="author1">Before trying to build a gauge to report a rate at which something in your application is happening, consider a counter, which is better suited for this purpose.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" class="calibre3" data-pdf-bookmark="Gauges">
<div class="preface" id="idm45139278571592">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_13">Should I Use a Gauge or a Counter?</h1>
<p class="author1">Never gauge something you can count.<a data-type="indexterm" data-startref="ix_ch02-asciidoc14" id="idm45139278240984" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc13" id="idm45139278240456" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Counters" class="calibre3"><div class="preface" id="counters">
<h1 class="calibre19" id="5N4C9-2d714b853a094e9a910510217e0e3d73">Counters</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="counters" id="ix_ch02-asciidoc15" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="counters" id="ix_ch02-asciidoc16" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Counters report a single metric, a count. The <code class="calibre24">Counter</code> interface allows you to increment by a fixed amount, which must be positive.</p>

<p class="author1">It is possible, though rare, to increment a counter by a fractional amount. For example, you could be counting sums of a base unit like dollars, which naturally have fractional amounts (although it would probably be more useful to count sales with a different meter type, as shown in <a data-type="xref" href="part0007_split_009.html#distribution_summaries" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Distribution Summaries”</a>).</p>

<p class="author1">The <code class="calibre24">MeterRegistry</code> interface contains convenience methods for creating counters, as shown in <a data-type="xref" href="part0006_split_014.html#counter_create" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-15</a>.</p>
<div id="counter_create" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-15. </span>Creating counters</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="c">// No tags
</code><code class="n">Counter</code><code class="calibre24"> </code><code class="n">counter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"bean.counter"</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="c">// Adding tags in key-value pairs with varargs
</code><code class="n">Counter</code><code class="calibre24"> </code><code class="n">counter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"bean.counter"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"region"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"us-east-1"</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="c">// Explicit tag list creation </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO3-1" href="part0006_split_014.html#callout_application_metrics_CO3-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="c">
</code><code class="n">Counter</code><code class="calibre24"> </code><code class="n">counter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"bean.counter"</code><code class="o">,</code><code class="calibre24"> </code><code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"us-east-1"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="c">// Adding tags to some other precreated set of tags.
</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Tag</code><code class="o">&gt;</code><code class="calibre24"> </code><code class="n">predeterminedTags</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"us-east-1"</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="n">Counter</code><code class="calibre24"> </code><code class="n">counter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">registry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"bean.counter"</code><code class="o">,</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="n">Tags</code><code class="o">.</code><code class="na">concat</code><code class="o">(</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">predeterminedTags</code><code class="o">,</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="s">"stack"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"prod"</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">)</code><code class="calibre24">
</code><code class="o">)</code><code class="o">;</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO3-1" href="part0006_split_014.html#co_application_metrics_CO3-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">This is not specific to counters—there are similar APIs we will see on other meter types.</p></dd>
</dl>

<p class="author1">The <code class="calibre24">Counter</code> fluent builder, as seen in <a data-type="xref" href="part0006_split_014.html#counter_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-16</a>, contains more options.</p>
<div id="counter_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-16. </span>Fluent builder for counters</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Counter</code> <code class="n">counter</code> <code class="o">=</code> <code class="n">Counter</code>
    <code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"bean.counter"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"a description of what this counter does"</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"beans"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">tags</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1">Micrometer has built-in metrics that include several counters. Some examples are given in <a data-type="xref" href="part0006_split_014.html#counter_examples" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-7</a>.</p>
<table id="counter_examples" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-7. </span>Examples of counters in Micrometer built-in instrumentation</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric name</th>
<th class="calibre44">Description</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">jetty.async.requests</p></td>
<td class="calibre47"><p class="calibre48">Total number of async requests</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">postgres.transactions</p></td>
<td class="calibre47"><p class="calibre48">Total number of transactions executed (commits + rollbacks)</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">jvm.classes.loaded</p></td>
<td class="calibre47"><p class="calibre48">The number of classes that are currently loaded in the Java virtual machine</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">jvm.gc.memory.promoted</p></td>
<td class="calibre47"><p class="calibre48">Count of positive increases in the size of the old generation memory pool before GC to after GC</p></td>
</tr>
</tbody>
</table>

<p class="author1">When building graphs and alerts off of counters, generally you should be most interested in measuring the rate at which some event is occurring over a given time interval. Consider a simple queue. Counters could be used to measure things like the rate at which items are being inserted and removed.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Counters" class="calibre3">
<div class="preface" id="counters">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_15">When a Counter Measures Occurrences, It Measures Throughput</h1>
<p class="author1"><a data-type="indexterm" data-primary="counters" data-secondary="rate of occurrences as measure of throughput" id="idm45139278008392" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="throughput" data-secondary="rate of occurrences as measure of" id="idm45139278007320" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>When we talk about the rate of occurrences of things happening, conceptually we are talking about <em class="calibre12">throughput</em>. When displaying counters as a rate on a chart, we are displaying a measure of throughput, the rapidity with which this counter is being incremented. When you have the opportunity to instrument an operation with metrics for each individual occurrence, you should almost always use timers (see <a data-type="xref" href="part0006_split_017.html#5N4J5-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Timers”</a>) instead, which provide a measure of throughput in addition to other useful <span class="keep-together">statistics.</span></p>
</div>

<p class="author1">You might want at first to conceive of visualizing absolute counts rather than a rate, but the absolute count is usually both a function of the rapidity with which something is used and the longevity of the application instance under instrumentation. Building dashboards and alerts of the rate of a counter per some interval of time disregards the longevity of the app, letting you see aberrant behavior long after the application has started.</p>

<p class="author1">In many cases, when we’ve dug into why engineers attempt to visualize absolute counts, it is to show some true business-related number (number of sales, revenue, etc.). Remember that metrics instrumentation is optimized for signaling availability, so its implementation is naturally going to trade off durability for instrumentation performance. Any given metrics publishing interval can fail due to things like (physical or virtual) machine failure or network issues between the application and the metrics backend, and it won’t be retried because the assumption is you’ll just catch up on the next interval. Even with cumulative counters, if the final value before shutdown doesn’t make it to the backend, it is lost. Mission-critical counts, such as those required for legal reporting, should use some other durable storage instead of being shipped as a metric (or maybe <em class="calibre12">in addition</em> to being shipped as a metric).</p>

<p class="author1">For some monitoring systems, like Atlas, counters are published as a rate from Micrometer. Querying for and plotting a counter in Atlas, as seen in <a data-type="xref" href="part0006_split_015.html#atlas_counter_rate" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-17</a>, displays a chart whose <em class="calibre12">y</em>-axis is a rate.</p>
<div id="atlas_counter_rate" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-17. </span>Atlas counter rate</h5>

<pre data-type="programlisting" class="calibre63">name,queue.insert,:eq</pre></div>

<p class="author1">Still, some monitoring systems expect counters to be published as a cumulative statistic. It is only at query time that the counter is converted to a rate for display, as in <a data-type="xref" href="part0006_split_015.html#prometheus_counter_rate" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-18</a>. In this case, we have to use the specific <code class="calibre24">rate</code> function to convert the cumulative statistic into a rate. In almost every monitoring scenario, you’ll use this <code class="calibre24">rate</code> function when accessing counters.</p>
<div id="prometheus_counter_rate" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-18. </span>Prometheus counter rate</h5>

<pre data-type="programlisting" class="calibre63">rate(queue_insert_sum[2m])</pre></div>

<p class="author1">It is tempting to count something like errors emitted from a particular method, or the total number of successful invocations of a method, but it is even better to record these events with a timer, because they include a count and other useful information about the latency of the operation.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Counters" class="calibre3">
<div class="preface" id="counters">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_16">Should I Use a Counter or a Timer (or a Distribution Summary)?</h1>
<p class="author1"><a data-type="indexterm" data-primary="counters" data-secondary="timers versus" id="idm45139277991352" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="counters versus" id="idm45139277990376" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Never count something you can time. And if the base unit is not a unit of time, then the corollary is, awkwardly: never count something you can record with a distribution summary.<a data-type="indexterm" data-startref="ix_ch02-asciidoc16" id="idm45139277989112" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc15" id="idm45139277988440" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3"><div class="preface" id="timers">
<h1 class="calibre19" id="5N4J5-2d714b853a094e9a910510217e0e3d73">Timers</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="timers" id="ix_ch02-asciidoc17" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" id="ix_ch02-asciidoc18" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Timers are for measuring short-duration latencies and the frequency of such events. All implementations of <code class="calibre24">Timer</code> report at least a few individual statistics:</p>
<dl class="calibre20">
<dt class="calibre21">Count</dt>
<dd class="calibre22">
<p class="calibre23">A measure of the number of individual recordings of this timer. For a <code class="calibre24">Timer</code> measuring an API endpoint, this count is the number of requests to the API. Count is a measure of throughput.</p>
</dd>
<dt class="calibre21">Sum</dt>
<dd class="calibre22">
<p class="calibre23">The sum of the time it took to satisfy all requests. So if there are three requests to an API endpoint that took 5 ms, 10 ms, and 15 ms, then the sum is <math alttext="5 plus 10 plus 15 equals 30 m s">
  <mrow>
    <mn>5</mn>
    <mo>+</mo>
    <mn>10</mn>
    <mo>+</mo>
    <mn>15</mn>
    <mo>=</mo>
    <mn>30</mn>
    <mi>m</mi>
    <mi>s</mi>
  </mrow>
</math>. The sum may be shipped literally as 30 ms, or as a rate, depending on the monitoring system. We’ll discuss shortly how to interpret this.</p>
</dd>
<dt class="calibre21">Maximum</dt>
<dd class="calibre22">
<p class="calibre23">The individual timing that took the longest, but decaying over an interval. <a data-type="indexterm" data-primary="ring buffer" id="ix_ch02-asciidoc19" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Micrometer maintains a series of overlapping intervals in a ring buffer and keeps track of maximum in each of these intervals. The maximum value is then a little sticky in a sense. The important thing to keep in mind is that this isn’t a maximum of all samples seen from the beginning of the app (this wouldn’t be very useful), but the maximum value seen “recently.” It is possible to configure the recency to make this value decay faster or slower.</p>
</dd>
</dl>

<p class="author1">In addition, timers can <em class="calibre12">optionally</em> ship other statistics:</p>
<dl class="calibre20">
<dt class="calibre21">Service level objective (SLO) boundaries</dt>
<dd class="calibre22">
<p class="calibre23">The count (i.e., total number) of requests observed that are less than or equal to a particular boundary value—for example, how many requests to an API endpoint took less than 100 ms. Since this is a count, it can be divided by the overall count to arrive at an idea of what percentage of requests met your service level objective, and is very cheap to calculate provided you know in advance what objectives you want to set.</p>
</dd>
<dt class="calibre21">Percentiles</dt>
<dd class="calibre22">
<p class="calibre23">Precomputed percentiles which cannot be combined with percentiles from other tags (e.g., percentiles for several instances in a cluster cannot be combined).</p>
</dd>
<dt class="calibre21">Histograms</dt>
<dd class="calibre22">
<p class="calibre23">Similar to SLO boundaries, histograms are comprised of a series of counts for a set of buckets. Histograms can be summed together across dimensions (e.g., sum the counts for like buckets across a series of instances) and be used to create percentile approximations by some monitoring systems. We’ll discuss histograms in more detail in <a data-type="xref" href="part0007_split_007.html#6LKA8-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Histograms”</a>.</p>
</dd>
</dl>

<p class="author1">Let’s go through a couple of examples of how these statistics might be used and the relationship between them.</p>








</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="“Count” Means “Throughput”" class="calibre3"><div class="preface" id="idm45139277950904">
<h2 class="calibre37" id="calibre_pb_18">“Count” Means “Throughput”</h2>

<p class="author1"><a data-type="indexterm" data-primary="throughput" data-secondary="count statistic as measure of" id="idm45139277949736" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="count statistic as measure of throughput" id="idm45139277948696" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The count statistic of a timer is individually useful. It is a measure of <em class="calibre12">throughput</em>, the rate at which the timed operation is happening. When timing an API endpoint, it’s the number of requests to that endpoint. When measuring messages on a queue, it’s the number of messages being placed on the queue.</p>

<p class="author1">The count statistic should be used exactly as described in <a data-type="xref" href="part0006_split_014.html#5N4C9-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Counters”</a>, as a rate. Depending on the monitoring system. this statistic will be either a cumulative count or a rate when shipped from Micrometer.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="“Count” and “Sum” Together Mean “Aggregable Average”" class="calibre3"><div class="preface" id="idm45139277945240">
<h2 class="calibre37" id="5N4KF-2d714b853a094e9a910510217e0e3d73">“Count” and “Sum” Together Mean “Aggregable Average”</h2>

<p class="author1"><a data-type="indexterm" data-primary="aggregable average" id="idm45139277943384" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="count, aggregable average and" id="idm45139277942680" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="sum, aggregable average and" id="idm45139277941992" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="aggregable average from count and sum together" id="idm45139277941304" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>With the one exception we’ll discuss shortly, sum is not really meaningful on its own. Without being considered in relation to the rate at which operations are occurring, a sum has no purpose. A sum of 1 second may be bad for an individual request to a user-facing API endpoint, but 1,000 requests of 1 ms each yielding a sum of 1 second sounds quite good!</p>

<p class="author1">Sum and count together can be used to create an <em class="calibre12">aggregable</em> average. If we instead published the average of a timer directly, it couldn’t be combined with the average data from other dimensions (such as other instances) to reason about the overall average.</p>

<p class="author1">Consider the scenario described in <a data-type="xref" href="part0006_split_019.html#timer_sum_count" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-4</a>, where a load balancer has distributed seven requests to four application instances. Three of these application instances are in Region 1 and, one instance is in Region 2.</p>

<figure class="calibre32"><div id="timer_sum_count" class="figure">
<img src="../images/00120.png" alt="srej 0204" class="calibre71"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-4. </span>Timings for requests going to a hypothetical application</h6>
</div></figure>

<p class="author1">Suppose we’ve tagged the timer metrics for each of these instances with the instance ID and region. The monitoring system then sees time series for timers with four different combinations of tags:</p>

<ul class="printings">
<li class="calibre15">
<p class="calibre18">Instance=1, Region=1</p>
</li>
<li class="calibre15">
<p class="calibre18">Instance=2, Region=1</p>
</li>
<li class="calibre15">
<p class="calibre18">Instance=3, Region=1</p>
</li>
<li class="calibre15">
<p class="calibre18">Instance=4, Region=2</p>
</li>
</ul>

<p class="author1">There will be time series for count and sum for each of these timers. In <a data-type="xref" href="part0006_split_019.html#timer_sum_count_table" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-8</a>, after these seven requests have occurred, a cumulative monitoring system will have values for sum and count for their corresponding tags. Also included is the average for that instance individually.</p>
<table id="timer_sum_count_table" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-8. </span>Cumulative sum and count for each timer</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Instance</th>
<th class="calibre44">Region</th>
<th class="calibre44">Count (operations)</th>
<th class="calibre44">Sum (seconds)</th>
<th class="calibre44">Average (seconds/operation)</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">0.022</p></td>
<td class="calibre47"><p class="calibre48">0.011</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">0.018</p></td>
<td class="calibre47"><p class="calibre48">0.009</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">3</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">0.020</p></td>
<td class="calibre47"><p class="calibre48">0.010</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">4</p></td>
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">0.100</p></td>
<td class="calibre47"><p class="calibre48">0.100</p></td>
</tr>
</tbody>
</table>

<p class="author1">To find the average latency for this timer across all instances in both regions of this application, we add the sums and divide that by the sum of the counts (see <a data-type="xref" href="part0006_split_019.html#computing_aggregable_average" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-1</a>).</p>
<div id="computing_aggregable_average" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-1. </span>Computing the cluster average</h5>
<math alttext="StartFraction 0.022 plus 0.018 plus 0.020 plus 0.100 Over 2 plus 2 plus 2 plus 1 EndFraction equals 0.017 s e c o n d s slash o p equals 17 m i l l i s e c o n d s slash o p" display="block">
  <mrow>
    <mfrac><mrow><mn>0</mn><mo>.</mo><mn>022</mn><mo>+</mo><mn>0</mn><mo>.</mo><mn>018</mn><mo>+</mo><mn>0</mn><mo>.</mo><mn>020</mn><mo>+</mo><mn>0</mn><mo>.</mo><mn>100</mn></mrow> <mrow><mn>2</mn><mo>+</mo><mn>2</mn><mo>+</mo><mn>2</mn><mo>+</mo><mn>1</mn></mrow></mfrac>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>017</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>o</mi>
    <mi>p</mi>
    <mo>=</mo>
    <mn>17</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>i</mi>
    <mi>l</mi>
    <mi>l</mi>
    <mi>i</mi>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>o</mi>
    <mi>p</mi>
  </mrow>
</math>
</div>

<p class="author1">If instead Micrometer only shipped averages from each instance, we wouldn’t have an easy way of calculating this same value. Averaging the averages, as shown in <a data-type="xref" href="part0006_split_019.html#average_of_averages" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-2</a>, is not correct. The “average” here is too high. Several more requests went to Region 1 than Region 2, and Region 1 was serving responses much more quickly.</p>
<div id="average_of_averages" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-2. </span>An INCORRECT calculation of cluster average</h5>
<math alttext="StartFraction 0.011 plus 0.009 plus 0.010 plus 0.100 Over 4 i n s t a n c e s EndFraction equals 0.032 s e c o n d s slash r e q u e s t equals 32 m i l l i s e c o n d s slash r e q u e s t" display="block">
  <mrow>
    <mfrac><mrow><mn>0</mn><mo>.</mo><mn>011</mn><mo>+</mo><mn>0</mn><mo>.</mo><mn>009</mn><mo>+</mo><mn>0</mn><mo>.</mo><mn>010</mn><mo>+</mo><mn>0</mn><mo>.</mo><mn>100</mn></mrow> <mrow><mn>4</mn><mspace width="4pt"/><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi>s</mi></mrow></mfrac>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>032</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mo>=</mo>
    <mn>32</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>i</mi>
    <mi>l</mi>
    <mi>l</mi>
    <mi>i</mi>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
  </mrow>
</math>
</div>

<p class="author1">The demonstration for how average is calculated across the cluster here assumes that Micrometer was shipping a cumulative value for sum and count. How does it work out if Micrometer was shipping a rate instead? <a data-type="xref" href="part0006_split_019.html#timer_sum_count_table_rate" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-9</a> shows rate-normalized values such as those that would be shipped to Atlas. For the sake of this table, assume that the seven requests shown in <a data-type="xref" href="part0006_split_019.html#timer_sum_count" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-4</a> happened over a one-minute interval and that this interval is aligned with the interval in which we push metrics to Atlas.</p>
<table id="timer_sum_count_table_rate" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-9. </span>Rate-normalized sum and count for each timer</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Instance</th>
<th class="calibre44">Region</th>
<th class="calibre44">Count (requests/second)</th>
<th class="calibre44">Sum (unitless)</th>
<th class="calibre44">Average (seconds/request)</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">0.033</p></td>
<td class="calibre47"><p class="calibre48">0.00037</p></td>
<td class="calibre47"><p class="calibre48">0.011</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">0.033</p></td>
<td class="calibre47"><p class="calibre48">0.00030</p></td>
<td class="calibre47"><p class="calibre48">0.009</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">3</p></td>
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">0.033</p></td>
<td class="calibre47"><p class="calibre48">0.00033</p></td>
<td class="calibre47"><p class="calibre48">0.010</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">4</p></td>
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">0.017</p></td>
<td class="calibre47"><p class="calibre48">0.00167</p></td>
<td class="calibre47"><p class="calibre48">0.100</p></td>
</tr>
</tbody>
</table>

<p class="author1">The count column now has a unit of “requests/second” rather than just “requests.” It will be requests/second no matter what the publishing interval is. In this case, we’re publishing every minute; so since we saw two requests to Instance 1, we conclude that the requests/second rate of requests to this instance is <a data-type="xref" href="part0006_split_019.html#rate_avg_instance1" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-3</a>.</p>
<div id="rate_avg_instance1" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-3. </span>The rate of throughput to Instance 1</h5>
<math alttext="2 r e q u e s t s slash m i n u t e equals 2 r e q u e s t s slash 60 s e c o n d s equals 0.033 r e q u e s t s slash s e c o n d" display="block">
  <mrow>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>m</mi>
    <mi>i</mi>
    <mi>n</mi>
    <mi>u</mi>
    <mi>t</mi>
    <mi>e</mi>
    <mo>=</mo>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mn>60</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>033</mn>
    <mspace width="4pt"/>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
  </mrow>
</math>
</div>

<p class="author1">The sum column now is unitless rather than being in seconds. It’s unitless because the numerator of the rate is seconds as well as the denominator, and these units cancel out. So for Instance 1, the sum is <a data-type="xref" href="part0006_split_019.html#rate_sum_instance1" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-4</a>. This unitless nature of sum in a rate-normalized system serves to underscore its meaninglessness independent of being combined with count (or some other dimensioned value).</p>
<div id="rate_sum_instance1" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-4. </span>The rate-normalized sum of Instance 1</h5>
<math alttext="22 m i l l i s e c o n d s slash m i n u t e equals 0.022 s e c o n d s slash 60 s e c o n d s equals 0.00037" display="block">
  <mrow>
    <mn>22</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>i</mi>
    <mi>l</mi>
    <mi>l</mi>
    <mi>i</mi>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>m</mi>
    <mi>i</mi>
    <mi>n</mi>
    <mi>u</mi>
    <mi>t</mi>
    <mi>e</mi>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>022</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mn>60</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>00037</mn>
  </mrow>
</math>
</div>

<p class="author1">The average per instance is the same as in the cumulative table because of the effect of the units canceling out.</p>

<p class="author1">For the purpose of average, it doesn’t matter what the interval is. If the interval were two minutes rather than one minute, our idea of throughput changes (i.e., it’s exactly half), but the extra minute cancels out in the average calculation. In the case of Instance 1, the count in requests/seconds is <a data-type="xref" href="part0006_split_019.html#rate_avg_instance1_2min_1" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-5</a>.</p>
<div id="rate_avg_instance1_2min_1" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-5. </span>The rate of throughput to Instance 1 over a two-minute interval</h5>
<math alttext="2 r e q u e s t s slash 2 m i n u t e s equals 2 r e q u e s t s slash 120 s e c o n d s equals 0.01667 r e q u e s t s slash s e c o n d" display="block">
  <mrow>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>i</mi>
    <mi>n</mi>
    <mi>u</mi>
    <mi>t</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mn>120</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>01667</mn>
    <mspace width="4pt"/>
    <mi>r</mi>
    <mi>e</mi>
    <mi>q</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mi>t</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
  </mrow>
</math>
</div>

<p class="author1">The sum is <a data-type="xref" href="part0006_split_019.html#rate_avg_instance1_2min_2" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-6</a>. But when we divide these, the average is still the same. <span class="keep-together">In this division,</span> you can essentially factor out the <em class="calibre12">2</em> from both numerator and <span class="keep-together">denominator.</span></p>
<div id="rate_avg_instance1_2min_2" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-6. </span>The rate-normalized sum of Instance 1 over a two-minute interval</h5>
<math alttext="22 m i l l i s e c o n d s slash 2 m i n u t e s equals 0.022 s e c o n d s slash 120 s e c o n d s equals 0.00018" display="block">
  <mrow>
    <mn>22</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>i</mi>
    <mi>l</mi>
    <mi>l</mi>
    <mi>i</mi>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>i</mi>
    <mi>n</mi>
    <mi>u</mi>
    <mi>t</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>022</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>/</mo>
    <mn>120</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>e</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>0</mn>
    <mo>.</mo>
    <mn>00018</mn>
  </mrow>
</math>
</div>

<p class="author1">Average is not ideal for monitoring availability. In general, you are better off accepting a slightly worse average and better worst-case (e.g., greater than 99th percentile) performance since the worst case tends to happen much more frequently than our intuition leads us to believe. Still, the combination of sum divided by count is easy to compute and possible on almost all monitoring systems, even those without more sophisticated math operations. So average is at least some baseline to have across a range of wildly different monitoring systems. If at all possible, don’t use average at all.</p>
<blockquote class="pcalibre8 pcalibre9 pcalibre7">
<p class="calibre16">Average: a random number that falls somewhere between the maximum and 1/2 the median. Most often used to ignore reality.</p>
<p data-type="attribution" class="pcalibre10 pcalibre11">Gil Tene</p>
</blockquote>

<p class="author1">Instead, for availability it is more useful to look at maximum or a high-percentile statistic, as we’ll see in detail in <a data-type="xref" href="part0009_split_009.html#8ILKM-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Timers”</a>.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Maximum Is a Decaying Signal That Isn’t Aligned to the Push Interval" class="calibre3"><div class="preface" id="idm45139277731640">
<h2 class="calibre37" id="5N4MM-2d714b853a094e9a910510217e0e3d73">Maximum Is a Decaying Signal That Isn’t Aligned to the Push Interval</h2>

<p class="author1"><a data-type="indexterm" data-primary="maximum, as decaying signal not aligned to push interval" id="ix_ch02-asciidoc20" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="maximum as decaying signal not aligned to push interval" id="ix_ch02-asciidoc21" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Micrometer decays the maximum rather than aligning it to the publishing interval like it does for sum and count. If we perfectly aligned the view of maximum time to the push interval, then a dropped metrics payload means we potentially miss out on seeing a particularly high maximum value (because in the next interval we’d only consider samples that occurred in that interval).</p>

<p class="author1">For other statistics like count, missing a publishing interval is generally not problematic, because the counter continues to accumulate during a period where a metrics payload is dropped, and the next successful payload will surface it.</p>

<p class="author1">Practically, there are many reasons why a high maximum latency and a dropped metrics payload would be correlated. For example, if the application is under heavy resource pressure (like a saturated network interface), a response to the user for an API endpoint that is being timed (and for which a maximum value is being tracked) may be exceedingly high at the same time that a metrics post request to the monitoring system fails with a read timeout. But such conditions can be (and many times are) temporary.</p>

<p class="author1">Perhaps you have a client-side load-balancing strategy that recognizes that (from the client’s perspective) API latency has gone up sharply for this instance that is under resource pressure and begins preferring other instances. By relieving pressure on this instance it recovers.</p>

<p class="author1">In some subsequent interval, after the instance has recovered, it’s nice to be able to push a maximum latency seen during this time of trouble that would otherwise have been skipped. In fact, it’s precisely these times of duress that we care about the most, not the maximum latency under fair-weather conditions!</p>

<p class="author1">The effect of this decaying though is that a maximum value will “linger” for a period of time after it actually occurred. In <a data-type="xref" href="part0006_split_020.html#max_decays" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-5</a>, we see a maximum value of approximately 30 ms for a timed operation. This 30 ms operation occurred sometime in the metrics publishing interval immediately before when the line first spikes up from 0 (around 19:15).</p>

<figure class="calibre32"><div id="max_decays" class="figure">
<img src="../images/00039.png" alt="srej 0205" class="calibre73"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-5. </span>The decaying maximum lingers on a chart for some time</h6>
</div></figure>

<p class="author1">This timer was configured to decay maximum values over a period of two minutes. So it lingers until about 19:17. Since this timer didn’t see any operations after this initial interval in which the 30 ms timing was seen, the time series disappears after the maximum value decays.</p>

<p class="author1">Micrometer keeps track of maximums in a <a href="https://oreil.ly/sHbIN" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">ring buffer</a> to achieve this decaying behavior. The ring buffer has configuration options <code class="calibre24">distributionStatisticsBufferLength</code> and <code class="calibre24">distributionStatisticExpiry</code> on <code class="calibre24">Timer.Builder</code> that you can use to decay for longer, as shown in <a data-type="xref" href="part0006_split_024.html#timer_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-20</a>. By default, Micrometer builds timers with a ring buffer of length 3, and the pointer will be advanced every 2 minutes.</p>

<p class="author1"><a data-type="xref" href="part0006_split_020.html#ring_buffer" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-6</a> is an illustration of a ring buffer of three elements. This ring buffer is just an array with a pointer to a particular element from which the maximum value will be polled whenever we publish metrics. Every <code class="calibre24">distributionStatisticExpiry</code>, the pointer is advanced to the next element in the ring buffer. The zeroth index element in this buffer has no samples in it. The first and second indexed elements are storing the state of the largest sample they have seen since their last reset, 10 ms. The darkened ring around the first index indicates that this index is the element that is currently being polled from.</p>

<figure class="calibre32"><div id="ring_buffer" class="figure">
<img src="../images/00004.png" alt="srej 0206" class="calibre74"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-6. </span>A ring buffer of three elements</h6>
</div></figure>

<p class="author1"><a data-type="xref" href="part0006_split_020.html#ring_buffer_of_maxes" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-7</a> shows a timer ring buffer with three elements and a two-minute expiry as it evolves over an eight-minute period of time. Below the figure is a minute-by-minute description of how the values are changing where <code class="calibre24">t</code> is the wall time in minutes.</p>

<figure class="calibre32"><div id="ring_buffer_of_maxes" class="figure">
<img src="../images/00033.png" alt="srej 0207" class="calibre75"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-7. </span>A timer max ring buffer of length 3 and two-minute expiry</h6>
</div></figure>
<dl class="calibre20">
<dt class="calibre21">t=0</dt>
<dd class="calibre22">
<p class="calibre23">This is the initial state. Each ring buffer element is empty. No timer recordings have been observed. Between t=0 and t=1, two timer recordings are observed: one at 10 ms and one at 8 ms.</p>
</dd>
<dt class="calibre21">t=1</dt>
<dd class="calibre22">
<p class="calibre23">Since 10 ms is the greater of the two recordings seen and every ring buffer element was previously empty, all of them now are tracking 10 ms as the maximum. If we were to publish metrics at t=1, the max would be 10 ms. Between t=1 and t=2 we observe a 7 ms timing, but it is not greater than the samples in any of the ring buffer elements.</p>
</dd>
<dt class="calibre21">t=2</dt>
<dd class="calibre22">
<p class="calibre23">The zeroth ring buffer element is reset because the expiry has been reached and the pointer is moved to index 1. Between t=2 and t=3 we see a timer recording of 6 ms. Since the zeroth element has been cleared, it now is tracking 6 ms as its view of the max. The polled max is 10 ms.</p>
</dd>
<dt class="calibre21">t=3</dt>
<dd class="calibre22">
<p class="calibre23">The oldest two ring buffer elements are still seeing 10 ms as the max, and the zeroth element is tracking 6 ms. The polled max is still 10 ms since the pointer is on index 1.</p>
</dd>
<dt class="calibre21">t=4</dt>
<dd class="calibre22">
<p class="calibre23">Index 1 is reset and the pointer is advanced to index 2. Index 2 is still tracking 10 ms, so the polled max is 10 ms.</p>
</dd>
<dt class="calibre21">t=5</dt>
<dd class="calibre22">
<p class="calibre23">Nothing changes. The polled max is 10 ms. Note that the timer would have reported a count and sum of 0 at this time and a max of 10 ms! This is what is meant by max not being aligned to the publishing interval in the same way that count and sum are.</p>
</dd>
<dt class="calibre21">t=6</dt>
<dd class="calibre22">
<p class="calibre23">Index 2 is reset and the pointer circles back to index 0, which is still hanging on to the 6 ms sample it observed between t=2 and t=3 as the max. The polled max is 6 ms. Between t=6 and t=7, a 12 ms sample is observed, which becomes the max across the ring buffer.</p>
</dd>
<dt class="calibre21">t=7</dt>
<dd class="calibre22">
<p class="calibre23">The polled max is 12 ms, observed shortly before t=7.</p>
</dd>
<dt class="calibre21">t=8</dt>
<dd class="calibre22">
<p class="calibre23">The zeroth ring buffer element is reset and the pointer moves to index 1. The polled max is 12 ms<a data-type="indexterm" data-startref="ix_ch02-asciidoc21" id="idm45139277669448" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>.<a data-type="indexterm" data-startref="ix_ch02-asciidoc20" id="idm45139277668616" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc19" id="idm45139277667912" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</dd>
</dl>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="The Sum of Sum Over an Interval" class="calibre3"><div class="preface" id="idm45139277705656">
<h2 class="calibre37" id="calibre_pb_21">The Sum of Sum Over an Interval</h2>

<p class="author1"><a data-type="indexterm" data-primary="interval, sum of sums over" id="idm45139277666088" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="sum of sums" id="idm45139277665320" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="sum of sum over an interval" id="idm45139277664648" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>There are few cases where the sum of sums is useful. In fact, I’ve only ever encountered one case of it, which we’ll see later in <a data-type="xref" href="part0009_split_018.html#8IN04-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Proportion of time spent in garbage collection”</a>, <a data-type="indexterm" data-primary="garbage collection (GC)" data-secondary="sum of sums and" id="idm45139277662616" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>where the sum of time spent in garbage collection (GC) is divided by the total amount of time in the interval in which garbage collection was happening (e.g., how much time was spent in GC altogether). Even in this case, we probably could develop a better alert signal for garbage collection if the JVM provided us with discrete timings for every garbage collection event as it occurred. If it did, we might look at high-percentile GC times or max GC time by cause.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="The Base Unit of Time" class="calibre3"><div class="preface" id="idm45139277660776">
<h2 class="calibre37" id="calibre_pb_22">The Base Unit of Time</h2>

<p class="author1"><a data-type="indexterm" data-primary="base unit of time" id="idm45139277659368" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="base unit of time" id="idm45139277658664" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The appropriate base unit for timers varies by monitoring system. For example, Prometheus expects floating point second-precision data because conceptually seconds are a base unit of time. Atlas expects nanosecond-precision data because it can then accept and store integral values. Since it isn’t possible to measure a subdivision of a nanosecond (and in many cases it isn’t even possible to measure in true nanosecond precision), the backend takes advantage of this optimization. Regardless, Micrometer automatically scales timings to the expected base unit for each monitoring system.</p>

<p class="author1">Neither one of these base units is right or wrong, and neither less precise. It is simply a matter of convention in each. The base unit of time doesn’t affect the <em class="calibre12">precision</em> of charts. Even though Micrometer ships times in seconds to Prometheus, for example, the chart will often still be displayed, like in <a data-type="xref" href="part0006_split_022.html#timer_base_unit_of_time_scaling" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-8</a>, in milliseconds for common timers like those used to monitor user-facing API endpoints.</p>

<figure class="calibre32"><div id="timer_base_unit_of_time_scaling" class="figure">
<img src="../images/00113.png" alt="srej 0208" class="calibre76"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-8. </span>A timer shipped with <em class="calibre12">seconds</em> base units displayed in milliseconds</h6>
</div></figure>

<p class="author1">We’ll cover charting more in <a data-type="xref" href="part0009_split_000.html#8IL24-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Chapter 4</a>, but for now, just know that scaling in this way is often accomplished automatically by the charting interface. We just need to tell it how to interpret the statistic, i.e., to say that the time series being displayed is dimensioned in seconds, as in <a data-type="xref" href="part0006_split_022.html#grafana_yaxis_seconds" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-9</a>.</p>

<figure class="calibre32"><div id="grafana_yaxis_seconds" class="figure">
<img src="../images/00008.png" alt="srej 0209" class="calibre77"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-9. </span>Informing the charting library how to interpret timer base units</h6>
</div></figure>

<p class="author1">In this case, Grafana is smart enough to know that it is easier for humans to read in milliseconds than small fractions of a second, so it scales the seconds data down to milliseconds. Similarly, if it is canonical to represent timings in nanoseconds to a particular monitoring system, the charting library would perform the opposite math to scale the values up to milliseconds.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="The Base Unit of Time" class="calibre3">
<div class="preface" id="idm45139277660776">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_23">Common Base Units Don’t Limit How You View the Data</h1>
<p class="author1">For common units like time and data size (e.g., bytes), you shouldn’t need to concern yourself with how you intend to <em class="calibre12">view</em> the data to decide what scale you <em class="calibre12">record</em> at. It’s generally preferable to be consistent with your base units everywhere and allow the charting library later to do this sort of automatic scaling to a human-readable format. Rather than recording the payload size of a response body in bytes (because it will generally be small) and the size of the heap in megabytes (because it will generally be large), record both in bytes. They will both be scaled to reasonable values later when you go to view them.</p>
</div>

<p class="author1">For monitoring systems that do not have a clear preference for base unit of time, Micrometer chooses one; and it is not generally configurable because consistency across all applications is more important than changing the base unit of time when precision is not sacrificed either way.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Using Timers" class="calibre3"><div class="preface" id="idm45139277643608">
<h2 class="calibre37" id="5N4PV-2d714b853a094e9a910510217e0e3d73">Using Timers</h2>

<p class="author1"><a data-type="indexterm" data-primary="timers" data-secondary="using" id="ix_ch02-asciidoc22" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The <a data-type="indexterm" data-primary="MeterRegistry" data-secondary="timer creation" id="idm45139277640312" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><code class="calibre24">MeterRegistry</code> interface contains convenience methods for creating timers, as shown in <a data-type="xref" href="part0006_split_024.html#timer_create" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-19</a>.</p>
<div id="timer_create" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-19. </span>Creating timers</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="c">// No tags</code>
<code class="n">Timer</code>  <code class="n">timer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">);</code>

<code class="c">// Adding tags in key-value pairs with varargs</code>
<code class="n">Timer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">,</code> <code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">);</code>

<code class="c">// Explicit tag list creation</code>
<code class="n">Timer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">,</code> <code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">));</code></pre></div>

<p class="author1">The <code class="calibre24">Timer</code> fluent builder (see <a data-type="xref" href="part0006_split_024.html#timer_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-20</a>) contains more options. Most of the time you won’t use all of these options.</p>
<div id="timer_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-20. </span>Fluent builder for timers</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Timer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">Timer</code>
    <code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"a description of what this timer does"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">distributionStatisticExpiry</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofMinutes</code><code class="o">(</code><code class="mi">2</code><code class="o">))</code>
    <code class="o">.</code><code class="na">distributionStatisticBufferLength</code><code class="o">(</code><code class="mi">3</code><code class="o">)</code>
    <code class="o">.</code><code class="na">serviceLevelObjectives</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofMillis</code><code class="o">(</code><code class="mi">100</code><code class="o">),</code> <code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">))</code>
    <code class="o">.</code><code class="na">publishPercentiles</code><code class="o">(</code><code class="mi">0.95</code><code class="o">,</code> <code class="mi">0.99</code><code class="o">)</code>
    <code class="o">.</code><code class="na">publishPercentileHistogram</code><code class="o">()</code>
    <code class="o">.</code><code class="na">tags</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1">The <code class="calibre24">Timer</code> interface exposes several convenience overloads for recording timings inline, such as in <a data-type="xref" href="part0006_split_024.html#timer_record_execution" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-21</a>. Additionally, a <code class="calibre24">Runnable</code> or <code class="calibre24">Callable</code> can be wrapped with instrumentation and returned for use later.</p>
<div id="timer_record_execution" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-21. </span>Recording execution with a timer</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">timer</code><code class="o">.</code><code class="na">record</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">dontCareAboutReturnValue</code><code class="o">());</code>
<code class="n">timer</code><code class="o">.</code><code class="na">recordCallable</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">returnValue</code><code class="o">());</code>

<code class="n">Runnable</code> <code class="n">r</code> <code class="o">=</code> <code class="n">timer</code><code class="o">.</code><code class="na">wrap</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">dontCareAboutReturnValue</code><code class="o">());</code>
<code class="n">Callable</code> <code class="n">c</code> <code class="o">=</code> <code class="n">timer</code><code class="o">.</code><code class="na">wrap</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">returnValue</code><code class="o">());</code></pre></div>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Using Timers" class="calibre3">
<div class="preface" id="idm45139277643608">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_25">Timers Versus Distribution Summaries</h1>
<p class="author1"><a data-type="indexterm" data-primary="distribution summaries" id="idm45139277460152" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="distribution summaries versus" id="idm45139277459320" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><code class="calibre24">Timers</code> are really just a specialized form of distribution summaries (see <a data-type="xref" href="part0007_split_009.html#distribution_summaries" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Distribution Summaries”</a>) that are aware of how to scale durations to the base unit of time of each monitoring system and that have an automatically determined base unit. In almost every case where you want to measure time, you should use a <code class="calibre24">Timer</code> rather than a <code class="calibre24">DistributionSummary</code>. The rare exception to this is when recording many long-duration events in a short interval, such that the nanosecond-precision <code class="calibre24">Timer</code> would overflow ~290 years (since Java’s long can effectively store a maximum of 9.22e9 seconds) inside of a single interval.</p>
</div>

<p class="author1">You may also store start state in a sample instance that can be stopped later. The sample records a start time based on the registry’s clock. After starting a sample, execute the code to be timed, and finish the operation by calling <code class="calibre24">stop(Timer)</code> on the sample.</p>

<p class="author1">Notice in <a data-type="xref" href="part0006_split_025.html#timer_sample" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-22</a> how the timer that the sample is accumulating to is not determined until it is time to stop the sample. This allows some tags to be determined dynamically from the end state of the operation we are timing. The use of <code class="calibre24">Timer.Sample</code> is especially common when we are dealing with some event-driven interface with a listener pattern. This example is a simplified form of Micrometer’s JOOQ execution listener.</p>
<div id="timer_sample" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-22. </span>Use of timer samples for event-driven patterns</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">class</code><code class="calibre24"> </code><code class="nc">JooqExecuteListener</code><code class="calibre24"> </code><code class="k">extends</code><code class="calibre24"> </code><code class="n">DefaultExecuteListener</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">private</code><code class="calibre24"> </code><code class="k">final</code><code class="calibre24"> </code><code class="n">Map</code><code class="o">&lt;</code><code class="n">ExecuteContext</code><code class="o">,</code><code class="calibre24"> </code><code class="n">Timer</code><code class="o">.</code><code class="na">Sample</code><code class="o">&gt;</code><code class="calibre24"> </code><code class="n">sampleByExecuteContext</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="n">ConcurrentHashMap</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Override</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">public</code><code class="calibre24"> </code><code class="kt">void</code><code class="calibre24"> </code><code class="nf">start</code><code class="o">(</code><code class="n">ExecuteContext</code><code class="calibre24"> </code><code class="n">ctx</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">Timer</code><code class="o">.</code><code class="na">Sample</code><code class="calibre24"> </code><code class="n">sample</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">Timer</code><code class="o">.</code><code class="na">start</code><code class="o">(</code><code class="n">registry</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">sampleByExecuteContext</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">ctx</code><code class="o">,</code><code class="calibre24"> </code><code class="n">sample</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Override</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">public</code><code class="calibre24"> </code><code class="kt">void</code><code class="calibre24"> </code><code class="nf">end</code><code class="o">(</code><code class="n">ExecuteContext</code><code class="calibre24"> </code><code class="n">ctx</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">Timer</code><code class="o">.</code><code class="na">Sample</code><code class="calibre24"> </code><code class="n">sample</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">sampleByExecuteContext</code><code class="o">.</code><code class="na">remove</code><code class="o">(</code><code class="n">sample</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">sample</code><code class="o">.</code><code class="na">stop</code><code class="o">(</code><code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"jooq.query"</code><code class="o">,</code><code class="calibre24"> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO4-1" href="part0006_split_025.html#callout_application_metrics_CO4-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO4-1" href="part0006_split_025.html#co_application_metrics_CO4-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">We would typically add some tags based on the result of the execution with data elements found in <code class="calibre24">ExecuteContext</code>.</p></dd>
</dl>

<p class="author1">There is also an <code class="calibre24">AutoCloseable</code> form of timer sample that is useful when timing blocks of code that contain checked exception handling, as shown in <a data-type="xref" href="part0006_split_025.html#timer_closeable_sample" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-23</a>. The pattern does require nested <code class="calibre24">try</code> statements, which are a bit unusual. If you are uncomfortable with this pattern, you can absolutely stick to a simple <code class="calibre24">Timer.Sample</code>.</p>
<div id="timer_closeable_sample" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-23. </span>Use of timer samples</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">try</code><code class="calibre24"> </code><code class="o">(</code><code class="n">Timer</code><code class="o">.</code><code class="na">ResourceSample</code><code class="calibre24"> </code><code class="n">sample</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">Timer</code><code class="o">.</code><code class="na">resource</code><code class="o">(</code><code class="n">registry</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"requests"</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">tag</code><code class="o">(</code><code class="s">"method"</code><code class="o">,</code><code class="calibre24"> </code><code class="n">request</code><code class="o">.</code><code class="na">getMethod</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO5-1" href="part0006_split_025.html#callout_application_metrics_CO5-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"This is an operation"</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">publishPercentileHistogram</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">try</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO5-2" href="part0006_split_025.html#callout_application_metrics_CO5-2"><img src="../images/00059.png" alt="2" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">        </code><code class="k">if</code><code class="calibre24"> </code><code class="o">(</code><code class="n">outcome</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"error"</code><code class="o">)</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">            </code><code class="k">throw</code><code class="calibre24"> </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">IllegalArgumentException</code><code class="o">(</code><code class="s">"boom"</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="n">sample</code><code class="o">.</code><code class="na">tag</code><code class="o">(</code><code class="s">"outcome"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"success"</code><code class="o">)</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO5-3" href="part0006_split_025.html#callout_application_metrics_CO5-3"><img src="../images/00067.png" alt="3" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24"> </code><code class="k">catch</code><code class="calibre24"> </code><code class="o">(</code><code class="n">Throwable</code><code class="calibre24"> </code><code class="n">t</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="n">sample</code><code class="o">.</code><code class="na">tag</code><code class="o">(</code><code class="s">"outcome"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"error"</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO5-1" href="part0006_split_025.html#co_application_metrics_CO5-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">This tag will apply to both outcomes. Description text and percentile histograms will also apply to both outcomes.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO5-2" href="part0006_split_025.html#co_application_metrics_CO5-2"><img src="../images/00059.png" alt="2" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">This nested try statement makes it possible to access the <code class="calibre24">Timer.ResourceSample</code> in the catch block for adding error tags.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO5-3" href="part0006_split_025.html#co_application_metrics_CO5-3"><img src="../images/00067.png" alt="3" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">We can add tags at each branching point in the <code class="calibre24">try/catch</code> block to record information about the outcome.</p></dd>
</dl>

<p class="author1">Micrometer has built-in metrics that include several timers. Some examples are given in <a data-type="xref" href="part0006_split_025.html#timer_examples" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-10</a>.</p>
<table id="timer_examples" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-10. </span>Examples of timers in Micrometer built-in instrumentation</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric name</th>
<th class="calibre44">Description</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http.server.requests</p></td>
<td class="calibre47"><p class="calibre48">Spring Boot records timings for executions of WebMVC and WebFlux request handlers.</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">jvm.gc.pause</p></td>
<td class="calibre47"><p class="calibre48">Time spent in GC pause.</p></td>
</tr>
<tr class="calibre59">
<td class="calibre47"><p class="calibre48">mongodb.driver.commands</p></td>
<td class="calibre47"><p class="calibre48">Time spent in MongoDB operations.</p></td>
</tr>
</tbody>
</table>

<p class="author1">Timers are the metrics corollary to distributed tracing (discussed in depth in <a data-type="xref" href="part0008_split_000.html#7K4G4-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Chapter 3</a>) in the sense that trace spans and timers can instrument the same code, as in <a data-type="xref" href="part0007_split_000.html#trace_and_timing" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-24</a>.</p>
<div data-type="note" type="note" class="calibre28"><div class="preface" id="calibre_pb_0"/>
</div>

</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Using Timers" class="calibre3">
<div class="preface" id="idm45139277643608">
<div data-type="note" type="note" class="calibre28">
<h1 class="calibre54" id="calibre_pb_0">The Intersection of Tracing and Metrics</h1>
<p class="author1">The overlap between distributed tracing and metrics is strictly limited to timing.</p>
</div>

<p class="author1">The sample code uses Zipkin’s Brave instrumentation, which we’ll see again later.</p>
<div id="trace_and_timing" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-24. </span>Tracing and timing the same block of code</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="c">// Start a new trace
</code><code class="n">ScopedSpan</code><code class="calibre24"> </code><code class="n">span</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">tracer</code><code class="o">.</code><code class="na">startScopedSpan</code><code class="o">(</code><code class="s">"encode"</code><code class="o">)</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO6-1" href="part0007_split_000.html#callout_application_metrics_CO6-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="k">try</code><code class="calibre24"> </code><code class="o">(</code><code class="n">Timer</code><code class="o">.</code><code class="na">ResourceSample</code><code class="calibre24"> </code><code class="n">sample</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">Timer</code><code class="o">.</code><code class="na">resource</code><code class="o">(</code><code class="n">registry</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"encode"</code><code class="o">)</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">try</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">encoder</code><code class="o">.</code><code class="na">encode</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">sample</code><code class="o">.</code><code class="na">stop</code><code class="o">(</code><code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"encode"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"result"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"success"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24"> </code><code class="k">catch</code><code class="calibre24"> </code><code class="o">(</code><code class="n">RuntimeException</code><code class="calibre24"> </code><code class="o">|</code><code class="calibre24"> </code><code class="n">Error</code><code class="calibre24"> </code><code class="n">e</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">span</code><code class="o">.</code><code class="na">error</code><code class="o">(</code><code class="n">e</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">sample</code><code class="o">.</code><code class="na">stop</code><code class="o">(</code><code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"encode"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"result"</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"failure"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="k">throw</code><code class="calibre24"> </code><code class="n">e</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24"> </code><code class="k">finally</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">span</code><code class="o">.</code><code class="na">finish</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO6-1" href="part0007_split_000.html#co_application_metrics_CO6-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Brave doesn’t have an AutoCloseable construct like Micrometer, so the instrumentation looks a little asymmetric.</p></dd>
</dl>

<p class="author1">It’s natural to assume that a particular block of code, given similar inputs, would execute in roughly the same amount of time. Our intuition about this can be misleading.<a data-type="indexterm" data-startref="ix_ch02-asciidoc22" id="idm45139276968200" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Common Features of Latency Distributions" class="calibre3"><div class="preface" id="idm45139277642664">
<h2 class="calibre37" id="calibre_pb_1">Common Features of Latency Distributions</h2>

<p class="author1"><a data-type="indexterm" data-primary="latency distributions, common features of" id="ix_ch02-asciidoc23" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="common features of latency distributions" id="ix_ch02-asciidoc24" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>It is important to understand some common characteristics of timings in Java applications. The same block of code will not execute in the same amount of time on each execution due to variance in the input parameters, downstream systems, the state of the heap, and many other variables. Nevertheless, many requests with similar inputs will commonly be satisfied in a similar amount of time.</p>

<p class="author1">Intuition may lead to a belief that timings are roughly normally distributed, i.e., that there is a central hump around the average with lower-probability tails for both faster and slower response times, like in <a data-type="xref" href="part0007_split_001.html#normal_distribution" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-10</a>.</p>

<figure class="calibre32"><div id="normal_distribution" class="figure">
<img src="../images/00050.png" alt="srej 0210" class="calibre78"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-10. </span>The normal distribution</h6>
</div></figure>

<p class="author1">In real-world cases, timings are almost always multimodal, meaning there is more than one “hump,” or grouping of timings, along the latency spectrum. Most commonly, Java timings are bimodal (two humps, as shown in <a data-type="xref" href="part0007_split_001.html#bimodal" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-11</a>), with the smaller, rightmost hump representing events like garbage collection and VM pauses. That second hump also includes a ripple effect of the multimodality in downstream services.</p>

<figure class="calibre32"><div id="bimodal" class="figure">
<img src="../images/00056.png" alt="srej 0211" class="calibre79"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-11. </span>A typical bimodal distribution of Java latencies</h6>
</div></figure>

<p class="author1">Bizarrely, the bigger, leftmost hump is often (though not always, of course) quite narrow and contains more than 99% of the timings. As a result, the 99th percentile (see <a data-type="xref" href="part0007_split_003.html#6LK44-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Percentiles/Quantiles”</a>) will in many cases be below the average, which is skewed higher by the second hump.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Common Features of Latency Distributions" class="calibre3">
<div class="preface" id="idm45139277642664">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_2">Standard Deviation</h1>
<p class="author1"><a data-type="indexterm" data-primary="standard deviation" id="idm45139276954168" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Some metrics instrumentation libraries and systems ship and display standard deviation. This metric only makes sense in the context of a normal distribution, which we’ve seen is essentially never the case. Standard deviation is not a meaningful statistic for real-world timings of Java executions. Ignore it! Also, ignore average.<a data-type="indexterm" data-startref="ix_ch02-asciidoc24" id="idm45139276952984" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc23" id="idm45139276952312" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Percentiles/Quantiles" class="calibre3"><div class="preface" id="percentiles_quantiles">
<h2 class="calibre37" id="6LK44-2d714b853a094e9a910510217e0e3d73">Percentiles/Quantiles</h2>

<p class="author1"><a data-type="indexterm" data-primary="percentiles" id="ix_ch02-asciidoc25" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="quantiles" id="ix_ch02-asciidoc26" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="percentiles/quantiles" id="ix_ch02-asciidoc27" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Did I mention not to use <a data-type="indexterm" data-primary="average latency" id="idm45139276946168" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="latency" data-secondary="average" id="idm45139276945496" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>average latency? At this point, you can probably see that I won’t miss an opportunity to pounce on average latency.</p>
<blockquote class="pcalibre8 pcalibre9 pcalibre7">
<p class="calibre16">Average: a random number that falls somewhere between the maximum and 1/2 the median. Most often used to ignore reality.</p>
<p data-type="attribution" class="pcalibre10 pcalibre11">Gil Tene</p>
</blockquote>

<p class="author1">Average latency is a poor metric to monitor to assess latency behavior, and max is a useful alert threshold but can be spiky. For comparative performance, we can look at high-percentile values, which are less spiky. High max spikes will certainly be more prevalent in less-performant code, but in any case <em class="calibre12">when</em> they occur is not under your control, making side-by-side comparisons even of identical blocks of code running on two different instances difficult.</p>

<p class="author1">Depending on the monitoring system, the term <em class="calibre12">percentile</em>, or <em class="calibre12">quantile</em>, is used to describe a point in a set of samples that relates to the rank order of its values. So the middle quantile, which is also called the median or the 50th percentile, is the middle value in a set of samples ranked from least to greatest.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Percentiles/Quantiles" class="calibre3">
<div class="preface" id="percentiles_quantiles">
<div data-type="note" type="note" class="calibre28"><h1 class="calibre54" id="calibre_pb_4">Median Versus Average</h1>
<p class="author1"><a data-type="indexterm" data-primary="average, median versus" id="idm45139276938584" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="median, average versus" id="idm45139276937880" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="median versus average" id="idm45139276937208" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Average is rarely useful for monitoring timings. Statistically, the average is the sum of all samples divided by the total number of samples. The average is just a different measure of centrality than the median, not better or worse in general at representing centrality. Even if it were a “perfect” measure of centrality, for the purpose of proving our system is reliable we care more about the <em class="calibre12">worst</em> half of the distribution, not the best half.</p>
</div>

<p class="author1">Percentiles are a special type of quantile, described relative to 100%. In a list of 100 samples ordered from least to greatest, the 99th percentile (P99) is the 99th sample in order. In a list of 1,000 samples, the 99.9th percentile is the 999th sample.</p>

<p class="author1">By this definition, percentiles, particularly high percentiles, are useful for determining what <em class="calibre12">most</em> users are experiencing (i.e., P99 is the worst latency that 99 out of 100 users experienced). For timings, percentiles usefully cut out the spiky behavior of VM or garbage collection pauses while still preserving majority user experience.</p>

<p class="author1">It is tempting to monitor a high-percentile value like the 99th and feel at ease that your users are experiencing good response times. Unfortunately, our intuition leads us astray with these statistics. The top 1% typically hides latencies that are one or two orders of magnitude larger than P99.</p>

<p class="author1">Any single request will avoid the top 1% exactly 99% of the time. When considering <code class="calibre24">N</code> requests, the chance that at least one of these requests is in the top 1% is <math alttext="left-parenthesis 1 minus 0.99 Superscript upper N Baseline right-parenthesis asterisk 100 percent-sign">
  <mrow>
    <mo>(</mo>
    <mn>1</mn>
    <mo>-</mo>
    <mn>0</mn>
    <mo>.</mo>
    <msup><mn>99</mn> <mi>N</mi> </msup>
    <mo>)</mo>
    <mo>*</mo>
    <mn>100</mn>
    <mo>%</mo>
  </mrow>
</math> (assuming these probabilities are independent, of course). It takes surprisingly few requests for there to be a greater than majority chance that one request will hit the top 1%. For 100 individual requests, the chance is <math alttext="left-parenthesis 1 minus 0.99 Superscript 100 Baseline right-parenthesis asterisk 100 percent-sign equals 63.3 percent-sign">
  <mrow>
    <mo>(</mo>
    <mn>1</mn>
    <mo>-</mo>
    <mn>0</mn>
    <mo>.</mo>
    <msup><mn>99</mn> <mn>100</mn> </msup>
    <mo>)</mo>
    <mo>*</mo>
    <mn>100</mn>
    <mo>%</mo>
    <mo>=</mo>
    <mn>63</mn>
    <mo>.</mo>
    <mn>3</mn>
    <mo>%</mo>
  </mrow>
</math>!</p>

<p class="author1">Consider the fact that a user interaction with your system likely involves many resource interactions (UI, API gateway, multiple microservice calls, some database interactions, etc.). The chance that any individual end-to-end <em class="calibre12">user interaction</em> experiences a top 1% latency on some resource in the chain of events satisfying their request is actually much higher than 1%. We can approximate this chance as <math alttext="left-parenthesis 1 minus 0.99 Superscript upper N Baseline right-parenthesis asterisk 100 percent-sign">
  <mrow>
    <mo>(</mo>
    <mn>1</mn>
    <mo>-</mo>
    <mn>0</mn>
    <mo>.</mo>
    <msup><mn>99</mn> <mi>N</mi> </msup>
    <mo>)</mo>
    <mo>*</mo>
    <mn>100</mn>
    <mo>%</mo>
  </mrow>
</math>. If a single request in a chain of microservices experiences a top 1% latency, then the whole user experience suffers, especially given the fact that the top 1% tends to be an order of magnitude or more worse in performance than requests under the 99th percentile.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Percentiles/Quantiles" class="calibre3">
<div class="preface" id="percentiles_quantiles">
<div data-type="note" type="note" class="calibre28"><h1 class="calibre54" id="calibre_pb_5">Time (Anti-)Correlation of Samples</h1>
<p class="author1"><a data-type="indexterm" data-primary="anti-correlation of samples" id="idm45139276906792" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="sampling" data-secondary="time correlation of samples" id="idm45139276906024" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="time correlation of samples" id="idm45139276905064" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="time correlation of samples" id="idm45139276904376" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The formulas given to determine the chance of experiencing a top 1% latency are only approximations. In reality, time-correlation of high/low latency leads to a lower chance, and anti-correlation would lead to a higher chance. In other words, the probabilities for each request aren’t truly independent. We almost never have information about this correlation, so the approximations are useful guides for how you should reason about your system.</p>
</div>

<p class="author1">Micrometer supports two ways of computing percentiles for timers:</p>

<ul class="printings">
<li class="calibre15">
<p class="calibre18">Precompute the percentile value and ship it directly to the monitoring system.</p>
</li>
<li class="calibre15">
<p class="calibre18">Group timings into discrete sets of latency buckets, and ship the sets of buckets together to the monitoring system (see <a data-type="xref" href="part0007_split_007.html#6LKA8-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Histograms”</a>). The monitoring system is then responsible for computing the percentile from a histogram.</p>
</li>
</ul>

<p class="author1">Precomputing percentile values is the most portable approach since many monitoring systems don’t support histogram-based percentile approximation, but it’s useful only in a narrow set of circumstances (we’ll see why a little later in this section). Precomputed percentiles can be added to a timer in a few different ways.</p>

<p class="author1">The <code class="calibre24">Timer</code> fluent builder supports adding percentiles directly as the <code class="calibre24">Timer</code> is being constructed, as shown in <a data-type="xref" href="part0007_split_005.html#timer_percentile_fluent" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-25</a>.</p>
<div id="timer_percentile_fluent" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-25. </span>Adding percentiles to a Timer via the builder</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Timer</code> <code class="n">requestsTimer</code> <code class="o">=</code> <code class="n">Timer</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">publishPercentiles</code><code class="o">(</code><code class="mi">0.99</code><code class="o">,</code> <code class="mi">0.999</code><code class="o">)</code>
  <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1"><a data-type="xref" href="part0007_split_005.html#timer_percentile_meter_filter" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-26</a> shows how to add percentiles with a <code class="calibre24">MeterFilter</code>.</p>
<div id="timer_percentile_meter_filter" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-26. </span>Adding percentiles to a Timer via a MeterFilter</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">().</code><code class="na">meterFilter</code><code class="o">(</code><code class="k">new</code> <code class="n">MeterFilter</code><code class="o">()</code> <code class="o">{</code>
  <code class="nd">@Override</code>
  <code class="k">public</code> <code class="n">DistributionStatisticConfig</code> <code class="nf">configure</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="n">id</code><code class="o">,</code>
      <code class="n">DistributionStatisticConfig</code> <code class="n">config</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">if</code> <code class="o">(</code><code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">().</code><code class="na">equals</code><code class="o">(</code><code class="s">"requests"</code><code class="o">))</code> <code class="o">{</code>
      <code class="n">DistributionStatisticConfig</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
        <code class="o">.</code><code class="na">publishPercentiles</code><code class="o">(</code><code class="mi">0.99</code><code class="o">,</code> <code class="mi">0.999</code><code class="o">)</code>
        <code class="o">.</code><code class="na">build</code><code class="o">()</code>
        <code class="o">.</code><code class="na">merge</code><code class="o">(</code><code class="n">config</code><code class="o">);</code>
    <code class="o">}</code>
    <code class="k">return</code> <code class="n">config</code><code class="o">;</code>
  <code class="o">}</code>
<code class="o">});</code>

<code class="o">...</code>

<code class="c">// The filter will apply to this timer as it is created</code>
<code class="n">Timer</code> <code class="n">requestsTimer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"requests"</code><code class="o">);</code></pre></div>

<p class="author1">Lastly, frameworks like Spring Boot offer property-driven <code class="calibre24">MeterFilter</code> equivalents that allow you to add percentiles to <code class="calibre24">Timers</code> declaratively. The configuration shown in <a data-type="xref" href="part0007_split_005.html#property_driven_percentiles" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-27</a> adds percentiles to any timer prefixed with the name <code class="calibre24">requests</code>.</p>
<div id="property_driven_percentiles" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-27. </span>Adding percentiles to metrics prefixed with “requests” in Spring Boot</h5>

<pre data-type="programlisting" class="calibre63">management.metrics.distribution.percentiles.requests=0.99,0.999</pre></div>

<p class="author1">Adding percentiles through a <code class="calibre24">MeterFilter</code> allows you to add percentile support to <code class="calibre24">Timers</code> that are created not just in your application code, but in other libraries you are including in your application that contain Micrometer instrumentation.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Percentiles/Quantiles" class="calibre3">
<div class="preface" id="percentiles_quantiles">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_6">Adding Timers to Library Code</h1>
<p class="author1"><a data-type="indexterm" data-primary="library code, adding timers to" id="idm45139276639416" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="adding to library code" id="idm45139276638648" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>If you are authoring a library and including timing code, do not preconfigure your timers with features like percentiles, histograms, and SLO boundaries. These features all have some performance cost, even if it is minimal. Allow the consumers of your library to determine if the timing is an important enough indicator to warrant the extra expense of these statistics. In particular, end users will want to turn on histograms when they intend to use the timing as part of a comparative measure, like in <a data-type="xref" href="part0010_split_013.html#9H5VC-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Automated Canary Analysis”</a>. When needed, users can configure these statistics with a <code class="calibre24">MeterFilter</code>.</p>
</div>

<p class="author1">Wherever a timer metric has more than a few total unique combinations of tags, pre-computed percentiles are unusable because they cannot be combined or aggregated. On a cluster of two instances, if the 90th percentile latency for a request endpoint is 100 ms on one application instance and 200 ms on another, we can’t simply average these two values together to arrive at a cluster-wide 90th percentile latency of 150 ms.</p>

<p class="author1"><a data-type="xref" href="part0007_split_006.html#percentiles_for_two_instances" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-11</a> shows why, using the median (50th percentile) as an example. Since the individual samples that went into this percentile calculation were thrown away, there is no way to reconstitute them to derive a cluster-wide percentile at the monitoring system.</p>
<table id="percentiles_for_two_instances" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-11. </span>P50 (median) request latency in a cluster of two instances</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Instance</th>
<th class="calibre44">Individual latencies (ms)</th>
<th class="calibre44">P50 latency (ms)</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">1</p></td>
<td class="calibre47"><p class="calibre48">[100,110,125]</p></td>
<td class="calibre47"><p class="calibre48">110</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">2</p></td>
<td class="calibre47"><p class="calibre48">[125,130,140]</p></td>
<td class="calibre47"><p class="calibre48">130</p></td>
</tr>
<tr class="calibre59">
<td class="calibre47"><p class="calibre48">Whole cluster</p></td>
<td class="calibre47"><p class="calibre48">[100,110,125,125,130,140]</p></td>
<td class="calibre47"><p class="calibre48">125</p></td>
</tr>
</tbody>
</table>

<p class="author1">The best we can do with precomputed percentiles is to simply plot all of the values and look for outliers, as in <a data-type="xref" href="part0007_split_006.html#p99_not_aggregated" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-12</a>, generated from the Prometheus query <code class="calibre24">requests_second{quantile=0.99}</code>.</p>

<figure class="calibre32"><div id="p99_not_aggregated" class="figure">
<img src="../images/00103.png" alt="srej 0212" class="calibre80"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-12. </span>99th percentile of a single timer for individual application instances</h6>
</div></figure>

<p class="author1">This scales to a point; but as the number of instances grows (imagine we had a cluster of 100 instances!), the visualization quickly becomes crowded. Attempts to limit the number of lines displayed to select just the top <em class="calibre12">N</em> worst latencies can result in situations where the legend is still full of individual instance IDs. This is because, as we see in <a data-type="xref" href="part0007_split_006.html#p99_topk" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-13</a>, where we are selecting the top three worst latencies with the Prometheus query <code class="calibre24">topk(3, requests_second{quantile=0.99})</code>, the third-worst instance changes virtually every interval.</p>

<figure class="calibre32"><div id="p99_topk" class="figure">
<img src="../images/00090.png" alt="srej 0213" class="calibre81"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-13. </span>Top three worst 99th percentile of a single timer for individual application instances</h6>
</div></figure>

<p class="author1">Because of the limitations of precomputed percentiles, if you are working with a monitoring system that supports histograms, <em class="calibre12">always</em> use them instead, as described in the following section.<a data-type="indexterm" data-startref="ix_ch02-asciidoc27" id="idm45139276613880" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc26" id="idm45139276613176" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc25" id="idm45139276612504" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Histograms" class="calibre3"><div class="preface" id="histograms">
<h2 class="calibre37" id="6LKA8-2d714b853a094e9a910510217e0e3d73">Histograms</h2>

<p class="author1"><a data-type="indexterm" data-primary="histograms" id="ix_ch02-asciidoc28" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="histograms" id="ix_ch02-asciidoc29" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Metrics are always presented in aggregated form to the monitoring system. The individual timings that together we represent as the latency of a block of code are not shipped to the monitoring system. If they were, metrics would no longer have a fixed cost irrespective of throughput.</p>

<p class="author1">We can send an approximation of what the individual timings looked like together in a histogram. <a data-type="indexterm" data-primary="buckets" id="idm45139276606824" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>In a histogram, the range of possible timings is divided into a series of buckets. For each bucket (also known as an <em class="calibre12">interval</em> or <em class="calibre12">bin</em>), the histogram maintains a count of how many individual timings fell into that bucket. The buckets are consecutive and nonoverlapping. They are not often of equal size, since there is generally some part of the range which we care about at a more fine-grained level than others. For example, for an API endpoint latency histogram, we care more about the distinction between 1, 10, and 100 ms latencies than we do about 40 s and 41 s latencies. The latency buckets will be more granular around the expected value than well outside the expected value.</p>

<p class="author1">Importantly, by accumulating all the individual timings into buckets, and controlling the number of buckets, we can retain the shape of the distribution while maintaining a fixed cost.</p>

<p class="author1">Histograms are represented in the monitoring system’s storage as a series of counters. In the case of Prometheus, as in <a data-type="xref" href="part0007_split_007.html#histogram_bucket_storage" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Table 2-12</a>, these counters have a special tag <code class="calibre24">le</code> that indicates that the metric is a count of all samples less than or equal to the tag value (in seconds).</p>
<table id="histogram_bucket_storage" class="calibre40">
<caption class="calibre41"><span class="keep-together">Table 2-12. </span>How histogram buckets are stored in a time series database (Prometheus)</caption>
<thead class="calibre42">
<tr class="calibre43">
<th class="calibre44">Metric name</th>
<th class="calibre44">Values</th>
</tr>
</thead>
<tbody class="calibre45">
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http_server_requests_seconds_bucket{status=200,le=0.1}</p></td>
<td class="calibre47"><p class="calibre48">[10,10,12,15]</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">http_server_requests_seconds_bucket{status=200,le=0.2}</p></td>
<td class="calibre47"><p class="calibre48">[20,20,24,26]</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http_server_requests_seconds_bucket{status=200,le=0.5}</p></td>
<td class="calibre47"><p class="calibre48">[30,30,40,67]</p></td>
</tr>
<tr class="calibre49">
<td class="calibre47"><p class="calibre48">http_server_requests_seconds_bucket{status=500,le=0.1}</p></td>
<td class="calibre47"><p class="calibre48">[1,1,2,5]</p></td>
</tr>
<tr class="calibre46">
<td class="calibre47"><p class="calibre48">http_server_requests_seconds_bucket{status=500,le=0.2}</p></td>
<td class="calibre47"><p class="calibre48">[1,1,2,6]</p></td>
</tr>
<tr class="calibre50">
<td class="calibre47"><p class="calibre48">http_server_requests_seconds_bucket{status=500,le=0.5}</p></td>
<td class="calibre47"><p class="calibre48">[1,1,2,6]</p></td>
</tr>
</tbody>
</table>

<p class="author1"><a data-type="indexterm" data-primary="cumulative histograms" id="idm45139276588456" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="normal histograms" id="idm45139276587752" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Depending on the monitoring system, a histogram may appear as either a normal or a cumulative histogram. A visual distinction between these two types of histograms is shown in <a data-type="xref" href="part0007_split_007.html#cumulative_vs_normal_histogram" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-14</a>. Cumulative histogram buckets represent the count of all timings less than or equal to their boundary. Note that the timer’s count is equal to the sum of all buckets in a normal histogram.</p>

<figure class="calibre32"><div id="cumulative_vs_normal_histogram" class="figure">
<img src="../images/00095.png" alt="srej 0214" class="calibre82"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-14. </span>Cumulative versus normal histogram</h6>
</div></figure>

<p class="author1">Like adding any other tag, adding histogram data to a timer increases the total required storage by a factor equal to the number of buckets that the range is subdivided into. In this example, since there are three buckets (0.1 s, 0.2 s, and 0.5 s) there will be three times the number of permutations of other tags’ time series stored.</p>

<p class="author1">This histogram is published each interval to the monitoring system. The histograms for each interval can be assembled into a heatmap. <a data-type="xref" href="part0007_split_007.html#latency_heatmap" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-15</a> shows the heatmap for the latency of an API endpoint. Most requests are served in ~1 ms, but there is a long tail of latencies leading all the way up to &gt;100 ms in each interval.</p>

<figure class="calibre32"><div id="latency_heatmap" class="figure">
<img src="../images/00078.png" alt="A heatmap of request latency" class="calibre83"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-15. </span>Latency heatmap</h6>
</div></figure>

<p class="author1">Histogram data can also be used to perform an approximation for a percentile, and this common use of histogram data is reflected in Micrometer’s option to enable histograms, <code class="calibre24">publishPercentileHistogram</code>. High percentiles are especially useful when performing comparative measurements of an application’s performance (such as the relative performance of two versions of an application in <a data-type="xref" href="part0010_split_013.html#9H5VC-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Automated Canary Analysis”</a>). Histograms are not enabled by default because of the additional storage cost on the monitoring system and heap usage in your application. Micrometer uses a bucketing function empirically determined at Netflix to generate reasonably low error bounds for these approximations.</p>

<p class="author1">Histogram publishing can be enabled for timers in a few ways.</p>

<p class="author1">The <code class="calibre24">Timer</code> fluent builder supports adding histograms directly as the <code class="calibre24">Timer</code> is being constructed, as shown in <a data-type="xref" href="part0007_split_007.html#timer_histogram_fluent" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-28</a>.</p>
<div id="timer_histogram_fluent" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-28. </span>Adding histograms to a Timer via the builder</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Timer</code> <code class="n">requestsTimer</code> <code class="o">=</code> <code class="n">Timer</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">publishPercentileHistogram</code><code class="o">()</code>
  <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1">Histogram support can be added after the fact via a <code class="calibre24">MeterFilter</code>, as shown in <a data-type="xref" href="part0007_split_007.html#timer_histogram_meter_filter" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-29</a>. This ability is crucial in layering your application with effective monitoring. In addition to their particular business logic, applications almost always contain a rich binary dependency hierarchy as well. It is reasonable for authors of common dependencies like HikariCP for connection pooling or the RabbitMQ Java client to want to include instrumentation involving timers in their code. But it is impossible for the authors of the RabbitMQ Java client to know whether RabbitMQ interactions are significant enough in your application to warrant the extra cost of shipping distribution statistics like percentile histograms (no matter how optimized they may be). Allowing application developers to turn on additional distribution statistics via <code class="calibre24">MeterFilter</code> allows the RabbitMQ Java client authors to use a minimal timer in their code.</p>
<div id="timer_histogram_meter_filter" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-29. </span>Adding histograms to a Timer via a MeterFilter</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="k">new</code><code class="calibre24"> </code><code class="n">MeterFilter</code><code class="o">(</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Override</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">public</code><code class="calibre24"> </code><code class="n">DistributionStatisticConfig</code><code class="calibre24"> </code><code class="nf">configure</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code><code class="calibre24"> </code><code class="n">id</code><code class="o">,</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">DistributionStatisticConfig</code><code class="calibre24"> </code><code class="n">config</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">if</code><code class="calibre24"> </code><code class="o">(</code><code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">DistributionStatisticConfig</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">publishPercentileHistogram</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">merge</code><code class="o">(</code><code class="n">config</code><code class="o">)</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO7-1" href="part0007_split_007.html#callout_application_metrics_CO7-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">return</code><code class="calibre24"> </code><code class="n">config</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="c">// The filter will apply to this timer as it is created
</code><code class="n">Timer</code><code class="calibre24"> </code><code class="n">requestsTimer</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code><code class="o">;</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO7-1" href="part0007_split_007.html#co_application_metrics_CO7-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Combines percentile histogram publishing with whatever other distribution statistics are configured by default (or by other <code class="calibre24">MeterFilter</code> configurations).</p></dd>
</dl>

<p class="author1">Lastly, frameworks like Spring Boot offer property-driven <code class="calibre24">MeterFilter</code> equivalents that allow you to add histograms to <code class="calibre24">Timers</code> declaratively. The configuration shown in <a data-type="xref" href="part0007_split_007.html#property_driven_histograms" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-30</a> adds histogram support to any timer prefixed with the name <code class="calibre24">requests</code>.</p>
<div id="property_driven_histograms" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-30. </span>Adding percentile histograms to metrics prefixed with “requests” in Spring Boot</h5>

<pre data-type="programlisting" class="calibre63">management.metrics.distribution.percentiles-histogram.requests=true</pre></div>

<p class="author1">Histograms are only shipped to monitoring systems that support percentile approximation based on histogram data.</p>

<p class="author1">For Atlas, use the <code class="calibre24">:percentiles</code> function, as in <a data-type="xref" href="part0007_split_007.html#atlas_percentiles" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-31</a>.</p>
<div id="atlas_percentiles" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-31. </span>Atlas percentiles function</h5>

<pre data-type="programlisting" class="calibre63">name,http.server.requests,:eq,
(,99,99.9,),:percentiles</pre></div>

<p class="author1">For Prometheus, use the <code class="calibre24">histogram_quantile</code> function, as in <a data-type="xref" href="part0007_split_007.html#prometheus_percentiles" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-32</a>. Recall from <a data-type="xref" href="part0007_split_003.html#6LK44-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Percentiles/Quantiles”</a> that percentiles are just a particular type of quantile. Prometheus histograms contain a special bucket called <code class="calibre24">Inf</code> that captures all samples exceeding the greatest bucket that you (or Micrometer) defines. Note that the timer’s count is equal to the count in the <code class="calibre24">Inf</code> bucket.<a data-type="indexterm" data-startref="ix_ch02-asciidoc29" id="idm45139276488312" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc28" id="idm45139276487576" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
<div id="prometheus_percentiles" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-32. </span>Prometheus histogram quantile function</h5>

<pre data-type="programlisting" class="calibre63">histogram_quantile(
  0.99,
  rate(http_server_requests_seconds_bucket[2m])
)</pre></div>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Timers" class="calibre3">
<div class="preface" id="timers">
<section data-type="sect2" data-pdf-bookmark="Service Level Objective Boundaries" class="calibre3"><div class="preface" id="slo_boundaries">
<h2 class="calibre37" id="6LKH9-2d714b853a094e9a910510217e0e3d73">Service Level Objective Boundaries</h2>

<p class="author1"><a data-type="indexterm" data-primary="meter filters" data-secondary="SLO boundaries and" id="ix_ch02-asciidoc30" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="service level objectives (SLOs)" data-secondary="timers and" id="ix_ch02-asciidoc31" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="SLO boundaries and" id="ix_ch02-asciidoc32" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Similar to percentiles and histograms, service level objective (SLO) boundaries can be added either through the <code class="calibre24">Timer</code> fluent builder or through a <code class="calibre24">MeterFilter</code>. You may notice I said “boundaries” and not “boundary” as you might expect. In many circumstances, it’s reasonable to layer your objectives. Gil Tene talks about establishing SLO requirements in his 2013 <a href="https://oreil.ly/-LNd6" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">talk</a> on monitoring latency, which I’ll paraphrase here because this is such a useful framework for explaining the need to layer SLOs. The SLO requirements interview is captured in <a data-type="xref" href="part0007_split_008.html#slo_requirements_interview" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-33</a>.</p>
<div id="slo_requirements_interview" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-33. </span>The SLO requirements interview</h5>

<pre data-type="programlisting" class="calibre63">Q: What are your service level objectives?
A: We need an average response of 10 milliseconds <a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO8-1" href="part0007_split_008.html#callout_application_metrics_CO8-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a>
Q: What is the worst-case requirement?
A: We don't have one.
Q: So it’s OK for some things to take more than 5 hours?
A: No!
Q: So we think that the worst-case requirement is 5 hours.
A: No! Let's make it 100 milliseconds.
Q: Are you sure? Even if the worst case only happens two times a day?
A: OK, make it 2 seconds.
Q: How often is it OK to have a 1-second response?
A: (Annoyed) I thought you said only a couple of times a day!
Q: That was for the worst case. If half the results are better than
   10 milliseconds, is it OK for every other request other than max
   to be just shy of 2 seconds?
A: (More specific requirements...)</pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO8-1" href="part0007_split_008.html#co_application_metrics_CO8-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Oh no, you said the word “average"…we’re just going to pretend we didn’t hear this.</p></dd>
</dl>

<p class="author1">This interview eventually yields a set of SLOs.</p>

<ul class="printings">
<li class="calibre15">
<p class="calibre18">90% better than 20 milliseconds</p>
</li>
<li class="calibre15">
<p class="calibre18">99.99% better than 100 milliseconds</p>
</li>
<li class="calibre15">
<p class="calibre18">100% better than 2 seconds</p>
</li>
</ul>

<p class="author1">We will configure Micrometer then to publish SLO counts for 20 milliseconds, 100 milliseconds, and 2 seconds. And we can simply compare, for example, the ratio of requests less than 20 milliseconds to the total number of requests; and if this ratio is less than 90%, then alert.</p>

<p class="author1">Micrometer will ship a count for each of these boundaries that indicates how many requests did not exceed that boundary. A set of SLO boundaries together form a coarse histogram, as seen in <a data-type="xref" href="part0007_split_008.html#slo_histogram" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-16</a>, where the latency domain is divided into buckets of zero to the lowest SLO and so on for consecutive SLO boundaries after that.</p>

<figure class="calibre32"><div id="slo_histogram" class="figure">
<img src="../images/00034.png" alt="srej 0216" class="calibre84"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-16. </span>Histogram of SLO boundaries</h6>
</div></figure>

<p class="author1">Shipping SLO boundaries does have an effect on total storage in the monitoring system and memory consumption in your application. However, because typically only a small set of boundaries is published, the cost is relatively low compared to percentile histograms.</p>

<p class="author1">Percentile histograms and SLOs can be used together. Adding SLO boundaries simply adds more buckets than would be shipped with just a percentile histogram. When SLO boundaries are shipped in addition to percentile histograms, the histogram shipped contains the buckets Micrometer decides are necessary to yield reasonable error bounds on percentile approximations <em class="calibre12">plus</em> any SLO boundaries, as shown in <a data-type="xref" href="part0007_split_008.html#mixed_percentiles_slos" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-17</a>.</p>

<figure class="calibre32"><div id="mixed_percentiles_slos" class="figure">
<img src="../images/00015.png" alt="srej 0217" class="calibre85"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-17. </span>Mixed histogram of service level objective boundaries and percentile histogram bucket boundaries</h6>
</div></figure>

<p class="author1">Publishing SLO boundaries is a far cheaper (and accurate) way of testing whether the <em class="calibre12">N</em>th percentile exceeds a certain value. For example, if you determine that an SLO is that 99% of requests are below 100 ms, then publish a 100 ms SLO boundary. To set an alert on violations of the SLO boundary, simply determine whether the ratio of requests below the boundary to total requests is less than 99%.</p>

<p class="author1">This is a little inconvenient when the monitoring system expects normal histograms, like Atlas, because you have to select and sum all the buckets <em class="calibre12">less than</em> the SLO boundary. <a data-type="indexterm" data-primary="tag values" id="idm45139276478648" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>In <a data-type="xref" href="part0007_split_008.html#slo_boundary_percentile_atlas" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-34</a>, we want to test whether 99% of requests are less than 100 ms (0.1 seconds); but since it isn’t possible to treat tag values as numerical values, we can’t use operators like <code class="calibre24">:le</code> to select all time series with a tag less than 0.1 seconds. So we have to resort to performing numerical comparisons with a regular expression operator like <code class="calibre24">:re</code>.</p>
<div id="slo_boundary_percentile_atlas" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-34. </span>Atlas alert criteria using an SLO boundary</h5>

<pre data-type="programlisting" class="calibre63">name,http.server.requests,:eq,
:dup,
slo,0.(0\d+|1),:re,
:div,
0.99,:lt,
uri,_API_ENDPOINT,:eq,:cq</pre></div>

<p class="author1"><a data-type="indexterm" data-primary="Prometheus" data-secondary="SLO boundaries" id="idm45139276525640" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Prometheus has the advantage here, given that its histograms are expressed cumulatively. That is, all the samples below 100 ms are accumulated to every boundary less than 100 ms, including this boundary.</p>

<p class="author1">The alert criteria is shown in <a data-type="xref" href="part0007_split_008.html#slo_boundary_percentile_prometheus" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-35</a>.</p>
<div id="slo_boundary_percentile_prometheus" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-35. </span>Prometheus alert criteria using an SLO boundary</h5>

<pre data-type="programlisting" class="calibre63">http_server_requests_seconds_bucket{le="0.1", uri="/API_ENDPOINT"}
/ <a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO9-1" href="part0007_split_008.html#callout_application_metrics_CO9-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a>
http_server_requests_seconds_count{uri="/API_ENDPOINT"} &lt; 0.99</pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO9-1" href="part0007_split_008.html#co_application_metrics_CO9-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Division symbol</p></dd>
</dl>

<p class="author1">Visually, the effect of these two queries can be seen in <a data-type="xref" href="part0007_split_008.html#slo_percentile_atlas_vs_prometheus" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-18</a>.</p>

<figure class="calibre32"><div id="slo_percentile_atlas_vs_prometheus" class="figure">
<img src="../images/00023.png" alt="srej 0218" class="calibre86"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-18. </span>SLO boundary alert queries: Atlas versus Prometheus</h6>
</div></figure>

<p class="author1">SLO publishing can be enabled for timers in a few ways.</p>

<p class="author1">The <code class="calibre24">Timer</code> fluent builder supports adding SLOs directly as the <code class="calibre24">Timer</code> is being constructed, as shown in <a data-type="xref" href="part0007_split_008.html#timer_slo_fluent" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-36</a>.</p>
<div id="timer_slo_fluent" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-36. </span>Adding SLO boundaries to a Timer via the builder</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Timer</code> <code class="n">requestsTimer</code> <code class="o">=</code> <code class="n">Timer</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code>
  <code class="o">.</code><code class="na">slo</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofMillis</code><code class="o">(</code><code class="mi">100</code><code class="o">),</code> <code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">))</code>
  <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1"><a data-type="xref" href="part0007_split_008.html#timer_slo_meter_filter" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-37</a> shows how to add SLO boundaries with a <code class="calibre24">MeterFilter</code>.</p>
<div id="timer_slo_meter_filter" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-37. </span>Adding SLO boundaries to a Timer via a MeterFilter</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="k">new</code><code class="calibre24"> </code><code class="n">MeterFilter</code><code class="o">(</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Override</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">public</code><code class="calibre24"> </code><code class="n">DistributionStatisticConfig</code><code class="calibre24"> </code><code class="nf">configure</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code><code class="calibre24"> </code><code class="n">id</code><code class="o">,</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">DistributionStatisticConfig</code><code class="calibre24"> </code><code class="n">config</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">if</code><code class="calibre24"> </code><code class="o">(</code><code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">DistributionStatisticConfig</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">slo</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofMillis</code><code class="o">(</code><code class="mi">100</code><code class="o">)</code><code class="o">,</code><code class="calibre24"> </code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">)</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="o">.</code><code class="na">merge</code><code class="o">(</code><code class="n">config</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">return</code><code class="calibre24"> </code><code class="n">config</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="n">Timer</code><code class="calibre24"> </code><code class="n">requestsTimer</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">registry</code><code class="o">.</code><code class="na">timer</code><code class="o">(</code><code class="s">"requests"</code><code class="o">)</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO10-1" href="part0007_split_008.html#callout_application_metrics_CO10-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO10-1" href="part0007_split_008.html#co_application_metrics_CO10-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">The filter will apply to this timer as it is created.</p></dd>
</dl>

<p class="author1">The next meter type is very similar to a timer<a data-type="indexterm" data-startref="ix_ch02-asciidoc32" id="idm45139274834616" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc31" id="idm45139274834088" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc30" id="idm45139274840104" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>.<a data-type="indexterm" data-startref="ix_ch02-asciidoc18" id="idm45139274839304" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc17" id="idm45139274844968" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>





</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Distribution Summaries" class="calibre3"><div class="preface" id="distribution_summaries">
<h1 class="calibre19" id="calibre_pb_9">Distribution Summaries</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="distribution summaries" id="idm45139274842632" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="distribution summaries" id="idm45139274841656" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>A distribution summary, shown in <a data-type="xref" href="part0007_split_009.html#distribution_summary_create" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-38</a>, is used to track the distribution of events. It is similar to a timer structurally, but it records values that do not represent a unit of time. For example, a distribution summary could be used to measure the payload sizes of requests hitting a server.</p>
<div id="distribution_summary_create" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-38. </span>Creating a distribution summary</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">DistributionSummary</code> <code class="n">summary</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">summary</code><code class="o">(</code><code class="s">"response.size"</code><code class="o">);</code></pre></div>

<p class="author1">Micrometer also provides a fluent builder, shown in <a data-type="xref" href="part0007_split_009.html#distribution_summary_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-39</a> for distribution summaries. For maximum portability, add base units, as they are part of the naming convention for some monitoring systems. Optionally, you may provide a scaling factor that each recorded sample will be multiplied by as it is recorded.</p>
<div id="distribution_summary_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-39. </span>The distribution summary fluent builder</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">DistributionSummary</code> <code class="n">summary</code> <code class="o">=</code> <code class="n">DistributionSummary</code>
    <code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"response.size"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"a description of what this summary does"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"bytes"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">tags</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"test"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">scale</code><code class="o">(</code><code class="mi">100</code><code class="o">)</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1">Distribution summaries have all the same percentile, histogram, and SLO options that timers do. Timers are just a specialized distribution summary for measuring time. SLOs are defined as fixed values instead of durations (i.e., <code class="calibre24">1000</code> instead of <code class="calibre24">Duration.ofMillis(1000)</code>, where 1,000 means something, depending on what base unit is assigned to the distribution summary) and provide convenience methods for timing blocks of code. That is the only difference in the available options.</p>

<p class="author1">A common example of a distribution summary is payload size measured in bytes.</p>

<p class="author1">Much like with timers, in many real-world cases the distribution is rarely normal. At one point I measured payload size in bytes, which was largely normal except there was a sharp drop-off on the left side of the distribution, because I was including request headers in the payload size. So there were zero occurrences of request payloads less than the size of having a certain set of request headers present.</p>

<p class="author1">Because distribution summaries can track any unit of measure, and the distribution of the measured values cannot be generally known as it can be for timers, the best way to alert on a distribution summary has some nuance:</p>

<ul class="printings">
<li class="calibre15">
<p class="calibre18">When the distribution is multimodal, as it is for timers, it is likely best to set alerts on maximum value so that you can keep track of where the “worst case” is.</p>
</li>
<li class="calibre15">
<p class="calibre18">In most cases, it still makes sense to use high percentiles like the 99th percentile for comparative analysis (see <a data-type="xref" href="part0010_split_013.html#9H5VC-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Automated Canary Analysis”</a>).</p>
</li>
</ul>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Long Task Timers" class="calibre3"><div class="preface" id="idm45139274844040">
<h1 class="calibre19" id="6LKS0-2d714b853a094e9a910510217e0e3d73">Long Task Timers</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="long task timers" id="ix_ch02-asciidoc33" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="long task timers" id="ix_ch02-asciidoc34" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="timers" data-secondary="long task timers" id="ix_ch02-asciidoc35" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The long task timer is a special type of timer that lets you measure time while an event being measured is <em class="calibre12">still running</em>. A timer does not record the duration until the task is complete. Long task timers ship several statistics:</p>
<dl class="calibre20">
<dt class="calibre21">Active</dt>
<dd class="calibre22">
<p class="calibre23">The number of executions that are currently in progress.</p>
</dd>
<dt class="calibre21">Total duration</dt>
<dd class="calibre22">
<p class="calibre23">The sum of all in-progress execution times of the block of code being measured.</p>
</dd>
<dt class="calibre21">Max</dt>
<dd class="calibre22">
<p class="calibre23">The longest in-progress timing. The max represents the total execution time of the oldest still-running execution time.</p>
</dd>
<dt class="calibre21">Histograms</dt>
<dd class="calibre22">
<p class="calibre23">A set of discretized buckets of in-progress tasks.</p>
</dd>
<dt class="calibre21">Percentiles</dt>
<dd class="calibre22">
<p class="calibre23">Precomputed percentiles of in-progress execution times.</p>
</dd>
</dl>

<p class="author1"><a data-type="xref" href="part0007_split_010.html#long_task_timer_active_duration" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-19</a> shows how a long task timer fundamentally differs from a timer. As soon as an operation is complete, it no longer contributes to the total duration. In contrast, an operation instrumented with a timer isn’t reported <em class="calibre12">until</em> it is complete. Notice how at time t=3, total duration increases by 2 rather than just 1. This is because we have two tasks that were executing beginning at t=2, so they each contribute 1 to the total at each interval while they continue to run. At t=4, both tasks stop, and so total duration drops to zero, along with active count.</p>

<p class="author1">Long task timer average has a different meaning than a timer average. It is the average of the time active operations that have been running <em class="calibre12">to this point</em>. Similarly, maximum represents the longest running task to this point, decayed in a similar way that timer maximum is.</p>

<figure class="calibre32"><div id="long_task_timer_active_duration" class="figure">
<img src="../images/00005.png" alt="srej 0219" class="calibre87"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-19. </span>Long task timer active and total duration for two tasks</h6>
</div></figure>

<p class="author1">The <code class="calibre24">MeterRegistry</code> interface contains convenience methods for creating long task timers, as shown in <a data-type="xref" href="part0007_split_010.html#long_task_timer_create" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-40</a>.</p>
<div id="long_task_timer_create" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-40. </span>Creating long task timers</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="c">// No tags</code>
<code class="n">LongTaskTimer</code>  <code class="n">timer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">more</code><code class="o">()</code>
  <code class="o">.</code><code class="na">longTaskTimer</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">);</code>

<code class="c">// Adding tags in key-value pairs with varargs</code>
<code class="n">LongTaskTimer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">more</code><code class="o">()</code>
  <code class="o">.</code><code class="na">longTaskTimer</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">,</code> <code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">);</code>

<code class="c">// Explicit tag list creation</code>
<code class="n">LongTaskTimer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">registry</code><code class="o">.</code><code class="na">more</code><code class="o">()</code>
  <code class="o">.</code><code class="na">longTaskTimer</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">,</code> <code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">));</code></pre></div>

<p class="author1">The <code class="calibre24">LongTaskTimer</code> fluent builder contains more options, shown in <a data-type="xref" href="part0007_split_010.html#long_task_timer_fluent_builder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-41</a>.</p>
<div id="long_task_timer_fluent_builder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-41. </span>Fluent builder for long task timers</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">LongTaskTimer</code> <code class="n">timer</code> <code class="o">=</code> <code class="n">LongTaskTimer</code>
    <code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"execution.time"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"a description of what this timer does"</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">tags</code><code class="o">(</code><code class="s">"region"</code><code class="o">,</code> <code class="s">"us-east-1"</code><code class="o">)</code> <code class="c">// Optional</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code></pre></div>

<p class="author1">Long task timers have a record method that returns a <code class="calibre24">Sample</code> that can later be stopped and convenience methods for recording a body of code wrapped in a lambda, as shown in <a data-type="xref" href="part0007_split_010.html#long_task_timer_record_execution" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-42</a>.</p>
<div id="long_task_timer_record_execution" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-42. </span>Recording execution with a long task timer</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">longTaskTimer</code><code class="o">.</code><code class="na">record</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">dontCareAboutReturnValue</code><code class="o">());</code>
<code class="n">longTaskTimer</code><code class="o">.</code><code class="na">recordCallable</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">returnValue</code><code class="o">());</code>

<code class="n">LongTaskTimer</code><code class="o">.</code><code class="na">Sample</code> <code class="n">sample</code> <code class="o">=</code> <code class="n">longTaskTimer</code><code class="o">.</code><code class="na">start</code><code class="o">();</code>
<code class="c">// Do something...</code>
<code class="n">sample</code><code class="o">.</code><code class="na">stop</code><code class="o">(</code><code class="n">longTaskTimer</code><code class="o">);</code></pre></div>

<p class="author1">A good example of a long task timer is in <a href="https://oreil.ly/qXUkv" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Edda</a>, which caches AWS resources such as instances, volumes, and autoscaling groups. Normally all data can be refreshed in a few minutes. If the AWS services are performing more slowly than usual, it can take much longer. A long task timer can be used to track the overall time for refreshing the metadata.</p>

<p class="author1">In application code, it is common for such long-running processes to be implemented with something like Spring Boot’s <code class="calibre24">@Scheduled</code>, as shown in <a data-type="xref" href="part0007_split_010.html#explicit_ltt" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-43</a>.</p>
<div id="explicit_ltt" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-43. </span>An explicitly recorded long task timer for a scheduled operation</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="nd">@Scheduled</code><code class="o">(</code><code class="n">fixedDelay</code> <code class="o">=</code> <code class="mi">360000</code><code class="o">)</code>
<code class="kt">void</code> <code class="nf">scrapeResources</code><code class="o">()</code> <code class="o">{</code>
  <code class="n">LongTaskTimer</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"aws.scrape"</code><code class="o">)</code>
    <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"Time it takes to find instances, volumes, etc."</code><code class="o">)</code>
    <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">)</code>
    <code class="o">.</code><code class="na">record</code><code class="o">(()</code> <code class="o">=&gt;</code> <code class="o">{</code>
      <code class="c">// Find instances, volumes, autoscaling groups, etc...</code>
    <code class="o">});</code>
<code class="o">}</code></pre></div>

<p class="author1">Some frameworks like Spring Boot also respond to the <code class="calibre24">@Timed</code> annotation to create long task timers when the <code class="calibre24">longTask</code> attribute is set to <code class="calibre24">true</code>, as in <a data-type="xref" href="part0007_split_010.html#annotation_ltt" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-44</a>.</p>
<div id="annotation_ltt" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-44. </span>An annotation-based long task timer for a scheduled operation</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="nd">@Timed</code><code class="o">(</code><code class="n">name</code> <code class="o">=</code> <code class="s">"aws.scrape"</code><code class="o">,</code> <code class="n">longTask</code> <code class="o">=</code> <code class="k">true</code><code class="o">)</code>
<code class="nd">@Scheduled</code><code class="o">(</code><code class="n">fixedDelay</code> <code class="o">=</code> <code class="mi">360000</code><code class="o">)</code>
<code class="kt">void</code> <code class="nf">scrapeResources</code><code class="o">()</code> <code class="o">{</code>
  <code class="c">// Find instances, volumes, autoscaling groups, etc...</code>
<code class="o">}</code></pre></div>

<p class="author1">If we wanted to alert when this process exceeds our threshold, with a long task timer we will receive that alert at the first reporting interval after we have exceeded the threshold. With a regular timer, we wouldn’t receive the alert until the first reporting interval after the process completed, over an hour later!<a data-type="indexterm" data-startref="ix_ch02-asciidoc35" id="idm45139274459480" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc34" id="idm45139274458872" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc33" id="idm45139274458264" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Choosing the Right Meter Type" class="calibre3"><div class="preface" id="choosing_meter_type">
<h1 class="calibre19" id="calibre_pb_11">Choosing the Right Meter Type</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="choosing the right meter type" id="idm45139274455976" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>In the instrumentation libraries for hierarchical metrics systems (see <a data-type="xref" href="part0006_split_003.html#hierarchical_metrics" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Hierarchical Metrics”</a>), typically only gauges and counters were supported. This led to a habit of precalculating statistics (most commonly rates like request throughput) and presenting them to the monitoring system as a gauge that could fluctuate up or down. Since Micrometer always exposes counters in a way that lets you derive a rate at query time, there is no need to perform this calculation manually in your application code.</p>

<p class="author1">Both <code class="calibre24">Timer</code> and <code class="calibre24">DistributionSummary</code> always publish a count of events in addition to other measurements. There should never be a reason to count the number of executions of a block of code. They should be timed instead.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Choosing the Right Meter Type" class="calibre3">
<div class="preface" id="choosing_meter_type">
<div data-type="tip" class="calibre28"><h1 class="calibre54" id="calibre_pb_12">Which Meter Type to Choose?</h1>
<p class="author1">Never gauge something you can count, and never count something you can time.</p>
</div>

<p class="author1">As a general rule, select a <code class="calibre24">LongTaskTimer</code> whenever timings exceed two minutes, when you need to monitor in-flight requests, and especially when an operation’s failure may inflate the expected time from a few minutes to many minutes or hours.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Controlling Cost" class="calibre3"><div class="preface" id="idm45139274418616">
<h1 class="calibre19" id="6LL3V-2d714b853a094e9a910510217e0e3d73">Controlling Cost</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="controlling cost" id="ix_ch02-asciidoc36" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="cost, of metrics" data-secondary="controlling" id="ix_ch02-asciidoc37" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The cost of metrics grows as you instrument more and more pieces of your application. Perhaps at the beginning you only start with shipping basic statistics like memory and processor utilization, and grow to additional areas like HTTP request monitoring, cache performance, database interactions, and connection pool saturation,. In fact, many of these basic use cases are going to be increasingly automatically instrumented by frameworks like Spring Boot.</p>

<p class="author1">Expanding instrumentation to additional components isn’t the likely source of high cost in telemetry, however. To examine the cost of an individual metric, think about the unique permutations of a metric name and all of its key-value tag combinations. <a data-type="indexterm" data-primary="cardinality, of metric" id="ix_ch02-asciidoc38" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>These form a set of time series on the backend, and we refer to the size of this set as the <em class="calibre12">cardinality</em> of the metric.</p>

<p class="author1">It is essential that you carefully bound a metric’s cardinality by considering all the possible key-value tags combinations that could result in a high number of unique values and limit them in some way. The cardinality of a metric is the product of the unique tag values for each tag key. The reasonable limit you place on tag cardinality varies from monitoring system to monitoring system, but in general keeping it in the thousands is a reasonable upper bound. At Netflix, the general advice was to keep metric cardinality under one million time series. This is probably at the outside edge of what most organizations would find responsible.</p>

<p class="author1">Remember, metrics are intended to present an aggregate view of an indicator, and they shouldn’t be used to try to examine event-level or request-level performance. Other forms of telemetry like distributed tracing or logging are more appropriate for individual event-level telemetry.</p>

<p class="author1">Framework-provided telemetry is generally carefully crafted to limit tag cardinality. For example, Spring Boot’s timing of Spring WebMVC and WebFlux adds a handful of tags but carefully limits how each contributes to the cardinality of the metric. The following list bexplains what each tag key means:</p>
<dl class="calibre20">
<dt class="calibre21">Method</dt>
<dd class="calibre22">
<p class="calibre23">There are a small number of possible values for HTTP method, based on the HTTP specification, e.g., <code class="calibre24">GET</code> or <code class="calibre24">POST</code>.</p>
</dd>
<dt class="calibre21">Status</dt>
<dd class="calibre22">
<p class="calibre23">HTTP status codes come from the HTTP specification, so are naturally limited in the possible values. Also, most API endpoints are going to realistically only return one of a few values: 200–202 success/created/accepted, 304 not modified, 400 bad request, 500 internal server error, and maybe 403 forbiddden. Most won’t return even this amount of variation.</p>
</dd>
<dt class="calibre21">Outcome</dt>
<dd class="calibre22">
<p class="calibre23">A summarization of status code, e.g., <code class="calibre24">SUCCESS</code>, <code class="calibre24">CLIENT_ERROR</code>, or <code class="calibre24">SERVER_ERROR</code>.</p>
</dd>
<dt class="calibre21">URI</dt>
<dd class="calibre22">
<p class="calibre23">This tag is a good demonstration of how tag cardinality could quickly get out of hand. For 200–400 status codes, the URI is going to be the path that the request was mapped to. But when the endpoint contains a path variable or request parameters, the framework is careful to use the <em class="calibre12">unsubstituted</em> path here rather than the raw path of the request, e.g., <code class="calibre24">/api/customer/{id}</code> instead of <code class="calibre24">/api/customer/123</code> and <code class="calibre24">/api/customer/456</code>. Not only does this help limit the metric’s cardinality, but it is also more useful to reason about the performance of all requests to <code class="calibre24">/api/customer/{id}</code> in the aggregate as opposed to groups of requests that retrieved the particular customer with ID <code class="calibre24">123</code> or <code class="calibre24">456</code>. In addition to path substitution, the URI should be further constrained in cases where the server is ultimately going to return a 404. Otherwise, every mistyped URI <code class="calibre24">/api/doesntexist/1</code>, <code class="calibre24">/api/doesntexistagain</code>, etc., results in a new tag. So Spring Boot uses a URI tag value of <code class="calibre24">NOT_FOUND</code> whenever the status code is 404. Similarly, it uses a <code class="calibre24">REDIRECT</code> value when the status code is 403 because the server may always redirect unauthenticated requests to the authentication mechanism, even when the requested path doesn’t exist.</p>
</dd>
<dt class="calibre21">Exception</dt>
<dd class="calibre22">
<p class="calibre23">When the request results in a 500 internal server error, this tag contains the exception class name, which is just a simple way of grouping the general classes of failures—for example, null pointer exceptions versus a connection timeout on a downstream service request. Again, there are generally only a few possible classes of failures based on the implementation of the endpoint, so this is naturally bounded.</p>
</dd>
</dl>

<p class="author1">For HTTP server request metrics then, the total cardinality might be something like <a data-type="xref" href="part0007_split_013.html#http_server_request_cardinality" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Equation 2-7</a>.</p>
<div id="http_server_request_cardinality" data-type="equation" class="calibre61">
<h5 class="calibre72"><span class="keep-together">Equation 2-7. </span>Cardinality of HTTP server request metric for a single endpoint</h5>
<math alttext="2 m e t h o d s times 4 s t a t u s e s times 2 o u t c o m e s times 1 upper U upper R upper I times 3 e x c e p t i o n s equals 48 t a g v a l u e s" display="block">
  <mrow>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>m</mi>
    <mi>e</mi>
    <mi>t</mi>
    <mi>h</mi>
    <mi>o</mi>
    <mi>d</mi>
    <mi>s</mi>
    <mo>×</mo>
    <mn>4</mn>
    <mspace width="4pt"/>
    <mi>s</mi>
    <mi>t</mi>
    <mi>a</mi>
    <mi>t</mi>
    <mi>u</mi>
    <mi>s</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mo>×</mo>
    <mn>2</mn>
    <mspace width="4pt"/>
    <mi>o</mi>
    <mi>u</mi>
    <mi>t</mi>
    <mi>c</mi>
    <mi>o</mi>
    <mi>m</mi>
    <mi>e</mi>
    <mi>s</mi>
    <mo>×</mo>
    <mn>1</mn>
    <mspace width="4pt"/>
    <mi>U</mi>
    <mi>R</mi>
    <mi>I</mi>
    <mo>×</mo>
    <mn>3</mn>
    <mspace width="4pt"/>
    <mi>e</mi>
    <mi>x</mi>
    <mi>c</mi>
    <mi>e</mi>
    <mi>p</mi>
    <mi>t</mi>
    <mi>i</mi>
    <mi>o</mi>
    <mi>n</mi>
    <mi>s</mi>
    <mo>=</mo>
    <mn>48</mn>
    <mspace width="4pt"/>
    <mi>t</mi>
    <mi>a</mi>
    <mi>g</mi>
    <mi>v</mi>
    <mi>a</mi>
    <mi>l</mi>
    <mi>u</mi>
    <mi>e</mi>
    <mi>s</mi>
  </mrow>
</math>
</div>

<p class="author1">Resist the urge to overoptimize for cost. In particular, there is no need to try to limit the publication of zero values, because in some application states in theory all metrics could be nonzero for a particular publishing interval. It is at that moment of greatest saturation where you would be publishing the most nonzero metrics that will govern the cost of metrics to you, not the low points where you could publish some lesser set of metrics by excluding zero values. Also, reporting a zero value is a useful signal that something is just not happening as opposed to the service not reporting at all.</p>

<p class="author1">In some cases, where tag cardinality cannot be limited easily by out-of-the-box instrumentation, you will find the configuration of a set of metrics makes you define how to limit the tags responsibly. A good example is Micrometer’s instrumentation for the Jetty <code class="calibre24">HttpClient</code>. A typical request using the Jetty <code class="calibre24">HttpClient</code> looks like <a data-type="xref" href="part0007_split_013.html#jetty_http_client_call" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-45</a>. The <code class="calibre24">HttpClient</code> API doesn’t provide a mechanism for providing a path variable to the <code class="calibre24">POST</code> call and a collection of variable values to substitute later, so by the time Micrometer’s Jetty <code class="calibre24">Request.Listener</code> intercepts the request, path variables have already been substituted irreversibly.<a data-type="indexterm" data-startref="ix_ch02-asciidoc38" id="idm45139274339048" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
<div id="jetty_http_client_call" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-45. </span>Jersey HTTP client call with path variable string concatenation</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">Request</code> <code class="n">post</code> <code class="o">=</code> <code class="n">httpClient</code><code class="o">.</code><code class="na">POST</code><code class="o">(</code><code class="s">"https://customerservice/api/customer/"</code> <code class="o">+</code> <code class="n">customerId</code><code class="o">);</code>
<code class="n">post</code><code class="o">.</code><code class="na">content</code><code class="o">(</code><code class="k">new</code> <code class="n">StringContentProvider</code><code class="o">(</code><code class="s">"{\\"</code><code class="n">detail</code><code class="err">\\</code><code class="s">": \\"</code><code class="n">all</code><code class="err">\\</code><code class="s">"}"</code><code class="o">));</code>
<code class="n">ContentResponse</code> <code class="n">response</code> <code class="o">=</code> <code class="n">post</code><code class="o">.</code><code class="na">send</code><code class="o">();</code></pre></div>

<p class="author1">Jetty client metrics should use the unsubstituted path for the <code class="calibre24">uri</code> tag for the same reason the URI tag on Spring Boot’s instrumentation of WebMVC and WebFlux was based on an unsubstituted value. It becomes the responsibility of the engineer using Jetty <code class="calibre24">HttpClient</code> to specify how to <code class="calibre24">unsubstitute</code> path variables for the purpose of tagging, as shown in <a data-type="xref" href="part0007_split_013.html#jetty_http_client_metrics_config" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-46</a>.<a data-type="indexterm" data-startref="ix_ch02-asciidoc37" id="idm45139274298744" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc36" id="idm45139274298040" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
<div id="jetty_http_client_metrics_config" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-46. </span>Jersey HTTP client metrics configuration</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">HttpClient</code> <code class="n">httpClient</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HttpClient</code><code class="o">();</code>
<code class="n">httpClient</code><code class="o">.</code><code class="na">getRequestListeners</code><code class="o">().</code><code class="na">add</code><code class="o">(</code>
  <code class="n">JettyClientMetrics</code>
    <code class="o">.</code><code class="na">builder</code><code class="o">(</code>
      <code class="n">registry</code><code class="o">,</code>
      <code class="n">result</code> <code class="o">-&gt;</code> <code class="o">{</code>
        <code class="n">String</code> <code class="n">path</code> <code class="o">=</code> <code class="n">result</code><code class="o">.</code><code class="na">getRequest</code><code class="o">().</code><code class="na">getURI</code><code class="o">().</code><code class="na">getPath</code><code class="o">();</code>
        <code class="k">if</code><code class="o">(</code><code class="n">path</code><code class="o">.</code><code class="na">startsWith</code><code class="o">(</code><code class="s">"/api/customer/"</code><code class="o">))</code> <code class="o">{</code>
          <code class="k">return</code> <code class="s">"/api/customer/{id}"</code><code class="o">;</code>
        <code class="o">}</code>
        <code class="o">...</code>
      <code class="o">}</code>
    <code class="o">)</code>
    <code class="o">.</code><code class="na">build</code><code class="o">()</code>
<code class="o">);</code></pre></div>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Coordinated Omission" class="calibre3"><div class="preface" id="coordinated_omission">
<h1 class="calibre19" id="calibre_pb_14">Coordinated Omission</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="coordinated omission" id="ix_ch02-asciidoc39" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="coordinated omission" id="ix_ch02-asciidoc40" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>My first job in high school was as a fast-food worker. Running the drive-through window gave me some early firsthand experience about how to lie with statistics.</p>

<p class="author1">Our performance as a store was evaluated on the basis of the <em class="calibre12">average</em> duration from the time a customer placed an order at the menu to when they departed with their order. Our store was fairly understaffed typically, so at times the average time exceeded our goal. We simply waited until a lull in activity and did laps around the building with one of our cars. A couple dozen three-to-four-second service times will lower the average quickly (again, average is a problem statistic more often than not)! We could make our service time look arbitrarily good. At some point, the corporate headquarters added minimum service time to the average statistic they were evaluating, and our cheating was over.</p>

<p class="author1">In one bizarre case, a bus came through the drive-through and each window of the bus ordered. Our service time was only driven by a pressure plate near the menu and after the service window, so it was unaware of service time per order, only per vehicle. Clearly we didn’t serve the bus order as quickly as we would serve a typical car, and the ripple effect of the bus on other service times illustrates a concept called <em class="calibre12">coordinated omission</em>, in which if we aren’t careful, we monitor some definition of service time but exclude wait time. There are two examples of coordinated omission with this bus incident, illustrated in <a data-type="xref" href="part0007_split_014.html#coordinated_omission_bus" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-20</a>.</p>

<figure class="calibre32"><div id="coordinated_omission_bus" class="figure">
<img src="../images/00011.png" alt="srej 0220" class="calibre88"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-20. </span>Coordinated omission caused by a bus in the drive-through</h6>
</div></figure>

<ul class="printings">
<li class="calibre15">
<p class="calibre18">At the point where the bus is at the window receiving its orders, there are only three other cars whose service time is being recorded (the three that have activated the pressure plate at the menu). The two cars behind the menu aren’t being observed by the system. The actual impact of the bus’s obstruction was on five other customers, but we will only see a service time impact on three.</p>
</li>
<li class="calibre15">
<p class="calibre18">Suppose instead of service time being determined from the menu through leaving the order window, we instead monitored service time as just the time spent at the order window. The average service time then was only affected by how long it took to serve the bus alone, and not the compounding effect it had on the cars behind it.</p>
</li>
</ul>

<p class="author1">These effects are similar to the effect that thread pools have on request timing. If a response time is calculated based on when a request handler begins processing a request and ends when the response is committed, there is no accounting for the time that a request sat in a queue waiting for an available request handler thread to begin processing it.</p>

<p class="author1">The other consequence of coordinated omission illustrated by this example is that blocking the drive-through lane prevents the restaurant from being totally overwhelmed by a steady state of customer orders. In fact, the appearance of a long line at the drive-through may have discouraged would-be customers from even attempting an order. Thread pools can have this effect as well. Coordinated omission arises from several sources:</p>
<dl class="calibre20">
<dt class="calibre21">Serverless functions</dt>
<dd class="calibre22">
<p class="calibre23">Measuring the execution of a serverless function from the perspective of that function of course doesn’t record the time required to launch the function.</p>
</dd>
<dt class="calibre21">Pauses</dt>
<dd class="calibre22">
<p class="calibre23">Pauses come in many forms—for example, the JVM pauses due to garbage collection, a reindexing database becomes momentarily unresponsive, and cache buffers flush to disk. Execution pauses are reported as higher latencies on in-flight timings, but operations for which timings haven’t yet started will report unrealistically low latencies.</p>
</dd>
<dt class="calibre21">Load testers</dt>
<dd class="calibre22">
<p class="calibre23">Conventional load testers back up in their own thread pools before truly saturating a service.</p>
</dd>
</dl>

<p class="author1">The need for accurate load tests is so common  that we’ll go into a little more detail about them.<a data-type="indexterm" data-startref="ix_ch02-asciidoc40" id="idm45139274191688" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc39" id="idm45139274190984" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Load Testing" class="calibre3"><div class="preface" id="load_testing">
<h1 class="calibre19" id="6LLA0-2d714b853a094e9a910510217e0e3d73">Load Testing</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="load testing" id="ix_ch02-asciidoc41" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="load testing" id="ix_ch02-asciidoc42" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Some conventional load testers like Apache Bench generate requests at a particular rate. Aggregated statistics are generated from the set of all response times. When responses don’t fit inside the collection bucket interval, the next request will be delayed.</p>

<p class="author1">In this way, a service that is becoming oversaturated doesn’t get pushed over the edge because the unintentional coordination of a longer response time causes the load test to back off. This coordination comes from the fact that these types of tests use a blocking request model that effectively limits concurrency to less than or equal to the number of cores on the machine running the test.</p>

<p class="author1">Real users don’t have this kind of coordination. They interact with your service independently of one another, and so can saturate the service to a far greater degree. One effective way to simulate user behavior is to saturate your service with a <a data-type="indexterm" data-primary="nonblocking load test" id="ix_ch02-asciidoc43" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>nonblocking load test. Gatling and JMeter each act this way (but Apache Bench does not). But to illustrate how an effective load test should work, we can use Spring’s nonblocking <code class="calibre24">WebClient</code> and Project Reactor to create a simple nonblocking load test. The result is shown in <a data-type="xref" href="part0007_split_015.html#6LLAA-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-47</a>. It’s in fact so easy to build these nonblocking load tests now that maybe it’s not worth the extra cognitive overhead of dedicated tools like JMeter and Gatling. You’ll have to decide this for yourself and your team.</p>
<div id="non_blocking_load_test" data-type="example" class="calibre61">
<h5 class="calibre62" id="6LLAA-2d714b853a094e9a910510217e0e3d73"><span class="keep-together">Example 2-47. </span>A nonblocking load test with WebClient and Project Reactor</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">public</code><code class="calibre24"> </code><code class="k">class</code><code class="calibre24"> </code><code class="nc">LoadTest</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">public</code><code class="calibre24"> </code><code class="k">static</code><code class="calibre24"> </code><code class="kt">void</code><code class="calibre24"> </code><code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[</code><code class="o">]</code><code class="calibre24"> </code><code class="n">args</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">MeterRegistry</code><code class="calibre24"> </code><code class="n">meterRegistry</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO11-1" href="part0007_split_015.html#callout_application_metrics_CO11-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">Counter</code><code class="calibre24"> </code><code class="n">counter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">meterRegistry</code><code class="o">.</code><code class="na">counter</code><code class="o">(</code><code class="s">"load.test.requests"</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">WebClient</code><code class="calibre24"> </code><code class="n">client</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">WebClient</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">baseUrl</code><code class="o">(</code><code class="s">"http://"</code><code class="calibre24"> </code><code class="o">+</code><code class="calibre24"> </code><code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">build</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">Flux</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">generate</code><code class="o">(</code><code class="nd">AtomicLong:</code><code class="o">:</code><code class="k">new</code><code class="o">,</code><code class="calibre24"> </code><code class="o">(</code><code class="n">state</code><code class="o">,</code><code class="calibre24"> </code><code class="n">sink</code><code class="o">)</code><code class="calibre24"> </code><code class="o">-</code><code class="o">&gt;</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO11-2" href="part0007_split_015.html#callout_application_metrics_CO11-2"><img src="../images/00059.png" alt="2" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">        </code><code class="kt">long</code><code class="calibre24"> </code><code class="n">i</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">state</code><code class="o">.</code><code class="na">getAndIncrement</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="n">sink</code><code class="o">.</code><code class="na">next</code><code class="o">(</code><code class="n">i</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="k">return</code><code class="calibre24"> </code><code class="n">state</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">}</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">limitRate</code><code class="o">(</code><code class="mi">1</code><code class="o">)</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO11-3" href="part0007_split_015.html#callout_application_metrics_CO11-3"><img src="../images/00067.png" alt="3" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">flatMap</code><code class="o">(</code><code class="n">n</code><code class="calibre24"> </code><code class="o">-</code><code class="o">&gt;</code><code class="calibre24"> </code><code class="n">client</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">uri</code><code class="o">(</code><code class="s">"/api/endpoint"</code><code class="o">)</code><code class="o">.</code><code class="na">exchange</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">doOnNext</code><code class="o">(</code><code class="n">resp</code><code class="calibre24"> </code><code class="o">-</code><code class="o">&gt;</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">        </code><code class="k">if</code><code class="calibre24"> </code><code class="o">(</code><code class="n">resp</code><code class="o">.</code><code class="na">statusCode</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">is2xxSuccessful</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">          </code><code class="n">counter</code><code class="o">.</code><code class="na">increment</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">}</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="o">.</code><code class="na">blockLast</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO11-1" href="part0007_split_015.html#co_application_metrics_CO11-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Configure a registry to ship metrics from the load test’s perspective to a monitoring system of choice.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO11-2" href="part0007_split_015.html#co_application_metrics_CO11-2"><img src="../images/00059.png" alt="2" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Generate an infinite flux, or if you want to run this for a particular number of requests, you can use <code class="calibre24">Flux.range(0, MAX_REQUESTS)</code> instead.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO11-3" href="part0007_split_015.html#co_application_metrics_CO11-3"><img src="../images/00067.png" alt="3" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">Clamp the rate at which you want the test to send requests to the service.</p></dd>
</dl>

<p class="author1">The difference between a reactive load test like this and a conventional load test is significant, as seen in <a data-type="xref" href="part0007_split_015.html#non_blocking_vs_conventional_load_test" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-21</a>. Conventional load tests (because they are blocking, and therefore can only have a concurrency level equal to or less than the number of cores on the machine running the test) show a max latency less than 10 ms. A nonblocking reactive load test shows a tower of latencies all the way up to greater than 200 ms, with a strong band greater than 200 ms as the application becomes saturated.</p>

<figure class="calibre32"><div id="non_blocking_vs_conventional_load_test" class="figure">
<img src="../images/00069.png" alt="srej 0221" class="calibre89"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-21. </span>Blocking load test versus a nonblocking (reactive) load test</h6>
</div></figure>

<p class="author1">The effect (shown in <a data-type="xref" href="part0007_split_015.html#non_blocking_vs_conventional_load_test_max" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-22</a>) on the alert criteria suggested in <a data-type="xref" href="part0009_split_017.html#8ILV9-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Latency”</a> is noticeable, as expected.</p>

<figure class="calibre32"><div id="non_blocking_vs_conventional_load_test_max" class="figure">
<img src="../images/00068.png" alt="srej 0222" class="calibre90"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-22. </span>Difference in max latency</h6>
</div></figure>

<p class="author1">The effect is also noticeable on the 99th percentile latency indicator, shown in <a data-type="xref" href="part0007_split_015.html#non_blocking_vs_conventional_load_test_p99" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-23</a>, so it would show up on the key indicator we use to <em class="calibre12">compare</em> the response-time performance of two versions of the same microservice (see <a data-type="xref" href="part0010_split_013.html#9H5VC-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Automated Canary Analysis”</a>).</p>

<figure class="calibre32"><div id="non_blocking_vs_conventional_load_test_p99" class="figure">
<img src="../images/00025.png" alt="srej 0223" class="calibre91"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-23. </span>Difference in 99th percentile</h6>
</div></figure>

<p class="author1">This example also shows why a server’s view of its own throughput can be misleading. Throughput, shown in <a data-type="xref" href="part0007_split_015.html#non_blocking_vs_conventional_load_test_throughput" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-24</a>, only increased from approximately 1 ops/second to 3 ops/second between the two tests, but this represents how many requests are being <em class="calibre12">completed</em>. In fact, during the period of the reactive load test where the service was oversaturated, many more requests were being queued up on the service’s Tomcat thread pool and not being handled in a timely fashion.</p>

<p class="author1">If monitoring throughput (and latency) for the sake of alert criteria in production, it would be better to monitor both from the perspective of the client when possible, as discussed in <a data-type="xref" href="part0009_split_017.html#8ILV9-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Latency”</a>.</p>

<figure class="calibre32"><div id="non_blocking_vs_conventional_load_test_throughput" class="figure">
<img src="../images/00036.png" alt="srej 0224" class="calibre91"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-24. </span>Difference in throughput</h6>
</div></figure>

<p class="author1">Lastly, average latency is shown in <a data-type="xref" href="part0007_split_015.html#non_blocking_vs_conventional_load_test_average" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-25</a>. Even though the average has gone up by an order of magnitude between the two tests, average is still around 60 ms, which probably doesn’t seem all that bad. Average hides so much of what is really happening that it simply isn’t a useful measure.</p>

<figure class="calibre32"><div id="non_blocking_vs_conventional_load_test_average" class="figure">
<img src="../images/00096.png" alt="srej 0225" class="calibre92"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-25. </span>Difference in average latency</h6>
</div></figure>

<p class="author1">Now that we’ve seen many of the meter building blocks and some of the ways they are used, let’s turn our focus to application-wide customization of how metrics are shipped<a data-type="indexterm" data-startref="ix_ch02-asciidoc43" id="idm45139273884376" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>.<a data-type="indexterm" data-startref="ix_ch02-asciidoc42" id="idm45139273883544" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc41" id="idm45139273882840" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Meter Filters" class="calibre3"><div class="preface" id="meter_filter">
<h1 class="calibre19" id="6LLJE-2d714b853a094e9a910510217e0e3d73">Meter Filters</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="meter filters" id="ix_ch02-asciidoc44" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="filters" id="ix_ch02-asciidoc45" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="meter filters" id="ix_ch02-asciidoc46" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The more instrumentation that is added to various parts of the Java stack, the greater the necessity of somehow controlling which metrics are published and at what fidelity. I first became aware of this need chatting with one one of the engineers on the Netflix rating team (the ones that control the thumbs up/star rating system on the Netflix UI). He showed me how a particular metric instrumented in a core platform library included by most user-facing microservices was recording roughly 70,000 time series per API endpoint! This was absurdly wasteful, since the vast majority of these time series were not used for many product teams in dashboards and alerts. Instrumentation had been developed for the highest-possible-fidelity use case. This underscores how little choice core library producers really have. They need to instrument for the high fidelity case and rely on somebody downstream of them to tune down this fidelity to something useful for them. From this experience, Micrometer meter filters were born.</p>

<p class="author1">Each registry can be configured with meter filters, which allow a great degree of control over how and when meters are registered and what kinds of statistics they emit. Meter filters serve three basic functions:</p>
<ol class="calibre4">
<li class="calibre5">
<p class="calibre18"><em class="calibre12">Deny</em> (or accept) meters from being registered.</p>
</li>
<li class="calibre5">
<p class="calibre18"><em class="calibre12">Transform</em> meter IDs (e.g., changing the name, adding or removing tags, changing description or base units).</p>
</li>
<li class="calibre5">
<p class="calibre18"><em class="calibre12">Configure</em> distribution statistics for some meter types.</p>
</li>

</ol>

<p class="author1">Implementations of <code class="calibre24">MeterFilter</code> are added to the registry programmatically, as in <a data-type="xref" href="part0007_split_016.html#meter_filter_apply" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-48</a>.</p>
<div id="meter_filter_apply" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-48. </span>Applying meter filters</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">()</code>
    <code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">ignoreTags</code><code class="o">(</code><code class="s">"too.much.information"</code><code class="o">))</code>
    <code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">denyNameStartsWith</code><code class="o">(</code><code class="s">"jvm"</code><code class="o">));</code></pre></div>

<p class="author1">Meter filters are applied in order, and the results of transforming or configuring a meter are chained.</p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Meter Filters" class="calibre3">
<div class="preface" id="meter_filter">
<div data-type="warning" type="warning" class="calibre30"><h1 class="calibre69" id="calibre_pb_17">Apply Meter Filters Early in the Application Life Cycle</h1>
<p class="author1">For performance reasons, meter filters only influence meters registered <em class="calibre12">after</em> the filter.</p>
</div>








</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Meter Filters" class="calibre3">
<div class="preface" id="meter_filter">
<section data-type="sect2" data-pdf-bookmark="Deny/Accept Meters" class="calibre3"><div class="preface" id="idm45139273852520">
<h2 class="calibre37" id="6LLL2-2d714b853a094e9a910510217e0e3d73">Deny/Accept Meters</h2>

<p class="author1"><a data-type="indexterm" data-primary="accept/deny meters" id="ix_ch02-asciidoc47" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="deny/accept meters" id="ix_ch02-asciidoc48" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="meter filters" data-secondary="deny/accept meters" id="ix_ch02-asciidoc49" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>The verbose form of an accept/deny filter is shown in <a data-type="xref" href="part0007_split_018.html#verbose_meter_filter" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-49</a>.</p>
<div id="verbose_meter_filter" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-49. </span>Most verbose form of an accept/deny filter</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">MeterFilter</code> <code class="n">filter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">MeterFilter</code><code class="o">()</code> <code class="o">{</code>
  <code class="nd">@Override</code>
  <code class="k">public</code> <code class="n">MeterFilterReply</code> <code class="nf">accept</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">if</code><code class="o">(</code><code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">().</code><code class="na">contains</code><code class="o">(</code><code class="s">"test"</code><code class="o">))</code> <code class="o">{</code>
       <code class="k">return</code> <code class="n">MeterFilterReply</code><code class="o">.</code><code class="na">DENY</code><code class="o">;</code>
    <code class="o">}</code>
    <code class="k">return</code> <code class="n">MeterFilterReply</code><code class="o">.</code><code class="na">NEUTRAL</code><code class="o">;</code>
  <code class="o">}</code>
<code class="o">}</code></pre></div>

<p class="author1"><code class="calibre24">MeterFilterReply</code> has three possible states:</p>
<dl class="calibre20">
<dt class="calibre21"><code class="calibre24">DENY</code></dt>
<dd class="calibre22">
<p class="calibre23">Do not allow this meter to be registered. When you attempt to register a meter against a registry and the filter returns <code class="calibre24">DENY</code>, the registry will return a NOOP version of that meter (e.g., <code class="calibre24">NoopCounter</code>, <code class="calibre24">NoopTimer</code>). Your code can continue to interact with the NOOP meter, but anything recorded to it is discarded immediately with minimal overhead.</p>
</dd>
<dt class="calibre21"><code class="calibre24">NEUTRAL</code></dt>
<dd class="calibre22">
<p class="calibre23">If no other meter filter has returned <code class="calibre24">DENY</code>, then registration of meters proceeds as normal.</p>
</dd>
<dt class="calibre21"><code class="calibre24">ACCEPT</code></dt>
<dd class="calibre22">
<p class="calibre23">If a filter returns <code class="calibre24">ACCEPT</code>, the meter is immediately registered without interrogating any further filters’ accept methods.</p>
</dd>
</dl>

<p class="author1"><code class="calibre24">MeterFilter</code> provides several convenience static builders for deny/accept type filters:</p>
<dl class="calibre20">
<dt class="calibre21"><code class="calibre24">accept()</code></dt>
<dd class="calibre22">
<p class="calibre23">Accept every meter, overriding the decisions of any filters that follow.</p>
</dd>
<dt class="calibre21"><code class="calibre24">accept(Predicate&lt;Meter.Id&gt;)</code></dt>
<dd class="calibre22">
<p class="calibre23">Accept any meter matching the predicate.</p>
</dd>
<dt class="calibre21"><code class="calibre24">acceptNameStartsWith(String)</code></dt>
<dd class="calibre22">
<p class="calibre23">Accept every meter with a matching prefix.</p>
</dd>
<dt class="calibre21"><code class="calibre24">deny()</code></dt>
<dd class="calibre22">
<p class="calibre23">Deny every meter, overriding the decisions of any filters that follow.</p>
</dd>
<dt class="calibre21"><code class="calibre24">denyNameStartsWith(String)</code></dt>
<dd class="calibre22">
<p class="calibre23">Deny every meter with a matching prefix. All out-of-the-box <code class="calibre24">MeterBinder</code> implementations provided by Micrometer have names with common prefixes to allow for easy grouping visualization in UIs, but also to make them easy to disable/enable as a group with a prefix. For example, you can deny all JVM metrics with <code class="calibre24">MeterFilter.denyNameStartsWith("jvm")</code>.</p>
</dd>
<dt class="calibre21"><code class="calibre24">deny(Predicate&lt;Meter.Id&gt;)</code></dt>
<dd class="calibre22">
<p class="calibre23">Deny any meter matching the predicate.</p>
</dd>
<dt class="calibre21"><code class="calibre24">maximumAllowableMetrics(int)</code></dt>
<dd class="calibre22">
<p class="calibre23">Deny any meter after the registry has reached a certain number of meters.</p>
</dd>
<dt class="calibre21"><code class="calibre24">maximumAllowableTags(String meterNamePrefix, String tagKey, int maximumTagValues, MeterFilter onMaxReached)</code></dt>
<dd class="calibre22">
<p class="calibre23">Place an upper bound on the number of tags produced by matching series.</p>
</dd>
</dl>

<p class="author1"><em class="calibre12">Allowlisting</em> only a certain group of metrics is a particularly common case for monitoring systems that are <em class="calibre12">expensive</em>. This can be achieved with the static:</p>
<dl class="calibre20">
<dt class="calibre21"><code class="calibre24">denyUnless(Predicate&lt;Meter.Id&gt;)</code></dt>
<dd class="calibre22">
<p class="calibre23">Deny all meters that <em class="calibre12">don’t</em> match the predicate.</p>
</dd>
</dl>

<p class="author1">Meter filters are applied in the order in which they are configured on the registry, so it is possible to stack deny/accept filters to achieve more complex rules. In <a data-type="xref" href="part0007_split_018.html#accept_only_http" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-50</a>, we’re explicitly accepting any metric prefixed with <code class="calibre24">http</code>, and denying everything else. Because the first filter gives an accept decision on a meter like <code class="calibre24">http.server.requests</code>, the universal deny filter is never asked to provide an <span class="keep-together">opinion.</span><a data-type="indexterm" data-startref="ix_ch02-asciidoc49" id="idm45139273731912" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc48" id="idm45139273731208" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc47" id="idm45139273730536" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
<div id="accept_only_http" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-50. </span>Accept only HTTP metrics and deny everything else</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">()</code>
    <code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">acceptNameStartsWith</code><code class="o">(</code><code class="s">"http"</code><code class="o">))</code>
    <code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">deny</code><code class="o">());</code></pre></div>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Meter Filters" class="calibre3">
<div class="preface" id="meter_filter">
<section data-type="sect2" data-pdf-bookmark="Transforming Metrics" class="calibre3"><div class="preface" id="idm45139273689640">
<h2 class="calibre37" id="calibre_pb_19">Transforming Metrics</h2>

<p class="author1"><a data-type="indexterm" data-primary="meter filters" data-secondary="transforming metrics" id="idm45139273686728" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="transforming metrics" id="idm45139273685784" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Meter filters can also transform a meter’s name, tags, description, and base units. One of the most common applications of transforming metrics is to add common tags. The author of a common Java library like the RabbitMQ Java client cannot possibly guess how you wish to identify RabbitMQ metrics arriving at your monitoring system by application, the deployed environment, the instance that the code is running on, the version of the application, etc. The possibility of applying common tags to all metrics streaming out of an application means that low-level-library authors can keep their instrumentation simple, adding only tags related to the piece they are <span class="keep-together">instrumenting,</span> e.g., the queue name for RabbitMQ metrics. The application developer can then enrich this instrumentation with other identifying information.</p>

<p class="author1">A transform filter is shown in <a data-type="xref" href="part0007_split_019.html#transform_meter_filter" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-51</a>. This filter adds a name prefix and an additional tag conditionally to meters starting with the name “test.”</p>
<div id="transform_meter_filter" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-51. </span>Transform meter filter</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="n">MeterFilter</code> <code class="n">filter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">MeterFilter</code><code class="o">()</code> <code class="o">{</code>
    <code class="nd">@Override</code>
    <code class="k">public</code> <code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="nf">map</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
       <code class="k">if</code><code class="o">(</code><code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">().</code><code class="na">startsWith</code><code class="o">(</code><code class="s">"test"</code><code class="o">))</code> <code class="o">{</code>
          <code class="k">return</code> <code class="n">id</code><code class="o">.</code><code class="na">withName</code><code class="o">(</code><code class="s">"extra."</code> <code class="o">+</code> <code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">()).</code><code class="na">withTag</code><code class="o">(</code><code class="s">"extra.tag"</code><code class="o">,</code> <code class="s">"value"</code><code class="o">);</code>
       <code class="o">}</code>
       <code class="k">return</code> <code class="n">id</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre></div>

<p class="author1"><code class="calibre24">MeterFilter</code> provides convenience builders for many common transformation cases:</p>
<dl class="calibre20">
<dt class="calibre21"><code class="calibre24">commonTags(Iterable&lt;Tag&gt;)</code></dt>
<dd class="calibre22">
<p class="calibre23">Add a set of tags to all metrics. Adding common tags for app name, host, region, etc., is a highly recommended practice.</p>
</dd>
<dt class="calibre21"><code class="calibre24">ignoreTags(String...)</code></dt>
<dd class="calibre22">
<p class="calibre23">Drop matching tag keys from every meter. This is particularly useful when a tag’s cardinality probably becomes too high and starts stressing your monitoring system or costing too much, but you can’t change all the instrumentation points quickly.</p>
</dd>
<dt class="calibre21"><code class="calibre24">replaceTagValues(String tagKey, Function&lt;String, String&gt; replacement, String... exceptions)</code></dt>
<dd class="calibre22">
<p class="calibre23">Replace tag values according to the provided mapping for all matching tag keys. This can be used to reduce the total cardinality of a tag by mapping some portion of tag values to something else.</p>
</dd>
<dt class="calibre21"><code class="calibre24">renameTag(String meterNamePrefix, String fromTagKey, String toTagKey)</code></dt>
<dd class="calibre22">
<p class="calibre23">Rename a tag key for every metric beginning with a given prefix.</p>
</dd>
</dl>

<p class="author1">Ignoring one or more of the tags mentioned at the beginning of this section on Netflix core platform instrumentation, which yielded tens of thousands of tags per API endpoint, could have significantly cut down on cost.</p>
</div></section>













</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Meter Filters" class="calibre3">
<div class="preface" id="meter_filter">
<section data-type="sect2" class="calibre3" data-pdf-bookmark="Configuring Distribution Statistics"><div class="preface" id="idm45139273592056">
<h2 class="calibre37" id="6LLSH-2d714b853a094e9a910510217e0e3d73">Configuring Distribution Statistics</h2>

<p class="author1"><a data-type="indexterm" data-primary="configuring distribution statistics" id="idm45139273590248" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="distribution statistics, configuring" id="idm45139273589384" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="meter filters" data-secondary="configuring distribution statistics" id="idm45139273588712" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><code class="calibre24">Timer</code>, <code class="calibre24">LongTaskTimer</code>, and <code class="calibre24">DistributionSummary</code> contain a set of optional distribution statistics in addition to the basics of count, total, and max that can be configured through filters. These distribution statistics include precomputed <a data-type="xref" href="part0007_split_003.html#6LK44-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Percentiles/Quantiles”</a>, <a data-type="xref" href="part0007_split_008.html#6LKH9-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Service Level Objective Boundaries”</a>, and <a data-type="xref" href="part0007_split_007.html#6LKA8-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">“Histograms”</a>. Distribution statistics can be configured through a <code class="calibre24">MeterFilter</code>, as shown in <a data-type="xref" href="part0007_split_020.html#distribution_statistics" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-52</a>.</p>
<div id="distribution_statistics" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-52. </span>Configuring distribution statistics</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">new</code> <code class="nf">MeterFilter</code><code class="o">()</code> <code class="o">{</code>
    <code class="nd">@Override</code>
    <code class="k">public</code> <code class="n">DistributionStatisticConfig</code> <code class="nf">configure</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="n">id</code><code class="o">,</code>
          <code class="n">DistributionStatisticConfig</code> <code class="n">config</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">if</code> <code class="o">(</code><code class="n">id</code><code class="o">.</code><code class="na">getName</code><code class="o">().</code><code class="na">startsWith</code><code class="o">(</code><code class="n">prefix</code><code class="o">))</code> <code class="o">{</code>
            <code class="k">return</code> <code class="n">DistributionStatisticConfig</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
                    <code class="o">.</code><code class="na">publishPercentiles</code><code class="o">(</code><code class="mi">0.9</code><code class="o">,</code> <code class="mi">0.95</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">build</code><code class="o">()</code>
                    <code class="o">.</code><code class="na">merge</code><code class="o">(</code><code class="n">config</code><code class="o">);</code>
        <code class="o">}</code>
        <code class="k">return</code> <code class="n">config</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">};</code></pre></div>

<p class="author1">Generally, you should create a new <code class="calibre24">DistributionStatisticConfig</code> with just the pieces you wish to configure and then <code class="calibre24">merge</code> it with the input configuration. This allows you to drop-down on registry-provided defaults for distribution statistics and to chain multiple filters together, each of which configures some part of the distribution statistics (e.g., maybe you want a 100 ms SLO for all HTTP requests but only percentile histograms on a few critical endpoints).</p>

<p class="author1"><code class="calibre24">MeterFilter</code> provides convenience builders for the following:</p>
<dl class="calibre20">
<dt class="calibre21"><code class="calibre24">maxExpected(Duration/long)</code></dt>
<dd class="calibre22">
<p class="calibre23">Governs the upper bound of percentile histogram buckets shipped from a timer or summary.</p>
</dd>
<dt class="calibre21"><code class="calibre24">minExpected(Duration/long)</code></dt>
<dd class="calibre22">
<p class="calibre23">Governs the lower bound of percentile histogram buckets shipped from a timer or summary.</p>
</dd>
</dl>

<p class="author1">Spring Boot offers property-based filters for configuring SLOs, percentiles, and percentile histograms by name prefix, as shown in the following list:</p>
<dl class="calibre20">
<dt class="calibre21"><code class="calibre24">management.metrics.distribution.percentiles-histogram</code></dt>
<dd class="calibre22">
<p class="calibre23">Whether to publish a histogram suitable for computing aggregable (across dimension) percentile approximations.</p>
</dd>
<dt class="calibre21"><code class="calibre24">management.metrics.distribution.minimum-expected-value</code></dt>
<dd class="calibre22">
<p class="calibre23">Publish less histogram buckets by clamping the range of expected values.</p>
</dd>
<dt class="calibre21"><code class="calibre24">management.metrics.distribution.maximum-expected-value</code></dt>
<dd class="calibre22">
<p class="calibre23">Publish less histogram buckets by clamping the range of expected values.</p>
</dd>
<dt class="calibre21"><code class="calibre24">management.metrics.distribution.percentiles</code></dt>
<dd class="calibre22">
<p class="calibre23">Publish percentile values computed in your application.</p>
</dd>
<dt class="calibre21"><code class="calibre24">management.metrics.distribution.sla</code></dt>
<dd class="calibre22">
<p class="calibre23">Publish a cumulative histogram with buckets defined by your SLAs.</p>
</dd>
</dl>

<p class="author1">Meter filters show up in ways that demonstrate how organizational culture can drive even the lowest level of software configurtion. Several organizations use them to separate platform and application metrics, for example.<a data-type="indexterm" data-startref="ix_ch02-asciidoc46" id="idm45139273482328" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc45" id="idm45139273481624" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc44" id="idm45139273480952" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>





</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Separating Platform and Application Metrics" class="calibre3"><div class="preface" id="separating_platform_and_application_metrics">
<h1 class="calibre19" id="6LM03-2d714b853a094e9a910510217e0e3d73">Separating Platform and Application Metrics</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="separating platform metrics from" id="ix_ch02-asciidoc50" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="platform metrics" id="ix_ch02-asciidoc51" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Conway’s Law <a data-type="indexterm" data-primary="Conway’s Law" id="idm45139273476216" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>suggests that “you ship your org chart.” This means roughly that the way in which your system is written, deployed, and works bears some resemblance to your organization.</p>

<p class="author1">I’ve found a common pattern that I think is a good positive illustration of this principle. At Netflix, the operations engineering organization (what we are calling platform engineering in this book) built tools that solved problems otherwise undifferentiated among individual microservices. This organization was very much customer-engineer-focused, but it exercised no oversight or control over what individual teams did because of the overarching “freedom and responsibility” culture. But at many organizations (and I don’t think this is necessarily worse or better), platform teams do act centrally on behalf of product teams. So while the monitoring of an individual microservice at Netflix was wholly the responsibility of the product team (with as much advice and assistance as requested from the central team), at many organizations the responsibility for monitoring applications may reside wholly with a central platform team.</p>

<p class="author1">In other cases, the responsibility is split, with a central platform team responsible for monitoring certain types of signals (usually resource metrics like processor, memory, and maybe closer-to-business metrics like API error ratio) and application teams responsible for any custom indicators. You may notice how the responsibilities in this case roughly break down along the lines of what black box and white box instrumentation each excel at (with platform teams monitoring black box signals and product teams monitoring white box signals). This is a good illustration of how agent-based instrumentation shipped to some particular SaaS product may serve the needs of the platform team while product teams use an entirely different monitoring system for other signals—i.e., how these types of instrumentation can be complementary rather than competitive.</p>

<p class="author1">Let’s consider an organization like this, and the impact it has on how metrics telemetry is configured in the application. To make this concrete, assume this organization is using Prometheus as its monitoring system. A platform engineer and a product engineer have different goals in this case:</p>
<dl class="calibre20">
<dt class="calibre21">Platform engineer</dt>
<dd class="calibre22">
<p class="calibre23"><a data-type="indexterm" data-primary="platform engineers, monitoring goals of" id="idm45139273470440" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>A platform engineer wants to monitor all microservices across the organization in the same way. This means that every microservice should publish a set of metrics the platform team intends to monitor. These metrics should have a consistent way of determining common tags (e.g., for the stack like test/dev/prod, region, cluster, server group name, application version, and an instance identifier). There is no value to the platform team in shipping anything more than the set of metrics the platform team intends to monitor. This set of metrics is unlikely to change significantly over time, because by the nature of the responsibility of the platform team, they represent general indicators that are useful to all applications and aren’t tied to specific business functions or features.</p>
</dd>
<dt class="calibre21">Product engineer</dt>
<dd class="calibre22">
<p class="calibre23"><a data-type="indexterm" data-primary="product engineers, monitoring goals of" id="idm45139273467640" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>A product engineer wants to monitor their microservice(s) alone. The same set of common tags applicable to the platform engineer are likely beneficial to the product engineer as well, but there may be additional common tags that further differentiate individual instances at a level that isn’t relevant to the platform team. For example, the application team may deploy several clusters of its microservice that could contain the same application code but serve different segments of its end users (e.g., internal users versus external users). They will likely want to add a common tag for this distinction to their metrics as well, as there may be <span class="keep-together">different</span> SLOs for different end-user populations. The metrics that a product engineer should focus most on will be more specific to end-user experience. They are also likely to be feature-focused. As new features change, the set of metrics changes as well.</p>
</dd>
</dl>

<p class="author1">If metrics for a microservice were published through a single <code class="calibre24">MeterRegistry</code>, there is a chance that product engineer customizations to the registry would impact the observability of the microservice for the platform team. And, depending on how metrics tags are being aggregated for display by the product team, platform engineers adding additional common tags could impact the alerts and dashboards of product engineers.</p>

<p class="author1">Because the engineering organization is structured in this way with this division of responsibilities across team boundaries, it should come up with a way to split the publishing of metrics into distinct meter registries that best serve the individual responsibilities of platform and product teams. “You ship your org chart.”</p>

<p class="author1">Since this sort of division of responsibility is fairly common, let’s consider how this would be achieved. First, the platform team becomes responsible for shipping a common library, a JAR binary dependency that every microservice can include that contains this common configuration. Because presumably microservice teams will be on different release cycles, the platform team will naturally have to evolve this common configuration slowly, relative to the pace of change of any individual microservice. In this common platform JAR, we’d expect to see autoconfiguration like in <a data-type="xref" href="part0007_split_021.html#6LM0R-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-53</a>.</p>
<div id="platform_autoconfiguration_metrics" data-type="example" class="calibre61">
<h5 class="calibre62" id="6LM0R-2d714b853a094e9a910510217e0e3d73"><span class="keep-together">Example 2-53. </span>Platform team’s autoconfiguration of metrics shared with product teams</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="nd">@Configuration</code><code class="calibre24">
</code><code class="k">public</code><code class="calibre24"> </code><code class="k">class</code><code class="calibre24"> </code><code class="nc">PlatformMetricsAutoConfiguration</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">private</code><code class="calibre24"> </code><code class="k">final</code><code class="calibre24"> </code><code class="n">Logger</code><code class="calibre24"> </code><code class="n">logger</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">LoggerFactory</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">PlatformMetricsAutoConfiguration</code><code class="o">.</code><code class="na">class</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">private</code><code class="calibre24"> </code><code class="k">final</code><code class="calibre24"> </code><code class="n">PrometheusMeterRegistry</code><code class="calibre24"> </code><code class="n">prometheusMeterRegistry</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">PrometheusMeterRegistry</code><code class="o">(</code><code class="n">PrometheusConfig</code><code class="o">.</code><code class="na">DEFAULT</code><code class="o">)</code><code class="o">;</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO12-1" href="part0007_split_021.html#callout_application_metrics_CO12-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Value</code><code class="o">(</code><code class="s">"${spring.application.name:unknown}"</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">private</code><code class="calibre24"> </code><code class="n">String</code><code class="calibre24"> </code><code class="n">appName</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Value</code><code class="o">(</code><code class="s">"${HOSTNAME:unknown}"</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">private</code><code class="calibre24"> </code><code class="n">String</code><code class="calibre24"> </code><code class="n">host</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">public</code><code class="calibre24"> </code><code class="nf">PlatformMetricsAutoConfiguration</code><code class="o">(</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO12-2" href="part0007_split_021.html#callout_application_metrics_CO12-2"><img src="../images/00059.png" alt="2" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">JvmGcMetrics</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">bindTo</code><code class="o">(</code><code class="n">prometheusMeterRegistry</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">JvmHeapPressureMetrics</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">bindTo</code><code class="o">(</code><code class="n">prometheusMeterRegistry</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">JvmMemoryMetrics</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">bindTo</code><code class="o">(</code><code class="n">prometheusMeterRegistry</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">ProcessorMetrics</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">bindTo</code><code class="o">(</code><code class="n">prometheusMeterRegistry</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">new</code><code class="calibre24"> </code><code class="nf">FileDescriptorMetrics</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">bindTo</code><code class="o">(</code><code class="n">prometheusMeterRegistry</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Bean</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@ConditionalOnBean</code><code class="o">(</code><code class="n">KubernetesClient</code><code class="o">.</code><code class="na">class</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="n">MeterFilter</code><code class="calibre24"> </code><code class="nf">kubernetesMeterFilter</code><code class="o">(</code><code class="n">KubernetesClient</code><code class="calibre24"> </code><code class="n">k8sClient</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO12-3" href="part0007_split_021.html#callout_application_metrics_CO12-3"><img src="../images/00067.png" alt="3" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">MeterFilter</code><code class="calibre24"> </code><code class="n">k8sMeterFilter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="k">new</code><code class="calibre24"> </code><code class="n">KubernetesCommonTags</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">prometheusMeterRegistry</code><code class="o">.</code><code class="na">config</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">k8sMeterFilter</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">return</code><code class="calibre24"> </code><code class="n">k8sMeterFilter</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@Bean</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@ConditionalOnMissingBean</code><code class="o">(</code><code class="n">KubernetesClient</code><code class="o">.</code><code class="na">class</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="n">MeterFilter</code><code class="calibre24"> </code><code class="nf">appAndHostTagsMeterFilter</code><code class="o">(</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">MeterFilter</code><code class="calibre24"> </code><code class="n">appAndHostMeterFilter</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">commonTags</code><code class="o">(</code><code class="calibre24">
</code><code class="calibre24">      </code><code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"app"</code><code class="o">,</code><code class="calibre24"> </code><code class="n">appName</code><code class="o">,</code><code class="calibre24"> </code><code class="s">"host"</code><code class="o">,</code><code class="calibre24"> </code><code class="n">host</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">prometheusMeterRegistry</code><code class="o">.</code><code class="na">config</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">appAndHostMeterFilter</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="k">return</code><code class="calibre24"> </code><code class="n">appAndHostMeterFilter</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="nd">@RestController</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="k">class</code><code class="calibre24"> </code><code class="nc">PlatformMetricsEndpoint</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="nd">@GetMapping</code><code class="o">(</code><code class="n">path</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="s">"/platform/metrics"</code><code class="o">,</code><code class="calibre24"> </code><code class="n">produces</code><code class="calibre24"> </code><code class="o">=</code><code class="calibre24"> </code><code class="n">TextFormat</code><code class="o">.</code><code class="na">CONTENT_TYPE_004</code><code class="o">)</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="n">String</code><code class="calibre24"> </code><code class="nf">platformMetrics</code><code class="o">(</code><code class="o">)</code><code class="calibre24"> </code><code class="o">{</code><code class="calibre24"> </code><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="co_application_metrics_CO12-4" href="part0007_split_021.html#callout_application_metrics_CO12-4"><img src="../images/00016.png" alt="4" class="calibre66"/></a><code class="calibre24">
</code><code class="calibre24">      </code><code class="k">return</code><code class="calibre24"> </code><code class="n">prometheusMeterRegistry</code><code class="o">.</code><code class="na">scrape</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code class="calibre24">
</code><code class="calibre24">    </code><code class="o">}</code><code class="calibre24">
</code><code class="calibre24">  </code><code class="o">}</code><code class="calibre24">
</code><code class="o">}</code></pre></div>
<dl class="calibre20">
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO12-1" href="part0007_split_021.html#co_application_metrics_CO12-1"><img src="../images/00112.png" alt="1" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">In the platform team’s configuration, a Prometheus meter registry can be created privately, without adding it to the Spring application context, so it is not subject to <code class="calibre24">MeterFilter</code>, <code class="calibre24">MeterBinder</code>, and other customizations that the product team might configure via the application context.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO12-2" href="part0007_split_021.html#co_application_metrics_CO12-2"><img src="../images/00059.png" alt="2" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">The metrics that the platform team cares about are added directly to the privately configured registry.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO12-3" href="part0007_split_021.html#co_application_metrics_CO12-3"><img src="../images/00067.png" alt="3" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">The platform team provides a common tag meter filter that works for every microservice running in Kubernetes. This practice is a concern cutting all microservice teams, and they all benefit from the same set of common tags (though they may add their own additionally). The meter filter is also applied right after construction to the private platform meter registry. A fallback set of common tags is provided for when the application isn’t running in Kubernetes.</p></dd>
<dt class="calibre21"><a class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre" id="callout_application_metrics_CO12-4" href="part0007_split_021.html#co_application_metrics_CO12-4"><img src="../images/00016.png" alt="4" class="calibre66"/></a></dt>
<dd class="calibre67"><p class="calibre68">The platform team sets up an API endpoint for itself, common to every application and distinct from the typical <code class="calibre24">/actuator/prometheus</code> endpoint that Spring would autoconfigure, leaving the actuator endpoint to be under the full control of the product team for its own purposes.</p></dd>
</dl>

<p class="author1">The implementation of Kubernetes common tags, shown in <a data-type="xref" href="part0007_split_021.html#6LMD0-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-54</a>, is applicable to the kinds of annotations that Spinnaker’s Kubernetes implementation configures to be placed on pods. Spinnaker will be discussed in greater detail in <a data-type="xref" href="part0010_split_000.html#9H5K4-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Chapter 5</a>.</p>
<div id="kubernetes_common_tags" data-type="example" class="calibre61">
<h5 class="calibre62" id="6LMD0-2d714b853a094e9a910510217e0e3d73"><span class="keep-together">Example 2-54. </span>Kubernetes common tags, assuming the service was deployed by Spinnaker</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">public</code> <code class="k">class</code> <code class="nc">KubernetesCommonTags</code> <code class="k">implements</code> <code class="n">MeterFilter</code> <code class="o">{</code>
  <code class="k">private</code> <code class="k">final</code> <code class="n">Function</code><code class="o">&lt;</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code><code class="o">,</code> <code class="n">Meter</code><code class="o">.</code><code class="na">Id</code><code class="o">&gt;</code> <code class="n">idMapper</code><code class="o">;</code>

  <code class="k">public</code> <code class="nf">KubernetesCommonTags</code><code class="o">(</code><code class="n">KubernetesClient</code> <code class="n">k8sClient</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">try</code> <code class="o">{</code>
      <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">annotations</code> <code class="o">=</code> <code class="n">k8sClient</code><code class="o">.</code><code class="na">pods</code><code class="o">()</code>
        <code class="o">.</code><code class="na">withName</code><code class="o">(</code><code class="n">host</code><code class="o">)</code>
        <code class="o">.</code><code class="na">get</code><code class="o">()</code>
        <code class="o">.</code><code class="na">getMetadata</code><code class="o">()</code>
        <code class="o">.</code><code class="na">getAnnotations</code><code class="o">();</code>

      <code class="k">for</code> <code class="o">(</code><code class="n">Map</code><code class="o">.</code><code class="na">Entry</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">annotation</code> <code class="o">:</code> <code class="n">annotations</code><code class="o">.</code><code class="na">entrySet</code><code class="o">())</code> <code class="o">{</code>
        <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Kubernetes pod annotation &lt;"</code> <code class="o">+</code> <code class="n">annotation</code><code class="o">.</code><code class="na">getKey</code><code class="o">()</code> <code class="o">+</code>
          <code class="s">"="</code> <code class="o">+</code> <code class="n">annotation</code><code class="o">.</code><code class="na">getValue</code><code class="o">()</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="o">);</code>
      <code class="o">}</code>

      <code class="n">idMapper</code> <code class="o">=</code> <code class="n">id</code> <code class="o">-&gt;</code> <code class="n">id</code><code class="o">.</code><code class="na">withTags</code><code class="o">(</code><code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>
        <code class="s">"revision"</code><code class="o">,</code>
          <code class="n">annotations</code><code class="o">.</code><code class="na">getOrDefault</code><code class="o">(</code><code class="s">"deployment.kubernetes.io/revision"</code><code class="o">,</code> <code class="s">"unknown"</code><code class="o">),</code>
        <code class="s">"app"</code><code class="o">,</code>
          <code class="n">annotations</code><code class="o">.</code><code class="na">getOrDefault</code><code class="o">(</code><code class="s">"moniker.spinnaker.io/application"</code><code class="o">,</code> <code class="n">appName</code><code class="o">),</code>
        <code class="s">"cluster"</code><code class="o">,</code>
          <code class="n">stream</code><code class="o">(</code><code class="n">annotations</code>
            <code class="o">.</code><code class="na">getOrDefault</code><code class="o">(</code><code class="s">"moniker.spinnaker.io/cluster"</code><code class="o">,</code> <code class="s">"unknown"</code><code class="o">)</code>
            <code class="o">.</code><code class="na">split</code><code class="o">(</code><code class="s">" "</code><code class="o">)</code>
          <code class="o">).</code><code class="na">reduce</code><code class="o">((</code><code class="n">first</code><code class="o">,</code> <code class="n">second</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="n">second</code><code class="o">).</code><code class="na">orElse</code><code class="o">(</code><code class="s">"unknown"</code><code class="o">),</code>
        <code class="s">"location"</code><code class="o">,</code>
          <code class="n">annotations</code><code class="o">.</code><code class="na">getOrDefault</code><code class="o">(</code><code class="s">"artifact.spinnaker.io/location"</code><code class="o">,</code> <code class="s">"unknown"</code><code class="o">),</code>
        <code class="s">"host"</code><code class="o">,</code> <code class="n">host</code>
      <code class="o">));</code>
    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">KubernetesClientException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>
      <code class="n">logger</code><code class="o">.</code><code class="na">warn</code><code class="o">(</code><code class="s">"Unable to apply kubernetes tags"</code><code class="o">,</code> <code class="n">e</code><code class="o">);</code>
      <code class="n">idMapper</code> <code class="o">=</code> <code class="n">id</code> <code class="o">-&gt;</code> <code class="n">id</code><code class="o">.</code><code class="na">withTags</code><code class="o">(</code><code class="n">Tags</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>
        <code class="s">"app"</code><code class="o">,</code> <code class="n">appName</code><code class="o">,</code>
        <code class="s">"host"</code><code class="o">,</code> <code class="n">host</code><code class="o">,</code>
        <code class="s">"cluster"</code><code class="o">,</code> <code class="s">"unknown"</code><code class="o">)</code>
      <code class="o">);</code>
    <code class="o">}</code>
  <code class="o">}</code>

  <code class="nd">@Override</code>
  <code class="k">public</code> <code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="nf">map</code><code class="o">(</code><code class="n">Meter</code><code class="o">.</code><code class="na">Id</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">idMapper</code><code class="o">.</code><code class="na">apply</code><code class="o">(</code><code class="n">id</code><code class="o">);</code>
  <code class="o">}</code>
<code class="o">}</code></pre></div>

<p class="author1">Another use case of meter filters involves adding a layer of resiliency to your publication of metrics themselves.<a data-type="indexterm" data-startref="ix_ch02-asciidoc51" id="idm45139273035528" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc50" id="idm45139273034920" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Partitioning Metrics by Monitoring System" class="calibre3"><div class="preface" id="idm45139273479688">
<h1 class="calibre19" id="calibre_pb_22">Partitioning Metrics by Monitoring System</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="partitioning metrics by monitoring system" id="ix_ch02-asciidoc52" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="monitoring" data-secondary="partitioning metrics by monitoring system" id="ix_ch02-asciidoc53" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>Suppose your organization has selected Prometheus as its primary monitoring system, and a dedicated platform engineering team is operating a series of Prometheus instances which should be pulling metrics from every application in the company’s inventory. Perhaps this platform team even contributes to monitoring some set of common indicators, on behalf of product teams, known to be broadly applicable to every Java microservice running in the organization.</p>

<p class="author1">How do these engineers prove that the Prometheus instances they think they are operating effectively are in fact scraping all the deployed assets successfully? There are different failure modes. In one case, Prometheus could simply time out attempting to pull metrics from a given application. This would be visible from Prometheus’s monitoring of itself. But another failure mode might be that we have misconfigured Prometheus so that it isn’t even <em class="calibre12">attempting</em> to scrape this application. In this case, Prometheus dutifully scrapes all the applications it knows about and reports nothing about the applications it doesn’t.</p>

<p class="author1">Suppose also your organization is running its infrastructure on AWS. We could choose to dual-publish metrics, both to our primary monitoring system Prometheus and to AWS Cloudwatch. A little investigation shows that Cloudwatch (like other public cloud-provider-hosted monitoring solutions) is fairly expensive, billed by the number of time series sent. But we really only want to use Cloudwatch to verify that Prometheus is doing what it should.</p>

<p class="author1">The overall process looks like <a data-type="xref" href="part0007_split_022.html#prom_and_cloudwatch" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Figure 2-26</a>. The Prometheus team routinely queries the state of the deployed asset inventory (maybe through a stateful delivery automation solution as described in <a data-type="xref" href="part0010_split_000.html#9H5K4-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Chapter 5</a>). For each application listed, the team can check for the counter that Micrometer maintains of Prometheus’s scrape attempts for the application. An application that isn’t being scraped will have a zero or empty counter.</p>

<figure class="calibre32"><div id="prom_and_cloudwatch" class="figure">
<img src="../images/00117.png" alt="srej 0226" class="calibre93"/>
<h6 class="calibre34"><span class="keep-together">Figure 2-26. </span>Shipping metrics to both Prometheus and Cloudwatch</h6>
</div></figure>

<p class="author1"><a data-type="xref" href="part0007_split_022.html#cloud_watch_meter_registry_customizer" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-55</a> shows how we can use an accept and deny <code class="calibre24">MeterFilter</code> pair to cost-effectively ship to Cloudwatch only the Prometheus metrics that are relevant in helping the platform team determine that the Prometheus scrape configuration is working as expected. It uses a Spring Boot feature called <code class="calibre24">MeterRegistryCustomizer</code> that allows us to add filter and other registry customization to specific registry types rather than to all of them.</p>
<div id="cloud_watch_meter_registry_customizer" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-55. </span>Using Cloudwatch MeterRegistryCustomizer</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="nd">@Bean</code>
<code class="n">MeterRegistryCustomizer</code><code class="o">&lt;</code><code class="n">CloudwatchMeterRegistry</code><code class="o">&gt;</code> <code class="nf">cloudwatchCustomizations</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">registry</code> <code class="o">-&gt;</code> <code class="n">registry</code><code class="o">.</code><code class="na">config</code><code class="o">()</code>
            <code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">acceptNameStartsWith</code><code class="o">(</code><code class="s">"prometheus"</code><code class="o">))</code>
            <code class="o">.</code><code class="na">meterFilter</code><code class="o">(</code><code class="n">MeterFilter</code><code class="o">.</code><code class="na">deny</code><code class="o">());</code>
<code class="o">}</code></pre></div>

<p class="author1">There is one last concept related to the organization of metrics.<a data-type="indexterm" data-startref="ix_ch02-asciidoc53" id="idm45139272694680" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-startref="ix_ch02-asciidoc52" id="idm45139272684744" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Meter Binders" class="calibre3"><div class="preface" id="meter_binders">
<h1 class="calibre19" id="calibre_pb_23">Meter Binders</h1>

<p class="author1"><a data-type="indexterm" data-primary="application metrics" data-secondary="meter binders" id="idm45139272682392" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/><a data-type="indexterm" data-primary="MeterBinder interface" id="idm45139272681192" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>In many cases monitoring some subsystem or library involves more than one meter. Micrometer provides a simple functional interface called a <code class="calibre24">MeterBinder</code> that is designed for encapsulating a set of meters together. Spring Boot automatically registers the metrics from any <code class="calibre24">MeterBinder</code> bean that is configured to the application context (i.e., <code class="calibre24">@Bean MeterBinder ...</code>). <a data-type="xref" href="part0007_split_023.html#meter_binder" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-56</a> illustrates a simple meter binder that encapsulates some metrics around a vehicle type.</p>
<div id="meter_binder" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-56. </span>Meter binder implementation</h5>

<pre data-type="programlisting" data-code-language="java" class="calibre63"><code class="k">public</code> <code class="k">class</code> <code class="nc">VehicleMeterBinder</code> <code class="k">implements</code> <code class="n">MeterBinder</code> <code class="o">{</code>
  <code class="k">private</code> <code class="k">final</code> <code class="n">Vehicle</code> <code class="n">vehicle</code><code class="o">;</code>

  <code class="k">public</code> <code class="nf">VehicleMeterBinder</code><code class="o">(</code><code class="n">Vehicle</code> <code class="n">vehicle</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">this</code><code class="o">.</code><code class="na">vehicle</code> <code class="o">=</code> <code class="n">vehicle</code><code class="o">;</code>
  <code class="o">}</code>

  <code class="nd">@Override</code>
  <code class="k">public</code> <code class="kt">void</code> <code class="nf">bindTo</code><code class="o">(</code><code class="n">MeterRegistry</code> <code class="n">registry</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">Gauge</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"vehicle.speed"</code><code class="o">,</code> <code class="n">vehicle</code><code class="o">,</code> <code class="nd">Vehicle:</code><code class="o">:</code><code class="n">getSpeed</code><code class="o">)</code>
      <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"km/h"</code><code class="o">)</code>
      <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"Current vehicle speed"</code><code class="o">)</code>
      <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code>

    <code class="n">FunctionCounter</code><code class="o">.</code><code class="na">builder</code><code class="o">(</code><code class="s">"vehicle.odometer"</code><code class="o">,</code> <code class="n">vehicle</code><code class="o">,</code> <code class="nd">Vehicle:</code><code class="o">:</code><code class="n">readOdometer</code><code class="o">())</code>
      <code class="o">.</code><code class="na">baseUnit</code><code class="o">(</code><code class="s">"kilometers"</code><code class="o">)</code>
      <code class="o">.</code><code class="na">description</code><code class="o">(</code><code class="s">"The amount of distance this vehicle has traveled"</code><code class="o">)</code>
      <code class="o">.</code><code class="na">register</code><code class="o">(</code><code class="n">registry</code><code class="o">);</code>
  <code class="o">}</code>
<code class="o">}</code></pre></div>

<p class="author1">It is best if all metrics registered in a meter binder share some common prefix (in this case “vehicle”), especially when the binder is packed up and shipped as default configuration across a wide array of applications. Some teams may not find the metrics to be useful in their specific case and filter them out to save on cost. Having a common prefix makes it easy to apply a deny meter filter by the common prefix, as in <a data-type="xref" href="part0007_split_023.html#property_based_deny_filter" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Example 2-57</a>. In this way, you can add and remove metrics from the meter binder over time, and the filter logic still has the effect of broadly including or excluding the metrics produced by this meter binder.<a data-type="indexterm" data-startref="ix_ch02-asciidoc5" id="idm45139272534200" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/></p>
<div id="property_based_deny_filter" data-type="example" class="calibre61">
<h5 class="calibre62"><span class="keep-together">Example 2-57. </span>A property-based deny filter for metrics coming from the vehicle meter binder</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre63"><code class="nt">management.metrics.enable.vehicle</code><code class="p">:</code> <code class="calibre24">false</code></pre></div>
</div></section>













</div></section></div>



  

<div id="sbo-rt-content" class="calibre2">
<section data-type="chapter" type="chapter" data-pdf-bookmark="Chapter 2. Application Metrics" class="calibre3">
<div class="preface" id="ch_app_monitoring">
<section data-type="sect1" data-pdf-bookmark="Summary" class="calibre3"><div class="preface" id="idm45139272530392">
<h1 class="calibre19" id="calibre_pb_24">Summary</h1>

<p class="author1">In this chapter, you’ve learned how to measure various parts of your application with dimensional metrics. We haven’t yet discussed specifically how to <em class="calibre12">use</em> this data. We will eventually be coming back to metrics in <a data-type="xref" href="part0009_split_000.html#8IL24-2d714b853a094e9a910510217e0e3d73" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre">Chapter 4</a>, where effective indicators for every Java microservice are presented along with how to build effective charts and alerts.</p>

<p class="author1">The organizational commitment you are signing up for to take advantage of all this dimensional metrics data involves the selection of one or more target dimensional monitoring systems, either picking a SaaS offering or standing up one of the available OSS systems on-prem. The impact on your code is limited. When using modern Java web frameworks like Spring Boot, prepackaged instrumentation will provide a great deal of detail without having to write any custom instrumentation code. All you need to do is add a dependency on the monitoring system implementation of your choice and then provide some configuration to ship metrics to it.</p>

<p class="author1">In the next chapter, we’ll see how metrics instrumentation compares to debuggability signals like distributed traces and logs. While reading it, keep in mind that the metrics instrumentation we’ve just discussed is designed to provide fixed-cost telemetry that helps you to understand what is happening to your system in the <em class="calibre12">aggregate</em>. These other telemetry sources will provide detailed information about what is happening at an <a data-type="indexterm" data-startref="ix_ch02-asciidoc0" id="idm45139272523704" class="pcalibre2 pcalibre3 pcalibre1 pcalibre4 pcalibre"/>individual event (or request) level.</p>
</div></section>







</div></section></div>



  </body></html>