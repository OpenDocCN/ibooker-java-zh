<html><head></head><body><section data-pdf-bookmark="Chapter 17. Reflection, or &#x201C;A Class Named Class&#x201D;" data-type="chapter" epub:type="chapter"><div class="chapter" id="javacook-reflection">&#13;
<h1><span class="label">Chapter 17. </span>Reflection, or “A Class Named Class”</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.0 Introduction" data-type="sect1"><div class="sect1" id="javacook-reflection-intro">&#13;
<h1>17.0 Introduction</h1>&#13;
&#13;
<p><a data-primary="reflection" data-type="indexterm" id="ref_ch"/><a data-primary="reflection" data-secondary="in Java" data-type="indexterm" id="idm45290627594856"/><a data-primary="Java" data-secondary="reflection in" data-type="indexterm" id="idm45290627593912"/>The class <code>java.lang.Class</code> and the reflection package <code>java.lang.reflect</code> provide a number of mechanisms for gathering information from the Java Virtual Machine. Known collectively as <em>reflection</em>, these facilities allow you to load classes on the fly, to find methods and fields in classes, to generate listings of them, and to invoke methods on dynamically loaded classes. There is even a mechanism to let you construct a class from scratch (well, actually, from an array of bytes) while your program is running. This is about as close as Java lets you get to the magic, secret internals of the Java machine.</p>&#13;
&#13;
<p>The JVM itself is a large program, normally written in C and/or C++, that implements the Java Virtual Machine abstraction. You can get the source for OpenJDK and other JVMs via the internet, which you could study for months. Here we concentrate on just a few aspects, and only from the point of view of a programmer using the JVM’s facilities, not how it works internally; that is an implementation detail that could vary from one vendor’s JVM to another.</p>&#13;
&#13;
<p>I’ll start with loading an existing class dynamically, move on to listing the fields and methods of a class and invoking methods, and end by creating a class on the fly using a <code>ClassLoader</code>. One of the more interesting aspects of Java, and one that accounts for its flexibility (applets in days of yore, servlets, web services, and other dynamic APIs) while also once being part of its perceived speed problem, is the notion of <em>dynamic loading</em>. For example, even the simplest “Hello, Java” program has to load the class file for your <code>HelloJava</code> class, the class file for its parent (usually <code>java.lang.Object</code>), the class for <code>PrintStream</code> (because you used <code>System.out</code>), the class for <code>PrintStream</code>’s parent, and <code>IOException</code>, and its parent, and so on. To see this in action, try something like this:</p>&#13;
&#13;
<pre data-type="programlisting">java -verbose HelloJava | more</pre>&#13;
&#13;
<p>To take another example, when applets were popular, a browser would download an applet’s bytecode file over the internet and run it on your desktop. How does it load the class file into the running JVM? We discuss this little bit of Java magic in <a data-type="xref" href="#javacook-reflection-SECT-3">Recipe 17.4</a>. The chapter ends with replacement versions of the JDK tools <em>javap</em> and a cross-reference tool that you can use to become a famous Java author by publishing your very own reference to the complete Java API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.1 Getting a Class Descriptor" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-1">&#13;
<h1>17.1 Getting a Class Descriptor</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="classes" data-secondary="reflection and" data-type="indexterm" id="idm45290627579896"/><a data-primary="reflection" data-secondary="class descriptors and" data-type="indexterm" id="idm45290627578920"/>You want to get a <code>Class</code> object from a class name or instance.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>If the type name is known at compile time, you can get the class instance using the compiler keyword <code>.class</code>, which works on any type that is known at compile time, even the eight primitive types.</p>&#13;
&#13;
<p>Otherwise, if you have an object (an instance of a class), you can call the <code class="keep-together">java.lang.Object</code> method <a data-primary="getClass() method" data-type="indexterm" id="idm45290627573432"/><code>getClass()</code>, which returns the <code>Class</code> object for the object’s class (now that was a mouthful!):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Trying the ClassName.class keyword:"</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Object class: "</code> <code class="o">+</code> <code class="n">Object</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"String class: "</code> <code class="o">+</code> <code class="n">String</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"String[] class: "</code> <code class="o">+</code> <code class="n">String</code><code class="o">[].</code><code class="na">class</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Calendar class: "</code> <code class="o">+</code> <code class="n">Calendar</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Current class: "</code> <code class="o">+</code> <code class="n">ClassKeyword</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Class for int: "</code> <code class="o">+</code> <code class="kt">int</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">();</code>&#13;
&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Trying the instance.getClass() method:"</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Sir Robin the Brave"</code><code class="o">.</code><code class="na">getClass</code><code class="o">());</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">Calendar</code><code class="o">.</code><code class="na">getInstance</code><code class="o">().</code><code class="na">getClass</code><code class="o">());</code></pre>&#13;
&#13;
<p>When we run it, we see this:</p>&#13;
<pre data-type="programlisting" id="I_25_tt658">C:\javasrc\reflect&gt;<strong>java  ClassKeyword </strong>&#13;
Trying the ClassName.class keyword:&#13;
Object class: class java.lang.Object&#13;
String class: class java.lang.String&#13;
String[] class: class [Ljava.lang.String;&#13;
Calendar class: class java.util.Calendar&#13;
Current class: class ClassKeyword&#13;
Class for int: int&#13;
&#13;
Trying the instance.getClass( ) method:&#13;
class java.lang.String&#13;
class java.util.GregorianCalendar&#13;
&#13;
C:\javasrc\reflect&gt;</pre>&#13;
&#13;
<p>Nothing fancy, but as you can see, you can get the <code>Class</code> object for almost anything known at compile time, whether it’s part of a package or not.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.2 Finding and Using Methods and Fields" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-2">&#13;
<h1>17.2 Finding and Using Methods and Fields</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-2.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="fields, reflection and" data-type="indexterm" id="fie_ref"/><a data-primary="methods, reflection and" data-type="indexterm" id="met_ref"/><a data-primary="reflection" data-secondary="fields, accessing" data-type="indexterm" id="ref_fie"/><a data-primary="reflection" data-secondary="methods, accessing" data-type="indexterm" id="ref_met"/>You need to find arbitrary method or field names in arbitrary classes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-2.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the reflection package <code>java.lang.reflect</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-2.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>If you just wanted to find fields and methods in one particular class, you wouldn’t need this recipe; you could simply create an instance of the class using <code>new</code> and refer to its fields and methods directly. But this allows you to find methods and fields in any class, even classes that have not yet been written! Given a class object created as in <a data-type="xref" href="#javacook-reflection-SECT-1">Recipe 17.1</a>, you can obtain a list of constructors, a list of methods, or a list of fields. The method <a data-primary="getMethod() method" data-type="indexterm" id="idm45290627440472"/><code>getMethods()</code>  lists the methods available for a given class as an array of <code>Method</code> objects. Similarly, <a data-primary="getFields() method" data-type="indexterm" id="idm45290627439000"/><code>getFields()</code>  returns a list of <code>Field</code> objects. Because constructor methods are treated specially by Java, there is also a <a data-primary="getConstructors() method" data-type="indexterm" id="idm45290627437432"/><code>getConstructors()</code>   method, which returns an array of <code>Constructor</code> objects. Even though <code>Class</code> is in the package <code>java.lang</code>, the <code>Constructor</code>, <code>Method</code>, and <code>Field</code> objects it returns are in <code>java.lang.</code><code class="keep-together">reflect</code>, so you need an import of this package. The <code>ListMethods</code> class (see <a data-type="xref" href="#javacook-reflection-EX-1">Example 17-1</a>) shows how get a list of methods in a class whose name is known at runtime.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-1">&#13;
<h5><span class="label">Example 17-1. </span>main/src/main/java/reflection/ListMethods.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ListMethods</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">ClassNotFoundException</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Usage: ListMethods className"</code><code class="o">);</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]);</code>&#13;
        <code class="n">Constructor</code><code class="o">&lt;?&gt;[]</code> <code class="n">cons</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getConstructors</code><code class="o">();</code>&#13;
        <code class="n">printList</code><code class="o">(</code><code class="s">"Constructors"</code><code class="o">,</code> <code class="n">cons</code><code class="o">);</code>&#13;
        <code class="n">Method</code><code class="o">[]</code> <code class="n">meths</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getMethods</code><code class="o">();</code>&#13;
        <code class="n">printList</code><code class="o">(</code><code class="s">"Methods"</code><code class="o">,</code> <code class="n">meths</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="kd">static</code> <code class="kt">void</code> <code class="nf">printList</code><code class="o">(</code><code class="n">String</code> <code class="n">s</code><code class="o">,</code> <code class="n">Object</code><code class="o">[]</code> <code class="n">o</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"*** "</code> <code class="o">+</code> <code class="n">s</code> <code class="o">+</code> <code class="s">" ***"</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">o</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">o</code><code class="o">[</code><code class="n">i</code><code class="o">].</code><code class="na">toString</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>For example, you could run <a data-type="xref" href="#javacook-reflection-EX-1">Example 17-1</a> on a class like <code>java.lang.String</code> and get a fairly lengthy list of methods; I’ll only show part of the output so you can see what it looks like:</p>&#13;
<pre data-type="programlisting" id="I_25_tt659">&gt; <strong>java reflection.ListMethods java.lang.String</strong>&#13;
*** Constructors ***&#13;
public java.lang.String( )&#13;
public java.lang.String(java.lang.String)&#13;
public java.lang.String(java.lang.StringBuffer)&#13;
public java.lang.String(byte[])&#13;
// and many more...&#13;
*** Methods ***&#13;
public static java.lang.String java.lang.String.copyValueOf(char[])&#13;
public static java.lang.String java.lang.String.copyValueOf(char[],int,int)&#13;
public static java.lang.String java.lang.String.valueOf(char)&#13;
// and more valueOf( ) forms...&#13;
public boolean java.lang.String.equals(java.lang.Object)&#13;
public final native java.lang.Class java.lang.Object.getClass( )&#13;
// and more java.lang.Object methods...&#13;
public char java.lang.String.charAt(int)&#13;
public int java.lang.String.compareTo(java.lang.Object)&#13;
public int java.lang.String.compareTo(java.lang.String)</pre>&#13;
&#13;
<p>You can see that this could be extended (almost literally) to write a <code>BeanMethods</code> class that would list only the set/get methods defined in a JavaBean&#13;
(see <a data-type="xref" href="ch15.html#javacook-packages-SECT-8">Recipe 15.4</a>).</p>&#13;
&#13;
<p>Alternatively, you can find a particular method and invoke it, or find a particular field and refer to its value. Let’s start by finding a given field, because that’s the easiest. <a data-type="xref" href="#javacook-reflection-EX-2">Example 17-2</a> is code that, given an <code>Object</code> and the name of a field, finds the field (gets a <code>Field</code> object) and then retrieves and prints the value of that <code>Field</code> as an <code>int</code>.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-2">&#13;
<h5><span class="label">Example 17-2. </span>main/src/main/java/reflection/FindField.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">FindField</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">unused</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">NoSuchFieldException</code><code class="o">,</code> <code class="n">IllegalAccessException</code> <code class="o">{</code>&#13;
&#13;
        <code class="c1">// Create instance of FindField</code>&#13;
        <code class="n">FindField</code> <code class="n">gf</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FindField</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Create instance of target class (YearHolder defined below).</code>&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="k">new</code> <code class="n">YearHolder</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Use gf to extract a field from o.</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"The value of 'currentYear' is: "</code> <code class="o">+</code>&#13;
            <code class="n">gf</code><code class="o">.</code><code class="na">intFieldValue</code><code class="o">(</code><code class="n">o</code><code class="o">,</code> <code class="s">"currentYear"</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kt">int</code> <code class="nf">intFieldValue</code><code class="o">(</code><code class="n">Object</code> <code class="n">o</code><code class="o">,</code> <code class="n">String</code> <code class="n">name</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">NoSuchFieldException</code><code class="o">,</code> <code class="n">IllegalAccessException</code> <code class="o">{</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="n">o</code><code class="o">.</code><code class="na">getClass</code><code class="o">();</code>&#13;
        <code class="n">Field</code> <code class="n">fld</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getField</code><code class="o">(</code><code class="n">name</code><code class="o">);</code>&#13;
        <code class="kt">int</code> <code class="n">value</code> <code class="o">=</code> <code class="n">fld</code><code class="o">.</code><code class="na">getInt</code><code class="o">(</code><code class="n">o</code><code class="o">);</code>&#13;
        <code class="k">return</code> <code class="n">value</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="cm">/** This is just a class that we want to get a field from */</code>&#13;
<code class="kd">class</code> <code class="nc">YearHolder</code> <code class="o">{</code>&#13;
    <code class="cm">/** Just a field that is used to show getting a field's value. */</code>&#13;
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">currentYear</code> <code class="o">=</code> <code class="n">Calendar</code><code class="o">.</code><code class="na">getInstance</code><code class="o">().</code><code class="na">get</code><code class="o">(</code><code class="n">Calendar</code><code class="o">.</code><code class="na">YEAR</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>What if we need to find a method? The simplest way is to use the methods<a data-primary="getMethod() method" data-type="indexterm" id="idm45290627209032"/> <code class="keep-together">getMethod()</code> and<a data-primary="invoke() method" data-type="indexterm" id="idm45290627207672"/> <code>invoke()</code>. But this is not altogether trivial. Suppose that somebody gives us a reference to an object. We don’t know its class but have been told that it should have this method:</p>&#13;
&#13;
<pre data-type="programlisting">public void work(String s) { }</pre>&#13;
&#13;
<p>We wish to invoke <code>work()</code>. To find the method, we must make an array of <code>Class</code> objects,&#13;
one per item in the parameter list. So, in this case, we make an array containing only a&#13;
reference to the class object for <code>String</code>. Because we know the name of the class at compile&#13;
time, we’ll use the shorter invocation <code>String.class</code> instead of <code>Class.forName()</code>. This,&#13;
plus the name of the method as a string, gets us entry into the <code>getMethod()</code> method of&#13;
the <code>Class</code> object. If this succeeds, we have a <code>Method</code> object. But guess what? In order&#13;
to invoke the method, we have to construct yet another array, this time an array of&#13;
<code class="keep-together">Object</code> references actually containing the data to be passed to the invocation. We also,&#13;
of course, need an instance of the class in whose context the method is to be run. For&#13;
this demonstration class, we need to pass only a single string, because our array consists only&#13;
of the string. <a data-type="xref" href="#javacook-reflection-EX-3">Example 17-3</a> is the code that finds the method and invokes&#13;
it.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-3">&#13;
<h5><span class="label">Example 17-3. </span>main/src/main/java/reflection/GetAndInvokeMethod.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Get a given method, and invoke it.</code>&#13;
<code class="cm"> * @author Ian F. Darwin, http://www.darwinsys.com/</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">GetAndInvokeMethod</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** This class is just here to give us something to work on,</code>&#13;
<code class="cm">     * with a println() call that will prove we got into it.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">static</code> <code class="kd">class</code> <code class="nc">X</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">work</code><code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">,</code> <code class="n">String</code> <code class="n">s</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">printf</code><code class="o">(</code><code class="s">"Called: i=%d, s=%s%n"</code><code class="o">,</code> <code class="n">i</code><code class="o">,</code> <code class="n">s</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="c1">// The main code does not use this overload.</code>&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">work</code><code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Unexpected call!"</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">clX</code> <code class="o">=</code> <code class="n">X</code><code class="o">.</code><code class="na">class</code><code class="o">;</code> <code class="c1">// or Class.forName("X");</code>&#13;
&#13;
            <code class="c1">// To find a method we need the array of matching Class types.</code>&#13;
            <code class="n">Class</code><code class="o">&lt;?&gt;[]</code> <code class="n">argTypes</code> <code class="o">=</code> <code class="o">{</code>&#13;
                <code class="kt">int</code><code class="o">.</code><code class="na">class</code><code class="o">,</code>&#13;
                <code class="n">String</code><code class="o">.</code><code class="na">class</code>&#13;
            <code class="o">};</code>&#13;
&#13;
            <code class="c1">// Now find a Method object for the given method.</code>&#13;
            <code class="n">Method</code> <code class="n">worker</code> <code class="o">=</code> <code class="n">clX</code><code class="o">.</code><code class="na">getMethod</code><code class="o">(</code><code class="s">"work"</code><code class="o">,</code> <code class="n">argTypes</code><code class="o">);</code>&#13;
&#13;
            <code class="c1">// To INVOKE the method, we need the invocation</code>&#13;
            <code class="c1">// arguments, as an Object array.</code>&#13;
            <code class="n">Object</code><code class="o">[]</code> <code class="n">theData</code> <code class="o">=</code> <code class="o">{</code>&#13;
                <code class="mi">42</code><code class="o">,</code>&#13;
                <code class="s">"Chocolate Chips"</code>&#13;
            <code class="o">};</code>&#13;
&#13;
            <code class="c1">// The obvious last step: invoke the method.</code>&#13;
            <code class="c1">// First arg is an instance, null if static method</code>&#13;
            <code class="n">worker</code><code class="o">.</code><code class="na">invoke</code><code class="o">(</code><code class="k">new</code> <code class="n">X</code><code class="o">(),</code> <code class="n">theData</code><code class="o">);</code>&#13;
&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Invoke() failed: "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Not tiny, but it’s still not bad. In most programming languages, you couldn’t do that in the 40 lines it took us here.</p>&#13;
&#13;
<p>A word of caution: when the arguments to a method are of a primitive type, such as <code>int</code>, you do not pass <code>Integer.class</code> into <code>getMethod()</code>. Instead, you must use the class object representing the primitive type <code>int</code>. The easiest way to find this class is in the <code>Integer</code> class, as a public constant named <code>TYPE</code>, so you’d pass <code>Integer.TYPE</code>. The same is true for all the primitive types; for each, the corresponding wrapper <code>class</code> has the primitive <code>class</code>     referred to as <code>TYPE</code>.</p>&#13;
&#13;
<p>Java also includes a mechanism called a <code>MethodHandle</code> that was&#13;
intended both to simplify and to generalize use of Reflection to invoke methods;&#13;
we do not cover it here because in practice it has not shown&#13;
to be a significant improvement over using the Reflection API.<a data-primary="" data-startref="fie_ref" data-type="indexterm" id="idm45290626808200"/><a data-primary="" data-startref="met_ref" data-type="indexterm" id="idm45290626807224"/><a data-primary="" data-startref="ref_fie" data-type="indexterm" id="idm45290626806280"/><a data-primary="" data-startref="ref_met" data-type="indexterm" id="idm45290626805336"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.3 Accessing Private Methods and Fields via Reflection" data-type="sect1"><div class="sect1" id="javacook-reflection-recipe">&#13;
<h1>17.3 Accessing Private Methods and Fields via Reflection</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-recipe.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="reflection" data-secondary="private fields/methods, accessing" data-type="indexterm" id="idm45290626801400"/>You want to access private fields and have heard you can do so using the Reflection API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-recipe.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>It’s generally a bad idea to access private fields. But if you&#13;
have to, and the <code>SecurityManager</code> allows you to use Reflection, you can.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-recipe.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>There is occasionally a need to access private fields in other classes.&#13;
For example, I did so recently in writing a JUnit test case that needed to see all&#13;
the fields of a target class.&#13;
The secret is to call the <code>Field</code> or <code>Method</code> descriptor’s <a data-primary="setAccessible() method" data-type="indexterm" id="idm45290626794504"/><code>setAccessible()</code> method&#13;
passing the value <code>true</code> before trying to get the value or invoke the method.&#13;
It really is that easy, as shown in <a data-type="xref" href="#javacook-reflection-defeatPrivacy">Example 17-4</a>.</p>&#13;
<div data-type="example" id="javacook-reflection-defeatPrivacy">&#13;
<h5><span class="label">Example 17-4. </span>main/src/main/java/reflection/DefeatPrivacy.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">X</code> <code class="o">{</code>&#13;
    <code class="nd">@SuppressWarnings</code><code class="o">(</code><code class="s">"unused"</code><code class="o">)</code> <code class="c1">// Used surreptitiously below.</code>&#13;
    <code class="kd">private</code> <code class="kt">int</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">42</code><code class="o">;</code>&#13;
    <code class="kt">int</code> <code class="n">q</code> <code class="o">=</code> <code class="mi">3</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="cm">/**</code>&#13;
<code class="cm"> * Demonstrate that it is, in fact, all too easy to access private members</code>&#13;
<code class="cm"> * of an object using Reflection, using the default SecurityManager</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">DefeatPrivacy</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">DefeatPrivacy</code><code class="o">().</code><code class="na">process</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">process</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">X</code> <code class="n">x</code> <code class="o">=</code> <code class="k">new</code> <code class="n">X</code><code class="o">();</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">x</code><code class="o">);</code>&#13;
        <code class="c1">// System.out.println(x.p); // Won't compile</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">x</code><code class="o">.</code><code class="na">q</code><code class="o">);</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?</code> <code class="kd">extends</code> <code class="n">X</code><code class="o">&gt;</code> <code class="n">class1</code> <code class="o">=</code> <code class="n">x</code><code class="o">.</code><code class="na">getClass</code><code class="o">();</code>&#13;
        <code class="n">Field</code><code class="o">[]</code> <code class="n">flds</code> <code class="o">=</code> <code class="n">class1</code><code class="o">.</code><code class="na">getDeclaredFields</code><code class="o">();</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">Field</code> <code class="n">f</code> <code class="o">:</code> <code class="n">flds</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">f</code><code class="o">.</code><code class="na">setAccessible</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>    <code class="c1">// bye-bye "private"</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">f</code> <code class="o">+</code> <code class="s">"=="</code> <code class="o">+</code> <code class="n">f</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">x</code><code class="o">));</code>&#13;
            <code class="n">f</code><code class="o">.</code><code class="na">setAccessible</code><code class="o">(</code><code class="kc">false</code><code class="o">);</code>    <code class="c1">// reset to "correct" state</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Use this with <em>extreme care</em>, because it can defeat some of the most cherished principles&#13;
of Java programming.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.4 Loading and Instantiating a Class Dynamically" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-3">&#13;
<h1>17.4 Loading and Instantiating a Class Dynamically</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-3.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="classes" data-secondary="loading/instantiating dynamically" data-type="indexterm" id="cla_lid"/><a data-primary="reflection" data-secondary="classes, loading/instantiating dynamically" data-type="indexterm" id="ref_clid"/>You want to load    classes dynamically, just like web servers load your servlets.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-3.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use <code>class.forName("ClassName");</code> and the class’s <a data-primary="newInstance() method" data-type="indexterm" id="idm45290626569240"/><code>newInstance( )</code>  method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-3.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Suppose you are writing a Java application and want other developers to be able to extend your application by writing Java classes that run in the context of your application. In other words, these developers are, in essence, using Java as an extension language, in the same way that applets are an extension of a web browser. You would probably want to define a small set of methods that these extension programs would have and that you could call for such purposes as initialization, operation, and termination. The best way to do this is, of course, to publish a given, possibly abstract, class that provides those methods and get the developers to subclass from it. Sound familiar? It should. This is just how web browsers such as Netscape allow the deployment of applets.</p>&#13;
&#13;
<p>We’ll leave the thornier issues of security and of loading a class file over a network socket for now and assume that the user can install the classes into the application directory or into a directory that appears in the <code>CLASSPATH</code> at the time the program is run. First, let’s define our class. We’ll call it <code>Cooklet</code> (see <a data-type="xref" href="#javacook-reflection-EX-4">Example 17-5</a>) to avoid infringing on the overused word <em>applet</em>. Pretend each subclass will represent the code to drive some elaborate kind of food-preparing-and-cooking appliance through the steps of one traditional recipe. And we’ll initially take the easiest path from ingredients to cookies before we complicate it.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-4">&#13;
<h5><span class="label">Example 17-5. </span>Cooklet.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/** A simple class, just to provide the list of methods that</code>&#13;
<code class="cm"> * users need to provide to be usable in our application.</code>&#13;
<code class="cm"> * Note that the class is abstract so you must subclass it,</code>&#13;
<code class="cm"> * but the methods are non-abstract so you don't have to provide</code>&#13;
<code class="cm"> * dummy versions if you don't need a particular functionality.</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">abstract</code> <code class="kd">class</code> <code class="nc">Cooklet</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** The initialization method. The Cookie application will</code>&#13;
<code class="cm">     * call you here (AFTER calling your no-argument constructor)</code>&#13;
<code class="cm">     * to allow you to initialize your code</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">initialize</code><code class="o">(</code> <code class="o">)</code> <code class="o">{</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** The work method. The cookie application will call you</code>&#13;
<code class="cm">     * here when it is time for you to start cooking.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">work</code><code class="o">(</code> <code class="o">)</code> <code class="o">{</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** The termination method. The cookie application will call you</code>&#13;
<code class="cm">     * here when it is time for you to stop cooking and shut down</code>&#13;
<code class="cm">     * in an orderly fashion.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">terminate</code><code class="o">(</code> <code class="o">)</code> <code class="o">{</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Now, because we’ll be baking, er, making this available to other people, we’ll probably want to cook up  a demonstration version too; see <a data-type="xref" href="#javacook-reflection-EX-5">Example 17-6</a>.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-5">&#13;
<h5><span class="label">Example 17-6. </span>main/src/main/java/reflection/DemoCooklet.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DemoCooklet</code> <code class="kd">extends</code> <code class="n">Cooklet</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">work</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"I am busy baking cookies."</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">terminate</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"I am shutting down my ovens now."</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>But how  does our application use it? Once we have the name of the user’s class, we need to create a <code>Class</code> object for that class. This can be done easily using the static method <code>Class.forName()</code>. Then we can create an instance of it using the <code>Class</code> object’s <a data-primary="newInstance() method" data-type="indexterm" id="idm45290626468744"/><code class="keep-together">newInstance()</code> method; this calls the class’s no-argument constructor. Then we simply cast the newly constructed object to our <code>Cooklet</code> class, and we can call its methods! It actually takes longer to describe this code than to look at the code, so let’s do that now; see <a data-type="xref" href="#javacook-reflection-EX-6">Example 17-7</a>.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-6">&#13;
<h5><span class="label">Example 17-7. </span>main/src/main/java/reflection/Cookies.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Cookies</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Cookies Application Version 0.0"</code><code class="o">);</code>&#13;
        <code class="n">Cooklet</code> <code class="n">cooklet</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
        <code class="n">String</code> <code class="n">cookletClassName</code> <code class="o">=</code> <code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">];</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Class</code><code class="o">&lt;</code><code class="n">Cooklet</code><code class="o">&gt;</code> <code class="n">cookletClass</code> <code class="o">=</code>&#13;
                <code class="o">(</code><code class="n">Class</code><code class="o">&lt;</code><code class="n">Cooklet</code><code class="o">&gt;)</code> <code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">cookletClassName</code><code class="o">);</code>&#13;
            <code class="n">cooklet</code> <code class="o">=</code> <code class="n">cookletClass</code><code class="o">.</code><code class="na">newInstance</code><code class="o">();</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Error "</code> <code class="o">+</code> <code class="n">cookletClassName</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">cooklet</code><code class="o">.</code><code class="na">initialize</code><code class="o">();</code>&#13;
        <code class="n">cooklet</code><code class="o">.</code><code class="na">work</code><code class="o">();</code>&#13;
        <code class="n">cooklet</code><code class="o">.</code><code class="na">terminate</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>And if we run it?</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">$</code> <code class="n">java</code> <code class="n">Cookies</code> <code class="n">DemoCooklet</code>&#13;
<code class="n">Cookies</code> <code class="n">Application</code> <code class="n">Version</code> <code class="mf">0.0</code>&#13;
<code class="n">I</code> <code class="n">am</code> <code class="n">busy</code> <code class="n">baking</code> <code class="n">cookies</code><code class="o">.</code>&#13;
<code class="n">I</code> <code class="n">am</code> <code class="n">shutting</code> <code class="n">down</code> <code class="n">my</code> <code class="n">ovens</code> <code class="n">now</code><code class="o">.</code>&#13;
<code class="n">$</code></pre>&#13;
&#13;
<p>Of course, this version has rather limited error handling. But you already know how to fix that. Your <code>ClassLoader</code> can also place classes into a package by constructing a <code>Package</code> object; you should do this if loading any medium-sized set of application    classes.<a data-primary="" data-startref="cla_lid" data-type="indexterm" id="idm45290626228056"/><a data-primary="" data-startref="ref_clid" data-type="indexterm" id="idm45290626227208"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.5 Constructing a Class from Scratch with a ClassLoader" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-4">&#13;
<h1>17.5 Constructing a Class from Scratch with a ClassLoader</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-4.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="classes" data-secondary="ClassLoader, constructing with" data-type="indexterm" id="cla_clc"/><a data-primary="ClassLoader" data-type="indexterm" id="cla_ab"/><a data-primary="reflection" data-secondary="ClassLoader and" data-type="indexterm" id="ref_cl"/>You need to load a class from a nonstandard location and run its methods.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-4.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Examine the existing loaders such as <code>java.net.URLClassLoader</code>. If none is suitable,&#13;
write and use your own <code>ClassLoader</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-4.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>A <code>ClassLoader</code>, of course, is a program that loads classes. One <code>ClassLoader</code> is built into the Java Virtual Machine, but your application can create others as needed. Learning to write and run a working <code>ClassLoader</code> and using it to load a class and run its methods is a nontrivial exercise. In fact, you rarely need to write a <code>ClassLoader</code>, but knowing how is helpful in understanding how the JVM finds classes, creates objects, and calls <span class="keep-together">methods</span>.</p>&#13;
&#13;
<p><code>ClassLoader</code> itself is abstract; you must subclass it, presumably providing a <code>loadClass()</code>  method that loads classes as you wish. It can load the bytes from a network connection, a local disk, RAM, a serial port, or anywhere else. Or you can construct the class file in memory yourself, if you have access to a compiler.</p>&#13;
&#13;
<p>There is a general-purpose loader called <code>java.net.URLClassLoader</code> that can be used if all you need&#13;
is to load classes via the web protocol (or, more generally, from one or more URLs).</p>&#13;
&#13;
<p>You must call the <code>ClassLoader</code> <a data-primary="loadClass() method" data-type="indexterm" id="idm45290626208808"/><code>loadClass()</code> method for any classes you wish to explicitly load from it.&#13;
Note that this method is called to load all classes required for classes you load (superclasses that&#13;
aren’t already loaded, for example).&#13;
However, the JVM still loads classes that you instantiate with the <code>new</code> operator normally via <span class="keep-together">classpath.</span></p>&#13;
&#13;
<p>When writing a <code>ClassLoader</code>, your <code>loadClass()</code> method needs to get the class file into a byte array (typically by reading it), convert the array into a <code>Class</code> object, and return the result.</p>&#13;
&#13;
<p>What? That sounds a bit like “And Then a Miracle Occurs…” And it is. The miracle of class creation, however, happens down inside the JVM, where you don’t have access to it. Instead, your <code>ClassLoader</code> has to call the <code>protected defineClass()</code>  method in your superclass (which is <code>java.lang.ClassLoader</code>). This is illustrated in <a data-type="xref" href="#javacook-reflection-FIG-1">Figure 17-1</a>, where a stream of bytes containing a hypothetical <code>Chicken</code> class is converted into a ready-to-run <code>Chicken</code> class in the JVM by calling the<a data-primary="defineClass() method" data-type="indexterm" id="idm45290626200536"/> <code>defineClass()</code> method.</p>&#13;
&#13;
<figure><div class="figure" id="javacook-reflection-FIG-1">&#13;
<img alt="jcb4 1701" src="assets/jcb4_1701.png"/>&#13;
<h6><span class="label">Figure 17-1. </span>ClassLoader in action</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What next?" data-type="sect3"><div class="sect3" id="javacook-reflection-SECT-4.3.1">&#13;
<h3>What next?</h3>&#13;
&#13;
<p>To use your <code>ClassLoader</code> subclass, you need to instantiate it and call its <code>loadClass()</code> method with the name of the class you want to load. This gives you a <code>Class</code> object for the named class; the <code>Class</code> object in turn lets you construct instances, find and call methods, etc. Refer back to <a data-type="xref" href="#javacook-reflection-SECT-2">Recipe 17.2</a>.<a data-primary="" data-startref="cla_clc" data-type="indexterm" id="idm45290626139304"/><a data-primary="" data-startref="cla_ab" data-type="indexterm" id="idm45290626138328"/><a data-primary="" data-startref="ref_cl" data-type="indexterm" id="idm45290626137384"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.6 Constructing a Class from Scratch with JavaCompiler" data-type="sect1"><div class="sect1" id="javacook-reflection-javacompiler">&#13;
<h1>17.6 Constructing a Class from Scratch with JavaCompiler</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45290626135080">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="classes" data-secondary="JavaCompiler, constructing with" data-type="indexterm" id="cla_jcc"/><a data-primary="JavaCompiler" data-type="indexterm" id="jc_ab"/><a data-primary="reflection" data-secondary="JavaCompiler" data-type="indexterm" id="ref_jc"/>You’d rather construct a class dynamically by generating source code and compiling it.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45290626129976">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>JavaCompiler</code> from <code>javax.tools</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45290626127528">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>There are many cases where you might need to generate code on the fly.&#13;
If you’re writing a framework, you might want to introspect on a model class to find its fields,&#13;
and generate accessors for them on the fly.&#13;
As we’ve seen in <a data-type="xref" href="#javacook-reflection-SECT-2">Recipe 17.2</a>, you can do this with the <code>Field</code> class.&#13;
However, for a high-volume operation it may well be more efficient to generate direct access code.</p>&#13;
&#13;
<p>The Java Compiler API has been around since Java 1.6 and is fairly easy to use for simple cases.&#13;
Here are the basic steps:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Get the <code>JavaCompiler</code> object for your current Java Runtime. If it’s not available,&#13;
either give up altogether, or fall back to using reflection.</p>&#13;
</li>&#13;
<li>&#13;
<p>Get a <code>CompilerTask</code> (which is also a <code>Callable</code>) to run the compilation, passing input and outputs.</p>&#13;
</li>&#13;
<li>&#13;
<p>Invoke the <code>Callable</code>, either directly or by using an <code>ExecutorService</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Check the results. If true, invoke the class.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>This is demonstrated in <a data-type="xref" href="#javacook-reflection-EX-javacompilerdemo">Example 17-8</a>.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-javacompilerdemo">&#13;
<h5><span class="label">Example 17-8. </span>main/src/main/java/reflection/JavaCompilerDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code><code> </code><code class="n">reflection</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">java.lang.reflect.Method</code><code class="o">;</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">java.net.URI</code><code class="o">;</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">java.util.List</code><code class="o">;</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">java.util.concurrent.Callable</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// tag::main[]&#13;
</code><code class="kn">import</code><code> </code><code class="nn">javax.tools.JavaCompiler</code><code class="o">;</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">javax.tools.SimpleJavaFileObject</code><code class="o">;</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">javax.tools.ToolProvider</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code class="cm">/** Demo the Java Compiler API: Create a class, compile, load, and run it.&#13;
 * N.B. Will not run under Eclipse due to classpath settings;&#13;
 * best run it standalone using "java JavaCompiler.java"&#13;
 * @author Ian Darwin&#13;
 */</code><code>&#13;
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">JavaCompilerDemo</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">final</code><code> </code><code class="kd">static</code><code> </code><code class="n">String</code><code> </code><code class="n">PACKAGE</code><code> </code><code class="o">=</code><code> </code><code class="s">"reflection"</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">final</code><code> </code><code class="kd">static</code><code> </code><code class="n">String</code><code> </code><code class="n">CLASS</code><code> </code><code class="o">=</code><code> </code><code class="s">"AnotherDemo"</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">static</code><code> </code><code class="kt">boolean</code><code> </code><code class="n">verbose</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="kt">void</code><code> </code><code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">args</code><code class="o">)</code><code> </code><code class="kd">throws</code><code> </code><code class="n">Exception</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">String</code><code> </code><code class="n">source</code><code> </code><code class="o">=</code><code> </code><code class="s">"package "</code><code> </code><code class="o">+</code><code> </code><code class="n">PACKAGE</code><code> </code><code class="o">+</code><code> </code><code class="s">";\n"</code><code> </code><code class="o">+</code><code>                  </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-1" id="co_reflection__or__a_class_named_class__CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>            </code><code class="s">"public class "</code><code> </code><code class="o">+</code><code> </code><code class="n">CLASS</code><code> </code><code class="o">+</code><code> </code><code class="s">" {\n"</code><code> </code><code class="o">+</code><code>&#13;
</code><code>            </code><code class="s">"\tpublic static void main(String[] args) {\n"</code><code> </code><code class="o">+</code><code>&#13;
</code><code>            </code><code class="s">"\t\tString message = (args.length &gt; 0 ? args[0] : \"Hi\")"</code><code> </code><code class="o">+</code><code> </code><code class="s">";\n"</code><code> </code><code class="o">+</code><code>&#13;
</code><code>            </code><code class="s">"\t\tSystem.out.println(message + \" from AnotherDemo\");\n"</code><code> </code><code class="o">+</code><code>&#13;
</code><code>            </code><code class="s">"\t}\n}\n"</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">verbose</code><code class="o">)</code><code>&#13;
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"Source to be compiled:\n"</code><code> </code><code class="o">+</code><code> </code><code class="n">source</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>&#13;
</code><code>        </code><code class="n">JavaCompiler</code><code> </code><code class="n">compiler</code><code> </code><code class="o">=</code><code> </code><code class="n">ToolProvider</code><code class="o">.</code><code class="na">getSystemJavaCompiler</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>   </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-2" id="co_reflection__or__a_class_named_class__CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">compiler</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="kc">null</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>            </code><code class="k">throw</code><code> </code><code class="k">new</code><code> </code><code class="nf">IllegalStateException</code><code class="o">(</code><code class="s">"No default compiler, giving up."</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="o">}</code><code>&#13;
</code><code>        </code><code class="n">Callable</code><code class="o">&lt;</code><code class="n">Boolean</code><code class="o">&gt;</code><code> </code><code class="n">compilation</code><code> </code><code class="o">=</code><code>&#13;
</code><code>            </code><code class="n">compiler</code><code class="o">.</code><code class="na">getTask</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">,</code><code> </code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"-d"</code><code class="o">,</code><code class="s">"."</code><code class="o">)</code><code class="o">,</code><code> </code><code class="kc">null</code><code class="o">,</code><code> </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-3" id="co_reflection__or__a_class_named_class__CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>            </code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="k">new</code><code> </code><code class="n">MySource</code><code class="o">(</code><code class="n">CLASS</code><code class="o">,</code><code> </code><code class="n">source</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="kt">boolean</code><code> </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">compilation</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>                            </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-4" id="co_reflection__or__a_class_named_class__CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">result</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Compiled OK"</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="n">Class</code><code class="o">&lt;</code><code class="o">?</code><code class="o">&gt;</code><code> </code><code class="n">c</code><code> </code><code class="o">=</code><code> </code><code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">PACKAGE</code><code> </code><code class="o">+</code><code> </code><code class="s">"."</code><code> </code><code class="o">+</code><code> </code><code class="n">CLASS</code><code class="o">)</code><code class="o">;</code><code>          </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-5" id="co_reflection__or__a_class_named_class__CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Class = "</code><code> </code><code class="o">+</code><code> </code><code class="n">c</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="n">Method</code><code> </code><code class="n">m</code><code> </code><code class="o">=</code><code> </code><code class="n">c</code><code class="o">.</code><code class="na">getMethod</code><code class="o">(</code><code class="s">"main"</code><code class="o">,</code><code> </code><code class="n">args</code><code class="o">.</code><code class="na">getClass</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>            </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-6" id="co_reflection__or__a_class_named_class__CO1-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Method descriptor = "</code><code> </code><code class="o">+</code><code> </code><code class="n">m</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="n">Object</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">passedArgs</code><code> </code><code class="o">=</code><code> </code><code class="o">{</code><code> </code><code class="n">args</code><code> </code><code class="o">}</code><code class="o">;</code><code>&#13;
</code><code>            </code><code class="n">m</code><code class="o">.</code><code class="na">invoke</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code><code> </code><code class="n">passedArgs</code><code class="o">)</code><code class="o">;</code><code>                                 </code><a class="co" href="#callout_reflection__or__a_class_named_class__CO1-7" id="co_reflection__or__a_class_named_class__CO1-7"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>        </code><code class="o">}</code><code> </code><code class="k">else</code><code> </code><code class="o">{</code><code>&#13;
</code><code>            </code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Compilation failed"</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="o">}</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code><code>&#13;
</code><code class="c1">// end::main[]&#13;
</code><code>&#13;
</code><code class="kd">class</code><code> </code><code class="nc">MySource</code><code> </code><code class="kd">extends</code><code> </code><code class="n">SimpleJavaFileObject</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="kd">final</code><code> </code><code class="n">String</code><code> </code><code class="n">source</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="n">MySource</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">fileName</code><code class="o">,</code><code> </code><code class="n">String</code><code> </code><code class="n">source</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="kd">super</code><code class="o">(</code><code class="n">URI</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="s">"string:///"</code><code> </code><code class="o">+</code><code> </code><code class="n">fileName</code><code class="o">.</code><code class="na">replace</code><code class="o">(</code><code class="sc">'.'</code><code class="o">,</code><code> </code><code class="sc">'/'</code><code class="o">)</code><code> </code><code class="o">+</code><code>&#13;
</code><code>                </code><code class="n">Kind</code><code class="o">.</code><code class="na">SOURCE</code><code class="o">.</code><code class="na">extension</code><code class="o">)</code><code class="o">,</code><code> </code><code class="n">Kind</code><code class="o">.</code><code class="na">SOURCE</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">source</code><code> </code><code class="o">=</code><code> </code><code class="n">source</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>    </code><code class="nd">@Override</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">CharSequence</code><code> </code><code class="nf">getCharContent</code><code class="o">(</code><code class="kt">boolean</code><code> </code><code class="n">ignoreEncodingErrors</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">source</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-1" id="callout_reflection__or__a_class_named_class__CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The source code that we want to compile. In real life it would probably be dynamically generated,&#13;
maybe using a <code>StringBuffer</code>.</p></dd>&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-2" id="callout_reflection__or__a_class_named_class__CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Get a reference to the default <code>JavaCompiler</code> object.</p></dd>&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-3" id="callout_reflection__or__a_class_named_class__CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Ask the compiler to create a <code>CompilerTask</code> to do the compilation.&#13;
<code>CompilerTask</code> is also <code>Callable</code> and we save it under that type.&#13;
The <code>-d</code> and <code>.</code> are standard <em>javac</em> arguments.&#13;
<code>MySource</code> extends the compiler-provided API class <code>SimpleJavaFileObject</code> to&#13;
give access to a file by creating a <em>file://</em> URL.</p></dd>&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-4" id="callout_reflection__or__a_class_named_class__CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>A <code>Callable</code> can be put into a thread pool (<code>ExecutorService</code>) (see <a data-type="xref" href="ch16.html#javacook-threads-SECT-1">Recipe 16.1</a>);&#13;
we don’t need this capability but the Compiler API returns it. We invoke the <code>Callable</code> directly.</p></dd>&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-5" id="callout_reflection__or__a_class_named_class__CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Assuming the <code>result</code> was <code>true</code> indicating success, we load the class with <code>Class.forName()</code>.</p></dd>&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-6" id="callout_reflection__or__a_class_named_class__CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>We have to find the <a data-primary="main() method" data-type="indexterm" id="idm45290625693672"/><code>main()</code> method in the generated class.&#13;
We reuse the <code>String[].class</code> type from args, since all <code>main</code> methods have the same argument.</p></dd>&#13;
<dt><a class="co" href="#co_reflection__or__a_class_named_class__CO1-7" id="callout_reflection__or__a_class_named_class__CO1-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Finally, we can invoke the <code>main</code> method, reusing the incoming <code>args</code> array&#13;
to pass any <em>welcome</em> message along.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Running this program with and without an argument shows that the argument passed&#13;
to the <code>JavaCompilerDemo</code> is being passed correctly to the generated <code>AnotherDemo</code> class:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">$</code> <code class="n">java</code> <code class="n">src</code><code class="o">/</code><code class="n">main</code><code class="o">/</code><code class="n">java</code><code class="o">/</code><code class="n">reflection</code><code class="o">/</code><code class="n">JavaCompilerDemo</code><code class="o">.</code><code class="na">java</code>&#13;
<code class="n">Compiled</code> <code class="n">OK</code>&#13;
<code class="n">Class</code> <code class="o">=</code> <code class="kd">class</code> <code class="nc">reflection</code><code class="o">.</code><code class="na">AnotherDemo</code>&#13;
<code class="n">Method</code> <code class="n">descriptor</code> <code class="o">=</code> <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code>&#13;
  <code class="n">reflection</code><code class="o">.</code><code class="na">AnotherDemo</code><code class="o">.</code><code class="na">main</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">String</code><code class="o">[])</code>&#13;
<code class="n">Hi</code> <code class="n">from</code> <code class="n">AnotherDemo</code>&#13;
<code class="n">$</code> <code class="n">java</code> <code class="n">src</code><code class="o">/</code><code class="n">main</code><code class="o">/</code><code class="n">java</code><code class="o">/</code><code class="n">reflection</code><code class="o">/</code><code class="n">JavaCompilerDemo</code><code class="o">.</code><code class="na">java</code> <code class="n">Welcome</code>&#13;
<code class="n">Compiled</code> <code class="n">OK</code>&#13;
<code class="n">Class</code> <code class="o">=</code> <code class="kd">class</code> <code class="nc">reflection</code><code class="o">.</code><code class="na">AnotherDemo</code>&#13;
<code class="n">Method</code> <code class="n">descriptor</code> <code class="o">=</code> <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code>&#13;
  <code class="n">reflection</code><code class="o">.</code><code class="na">AnotherDemo</code><code class="o">.</code><code class="na">main</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">String</code><code class="o">[])</code>&#13;
<code class="n">Welcome</code> <code class="n">from</code> <code class="n">AnotherDemo</code>&#13;
<code class="n">$</code></pre>&#13;
&#13;
<p>There is a lot to explore in the Compiler API, including the <code>JavaFileManager</code> that lets you&#13;
control the placement of class files (other than by using <code>-d</code> as we did here),&#13;
listeners to monitor compilation, and control of output and error streams.&#13;
Consult the <code>javax.tools.JavaCompiler</code> <a href="https://docs.oracle.com/javase/8/docs/api/javax/tools/JavaCompiler.html">documentation</a> for details.<a data-primary="" data-startref="cla_jcc" data-type="indexterm" id="idm45290626014424"/><a data-primary="" data-startref="jc_ab" data-type="indexterm" id="idm45290626013448"/><a data-primary="" data-startref="ref_jc" data-type="indexterm" id="idm45290626012504"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.7 Performance Timing" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-5">&#13;
<h1>17.7 Performance Timing</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-5.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="performance timing" data-type="indexterm" id="pt_ab"/><a data-primary="reflection" data-secondary="performance timing" data-type="indexterm" id="ref_pt"/>Slow performance?</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-5.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a<a data-primary="profiler" data-type="indexterm" id="idm45290626004616"/> <em>profiler</em>, or time individual methods using&#13;
<code>System.currentTimeMillis()</code> before and after invoking the target method;&#13;
the difference is the time that method took.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-5.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Profilers" data-type="sect3"><div class="sect3" id="idm45290626093960">&#13;
<h3>Profilers</h3>&#13;
&#13;
<p>Profiling tools—profilers—have a long history as one of the important tools in a programmer’s toolkit.&#13;
A commercial profiling tool will help find bottlenecks in your program by showing both the number&#13;
of times each method was called and the amount of time in each.</p>&#13;
&#13;
<p>Quite a bit of useful information can be obtained from a Java application by&#13;
use of the <code>VisualVM</code> tool, which was part of the Oracle JDK up until Java 8.&#13;
With Java 9 this tool was open-sourced, and it’s now available from the<a data-primary="VisualVM project" data-type="indexterm" id="idm45290626091224"/>&#13;
<a href="https://visualvm.github.io/index.html">VisualVM project</a>.</p>&#13;
&#13;
<p>Another tool that is part of the JDK is<a data-primary="Java Flight Recorder" data-type="indexterm" id="idm45290626089240"/>&#13;
<a href="https://en.wikipedia.org/wiki/JDK_Flight_Recorder">Java Flight Recorder</a>,&#13;
which is now open-sourced and built into the JDK.&#13;
Its data is meant to be analyzed by<a data-primary="Java Mission Control" data-type="indexterm" id="idm45290626087688"/>&#13;
<a href="https://en.wikipedia.org/wiki/JDK_Mission_Control">Java Mission Control</a>.&#13;
There are also third-party profilers that will give more detailed information;&#13;
a web search will find current commercial offerings.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Measuring a single method" data-type="sect3"><div class="sect3" id="idm45290626085736">&#13;
<h3>Measuring a single method</h3>&#13;
&#13;
<p>The simplest technique is to save the JVM’s accumulated time before and after dynamically loading a main program and then calculate the difference between those times. Code to do just this is presented in <a data-type="xref" href="#javacook-reflection-EX-7">Example 17-11</a>; for now, just remember that we have a way of timing a given Java class.</p>&#13;
&#13;
<p>One way of measuring the efficiency of a particular operation is to run it many times in isolation. The overall time the program takes to run thus approximates the total time of many invocations of the same operation. Gross numbers like this can be compared if you want to know which of two ways of doing something is more efficient. Consider the case of string concatenation versus<a data-primary="println() method" data-type="indexterm" id="idm45290626082088"/> <code>println()</code>. The code</p>&#13;
&#13;
<pre data-type="programlisting">println("Time is " + n.toString( ) + " seconds");</pre>&#13;
&#13;
<p>will probably work by creating a <code>StringBuilder</code>; appending the string <code>"Time is"</code>, the&#13;
value of <code>n</code> as a string, and <code>"seconds"</code>; and finally converting the finished&#13;
<code class="keep-together">StringBuilder</code> to a <code>String</code> and passing that to <code>println()</code>. Suppose you have a program&#13;
that does a lot of this, such as a Java servlet that creates a lot of HTML this way, and&#13;
you expect (or at least hope) your website to be sufficiently busy so that doing this&#13;
efficiently will make a difference.  There are two ways of thinking about this:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Theory A: this string concatenation is inefficient.</p>&#13;
</li>&#13;
<li>&#13;
<p>Theory B: string concatenation doesn’t matter; <code>println()</code> is inefficient, too.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>A proponent of Theory A might say that because <code>println()</code> just puts stuff into a buffer,&#13;
it is very fast and that string concatenation is the expensive part.</p>&#13;
&#13;
<p>How to decide between Theory A and Theory B? Assume you are willing to write a simple test&#13;
program that tests both theories.  Let’s just write a simple program both ways and time it.&#13;
<a data-type="xref" href="#stringprintA">Example 17-9</a> is the timing program for Theory A.</p>&#13;
<div data-type="example" id="stringprintA">&#13;
<h5><span class="label">Example 17-9. </span>main/src/main/java/performance/StringPrintA.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StringPrintA</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="s">"Hello World"</code><code class="o">;</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100000</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;p&gt;&lt;b&gt;"</code> <code class="o">+</code> <code class="n">o</code><code class="o">.</code><code class="na">toString</code><code class="o">()</code> <code class="o">+</code> <code class="s">"&lt;/b&gt;&lt;/p&gt;"</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><code>StringPrintAA</code> (in the <em>javasrc</em> repo but not printed here) is the same but&#13;
explicitly uses a <code>StringBuilder</code> for the string&#13;
concatenation. <a data-type="xref" href="#stringprintb">Example 17-10</a> is the tester for Theory B.</p>&#13;
<div data-type="example" id="stringprintb">&#13;
<h5><span class="label">Example 17-10. </span>main/src/main/java/performance/StringPrintB.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StringPrintB</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="s">"Hello World"</code><code class="o">;</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100000</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"&lt;p&gt;&lt;b&gt;"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">o</code><code class="o">.</code><code class="na">toString</code><code class="o">());</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="s">"&lt;/b&gt;&lt;/p&gt;"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Timing results" data-type="sect3"><div class="sect3" id="javacook-reflection-SECT-5.3.1">&#13;
<h3>Timing results</h3>&#13;
&#13;
<p>I ran <code>StringPrintA</code>, <code>StringPrintAA</code>, and <code>StringPrintB</code> twice each on the same computer.&#13;
To eliminate JVM startup times, I ran them from a program called <code>TimeNoArgs</code>, which&#13;
takes a class name and invokes its<a data-primary="main() method" data-type="indexterm" id="idm45290625195272"/> <code>main()</code> method, using the Reflection API.&#13;
<code>TimeNoArgs</code> and a shell script to run it, <em>stringprinttimer.sh</em>, are in the <em>performance</em>&#13;
folder of the <em>javasrc</em> source repository.  Here are the results:</p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th>2004 program</th>&#13;
<th>Seconds</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>StringPrintA</code></p></td>&#13;
<td><p>17.23, 17.20 seconds</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>StringPrintAA</code></p></td>&#13;
<td><p>17.23, 17.23 seconds</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>StringPrintB</code></p></td>&#13;
<td><p>27.59, 27.60 seconds</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th>2014 program</th>&#13;
<th>Seconds</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>StringPrintA</code></p></td>&#13;
<td><p>0.714, 0.525 seconds</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>StringPrintAA</code></p></td>&#13;
<td><p>0.616, 0.561 seconds</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>StringPrintB</code></p></td>&#13;
<td><p>1.091, 1.039 seconds</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>Although the times went down by a factor of roughly 20 over a decade due to both JVM improvements and faster hardware,&#13;
the ratios remain remarkably consistent: <code>StringPrintB</code>, which calls <a data-primary="print() method" data-type="indexterm" id="idm45290625175832"/><a data-primary="println() method" data-type="indexterm" id="idm45290625175096"/><code>print()</code> and <code>println()</code>&#13;
multiple times, takes roughly twice as long.</p>&#13;
&#13;
<p>Moral: don’t guess. If it matters, time it.</p>&#13;
&#13;
<p>Another moral: multiple calls to <code>System.out.print()</code> cost more than the same number of&#13;
calls to a <code>StringBuilder</code>’s<a data-primary="append() methods" data-type="indexterm" id="idm45290625171576"/> <code>append()</code> method, by a factor of roughly 1.5 (or 150%).&#13;
Theory B wins; the extra <code>println</code> calls appear to save a string concatenation but make&#13;
the program take substantially longer.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other aspects of performance: GC" data-type="sect3"><div class="sect3" id="idm45290625169768">&#13;
<h3>Other aspects of performance: GC</h3>&#13;
&#13;
<p>There are many other aspects of software performance. One that is fundamental <span class="keep-together">to Java</span> is garbage collection behavior. Sun/Oracle usually discusses this at JavaOne. For example, see the 2003 JavaOne presentation<a data-primary="Garbage Collection in the Java HotSpot Virtual Machine paper" data-type="indexterm" id="idm45290625167416"/> <a href="http://www.oracle.com/technetwork/java/javase/tech/ts-3153-coomes-19899-dsf-150093.pdf">“Garbage Collection in the Java HotSpot Virtual Machine”</a>. See also the 2007 JavaOne talk by the same GC development team,<a data-primary="Garbage-Collection-Friendly Programming, TS-2906" data-type="indexterm" id="idm45290625165960"/><a data-primary="The Garbage Collection MythBusters presentation" data-primary-sortas="garbage" data-type="indexterm" id="idm45290625165192"/> <a href="https://docs.huihoo.com/javaone/2007/java-se/TS-2906.pdf">“Garbage Collection-Friendly Programming,” TS-2906</a>. JavaOne 2010 featured an updated presentation entitled <a href="https://oreil.ly/java-world-the-garbage-collection-mythbusters">“The Garbage Collection MythBusters”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A timing program" data-type="sect3"><div class="sect3" id="javacook-reflection-SECT-5.3.2">&#13;
<h3>A timing program</h3>&#13;
&#13;
<p>It’s pretty easy to build a simplified <code>time</code> command in Java, given that you have <code class="keep-together">System.currentTimeMillis()</code> to start with. Run my <code>Time</code> program, and, on the command line, specify the name of the class to be timed, followed by the arguments (if any) that class needs for running. The program is shown in <a data-type="xref" href="#javacook-reflection-EX-7">Example 17-11</a>. The time that the class took is displayed. But remember that <code>System.currentTimeMillis()</code> returns clock time, not necessarily CPU time. So you must run it on a machine that isn’t running a lot of background processes. And note also that I use dynamic loading (see <a data-type="xref" href="#javacook-reflection-SECT-3">Recipe 17.4</a>) to let you put the Java class name on the command line.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-7">&#13;
<h5><span class="label">Example 17-11. </span>main/src/main/java/performance/Time.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Time</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="c1">// Instantiate target class, from argv[0]</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">argv</code><code class="o">[</code><code class="mi">0</code><code class="o">]);</code>&#13;
&#13;
        <code class="c1">// Find its static main method (use our own argv as the signature).</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?&gt;[]</code> <code class="n">classes</code> <code class="o">=</code> <code class="o">{</code> <code class="n">argv</code><code class="o">.</code><code class="na">getClass</code><code class="o">()</code> <code class="o">};</code>&#13;
        <code class="n">Method</code> <code class="n">main</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getMethod</code><code class="o">(</code><code class="s">"main"</code><code class="o">,</code> <code class="n">classes</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Make new argv array, dropping class name from front.</code>&#13;
        <code class="c1">// Normally Java doesn't get the class name, but in</code>&#13;
        <code class="c1">// this case the user puts the name of the class to time</code>&#13;
        <code class="c1">// as well as all its arguments...</code>&#13;
        <code class="n">String</code> <code class="n">nargv</code><code class="o">[]</code> <code class="o">=</code> <code class="k">new</code> <code class="n">String</code><code class="o">[</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">-</code> <code class="mi">1</code><code class="o">];</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">arraycopy</code><code class="o">(</code><code class="n">argv</code><code class="o">,</code> <code class="mi">1</code><code class="o">,</code> <code class="n">nargv</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">nargv</code><code class="o">.</code><code class="na">length</code><code class="o">);</code>&#13;
&#13;
        <code class="n">Object</code><code class="o">[]</code> <code class="n">nargs</code> <code class="o">=</code> <code class="o">{</code> <code class="n">nargv</code> <code class="o">};</code>&#13;
&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Starting class "</code> <code class="o">+</code> <code class="n">c</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// About to start timing run. Important to not do anything</code>&#13;
        <code class="c1">// (even a println) that would be attributed to the program</code>&#13;
        <code class="c1">// being timed, from here until we've gotten ending time.</code>&#13;
&#13;
        <code class="c1">// Get current (i.e., starting) time</code>&#13;
        <code class="kt">long</code> <code class="n">t0</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">currentTimeMillis</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Run the main program</code>&#13;
        <code class="n">main</code><code class="o">.</code><code class="na">invoke</code><code class="o">(</code><code class="kc">null</code><code class="o">,</code> <code class="n">nargs</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Get ending time, and compute usage</code>&#13;
        <code class="kt">long</code> <code class="n">t1</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">currentTimeMillis</code><code class="o">();</code>&#13;
&#13;
        <code class="kt">long</code> <code class="n">runTime</code> <code class="o">=</code> <code class="n">t1</code> <code class="o">-</code> <code class="n">t0</code><code class="o">;</code>&#13;
&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
             <code class="s">"runTime="</code>  <code class="o">+</code> <code class="n">Double</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="n">runTime</code><code class="o">/</code><code class="mi">1000</code><code class="n">D</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Of course, you can’t directly compare the results from the operating system <code>time</code> command with results from running this program. There is a rather large, but fairly constant,   initialization overhead—the JVM startup and the initialization of <code>Object</code> and <code>System.out</code>, for example—that is included in the former and excluded from the latter. One could even argue that my <code>Time</code> program is more accurate because it excludes this constant overhead. But, as noted, it must be run on a single-user machine to yield repeatable results. And no fair running an editor in another window while waiting for your timed program to complete!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45290624934088">&#13;
<h2>See Also</h2>&#13;
&#13;
<p><a data-primary="Java Performance)" data-type="indexterm" id="idm45290624932920"/><a data-primary="Oaks, Scott" data-secondary="Java Performance" data-type="indexterm" id="idm45290624932216"/><em><a class="orm:hideurl" href="http://shop.oreilly.com/product/0636920272250.do">Java Performance</a></em> by Scott Oaks (O’Reilly) provides information on tuning Java <span class="keep-together">&#13;
performance.</span><a data-primary="" data-startref="pt_ab" data-type="indexterm" id="idm45290624929560"/><a data-primary="" data-startref="ref_pt" data-type="indexterm" id="idm45290624928584"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.8 Printing Class Information" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-6">&#13;
<h1>17.8 Printing Class Information</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-6.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="classes" data-secondary="printing information of" data-type="indexterm" id="cla_pri"/><a data-primary="reflection" data-secondary="printing class information with" data-type="indexterm" id="ref_pri"/>You want to print all the information about a class, similar to the way <em>javap</em> does.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-6.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Get a <code>Class</code> object, call its<a data-primary="getFields() method" data-type="indexterm" id="idm45290624919256"/><a data-primary="getMethod() method" data-type="indexterm" id="idm45290624918520"/> <code>getFields()</code> and <code>getMethods()</code>, and print the results.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-6.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The JDK includes a program called<a data-primary="javap command" data-type="indexterm" id="idm45290624914760"/> <em>javap</em>, the Java Printer. Sun’s JDK version normally prints the outline of a class file—a list of its methods and fields—but can also print out the Java bytecodes or machine instructions. The Kaffe package did not include a version of <em>javap</em>, so I wrote one and contributed it (see <a data-type="xref" href="#javacook-reflection-EX-8">Example 17-12</a>). The Kaffe folks have expanded it somewhat, but it still works basically the same. My version doesn’t print the bytecodes; it behaves rather like Sun’s behaves when you don’t give its version any command-line options.</p>&#13;
&#13;
<p>The <code>getFields()</code> and <code>getMethods()</code> methods return arrays of <code>Field</code> and <code>Method</code>, respectively; these are both in package <code>java.lang.reflect</code>. I use a <code>Modifiers</code> object to get details on the permissions and storage attributes of the fields and methods. In many Java implementations, you can bypass this and simply call <a data-primary="toString() method" data-type="indexterm" id="idm45290624908232"/><code>toString()</code> in each <code>Field</code> and <code>Method</code> object (as I do here for <code>Constructors</code>). Doing it this way gives me a bit more control over the formatting.<a data-primary="" data-startref="cla_pri" data-type="indexterm" id="idm45290624905832"/><a data-primary="" data-startref="ref_pri" data-type="indexterm" id="idm45290624904856"/></p>&#13;
<div data-type="example" id="javacook-reflection-EX-8">&#13;
<h5><span class="label">Example 17-12. </span>main/src/main/java/reflection/MyJavaP.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">MyJavaP</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** Simple main program, construct self, process each class name</code>&#13;
<code class="cm">     * found in argv.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">MyJavaP</code> <code class="n">pp</code> <code class="o">=</code> <code class="k">new</code> <code class="n">MyJavaP</code><code class="o">();</code>&#13;
&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Usage: MyJavaP className [...]"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">1</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">else</code> <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">argv</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code>&#13;
            <code class="n">pp</code><code class="o">.</code><code class="na">doClass</code><code class="o">(</code><code class="n">argv</code><code class="o">[</code><code class="n">i</code><code class="o">]);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Format the fields and methods of one class, given its name.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">doClass</code><code class="o">(</code><code class="n">String</code> <code class="n">className</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Class</code><code class="o">&lt;?</code> <code class="kd">extends</code> <code class="n">Object</code><code class="o">&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">className</code><code class="o">);</code>&#13;
&#13;
            <code class="kd">final</code> <code class="n">Annotation</code><code class="o">[]</code> <code class="n">annotations</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getAnnotations</code><code class="o">();</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="n">Annotation</code> <code class="n">a</code> <code class="o">:</code> <code class="n">annotations</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">a</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">c</code> <code class="o">+</code> <code class="s">" {"</code><code class="o">);</code>&#13;
&#13;
            <code class="n">Field</code> <code class="n">fields</code><code class="o">[]</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getDeclaredFields</code><code class="o">();</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="n">Field</code> <code class="n">f</code> <code class="o">:</code> <code class="n">fields</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="kd">final</code> <code class="n">Annotation</code><code class="o">[]</code> <code class="n">fldAnnotations</code> <code class="o">=</code> <code class="n">f</code><code class="o">.</code><code class="na">getAnnotations</code><code class="o">();</code>&#13;
                <code class="k">for</code> <code class="o">(</code><code class="n">Annotation</code> <code class="n">a</code> <code class="o">:</code> <code class="n">fldAnnotations</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">a</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
                <code class="k">if</code> <code class="o">(!</code><code class="n">Modifier</code><code class="o">.</code><code class="na">isPrivate</code><code class="o">(</code><code class="n">f</code><code class="o">.</code><code class="na">getModifiers</code><code class="o">()))</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"\t"</code> <code class="o">+</code> <code class="n">f</code> <code class="o">+</code> <code class="s">";"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
            <code class="n">Constructor</code><code class="o">&lt;?</code> <code class="kd">extends</code> <code class="n">Object</code><code class="o">&gt;[]</code> <code class="n">constructors</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getConstructors</code><code class="o">();</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="n">Constructor</code><code class="o">&lt;?</code> <code class="kd">extends</code> <code class="n">Object</code><code class="o">&gt;</code> <code class="n">con</code> <code class="o">:</code> <code class="n">constructors</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"\t"</code> <code class="o">+</code> <code class="n">con</code> <code class="o">+</code> <code class="s">";"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
            <code class="n">Method</code> <code class="n">methods</code><code class="o">[]</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getDeclaredMethods</code><code class="o">();</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="n">Method</code> <code class="n">m</code> <code class="o">:</code> <code class="n">methods</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="kd">final</code> <code class="n">Annotation</code><code class="o">[]</code> <code class="n">methodAnnotations</code> <code class="o">=</code> <code class="n">m</code><code class="o">.</code><code class="na">getAnnotations</code><code class="o">();</code>&#13;
                <code class="k">for</code> <code class="o">(</code><code class="n">Annotation</code> <code class="n">a</code> <code class="o">:</code> <code class="n">methodAnnotations</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">a</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
                <code class="k">if</code> <code class="o">(!</code><code class="n">Modifier</code><code class="o">.</code><code class="na">isPrivate</code><code class="o">(</code><code class="n">m</code><code class="o">.</code><code class="na">getModifiers</code><code class="o">()))</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"\t"</code> <code class="o">+</code> <code class="n">m</code> <code class="o">+</code> <code class="s">";"</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"}"</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">ClassNotFoundException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Error: Class "</code> <code class="o">+</code>&#13;
                <code class="n">className</code> <code class="o">+</code> <code class="s">" not found!"</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"JavaP Error: "</code> <code class="o">+</code> <code class="n">e</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.9 Listing Classes in a Package" data-type="sect1"><div class="sect1" id="javacook-reflection-classesInPackage">&#13;
<h1>17.9 Listing Classes in a Package</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-classesInPackage.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="classes" data-secondary="listing, in packages" data-type="indexterm" id="cla_lip"/><a data-primary="packages" data-secondary="listing classes in" data-type="indexterm" id="pac_lc"/><a data-primary="reflection" data-secondary="listing classes and" data-type="indexterm" id="ref_lc"/>You want to get a list of all the classes in a package.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-classesInPackage.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>You can’t, in the general case.  There are some limited approaches, most involving&#13;
<code>CLASSPATH</code> scanning.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-classesInPackage.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>There is no way to find out all the classes in a package, in part because, as we just&#13;
saw in <a data-type="xref" href="#javacook-reflection-SECT-4">Recipe 17.5</a>,&#13;
you can add classes to a package at any time!&#13;
And, for better or for worse, the JVM and standard classes such as <code>java.lang.Package</code>&#13;
do not even allow you to enumerate the classes currently in a given package.</p>&#13;
&#13;
<p>The nearest you can come is to look through the <code>CLASSPATH</code>.&#13;
And this will surely work only for local directories and JAR files;&#13;
if you have locally defined or network-loaded classes, this is not going to help.&#13;
In other words, it will find compiled classes, but not dynamically loaded ones.&#13;
There are several libraries that can automate this for you, and you’re welcome to use them.&#13;
The code to scan the <code>CLASSPATH</code> is fairly simple at heart, though, so classy developers with heart&#13;
will want to examine it.&#13;
<a data-type="xref" href="#javacook-reflection-EX-8X">Example 17-13</a> shows my <code>ClassesInPackage</code> class with its one static method.&#13;
The code works but is rather short on error handling, and it will crash on&#13;
nonexistent packages and other failures.</p>&#13;
&#13;
<p>The code goes through a few gyrations to get the <code>CLASSPATH</code> as an enumeration of URLs,&#13;
then looks at each element.</p>&#13;
<dl>&#13;
<dt>file</dt>&#13;
<dd>&#13;
<p>URLs will contain the pathname of the file&#13;
containing the <em>.class</em> file, so we can just list it.</p>&#13;
</dd>&#13;
<dt>jar</dt>&#13;
<dd>&#13;
<p>URLs contain the filename as “file:/path_to_jar_file!package/name,” so we have to pull&#13;
this apart; the “package name” suffix is slightly redundant in this case because it’s the&#13;
package we asked the <code>ClassLoader</code> to give us.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="example" id="javacook-reflection-EX-8X">&#13;
<h5><span class="label">Example 17-13. </span>main/src/main/java/reflection/ClassesInPackage.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ClassesInPackage</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** This approach began as a contribution by Paul Kuit at</code>&#13;
<code class="cm">     * http://stackoverflow.com/questions/1456930/, but his only</code>&#13;
<code class="cm">     * handled single files in a directory in classpath, not in Jar files.</code>&#13;
<code class="cm">     * N.B. Does NOT handle system classes!</code>&#13;
<code class="cm">     * @param packageName</code>&#13;
<code class="cm">     * @return</code>&#13;
<code class="cm">     * @throws IOException</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="n">String</code><code class="o">[]</code> <code class="nf">getPackageContent</code><code class="o">(</code><code class="n">String</code> <code class="n">packageName</code><code class="o">)</code>&#13;
        <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
&#13;
        <code class="kd">final</code> <code class="n">String</code> <code class="n">packageAsDirName</code> <code class="o">=</code> <code class="n">packageName</code><code class="o">.</code><code class="na">replace</code><code class="o">(</code><code class="s">"."</code><code class="o">,</code> <code class="s">"/"</code><code class="o">);</code>&#13;
        <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">list</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>&#13;
        <code class="kd">final</code> <code class="n">Enumeration</code><code class="o">&lt;</code><code class="n">URL</code><code class="o">&gt;</code> <code class="n">urls</code> <code class="o">=</code>&#13;
                <code class="n">Thread</code><code class="o">.</code><code class="na">currentThread</code><code class="o">().</code>&#13;
                <code class="n">getContextClassLoader</code><code class="o">().</code>&#13;
                <code class="n">getResources</code><code class="o">(</code><code class="n">packageAsDirName</code><code class="o">);</code>&#13;
        <code class="k">while</code> <code class="o">(</code><code class="n">urls</code><code class="o">.</code><code class="na">hasMoreElements</code><code class="o">())</code> <code class="o">{</code>&#13;
            <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="n">urls</code><code class="o">.</code><code class="na">nextElement</code><code class="o">();</code>&#13;
            <code class="c1">// System.out.println("URL = " + url);</code>&#13;
            <code class="n">String</code> <code class="n">file</code> <code class="o">=</code> <code class="n">url</code><code class="o">.</code><code class="na">getFile</code><code class="o">();</code>&#13;
            <code class="k">switch</code> <code class="o">(</code><code class="n">url</code><code class="o">.</code><code class="na">getProtocol</code><code class="o">())</code> <code class="o">{</code>&#13;
            <code class="k">case</code> <code class="s">"file"</code><code class="o">:</code>&#13;
                <code class="c1">// This is the easy case: "file" is</code>&#13;
                <code class="c1">// the full path to the classpath directory</code>&#13;
                <code class="n">File</code> <code class="n">dir</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>&#13;
                <code class="k">for</code> <code class="o">(</code><code class="n">File</code> <code class="n">f</code> <code class="o">:</code> <code class="n">dir</code><code class="o">.</code><code class="na">listFiles</code><code class="o">())</code> <code class="o">{</code>&#13;
                    <code class="n">list</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">packageAsDirName</code> <code class="o">+</code> <code class="s">"/"</code> <code class="o">+</code> <code class="n">f</code><code class="o">.</code><code class="na">getName</code><code class="o">());</code>&#13;
                <code class="o">}</code>&#13;
                <code class="k">break</code><code class="o">;</code>&#13;
            <code class="k">case</code> <code class="s">"jar"</code><code class="o">:</code>&#13;
                <code class="c1">// This is the harder case; "file" is of the form</code>&#13;
                <code class="c1">// "jar:/home/ian/bleah/darwinsys.jar!com/darwinsys/io"</code>&#13;
                <code class="c1">// for some jar file that contains at least one class from</code>&#13;
                <code class="c1">// the given package.</code>&#13;
                <code class="kt">int</code> <code class="n">colon</code> <code class="o">=</code> <code class="n">file</code><code class="o">.</code><code class="na">indexOf</code><code class="o">(</code><code class="sc">':'</code><code class="o">);</code>&#13;
                <code class="kt">int</code> <code class="n">bang</code> <code class="o">=</code> <code class="n">file</code><code class="o">.</code><code class="na">indexOf</code><code class="o">(</code><code class="sc">'!'</code><code class="o">);</code>&#13;
                <code class="n">String</code> <code class="n">jarFileName</code> <code class="o">=</code> <code class="n">file</code><code class="o">.</code><code class="na">substring</code><code class="o">(</code><code class="n">colon</code> <code class="o">+</code> <code class="mi">1</code><code class="o">,</code> <code class="n">bang</code><code class="o">);</code>&#13;
                <code class="n">JarFile</code> <code class="n">jarFile</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JarFile</code><code class="o">(</code><code class="n">jarFileName</code><code class="o">);</code>&#13;
                <code class="n">Enumeration</code><code class="o">&lt;</code><code class="n">JarEntry</code><code class="o">&gt;</code> <code class="n">entries</code> <code class="o">=</code> <code class="n">jarFile</code><code class="o">.</code><code class="na">entries</code><code class="o">();</code>&#13;
                <code class="k">while</code> <code class="o">(</code><code class="n">entries</code><code class="o">.</code><code class="na">hasMoreElements</code><code class="o">())</code> <code class="o">{</code>&#13;
                    <code class="n">JarEntry</code> <code class="n">e</code> <code class="o">=</code> <code class="n">entries</code><code class="o">.</code><code class="na">nextElement</code><code class="o">();</code>&#13;
                    <code class="n">String</code> <code class="n">jarEntryName</code> <code class="o">=</code> <code class="n">e</code><code class="o">.</code><code class="na">getName</code><code class="o">();</code>&#13;
                    <code class="k">if</code> <code class="o">(!</code><code class="n">jarEntryName</code><code class="o">.</code><code class="na">endsWith</code><code class="o">(</code><code class="s">"/"</code><code class="o">)</code> <code class="o">&amp;&amp;</code>&#13;
                        <code class="n">jarEntryName</code><code class="o">.</code><code class="na">startsWith</code><code class="o">(</code><code class="n">packageAsDirName</code><code class="o">))</code> <code class="o">{</code>&#13;
                        <code class="n">list</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">jarEntryName</code><code class="o">);</code>&#13;
                    <code class="o">}</code>&#13;
                <code class="o">}</code>&#13;
                <code class="k">break</code><code class="o">;</code>&#13;
            <code class="k">default</code><code class="o">:</code>&#13;
                <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalStateException</code><code class="o">(</code>&#13;
                <code class="s">"Dunno what to do with URL "</code> <code class="o">+</code> <code class="n">url</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">return</code> <code class="n">list</code><code class="o">.</code><code class="na">toArray</code><code class="o">(</code><code class="k">new</code> <code class="n">String</code><code class="o">[]</code> <code class="o">{});</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">String</code><code class="o">[]</code> <code class="n">names</code> <code class="o">=</code> <code class="n">getPackageContent</code><code class="o">(</code><code class="s">"com.darwinsys.io"</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">String</code> <code class="n">name</code> <code class="o">:</code> <code class="n">names</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">name</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Done"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Note that if you run this application in the <em>javasrc</em> project, it will list the&#13;
members of the demonstration package (<code>com.darwinsys.io</code>) twice, because it will find them both in the build directory and in the JAR file. If this is an issue, change the <code>List</code> to a <code>Set</code> (see&#13;
<a data-type="xref" href="ch07.html#javacook-structure-collections">Recipe 7.3</a>).<a data-primary="" data-startref="cla_lip" data-type="indexterm" id="idm45290624508776"/><a data-primary="" data-startref="pac_lc" data-type="indexterm" id="idm45290624507800"/><a data-primary="" data-startref="ref_lc" data-type="indexterm" id="idm45290624506856"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.10 Using and Defining Annotations" data-type="sect1"><div class="sect1" id="javacook-reflection-annotations">&#13;
<h1>17.10 Using and Defining Annotations</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-annotations-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="annotations" data-secondary="using with reflection" data-type="indexterm" id="ann_ref"/><a data-primary="annotations" data-secondary="defining with reflection" data-type="indexterm" id="anno_def"/><a data-primary="reflection" data-secondary="annotations, using/defining" data-type="indexterm" id="ref_ann"/>You need to know how to use annotations in code or to define your own annotations.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-annotations-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Apply annotations in your code using <code>@</code><code>AnnotationName</code> before a class, method, field, etc.&#13;
Define annotations with <code>@interface</code> at the same level as <code>class</code>, <code>interface</code>, etc.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-annotations-1.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Annotations are a way of adding additional information beyond what the source code conveys.&#13;
Annotations may be directed at the compiler or at runtime examination.&#13;
Their syntax was somewhat patterned after javadoc annotations&#13;
(such as <code>@author</code>, <code>@version</code> inside doc comments).&#13;
Annotations are what I call<a data-primary="class-like constructs" data-type="indexterm" id="idm45290623985064"/> <em>class-like things</em> (so they have initial-cap names)&#13;
but are prefixed by <code>@</code> sign where used (e.g., <code>@Override</code>).&#13;
You can place them on classes, methods, fields, and a few other places; they must&#13;
appear immediately before what they annotate (ignoring space and comments).&#13;
A given annotation may only appear once in a given position (this is relaxed in Java 8 or 9).</p>&#13;
&#13;
<p>As an example of the benefits of a compile-time annotation, consider the&#13;
common error made when overriding: as shown in <a data-type="xref" href="#myclassjavaanno">Example 17-14</a>, a small error in the method signature&#13;
can result it an overload when an override was intended.</p>&#13;
<div data-type="example" id="myclassjavaanno">&#13;
<h5><span class="label">Example 17-14. </span>MyClass.java (an example of why we need annotations)</h5>&#13;
&#13;
<pre data-type="programlisting">public class MyClass {&#13;
&#13;
    public boolean equals(MyClass object2) {&#13;
        // compare, return boolean&#13;
    }&#13;
}</pre></div>&#13;
&#13;
<p>The code will compile just fine on any release of Java, but it is incorrect.&#13;
The standard contract of the <a data-primary="equals() method" data-type="indexterm" id="idm45290623978408"/><code>equals()</code> method (see&#13;
<a data-type="xref" href="ch08.html#javacook-oo-SECT-1">Recipe 8.1</a>) requires a method whose&#13;
solitary argument is of type <code>java.lang.Object</code>. The preceding version creates an accidental&#13;
overload. Because the main use of <code>equals()</code> (and its buddy method <code>hashCode()</code>; see&#13;
<a data-type="xref" href="ch08.html#javacook-oo-SECT-1">Recipe 8.1</a>) is in the&#13;
Collections classes (see <a data-type="xref" href="ch07.html#javacook-structure">Chapter 7</a>),&#13;
this overloaded method will never get called, resulting both&#13;
in dead code and in incorrect operation of your class within <code>Set</code>s and <code>Map</code>s.</p>&#13;
&#13;
<p>The solution is very simple: using the annotation <code>java.lang.Override</code>, as in <a data-type="xref" href="#myclassjavaoverride">Example 17-15</a>, informs the&#13;
compiler that the annotated method is required to override a method inherited from&#13;
a supertype (such as a superclass or an interface). If not, the code will not compile.</p>&#13;
<div data-type="example" id="myclassjavaoverride">&#13;
<h5><span class="label">Example 17-15. </span>MyClass.java with @Override annotation</h5>&#13;
&#13;
<pre data-type="programlisting">public class MyClass {&#13;
&#13;
    @Override&#13;
    public boolean equals(MyClass object2) {&#13;
        // compare, return boolean&#13;
    }&#13;
}</pre></div>&#13;
&#13;
<p>This version of <code>equals()</code>, while still incorrect, will be flagged as erroneous at compile time,&#13;
potentially avoiding a lot of debugging time.&#13;
This annotation, on your own classes, will help both at the time you write new code and&#13;
as you maintain your codebase; if a method is removed from a superclass, all the subclasses&#13;
that still attempt to override it <em>and</em> have the <code>@Override</code> annotation will cause&#13;
an error message, allowing you to remove a bunch of dead code.</p>&#13;
&#13;
<p>The second major use of annotations is to provide metadata at runtime.&#13;
For example, the <a data-primary="Java Persistence API" data-type="indexterm" id="idm45290623965992"/>Java Persistence API (JPA, see <a href="https://darwinsys.com/db_in_java"><em class="hyperlink">https://darwinsys.com/db_in_java</em></a>)&#13;
uses its own set of annotations from&#13;
the package <code>javax.persistence</code> to mark up entity classes to be loaded and/or&#13;
persisted. A JPA entity class might look like <a data-type="xref" href="#personjavajpa">Example 17-16</a>.</p>&#13;
<div data-type="example" id="personjavajpa">&#13;
<h5><span class="label">Example 17-16. </span>main/src/main/java/domain/Person.java (JPA annotations)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Entity</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Person</code> <code class="o">{</code>&#13;
&#13;
    <code class="kt">int</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="n">String</code> <code class="n">firstName</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="n">String</code> <code class="n">lastName</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Person</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="c1">// required by JPA; must code it since we need 2-arg form.</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Person</code><code class="o">(</code><code class="n">String</code> <code class="n">firstName</code><code class="o">,</code> <code class="n">String</code> <code class="n">lastName</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">firstName</code> <code class="o">=</code> <code class="n">firstName</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">lastName</code> <code class="o">=</code> <code class="n">lastName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Id</code> <code class="nd">@GeneratedValue</code><code class="o">(</code><code class="n">strategy</code><code class="o">=</code><code class="n">GenerationType</code><code class="o">.</code><code class="na">AUTO</code><code class="o">,</code> <code class="n">generator</code><code class="o">=</code><code class="s">"my_poid_gen"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="kt">int</code> <code class="nf">getId</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setId</code><code class="o">(</code><code class="kt">int</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getFirstName</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">firstName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setFirstName</code><code class="o">(</code><code class="n">String</code> <code class="n">firstName</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">firstName</code> <code class="o">=</code> <code class="n">firstName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Column</code><code class="o">(</code><code class="n">name</code><code class="o">=</code><code class="s">"surname"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getLastName</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">lastName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setLastName</code><code class="o">(</code><code class="n">String</code> <code class="n">lastName</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">lastName</code> <code class="o">=</code> <code class="n">lastName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="nf">getFullName</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Transient</code> <code class="cm">/* synthetic: cannot be used in JPA queries. */</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getFullName</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">StringBuilder</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="o">();</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">firstName</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code>&#13;
            <code class="n">sb</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">firstName</code><code class="o">).</code><code class="na">append</code><code class="o">(</code><code class="sc">' '</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">lastName</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code>&#13;
            <code class="n">sb</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">lastName</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">sb</code><code class="o">.</code><code class="na">length</code><code class="o">()</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code>&#13;
            <code class="n">sb</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"NO NAME"</code><code class="o">);</code>&#13;
        <code class="k">return</code> <code class="n">sb</code><code class="o">.</code><code class="na">toString</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>@Entity</code> annotation at class level directs JPA to treat this as a data object to&#13;
be mapped into the database.&#13;
The <code>@Id</code> informs JPA that this <code>id</code> is the primary key <span class="keep-together">property,</span> and the <code>@GeneratedValue</code>&#13;
tells it how to assign the primary key values for newly created objects.&#13;
The <code>@Column</code> annotation is only needed when the column name in the relational database&#13;
differs from the expected name based on the property; in this case, the SQL database&#13;
designer has used <code>surname</code>, whereas the Java developer wants to use <code>lastName</code>.</p>&#13;
&#13;
<p>I said that annotations are class-like things, and therefore, you can define your own.&#13;
The syntax here is a bit funky; you use <code>@interface</code>. It is rumored that the team&#13;
developing this feature was either told not to, or was afraid to, introduce a new&#13;
keyword into the language, due to the trouble that doing so had caused when the <code>enum</code> <span class="keep-together">keyword</span>&#13;
was introduced in Java SE 1.4.&#13;
Or, maybe they just wanted to use a syntax that was more reminiscent of the annotation’s usage.&#13;
At any rate, <a data-type="xref" href="#trivialannot">Example 17-17</a> is a trivial example of a custom annotation.</p>&#13;
<div data-type="example" id="trivialannot">&#13;
<h5><span class="label">Example 17-17. </span>Trivial annotation defined</h5>&#13;
&#13;
<pre data-type="programlisting">package lang;&#13;
&#13;
public @interface MyToyAnnotation {&#13;
}</pre></div>&#13;
&#13;
<p>Annotations are class-like things, so they should be named the same way—that is, names&#13;
that begin with a capital letter and, if public, are stored in a source file of the same name&#13;
(e.g, <em>MyToyAnnotation.java</em>).</p>&#13;
&#13;
<p>Compile the <a data-type="xref" href="#trivialannot">Example 17-17</a> with <em>javac</em> and you’ll see there’s a new <em>MyToyAnnotation.class</em> file.&#13;
In <a data-type="xref" href="#runningjavap">Example 17-18</a>, we examine this with <em>javap</em>, the standard JDK class inspection tool.</p>&#13;
<div data-type="example" id="runningjavap">&#13;
<h5><span class="label">Example 17-18. </span>Running javap on trivial annotation</h5>&#13;
&#13;
<pre data-type="programlisting">$ javap lang.MyToyAnnotation&#13;
Compiled from "MyToyAnnotation.java"&#13;
public interface lang.MyToyAnnotation extends java.lang.annotation.Annotation {&#13;
}&#13;
$</pre></div>&#13;
&#13;
<p>As it says, an <code>Annotation</code> is represented in the class file format as just an interface that <code>extends Annotation</code> (to answer the obvious question, you could write simple interfaces this way, but it would be a truly terrible idea).  In <a data-type="xref" href="#annotation">Example 17-19</a>, we take a quick look at <code>Annotation</code> itself.</p>&#13;
<div data-type="example" id="annotation">&#13;
<h5><span class="label">Example 17-19. </span>The Annotation Interface in Detail</h5>&#13;
&#13;
<pre data-type="programlisting">$ javap java.lang.annotation.Annotation&#13;
Compiled from "Annotation.java"&#13;
public interface java.lang.annotation.Annotation {&#13;
  public abstract boolean equals(java.lang.Object);&#13;
  public abstract int hashCode();&#13;
  public abstract java.lang.String toString();&#13;
  public abstract java.lang.Class&lt;? extends java.lang.annotation.Annotation&gt;&#13;
    annotationType();&#13;
}&#13;
$</pre></div>&#13;
&#13;
<p>Annotations can be made such that the compiler will only allow them in certain points&#13;
in your code. <a data-type="xref" href="#annotation-classes">Example 17-20</a> is one that can only go on classes or interfaces.</p>&#13;
<div data-type="example" id="annotation-classes">&#13;
<h5><span class="label">Example 17-20. </span>Sample Annotation for Classes, Interfaces, etc.</h5>&#13;
&#13;
<pre data-type="programlisting">@Target(ElementType.TYPE)&#13;
@Retention(RetentionPolicy.RUNTIME)&#13;
public @interface MyAnnotation {&#13;
}</pre></div>&#13;
&#13;
<p>The <code>@Target</code> specifies where the annotation can be used: <code>ElementType.TYPE</code> makes it usable on&#13;
classes, interfaces, class-like things such as enums, even annotations!&#13;
To restrict it to use just on annotations, there is <code>ElementType.ANNOTATION_TYPE</code>.&#13;
Other types include <code>METHOD</code>, <code>FIELD</code>, <code>CONSTRUCTOR</code>, <code>LOCAL_VARIABLE</code>, <code>PACKAGE</code>, and <code>PARAMETER</code>.&#13;
So, this annotation is itself annotated with two <code>@ANNOTATION_TYPE</code>-targeted annotations.</p>&#13;
&#13;
<p>Usage of annotations with an existing framework requires consulting their documentation.&#13;
Using annotations for your own purpose at runtime requires use of the Reflection API,&#13;
as shown in <a data-type="xref" href="#javacook-reflection-Ex-AnnotationDemo">Example 17-21</a>.</p>&#13;
&#13;
<p>One more thing to note about annotations is that they may have attributes. These are defined&#13;
as methods in the annotation source code but used as attributes where the annotation is used.&#13;
<a data-type="xref" href="#javacook-reflection-Ex-AnnotationDemo">Example 17-21</a> is an annotated annotation with one such attribute.</p>&#13;
<div data-type="example" id="javacook-reflection-Ex-AnnotationDemo">&#13;
<h5><span class="label">Example 17-21. </span>main/src/main/java/lang/AnnotationDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * A sample annotation for types (classes, interfaces);</code>&#13;
<code class="cm"> * it will be available at run time.</code>&#13;
<code class="cm"> */</code>&#13;
<code class="nd">@Target</code><code class="o">(</code><code class="n">ElementType</code><code class="o">.</code><code class="na">TYPE</code><code class="o">)</code>&#13;
<code class="nd">@Retention</code><code class="o">(</code><code class="n">RetentionPolicy</code><code class="o">.</code><code class="na">RUNTIME</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="nd">@interface</code> <code class="n">AnnotationDemo</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">fancy</code><code class="o">()</code> <code class="k">default</code> <code class="kc">false</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kt">int</code> <code class="nf">order</code><code class="o">()</code> <code class="k">default</code> <code class="mi">42</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="cm">/** A simple example of using the annotation */</code>&#13;
<code class="nd">@AnnotationDemo</code><code class="o">(</code><code class="n">fancy</code><code class="o">=</code><code class="kc">true</code><code class="o">)</code>&#13;
<code class="nd">@Resource</code><code class="o">(</code><code class="n">name</code><code class="o">=</code><code class="s">"Dumbledore"</code><code class="o">)</code>&#13;
<code class="kd">class</code> <code class="nc">FancyClassJustToShowAnnotation</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** Print out the annotations attached to this class */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="n">FancyClassJustToShowAnnotation</code><code class="o">.</code><code class="na">class</code><code class="o">;</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Class "</code> <code class="o">+</code> <code class="n">c</code><code class="o">.</code><code class="na">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" has these annotations:"</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">Annotation</code> <code class="n">a</code> <code class="o">:</code> <code class="n">c</code><code class="o">.</code><code class="na">getAnnotations</code><code class="o">())</code> <code class="o">{</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">a</code> <code class="k">instanceof</code> <code class="n">AnnotationDemo</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">AnnotationDemo</code> <code class="n">ad</code> <code class="o">=</code> <code class="o">(</code><code class="n">AnnotationDemo</code><code class="o">)</code><code class="n">a</code><code class="o">;</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"\t"</code> <code class="o">+</code><code class="n">a</code> <code class="o">+</code>&#13;
                    <code class="s">" with fancy="</code> <code class="o">+</code> <code class="n">ad</code><code class="o">.</code><code class="na">fancy</code><code class="o">()</code> <code class="o">+</code>&#13;
                    <code class="s">" and order "</code> <code class="o">+</code> <code class="n">ad</code><code class="o">.</code><code class="na">order</code><code class="o">());</code>&#13;
            <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"\tSomebody else's annotation: "</code> <code class="o">+</code> <code class="n">a</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><code>AnnotationDemo</code> has the meta-annotation <code>@Target(ElementType.TYPE)</code> to&#13;
indicate that it can annotate user-defined types (such as classes).  Other <code>ElementType</code>&#13;
choices include <code>METHOD</code>, <code>FIELD</code>, and <code>PARAMETER</code>.  If more than one is&#13;
needed, use array initializer syntax.</p>&#13;
&#13;
<p><code>AnnotationDemo</code> also has the <code>@Retention(RetentionPolicy.RUNTIME)</code> annotation to request&#13;
that it be preserved until runtime. This is obviously required for any annotation that will be examined by a framework at runtime.</p>&#13;
&#13;
<p>These two meta-annotations are common on user-defined annotations that will be examined at&#13;
runtime.</p>&#13;
&#13;
<p>The class <code>FancyClassJustToShowAnnotation</code> shows using the <code>AnnotationDemo</code> annotation,&#13;
along with a standard Java one (the <code>@Resource</code> annotation).</p>&#13;
&#13;
<p>Refer to <a data-type="xref" href="#javacook-reflection-pluginViaAnnotations">Recipe 17.11</a>&#13;
for a full example of using this mechanism.<a data-primary="" data-startref="ann_ref" data-type="indexterm" id="idm45290623396008"/><a data-primary="" data-startref="ref_ann" data-type="indexterm" id="idm45290623395064"/><a data-primary="" data-startref="anno_def" data-type="indexterm" id="idm45290623394120"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.11 Finding Plug-In-Like Classes via Annotations" data-type="sect1"><div class="sect1" id="javacook-reflection-pluginViaAnnotations">&#13;
<h1>17.11 Finding Plug-In-Like Classes via Annotations</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-reflection-pluginViaAnnotations.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="annotations" data-secondary="plug-in-like classes, finding with" data-type="indexterm" id="idm45290623390440"/><a data-primary="classes" data-secondary="plug-in-like" data-type="indexterm" id="idm45290623389496"/><a data-primary="plug-in-like classes" data-type="indexterm" id="idm45290623388552"/>You want to do plug-in-like things without using an explicit plug-in API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-reflection-pluginViaAnnotations.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Define an annotation for the purpose, and use it to mark the plug-in classes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-reflection-pluginViaAnnotations.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Suppose we want to model how the Java EE standard <code>javax.annotations.Named</code> or&#13;
<code>javax.faces.ManagedBean</code> annotations work; for each class&#13;
that is so annotated, convert the class name to an instance-like name (e.g, lowercase the first letter),&#13;
and do something special with it. You’d want to do something like the following:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Get the list of classes in the given package(s) (see <a data-type="xref" href="#javacook-reflection-classesInPackage">Recipe 17.9</a>).</p>&#13;
</li>&#13;
<li>&#13;
<p>Check if the class is annotated.</p>&#13;
</li>&#13;
<li>&#13;
<p>If so, save the name and <code>Class</code> descriptor for later use.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>This is implemented in <a data-type="xref" href="#javacook-reflection-EX-8Y">Example 17-22</a>.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-8Y">&#13;
<h5><span class="label">Example 17-22. </span>main/src/main/java/reflection/PluginsViaAnnotations</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/** Discover "plugins" or other add-in classes via Reflection using Annotations */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PluginsViaAnnotations</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/**</code>&#13;
<code class="cm">     * Find all classes in the given package which have the given</code>&#13;
<code class="cm">     * class-level annotation class.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Class</code><code class="o">&lt;?&gt;&gt;</code> <code class="n">findAnnotatedClasses</code><code class="o">(</code><code class="n">String</code> <code class="n">packageName</code><code class="o">,</code>&#13;
        <code class="n">Class</code><code class="o">&lt;?</code> <code class="kd">extends</code> <code class="n">Annotation</code><code class="o">&gt;</code> <code class="n">annotationClass</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">Class</code><code class="o">&lt;?&gt;&gt;</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>&#13;
        <code class="n">String</code><code class="o">[]</code> <code class="n">clazzNames</code> <code class="o">=</code> <code class="n">ClassesInPackage</code><code class="o">.</code><code class="na">getPackageContent</code><code class="o">(</code><code class="n">packageName</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">String</code> <code class="n">clazzName</code> <code class="o">:</code> <code class="n">clazzNames</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">if</code> <code class="o">(!</code><code class="n">clazzName</code><code class="o">.</code><code class="na">endsWith</code><code class="o">(</code><code class="s">".class"</code><code class="o">))</code> <code class="o">{</code>&#13;
                <code class="k">continue</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="n">clazzName</code> <code class="o">=</code> <code class="n">clazzName</code><code class="o">.</code><code class="na">replace</code><code class="o">(</code><code class="sc">'/'</code><code class="o">,</code> <code class="sc">'.'</code><code class="o">).</code><code class="na">replace</code><code class="o">(</code><code class="s">".class"</code><code class="o">,</code> <code class="s">""</code><code class="o">);</code>&#13;
            <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">c</code> <code class="o">=</code> <code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">clazzName</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">ClassNotFoundException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Weird: class "</code> <code class="o">+</code> <code class="n">clazzName</code> <code class="o">+</code>&#13;
                    <code class="s">" reported in package but gave CNFE: "</code> <code class="o">+</code> <code class="n">ex</code><code class="o">);</code>&#13;
                <code class="k">continue</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">c</code><code class="o">.</code><code class="na">isAnnotationPresent</code><code class="o">(</code><code class="n">annotationClass</code><code class="o">)</code> <code class="o">&amp;&amp;</code>&#13;
                    <code class="o">!</code><code class="n">ret</code><code class="o">.</code><code class="na">contains</code><code class="o">(</code><code class="n">c</code><code class="o">))</code>&#13;
                    <code class="n">ret</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">c</code><code class="o">);</code>&#13;
&#13;
        <code class="o">}</code>&#13;
        <code class="k">return</code> <code class="n">ret</code><code class="o">;</code>&#13;
    <code class="o">}</code></pre></div>&#13;
&#13;
<p>We can take this one step further and support particular method&#13;
annotations, similar to <code>javax.annotations.PostCreate</code>, which is&#13;
meant to decorate a method that is to be called after an instance&#13;
of the bean has been instantiated by the framework.  Our flow is&#13;
now something like this, and the code is shown in <a data-type="xref" href="#javacook-reflection-EX-8Z">Example 17-23</a>:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Get the list of classes in the given package(s) (again, see <a data-type="xref" href="#javacook-reflection-classesInPackage">Recipe 17.9</a>).</p>&#13;
</li>&#13;
<li>&#13;
<p>If you are using a class-level annotation, check if the class is annotated.</p>&#13;
</li>&#13;
<li>&#13;
<p>If this class is still of interest, get a list of its methods.</p>&#13;
</li>&#13;
<li>&#13;
<p>For each method, see if it contains a given method-specific annotation.</p>&#13;
</li>&#13;
<li>&#13;
<p>If so, add the class and method to a list of invocable methods.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
<div data-type="example" id="javacook-reflection-EX-8Z">&#13;
<h5><span class="label">Example 17-23. </span>main/src/main/java/reflection/PluginsViaAnnotations (find annotated methods)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">    <code class="cm">/**</code>&#13;
<code class="cm">     * Find all classes in the given package which have the given</code>&#13;
<code class="cm">     * method-level annotation class on at least one method.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Class</code><code class="o">&lt;?&gt;&gt;</code> <code class="n">findClassesWithAnnotatedMethods</code><code class="o">(</code><code class="n">String</code> <code class="n">packageName</code><code class="o">,</code>&#13;
            <code class="n">Class</code><code class="o">&lt;?</code> <code class="kd">extends</code> <code class="n">Annotation</code><code class="o">&gt;</code> <code class="n">methodAnnotationClass</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">Class</code><code class="o">&lt;?&gt;&gt;</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>&#13;
        <code class="n">String</code><code class="o">[]</code> <code class="n">clazzNames</code> <code class="o">=</code> <code class="n">ClassesInPackage</code><code class="o">.</code><code class="na">getPackageContent</code><code class="o">(</code><code class="n">packageName</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">String</code> <code class="n">clazzName</code> <code class="o">:</code> <code class="n">clazzNames</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">if</code> <code class="o">(!</code><code class="n">clazzName</code><code class="o">.</code><code class="na">endsWith</code><code class="o">(</code><code class="s">".class"</code><code class="o">))</code> <code class="o">{</code>&#13;
                <code class="k">continue</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="n">clazzName</code> <code class="o">=</code> <code class="n">clazzName</code><code class="o">.</code><code class="na">replace</code><code class="o">(</code><code class="sc">'/'</code><code class="o">,</code> <code class="sc">'.'</code><code class="o">).</code><code class="na">replace</code><code class="o">(</code><code class="s">".class"</code><code class="o">,</code> <code class="s">""</code><code class="o">);</code>&#13;
            <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">c</code> <code class="o">=</code> <code class="n">Class</code><code class="o">.</code><code class="na">forName</code><code class="o">(</code><code class="n">clazzName</code><code class="o">);</code>&#13;
                <code class="c1">// System.out.println("Loaded " + c);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">ClassNotFoundException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Weird: class "</code> <code class="o">+</code> <code class="n">clazzName</code> <code class="o">+</code>&#13;
                    <code class="s">" reported in package but gave CNFE: "</code> <code class="o">+</code> <code class="n">ex</code><code class="o">);</code>&#13;
                <code class="k">continue</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="n">Method</code> <code class="n">m</code> <code class="o">:</code> <code class="n">c</code><code class="o">.</code><code class="na">getDeclaredMethods</code><code class="o">())</code> <code class="o">{</code>&#13;
                <code class="c1">// System.out.printf("Class %s Method: %s\n",</code>&#13;
                <code class="c1">//     c.getSimpleName(), m.getName());</code>&#13;
                <code class="k">if</code> <code class="o">(</code><code class="n">m</code><code class="o">.</code><code class="na">isAnnotationPresent</code><code class="o">(</code><code class="n">methodAnnotationClass</code><code class="o">)</code> <code class="o">&amp;&amp;</code>&#13;
                        <code class="o">!</code><code class="n">ret</code><code class="o">.</code><code class="na">contains</code><code class="o">(</code><code class="n">c</code><code class="o">))</code> <code class="o">{</code>&#13;
                    <code class="n">ret</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">c</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">return</code> <code class="n">ret</code><code class="o">;</code>&#13;
    <code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-reflection-pluginViaAnnotations.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p><a data-type="xref" href="#javacook-reflection-annotations">Recipe 17.10</a> and the rest of this chapter.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="17.12 Program: CrossRef" data-type="sect1"><div class="sect1" id="javacook-reflection-SECT-7">&#13;
<h1>17.12 Program: CrossRef</h1>&#13;
&#13;
<p><a data-primary="CrossRef program" data-type="indexterm" id="crf_ab"/>You’ve probably seen those other Java books that consist entirely of listings of the Java&#13;
API for version thus-and-such of the JDK. I don’t suppose you thought the authors of these&#13;
works sat down and typed the entire contents from scratch. As a programmer, you would have&#13;
realized, I hope, that there must be a way to obtain that information from Java. But you&#13;
might not have realized how easy it is! If you’ve read this chapter faithfully, you now&#13;
know that there is one true way: make the computer do the walking.&#13;
<a data-type="xref" href="#javacook-reflection-EX-9">Example 17-24</a> is a program that puts most of the techniques together. This&#13;
version generates a cross-reference listing, but by overriding the last few methods, you&#13;
could easily convert it to print the information in any format you like, including an API&#13;
reference book. You’d need to deal with the details of this or that publishing&#13;
software—FrameMaker, troff, T<sub>E</sub>X, or whatever—but that’s the easy part.</p>&#13;
&#13;
<p>This program makes fuller use of the Reflection API than did <code>MyJavaP</code> in <a data-type="xref" href="#javacook-reflection-SECT-6">Recipe 17.8</a>. It also uses the <code>java.util.zip</code>  classes (see <a data-type="xref" href="ch10.html#javacook-io-SECT-20">Recipe 10.15</a>) to crack the JAR archive containing the class files of the API. Each class file found in the archive is loaded and listed; the listing part is similar to <code>MyJavaP</code>.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-9">&#13;
<h5><span class="label">Example 17-24. </span>main/src/main/java/reflection/CrossRef.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CrossRef</code> <code class="kd">extends</code> <code class="n">APIFormatter</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** Simple main program, construct self, process each .ZIP file</code>&#13;
<code class="cm">     * found in CLASSPATH or in argv.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">CrossRef</code> <code class="n">xref</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CrossRef</code><code class="o">();</code>&#13;
        <code class="n">xref</code><code class="o">.</code><code class="na">doArgs</code><code class="o">(</code><code class="n">argv</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/**</code>&#13;
<code class="cm">     * Print the fields and methods of one class.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">doClass</code><code class="o">(</code><code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">startClass</code><code class="o">(</code><code class="n">c</code><code class="o">);</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Field</code><code class="o">[]</code> <code class="n">fields</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getDeclaredFields</code><code class="o">();</code>&#13;
            <code class="n">Arrays</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">fields</code><code class="o">,</code> <code class="k">new</code> <code class="n">Comparator</code><code class="o">&lt;</code><code class="n">Field</code><code class="o">&gt;()</code> <code class="o">{</code>&#13;
                <code class="kd">public</code> <code class="kt">int</code> <code class="nf">compare</code><code class="o">(</code><code class="n">Field</code> <code class="n">o1</code><code class="o">,</code> <code class="n">Field</code> <code class="n">o2</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="k">return</code> <code class="n">o1</code><code class="o">.</code><code class="na">getName</code><code class="o">().</code><code class="na">compareTo</code><code class="o">(</code><code class="n">o2</code><code class="o">.</code><code class="na">getName</code><code class="o">());</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">});</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">fields</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
                <code class="n">Field</code> <code class="n">field</code> <code class="o">=</code> <code class="o">(</code><code class="n">Field</code><code class="o">)</code><code class="n">fields</code><code class="o">[</code><code class="n">i</code><code class="o">];</code>&#13;
                <code class="k">if</code> <code class="o">(!</code><code class="n">Modifier</code><code class="o">.</code><code class="na">isPrivate</code><code class="o">(</code><code class="n">field</code><code class="o">.</code><code class="na">getModifiers</code><code class="o">()))</code>&#13;
                    <code class="n">putField</code><code class="o">(</code><code class="n">field</code><code class="o">,</code> <code class="n">c</code><code class="o">);</code>&#13;
                <code class="c1">// else System.err.println("private field ignored: " + field);</code>&#13;
            <code class="o">}</code>&#13;
&#13;
            <code class="n">Method</code> <code class="n">methods</code><code class="o">[]</code> <code class="o">=</code> <code class="n">c</code><code class="o">.</code><code class="na">getDeclaredMethods</code><code class="o">();</code>&#13;
            <code class="n">Arrays</code><code class="o">.</code><code class="na">sort</code><code class="o">(</code><code class="n">methods</code><code class="o">,</code> <code class="k">new</code> <code class="n">Comparator</code><code class="o">&lt;</code><code class="n">Method</code><code class="o">&gt;()</code> <code class="o">{</code>&#13;
                <code class="kd">public</code> <code class="kt">int</code> <code class="nf">compare</code><code class="o">(</code><code class="n">Method</code> <code class="n">o1</code><code class="o">,</code> <code class="n">Method</code> <code class="n">o2</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="k">return</code> <code class="n">o1</code><code class="o">.</code><code class="na">getName</code><code class="o">().</code><code class="na">compareTo</code><code class="o">(</code><code class="n">o2</code><code class="o">.</code><code class="na">getName</code><code class="o">());</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">});</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">methods</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
                <code class="k">if</code> <code class="o">(!</code><code class="n">Modifier</code><code class="o">.</code><code class="na">isPrivate</code><code class="o">(</code><code class="n">methods</code><code class="o">[</code><code class="n">i</code><code class="o">].</code><code class="na">getModifiers</code><code class="o">()))</code>&#13;
                    <code class="n">putMethod</code><code class="o">(</code><code class="n">methods</code><code class="o">[</code><code class="n">i</code><code class="o">],</code> <code class="n">c</code><code class="o">);</code>&#13;
                <code class="c1">// else System.err.println("pvt: " + methods[i]);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">endClass</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** put a Field's information to the standard output.  */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">putField</code><code class="o">(</code><code class="n">Field</code> <code class="n">fld</code><code class="o">,</code> <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">println</code><code class="o">(</code><code class="n">fld</code><code class="o">.</code><code class="na">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" field "</code> <code class="o">+</code> <code class="n">c</code><code class="o">.</code><code class="na">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" "</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** put a Method's information to the standard output.  */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">putMethod</code><code class="o">(</code><code class="n">Method</code> <code class="n">method</code><code class="o">,</code> <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">methName</code> <code class="o">=</code> <code class="n">method</code><code class="o">.</code><code class="na">getName</code><code class="o">();</code>&#13;
        <code class="n">println</code><code class="o">(</code><code class="n">methName</code> <code class="o">+</code> <code class="s">" method "</code> <code class="o">+</code> <code class="n">c</code><code class="o">.</code><code class="na">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">" "</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Print the start of a class. Unused in this version,</code>&#13;
<code class="cm">     * designed to be overridden */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">startClass</code><code class="o">(</code><code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Print the end of a class. Unused in this version,</code>&#13;
<code class="cm">     * designed to be overridden */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">endClass</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Convenience routine, short for System.out.println */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kt">void</code> <code class="nf">println</code><code class="o">(</code><code class="n">String</code> <code class="n">s</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">s</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>You probably noticed the methods <a data-primary="startClass() method" data-type="indexterm" id="idm45290622897064"/><a data-primary="endClass() method" data-type="indexterm" id="idm45290622896456"/><code>startClass()</code> and <code>endClass()</code>, which are null. These methods are placeholders designed to make subclassing easy for when you need to write something at the start and end of each class. One example might be a fancy text formatting application in which you need to output a bold header at the beginning of each class. Another would be XML, where you’d want to write a tag like <code>&lt;class&gt;</code> at the front of each class and <code>&lt;/class&gt;</code> at the end. <a data-type="xref" href="#javacook-reflection-EX-10">Example 17-25</a> is an XML-specific subclass that generates (limited) XML for each field and method.</p>&#13;
<div data-type="example" id="javacook-reflection-EX-10">&#13;
<h5><span class="label">Example 17-25. </span>main/src/main/java/reflection/CrossRefXML.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CrossRefXML</code> <code class="kd">extends</code> <code class="n">CrossRef</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">CrossRef</code> <code class="n">xref</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CrossRefXML</code><code class="o">();</code>&#13;
        <code class="n">xref</code><code class="o">.</code><code class="na">doArgs</code><code class="o">(</code><code class="n">argv</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Print the start of a class.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">startClass</code><code class="o">(</code><code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">println</code><code class="o">(</code><code class="s">"&lt;class&gt;&lt;classname&gt;"</code> <code class="o">+</code> <code class="n">c</code><code class="o">.</code><code class="na">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">"&lt;/classname&gt;"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">putField</code><code class="o">(</code><code class="n">Field</code> <code class="n">fld</code><code class="o">,</code> <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">println</code><code class="o">(</code><code class="s">"&lt;field&gt;"</code> <code class="o">+</code> <code class="n">fld</code> <code class="o">+</code> <code class="s">"&lt;/field&gt;"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** put a Method's information to the standard output.</code>&#13;
<code class="cm">     * Marked protected so you can override it (hint, hint).</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">putMethod</code><code class="o">(</code><code class="n">Method</code> <code class="n">method</code><code class="o">,</code> <code class="n">Class</code><code class="o">&lt;?&gt;</code> <code class="n">c</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">println</code><code class="o">(</code><code class="s">"&lt;method&gt;"</code> <code class="o">+</code> <code class="n">method</code> <code class="o">+</code> <code class="s">"&lt;/method&gt;"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Print the end of a class.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">endClass</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">println</code><code class="o">(</code><code class="s">"&lt;/class&gt;"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>By the way, if you publish a book using either of these and get rich, “Remember, remember me!”</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-reflection-SECT-8.1">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>We have not investigated all the ins and outs of reflection or the <code>ClassLoader</code> mechanism, but by now you should have a basic idea of how it works.</p>&#13;
&#13;
<p>Perhaps the most important omissions are <code>SecurityManager</code> and <code>ProtectionDomain</code>. Only one <code>SecurityManager</code> can be installed in a given instance of the JVM (e.g., to prevent malicious code from providing its own!). A browser running the old Java Applet API, for example, provides a <code>SecurityManager</code> that is far more restrictive than the standard one. Writing such a <code>SecurityManager</code> is left as an exercise for the reader—an important exercise for anyone planning to load classes over the internet! (For more information about security managers and the Java Security APIs, see <a data-primary="Java Security (Oaks)" data-type="indexterm" id="idm45290622409384"/><a data-primary="Oaks, Scott" data-secondary="Java Security" data-type="indexterm" id="idm45290622408680"/><em><a class="orm:hideurl" href="http://oreil.ly/java-security-2nd">Java Security</a></em> by Scott Oaks (O’Reilly). A <code>ProtectionDomain</code> can be provided with a <code>ClassLoader</code> to specify all the permissions needed for the class to run.</p>&#13;
&#13;
<p>I’ve also left unexplored many topics in the JVM; see the (somewhat dated) O’Reilly books<a data-primary="Java Virtual Machine (Downing and Meyer)" data-type="indexterm" id="idm45290622405208"/><a data-primary="Downing, Troy" data-secondary="Java Virtual Machine" data-type="indexterm" id="idm45290622404472"/><a data-primary="Meyer, Jon" data-secondary="Java Virtual Machine" data-type="indexterm" id="idm45290622403528"/>&#13;
<em><a class="orm:hideurl" href="http://shop.oreilly.com/product/9781565921948.do">Java Virtual Machine</a></em> by Troy Downing and Jon Meyer, and<a data-primary="Java Language Reference (Grand)" data-type="indexterm" id="idm45290622401304"/><a data-primary="Grand, Mark" data-secondary="Java Language Reference" data-type="indexterm" id="idm45290622400616"/>&#13;
<em><a class="orm:hideurl" href="http://shop.oreilly.com/product/9781565923263.do">Java Language Reference</a></em> by Mark Grand.&#13;
You can also read the Sun/Oracle <em>Java Language Specification</em> and&#13;
<em>JVM Specification</em> documents (both updated with new releases, available&#13;
<a href="https://docs.oracle.com/en/java/javase/13/docs">online</a>), for a lifetime of reading enjoyment and edification!</p>&#13;
&#13;
<p>The Apache Software Foundation maintains a vast array of useful software packages that are free to get and use. Source code is always available without charge from its website. Two packages you might want to investigate include the Commons BeanUtils and the Byte Code Engineering Library (BCEL).<a data-primary="Commons BeanUtils" data-type="indexterm" id="idm45290622395928"/> The <a href="http://commons.apache.org/beanutils">Commons BeanUtils</a> claims to provide easier-to-use wrappers around some of the Reflection API. BCEL is a third-party toolkit for building and manipulating bytecode class files. Written by <a data-primary="Dahm, Markus" data-type="indexterm" id="idm45290622394248"/>Markus Dahm, BCEL has become part of the<a data-primary="Apache Commons Project" data-type="indexterm" id="idm45290622393352"/> <a href="http://commons.apache.org/bcel">Apache Commons Project</a>.<a data-primary="" data-startref="crf_ab" data-type="indexterm" id="idm45290622391848"/><a data-primary="" data-startref="ref_ch" data-type="indexterm" id="idm45290622390840"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>