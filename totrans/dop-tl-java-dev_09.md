# 第九章 移动工作流

Stephen Chin

> 程序测试可以非常有效地显示存在的 bug，但却无法有效地证明其不存在。
> 
> Edsger Dijkstra

DevOps 的覆盖范围如果不包括移动开发和智能手机的话，就不完整了，后者是计算机拥有量增长最快的领域。过去十年间，智能手机的使用量飙升，全球拥有数以十亿计的智能手机，详见图 9-1。

由于像印度和中国等大国的智能手机拥有率不到 70%，预计智能手机的拥有量将继续上升。如今全球拥有 36 亿部智能手机，到 2023 年预计将达到 43 亿部，这是一个不容忽视的市场和用户群体。

智能手机还具有另一个性质，使得 DevOps 成为一种必不可少的实践：它们属于一类需要连续更新的互联网连接设备，这是因为它们面向的是不那么技术熟练的消费者，需要以最少的用户参与来维护设备。这种趋势受到围绕智能手机建立的应用程序生态系统的推动，使得下载新软件以及接收软件更新对终端用户来说变得轻松且风险相对较低。

![显示从 2012 年到 2023 年全球智能手机拥有量增长情况的图表](img/dtjd_0901.png)

###### 图 9-1 2012 年至 2023 年间全球智能手机用户数，数据来自[Statista](https://oreil.ly/k8dk1)（2023 年的预测标有*）

由于多种功能原因，你可能希望更新你的应用程序：

为用户添加新功能

大多数应用程序快速发布，具备最小可行特性集，以缩短上市时间。这使得可以频繁发布小的功能更新，以增加终端用户的实用功能。

修复 bug 并提高应用程序的稳定性

成熟的应用程序经常有很多修复小 bug、提高稳定性和改进用户体验的更新。这些改动通常较小，可以频繁发布。

修补安全漏洞或利用

移动应用程序通常具有广泛的攻击面，包括本地安装的应用程序、提供数据的后端以及用于应用程序和云服务登录的用户认证工作流程。

此外，许多应用程序更新驱动于增加市场份额和改善与用户的互动。一些增加应用市场份额的更新的例子包括以下内容：

与主要平台发布保持一致

每当主要平台发布新版本时，经过认证并更新以利用新功能的应用程序将看到下载量的增加。

提升应用在商店中的可见性

应用商店奖励那些频繁更新的应用程序，通过保留用户评分和突出新发布的方式。发布说明还为您在商店中增加可搜索内容提供了机会。相反，如果您的应用停滞不前没有更新，其在搜索引擎优化中的排名自然会下降。

提醒当前用户关于您的应用程序，以增加使用率

移动平台会提示用户更新其现有应用程序，并有时显示徽章或其他提醒，以增加用户参与度。

应用商店中排名靠前的应用程序知道持续更新的重要性并经常更新。根据[Appbot](https://oreil.ly/CdW2A)的数据，排名前 200 的免费应用中，自上次更新以来的中位时间为 7.8 天！在这种更新速度下，如果您不使用持续发布流程，将无法跟上步伐。

Java 开发者在构建移动应用程序时有很好的选择。这些选择包括专注于移动端的 Web 开发，使用响应式 Web 应用程序适配受限设备。其他选项包括专门为 Android 设备编写的 Java 移动应用程序。最后，还有几个跨平台的选项可用于在 Android 和 iOS 设备上构建应用程序，包括 Gluon Mobile 和 Electron。

本章主要关注 Android 应用程序开发。然而，所有这些基于 Java 的移动 DevOps 技术和考虑因素同样适用于这些平台。

# 移动端快速 DevOps 工作流

以下是投资于移动 DevOps 将实现的一些业务收益：

更好的客户体验

由于应用商店中易用且便捷的评分系统，客户体验至关重要。能够快速响应客户问题并在多种设备上进行测试，将确保最佳的客户体验。

更快的创新

通过持续发布到生产环境，您将能够以比竞争对手更高的速度将新功能和能力提供给客户。

更高的软件质量

鉴于 Android 设备的数量众多且碎片化严重，通过手动彻底测试您的应用程序是不可能的。但通过自动化的移动测试策略，覆盖用户群体的关键设备特性，您将能够减少最终用户报告的问题数量。

降低风险

现代应用程序中大多数可执行代码都有开源依赖项，这些依赖项会暴露您面临的已知安全漏洞。通过具备移动 DevOps 管道，允许您测试新版本的依赖项并频繁更新，您将能够在这些漏洞被利用之前快速修复应用程序中的问题。

本书其余部分提到的原则和最佳实践同样适用于移动应用程序开发，但由于市场的规模和期望，这些因素会放大 10 倍。在为 Android 设备规划移动 DevOps 管道时，以下是您需要考虑的阶段：

1.  构建。

    Android 构建脚本通常使用 Gradle 编写。因此，您可以使用您选择的任何持续集成服务器，包括 Jenkins、CircleCI、Travis CI 或 JFrog Pipelines。

1.  测试。

    单元测试

    Android 单元测试通常使用 JUnit 编写，可以轻松自动化。更高级别的 Android 单元测试通常使用一些 UI 测试框架，如 Espresso、Appium、Calabash 或 Robotium。

    集成测试

    除了测试您自己的应用程序外，还重要测试应用程序之间的交互，使用诸如 UI Automator 之类的工具进行集成测试，并可以跨多个 Android 应用程序进行测试。

    功能测试

    整体应用程序验证很重要。您可以手动执行此操作，但是自动化工具可以模拟用户输入，例如先前提到的 UI 自动化工具。另一种选择是运行像 Google 的 App 爬虫这样的机器人爬虫工具，以检查您的应用程序的用户界面并自动发出用户操作。

1.  打包。

    在打包步骤中，您需要聚合部署所需的所有脚本、配置文件和二进制文件。通过使用像 Artifactory 这样的软件包管理工具，您可以保留所有构建和测试信息，并轻松跟踪依赖关系以进行可追溯性和调试。

1.  发布。

    移动应用开发最好的部分之一是发布移动应用程序以结束应用商店提交; 最终部署到设备的管理由 Google Play 基础设施管理。具有挑战性的部分是您必须准备您的构建以确保应用商店提交成功，并且如果您没有完全自动化提交过程，构建、测试和打包中的任何错误都会导致延迟而受到惩罚。

正如您所看到的，Android 开发中 DevOps 的最大区别在于测试。对 Android 应用程序的 UI 测试框架进行了大量投资，因为自动化测试是解决在高度碎片化的设备生态系统中进行测试问题的唯一解决方案。我们将在下一节中了解到 Android 设备碎片化有多严重，并在本章后面讨论缓解这一问题的方法。

# Android 设备碎片化

iOS 生态系统受到 Apple 严格控制，限制了可用的硬件型号数量、屏幕大小的变化以及手机上的硬件传感器和功能集。自 2007 年首款 iPhone 推出以来，仅生产了 29 种不同的设备，其中仅有 7 种目前在售。

相比之下，Android 生态系统向众多设备制造商开放，他们定制从屏幕大小和分辨率到处理器和硬件传感器，甚至生产像折叠屏这样的独特形态因素的一切。来自 1,300 个不同制造商的超过 24,000 种不同设备，这比 iOS 设备的碎片化高出 1,000 倍。这使得为 Android 平台进行测试变得更加困难。

在碎片化方面，几个关键差异使得统一测试不同 Android 设备变得困难：

Android 版本

Android 设备制造商并不总是为旧设备提供最新的 Android 版本更新，因此用户可能会被困在旧的 Android 操作系统版本上，直到购买新设备。旧 Android 版本的使用减少是逐渐的，目前仍在运行 Android 4.*x* 版本的活跃设备超过七年，包括 Jelly Bean 和 KitKat。

屏幕尺寸和分辨率

Android 设备涵盖广泛的形态因素和硬件配置，趋势是向更大和像素密度更高的显示器发展。一个设计良好的应用程序需要能够在各种屏幕尺寸和分辨率下良好地扩展。

3D 支持

特别是对于游戏而言，了解设备在 API 和性能方面的 3D 支持水平至关重要。

硬件特性

大多数 Android 设备配备基本的硬件传感器（摄像头、加速计、GPS），但对于新的硬件 API（如近场通信（NFC）、气压计、磁力计、接近传感器、压力传感器、温度计等），支持有所不同。

## Android 操作系统碎片化

Android 版本碎片化影响设备测试的两个层面。首先是主要的 Android 版本，它决定了您需要构建和测试的 Android API 版本数量。第二个是由原始设备制造商（OEM）进行的操作系统定制，以支持特定的硬件配置。

对于 iOS 而言，由于苹果控制硬件和操作系统，它能够同时为所有支持的设备推送更新。这保持了针对性能和安全修复的小版本更新的高采纳率。苹果还在主要发布中投入了许多功能和市场推广，以快速推动用户群体升级到最新版本。因此，仅在初始发布后的七个月内，苹果就能够实现 iOS 14 的 [86% 采纳率](https://oreil.ly/3GYL8)。

Android 市场的复杂性显著增加，因为 OEM 修改并测试其设备的定制 Android OS 版本。此外，他们依赖于系统芯片（SoC）制造商为不同的硬件组件提供代码更新。这意味着主要供应商创建的设备可能仅会收到几个主要操作系统版本的更新，而小型供应商的设备即使在支持期内也可能永远不会看到操作系统升级。

为了帮助您决定支持不同 Android OS 版本的范围，Google 在 Android Studio 中提供了有关设备按 API 级别采用情况的信息。截至 2021 年 8 月的用户分布如图 9-2 所示。要实现与最新 iOS 版本相当的> 86％采用率，您需要至少支持 Android 5.1 Lollipop，这是 2014 年发布的一个版本。即使如此，您仍然错过了仍在使用基于 Android 4 的设备的超过 5％的用户。

![带有使用和功能信息的 Android 版本列表](img/dtjd_0902.png)

###### 图 9-2\. Android Studio 显示 Android 平台不同版本用户的分布（Android 11 采用率<1％）

更进一步复杂化情况的是，每个 OEM 都会修改其提供给设备的 Android OS，因此仅仅测试每个主要 Android 版本的一个设备是不够的。这是 Android 使用 Linux 内核访问硬件设备的方式导致的结果。

Linux 内核是操作系统的核心，并提供用于访问摄像头、加速计、显示器和设备上其他硬件的低级设备驱动程序代码。在 Google 基于的 Linux 内核中，Google 添加了 Android 特定的功能和补丁，SoC 供应商添加了硬件特定的支持，OEM 进一步为其特定设备修改了它。因此，每个设备在性能、安全性和可能影响应用程序的潜在错误方面都存在一定的变化范围，当用户在新设备上运行时可能会受到影响。

Google 致力于改善这种情况，通过 Android 8.0 Oreo，其中包括一个新的硬件抽象层，允许设备特定的代码在内核外运行。这使得 OEM 厂商可以在没有等待 SoC 供应商的设备驱动程序更新的情况下，从 Google 更新到新的 Android 内核版本，从而减少了操作系统升级所需的重新开发和测试的数量。然而，除了 Google 负责 OS 更新的 Pixel 设备外，大多数 Android 设备升级仍由 OEM 厂商掌控，它们仍然很慢地升级到新的 Android 版本。

## 构建不同屏幕尺寸的应用

鉴于在硬件制造商和超过 24,000 个型号中的多样性，如前一节所讨论的，屏幕尺寸和分辨率也存在巨大差异是毫不奇怪的。不断推出新的屏幕尺寸，例如使用 21.5 英寸触摸屏的巨大 HP Slate 21，以及带有垂直 1680 × 720 盖板显示器，打开后显示 2152 × 1536 分辨率的双宽内部显示器的三星 Galaxy Fold。

除了屏幕尺寸的巨大变化外，还存在着不断追求更高像素密度的战斗。更高的像素密度可以实现更清晰的文本和更锐利的图形，从而提供更好的视觉体验。

当前像素密度的领先者是 Sony Xperia XZ，在仅 5.2 英寸对角线的屏幕上配备了 3840 × 2160 的 UHS-1 显示屏。这使得像素密度达到 806.93 像素每英寸（PPI），接近人眼可区分的最大分辨率。

应用材料是 LCD 和 OLED 显示器的主要制造商之一，对手持显示器上的像素密度的人类感知进行了研究。它发现，在距离眼睛 4 英寸的距离上，20/20 视力的人能够区分 876 PPI。因此，智能手机显示屏迅速接近像素密度的理论极限；然而，其他形式因素如虚拟现实头显可能会进一步推动密度。

为了处理像素密度的变化，Android 将屏幕分类为以下像素密度范围：

ldpi，约 120 dpi（0.75 倍比例）

仅用于少数非常低分辨率设备，如 HTC Tattoo，Motorola Flipout 和 Sony X10 Mini，它们的屏幕分辨率为 240 × 320 像素。

mdpi，约 160 dpi（1 倍比例）

这是像 HTC Hero 和 Motorola Droid 这样的 Android 设备的原始屏幕分辨率。

tvdpi，约 213 dpi（1.33 倍比例）

电视分辨率，如 Google Nexus 7，但不被视为“主要”密度组。

hdpi，约 240 dpi（1.5 倍比例）

第二代手机，如 HTC Nexus One 和 Samsung Galaxy Ace，将分辨率提高了 50%。

xhdpi，约 320 dpi（2 倍比例）

第一批使用这种 2 倍分辨率的手机之一是 Sony Xperia S，随后是 Samsung Galaxy S III 和 HTC One 等手机。

xxhdpi，约 480 dpi（3 倍比例）

第一款 xxhdpi 设备是 Google 的 Nexus 10，它只有 300 dpi，但因为是平板形式，需要大图标。

xxxhdpi，约 640 dpi（4 倍比例）

这是像 Nexus 6 和 Samsung Galaxy S6 Edge 这样的设备目前使用的最高分辨率。

随着显示器像素密度的持续增加，Google 可能希望选择比仅添加更多*x*更好的高分辨率显示约定！

为了给最终用户提供最佳的用户体验，重要的是确保您的应用程序在所有可用分辨率下看起来和行为一致。考虑到各种屏幕分辨率的广泛变化，简单地为每种分辨率硬编码是不够的。

这里有一些最佳实践，确保您的应用程序在各种分辨率下都能正常工作：

+   始终使用密度独立和可伸缩像素：

    密度独立像素（dp）

    根据设备分辨率调整的像素单位。对于 mdpi 屏幕，1 像素（px）= 1 dp。对于其他屏幕分辨率，px = dp ×（dpi / 160）。

    可伸缩像素（sp）

    用于文本或其他用户可调整大小元素的可伸缩像素单位。它以 1 sp = 1 dp 开始，并根据用户定义的文本缩放值进行调整。

+   为所有可用分辨率提供备用位图：

    +   Android 允许您通过将其放入名为 *drawable-?dpi* 的子文件夹中来为不同分辨率提供备用位图，其中 *?dpi* 是支持的密度范围之一。

    +   对于应用程序图标也是如此，不过您应该使用名为 *mipmap-?dpi* 的子文件夹，以便在构建特定密度的 APK 时资源不被移除，因为应用程序图标通常会放大超出设备分辨率。

+   更好的做法是尽可能使用矢量图形：

    +   Android Studio 提供了一个名为 Vector Asset Studio 的工具，允许您将 SVG 或 PSD 文件转换为 Android 矢量文件，可以作为应用程序资源使用，如图 9-3 所示。

![Android Studio 中用于将 SVG 和 PSD 文件转换为矢量资源的对话框](img/dtjd_0903.png)

###### 图 9-3\. 将 SVG 文件转换为 Android 矢量格式

开发能够清晰适配不同屏幕尺寸和分辨率的应用程序是非常复杂的，需要仔细测试不同分辨率的设备。为了帮助集中测试工作，Google 提供了用户提取的[数据](https://oreil.ly/Aqw18)，显示了不同设备分辨率的使用情况，如表 9-1 所示。

表 9-1\. Android 屏幕大小和密度分布

|  | ldpi | mdpi | tvdpi | hdpi | xdpi | xxhdpi | 总计 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 小型 | 0.1% |  |  |  | 0.1% |  | 0.2% |
| 普通 |  | 0.3% | 0.3% | 14.8% | 41.3% | 26.1% | 82.8% |
| 大型 |  | 1.7% | 2.2% | 0.8% | 3.2% | 2.0% | 9.9% |
| 超大 |  | 4.2% | 0.2% | 2.3% | 0.4% |  | 7.1% |
| 总计 | 0.1% | 6.2% | 2.7% | 17.9% | 45.0% | 28.1% |  |

如您所见，某些分辨率并不常见，除非您的应用程序针对这些用户或遗留设备类型，否则可以从设备测试矩阵中删除它们。ldpi 分辨率仅用于 Android 设备的一小部分，并且市场份额仅为 0.1% —— 很少有应用程序针对这种非常小的分辨率屏幕进行优化。此外，tvdpi 是一种使用率仅为 2.7% 的小众屏幕分辨率，可以安全地忽略，因为 Android 将自动缩放 hdpi 资源以适应此屏幕分辨率。

这仍然需要您支持五种设备密度，并且可能需要测试无数种屏幕分辨率和宽高比。我稍后会讨论测试策略，但您可能需要同时使用模拟设备和物理设备，以确保在碎片化的 Android 生态系统中提供最佳用户体验。

## 硬件和 3D 支持

第一台 Android 设备是 HTC Dream（又称 T-Mobile G1），如图 9-4 所示。它具有中密度触摸屏，分辨率为 320 × 480 像素，硬件键盘、扬声器、麦克风、五个按钮、可点击的轨迹球和后置摄像头。虽然在现代智能手机标准下算是原始，但它是推出 Android 的良好平台，当时尚未支持软键盘。

与现代智能手机标准相比，这套硬件设备显得比较适中。驱动 HTC Dream 的高通 MSM7201A 处理器是一款 528 MHz Arm11 处理器，仅支持 OpenGL ES 1.1。相比之下，三星 Galaxy S21 Ultra 5G 配备 3200 × 1440 分辨率屏幕和以下传感器：

+   2.9 GHz 8 核处理器

+   Arm Mali-G78 MP14 GPU，支持 Vulkan 1.1、OpenGL ES 3.2 和 OpenCL 2.0

+   五个摄像头（一个前置，四个后置）

+   三个麦克风（一个底部，两个顶部）

+   立体声扬声器

+   超声波指纹识别器

+   加速度计

+   气压计

+   陀螺仪传感器（陀螺仪）

+   地磁传感器（磁力计）

+   Hall 传感器

+   接近传感器

+   环境光传感器

+   NFC

![显示智能手机的照片，显示屏幕已收起，显示出硬件键盘。](img/dtjd_0904.png)

###### 图 9-4\. T-Mobile G1（又名 HTC Dream），这是第一款运行 Android 操作系统的智能手机（照片在[创意共享许可](https://oreil.ly/GLSPZ)下使用）

三星旗舰手机在硬件支持方面处于高端，包括几乎所有支持的传感器类型。面向大众市场的手机可能选择使用性能较低的芯片组，并省略一些传感器以降低成本。Android 使用可用物理传感器的数据还在软件中创建“虚拟”传感器，应用程序使用这些传感器：

游戏旋转向量

由加速度计和陀螺仪数据的组合

重力

由加速度计和陀螺仪（如果没有陀螺仪，则为磁力计）数据的组合

地磁旋转向量

由加速度计和磁力计数据的组合

线性加速度

由加速度计和陀螺仪（如果没有陀螺仪，则为磁力计）数据的组合

旋转向量

由加速度计、磁力计和陀螺仪数据的组合

显著动作

由加速度计数据（在低功耗模式下可能替代其他传感器数据）

步数检测器/计数器

由加速度计数据（在低功耗模式下可能替代其他传感器数据）

这些虚拟传感器仅在足够的物理传感器集合存在时才可用。大多数手机包含加速度计，但可能选择省略陀螺仪或磁力计或两者，从而降低运动检测的精度并禁用某些虚拟传感器。

硬件传感器可以模拟，但要模拟测试真实世界条件则更加困难。此外，硬件芯片组和 SoC 供应商驱动程序的实现有很大差异，需要大量测试矩阵以验证应用程序在各种设备上的运行。

对于游戏开发人员尤为重要的硬件另一个方面，但越来越成为基本图形堆栈和应用程序预期性能的一部分，是 3D API 支持。几乎所有移动处理器都支持一些基本的 3D API，包括第一款 Android 手机，支持 OpenGL ES 1.1，这是 OpenGL 3D 标准的移动特定版本。现代手机支持 OpenGL ES 标准的较新版本，包括 OpenGL ES 2.0、3.0、3.1，以及现在的 3.2 版本。

OpenGL ES 2.0 引入了编程模型的显著转变，从功能管线转变为可编程管线，通过着色器的使用允许更直接的控制来创建复杂效果。OpenGL ES 3.0 通过支持顶点数组对象、实例化渲染和设备独立压缩格式（ETC2/EAC）等功能，进一步提高了 3D 图形的性能和硬件独立性。

OpenGL ES 的采用速度相当快，所有现代设备至少支持 OpenGL ES 2.0。根据 Google 在图 9-5 中展示的设备数据，大多数设备（67.54%）支持 OpenGL ES 3.2，这是 2015 年 8 月发布的标准的最新版本。

![显示 OpenGL ES 版本采用的饼状图](img/dtjd_0905.png)

###### 图 9-5\. Android 设备采用不同版本 OpenGL ES 的百分比，来自[Google 的分布仪表板](https://oreil.ly/18xDQ)

Vulkan 是一种现代图形芯片组支持的新的图形 API。它具有在桌面和移动设备之间可移植性的优势，随着计算平台继续融合，更容易移植桌面代码。此外，它允许更精细的线程和内存管理控制，以及用于跨多个线程缓冲和排序命令的异步 API，更好地利用多核处理器和高端硬件。

由于 Vulkan 是一种较新的 API，其采用速度不及 OpenGL ES 快；但是，64%的 Android 设备具有某种程度的 Vulkan 支持。根据 Google 在图 9-6 中可视化的设备统计数据，这分为支持 42%设备的 Vulkan 1.1 版本，以及仅支持 Vulkan 1.0.3 API 级别的剩余 22%设备。

与硬件传感器测试类似，许多不同制造商实现了大量的 3D 芯片组。因此，在您的应用程序中可靠地测试错误和性能问题的唯一方法是在不同手机型号上执行设备测试，将在下一节中详述。

![显示 Vulkan 版本采用的饼状图](img/dtjd_0906.png)

###### 图 9-6\. Android 设备采用不同版本 Vulkan 的百分比，来自[Google 的分布仪表板](https://oreil.ly/K9FZd)

# 在并行设备上进行持续测试

前面的部分讨论了 Android 设备生态系统中的大量碎片化。这是由技术因素（如 Android 操作系统架构）以及 OEM 和 SoC 供应商复杂的生态系统所迫使的。另外，Android 平台的普及度极高，有 1,300 多家制造商生产超过 24,000 种设备，这造成了持续的测试和部署挑战。

设备仿真器适用于开发和应用程序的基本测试，但无法模拟独特硬件配置、设备驱动程序、定制内核和真实传感器行为的复杂交互。因此，需要在设备上进行高水平的手动和自动化测试，以确保终端用户获得良好的体验。

在硬件规模测试中有两种基本方法。第一种是建立共享设备的设备实验室。这是一个实用的方法来开始测试，因为您可能已经有大量可用的 Android 设备，通过适当的基础设施和自动化可以更好地利用这些设备。然而，根据您想支持的设备配置数量，这可能是一个相当大而昂贵的事业。此外，对于一个大型设备农场的持续维护和维护在材料和劳动力方面都是昂贵的。

第二个选项是将设备测试外包给云服务。考虑到远程控制 Android 设备的进展以及平台的稳定性，能够选择设备矩阵并在云中触发自动化测试是很方便的。大多数云服务提供详细的屏幕截图和诊断日志，可以用于跟踪构建失败，并且可以手动控制设备进行调试。

## 建设设备农场

即使只是小规模地建立自己的设备农场，也是充分利用您已有的 Android 设备并增加其在整个组织中效用的好方法。在大规模运作时，设备农场可以显著降低 Android 开发的运行成本，一旦您投入了硬件的前期投资。但请记住，管理一个大型设备实验室是一项全职工作，并且有持续的成本需要考虑。

用于管理 Android 设备的流行开源库是 Device Farmer（前身为 Open STF）。Device Farmer 允许您通过 Web 浏览器远程控制 Android 设备，实时查看设备屏幕，如 图 9-7 所示。对于手动测试，您可以从桌面键盘输入，并使用鼠标输入单点触摸或多点触控手势。对于自动化测试，REST API 允许您使用像 Appium 这样的测试自动化框架。

![在会议上建立的志愿者设备实验室的图片](img/dtjd_0907.png)

###### 图 9-7\. Device Farmer 的 [用户界面](https://oreil.ly/2MQpN)（照片使用 [知识共享](https://oreil.ly/bPhIL) 许可）

Device Farmer 还帮助你管理设备清单。它会显示已连接的设备、每个设备的使用者以及你设备的硬件规格，并协助在大型实验室中物理定位设备。

最后，Device Farmer 还有一个预订和分区设备组的系统。你可以将你的设备清单分成具有所有者和相关属性的不同组。这些组可以永久分配给项目或组织，也可以预订一段特定的时间。

要建立一个设备实验室，你还需要硬件来支持这些设备。基本的硬件设置包括以下内容：

驱动计算机

即使 Device Farmer 可以在任何操作系统上运行，但建议在基于 Linux 的主机上运行，以便管理和最佳稳定性。一个很好的开始选项是像 Intel NUC 这样的小巧但功能强大的计算机。

USB 集线器

为了设备的连接和稳定供电，建议使用一个带电源的 USB 集线器。获得可靠的 USB 集线器很重要，因为这会影响到你实验室的稳定性。

无线路由器

设备将通过无线路由器获取网络连接，因此这是设备设置中的一个重要部分。为你的设备拥有一个专用的网络将增加可靠性，并减少与网络上其他设备的争用。

安卓设备

当然，最重要的部分是有大量的安卓设备进行测试。从与你的目标用户群最常见和最受欢迎的设备开始，并根据前面部分讨论的 Android 操作系统版本、屏幕尺寸和硬件支持来添加设备，以达到所需的测试矩阵。

大量的电缆

你需要比平常更长的电缆来有效管理设备与 USB 集线器的连接。在设备和硬件组件之间留出足够的空间以避免过热是很重要的。

通过一点点工作，你将能够创建一个类似于图 9-8 的完全自动化设备实验室，这是世界上第一个在德国杜塞尔多夫举行的 beyond tellerrand 大会上展示的设备实验室。

![会议上自愿建造的设备实验室的图片](img/dtjd_0908.png)

###### 图 9-8\. [开放设备实验室](https://oreil.ly/QgEr9) 在德国杜塞尔多夫举行的 beyond tellerrand 大会上（照片使用[知识共享许可](https://oreil.ly/Xv18U)）

设备农民被分为微服务，以支持平台的可伸缩性，可扩展到数千台设备。直接使用，它轻松支持 15 台设备，之后您将遇到 Android 调试桥（ADB）的端口限制。可以通过运行多个 Device Farmer ADB 和 Provider 服务的实例来扩展到您的机器支持的 USB 设备数量限制。对于 Intel 架构，这是 96 个端点（包括其他外围设备），对于 AMD，可以达到 254 个 USB 端点。通过使用多个 Device Farmer 服务器，您可以扩展到数千台设备，这应该足以支持企业 Android 应用的移动测试和验证。

一个大规模移动设备实验室的示例是 Facebook 在其俄勒冈州 Prineville 数据中心的移动设备实验室，如图 9-9 所示。该公司构建了一个客户服务器机架封装来容纳移动设备，设计用于阻挡 WiFi 信号，以防止数据中心设备之间的干扰。每个封装可以支持 32 台设备，由 4 台 OCP Leopard 服务器供电，并连接到设备。这提供了一个稳定且可扩展的硬件设置，使公司能够达到其 2000 台设备的目标设备农场规模。

![一张数据中心中装有机架式设备的照片。](img/dtjd_0909.png)

###### 图 9-9\. Facebook 在其 Prineville 数据中心的移动设备实验室（[Antoine Reversat 拍摄的照片](https://oreil.ly/fbj35)）

运行大规模设备实验室存在一些挑战：

设备维护

安卓设备不适合全天候自动化测试。因此，您可能会经历比正常情况更高的设备故障，并且每一两年需要更换电池或整个设备。合理间隔设备并保持良好的冷却有助于解决这个问题。

WiFi 干扰/连接性

WiFi 网络，尤其是面向消费者的 WiFi 路由器，稳定性不高，特别是在设备数量较多的情况下。降低 WiFi 路由器的广播信号功率，并确保它们处于不竞争的网络频段，可以减少干扰。

网线布线

在所有设备和 USB 集线器或计算机之间布线可能会造成一团乱麻。除了难以维护外，这也可能导致连接和充电问题。确保移除所有电缆中的环圈，并根据需要使用屏蔽电缆和铁氧体磁芯以减少电磁干扰。

设备可靠性

在消费设备上运行设备实验室有普遍风险，因为消费设备不够可靠。将自动化测试运行限制在有限的时间段内有助于防止测试因设备无响应而被阻塞。在测试之间，进行一些清理工作以删除数据并释放内存有助于提升性能和可靠性。最后，需要定期重新启动安卓设备及其运行它们的服务器。

###### 小贴士

从您已拥有的设备开始，逐步扩展规模，并能够跨范围设备进行测试并并行启动自动化测试。在大规模上，这是解决跨碎片化的 Android 生态系统进行测试的有效解决方案，但需要高昂的前期成本及持续的支持和维护。

接下来的部分讨论了可以立即在简单的按需付费基础上开始使用的设备实验室。

## 云中的移动管道

如果搭建自己的设备实验室似乎令人望而却步，那么一个简单且低成本的方法是使用运行在公共云基础设施上的设备农场，以跨大范围设备进行测试。移动设备云的优势在于易于开始和对最终用户无需维护。您只需选择要运行测试的设备，并对您的应用程序针对设备池进行手动或自动化测试。

一些移动设备云还支持自动化机器人测试，这些测试将尝试操作应用程序的所有可见 UI 元素，以识别应用程序的性能或稳定性问题。测试运行后，您将获得任何失败的完整报告、用于调试的设备日志以及用于追踪问题的屏幕截图。

许多移动设备云可供选择，其中一些可以追溯到功能手机时代。然而，最受欢迎和现代化的设备云已经与三大主要云服务提供商——亚马逊、谷歌和微软——达成了一致。它们都在移动测试基础设施上投入了大量资金，您可以以合理的价格尝试并使用大量模拟和真实设备进行测试。

### AWS 设备农场

亚马逊提供了作为其公共云服务一部分的移动设备云。通过使用 AWS 设备农场，您可以在各种真实设备上使用您的 AWS 账户运行自动化测试。

创建新的 AWS 设备农场测试的步骤如下：

1.  *上传您的 APK 文件*：首先，上传您编译的 APK 文件或从最近更新的文件中选择。

1.  *配置您的测试自动化*：AWS 设备农场支持多种测试框架，包括使用 Java、Python、Node.js 或 Ruby 编写的 Appium 测试，以及 Calabash、Espresso、Robotium 或 UI Automator。如果您没有自动化测试，AWS 提供了两个名为 Fuzz 和 Explorer 的机器人应用测试工具。

1.  *选择要运行的设备*：从用户创建的设备池或默认的五款最流行设备池中选择要在其上运行测试的设备，如图 9-10 所示。

1.  *设置设备状态*：在开始测试之前设置设备状态，您可以指定要安装的数据或其他依赖应用程序，设置无线电状态（WiFi、蓝牙、GPS 和 NFC），更改 GPS 坐标、更改语言环境并设置网络配置文件。

1.  *运行你的测试*: 最后，你可以在所选设备上运行测试，每台设备的执行超时时间可长达 150 分钟。如果你的测试执行速度更快，测试将提前结束，但同时也设置了测试运行成本的最大上限。

![在 AWS Device Farm 上创建新运行的截图。](img/dtjd_0910.png)

###### 图 9-10\. 在 AWS Device Farm 向导中选择要运行的设备

AWS Device Farm 为个人开发者提供免费的配额以启动测试自动化，额外设备测试按分钟计费，还有月度计划可同时在多台设备上进行并行测试。所有这些计划都基于共享设备池运行，截至撰写本文时，共有 91 台设备，其中 54 台为安卓设备，如图 9-11 所示。然而，大多数这些设备都具有高可用性，这意味着它们有大量相同的设备可供测试。这意味着你不太可能在队列中被阻塞，或者需要测试的设备不可用。

![设备表格的截图。](img/dtjd_0911.png)

###### 图 9-11\. AWS Device Farm 中可用设备的列表

最后，AWS Device Farm 提供了几种集成方式来运行自动化测试。从 Android Studio 内部，你可以使用其 Gradle 插件在 AWS Device Farm 上运行测试。如果你希望从持续集成系统启动 AWS Device Farm 测试，亚马逊提供了一个 Jenkins 插件，你可以在本地构建和自动化测试完成后立即使用它来启动设备测试。

### Google Firebase Test Lab

在 Google 收购 Firebase 后，其一直在不断扩展和改进其提供的功能。Firebase Test Lab 是其移动设备测试平台，提供与 AWS Device Farm 类似的功能。开始时，Google 为开发者提供免费的配额，每天运行有限数量的测试。超出此配额后，你可以升级到按设备小时计费的按需付费计划。

Firebase Test Lab 提供了几种可以启动服务上的测试的方式：

Android Studio

Firebase Test Lab 已集成在 Android Studio 中，使你能够在其移动设备云中轻松运行测试，就像在本地设备上运行一样。

Firebase Web UI

从 Firebase 网页控制台，你可以上传你的 APK，并将从运行你的第一个应用程序开始进行自动化的 Robo 测试，如图 9-12 所示。此外，你可以使用 Espresso、Robotium 或 UI Automator 运行你自己的自动化测试。游戏开发者可以选择运行模拟用户场景的集成游戏循环。

自动化命令行脚本

你可以通过使用其命令行 API 将 Firebase Test Lab 轻松集成到你的 CI 系统中。这使你能够与 Jenkins、CircleCI、JFrog Pipelines 或你喜欢的 CI/CD 系统集成。

![Firebase 网页控制台测试应用程序的截图。](img/dtjd_0912.png)

###### 图 9-12\. Firebase web 用户界面运行自动化 Robo 测试

在撰写本文时，Firebase 测试实验室提供了比 AWS 设备农场更多的 Android 设备，支持 109 种设备，并支持流行设备的多个 API 级别。鉴于与 Google 的 Android 工具集成紧密以及个人免费配额的慷慨，这是一个让您的开发团队开始构建测试自动化的简单方法。

### Microsoft Visual Studio App Center

Microsoft Visual Studio App Center，前身为 Xamarin 测试云，在所有云服务中提供了最令人印象深刻的设备列表，拥有 349 种 Android 设备类型供您进行测试，如图 9-13 所示。然而，与 AWS 设备农场和 Firebase 测试实验室不同，Microsoft 没有为开发者提供免费的使用服务层。Microsoft 确实为其服务提供了 30 天的试用期，用于使用单个物理设备进行测试，并且有按并发设备数量付费的计划，这对大型企业是合理的选择。

![VS App Center 中设备列表的屏幕截图。](img/dtjd_0913.png)

###### 图 9-13\. Visual Studio App Center 设备选择屏幕

Visual Studio App Center 也缺少一些用户友好的功能，比如机器人测试和通过 Web 控制台简单执行测试。相反，它专注于与 App Center CLI 的命令行集成。从 App Center CLI，您可以轻松地使用 Appium、Calabash、Espresso 或 XamarinUITest 启动自动化测试。此外，这使得与 CI/CD 工具的集成变得简单直接。

总体而言，Visual Studio App Center 在设备覆盖率上胜出，并且明确专注于企业移动设备测试。然而，对于独立开发者或较小团队来说，它不太易接近，并且前期成本较高，但在扩展过程中将表现良好。

## 设备测试策略的规划

现在您已经了解了设置自己的设备实验室并利用云基础设施的基础知识，您应该更清楚这些如何映射到您的移动设备测试需求。

这些是选择云服务的优势：

初创成本低

云计划通常为开发者提供有限数量的免费设备测试，并提供基于利用率的定价来进行设备测试。在开始设备测试时，这是开始探索手动和自动化设备测试的最简单和成本最低的方法。

大量设备选择

由于云测试提供商支持大量的客户安装基地，他们拥有大量的当前和传统的手机库存进行测试。这使得能够精确地针对您的用户最有可能拥有的设备类型、配置和配置文件进行测试成为可能。

快速扩展

应用开发主要是关于病毒营销和快速扩展。与其一开始投资昂贵的基础设施，云服务允许您根据应用程序的大小和流行度需求扩展测试，需要更大的设备测试矩阵。

降低资本支出

建立一个大型设备实验室是一项高昂的前期资本支出。通过按需支付云基础设施费用，您可以延迟成本，最大化您的资本效率。

全球访问

随着远程和分布式团队成为常态，云服务的设计允许您的整个团队轻松访问，无论他们位于何处。

然而，即使有了所有这些好处，建立设备实验室的传统方法也具有独特的优势。以下是您可能希望建立自己设备实验室的一些原因：

规模化降低成本

运行和维护规模化设备实验室的总拥有成本远低于设备可用寿命期间从云服务提供商处支付的总月费用。对于小团队来说，这个门槛很难达到，但如果你是一个大型移动公司，这将是显著的节省。

快速和可预测的周期时间

控制设备农场，您可以保证测试并行运行，并在可预测的时间范围内完成，以支持响应性构建。云服务提供商的设备可用性有限，并且流行配置的排队等待时间可能会限制您快速迭代的能力。

无会话限制

设备云通常会对其服务设置硬编码会话限制，以防止因测试或设备故障而导致测试挂起。随着测试套件复杂性的增加，30 分钟的硬限制可能会成为完成复杂用户流程测试的障碍。

法规要求

在金融和国防等特定受监管行业，安全要求可能会限制或禁止在企业防火墙之外部署应用程序和执行测试的能力。这类公司需要一个本地设备实验室设置。

物联网设备集成

如果您的用例要求将移动设备与物联网设备和传感器集成，这不是云服务提供商能够直接提供的配置。您可能最好创建一个设备实验室，配置最适合您实际场景的物联网和移动配置。

###### 提示

在某些情况下，同时进行云测试和本地设备实验室测试也是有意义的。根据您对周期时间、维护成本、设备扩展和法规要求的具体需求，这可以让您同时获得两种测试方法的最佳效果。

# 总结

Android 是全球最流行的移动平台，因其庞大的制造商和应用开发者生态系统。然而，这也是 Android 开发面临的挑战之一：一个拥有数千家制造商生产数万款设备的极度分散的设备市场。鉴于这种规模的碎片化和设备不一致性，对于移动开发的成功来说，拥有完全自动化的移动开发运维管道是必不可少的。

在 Web 应用程序开发中，类似于 DevOps 的等价物是，如果不是三种主要的浏览器，而是成千上万种独特的浏览器类型。你将被迫自动化以获得任何质量保证水平，这正是为什么在移动领域如此关注在真实设备上运行的 UI 测试自动化的原因。

使用本章学到的工具和技术，结合整体的 DevOps 知识，包括源代码控制、构建推广和安全性，你应该领先于你的移动 DevOps 同行，以面对全球数百万设备的持续部署挑战。
