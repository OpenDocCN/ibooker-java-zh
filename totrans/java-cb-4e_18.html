<html><head></head><body><section data-pdf-bookmark="Chapter 18. Using Java with Other Languages" data-type="chapter" epub:type="chapter"><div class="chapter" id="javacook-otherlang">&#13;
<h1><span class="label">Chapter 18. </span>Using Java with Other Languages</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.0 Introduction" data-type="sect1"><div class="sect1" id="javacook-otherlang-intro">&#13;
<h1>18.0 Introduction</h1>&#13;
&#13;
<p><a data-primary="Java" data-secondary="using with other languages" data-type="indexterm" id="jav_uol"/>Java has several methods of running programs written in other languages. You can invoke a compiled program or executable script using <code>Runtime.exec()</code>, as I’ll describe in <a data-type="xref" href="#javacook-otherlang-SECT-1">Recipe 18.1</a>.&#13;
There is an element of system dependency here, because you can only run external applications&#13;
under the operating system they are compiled for.&#13;
Alternatively, you can invoke one of a number of scripting languages <a data-primary="dynamic languages" data-type="indexterm" id="idm45290622383576"/>(or <em>dynamic languages</em>)—running the gamut: awk, bsh, Clojure, Ruby, Perl, Python, Scala—using <code>javax.script</code>, as illustrated in <a data-type="xref" href="#javacook-otherlang-scripting">Recipe 18.3</a>.&#13;
Or you can drop down to C level with Java’s <a data-primary="native code" data-type="indexterm" id="idm45290622381064"/><em>native code</em> mechanism and call compiled functions written in  C/C++; see <a data-type="xref" href="#javacook-otherlang-SECT-5">Recipe 18.6</a>.&#13;
From native code, you can call to functions written in just about any language. Not to mention that you can contact programs written in any language over a socket (see <a data-type="xref" href="ch13.html#javacook-netserver">Chapter 13</a>), with HTTP services (see <a data-type="xref" href="ch13.html#javacook-netserver">Chapter 13</a>), or with Java clients in RMI or CORBA clients in a variety of languages.</p>&#13;
&#13;
<p>There is a wide range of other JVM languages, including these:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a data-primary="BeanShell" data-type="indexterm" id="idm45290622376056"/>BeanShell, a general scripting language for Java.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Groovy" data-type="indexterm" id="idm45290622374520"/><a href="https://groovy-lang.org">Groovy</a> is a Java-based scripting language that pioneered the use of closures in the Java language ecosystem.&#13;
It also has a rapid-development web package called <a data-primary="Grails" data-type="indexterm" id="idm45290622372984"/><a href="http://grails.org">Grails</a> and a build tool called <a data-primary="Gradle" data-secondary="about" data-type="indexterm" id="idm45290622371624"/>Gradle (see <a data-type="xref" href="ch01.html#javacook-getstarted-gradle">Recipe 1.8</a>).&#13;
Gradle is also used as the build tool in modern Android development.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Jython" data-type="indexterm" id="idm45290622368840"/><a href="http://jython.org">Jython</a>, a full Java implementation of Python.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="JRuby" data-type="indexterm" id="idm45290622366744"/><a href="http://jruby.org">JRuby</a>, a full Java implementation of the Ruby language.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Scala" data-type="indexterm" id="idm45290622364584"/><a href="http://scala-lang.org">Scala</a>, a JVM language that claims to offer the “best of functional and OO” languages.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Clojure" data-type="indexterm" id="idm45290622362488"/><a href="http://clojure.org">Clojure</a>, a predominantly functional&#13;
<a href="https://en.wikipedia.org/wiki/Common_Lisp#The_function_namespace">Lisp-1</a> dialect for the JVM.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Renjin" data-type="indexterm" id="idm45290622359576"/><a href="http://renjin.org">Renjin</a> (pronounced “R engine”), a fairly complete open source clone of the R statistics package&#13;
with the ability to scale to the cloud.&#13;
See <a data-type="xref" href="ch11.html#javacook-ds-r-within-java">Recipe 11.5</a> for an example using Renjin.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These are JVM-centric, and some can be called directly from Java to script, or vice versa, without using <code>javax.script</code>. A list of these languages can be found on <a href="http://en.wikipedia.org/wiki/List_of_JVM_languages"><span class="keep-together">Wikipedia</span></a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.1 Running an External Program from Java" data-type="sect1"><div class="sect1" id="javacook-otherlang-SECT-1">&#13;
<h1>18.1 Running an External Program from Java</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Java" data-secondary="running external programs from" data-type="indexterm" id="jav_rep"/>You want to run an external program from within a Java program.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use one of the <a data-primary="exec() method" data-type="indexterm" id="idm45290622348200"/><code>exec()</code> methods in the <code>java.lang.Runtime</code> class.&#13;
Or set up a <code>ProcessBuilder</code> and call its <a data-primary="start() method" data-type="indexterm" id="idm45290622346184"/><code>start()</code> method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-1.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>exec()</code> method in the <code>Runtime</code> class lets you run an external program. The command line you give is broken into  strings by a simple <code>StringTokenizer</code> (see <a data-type="xref" href="ch03.html#javacook-strings-SECT-1">Recipe 3.1</a>) and passed on to the operating system’s “execute a program” system call. As an example, here is a simple program that uses <code>exec()</code> to run <em>kwrite</em>, a windowed  text editor program.<sup><a data-type="noteref" href="ch18.html#idm45290622339272" id="idm45290622339272-marker">1</a></sup> On Windows, you’d have to change the name to <code>notepad</code> or <code>wordpad</code>, possibly including the full pathname, for example, <em>c:/windows/notepad.exe</em> (you can also use backslashes, but be careful to double them because the backslash is special in Java strings):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ExecDemoSimple</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code> <code class="n">av</code><code class="o">[])</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
&#13;
        <code class="c1">// Run the "notepad" program or a similar editor</code>&#13;
        <code class="n">Process</code> <code class="n">p</code> <code class="o">=</code> <code class="n">Runtime</code><code class="o">.</code><code class="na">getRuntime</code><code class="o">().</code><code class="na">exec</code><code class="o">(</code><code class="s">"kwrite"</code><code class="o">);</code>&#13;
&#13;
        <code class="n">p</code><code class="o">.</code><code class="na">waitFor</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>When you compile and run it, the appropriate editor window appears:</p>&#13;
<pre data-type="programlisting" id="I_26_tt668">&#13;
$ <strong>javac -d . ExecDemoSimple.java</strong>&#13;
$ <strong>java otherlang.ExecDemoSimple </strong># causes a KWrite window to appear.&#13;
$</pre>&#13;
&#13;
<p>This version of <code>exec()</code> assumes that the pathname contains no blanks because these break proper operation of the <code>StringTokenizer</code>. To overcome this potential problem, use an overloaded form of <code>exec()</code>, taking an array of strings as arguments. <a data-type="xref" href="#javacook-otherlang-EX-1">Example 18-1</a> runs the Windows or  Unix version of the Firefox web browser, assuming that Firefox was installed in the default directory (or another directory that is on your <code>PATH</code>). It passes the name of a help file as an argument, offering a kind of primitive help mechanism, as displayed in <a data-type="xref" href="#javacook-otherlang-FIG-1">Figure 18-1</a>.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-1">&#13;
<h5><span class="label">Example 18-1. </span>main/src/main/java/otherlang/ExecDemoNS.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ExecDemoNS</code> <code class="kd">extends</code> <code class="n">JFrame</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BROWSER</code> <code class="o">=</code> <code class="s">"firefox"</code><code class="o">;</code>&#13;
&#13;
    <code class="n">Logger</code> <code class="n">logger</code> <code class="o">=</code> <code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">ExecDemoNS</code><code class="o">.</code><code class="na">class</code><code class="o">.</code><code class="na">getSimpleName</code><code class="o">());</code>&#13;
&#13;
    <code class="cm">/** The name of the help file. */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">HELPFILE</code> <code class="o">=</code> <code class="s">"./help/index.html"</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** A stack of process objects; each entry tracks one running process */</code>&#13;
    <code class="n">Stack</code><code class="o">&lt;</code><code class="n">Process</code><code class="o">&gt;</code> <code class="n">pStack</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Stack</code><code class="o">&lt;&gt;();</code>&#13;
&#13;
    <code class="cm">/** main - instantiate and run */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code> <code class="n">av</code><code class="o">[])</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">program</code> <code class="o">=</code> <code class="n">av</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code> <code class="o">?</code> <code class="n">BROWSER</code> <code class="o">:</code> <code class="n">av</code><code class="o">[</code><code class="mi">0</code><code class="o">];</code>&#13;
        <code class="k">new</code> <code class="nf">ExecDemoNS</code><code class="o">(</code><code class="n">program</code><code class="o">).</code><code class="na">setVisible</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** The path to the binary executable that we will run */</code>&#13;
    <code class="kd">protected</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">program</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** Constructor - set up strings and things. */</code>&#13;
    <code class="kd">public</code> <code class="nf">ExecDemoNS</code><code class="o">(</code><code class="n">String</code> <code class="n">program</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="kd">super</code><code class="o">(</code><code class="s">"ExecDemo: "</code> <code class="o">+</code> <code class="n">program</code><code class="o">);</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">program</code> <code class="o">=</code> <code class="n">program</code><code class="o">;</code>&#13;
&#13;
        <code class="n">Container</code> <code class="n">cp</code> <code class="o">=</code> <code class="n">getContentPane</code><code class="o">();</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">setLayout</code><code class="o">(</code><code class="k">new</code> <code class="n">FlowLayout</code><code class="o">());</code>&#13;
        <code class="n">JButton</code> <code class="n">b</code><code class="o">;</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">b</code><code class="o">=</code><code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Exec"</code><code class="o">));</code>&#13;
        <code class="n">b</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="n">runProgram</code><code class="o">());</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">b</code><code class="o">=</code><code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Wait"</code><code class="o">));</code>&#13;
        <code class="n">b</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="n">doWait</code><code class="o">());</code>&#13;
        <code class="n">cp</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">b</code><code class="o">=</code><code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Exit"</code><code class="o">));</code>&#13;
        <code class="n">b</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">0</code><code class="o">));</code>&#13;
        <code class="n">pack</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Start the help, in its own Thread. */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">runProgram</code><code class="o">()</code> <code class="o">{</code>&#13;
&#13;
        <code class="k">new</code> <code class="nf">Thread</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
&#13;
                <code class="k">try</code> <code class="o">{</code>&#13;
                    <code class="c1">// Get a "file:" URL for the Help File</code>&#13;
                    <code class="n">URL</code> <code class="n">helpURL</code> <code class="o">=</code> <code class="k">this</code><code class="o">.</code><code class="na">getClass</code><code class="o">().</code><code class="na">getClassLoader</code><code class="o">().</code>&#13;
                        <code class="n">getResource</code><code class="o">(</code><code class="n">HELPFILE</code><code class="o">);</code>&#13;
&#13;
                    <code class="c1">// Start the external browser from the Java Application.</code>&#13;
&#13;
                    <code class="n">String</code> <code class="n">osname</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">getProperty</code><code class="o">(</code><code class="s">"os.name"</code><code class="o">);</code>&#13;
                    <code class="n">String</code> <code class="n">run</code><code class="o">;</code>&#13;
                    <code class="k">if</code> <code class="o">(</code><code class="s">"Mac OS X"</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">osname</code><code class="o">))</code> <code class="o">{</code>&#13;
                        <code class="n">run</code> <code class="o">=</code> <code class="s">"open -a "</code> <code class="o">+</code> <code class="n">program</code><code class="o">;</code>&#13;
                        <code class="c1">// "if" allows for other OSes needing special handling</code>&#13;
                    <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                        <code class="n">run</code> <code class="o">=</code> <code class="n">program</code><code class="o">;</code>&#13;
                    <code class="o">}</code>&#13;
&#13;
                    <code class="n">pStack</code><code class="o">.</code><code class="na">push</code><code class="o">(</code><code class="n">Runtime</code><code class="o">.</code><code class="na">getRuntime</code><code class="o">().</code><code class="na">exec</code><code class="o">(</code><code class="n">run</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">helpURL</code><code class="o">));</code>&#13;
&#13;
                    <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"In main after exec "</code> <code class="o">+</code> <code class="n">pStack</code><code class="o">.</code><code class="na">size</code><code class="o">());</code>&#13;
&#13;
                <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">JOptionPane</code><code class="o">.</code><code class="na">showMessageDialog</code><code class="o">(</code><code class="n">ExecDemoNS</code><code class="o">.</code><code class="na">this</code><code class="o">,</code>&#13;
                        <code class="s">"Error"</code> <code class="o">+</code> <code class="n">ex</code><code class="o">,</code> <code class="s">"Error"</code><code class="o">,</code>&#13;
                        <code class="n">JOptionPane</code><code class="o">.</code><code class="na">ERROR_MESSAGE</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}.</code><code class="na">start</code><code class="o">();</code>&#13;
&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">doWait</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">pStack</code><code class="o">.</code><code class="na">size</code><code class="o">()</code> <code class="o">==</code> <code class="mi">0</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Nothing to wait for."</code><code class="o">);</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Waiting for process "</code> <code class="o">+</code> <code class="n">pStack</code><code class="o">.</code><code class="na">size</code><code class="o">());</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Process</code> <code class="n">p</code> <code class="o">=</code> <code class="n">pStack</code><code class="o">.</code><code class="na">pop</code><code class="o">();</code>&#13;
            <code class="n">p</code><code class="o">.</code><code class="na">waitFor</code><code class="o">();</code>&#13;
            <code class="c1">// wait for process to complete</code>&#13;
            <code class="c1">// (may not work as expected for some old Windows programs)</code>&#13;
            <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"Process "</code> <code class="o">+</code> <code class="n">p</code> <code class="o">+</code> <code class="s">" is done."</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">JOptionPane</code><code class="o">.</code><code class="na">showMessageDialog</code><code class="o">(</code><code class="k">this</code><code class="o">,</code>&#13;
                <code class="s">"Error"</code> <code class="o">+</code> <code class="n">ex</code><code class="o">,</code> <code class="s">"Error"</code><code class="o">,</code>&#13;
                <code class="n">JOptionPane</code><code class="o">.</code><code class="na">ERROR_MESSAGE</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<figure><div class="figure" id="javacook-otherlang-FIG-1">&#13;
<img alt="jcb4 1801" src="assets/jcb4_1801.png"/>&#13;
<h6><span class="label">Figure 18-1. </span>ExecDemoNS in action</h6>&#13;
</div></figure>&#13;
&#13;
<p>A newer class, <code>ProcessBuilder</code>, replaces most nontrivial uses of <code>Runtime.exec()</code>.&#13;
This <code>ProcessBuilder</code> uses generic collections to let you modify or replace the environment, as shown in <a data-type="xref" href="#javacook-otherlang-EX-2">Example 18-2</a>.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-2">&#13;
<h5><span class="label">Example 18-2. </span>main/src/main/java/otherlang/ProcessBuilderDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code>        </code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="n">command</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ArrayList</code><code class="o">&lt;</code><code class="o">&gt;</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>            </code><a class="co" href="#callout_using_java_with_other_languages_CO1-1" id="co_using_java_with_other_languages_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">command</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="s">"notepad"</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">command</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="s">"foo.txt"</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">ProcessBuilder</code><code> </code><code class="n">builder</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">ProcessBuilder</code><code class="o">(</code><code class="n">command</code><code class="o">)</code><code class="o">;</code><a class="co" href="#callout_using_java_with_other_languages_CO1-2" id="co_using_java_with_other_languages_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">builder</code><code class="o">.</code><code class="na">environment</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"PATH"</code><code class="o">,</code><code>&#13;
</code><code>                </code><code class="s">"/windows;/windows/system32;/winnt"</code><code class="o">)</code><code class="o">;</code><code>        </code><a class="co" href="#callout_using_java_with_other_languages_CO1-3" id="co_using_java_with_other_languages_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="kd">final</code><code> </code><code class="n">Process</code><code> </code><code class="n">godot</code><code> </code><code class="o">=</code><code> </code><code class="n">builder</code><code class="o">.</code><code class="na">directory</code><code class="o">(</code><code>&#13;
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">File</code><code class="o">(</code><code class="n">System</code><code class="o">.</code><code class="na">getProperty</code><code class="o">(</code><code class="s">"user.home"</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code class="o">.</code><code>      </code><a class="co" href="#callout_using_java_with_other_languages_CO1-4" id="co_using_java_with_other_languages_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>            </code><code class="n">start</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Waiting for Godot"</code><code class="o">)</code><code class="o">;</code><code>             </code><a class="co" href="#callout_using_java_with_other_languages_CO1-5" id="co_using_java_with_other_languages_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="n">godot</code><code class="o">.</code><code class="na">waitFor</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>                                     </code><a class="co" href="#callout_using_java_with_other_languages_CO1-6" id="co_using_java_with_other_languages_CO1-6"><img alt="6" src="assets/6.png"/></a></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_using_java_with_other_languages_CO1-1" id="callout_using_java_with_other_languages_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Set up the command-line argument list: editor program name and filename.</p></dd>&#13;
<dt><a class="co" href="#co_using_java_with_other_languages_CO1-2" id="callout_using_java_with_other_languages_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use that to start configuring the <code>ProcessBuilder</code>.</p></dd>&#13;
<dt><a class="co" href="#co_using_java_with_other_languages_CO1-3" id="callout_using_java_with_other_languages_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Configure the builder’s environment to a list of common MS Windows <span class="keep-together">directories.</span></p></dd>&#13;
<dt><a class="co" href="#co_using_java_with_other_languages_CO1-4" id="callout_using_java_with_other_languages_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Set the initial directory to the user’s home, and start the process!</p></dd>&#13;
<dt><a class="co" href="#co_using_java_with_other_languages_CO1-5" id="callout_using_java_with_other_languages_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>I always wanted to be able to use this line in code.</p></dd>&#13;
<dt><a class="co" href="#co_using_java_with_other_languages_CO1-6" id="callout_using_java_with_other_languages_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Wait for the end of our little play.</p></dd>&#13;
</dl>&#13;
&#13;
<p>For more on <code>ProcessBuilder</code>, see the javadoc for <code>java.lang.ProcessBuilder</code>.<a data-primary="" data-startref="jav_rep" data-type="indexterm" id="idm45290621495656"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.2 Running a Program and Capturing Its Output" data-type="sect1"><div class="sect1" id="javacook-otherlang-SECT-2">&#13;
<h1>18.2 Running a Program and Capturing Its Output</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-2.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Java" data-secondary="running programs and capturing output" data-type="indexterm" id="jav_rpco"/>You want to run a program but also capture its output.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-2.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>Process</code> object’s <a data-primary="getInputStream() method" data-type="indexterm" id="idm45290621488200"/><code>getInputStream()</code>; read and copy the contents to <code>System.out</code> or wherever you want them.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-2.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The original notion of standard output and standard error was that they would always&#13;
be connected to the terminal; this notion dates from an earlier time when almost&#13;
all computer users worked at the command line.&#13;
Today, a program’s standard output and error output do not always automatically appear anywhere.&#13;
Arguably there should be an automatic way to make this happen. But for now, you need to add a few&#13;
lines of code to grab the program’s output and print it:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ExecDemoLs</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">Logger</code> <code class="n">logger</code> <code class="o">=</code>&#13;
        <code class="n">Logger</code><code class="o">.</code><code class="na">getLogger</code><code class="o">(</code><code class="n">ExecDemoLs</code><code class="o">.</code><code class="na">class</code><code class="o">.</code><code class="na">getSimpleName</code><code class="o">());</code>&#13;
&#13;
    <code class="cm">/** The program to run */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">PROGRAM</code> <code class="o">=</code> <code class="s">"ls"</code><code class="o">;</code> <code class="c1">// "dir" for Windows</code>&#13;
    <code class="cm">/** Set to true to end the loop */</code>&#13;
    <code class="kd">static</code> <code class="kd">volatile</code> <code class="kt">boolean</code> <code class="n">done</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code> <code class="n">argv</code><code class="o">[])</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
&#13;
        <code class="kd">final</code> <code class="n">Process</code> <code class="n">p</code><code class="o">;</code>         <code class="c1">// Process tracks one external native process</code>&#13;
        <code class="n">BufferedReader</code> <code class="n">is</code><code class="o">;</code>    <code class="c1">// reader for output of process</code>&#13;
        <code class="n">String</code> <code class="n">line</code><code class="o">;</code>&#13;
&#13;
        <code class="n">p</code> <code class="o">=</code> <code class="n">Runtime</code><code class="o">.</code><code class="na">getRuntime</code><code class="o">().</code><code class="na">exec</code><code class="o">(</code><code class="n">PROGRAM</code><code class="o">);</code>&#13;
&#13;
        <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"In Main after exec"</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Optional: start a thread to wait for the process to terminate.</code>&#13;
        <code class="c1">// Don't just wait in main line, but here set a "done" flag and</code>&#13;
        <code class="c1">// use that to control the main reading loop below.</code>&#13;
        <code class="n">Thread</code> <code class="n">waiter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Thread</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
                <code class="k">try</code> <code class="o">{</code>&#13;
                    <code class="n">p</code><code class="o">.</code><code class="na">waitFor</code><code class="o">();</code>&#13;
                <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="c1">// OK, just quit.</code>&#13;
                    <code class="k">return</code><code class="o">;</code>&#13;
                <code class="o">}</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Program terminated!"</code><code class="o">);</code>&#13;
                <code class="n">done</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">};</code>&#13;
        <code class="n">waiter</code><code class="o">.</code><code class="na">start</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// getInputStream gives an Input stream connected to</code>&#13;
        <code class="c1">// the process p's standard output (and vice versa). We use</code>&#13;
        <code class="c1">// that to construct a BufferedReader so we can readLine() it.</code>&#13;
        <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">p</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
&#13;
        <code class="k">while</code> <code class="o">(!</code><code class="n">done</code> <code class="o">&amp;&amp;</code> <code class="o">((</code><code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">))</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">line</code><code class="o">);</code>&#13;
&#13;
        <code class="n">logger</code><code class="o">.</code><code class="na">info</code><code class="o">(</code><code class="s">"In Main after EOF"</code><code class="o">);</code>&#13;
&#13;
        <code class="k">return</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>This is such a common occurrence that I’ve packaged it up into a class called&#13;
<code>ExecAndPrint</code>, which is part of my <code>com.darwinsys.lang</code> package. <code>ExecAndPrint</code> has&#13;
several overloaded forms of its <a data-primary="run() method" data-type="indexterm" id="idm45290621479496"/><code>run()</code> method (see the documentation for details), but&#13;
they all take at least a command and optionally an output file to which the command’s&#13;
output is written. <a data-type="xref" href="#javacook-otherlang-EX-2ch24">Example 18-3</a> shows the code for some of these methods.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-2ch24">&#13;
<h5><span class="label">Example 18-3. </span>darwinsys-api/src/main/java/com/darwinsys/lang/ExecAndPrint.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">    <code class="cm">/** Need a Runtime object for any of these methods */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kd">static</code> <code class="n">Runtime</code> <code class="n">r</code> <code class="o">=</code> <code class="n">Runtime</code><code class="o">.</code><code class="na">getRuntime</code><code class="o">();</code>&#13;
&#13;
    <code class="cm">/** Run the command given as a String, output to System.out</code>&#13;
<code class="cm">     * @param cmd The command</code>&#13;
<code class="cm">     * @return The command's exit status</code>&#13;
<code class="cm">     * @throws IOException if the command isn't found</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">int</code> <code class="nf">run</code><code class="o">(</code><code class="n">String</code> <code class="n">cmd</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="nf">run</code><code class="o">(</code><code class="n">cmd</code><code class="o">,</code> <code class="k">new</code> <code class="n">OutputStreamWriter</code><code class="o">(</code><code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Run the command given as a String, output to "out"</code>&#13;
<code class="cm">     * @param cmd The command and list of arguments</code>&#13;
<code class="cm">     * @param out The output file</code>&#13;
<code class="cm">     * @return The command's exit status</code>&#13;
<code class="cm">     * @throws IOException if the command isn't found</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">int</code> <code class="nf">run</code><code class="o">(</code><code class="n">String</code> <code class="n">cmd</code><code class="o">,</code> <code class="n">Writer</code> <code class="n">out</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Process</code> <code class="n">p</code> <code class="o">=</code> <code class="n">r</code><code class="o">.</code><code class="na">exec</code><code class="o">(</code><code class="n">cmd</code><code class="o">);</code>&#13;
&#13;
        <code class="n">FileIO</code><code class="o">.</code><code class="na">copyFile</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">p</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()),</code> <code class="n">out</code><code class="o">,</code> <code class="kc">true</code><code class="o">);</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">p</code><code class="o">.</code><code class="na">waitFor</code><code class="o">();</code>    <code class="c1">// wait for process to complete</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="o">-</code><code class="mi">1</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">return</code> <code class="n">p</code><code class="o">.</code><code class="na">exitValue</code><code class="o">();</code>&#13;
    <code class="o">}</code></pre></div>&#13;
&#13;
<p>As a simple example of using <a data-primary="exec() method" data-type="indexterm" id="idm45290621132312"/><code>exec()</code> directly along with <code>ExecAndPrint</code>, I’ll create&#13;
three temporary files, list them (directory listing), and then delete them. When I run the&#13;
<code>ExecDemoFiles</code> program, it lists the three files it has created:</p>&#13;
&#13;
<pre data-type="programlisting">-rw-------  1 ian  wheel  0 Jan 29 14:29 file1&#13;
-rw-------  1 ian  wheel  0 Jan 29 14:29 file2&#13;
-rw-------  1 ian  wheel  0 Jan 29 14:29 file3</pre>&#13;
&#13;
<p>Its source code is in <a data-type="xref" href="#javacook-otherlang-EX-3">Example 18-4</a>.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-3">&#13;
<h5><span class="label">Example 18-4. </span>main/src/main/java/otherlang/ExecDemoFiles.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="c1">// Get and save the Runtime object.</code>&#13;
        <code class="n">Runtime</code> <code class="n">rt</code> <code class="o">=</code> <code class="n">Runtime</code><code class="o">.</code><code class="na">getRuntime</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Create three temporary files (the slow way!)</code>&#13;
        <code class="n">rt</code><code class="o">.</code><code class="na">exec</code><code class="o">(</code><code class="s">"mktemp file1"</code><code class="o">);</code>&#13;
        <code class="n">rt</code><code class="o">.</code><code class="na">exec</code><code class="o">(</code><code class="s">"mktemp file2"</code><code class="o">);</code>&#13;
        <code class="n">rt</code><code class="o">.</code><code class="na">exec</code><code class="o">(</code><code class="s">"mktemp file3"</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Run the "ls" (directory lister) program</code>&#13;
        <code class="c1">// with its output sent into a file</code>&#13;
        <code class="n">String</code><code class="o">[]</code> <code class="n">args</code> <code class="o">=</code> <code class="o">{</code> <code class="s">"ls"</code><code class="o">,</code> <code class="s">"-l"</code><code class="o">,</code> <code class="s">"file1"</code><code class="o">,</code> <code class="s">"file2"</code><code class="o">,</code> <code class="s">"file3"</code> <code class="o">};</code>&#13;
        <code class="n">ExecAndPrint</code><code class="o">.</code><code class="na">run</code><code class="o">(</code><code class="n">args</code><code class="o">);</code>&#13;
&#13;
        <code class="n">rt</code><code class="o">.</code><code class="na">exec</code><code class="o">(</code><code class="s">"rm file1 file2 file3"</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>A process isn’t necessarily destroyed when the Java program that created it exits or bombs&#13;
out. Simple text-based programs will be, but window-based programs like <em>kwrite</em>&#13;
Netscape, or even a Java-based <code>JFrame</code> application, will not. For example, our&#13;
<code>ExecDemoNS</code> program started Netscape, and when <code>ExecDemoNS</code>’s Exit button is clicked,&#13;
<code>ExecDemoNS</code> exits but Netscape stays running. What if you want to be sure a process has&#13;
completed? The <code>Process</code> object has a<a data-primary="waitFor() method" data-type="indexterm" id="idm45290620787944"/> <code>waitFor()</code>  method that lets you do so, and an&#13;
<a data-primary="exitValue() method" data-type="indexterm" id="idm45290620786616"/><code>exitValue()</code>  method that tells you the return code from the process. Finally, should&#13;
you wish to forcibly terminate the other process, you can do so with the <code>Process</code>&#13;
object’s <a data-primary="destroy() method" data-type="indexterm" id="idm45290621051064"/><code>destroy()</code>  method, which takes no argument and returns no value.&#13;
<a data-type="xref" href="#javacook-otherlang-EX-4">Example 18-5</a> is <code>ExecDemoWait</code>, a program that runs whatever program you&#13;
name on the command line (along with arguments), captures the program’s standard output,&#13;
and waits for the program to terminate.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-4">&#13;
<h5><span class="label">Example 18-5. </span>main/src/main/java/otherlang/ExecDemoWait.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="c1">// A Runtime object has methods for dealing with the OS</code>&#13;
        <code class="n">Runtime</code> <code class="n">r</code> <code class="o">=</code> <code class="n">Runtime</code><code class="o">.</code><code class="na">getRuntime</code><code class="o">();</code>&#13;
        <code class="n">Process</code> <code class="n">p</code><code class="o">;</code>         <code class="c1">// Process tracks one external native process</code>&#13;
        <code class="n">BufferedReader</code> <code class="n">is</code><code class="o">;</code>    <code class="c1">// reader for output of process</code>&#13;
        <code class="n">String</code> <code class="n">line</code><code class="o">;</code>&#13;
&#13;
        <code class="c1">// Our argv[0] contains the program to run; remaining elements</code>&#13;
        <code class="c1">// of argv contain args for the target program. This is just</code>&#13;
        <code class="c1">// what is needed for the String[] form of exec.</code>&#13;
        <code class="n">p</code> <code class="o">=</code> <code class="n">r</code><code class="o">.</code><code class="na">exec</code><code class="o">(</code><code class="n">argv</code><code class="o">);</code>&#13;
&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"In Main after exec"</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// getInputStream gives an Input stream connected to</code>&#13;
        <code class="c1">// the process p's standard output. Just use it to make</code>&#13;
        <code class="c1">// a BufferedReader to readLine() what the program writes out.</code>&#13;
        <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">p</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
&#13;
        <code class="k">while</code> <code class="o">((</code><code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">line</code><code class="o">);</code>&#13;
&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"In Main after EOF"</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">p</code><code class="o">.</code><code class="na">waitFor</code><code class="o">();</code>    <code class="c1">// wait for process to complete</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">e</code><code class="o">);</code>    <code class="c1">// "Can't Happen"</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Process done, exit status was "</code> <code class="o">+</code> <code class="n">p</code><code class="o">.</code><code class="na">exitValue</code><code class="o">());</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-2.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>You wouldn’t normally use any form of <a data-primary="exec() method" data-type="indexterm" id="idm45290621043800"/><code>exec()</code> to run one Java program from another in&#13;
this way; instead, you’d probably create it as a thread within the same process, because&#13;
this is generally quite a bit faster (the Java interpreter is already up and running, so&#13;
why wait for another copy of it to start up?). See <a data-type="xref" href="ch16.html#javacook-threads">Chapter 16</a>.</p>&#13;
&#13;
<p>When building industrial-strength applications, note the cautionary remarks in the Java&#13;
API docs for the <code>Process</code> class concerning the danger of losing some of the I/O due to&#13;
insufficient buffering by the operating system.<a data-primary="" data-startref="jav_rpco" data-type="indexterm" id="idm45290620631448"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.3 Calling Other Languages via javax.script" data-type="sect1"><div class="sect1" id="javacook-otherlang-scripting">&#13;
<h1>18.3 Calling Other Languages via javax.script</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45290620628760">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Java" data-secondary="javax.script" data-type="indexterm" id="jav_javax"/><a data-primary="javax.script" data-type="indexterm" id="javax_ab"/>You want to invoke a script written in some other language from within your Java program, running in the JVM,&#13;
with the ability to pass variables directly to/from the other language.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45290620624792">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>If the script you want is written in any of the two-dozen-plus supported languages,&#13;
use <code>javax.script</code>.&#13;
Those languages include awk, Perl, Python, Ruby, BeanShell, PNuts, Ksh/Bash, R (Renjin), and&#13;
several implementations of JavaScript.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45290620622568">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>One of the first tasks when using this API is to find out the installed scripting engines,&#13;
and then pick one that is available.&#13;
The <code>ScriptEnginesDemo</code> program in <a data-type="xref" href="#javacook-otherlang-scriptenginesdemo">Example 18-6</a> lists the installed engines&#13;
and runs a simple script in the default language, ECMAScript (aka JavaScript).</p>&#13;
<div data-type="example" id="javacook-otherlang-scriptenginesdemo">&#13;
<h5><span class="label">Example 18-6. </span>main/src/main/java/otherlang/ScriptEnginesDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ScriptEnginesDemo</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">ScriptException</code> <code class="o">{</code>&#13;
        <code class="n">ScriptEngineManager</code> <code class="n">scriptEngineManager</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ScriptEngineManager</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Print list of supported languages</code>&#13;
        <code class="n">scriptEngineManager</code><code class="o">.</code><code class="na">getEngineFactories</code><code class="o">().</code><code class="na">forEach</code><code class="o">(</code><code class="n">factory</code> <code class="o">-&gt;</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">factory</code><code class="o">.</code><code class="na">getLanguageName</code><code class="o">()));</code>&#13;
&#13;
        <code class="c1">// Run a script in the JavaScript language</code>&#13;
        <code class="n">String</code> <code class="n">lang</code> <code class="o">=</code> <code class="s">"JavaScript"</code><code class="o">;</code>&#13;
        <code class="n">ScriptEngine</code> <code class="n">engine</code> <code class="o">=</code>&#13;
            <code class="n">scriptEngineManager</code><code class="o">.</code><code class="na">getEngineByName</code><code class="o">(</code><code class="n">lang</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">engine</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Could not find engine"</code><code class="o">);</code>&#13;
            <code class="k">return</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">engine</code><code class="o">.</code><code class="na">eval</code><code class="o">(</code><code class="s">"print(\"Hello from "</code> <code class="o">+</code> <code class="n">lang</code> <code class="o">+</code> <code class="s">"\");"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#javacook-otherlang-pythonfromjava">Example 18-7</a> is a very simple demo&#13;
of calling Python from Java using <code>javax.scripting</code>.&#13;
We know the name of the scripting engine we want to use: Python.&#13;
We’ll use the in-vm implementation known as <code>jython</code>, which was originally&#13;
called JPython but was changed due to a trademark issue.&#13;
Once we put the <em>jython-standalone-2.nnn.jar</em> onto our <code>CLASSPATH</code>,&#13;
the script engine is automatically detected.&#13;
Just in case it fails, we print a verbose message including a list of the engines that are available.</p>&#13;
<div data-type="example" id="javacook-otherlang-pythonfromjava">&#13;
<h5><span class="label">Example 18-7. </span>main/src/main/java/otherlang/PythonFromJava.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * demo using Python (jython) to get a Java variable, print, and change it.</code>&#13;
<code class="cm"> * @author Ian Darwin</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">PythonFromJava</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">PY_SCRIPTNAME</code> <code class="o">=</code> <code class="s">"pythonfromjava.py"</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="n">ScriptEngineManager</code> <code class="n">scriptEngineManager</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ScriptEngineManager</code><code class="o">();</code>&#13;
&#13;
        <code class="n">ScriptEngine</code> <code class="n">engine</code> <code class="o">=</code> <code class="n">scriptEngineManager</code><code class="o">.</code><code class="na">getEngineByName</code><code class="o">(</code><code class="s">"python"</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">engine</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="kd">final</code> <code class="n">String</code> <code class="n">message</code> <code class="o">=</code>&#13;
                <code class="s">"Could not find 'python' engine; add its jar to CLASSPATH"</code><code class="o">;</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">message</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Available script engines are: "</code><code class="o">);</code>&#13;
            <code class="n">scriptEngineManager</code><code class="o">.</code><code class="na">getEngineFactories</code><code class="o">().</code><code class="na">forEach</code><code class="o">(</code><code class="n">factory</code> <code class="o">-&gt;</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">factory</code><code class="o">.</code><code class="na">getLanguageName</code><code class="o">()));</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalStateException</code><code class="o">(</code><code class="n">message</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="kd">final</code> <code class="n">Bindings</code> <code class="n">bindings</code> <code class="o">=</code> <code class="n">engine</code><code class="o">.</code><code class="na">getBindings</code><code class="o">(</code><code class="n">ScriptContext</code><code class="o">.</code><code class="na">ENGINE_SCOPE</code><code class="o">);</code>&#13;
        <code class="n">bindings</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"meaning"</code><code class="o">,</code> <code class="mi">42</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Let's run a python script stored on disk (well, on classpath):</code>&#13;
        <code class="n">InputStream</code> <code class="n">is</code> <code class="o">=</code>&#13;
            <code class="n">PythonFromJava</code><code class="o">.</code><code class="na">class</code><code class="o">.</code><code class="na">getResourceAsStream</code><code class="o">(</code><code class="s">"/"</code> <code class="o">+</code> <code class="n">PY_SCRIPTNAME</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">is</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IOException</code><code class="o">(</code><code class="s">"Could not find file "</code> <code class="o">+</code> <code class="n">PY_SCRIPTNAME</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">engine</code><code class="o">.</code><code class="na">eval</code><code class="o">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="o">(</code><code class="n">is</code><code class="o">));</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Java: Meaning is now "</code> <code class="o">+</code> <code class="n">bindings</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"meaning"</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45290620477144">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>Before Oracle dismantled java.net, there used to be a list of&#13;
many languages (see&#13;
<a href="https://web.archive.org/web/20140909141915/https://java.net/projects/scripting/sources/svn/show/trunk/engines">this archived list</a>; the links don’t work, but it shows the extent of the languages that&#13;
were available).&#13;
Back then, you could download the script engines from that site.&#13;
I am not aware of a current official list of engines, unfortunately.&#13;
However, the list maintained as part of the scripting project&#13;
per se can be found in an unofficial source code&#13;
repository, by viewing <a href="https://github.com/scijava/javax-scripting"><em class="hyperlink">https://github.com/scijava/javax-scripting</em></a>,&#13;
from which it should in theory be possible to build the one you want.&#13;
A dozen or so other engines are maintained by others outside this project; for example,&#13;
there is a <code>Perl5</code> script engine from<a data-primary="Google Code" data-type="indexterm" id="idm45290620283560"/> <a href="https://code.google.com/archive/p/javaperlscripting">Google Code</a>.</p>&#13;
&#13;
<p>There is a also a&#13;
<a href="http://java-source.net/open-source/scripting-languages">list of Java-compatible scripting languages</a>&#13;
(not necessarily all using <code>javax.script</code>).</p>&#13;
&#13;
<p>It is possible to roll your own scripting engine; see my write-up at&#13;
<a href="https://darwinsys.com/java/scriptengines.html"><em class="hyperlink">https://darwinsys.com/java/scriptengines.html</em></a>.<a data-primary="" data-startref="jav_javax" data-type="indexterm" id="idm45290620278824"/><a data-primary="" data-startref="javax_ab" data-type="indexterm" id="idm45290620277880"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.4 Mixing Languages with GraalVM" data-type="sect1"><div class="sect1" id="javacook-otherlang-with-graalvm">&#13;
<h1>18.4 Mixing Languages with GraalVM</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45290620275288">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="GraalVM" data-secondary="mixing languages with" data-type="indexterm" id="idm45290620274088"/><a data-primary="Java" data-secondary="mixing languages with GraalVM" data-type="indexterm" id="idm45290620273112"/>GraalVM aims to be multilanguage, and you’d like to use different languages in the VM.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45290620271704">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use <em>gu</em> (graal utility) to install additional language packs and call other languages.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45290620269704">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>While GraalVM positions itself as able to support a wide variety of programming&#13;
languages, the number currently supported is small but growing.&#13;
Let’s try invoking Python code from within Java.&#13;
Assuming you’ve installed Graal itself as per <a data-type="xref" href="ch01.html#jcb-getstarted-graal">Recipe 1.2</a>,&#13;
you should have <em>gu</em> on your executable path,&#13;
so try the following:</p>&#13;
&#13;
<pre data-type="programlisting">$ gu install python&#13;
Downloading: Component catalog from www.graalvm.org&#13;
Processing component archive: Graal.Python&#13;
Downloading: Component python: Graal.Python  from github.com&#13;
Installing new component: Graal.Python (org.graalvm.python, version 19.2.0.1)&#13;
&#13;
IMPORTANT NOTE:&#13;
---------------&#13;
Set of GraalVM components that provide language implementations have changed.&#13;
  The Polyglot native image and polyglot native C library may be out of sync:&#13;
- new languages may not be accessible&#13;
- removed languages may cause the native binary to fail on missing resources&#13;
  or libraries.&#13;
To rebuild and refresh the native binaries, use the following command:&#13;
      Library/Java/JavaVirtualMachines/graalvm-ce-19.2.0.1/Contents/Home/bin/gu&#13;
      rebuild-images&#13;
&#13;
You may need to install "native-image" component which provide the rebuild tools.</pre>&#13;
&#13;
<p>Then the code in <a data-type="xref" href="#javacook-otherlang-graalpy">Example 18-8</a> can be used.</p>&#13;
<div data-type="example" id="javacook-otherlang-graalpy">&#13;
<h5><span class="label">Example 18-8. </span>graal/src/JavaCallPython.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">import</code> <code class="nn">java.io.*</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">java.util.stream.*</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.graalvm.polyglot.*</code><code class="o">;</code>&#13;
&#13;
<code class="cm">/**</code>&#13;
<code class="cm"> * GraalVM polyglot: calling Python from Java/</code>&#13;
<code class="cm"> */</code>&#13;
<code class="c1">// tag::main[]</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">JavaCallPython</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">java</code><code class="o">.</code><code class="na">io</code><code class="o">.</code><code class="na">IOException</code> <code class="o">{</code>&#13;
&#13;
         <code class="k">try</code> <code class="o">(</code><code class="n">Context</code> <code class="n">context</code> <code class="o">=</code> <code class="n">Context</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="s">"jython"</code><code class="o">))</code> <code class="o">{</code>&#13;
            <code class="n">Value</code> <code class="n">result</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="na">execute</code><code class="o">(</code><code class="s">"2 + 2"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">result</code><code class="o">.</code><code class="na">asString</code><code class="o">());</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code>&#13;
<code class="c1">// end::main[]</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.5 Marrying Java and Perl" data-type="sect1"><div class="sect1" id="javacook-otherlang-SECT-4">&#13;
<h1>18.5 Marrying Java and Perl</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-4.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Java" data-secondary="Perl and" data-type="indexterm" id="jav_perl"/><a data-primary="Perl, Java and" data-type="indexterm" id="perl_jav"/>You want to call Java from Perl, or vice versa.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-4.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>To call Java from Perl, use the Perl <code>Inline::Java</code> module.&#13;
To go the other way—calling Perl from Java—use <code>javax.script</code>, as in <a data-type="xref" href="#javacook-otherlang-scripting">Recipe 18.3</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-4.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Perl is often called a glue language that can be used to bring together diverse parts of the software world. But, in addition, it is a full-blown language for creating software. A wealth of extension modules provide ready-to-run solutions for quite diverse problems, and most of these modules are available free from <a data-primary="CPAN (Comprehensive Perl Archive Network)" data-type="indexterm" id="idm45290620218376"/>CPAN, the <a href="http://www.cpan.org">Comprehensive Perl Archive Network</a>. Also, as a scripting language, it is ideally suited for rapid prototyping. On the other hand, although building graphical user interfaces is definitely possible in Perl, it is not exactly one of the language’s strengths. So you might want to construct your GUI using Java Swing, and, at the same time, reuse business logic implemented in Perl.</p>&#13;
&#13;
<p>Fortunately, among the many CPAN modules, <code>Inline::Java</code>  makes the integration of Perl and Java a breeze. Let’s assume first that you want to call into Java from Perl. For business logic, I have picked a CPAN module that measures the similarity of two strings (the so-called<a data-primary="Levenshtein string edit distance algorithm" data-type="indexterm" id="idm45290620215192"/> <em>Levenshtein edit distance</em>). <a data-type="xref" href="#javacook-otherlang-EX-7">Example 18-9</a> shows the complete source. You need at least version 0.44 of the module <code>Inline::Java</code>; previous versions did not support threaded applications properly, so use of Swing wasn’t possible.</p>&#13;
&#13;
<p>Using the module this way requires that the Java source be included&#13;
in the Perl script with special delimiters, as shown in <a data-type="xref" href="#javacook-otherlang-EX-7">Example 18-9</a>.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-7">&#13;
<h5><span class="label">Example 18-9. </span>Swinging.pl</h5>&#13;
&#13;
<pre data-type="programlisting">#! /usr/bin/perl&#13;
# Calling Java from Perl&#13;
&#13;
use strict;&#13;
use warnings;&#13;
&#13;
use Text::Levenshtein qw( );&#13;
  # Perl module from CPAN to measure string similarity&#13;
&#13;
use Inline 0.44 "JAVA" =&amp;gt; "DATA";  # pointer to the Inline java source&#13;
use Inline::Java qw(caught);  # helper function to determine exception type&#13;
&#13;
my $show = new Showit;     # construct Java object using Perl syntax&#13;
$show-&amp;gt;show("Just another Perl hacker");            # call method on that object&#13;
&#13;
eval {&#13;
  # Call a method that will call back to Perl;&#13;
  # catch exceptions, if any.&#13;
  print "matcher: ", $show-&amp;gt;match("Japh", shift||"Java"),&#13;
  " (displayed from Perl)\n";&#13;
};&#13;
if ($@) {&#13;
  print STDERR "Caught:", caught($@), "\n";&#13;
  die $@ unless caught("java.lang.Exception");&#13;
  print STDERR $@-&amp;gt;getMessage( ), "\n";&#13;
}&#13;
&#13;
__END_  _&#13;
&#13;
__JAVA_  _&#13;
// Java starts here&#13;
import javax.swing.*;&#13;
import org.perl.inline.java.*;&#13;
&#13;
class Showit extends InlineJavaPerlCaller {&#13;
  // extension only neeeded if calling back into Perl&#13;
&#13;
  /** Simple Java class to be called from Perl, and to call back to Perl&#13;
   */&#13;
  public Showit( ) throws InlineJavaException { }&#13;
&#13;
  /** Simple method */&#13;
  public void show(String str) {&#13;
    System.out.println(str + " inside Java");&#13;
  }&#13;
&#13;
  /** Method calling back into Perl */&#13;
  public int match(String target, String pattern)&#13;
      throws InlineJavaException, InlineJavaPerlException {&#13;
&#13;
    // Calling a function residing in a Perl Module&#13;
    String str = (String)CallPerl("Text::Levenshtein", "distance",&#13;
          new Object [] {target, pattern});&#13;
&#13;
    // Show result&#13;
    JOptionPane.showMessageDialog(null, "Edit distance between '" + target +&#13;
        "' and '" + pattern + "' is " + str,&#13;
        "Swinging Perl", JOptionPane.INFORMATION_MESSAGE);&#13;
    return Integer.parseInt(str);&#13;
  }&#13;
&#13;
}</pre></div>&#13;
&#13;
<p>Since this uses the <code>Text::Levenshtein</code> and the <code>Inline::Java</code> modules, you will have to install that.&#13;
Here’s the standard way:</p>&#13;
<pre>$ perl -MCPAN -e shell&#13;
&gt; install Text::Levenshtein&#13;
&gt; install Inline::Java&#13;
&gt; quit</pre>&#13;
&#13;
<p>On some systems there may be an OS-specific module; for example, on OpenBSD Unix, it’s this:</p>&#13;
<pre>$ doas pkg_add p5-Text-LevenshteinXS</pre>&#13;
&#13;
<p>In a simple Perl+Java program like this, you don’t even need to write a separate Java source file: you combine all the code, Perl and Java alike, in one single file. You do not need to compile anything, either; just execute it by typing:</p>&#13;
&#13;
<pre data-type="programlisting">perl Swinging.pl</pre>&#13;
&#13;
<p>(You can also add a string argument.) After a little churning, a Java message box pops up, telling you that the distance between <code>Japh</code> and <code>Java</code> is 2. At the same time, your console shows the string “Just another Perl hacker inside Java.” When you close the message box, you get the final result “matcher: 2 (displayed from Perl).”</p>&#13;
&#13;
<p>In between, your Perl program has created an instance of the Java class <code>Showit</code> by calling its constructor. It then called that object’s <a data-primary="show() method" data-type="indexterm" id="idm45290620200840"/><code>show()</code> method to display a string from within Java. It then proceeded to call the <a data-primary="match() method" data-type="indexterm" id="idm45290620199752"/><code>match()</code> method, but this time, something more complicated happens: the Java code calls back into Perl, accessing method <code>distance</code> of module <code>Text::Levenshtein</code> and passing it two strings as arguments. It receives the result, displays it in a message box, and finally, for good measure, returns it to the Perl main program that it had been called from.</p>&#13;
&#13;
<p>Incidentally, the <code>eval { }</code> block around the method call is the Perlish way of catching exceptions. In this case, the exception is thrown from within Java.</p>&#13;
&#13;
<p>If you restart the program, you will notice that startup time is much shorter, which is always good news. Why is that so? On the first call, <code>Inline::Java</code>  took the input apart, precompiled the Java part, and saved it to disk (usually, in a subdirectory called <em class="keep-together">_Inline</em>). On subsequent calls, it just makes sure that the Java source has not changed and then calls the class file that is already on disk. (Of course, if you surreptitiously changed the Java code, it is recompiled just as automagically.) Behind the scenes, even stranger things are going on, however. When the Perl script is executed, a Java server is constructed and started unbeknownst to the user, and the Perl part and the Java bits communicate through a TCP socket (see <a data-type="xref" href="ch13.html#javacook-netserver">Chapter 13</a>).</p>&#13;
&#13;
<p>Marrying two platform-independent languages, like Perl and Java, in a portable way skirts many portability problems. When distributing inlined applications, be sure to supply not just the source files but also the contents of the <em>_Inline</em> directory. (It is advisable to purge that directory and to rebuild everything just before distribution time; otherwise, old compiled versions left lying around might make it into the distribution.) Each target machine needs to repeat the magic steps of <code>Inline::Java</code>, which requires a Java compiler. In any case, the <code>Inline::Java</code> module must be installed.</p>&#13;
&#13;
<p>Because Perl has <code>Inline</code> modules for a number of other languages (ordinary languages like C, but others as exotic as Befunge), one might even consider using Perl as glue for interoperation between those other languages, jointly or separately, and Java. I am sure many happy hours can be spent working out the intricacies of such <span class="keep-together">interactions.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-4.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>You can find full information on <code>Inline::Java</code> on <a href="http://search.cpan.org">CPAN</a> or in the POD (Plain Old Documentation) that is installed along with the module itself.<a data-primary="" data-startref="jav_perl" data-type="indexterm" id="idm45290620186616"/><a data-primary="" data-startref="perl_jav" data-type="indexterm" id="idm45290620185640"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.6 Calling Other Languages via Native Code" data-type="sect1"><div class="sect1" id="javacook-otherlang-SECT-5">&#13;
<h1>18.6 Calling Other Languages via Native Code</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-5.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Java" data-secondary="calling languages via native code" data-type="indexterm" id="jav_clnc"/><a data-primary="native code" data-type="indexterm" id="nc_ab"/>You wish to call native C/C++ functions from Java, either for efficiency&#13;
or to access hardware- or system-specific features.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-5.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use JNI, the Java Native Interface.&#13;
Or, use GraalVM.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-5.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Java lets you load native or compiled code into your Java program. Why would you want to&#13;
do such a thing? The best reason would probably be to access OS-dependent functionality,&#13;
or existing code written in another language. A less good reason would be&#13;
speed: native code can sometimes run faster than Java, though this is becoming less important&#13;
as computers get faster and more multicore.&#13;
Like everything else in Java, the native code mechanism is subject to security restrictions;&#13;
for example, applets were not allowed to access native code.</p>&#13;
&#13;
<p>The native code language bindings are defined for code written in C or C++. If you need to access a language other than C/C++, write a bit of C/C++ and have it pass control to other functions or applications, using any mechanism defined by your operating system.</p>&#13;
&#13;
<p>Due to such system-dependent features as the interpretation of header files and the allocation of the processor’s general-purpose registers, your native code may need to be compiled by the same C compiler used to compile the Java runtime for your platform. For example, on Solaris you  can use SunPro C or maybe gcc. On Win32 platforms, use Microsoft visual C++ Version 4.x or higher (32 bit). For Linux and macOS, you should be able to use the provided gcc-based compiler. For other platforms, see your Java vendor’s documentation.</p>&#13;
&#13;
<p>Also note that the details in this section are for the Java Native Interface (JNI) of Java 1.1 and later, which differs in some details from 1.0 and from Microsoft’s native <span class="keep-together">interface.</span></p>&#13;
<aside class="less_space pagebreak-before" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="javacook-otherlang-SIDEBAR-1">&#13;
<h5>Ian’s Basic Steps: Java Calling Native Code</h5>&#13;
<p>To call native code from Java, follow these steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Write Java code that calls a native method.</p>&#13;
</li>&#13;
<li>&#13;
<p>Compile this Java code.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create an <em>.h</em> file using <em>javah</em>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Write a C function that does the work.</p>&#13;
</li>&#13;
<li>&#13;
<p>Compile the C code into a loadable object.</p>&#13;
</li>&#13;
<li>&#13;
<p>Try it!</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></aside>&#13;
&#13;
<p>The first step is to write Java code that calls a native method. To do this, use the keyword <code>native</code> to indicate that the method is native, and provide a static code block that loads your native method using <code>System.loadLibrary()</code>. (The dynamically loadable module is created in step 5.) Static blocks are executed when the class containing them is loaded; loading the native code here ensures it is in memory when needed!</p>&#13;
&#13;
<p>Object variables that your native code may modify should carry the <code>volatile</code>  modifier. The file <em>HelloJni.java</em>, shown in <a data-type="xref" href="#javacook-otherlang-EX-10">Example 18-10</a>, is a good starting point.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-10">&#13;
<h5><span class="label">Example 18-10. </span>main/src/main/java/jni/HelloJni.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * A trivial class to show Java Native Interface 1.1 usage from Java.</code>&#13;
<code class="cm">  */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">HelloJni</code> <code class="o">{</code>&#13;
  <code class="kt">int</code> <code class="n">myNumber</code> <code class="o">=</code> <code class="mi">42</code><code class="o">;</code> <code class="c1">// used to show argument passing</code>&#13;
&#13;
  <code class="c1">// declare native class</code>&#13;
  <code class="kd">public</code> <code class="kd">native</code> <code class="kt">void</code> <code class="nf">displayHelloJni</code><code class="o">();</code>&#13;
&#13;
  <code class="c1">// Application main, call its display method</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"HelloJni starting; args.length="</code><code class="o">+</code>&#13;
                       <code class="n">args</code><code class="o">.</code><code class="na">length</code><code class="o">+</code><code class="s">"..."</code><code class="o">);</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">args</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code>&#13;
                       <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"args["</code><code class="o">+</code><code class="n">i</code><code class="o">+</code><code class="s">"]="</code><code class="o">+</code><code class="n">args</code><code class="o">[</code><code class="n">i</code><code class="o">]);</code>&#13;
    <code class="n">HelloJni</code> <code class="n">hw</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HelloJni</code><code class="o">();</code>&#13;
    <code class="n">hw</code><code class="o">.</code><code class="na">displayHelloJni</code><code class="o">();</code><code class="c1">// call the native function</code>&#13;
    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Back in Java, \"myNumber\" now "</code> <code class="o">+</code> <code class="n">hw</code><code class="o">.</code><code class="na">myNumber</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="c1">// Static code blocks are executed once, when class file is loaded</code>&#13;
  <code class="kd">static</code> <code class="o">{</code>&#13;
    <code class="n">System</code><code class="o">.</code><code class="na">loadLibrary</code><code class="o">(</code><code class="s">"hello"</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The second step is simple; just use <em>javac HelloJni.java</em> as you normally would. You probably won’t get any compilation errors on a simple program like this; if you do, correct them and try the compilation again.</p>&#13;
&#13;
<p>Next, you need to create an <em>.h</em>   file. Use <em>javah</em> to produce this file:</p>&#13;
<pre data-type="programlisting" id="I_26_tt679"><strong>javah jni.HelloJni</strong>           // produces HelloJni.h</pre>&#13;
&#13;
<p>The <em>.h</em> file produced is a glue file, not really meant for human consumption and particularly not for editing. But by inspecting the resulting <em>.h</em> file, you’ll see that the C method’s name is composed of the name <code>Java</code>, the package name (if any), the class name, and the method name:</p>&#13;
&#13;
<pre data-type="programlisting">JNIEXPORT void JNICALL Java_HelloJni_displayHelloWorld(JNIEnv *env,&#13;
    jobject this);</pre>&#13;
&#13;
<p>Then create a C function that does the work. You must use the same function signature&#13;
as is used in the <em>.h</em> file.</p>&#13;
&#13;
<p>This function can do whatever it wants. Note that it is passed two arguments: a JVM&#13;
environment variable and a handle for the <code>this</code> object. <a data-type="xref" href="#javacook-otherlang-TABLE-2">Table 18-1</a>&#13;
shows the correspondence between Java types and the C types (JNI types) used in the C code.</p>&#13;
<table id="javacook-otherlang-TABLE-2">&#13;
<caption><span class="label">Table 18-1. </span>Java and JNI types</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Java type</th>&#13;
<th>JNI</th>&#13;
<th>Java array type</th>&#13;
<th>JNI</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>byte</code></p></td>&#13;
<td><p><code>jbyte</code></p></td>&#13;
<td><p><code>byte[]</code></p></td>&#13;
<td><p><code>jbyteArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>short</code></p></td>&#13;
<td><p><code>jshort</code></p></td>&#13;
<td><p><code>short[]</code></p></td>&#13;
<td><p><code>jshortArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>int</code></p></td>&#13;
<td><p><code>jint</code></p></td>&#13;
<td><p><code>int[]</code></p></td>&#13;
<td><p><code>jintArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>long</code></p></td>&#13;
<td><p><code>jlong</code></p></td>&#13;
<td><p><code>long[]</code></p></td>&#13;
<td><p><code>jlongArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>float</p></td>&#13;
<td><p>jfloat</p></td>&#13;
<td><p>float[]</p></td>&#13;
<td><p>jfloatArray</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>double</code></p></td>&#13;
<td><p><code>jdouble</code></p></td>&#13;
<td><p><code>double[]</code></p></td>&#13;
<td><p><code>jdoubleArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>char</code></p></td>&#13;
<td><p><code>jchar</code></p></td>&#13;
<td><p><code>char[]</code></p></td>&#13;
<td><p><code>jcharArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>boolean</code></p></td>&#13;
<td><p><code>jboolean</code></p></td>&#13;
<td><p><code>boolean[]</code></p></td>&#13;
<td><p><code>jbooleanArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>void</code></p></td>&#13;
<td><p><code>jvoid</code></p></td>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Object</code></p></td>&#13;
<td><p><code>jobject</code></p></td>&#13;
<td><p><code>Object[]</code></p></td>&#13;
<td><p><code>jobjectArray</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Class</code></p></td>&#13;
<td><p><code>jclass</code></p></td>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>String</code></p></td>&#13;
<td><p><code>jstring</code></p></td>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>array</code></p></td>&#13;
<td><p><code>jarray</code></p></td>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Throwable</code></p></td>&#13;
<td><p><code>jthrowable</code></p></td>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p><a data-type="xref" href="#javacook-otherlang-EX-11">Example 18-11</a> is a complete C native implementation. Passed an object of type <code>Hel⁠lo​Jni.java</code>, it increments the integer <code>myNumber</code> contained in the object.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-11">&#13;
<h5><span class="label">Example 18-11. </span>main/src/main/java/jni/HelloJni.c</h5>&#13;
&#13;
<pre data-type="programlisting">#include &lt;jni.h&gt;&#13;
#include "HelloJni.h"&#13;
#include &lt;stdio.h&gt;&#13;
/*&#13;
 * This is the Java Native implementation of displayHelloJni.&#13;
 */&#13;
JNIEXPORT void JNICALL Java_HelloJni_displayHelloJni(JNIEnv *env, jobject this) {&#13;
  jfieldID fldid;&#13;
  jint n, nn;&#13;
&#13;
  (void)printf("Hello from a Native Method\n");&#13;
&#13;
  if (this == NULL) {&#13;
    fprintf(stderr, "'this.' pointer is null!\n");&#13;
    return;&#13;
  }&#13;
  if ((fldid = (*env)-&gt;GetFieldID(env,&#13;
        (*env)-&gt;GetObjectClass(env, this), "myNumber", "I")) == NULL) {&#13;
    fprintf(stderr, "GetFieldID failed");&#13;
    return;&#13;
  }&#13;
&#13;
  n = (*env)-&gt;GetIntField(env, this, fldid);/* retrieve myNumber */&#13;
  printf("\"myNumber\" value is %d\n", n);&#13;
&#13;
  (*env)-&gt;SetIntField(env, this, fldid, ++n);/* increment it! */&#13;
  nn = (*env)-&gt;GetIntField(env, this, fldid);&#13;
&#13;
  printf("\"myNumber\" value now %d\n", nn); /* make sure */&#13;
  return;&#13;
}</pre></div>&#13;
&#13;
<p>Finally, you compile the C code into a loadable object. Naturally, the details depend on platform, compiler, etc. For example, on Windows, you could use this:</p>&#13;
<pre data-type="programlisting" id="I_26_tt727">&gt; <strong>set JAVA_HOME=C:\java</strong>              # or wherever&#13;
&gt; <strong>set INCLUDE=%JAVA_HOME%\include;%JAVA_HOME%\include\Win32;%INCLUDE%</strong>&#13;
&gt; <strong>set LIB=%JAVA_HOME%\lib;%LIB%</strong>&#13;
&gt; <strong>cl HelloJni.c -Fehello.dll -MD -LD</strong></pre>&#13;
&#13;
<p>And on Unix, you could use this:</p>&#13;
<pre data-type="programlisting" id="I_26_tt728">$ <strong>export JAVAHOME=/local/java</strong>   # or wherever&#13;
$ <strong>cc -I$JAVAHOME/include -I$JAVAHOME/include/solaris \</strong>&#13;
	<strong>-G HelloJni.c -o libhello.so</strong></pre>&#13;
&#13;
<p><a data-type="xref" href="#javacook-otherlang-EX-12">Example 18-12</a> is a makefile for Unix.</p>&#13;
<div data-type="example" id="javacook-otherlang-EX-12">&#13;
<h5><span class="label">Example 18-12. </span>main/src/main/java/jni/Makefile (Unix version)</h5>&#13;
&#13;
<pre data-type="programlisting"># Configuration Section&#13;
&#13;
CFLAGS_FOR_SO = -G # Solaris&#13;
CFLAGS_FOR_SO = -shared&#13;
CSRCS        = HelloJni.c&#13;
# JAVA_HOME should be been set in the environment&#13;
#INCLUDES    = -I$(JAVA_HOME)/include -I$(JAVAHOME)/include/solaris&#13;
#INCLUDES    = -I$(JAVA_HOME)/include -I$(JAVAHOME)/include/openbsd&#13;
INCLUDES    = -I$(JAVA_HOME)/include&#13;
&#13;
all:        testhello testjavafromc&#13;
&#13;
# This part of the Makefile is for C called from Java, in HelloJni&#13;
testhello:        hello.all&#13;
        @echo&#13;
        @echo "Here we test the Java code \"HelloJni\" that calls C code."&#13;
        @echo&#13;
        LD_LIBRARY_PATH=`pwd`:. java HelloJni&#13;
&#13;
hello.all:        HelloJni.class libhello.so&#13;
&#13;
HelloJni.class: HelloJni.java&#13;
        javac HelloJni.java&#13;
&#13;
HelloJni.h:    HelloJni.class&#13;
        javah -jni HelloJni&#13;
&#13;
HelloJni.o::    HelloJni.h&#13;
&#13;
libhello.so:    $(CSRCS) HelloJni.h&#13;
    $(CC) $(INCLUDES) $(CFLAGS_FOR_SO) $(CSRCS) -o libhello.so&#13;
&#13;
# This part of the Makefile is for Java called from C, in javafromc&#13;
testjavafromc:    javafromc.all hello.all&#13;
    @echo&#13;
    @echo "Now we test HelloJni using javafromc instead of java"&#13;
    @echo&#13;
    ./javafromc HelloJni&#13;
    @echo&#13;
    @echo "That was, in case you didn't notice, C-&gt;Java-&gt;C. And,"&#13;
    @echo "incidentally, a replacement for JDK program \"java\" itself!"&#13;
    @echo&#13;
&#13;
&#13;
javafromc.all:    javafromc&#13;
&#13;
javafromc:    javafromc.o&#13;
    $(CC) -L$(LIBDIR) javafromc.o -ljava -o $@&#13;
&#13;
javafromc.o:    javafromc.c&#13;
    $(CC) -c $(INCLUDES) javafromc.c&#13;
&#13;
clean:&#13;
    rm -f core *.class *.o *.so HelloJni.h&#13;
clobber: clean&#13;
    rm -f javafromc</pre></div>&#13;
&#13;
<p>And you’re done! Just run the Java interpreter on the class file containing the main&#13;
program. Assuming that you’ve set whatever system-dependent settings are necessary&#13;
(possibly including both <code>CLASSPATH</code> and <code>LD_LIBRARY_PATH</code> or its equivalent), the program&#13;
should run as follows:</p>&#13;
<pre data-type="programlisting" id="I_26_tt729">C&gt; <strong>java jni.HelloJni</strong>&#13;
Hello from a Native Method      // from C&#13;
"myNumber" value is 42          // from C&#13;
"myNumber" value now 43         // from C&#13;
Value of myNumber now 43        // from Java</pre>&#13;
&#13;
<p>Congratulations! You’ve called a native method. However, you’ve given up portability; the Java class file now requires you to build a loadable object for each operating system and hardware platform. Multiply {Windows, Mac OS X, Sun Solaris, HP/UX, Linux, OpenBSD, NetBSD, FreeBSD} times {Intel-32, Intel-64/AMD64, Arm, Arm-64, and maybe SPARC64, PowerPC, and HP-PA}, and you begin to see the portability issues.</p>&#13;
&#13;
<p>Beware that problems with your native code can and will crash the runtime process right out from underneath the Java Virtual Machine. The JVM can do nothing to protect itself from poorly written C/C++ code. Memory must be managed by the programmer; there is no automatic garbage collection of memory obtained by the system runtime allocator. You’re dealing directly with the operating system and sometimes even the hardware, so, be careful. Be very careful.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-5.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>If you need more information on Java native methods, you might be interested in the comprehensive treatment found in<a data-primary="Essential JNI: Java Native Interface (Gordon)" data-type="indexterm" id="idm45290619827224"/><a data-primary="Gordon, Rob" data-secondary="Essential JNI: Java Native Interface" data-type="indexterm" id="idm45290619826424"/> <em>Essential JNI: Java Native Interface</em> by Rob Gordon (Prentice Hall).<a data-primary="" data-startref="jav_clnc" data-type="indexterm" id="idm45290619824872"/><a data-primary="" data-startref="nc_ab" data-type="indexterm" id="idm45290619823928"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="18.7 Calling Java from Native Code" data-type="sect1"><div class="sect1" id="javacook-otherlang-SECT-6">&#13;
<h1>18.7 Calling Java from Native Code</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-6.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Java" data-secondary="calling from native code" data-type="indexterm" id="jav_cfnc"/><a data-primary="native code" data-type="indexterm" id="nc_abo"/>You need to go the other way, calling Java from C/C++ code.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-6.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use JNI again.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-otherlang-SECT-6.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>JNI (Java Native Interface) provides an interface for calling Java from C, with calls to:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create a JVM.</p>&#13;
</li>&#13;
<li>&#13;
<p>Load a class.</p>&#13;
</li>&#13;
<li>&#13;
<p>Find and call a method from that class (e.g., main).</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>JNI lets you add Java to legacy code. That can be useful for a&#13;
variety of purposes and lets you treat Java code as an extension&#13;
language.</p>&#13;
&#13;
<p>The code in<a data-primary="main() method" data-type="indexterm" id="idm45290619809224"/> <a data-type="xref" href="#javacook-otherlang-javaFromC">Example 18-13</a> takes a class name from the&#13;
command line, starts up the JVM, and calls the <code>main()</code> method in the class.<a data-primary="" data-startref="jav_uol" data-type="indexterm" id="idm45290619756568"/></p>&#13;
<div data-type="example" id="javacook-otherlang-javaFromC">&#13;
<h5><span class="label">Example 18-13. </span>main/src/main/java/jni/javafromc.c (Calling Java from C)</h5>&#13;
&#13;
<pre data-code-language="c" data-type="programlisting"><code class="cm">/*</code>&#13;
<code class="cm"> * This is a C program that calls Java code.</code>&#13;
<code class="cm"> * This could be used as a model for building Java into an</code>&#13;
<code class="cm"> * existing application as an extention language, for example.</code>&#13;
<code class="cm"> */</code>&#13;
&#13;
<code class="cp">#include &lt;stdio.h&gt;</code>&#13;
<code class="cp">#include &lt;jni.h&gt;</code>&#13;
&#13;
<code class="kt">int</code>&#13;
<code class="nf">main</code><code class="p">(</code><code class="kt">int</code> <code class="n">argc</code><code class="p">,</code> <code class="kt">char</code> <code class="o">*</code><code class="n">argv</code><code class="p">[])</code> <code class="p">{</code>&#13;
    <code class="kt">int</code> <code class="n">i</code><code class="p">;</code>&#13;
    <code class="n">JavaVM</code> <code class="o">*</code><code class="n">jvm</code><code class="p">;</code>        <code class="cm">/* The Java VM we will use */</code>&#13;
    <code class="n">JNIEnv</code> <code class="o">*</code><code class="n">myEnv</code><code class="p">;</code>        <code class="cm">/* pointer to native environment */</code>&#13;
    <code class="n">JDK1_1InitArgs</code> <code class="n">jvmArgs</code><code class="p">;</code> <code class="cm">/* JNI initialization arguments */</code>&#13;
    <code class="n">jclass</code> <code class="n">myClass</code><code class="p">,</code> <code class="n">stringClass</code><code class="p">;</code>    <code class="cm">/* pointer to the class type */</code>&#13;
    <code class="n">jmethodID</code> <code class="n">myMethod</code><code class="p">;</code>    <code class="cm">/* pointer to the main() method */</code>&#13;
    <code class="n">jarray</code> <code class="n">args</code><code class="p">;</code>        <code class="cm">/* becomes an array of Strings */</code>&#13;
    <code class="n">jthrowable</code> <code class="n">tossed</code><code class="p">;</code>    <code class="cm">/* Exception object, if we get one. */</code>&#13;
&#13;
    <code class="n">JNI_GetDefaultJavaVMInitArgs</code><code class="p">(</code><code class="o">&amp;</code><code class="n">jvmArgs</code><code class="p">);</code>    <code class="cm">/* set up the argument pointer */</code>&#13;
    <code class="cm">/* Could change values now, like: jvmArgs.classpath = ...; */</code>&#13;
&#13;
    <code class="cm">/* initialize the JVM! */</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">JNI_CreateJavaVM</code><code class="p">(</code><code class="o">&amp;</code><code class="n">jvm</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">myEnv</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">jvmArgs</code><code class="p">)</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">fprintf</code><code class="p">(</code><code class="n">stderr</code><code class="p">,</code> <code class="s">"CreateJVM failed</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>&#13;
        <code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="cm">/* find the class named in argv[1] */</code>&#13;
    <code class="k">if</code> <code class="p">((</code><code class="n">myClass</code> <code class="o">=</code> <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">FindClass</code><code class="p">(</code><code class="n">myEnv</code><code class="p">,</code> <code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">]))</code> <code class="o">==</code> <code class="nb">NULL</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">fprintf</code><code class="p">(</code><code class="n">stderr</code><code class="p">,</code> <code class="s">"FindClass %s failed</code><code class="se">\n</code><code class="s">"</code><code class="p">,</code> <code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>&#13;
        <code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="cm">/* find the static void main(String[]) method of that class */</code>&#13;
    <code class="n">myMethod</code> <code class="o">=</code> <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">GetStaticMethodID</code><code class="p">(</code>&#13;
        <code class="n">myEnv</code><code class="p">,</code> <code class="n">myClass</code><code class="p">,</code> <code class="s">"main"</code><code class="p">,</code> <code class="s">"([Ljava/lang/String;)V"</code><code class="p">);</code>&#13;
    <code class="cm">/* myMethod = (*myEnv)-&gt;GetMethodID(myEnv, myClass, "test", "(I)I"); */</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">myMethod</code> <code class="o">==</code> <code class="nb">NULL</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">fprintf</code><code class="p">(</code><code class="n">stderr</code><code class="p">,</code> <code class="s">"GetStaticMethodID failed</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>&#13;
        <code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="cm">/* Since we're calling main, must pass along the command line arguments,</code>&#13;
<code class="cm">     * in the form of Java String array</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="k">if</code> <code class="p">((</code><code class="n">stringClass</code> <code class="o">=</code> <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">FindClass</code><code class="p">(</code><code class="n">myEnv</code><code class="p">,</code> <code class="s">"java/lang/String"</code><code class="p">))</code> <code class="o">==</code> <code class="nb">NULL</code><code class="p">){</code>&#13;
        <code class="n">fprintf</code><code class="p">(</code><code class="n">stderr</code><code class="p">,</code> <code class="s">"get of String class failed!!</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>&#13;
        <code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="cm">/* make an array of Strings, subtracting 1 for progname &amp; 1 for the</code>&#13;
<code class="cm">     * java class name */</code>&#13;
    <code class="k">if</code> <code class="p">((</code><code class="n">args</code> <code class="o">=</code> <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">NewObjectArray</code><code class="p">(</code><code class="n">myEnv</code><code class="p">,</code> <code class="n">argc</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="n">stringClass</code><code class="p">,</code> <code class="nb">NULL</code><code class="p">))</code><code class="o">==</code><code class="nb">NULL</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">fprintf</code><code class="p">(</code><code class="n">stderr</code><code class="p">,</code> <code class="s">"Create array failed!</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>&#13;
        <code class="n">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="cm">/* fill the array */</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">i</code><code class="o">=</code><code class="mi">2</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">argc</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code>&#13;
        <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">SetObjectArrayElement</code><code class="p">(</code><code class="n">myEnv</code><code class="p">,</code>&#13;
            <code class="n">args</code><code class="p">,</code> <code class="n">i</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">NewStringUTF</code><code class="p">(</code><code class="n">myEnv</code><code class="p">,</code> <code class="n">argv</code><code class="p">[</code><code class="n">i</code><code class="p">]));</code>&#13;
&#13;
    <code class="cm">/* finally, call the method. */</code>&#13;
    <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">CallStaticVoidMethodA</code><code class="p">(</code><code class="n">myEnv</code><code class="p">,</code> <code class="n">myClass</code><code class="p">,</code> <code class="n">myMethod</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">args</code><code class="p">);</code>&#13;
&#13;
    <code class="cm">/* And check for exceptions */</code>&#13;
    <code class="k">if</code> <code class="p">((</code><code class="n">tossed</code> <code class="o">=</code> <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">ExceptionOccurred</code><code class="p">(</code><code class="n">myEnv</code><code class="p">))</code> <code class="o">!=</code> <code class="nb">NULL</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">fprintf</code><code class="p">(</code><code class="n">stderr</code><code class="p">,</code> <code class="s">"%s: Exception detected:</code><code class="se">\n</code><code class="s">"</code><code class="p">,</code> <code class="n">argv</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>&#13;
        <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">ExceptionDescribe</code><code class="p">(</code><code class="n">myEnv</code><code class="p">);</code>    <code class="cm">/* writes on stderr */</code>&#13;
        <code class="p">(</code><code class="o">*</code><code class="n">myEnv</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">ExceptionClear</code><code class="p">(</code><code class="n">myEnv</code><code class="p">);</code>    <code class="cm">/* OK, we're done with it. */</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">(</code><code class="o">*</code><code class="n">jvm</code><code class="p">)</code><code class="o">-&gt;</code><code class="n">DestroyJavaVM</code><code class="p">(</code><code class="n">jvm</code><code class="p">);</code>    <code class="cm">/* no error checking as we're done anyhow */</code>&#13;
    <code class="k">return</code> <code class="mi">0</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>====<a data-primary="" data-startref="jav_cfnc" data-type="indexterm" id="idm45290619745112"/><a data-primary="" data-startref="nc_abo" data-type="indexterm" id="idm45290619744264"/></p></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45290622339272"><sup><a href="ch18.html#idm45290622339272-marker">1</a></sup> <em>kwrite</em> is Unix-specific; it’s a part of the <a href="http://www.kde.org">K Desktop Environment (KDE)</a>.</p></div></div></section></body></html>