<html><head></head><body><section data-pdf-bookmark="Chapter 10. Functions to Extension Functions" data-type="chapter" epub:type="chapter"><div class="chapter" id="functions-to-extension-functions">&#13;
<h1><span class="label">Chapter 10. </span>Functions to Extension Functions</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Kotlin has a special kind of procedure called an extension function, that is called like a method but is in fact (usually) a top-level function.&#13;
It’s easy to convert from a normal function to an extension function and back.&#13;
When should we prefer one to the other?</p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Functions and Methods" data-type="sect1"><div class="sect1" id="idm46393394549704">&#13;
<h1>Functions and Methods</h1>&#13;
&#13;
<p>Object-oriented programming<a data-primary="functions to extension functions" data-secondary="functions and methods" data-type="indexterm" id="FEFfunc10"/><a data-primary="object-oriented programming" data-type="indexterm" id="idm46393394546440"/><a data-primary="methods" data-type="indexterm" id="meth10"/> is the art of solving problems by sending messages to objects.&#13;
Want to know the length of <code>myString</code>?&#13;
Ask it by sending it a message <code>myString.length()</code>.&#13;
Want to print that string to the console?&#13;
Put the string in a message and ask another object representing the console to print it for you: &#13;
<span class="keep-together"><code>System.out.println(myString)</code></span>.&#13;
In classic OO languages, we define how an object reacts to a message by defining methods on classes.&#13;
Methods are bound to their class and have access to the members (fields and other methods) associated with a particular instance.&#13;
When we invoke a method, the runtime arranges for the correct version to be called (depending on the runtime type of the object), and for it to have access to instance state.</p>&#13;
&#13;
<p>In<a data-primary="functional programming" data-type="indexterm" id="idm46393394541816"/> contrast, in functional programming, we solve problems by calling functions with values.&#13;
We find the length of <code>myString</code> by passing it to a function: <code>length(myString)</code>.&#13;
We print to the console with <code>println(myString)</code>, and if we wanted to print somewhere else, we would pass that to the function: <code>println(myString, System.err)</code>.&#13;
Functions are not defined <em>on</em> a type; function parameters and results <em>have</em> a type.</p>&#13;
&#13;
<p>The<a data-primary="discoverability" data-type="indexterm" id="idm46393394538008"/><a data-primary="extensibility" data-type="indexterm" id="idm46393394537272"/> paradigms have pros and cons, but for now let’s just consider discoverability and extensibility.</p>&#13;
&#13;
<p>Here is a <code>Customer</code> type:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Customer</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">givenName</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">familyName</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This is a class, so straightaway we know that we can send messages to ask for the <code>id</code>, <code>givenName</code>, and <code>familyName</code>.&#13;
What about other operations?&#13;
In a class-based system, we only have to scroll down to see another message that we can send:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Customer</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">givenName</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">familyName</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">fullName</code> <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$givenName $familyName"</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Often we don’t even get as far as looking at the definition.&#13;
If we have a variable <code>val customer: Customer</code>, we can type <code>customer.</code> and our IDE will eagerly tell us that we can call <code>id</code>, <code>givenName</code>, <code>familyName</code>, or <code>fullName</code>.&#13;
In fact, this auto-complete is in many ways better than looking at the class definition, because it also shows us other operations (<code>equals</code>, <code>copy</code>, and so on) that are defined in supertypes or implicit in the language.</p>&#13;
&#13;
<p>In<a data-primary="functional decomposition" data-type="indexterm" id="idm46393394425832"/> a functional decomposition, <code>fullName</code> would be a function, and, if we suspect it exists, we would have to search our codebase for it.&#13;
In this case it will be a function where the only argument is of type <code>Customer</code>.&#13;
It’s surprisingly hard to get IntelliJ to help us.&#13;
“Find Usages” grouped by parameter type will do the job, but it’s hardly convenient.&#13;
In practice, we expect to find the definition of <code>Customer</code> and its fundamental operations close together in the source, perhaps in the same file or at least namespace, so we might navigate there and find the functions where we expect them, but our tools haven’t been very helpful.</p>&#13;
&#13;
<p>Score one to OO for discoverability then.&#13;
What about extensibility?&#13;
What happens when we want to add an operation to <code>Customer</code>?&#13;
Marketing would like to render the name reversed with the <code>familyName</code> in uppercase for some report or other.&#13;
(You may notice that whenever we need a simple but arbitrary example, we blame marketing.)</p>&#13;
&#13;
<p>If we own the code, we can just add a method:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Customer</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">givenName</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">familyName</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">fullName</code> <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$givenName $familyName"</code>&#13;
    <code class="k">fun</code> <code class="nf">nameForMarketing</code><code class="p">()</code> <code class="p">=</code> <code class="s">"${familyName.uppercase()}, $givenName}"</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If we don’t own the code, then we can’t add a method, so we have to fall back on a function.&#13;
In Java we might have a collection of these static functions in a class called <code>Marketing</code>, or <code>CustomerUtils</code>.&#13;
In<a data-primary="top-level functions" data-type="indexterm" id="idm46393394342472"/> Kotlin we can make them top-level functions (see <a data-type="xref" href="ch08.html#static-methods-to-top-level-functions">Chapter 8</a>), but the principle is the same:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">nameForMarketing</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">Customer</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="s">"${customer.familyName.uppercase()}, $customer.givenName}"</code></pre>&#13;
&#13;
<p>What of the functional solution?&#13;
Well, this is the functional solution, too.&#13;
So the functional solution is arguably better for extensibility, because extension operations are indistinguishable from those (like <code>fullName</code>) provided by the original authors, whereas the OO solution makes us look for two different types of implementation: methods and functions.</p>&#13;
&#13;
<p>Even if we <em>do</em> own the code for the <code>Customer</code> class, we should be wary of adding methods like <code>nameForMarketing</code>.&#13;
If the class <code>Customer</code> is a fundamental domain class in our application, lots of other code will depend on it.&#13;
Adding a report for marketing shouldn’t force us to recompile and retest everything, but it will if we add a method.&#13;
So it’s better that we keep <code>Customer</code> as small as possible and have noncore operations as external functions, even if this means they are not as discoverable as methods.</p>&#13;
&#13;
<p>In Kotlin, those functions don’t have to be as hard to find as we’ve made out, though; they can be extension functions.<a data-primary="" data-startref="meth10" data-type="indexterm" id="idm46393394329208"/><a data-primary="" data-startref="FEFfunc10" data-type="indexterm" id="idm46393394324456"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Extension Functions" data-type="sect1"><div class="sect1" id="idm46393394549080">&#13;
<h1>Extension Functions</h1>&#13;
&#13;
<p>Kotlin’s extension functions<a data-primary="extension functions" data-seealso="functions to extension functions" data-type="indexterm" id="idm46393394321816"/><a data-primary="functions to extension functions" data-secondary="extension functions" data-type="indexterm" id="idm46393394320872"/> look like methods, but are in fact just functions.&#13;
(As we saw in <a data-type="xref" href="ch08.html#static-methods-to-top-level-functions">Chapter 8</a>, technically they are <em>also</em> methods, because on the JVM all code has to be defined in a method.&#13;
In <a data-type="xref" href="#extension-functions-as-methods">“Extension Functions as Methods”</a>, we’ll see that extension functions can in fact also be nonstatic methods of another class.)</p>&#13;
&#13;
<p>As their name implies, extension functions give us the ability to <em>extend</em> the operations available on a type.&#13;
They do this while supporting the intuitive, dot-means-send-a-message calling convention of methods, which allows them to be discoverable in the same Ctrl-Space way.</p>&#13;
&#13;
<p>So we can define an extension function:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Customer</code><code class="p">.</code><code class="n">nameForMarketing</code><code class="p">()</code> <code class="p">=</code> <code class="s">"${familyName.uppercase()}, $givenName}"</code></pre>&#13;
&#13;
<p>Then we can call it as if it is a method:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">s</code> <code class="p">=</code> <code class="n">customer</code><code class="p">.</code><code class="n">nameForMarketing</code><code class="p">()</code></pre>&#13;
&#13;
<p>IntelliJ will auto-suggest extension functions along with the actual methods, even if they need to be imported to bring them into scope.</p>&#13;
&#13;
<p>Java isn’t quite so helpful—it just sees the extension function as a static function:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">s</code> <code class="o">=</code> <code class="n">MarketingStuffKt</code><code class="o">.</code><code class="na">nameForMarketing</code><code class="o">(</code><code class="n">customer</code><code class="o">);</code></pre>&#13;
&#13;
<p><code>MarketingStuffKt</code> is the name of the class containing our top-level declarations as static methods; see <a data-type="xref" href="ch08.html#static-methods-to-top-level-functions">Chapter 8</a>.</p>&#13;
&#13;
<p>Interestingly, we can’t call the function in the same way from Kotlin:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">nameForMarketing</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code> <code class="c1">// doesn't compile</code></pre>&#13;
&#13;
<p>This fails to compile, with the error:</p>&#13;
<blockquote>&#13;
<p><code>Unresolved reference. None of the following candidates is applicable because of receiver type mismatch:&#13;
public fun Customer.nameForMarketing(): String ...</code>.</p></blockquote>&#13;
&#13;
<p><em>Receiver</em>, by<a data-primary="receivers" data-type="indexterm" id="idm46393394261752"/> the way, is the term that Kotlin uses for the object named <code>this</code> in an extension function (or normal method): the object that receives messages.</p>&#13;
&#13;
<p>Note that extension functions don’t have any special access to the private members of the class that they are extending; they only have the same privileges as normal functions in their scope.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Extensions and Function Types" data-type="sect1"><div class="sect1" id="idm46393394322920">&#13;
<h1>Extensions and Function Types</h1>&#13;
&#13;
<p>Although<a data-primary="functions to extension functions" data-secondary="extensions and function types" data-type="indexterm" id="idm46393394258520"/> we can’t call extension functions as normal functions in Kotlin, we can assign them to normal function references. So the following compiles:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">methodReference</code><code class="p">:</code> <code class="p">(</code><code class="n">Customer</code><code class="p">.()</code> <code class="p">-&gt;</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">Customer</code><code class="o">::</code><code class="n">fullName</code>&#13;
<code class="k">val</code> <code class="py">extensionFunctionReference</code><code class="p">:</code> <code class="p">(</code><code class="n">Customer</code><code class="p">.()</code> <code class="p">-&gt;</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">Customer</code><code class="o">::</code><code class="n">nameForMarketing</code>&#13;
&#13;
<code class="k">val</code> <code class="py">methodAsFunctionReference</code><code class="p">:</code> <code class="p">(</code><code class="n">Customer</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">methodReference</code>&#13;
<code class="k">val</code> <code class="py">extensionAsFunctionReference</code><code class="p">:</code> <code class="p">(</code><code class="n">Customer</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">extensionFunctionReference</code></pre>&#13;
&#13;
<p>We can invoke these as expected:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">customer</code><code class="p">.</code><code class="n">methodReference</code><code class="p">()</code>&#13;
<code class="n">customer</code><code class="p">.</code><code class="n">extensionFunctionReference</code><code class="p">()</code>&#13;
&#13;
<code class="n">methodAsFunctionReference</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code>&#13;
<code class="n">extensionAsFunctionReference</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code></pre>&#13;
&#13;
<p>We can also use the <em>with-receiver</em> references as if they took the receiver as the first argument:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">methodReference</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code>&#13;
<code class="n">extensionFunctionReference</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code></pre>&#13;
&#13;
<p>We cannot, however, call the plain references as if they had a receiver.&#13;
Both of these lines fail to compile, with an <code>Unresolved reference</code> error:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">customer</code><code class="p">.</code><code class="n">methodAsFunctionReference</code><code class="p">()</code>&#13;
<code class="n">customer</code><code class="p">.</code><code class="n">extensionAsFunctionReference</code><code class="p">()</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Extension Properties" data-type="sect1"><div class="sect1" id="idm46393394010312">&#13;
<h1>Extension Properties</h1>&#13;
&#13;
<p>Kotlin<a data-primary="functions to extension functions" data-secondary="extension properties" data-type="indexterm" id="idm46393394062072"/> also supports extension properties.&#13;
As we discuss in <a data-type="xref" href="ch11.html#methods-to-properties">Chapter 11</a>, Kotlin property accessors are actually method calls.&#13;
In the same way that extension functions are static functions that are called like methods, extension properties are static functions that are called like properties, which are in turn methods.&#13;
Extension properties can’t store any data because they don’t really add fields to their class—their value can only be computed.</p>&#13;
&#13;
<p>The <code>nameForMarketing</code> function could have been defined as an extension <em>property</em>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">Customer</code><code class="p">.</code><code class="n">nameForMarketing</code> <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"${familyName.uppercase()}, $givenName}"</code></pre>&#13;
&#13;
<p>In fact, it probably <em>should</em> be a property, as we will discuss in <a data-type="xref" href="ch11.html#methods-to-properties">Chapter 11</a>.</p>&#13;
&#13;
<p>Most of what we have to say about extension functions applies to extension properties unless we specifically distinguish between them.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Extensions Are Not Polymorphic</h1>&#13;
<p>Although<a data-primary="method calls" data-type="indexterm" id="idm46393393987288"/><a data-primary="polymorphic method calls" data-type="indexterm" id="idm46393393986552"/> invoking an extension function looks like a method call, it is not, in fact, sending a message to an object.&#13;
For polymorphic method calls, Kotlin uses the dynamic type of the receiver at runtime to select the method to execute.&#13;
For extensions, Kotlin uses the static type of the receiver at compile time to select the function to call.</p>&#13;
&#13;
<p>If we need to use extensions in a polymorphic way, we can often achieve this by calling polymorphic methods from our extension functions.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conversions" data-type="sect1"><div class="sect1" id="idm46393393984632">&#13;
<h1>Conversions</h1>&#13;
&#13;
<p>So far, we<a data-primary="functions to extension functions" data-secondary="type conversions" data-type="indexterm" id="FEFtype10"/><a data-primary="type conversions" data-type="indexterm" id="tycon10"/> have seen extension functions adding operations to a type.&#13;
Conversions from one type to another are a common case.&#13;
Travelator needs to convert customer details to and from JSON and XML.&#13;
How should we convert from <code>JsonNode</code> to &#13;
<span class="keep-together"><code>Customer</code></span>?</p>&#13;
&#13;
<p>We could add a constructor: <code>Customer(JsonNode)</code> that knows how to extract the relevant data, but it really doesn’t feel right to pollute our <code>Customer</code> class with dependencies on a specific JSON library, and then maybe an XML parser, and then what?&#13;
The same argument applies to adding conversions to the <code>JsonNode</code> class.&#13;
Even if we <em>could</em> change its code, pretty soon it would be unmanageable with all the <code>JsonNode.toMyDomainType()</code> methods.</p>&#13;
&#13;
<p class="pagebreak-before">In Java, we would write a class of utility functions of the form:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">static</code> <code class="n">Customer</code> <code class="nf">toCustomer</code><code class="o">(</code><code class="n">JsonNode</code> <code class="n">node</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Or with Nat and Duncan’s preferred naming convention:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">static</code> <code class="n">Customer</code> <code class="nf">customerFrom</code><code class="o">(</code><code class="n">JsonNode</code> <code class="n">node</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393393904824">&#13;
<h5>How to Name Conversions</h5>&#13;
<p>A<a data-primary="naming conventions" data-type="indexterm" id="idm46393393911368"/><a data-primary="functions" data-secondary="naming conventions" data-type="indexterm" id="idm46393393910632"/> function converting a <code>JsonNode</code> to a <code>Customer</code> might be called <code>nodeToCustomer</code>, <code>createCustomer</code>, <code>toCustomer</code>, <code>customerFrom</code>, or <code>customerFor</code>.&#13;
Why should we pick <code>customerFrom</code>? Let’s examine the alternatives where they are invoked.</p>&#13;
&#13;
<p><code>nodeToCustomer</code> is OK, but the repetition of <code>node</code> is irritating when called:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">nodeToCustomer</code><code class="o">(</code><code class="n">node</code><code class="o">)</code></pre>&#13;
&#13;
<p><code>createCustomer</code> is OK, but doesn’t hint at the relationship between <code>node</code> and <code>customer</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">createCustomer</code><code class="o">(</code><code class="n">node</code><code class="o">)</code></pre>&#13;
&#13;
<p><code>toCustomer</code> lets us know that <code>node</code> contains everything we need to create a <code>Customer</code>, but doesn’t flow in English:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">toCustomer</code><code class="o">(</code><code class="n">node</code><code class="o">)</code></pre>&#13;
&#13;
<p>Our preferred <code>customerFrom</code> flows, and hints that we are extracting the data for &#13;
<span class="keep-together"><code>customer</code></span> from <code>node</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">customerFrom</code><code class="o">(</code><code class="n">node</code><code class="o">)</code></pre>&#13;
&#13;
<p>We could also try <code>customerFor</code>, which also flows:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">customerFor</code><code class="o">(</code><code class="n">node</code><code class="o">)</code></pre>&#13;
&#13;
<p>But <code>customerFor</code> suggests a different relationship than parsing.&#13;
<em>For</em> implies a lookup operation: <code>phoneNumberFor(customer)</code>, or composition: <code>wheelFor(bicycle)</code>.</p>&#13;
&#13;
<p>Do these distinctions actually matter?&#13;
Mostly no, and we should be wary of leaning on the subtleties of English when our teammates and clients may not be native speakers.&#13;
But there is no point in not using the bestest words that we can.&#13;
Compared to <code>createCustomer(node)</code>, the use of <code>customerFrom(node)</code> may help a reader understand what is happening in one pass rather than two, or prevent an incorrect assumption that leads to an error.&#13;
We can make small but significant improvements by optimizing how our code reads in context.</p>&#13;
</div></aside>&#13;
&#13;
<p class="pagebreak-before">Calling the conversions individually isn’t too horrible:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">customer</code> <code class="o">=</code> <code class="n">customerFrom</code><code class="o">(</code><code class="n">node</code><code class="o">);</code>&#13;
<code class="n">var</code> <code class="n">marketingName</code> <code class="o">=</code> <code class="n">nameForMarketing</code><code class="o">(</code><code class="n">customer</code><code class="o">);</code></pre>&#13;
&#13;
<p>If we need to combine functions, though, things start to go awry:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">var</code> <code class="n">marketingLength</code> <code class="o">=</code> <code class="n">nameForMarketing</code><code class="o">(</code><code class="n">customerFrom</code><code class="o">(</code><code class="n">node</code><code class="o">)).</code><code class="na">length</code><code class="o">();</code></pre>&#13;
&#13;
<p>We’re all developers here, and used to reading function invocations.&#13;
So it’s easy to underestimate the cognitive load of searching for the innermost call and working your way out through function and method calls to compute how an expression evaluates.&#13;
Not what it evaluates to, just the order in which it evaluates.&#13;
In Kotlin, we can write the conversion as an extension on <code>JsonNode</code> and enjoy a soothing flow from left to right:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">JsonNode</code><code class="p">.</code><code class="n">toCustomer</code><code class="p">():</code> <code class="n">Customer</code> <code class="p">=</code> <code class="p">...</code>&#13;
&#13;
<code class="k">val</code> <code class="py">marketingLength</code> <code class="p">=</code> <code class="n">jsonNode</code><code class="p">.</code><code class="n">toCustomer</code><code class="p">().</code><code class="n">nameForMarketing</code><code class="p">().</code><code class="n">length</code></pre>&#13;
&#13;
<p>Ahh…that’s much more readable.<a data-primary="" data-startref="FEFtype10" data-type="indexterm" id="idm46393393653368"/><a data-primary="" data-startref="tycon10" data-type="indexterm" id="idm46393393652520"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Nullable Parameters" data-type="sect1"><div class="sect1" id="idm46393393984008">&#13;
<h1>Nullable Parameters</h1>&#13;
&#13;
<p>Extensions<a data-primary="functions to extension functions" data-secondary="nullable parameters" data-type="indexterm" id="idm46393393649688"/><a data-primary="nullability" data-secondary="nullable parameters" data-type="indexterm" id="idm46393393648712"/><a data-primary="?. operator" data-type="indexterm" id="questop10"/> really come into their own when we work with optional data.&#13;
When we are sending messages to a potentially <code>null</code> object, we can use the safe-call operator <code>?.</code> that we saw in <a data-type="xref" href="ch04.html#optional-to-nullable">Chapter 4</a>.&#13;
That doesn’t help with parameters though; to pass a nullable reference as an argument to a function that takes a nonnull parameter, we have to wrap the call in conditional logic:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">customer</code><code class="p">:</code> <code class="n">Customer</code><code class="p">?</code> <code class="p">=</code> <code class="n">loggedInCustomer</code><code class="p">()</code>&#13;
<code class="k">val</code> <code class="py">greeting</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="k">when</code> <code class="p">(</code><code class="n">customer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">null</code> <code class="p">-&gt;</code> <code class="k">null</code>&#13;
    <code class="k">else</code> <code class="p">-&gt;</code> <code class="n">greetingForCustomer</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Kotlin’s<a data-primary="scoping functions" data-type="indexterm" id="idm46393393570408"/><a data-primary="functions" data-secondary="scoping functions" data-type="indexterm" id="idm46393393552584"/> <em>scoping functions</em>, such as <code>let</code>, <code>apply</code>, and <code>also</code>, can help here.&#13;
In particular, <code>let</code> converts its receiver into a lambda parameter:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">customer</code><code class="p">:</code> <code class="n">Customer</code><code class="p">?</code> <code class="p">=</code> <code class="n">loggedInCustomer</code><code class="p">()</code>&#13;
<code class="k">val</code> <code class="py">greeting</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="n">customer</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="n">greetingForCustomer</code><code class="p">(</code><code class="n">it</code><code class="p">)</code> <code class="p">}</code></pre>&#13;
&#13;
<p>Here<a data-primary="?.let expression" data-type="indexterm" id="idm46393393530792"/> the <code>?.</code> ensures that <code>let</code> is only called when the customer is not <code>null</code>, meaning that the lambda parameter, <code>it</code>, is never null, and can be passed to the function within the lambda body.&#13;
You can think of <code>?.let</code> as a<a data-primary="safe-call operator" data-type="indexterm" id="idm46393393504888"/> safe-call operator for (single) arguments.</p>&#13;
&#13;
<p>If a function returns a nullable result, and we must pass that result to another function that expects a nonnull parameter, the scoping functions start to get cumbersome:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">customer</code><code class="p">:</code> <code class="n">Customer</code><code class="p">?</code> <code class="p">=</code> <code class="n">loggedInCustomer</code><code class="p">()</code>&#13;
&#13;
<code class="k">val</code> <code class="py">reminder</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="n">customer</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code>&#13;
    <code class="n">nextTripForCustomer</code><code class="p">(</code><code class="n">it</code><code class="p">)</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code>&#13;
        <code class="n">timeUntilDepartureOfTrip</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">currentTime</code><code class="p">)</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code>&#13;
            <code class="n">durationToUserFriendlyText</code><code class="p">(</code><code class="n">it</code><code class="p">)</code> <code class="p">+</code> <code class="s">" until your next trip!"</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Even when we can flatten nested null checks into a pipeline of calls to <code>let</code>, all this additional mechanism adds syntactic noise and obscures the <em>intent</em> of the code:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">reminder</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="n">customer</code>&#13;
    <code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="n">nextTripForCustomer</code><code class="p">(</code><code class="n">it</code><code class="p">)</code> <code class="p">}</code>&#13;
    <code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="n">timeUntilDepartureOfTrip</code><code class="p">(</code><code class="n">it</code><code class="p">,</code> <code class="n">currentTime</code><code class="p">)</code> <code class="p">}</code>&#13;
    <code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="n">durationToUserFriendlyText</code><code class="p">(</code><code class="n">it</code><code class="p">)</code> <code class="p">}</code>&#13;
    <code class="o">?.</code><code class="n">let</code> <code class="p">{</code> <code class="n">it</code> <code class="p">+</code> <code class="s">" until your next trip!"</code> <code class="p">}</code></pre>&#13;
&#13;
<p>If we convert the problematic parameters to extension function receivers, we can chain calls directly, bringing the application logic to the fore:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">reminder</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="n">customer</code>&#13;
    <code class="o">?.</code><code class="n">nextTrip</code><code class="p">()</code>&#13;
    <code class="o">?.</code><code class="n">timeUntilDeparture</code><code class="p">(</code><code class="n">currentTime</code><code class="p">)</code>&#13;
    <code class="o">?.</code><code class="n">toUserFriendlyText</code><code class="p">()</code>&#13;
    <code class="o">?.</code><code class="n">plus</code><code class="p">(</code><code class="s">" until your next trip!"</code><code class="p">)</code></pre>&#13;
&#13;
<p>When Nat and Duncan first adopted Kotlin, they soon found that extensions and nullability form a virtuous circle.&#13;
It was easier to process optional data with extension functions, so they extracted extensions private to the file or refactored functions into extensions where it made logic easier to write.&#13;
They found that the names of these extensions could be more concise than that of an equivalent function without obscuring intent.&#13;
As a result, they wrote more extensions to make their application logic concise.&#13;
Private extensions often proved to be useful elsewhere, so they moved them into common modules where they could easily be shared.&#13;
This made it easier to use optional data in other parts of the application, which led them to write more extensions, which made application logic more concise…and so on.</p>&#13;
&#13;
<p>Although extensions are promoted as a way to extend third-party types, the concise naming they allow, and nullability in the type system, encourage us to define extensions on our own types as well.&#13;
Part of the grain of Kotlin is the way these features interact to smooth our way.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Nullable Receivers" data-type="sect1"><div class="sect1" id="idm46393393651016">&#13;
<h1>Nullable Receivers</h1>&#13;
&#13;
<p>One<a data-primary="functions to extension functions" data-secondary="nullable receivers" data-type="indexterm" id="idm46393393288520"/><a data-primary="receivers" data-type="indexterm" id="idm46393393287544"/><a data-primary="nullability" data-secondary="nullable receivers" data-type="indexterm" id="idm46393393286872"/> major difference between invoking a method and calling a function is in the treatment of <code>null</code> references.&#13;
If we have a reference that is <code>null</code>, we can’t send a message to it, because there is nothing to send a message to—the JVM throws a <code>Null​Poin⁠terException</code> if we try.&#13;
In contrast, we are able to have <code>null</code> <em>parameters</em>.&#13;
We may not know what to do with them, but they don’t prevent the runtime from finding code to invoke.</p>&#13;
&#13;
<p>Because the receiver in an extension function is actually a parameter, it <em>can</em> be <code>null</code>.&#13;
So while <code>anObject.method()</code> and <code>anObject.extensionFunction()</code> look like equivalent calls, <code>method</code> can never be called if <code>anObject</code> is <code>null</code>, whereas <code>extensionFunction</code> can be called with <code>null</code>, if the receiver is nullable.</p>&#13;
&#13;
<p>We could use this to extract out the steps that generate the reminder in the previous pipeline, into an extension on <code>Trip?</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Trip</code><code class="o">?.</code><code class="n">reminderAt</code><code class="p">(</code><code class="n">currentTime</code><code class="p">:</code> <code class="n">ZonedDateTime</code><code class="p">):</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code>&#13;
    <code class="k">this</code><code class="o">?.</code><code class="n">timeUntilDeparture</code><code class="p">(</code><code class="n">currentTime</code><code class="p">)</code>&#13;
        <code class="o">?.</code><code class="n">toUserFriendlyText</code><code class="p">()</code>&#13;
        <code class="o">?.</code><code class="n">plus</code><code class="p">(</code><code class="s">" until your next trip!"</code><code class="p">)</code></pre>&#13;
&#13;
<p>Note<a data-primary="safe-call operator" data-type="indexterm" id="idm46393393247944"/> that we have to use the safe-call operator to dereference <code>this</code> inside the extension.&#13;
Although <code>this</code> is never <code>null</code> inside a method, it can be inside an extension of a nullable type.&#13;
A <code>null</code> <code>this</code> can be surprising if you’re coming from Java, where it can never happen, but for extensions, Kotlin treats <code>this</code> as just another nullable &#13;
<span class="keep-together">parameter</span>.</p>&#13;
&#13;
<p>We can call this function on a nullable <code>Trip</code> without the noise of the <code>?.</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">reminder</code><code class="p">:</code> <code class="n">String</code><code class="p">?</code> <code class="p">=</code> <code class="n">customer</code><code class="p">.</code><code class="n">nextTrip</code><code class="p">().</code><code class="n">reminderAt</code><code class="p">(</code><code class="n">currentTime</code><code class="p">)</code></pre>&#13;
&#13;
<p>On the other hand, we’ve made the flow of nullability in the calling function harder to understand, because although type-checked, it is not visible in the code of the pipelines that calls the extension.</p>&#13;
&#13;
<p><code>Trip?.reminderAt</code> has another, more obtrusive, drawback: the return type is always the nullable <code>String?</code> even if called on a nonnullable <code>Trip</code>.&#13;
In that case we will find ourselves writing code like:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">trip</code><code class="p">:</code> <code class="n">Trip</code> <code class="p">=</code> <code class="p">...</code>&#13;
<code class="k">val</code> <code class="py">reminder</code><code class="p">:</code> <code class="n">String</code> <code class="p">=</code> <code class="n">trip</code><code class="p">.</code><code class="n">reminderAt</code><code class="p">(</code><code class="n">currentTime</code><code class="p">)</code> <code class="o">?:</code> <code class="n">error</code><code class="p">(</code><code class="s">"Should never happen"</code><code class="p">)</code></pre>&#13;
&#13;
<p>This a bug waiting to happen when code around it changes, because we’ve made it impossible for the type checker to detect an incompatible change.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Don’t write extensions on nullable types that return <code>null</code> if the receiver is <code>null</code>.&#13;
Write an extension on the nonnullable type and use the safe-call operator to invoke it.</p>&#13;
</div>&#13;
&#13;
<p>Extensions on nullable types can be useful though, when they return a nonnullable result.&#13;
They act as an escape route from the realm of nullable values back to the realm of nonnullable values, terminating a pipeline of safe calls.&#13;
For example, we can make the <code>reminderAt</code> extension return some meaningful text even when the customer doesn’t have a next trip:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Trip</code><code class="o">?.</code><code class="n">reminderAt</code><code class="p">(</code><code class="n">currentTime</code><code class="p">:</code> <code class="n">ZonedDateTime</code><code class="p">):</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="k">this</code><code class="o">?.</code><code class="n">timeUntilDeparture</code><code class="p">(</code><code class="n">currentTime</code><code class="p">)</code>&#13;
        <code class="o">?.</code><code class="n">toUserFriendlyText</code><code class="p">()</code>&#13;
        <code class="o">?.</code><code class="n">plus</code><code class="p">(</code><code class="s">" until your next trip!"</code><code class="p">)</code>&#13;
        <code class="o">?:</code> <code class="s">"Start planning your next trip.  The world's your oyster!"</code></pre>&#13;
&#13;
<p>Similarly, here are two extension functions that we probably should have introduced in <a data-type="xref" href="ch04.html#optional-to-nullable">Chapter 4</a>.&#13;
The first is defined on any nullable type, but always returns a nonnull result:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="err">&lt;</code><code class="nf">T</code> <code class="p">:</code> <code class="n">Any</code><code class="p">&gt;</code> <code class="n">T</code><code class="o">?.</code><code class="n">asOptional</code><code class="p">():</code> <code class="n">Optional</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">Optional</code><code class="p">.</code><code class="n">ofNullable</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="err">&lt;</code><code class="nf">T</code> <code class="p">:</code> <code class="n">Any</code><code class="p">&gt;</code> <code class="n">Optional</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;.</code><code class="n">asNullable</code><code class="p">():</code> <code class="n">T</code><code class="p">?</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">orElse</code><code class="p">(</code><code class="k">null</code><code class="p">)</code></pre>&#13;
&#13;
<p>This neatly brings up the subject of generic extensions.<a data-primary="" data-startref="questop10" data-type="indexterm" id="idm46393393097144"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generics" data-type="sect1"><div class="sect1" id="idm46393393340296">&#13;
<h1>Generics</h1>&#13;
&#13;
<p>Just<a data-primary="functions to extension functions" data-secondary="generics" data-type="indexterm" id="idm46393393023288"/><a data-primary="receivers" data-type="indexterm" id="idm46393393022312"/><a data-primary="generic parameters" data-type="indexterm" id="idm46393393021640"/> as with normal functions, extensions can have generic parameters, and things become really interesting when the receiver is generic.</p>&#13;
&#13;
<p>Here’s a useful extension function that for some reason isn’t part of the standard library.&#13;
It is defined as an extension on any type, including <code>null</code> references:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="err">&lt;</code><code class="nf">T</code><code class="p">&gt;</code> <code class="n">T</code><code class="p">.</code><code class="n">printed</code><code class="p">():</code> <code class="n">T</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">also</code><code class="p">(</code><code class="o">::</code><code class="n">println</code><code class="p">)</code></pre>&#13;
&#13;
<p>We can use this when we want to debug the value of an expression in place.&#13;
For example, remember this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">marketingLength</code> <code class="p">=</code> <code class="n">jsonNode</code><code class="p">.</code><code class="n">toCustomer</code><code class="p">().</code><code class="n">nameForMarketing</code><code class="p">().</code><code class="n">length</code></pre>&#13;
&#13;
<p>If we need to see the value of the customer for debugging, we would normally need to pull out a variable:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">customer</code> <code class="p">=</code> <code class="n">jsonNode</code><code class="p">.</code><code class="n">toCustomer</code><code class="p">()</code>&#13;
<code class="n">println</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code>&#13;
<code class="k">val</code> <code class="py">marketingLength</code> <code class="p">=</code> <code class="n">customer</code><code class="p">.</code><code class="n">nameForMarketing</code><code class="p">().</code><code class="n">length</code></pre>&#13;
&#13;
<p>With <code>printed</code>, we have a function that prints the value of the receiver and returns it unchanged, so that we can write:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">marketingLength</code> <code class="p">=</code> <code class="n">jsonNode</code><code class="p">.</code><code class="n">toCustomer</code><code class="p">().</code><code class="n">printed</code><code class="p">().</code><code class="n">nameForMarketing</code><code class="p">().</code><code class="n">length</code></pre>&#13;
&#13;
<p>which is much less disruption and easy to search for before we check in.</p>&#13;
&#13;
<p>Note that even if we had been able to add a method to <code>Any?</code>, there is no way for a method to say that it returns the same type as its receiver.&#13;
Had we written:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Any</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">printed</code><code class="p">()</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">also</code><code class="p">(</code><code class="o">::</code><code class="n">println</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>the return type would have been <code>Any</code>, so we could not then invoke <code>nameForMarketing()</code> etc. on the result.</p>&#13;
&#13;
<p>We can also define extension functions for specialized generic types, for example, <code>Iterable&lt;Customer&gt;</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Iterable</code><code class="p">&lt;</code><code class="n">Customer</code><code class="p">&gt;.</code><code class="n">familyNames</code><code class="p">():</code> <code class="n">Set</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="k">this</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">Customer</code><code class="o">::</code><code class="n">familyName</code><code class="p">).</code><code class="n">toSet</code><code class="p">()</code></pre>&#13;
&#13;
<p>This extension function is applicable to any <code>Collection&lt;Customer&gt;</code> but not to collections of other types.&#13;
This allows us to use collections to represent domain concepts rather than defining our own types, as we will see in <a data-type="xref" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15</a>.&#13;
We can also extract parts of collections pipelines into named operations; see <a data-type="xref" href="ch13.html#extracting-part-of-a-pipeline">“Extracting Part of a Pipeline”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Extension Functions as Methods" data-type="sect1"><div class="sect1" id="extension-functions-as-methods">&#13;
<h1>Extension Functions as Methods</h1>&#13;
&#13;
<p>We<a data-primary="functions to extension functions" data-secondary="extension functions as methods" data-type="indexterm" id="idm46393392798520"/><a data-primary="methods" data-type="indexterm" id="idm46393392774424"/> normally define extension functions as top-level functions.&#13;
They can, though, be defined <em>inside</em> a class definition.&#13;
In this case they can access the members of their own class and <em>extend</em> another type:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">JsonWriter</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">objectMapper</code><code class="p">:</code> <code class="n">ObjectMapper</code><code class="p">,</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">Customer</code><code class="p">.</code><code class="n">toJson</code><code class="p">():</code> <code class="n">JsonNode</code> <code class="p">=</code> <code class="n">objectMapper</code><code class="p">.</code><code class="n">valueToTree</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Here <code>Customer.toJson</code> has access to two values of <code>this</code>.&#13;
It can refer to the <code>Customer</code> receiver of the extension function or the <code>JsonWriter</code> instance of the method.&#13;
In longhand, the function is:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Customer</code><code class="p">.</code><code class="n">toJson</code><code class="p">():</code> <code class="n">JsonNode</code> <code class="p">=</code>&#13;
    <code class="k">this</code><code class="n">@JsonWriter</code><code class="p">.</code><code class="n">objectMapper</code><code class="p">.</code><code class="n">valueToTree</code><code class="p">(</code><code class="k">this</code><code class="n">@toJson</code><code class="p">)</code></pre>&#13;
&#13;
<p>This isn’t a technique that we should use too often (it can be hard to interpret which receiver applies without IDE assistance), but it can simplify code by allowing the simple left-to-right reading of extension functions while hiding details that would complicate things.&#13;
In particular, it allows DSLs to hide details (like the <code>ObjectMapper</code>) that clients shouldn’t be bothered by.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring to Extension Functions" data-type="sect1"><div class="sect1" id="refactoring-to-extension-functions">&#13;
<h1>Refactoring to Extension Functions</h1>&#13;
&#13;
<p>The<a data-primary="functions to extension functions" data-secondary="refactoring to extension functions" data-type="indexterm" id="FEFref10"/><a data-primary="refactoring" data-secondary="functions to extension functions" data-type="indexterm" id="Rfunctions10"/> actual mechanics of converting a static method to an extension function are simple, but we have to hone a sense for where an extension function will make things better.&#13;
Let’s work our way through a part of Travelator and see how we do.</p>&#13;
&#13;
<p>Those clever people in marketing have come up with a spreadsheet that gives customers a score according to how valuable they are to the company: their expected future spending.&#13;
They’re constantly tweaking the algorithm, so they don’t want us to automate that.&#13;
Instead, they export a tab-separated file of customer data, score, and spend, and we produce a summary report from that file.&#13;
Here are our tests:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">HighValueCustomersReportTests</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">test</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">input</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="s">"ID\tFirstName\tLastName\tScore\tSpend"</code><code class="o">,</code>&#13;
            <code class="s">"1\tFred\tFlintstone\t11\t1000.00"</code><code class="o">,</code>&#13;
            <code class="s">"4\tBetty\tRubble\t10\t2000.00"</code><code class="o">,</code>&#13;
            <code class="s">"2\tBarney\tRubble\t0\t20.00"</code><code class="o">,</code>&#13;
            <code class="s">"3\tWilma\tFlintstone\t9\t0.00"</code>&#13;
        <code class="o">);</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">expected</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="s">"ID\tName\tSpend"</code><code class="o">,</code>&#13;
            <code class="s">"4\tRUBBLE, Betty\t2000.00"</code><code class="o">,</code>&#13;
            <code class="s">"1\tFLINTSTONE, Fred\t1000.00"</code><code class="o">,</code>&#13;
            <code class="s">"\tTOTAL\t3000.00"</code>&#13;
        <code class="o">);</code>&#13;
        <code class="n">check</code><code class="o">(</code><code class="n">input</code><code class="o">,</code> <code class="n">expected</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">emptyTest</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">input</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="s">"ID\tFirstName\tLastName\tScore\tSpend"</code>&#13;
        <code class="o">);</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">expected</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="s">"ID\tName\tSpend"</code><code class="o">,</code>&#13;
            <code class="s">"\tTOTAL\t0.00"</code>&#13;
        <code class="o">);</code>&#13;
        <code class="n">check</code><code class="o">(</code><code class="n">input</code><code class="o">,</code> <code class="n">expected</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Test</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">emptySpendIs0</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">assertEquals</code><code class="o">(</code>&#13;
            <code class="k">new</code> <code class="nf">CustomerData</code><code class="o">(</code><code class="s">"1"</code><code class="o">,</code> <code class="s">"Fred"</code><code class="o">,</code> <code class="s">"Flintstone"</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="mi">0</code><code class="n">D</code><code class="o">),</code>&#13;
            <code class="n">HighValueCustomersReport</code><code class="o">.</code><code class="na">customerDataFrom</code><code class="o">(</code><code class="s">"1\tFred\tFlintstone\t0"</code><code class="o">)</code>&#13;
        <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">check</code><code class="o">(</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">inputLines</code><code class="o">,</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">expectedLines</code>&#13;
    <code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">output</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringWriter</code><code class="o">();</code>&#13;
        <code class="n">HighValueCustomersReport</code><code class="o">.</code><code class="na">generate</code><code class="o">(</code>&#13;
            <code class="k">new</code> <code class="nf">StringReader</code><code class="o">(</code><code class="n">String</code><code class="o">.</code><code class="na">join</code><code class="o">(</code><code class="s">"\n"</code><code class="o">,</code> <code class="n">inputLines</code><code class="o">)),</code>&#13;
            <code class="n">output</code>&#13;
        <code class="o">);</code>&#13;
        <code class="n">assertEquals</code><code class="o">(</code><code class="n">String</code><code class="o">.</code><code class="na">join</code><code class="o">(</code><code class="s">"\n"</code><code class="o">,</code> <code class="n">expectedLines</code><code class="o">),</code> <code class="n">output</code><code class="o">.</code><code class="na">toString</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.1&amp;show=file">Example 10.1 [extensions.0:src/test/java/travelator/marketing/HighValueCustomersReportTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>You can see that we haven’t gone to town on these, because the people in marketing do have a habit of changing their minds, but in essence the report needs to list the customers who have a score of 10 or more, sorted by spend, with a final total line.</p>&#13;
&#13;
<p>Here is the code:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">HighValueCustomersReport</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">generate</code><code class="o">(</code><code class="n">Reader</code> <code class="n">reader</code><code class="o">,</code> <code class="n">Writer</code> <code class="n">writer</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">CustomerData</code><code class="o">&gt;</code> <code class="n">valuableCustomers</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code><code class="n">reader</code><code class="o">).</code><code class="na">lines</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">skip</code><code class="o">(</code><code class="mi">1</code><code class="o">)</code> <code class="c1">// header</code>&#13;
            <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="n">line</code> <code class="o">-&gt;</code> <code class="n">customerDataFrom</code><code class="o">(</code><code class="n">line</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">filter</code><code class="o">(</code><code class="n">customerData</code> <code class="o">-&gt;</code> <code class="n">customerData</code><code class="o">.</code><code class="na">score</code> <code class="o">&gt;=</code> <code class="mi">10</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">sorted</code><code class="o">(</code><code class="n">comparing</code><code class="o">(</code><code class="n">customerData</code> <code class="o">-&gt;</code> <code class="n">customerData</code><code class="o">.</code><code class="na">score</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">toList</code><code class="o">());</code>&#13;
&#13;
        <code class="n">writer</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"ID\tName\tSpend\n"</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">var</code> <code class="nl">customerData:</code> <code class="n">valuableCustomers</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">writer</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">lineFor</code><code class="o">(</code><code class="n">customerData</code><code class="o">)).</code><code class="na">append</code><code class="o">(</code><code class="s">"\n"</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">writer</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">summaryFor</code><code class="o">(</code><code class="n">valuableCustomers</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">summaryFor</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">CustomerData</code><code class="o">&gt;</code> <code class="n">valuableCustomers</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">total</code> <code class="o">=</code> <code class="n">valuableCustomers</code><code class="o">.</code><code class="na">stream</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">mapToDouble</code><code class="o">(</code><code class="n">customerData</code> <code class="o">-&gt;</code> <code class="n">customerData</code><code class="o">.</code><code class="na">spend</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">sum</code><code class="o">();</code>&#13;
        <code class="k">return</code> <code class="s">"\tTOTAL\t"</code> <code class="o">+</code> <code class="n">formatMoney</code><code class="o">(</code><code class="n">total</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">static</code> <code class="n">CustomerData</code> <code class="nf">customerDataFrom</code><code class="o">(</code><code class="n">String</code> <code class="n">line</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">parts</code> <code class="o">=</code> <code class="n">line</code><code class="o">.</code><code class="na">split</code><code class="o">(</code><code class="s">"\t"</code><code class="o">);</code>&#13;
        <code class="kt">double</code> <code class="n">spend</code> <code class="o">=</code> <code class="n">parts</code><code class="o">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">4</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code>&#13;
            <code class="n">Double</code><code class="o">.</code><code class="na">parseDouble</code><code class="o">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">4</code><code class="o">]);</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nf">CustomerData</code><code class="o">(</code>&#13;
            <code class="n">parts</code><code class="o">[</code><code class="mi">0</code><code class="o">],</code>&#13;
            <code class="n">parts</code><code class="o">[</code><code class="mi">1</code><code class="o">],</code>&#13;
            <code class="n">parts</code><code class="o">[</code><code class="mi">2</code><code class="o">],</code>&#13;
            <code class="n">Integer</code><code class="o">.</code><code class="na">parseInt</code><code class="o">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">3</code><code class="o">]),</code>&#13;
            <code class="n">spend</code>&#13;
        <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">lineFor</code><code class="o">(</code><code class="n">CustomerData</code> <code class="n">customer</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">customer</code><code class="o">.</code><code class="na">id</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code> <code class="n">marketingNameFor</code><code class="o">(</code><code class="n">customer</code><code class="o">)</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code>&#13;
            <code class="n">formatMoney</code><code class="o">(</code><code class="n">customer</code><code class="o">.</code><code class="na">spend</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">formatMoney</code><code class="o">(</code><code class="kt">double</code> <code class="n">money</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">String</code><code class="o">.</code><code class="na">format</code><code class="o">(</code><code class="s">"%#.2f"</code><code class="o">,</code> <code class="n">money</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">marketingNameFor</code><code class="o">(</code><code class="n">CustomerData</code> <code class="n">customer</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">customer</code><code class="o">.</code><code class="na">familyName</code><code class="o">.</code><code class="na">toUpperCase</code><code class="o">()</code> <code class="o">+</code> <code class="s">", "</code> <code class="o">+</code> <code class="n">customer</code><code class="o">.</code><code class="na">givenName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.2&amp;show=file">Example 10.2 [extensions.0:src/main/java/travelator/marketing/HighValueCustomersReport.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>You can see that this is already quite a functional (as opposed to object-oriented) expression of the solution.&#13;
This will make it easy to convert to top-level functions, and top-level functions are easy to convert to extension functions.</p>&#13;
&#13;
<p>But first, here is <code>CustomerData</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CustomerData</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">givenName</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">familyName</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">score</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">double</code> <code class="n">spend</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">CustomerData</code><code class="o">(</code>&#13;
        <code class="n">String</code> <code class="n">id</code><code class="o">,</code>&#13;
        <code class="n">String</code> <code class="n">givenName</code><code class="o">,</code>&#13;
        <code class="n">String</code> <code class="n">familyName</code><code class="o">,</code>&#13;
        <code class="kt">int</code> <code class="n">score</code><code class="o">,</code>&#13;
        <code class="kt">double</code> <code class="n">spend</code>&#13;
    <code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">givenName</code> <code class="o">=</code> <code class="n">givenName</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">familyName</code> <code class="o">=</code> <code class="n">familyName</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">score</code> <code class="o">=</code> <code class="n">score</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">spend</code> <code class="o">=</code> <code class="n">spend</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="o">...</code> <code class="n">and</code> <code class="n">equals</code> <code class="n">and</code> <code class="n">hashcode</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.3&amp;show=file">Example 10.3 [extensions.0:src/main/java/travelator/marketing/CustomerData.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This isn’t trying to represent everything about a customer, just the data we care about for this report, which is why whoever wrote it just used fields.&#13;
(<a data-type="xref" href="ch11.html#methods-to-properties">Chapter 11</a> discusses this trade-off.)&#13;
I doubt we (erm, whoever wrote it) would even have bothered with <code>equals</code> and <code>hashCode</code> had it not been for the <code>emptySpendIs0</code> test.&#13;
That <code>double</code> for spend looks suspicious too, but it hasn’t caused us any problems yet, so we’ll suspend our disbelief and just convert the whole thing to a Kotlin data class (see <a data-type="xref" href="ch05.html#beans-to-values">Chapter 5</a>) before we go on.</p>&#13;
&#13;
<p>Normally, that would be a really simple job because of the excellent interop, but it turns out that (at the time of writing) the converter cannot believe that anyone would stoop to raw field access. So it doesn’t update Java that accesses, for example, <code>customerData.score</code> to call <code>customerData.getScore()</code> (the Kotlin property), resulting in a slew of compile failures.&#13;
Rather than fixing those, we revert, and use the “Encapsulate Fields” refactor to convert all the fields and field accesses in <code>Customer</code> to getters:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">CustomerData</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">givenName</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">familyName</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">score</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="kt">double</code> <code class="n">spend</code><code class="o">;</code>&#13;
&#13;
    <code class="o">...</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getId</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getGivenName</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">givenName</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
    <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.4&amp;show=file">Example 10.4 [extensions.1:src/main/java/travelator/marketing/CustomerData.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The refactoring has also updated the client code to call the getters:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">lineFor</code><code class="o">(</code><code class="n">CustomerData</code> <code class="n">customer</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">customer</code><code class="o">.</code><code class="na">getId</code><code class="o">()</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code> <code class="n">marketingNameFor</code><code class="o">(</code><code class="n">customer</code><code class="o">)</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code>&#13;
        <code class="n">formatMoney</code><code class="o">(</code><code class="n">customer</code><code class="o">.</code><code class="na">getSpend</code><code class="o">());</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.5&amp;show=file">Example 10.5 [extensions.1:src/main/java/travelator/marketing/HighValueCustomersReport.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The getters allow us to convert <code>CustomerData</code> to a Kotlin data class without breaking the Java.&#13;
“Convert Java File to Kotlin File”, followed by adding the <code>data</code> modifier and deleting the <code>equals</code> and <code>hashCode</code> overrides, gives us:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">CustomerData</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">givenName</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">familyName</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">score</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code>&#13;
    <code class="k">val</code> <code class="py">spend</code><code class="p">:</code> <code class="n">Double</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.6&amp;show=file">Example 10.6 [extensions.2:src/main/java/travelator/marketing/CustomerData.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we can go ahead and convert <code>HighValueCustomerReport</code> to Kotlin, too; it’s entirely self-contained.&#13;
That doesn’t go brilliantly, because <code>customerDataFrom</code> doesn’t compile after the conversion:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">object</code><code> </code><code class="nc">HighValueCustomersReport</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code>    </code><code class="n">@JvmStatic</code><code>&#13;
</code><code>    </code><code class="k">fun</code><code> </code><code class="nf">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">:</code><code> </code><code class="n">String</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">CustomerData</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="k">val</code><code> </code><code class="py">parts</code><code> </code><code class="p">=</code><code> </code><code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">.</code><code class="n">toRegex</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">.</code><code class="n">toTypedArray</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">val</code><code> </code><code class="py">spend</code><code class="p">:</code><code> </code><code class="n">Double</code><code> </code><code class="p">=</code><code> </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code><code> </code><code class="p">=</code><code class="p">=</code><code> </code><code class="m">4</code><code class="p">)</code><code> </code><code class="m">0</code><code> </code><code class="k">else</code><code> </code><code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">]</code><code class="p">.</code><code class="n">toDouble</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO18-1" id="co_introduction_CO18-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">CustomerData</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">]</code><code class="p">.</code><code class="n">toInt</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_introduction_CO18-2" id="co_introduction_CO18-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>            </code><code class="n">spend</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.7&amp;show=file">Example 10.7 [extensions.3:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO18-1" id="callout_introduction_CO18-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>The integer literal does not conform to the expected type Double</code>.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO18-2" id="callout_introduction_CO18-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Odd formatting.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The converter hasn’t been smart enough to know that Kotlin doesn’t coerce the integer 0 to double, leading to a compile error.&#13;
Let’s help IntelliJ out by clicking the error and Alt-Entering to fix it, in the hope that it will return the favor when the machines rule the world.&#13;
After a reformat, this gives us:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">object</code> <code class="nc">HighValueCustomersReport</code> <code class="p">{</code>&#13;
    <code class="p">...</code>&#13;
    <code class="n">@JvmStatic</code>&#13;
    <code class="k">fun</code> <code class="nf">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">CustomerData</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">parts</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">.</code><code class="n">toRegex</code><code class="p">()).</code><code class="n">toTypedArray</code><code class="p">()</code>&#13;
        <code class="k">val</code> <code class="py">spend</code><code class="p">:</code> <code class="n">Double</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">CustomerData</code><code class="p">(</code>&#13;
            <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
            <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
            <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
            <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
            <code class="n">spend</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.8&amp;show=file">Example 10.8 [extensions.4:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>As we discussed in <a data-type="xref" href="ch08.html#static-methods-to-top-level-functions">Chapter 8</a>, the conversion has placed the functions into an <code>object HighValueCustomersReport</code> so that Java code can still find them.&#13;
If we try to convert them to top-level functions using the techniques in that chapter, we find that dependencies between the methods mean that the code doesn’t compile at times.&#13;
We can solve the problem either by moving the private methods first or by just ignoring the compiler until the <code>HighValueCustomersReport</code> is emptied and removed.</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">package</code> <code class="nn">travelator.marketing</code>&#13;
&#13;
<code class="p">...</code>&#13;
&#13;
<code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">?,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">BufferedReader</code><code class="p">(</code><code class="n">reader</code><code class="p">).</code><code class="n">lines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">skip</code><code class="p">(</code><code class="m">1</code><code class="p">)</code> <code class="c1">// header</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">line</code><code class="p">:</code> <code class="n">String</code> <code class="p">-&gt;</code> <code class="n">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">)</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="p">(</code><code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sorted</code><code class="p">(</code><code class="n">Comparator</code><code class="p">.</code><code class="n">comparing</code> <code class="p">{</code> <code class="p">(</code><code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">score</code> <code class="p">})</code>&#13;
        <code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="n">Collectors</code><code class="p">.</code><code class="n">toList</code><code class="p">())</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"ID\tName\tSpend\n"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">lineFor</code><code class="p">(</code><code class="n">customerData</code><code class="p">)).</code><code class="n">append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">summaryFor</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">))</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">summaryFor</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">stream</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">mapToDouble</code> <code class="p">{</code> <code class="p">(</code><code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">spend</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">spend</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sum</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="s">"\tTOTAL\t"</code> <code class="p">+</code> <code class="n">formatMoney</code><code class="p">(</code><code class="n">total</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">CustomerData</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">parts</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">.</code><code class="n">toRegex</code><code class="p">()).</code><code class="n">toTypedArray</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">spend</code><code class="p">:</code> <code class="n">Double</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">CustomerData</code><code class="p">(</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
        <code class="n">spend</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">lineFor</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">CustomerData</code><code class="p">):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">customer</code><code class="p">.</code><code class="n">id</code> <code class="p">+</code> <code class="s">"\t"</code> <code class="p">+</code> <code class="n">marketingNameFor</code><code class="p">(</code><code class="n">customer</code><code class="p">)</code> <code class="p">+</code> <code class="s">"\t"</code> <code class="p">+</code>&#13;
        <code class="n">formatMoney</code><code class="p">(</code><code class="n">customer</code><code class="p">.</code><code class="n">spend</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">formatMoney</code><code class="p">(</code><code class="n">money</code><code class="p">:</code> <code class="n">Double</code><code class="p">):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">String</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="s">"%#.2f"</code><code class="p">,</code> <code class="n">money</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">marketingNameFor</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">CustomerData</code><code class="p">):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">customer</code><code class="p">.</code><code class="n">familyName</code><code class="p">.</code><code class="n">toUpperCase</code><code class="p">()</code> <code class="p">+</code> <code class="s">", "</code> <code class="p">+</code> <code class="n">customer</code><code class="p">.</code><code class="n">givenName</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.9&amp;show=file">Example 10.9 [extensions.5:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>OK, it’s time to look for places where extension functions can improve the code.&#13;
At the end is the <code>marketingNameFor</code> that we saw (a slightly different version of) earlier.&#13;
If we Alt-Enter on the <code>customer</code> parameter, IntelliJ will offer to “Convert parameter to receiver”.&#13;
This gives:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">lineFor</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">CustomerData</code><code class="p">):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">customer</code><code class="p">.</code><code class="n">id</code> <code class="p">+</code> <code class="s">"\t"</code> <code class="p">+</code> <code class="n">customer</code><code class="p">.</code><code class="n">marketingNameFor</code><code class="p">()</code> <code class="p">+</code> <code class="s">"\t"</code> <code class="p">+</code>&#13;
        <code class="n">formatMoney</code><code class="p">(</code><code class="n">customer</code><code class="p">.</code><code class="n">spend</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="p">...</code>&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">CustomerData</code><code class="p">.</code><code class="n">marketingNameFor</code><code class="p">():</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">familyName</code><code class="p">.</code><code class="n">toUpperCase</code><code class="p">()</code> <code class="p">+</code> <code class="s">", "</code> <code class="p">+</code> <code class="n">givenName</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.10&amp;show=file">Example 10.10 [extensions.6:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That <code>For</code> in <code>marketingNameFor</code> is confusing now that we’ve moved the parameter to be the receiver, because the <code>For</code> doesn’t have a subject.&#13;
Let’s “Convert function to property” named <code>marketingName</code> (<a data-type="xref" href="ch11.html#methods-to-properties">Chapter 11</a> explains how and why) and then “Convert to expression body”.&#13;
Oh, and “Convert concatenation to template” on both strings!&#13;
Phew, that flurry of Alt-Entering gives:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">lineFor</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">CustomerData</code><code class="p">):</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="s">"${customer.id}\t${customer.marketingName}\t${formatMoney(customer.spend)}"</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">formatMoney</code><code class="p">(</code><code class="n">money</code><code class="p">:</code> <code class="n">Double</code><code class="p">):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">String</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="s">"%#.2f"</code><code class="p">,</code> <code class="n">money</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">val</code> <code class="py">CustomerData</code><code class="p">.</code><code class="n">marketingName</code><code class="p">:</code> <code class="n">String</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"${familyName.toUpperCase()}, $givenName"</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.11&amp;show=file">Example 10.11 [extensions.7:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now <code>formatMoney</code> is letting us down, so again we can “Convert parameter to receiver”, rename to <code>toMoneyString</code>, and “Convert to expression body”:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">lineFor</code><code class="p">(</code><code class="n">customer</code><code class="p">:</code> <code class="n">CustomerData</code><code class="p">):</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="s">"${customer.id}\t${customer.marketingName}\t${customer.spend.toMoneyString()}"</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">Double</code><code class="p">.</code><code class="n">toMoneyString</code><code class="p">()</code> <code class="p">=</code> <code class="n">String</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="s">"%#.2f"</code><code class="p">,</code> <code class="k">this</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.12&amp;show=file">Example 10.12 [extensions.8:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The <code>String.format</code> rankles a bit.&#13;
Kotlin would allow us to write <code>"%#.2f".format(this)</code>, but we prefer swapping the parameter and receiver to give:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">Double</code><code class="p">.</code><code class="n">toMoneyString</code><code class="p">()</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">formattedAs</code><code class="p">(</code><code class="s">"%#.2f"</code><code class="p">)</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">Double</code><code class="p">.</code><code class="n">formattedAs</code><code class="p">(</code><code class="n">format</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code> <code class="n">String</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="k">this</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.13&amp;show=file">Example 10.13 [extensions.9:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>Double.formattedAs</code> is the first extension function we’ve written that had a parameter as well as its receiver.&#13;
That’s because the others have been very specific conversions, but this one is more general.&#13;
While we’re thinking general, <code>formattedAs</code> can equally well apply to any type, including <code>null</code>, so we can upgrade it to:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">Any</code><code class="o">?.</code><code class="n">formattedAs</code><code class="p">(</code><code class="n">format</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code> <code class="n">String</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="k">this</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.14&amp;show=file">Example 10.14 [extensions.10:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It now feels like a good candidate for moving into our library of generally useful Kotlin functions.</p>&#13;
&#13;
<p>Next, <code>customerDataFrom</code> is in our sights.&#13;
It is currently:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">CustomerData</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">parts</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">.</code><code class="n">toRegex</code><code class="p">()).</code><code class="n">toTypedArray</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">spend</code><code class="p">:</code> <code class="n">Double</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">CustomerData</code><code class="p">(</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
        <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
        <code class="n">spend</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.15&amp;show=file">Example 10.15 [extensions.11:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Before we go on, let’s observe that <code>CharSequence.split()</code>, <code>String.toRegex()</code>, &#13;
<span class="keep-together"><code>Collection&lt;T&gt;.toTypedArray()</code></span>, <code>String.toDouble()</code>, and <code>String.toInt()</code> are all extension functions provided by the Kotlin standard library.</p>&#13;
&#13;
<p>There’s a lot we can tidy up before we address the signature of <code>customerDataFrom</code>.&#13;
Kotlin has a <code>CharSequence.split(delimiters)</code> that we can use in place of the regex.&#13;
Then we can inline <code>spend</code>, followed by Alt-Enter and “Add names to call arguments” to help make sense of the constructor call:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">CustomerData</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">parts</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">CustomerData</code><code class="p">(</code>&#13;
        <code class="n">id</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
        <code class="n">givenName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
        <code class="n">familyName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
        <code class="n">score</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
        <code class="n">spend</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.16&amp;show=file">Example 10.16 [extensions.12:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><a data-type="xref" href="ch09.html#multi-to-single-expression-functions">Chapter 9</a> argues in favor of single-expression functions.&#13;
This certainly doesn’t <em>need</em> to be a single expression, but let’s practice anyway:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">customerDataFrom</code><code class="p">(</code><code class="n">line</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">CustomerData</code> <code class="p">=</code>&#13;
    <code class="n">line</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">).</code><code class="n">let</code> <code class="p">{</code> <code class="n">parts</code> <code class="p">-&gt;</code>&#13;
        <code class="n">CustomerData</code><code class="p">(</code>&#13;
            <code class="n">id</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
            <code class="n">givenName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
            <code class="n">familyName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
            <code class="n">score</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
            <code class="n">spend</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.17&amp;show=file">Example 10.17 [extensions.13:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>At last, we can get around to converting to an extension function.&#13;
Again we change the name (to <code>toCustomerData</code>) to make sense at the call site:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">String</code><code class="p">.</code><code class="n">toCustomerData</code><code class="p">():</code> <code class="n">CustomerData</code> <code class="p">=</code>&#13;
    <code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">).</code><code class="n">let</code> <code class="p">{</code> <code class="n">parts</code> <code class="p">-&gt;</code>&#13;
        <code class="n">CustomerData</code><code class="p">(</code>&#13;
            <code class="n">id</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
            <code class="n">givenName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
            <code class="n">familyName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
            <code class="n">score</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
            <code class="n">spend</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.18&amp;show=file">Example 10.18 [extensions.14:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Note that the Java in our tests can still call this as a static method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">emptySpendIs0</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">assertEquals</code><code class="o">(</code>&#13;
        <code class="k">new</code> <code class="nf">CustomerData</code><code class="o">(</code><code class="s">"1"</code><code class="o">,</code> <code class="s">"Fred"</code><code class="o">,</code> <code class="s">"Flintstone"</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="mi">0</code><code class="n">D</code><code class="o">),</code>&#13;
        <code class="n">HighValueCustomersReportKt</code><code class="o">.</code><code class="na">toCustomerData</code><code class="o">(</code><code class="s">"1\tFred\tFlintstone\t0"</code><code class="o">)</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.19&amp;show=file">Example 10.19 [extensions.14:src/test/java/travelator/marketing/HighValueCustomersReportTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now let’s address <code>summaryFor</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">summaryFor</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">stream</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">mapToDouble</code> <code class="p">{</code> <code class="p">(</code><code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">spend</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">spend</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sum</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="s">"\tTOTAL\t"</code> <code class="p">+</code> <code class="n">total</code><code class="p">.</code><code class="n">toMoneyString</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.20&amp;show=file">Example 10.20 [extensions.15:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That destructuring is odd, but we can get rid of it by hand-converting the stream to Kotlin. This isn’t a thing that IntelliJ can do when we wrote this, but we give guidance in <a data-type="xref" href="ch13.html#streams-to-sequences">Chapter 13</a>.&#13;
We’ll remove the string concatenation while we’re there:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">summaryFor</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;):</code> <code class="n">String</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">total</code> <code class="p">=</code> <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">sumByDouble</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">spend</code> <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="s">"\tTOTAL\t${total.toMoneyString()}"</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.21&amp;show=file">Example 10.21 [extensions.16:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now the familiar combination of converting to an appropriately named single-expression extension function:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;.</code><code class="n">summarised</code><code class="p">():</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">sumByDouble</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">spend</code> <code class="p">}.</code><code class="n">let</code> <code class="p">{</code> <code class="n">total</code> <code class="p">-&gt;</code>&#13;
        <code class="s">"\tTOTAL\t${total.toMoneyString()}"</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.22&amp;show=file">Example 10.22 [extensions.17:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.22&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>At this stage, only <code>generate</code> is left unimproved:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">?,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">BufferedReader</code><code class="p">(</code><code class="n">reader</code><code class="p">).</code><code class="n">lines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">skip</code><code class="p">(</code><code class="m">1</code><code class="p">)</code> <code class="c1">// header</code>&#13;
        <code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="n">line</code><code class="p">:</code> <code class="n">String</code> <code class="p">-&gt;</code> <code class="n">line</code><code class="p">.</code><code class="n">toCustomerData</code><code class="p">()</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="p">(</code><code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sorted</code><code class="p">(</code><code class="n">Comparator</code><code class="p">.</code><code class="n">comparing</code> <code class="p">{</code> <code class="p">(</code><code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">score</code> <code class="p">})</code>&#13;
        <code class="p">.</code><code class="n">collect</code><code class="p">(</code><code class="n">Collectors</code><code class="p">.</code><code class="n">toList</code><code class="p">())</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"ID\tName\tSpend\n"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">lineFor</code><code class="p">(</code><code class="n">customerData</code><code class="p">)).</code><code class="n">append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.23&amp;show=file">Example 10.23 [extensions.18:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.23&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Again, we currently have to convert Java streams to Kotlin list operations by hand:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code> <code class="c1">// header</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"ID\tName\tSpend\n"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">lineFor</code><code class="p">(</code><code class="n">customerData</code><code class="p">)).</code><code class="n">append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.24&amp;show=file">Example 10.24 [extensions.19:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.24&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>Appendable.appendLine()</code> is another extension function that allows us to simplify the output stage:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code> <code class="c1">// header</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">lineFor</code><code class="p">(</code><code class="n">customerData</code><code class="p">))</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.25&amp;show=file">Example 10.25 [extensions.20:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.25&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It feels like we should be able to remove that <code>// header</code> comment by extracting a function.&#13;
<a data-type="xref" href="ch13.html#extracting-part-of-a-pipeline">“Extracting Part of a Pipeline”</a> details how to extract a function from a chain, but look at what happens when we try that technique but don’t convert <code>withoutHeader</code> to an extension function:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">withoutHeader</code><code class="p">(</code><code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">())</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">lineFor</code><code class="p">(</code><code class="n">customerData</code><code class="p">))</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">withoutHeader</code><code class="p">(</code><code class="n">list</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;)</code> <code class="p">=</code> <code class="n">list</code><code class="p">.</code><code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.26&amp;show=file">Example 10.26 [extensions.21:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.26&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We’ve lost the nice pipeline flow from left to right, top to bottom: <code>withoutHeader</code> comes before the <code>readLines</code> in the text but after it in execution order.&#13;
Alt-Enter on the <code>list</code> parameter in <code>withoutHeader</code> and “Convert Parameter to Receiver” restores the flow:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">lineFor</code><code class="p">(</code><code class="n">customerData</code><code class="p">))</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">withoutHeader</code><code class="p">()</code> <code class="p">=</code> <code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.27&amp;show=file">Example 10.27 [extensions.22:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.27&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can make this even more expressive with two more extensions, <code>List&lt;String&gt;.​to⁠Val⁠uableCustomers()</code> and <code>CustomerData.outputLine</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code>&#13;
        <code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">customerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">toValuableCustomers</code><code class="p">()</code> <code class="p">=</code> <code class="n">withoutHeader</code><code class="p">()</code>&#13;
    <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
<code class="p">...</code>&#13;
&#13;
<code class="k">private</code> <code class="k">val</code> <code class="py">CustomerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">:</code> <code class="n">String</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$id\t$marketingName\t${spend.toMoneyString()}"</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.28&amp;show=file">Example 10.28 [extensions.23:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.28&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This still isn’t quite as sweet as we might like, but we’ve proved the point of extension functions.&#13;
Chapters <a href="ch20.html#performing-io-to-passing-data">20</a> and <a href="ch21.html#exceptions-to-values">21</a> will complete this refactoring.&#13;
In the meantime, here’s the whole file:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code>&#13;
        <code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">customerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">toValuableCustomers</code><code class="p">()</code> <code class="p">=</code> <code class="n">withoutHeader</code><code class="p">()</code>&#13;
    <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">withoutHeader</code><code class="p">()</code> <code class="p">=</code> <code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;.</code><code class="n">summarised</code><code class="p">():</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">sumByDouble</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">spend</code> <code class="p">}.</code><code class="n">let</code> <code class="p">{</code> <code class="n">total</code> <code class="p">-&gt;</code>&#13;
        <code class="s">"\tTOTAL\t${total.toMoneyString()}"</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">internal</code> <code class="k">fun</code> <code class="nf">String</code><code class="p">.</code><code class="n">toCustomerData</code><code class="p">():</code> <code class="n">CustomerData</code> <code class="p">=</code>&#13;
    <code class="n">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">).</code><code class="n">let</code> <code class="p">{</code> <code class="n">parts</code> <code class="p">-&gt;</code>&#13;
        <code class="n">CustomerData</code><code class="p">(</code>&#13;
            <code class="n">id</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">0</code><code class="p">],</code>&#13;
            <code class="n">givenName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>&#13;
            <code class="n">familyName</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>&#13;
            <code class="n">score</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="m">3</code><code class="p">].</code><code class="n">toInt</code><code class="p">(),</code>&#13;
            <code class="n">spend</code> <code class="p">=</code> <code class="k">if</code> <code class="p">(</code><code class="n">parts</code><code class="p">.</code><code class="n">size</code> <code class="p">==</code> <code class="m">4</code><code class="p">)</code> <code class="m">0.0</code> <code class="k">else</code> <code class="n">parts</code><code class="p">[</code><code class="m">4</code><code class="p">].</code><code class="n">toDouble</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
&#13;
<code class="k">private</code> <code class="k">val</code> <code class="py">CustomerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">:</code> <code class="n">String</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"$id\t$marketingName\t${spend.toMoneyString()}"</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">Double</code><code class="p">.</code><code class="n">toMoneyString</code><code class="p">()</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">formattedAs</code><code class="p">(</code><code class="s">"%#.2f"</code><code class="p">)</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">Any</code><code class="o">?.</code><code class="n">formattedAs</code><code class="p">(</code><code class="n">format</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">=</code> <code class="n">String</code><code class="p">.</code><code class="n">format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="k">this</code><code class="p">)</code>&#13;
&#13;
<code class="k">private</code> <code class="k">val</code> <code class="py">CustomerData</code><code class="p">.</code><code class="n">marketingName</code><code class="p">:</code> <code class="n">String</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="s">"${familyName.toUpperCase()}, $givenName"</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=10.29&amp;show=file">Example 10.29 [extensions.23:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=10.29&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Note that every function except the entry point is a single-expression extension function.&#13;
We haven’t made <code>generate</code> an extension function because there isn’t a natural parameter to make the receiver; it doesn’t feel like a natural operation on <code>Reader</code> or <code>Writer</code>.&#13;
That may change when we continue refactoring this code in <a data-type="xref" href="ch20.html#performing-io-to-passing-data">Chapter 20</a>. Let’s see, shall we?<a data-primary="" data-startref="Rfunctions10" data-type="indexterm" id="idm46393388810120"/><a data-primary="" data-startref="FEFref10" data-type="indexterm" id="idm46393388809176"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393392665816">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>Extension functions<a data-primary="extension functions" data-type="indexterm" id="idm46393392664104"/><a data-primary="functions to extension functions" data-secondary="writing your own types" data-type="indexterm" id="idm46393388808232"/> and properties are the unsung heroes of the Kotlin language.&#13;
Their canonical use is to add operations to types we cannot modify ourselves.</p>&#13;
&#13;
<p>However, Kotlin language features and tooling combine to encourage us—quite insistently—to write extension functions for our <em>own</em> types as well.&#13;
Kotlin’s safe call operator makes it more convenient to call an extension function through a potentially null reference than to pass the reference to a function as a parameter when it is nonnull.&#13;
The type of a freestanding generic extension can express relationships between the receiver and its result that cannot be expressed by open methods.&#13;
Autocompletion in IntelliJ includes extension functions along with the methods that can call on a value, but it does not show you functions that you can pass the value to as a &#13;
<span class="keep-together">parameter</span>.</p>&#13;
&#13;
<p>As a result, extension functions allow us to write code that is more easily discovered, understood, and maintained.&#13;
Many of the other techniques presented in this book build on extension functions, as we will see in&#13;
<a data-type="xref" data-xrefstyle="chap-num-title" href="ch15.html#encapsulated-collections-to-typealiases">Chapter 15, <em>Encapsulated Collections to Type Aliases</em></a>,&#13;
<a data-type="xref" data-xrefstyle="chap-num-title" href="ch18.html#open-to-sealed-classes">Chapter 18, <em>Open to Sealed Classes</em></a>, and others.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>