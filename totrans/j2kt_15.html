<html><head></head><body><section data-pdf-bookmark="Chapter 15. Encapsulated Collections to Type Aliases" data-type="chapter" epub:type="chapter"><div class="chapter" id="encapsulated-collections-to-typealiases">&#13;
<h1><span class="label">Chapter 15. </span>Encapsulated Collections to Type Aliases</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>In Java, we encapsulate collections of objects in classes to control mutation and add operations.&#13;
Controlling mutation is less of a concern in Kotlin, and we can use extension functions to add operations.&#13;
How would our designs be better without the encapsulation, and how do we get there?</p>&#13;
</blockquote>&#13;
&#13;
<p>In<a data-primary="Java" data-secondary="versus Kotlin" data-secondary-sortas="Kotlin" data-type="indexterm" id="idm46393377067560"/><a data-primary="Kotlin" data-secondary="versus Java" data-secondary-sortas="Java" data-type="indexterm" id="idm46393377066280"/><a data-primary="encapsulated collections to type aliases" data-secondary="hiding collections inside another object" data-type="indexterm" id="ECTAhid15"/> <a data-type="xref" href="ch06.html#java-to-kotlin-collections">Chapter 6</a> we looked at the differences between the grains of Java and Kotlin when it comes to collections.&#13;
Java’s collection interfaces, in keeping with its object-oriented roots, are fundamentally mutable, whereas Kotlin treats collections as value types.&#13;
As we saw, if we mutate shared collections, we can run into all sorts of trouble.&#13;
We <em>could</em> avoid that trouble by not mutating shared collections (<a data-type="xref" href="ch06.html#dont-mutate-shared-collections">“Don’t Mutate Shared Collections”</a>), but in Java that’s hard to do when those <code>add</code> and <code>set</code> methods are just an autocomplete away.&#13;
Instead of convention and discipline, most Java code sensibly opts for the safer approach of simply not sharing raw collections.&#13;
Instead, collections are hidden inside another object.</p>&#13;
&#13;
<p>Here, for example, is a <code>Route</code> in Travelator:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Route</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="kd">private</code><code> </code><code class="kd">final</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">journeys</code><code class="o">;</code><code> </code><a class="co" href="#callout_introduction_CO23-1" id="co_introduction_CO23-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">Route</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code><code> </code><code class="n">journeys</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">journeys</code><code> </code><code class="o">=</code><code> </code><code class="n">journeys</code><code class="o">;</code><code> </code><a class="co" href="#callout_introduction_CO23-2" id="co_introduction_CO23-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">int</code><code> </code><code class="nf">size</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="#callout_introduction_CO23-3" id="co_introduction_CO23-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">journeys</code><code class="o">.</code><code class="na">size</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Journey</code><code> </code><code class="nf">get</code><code class="o">(</code><code class="kt">int</code><code> </code><code class="n">index</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="#callout_introduction_CO23-3" id="co_introduction_CO23-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">journeys</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">index</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Location</code><code> </code><code class="nf">getDepartsFrom</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="#callout_introduction_CO23-4" id="co_introduction_CO23-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">get</code><code class="o">(</code><code class="mi">0</code><code class="o">)</code><code class="o">.</code><code class="na">getDepartsFrom</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Location</code><code> </code><code class="nf">getArrivesAt</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="#callout_introduction_CO23-4" id="co_introduction_CO23-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">get</code><code class="o">(</code><code class="n">size</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="o">)</code><code class="o">.</code><code class="na">getArrivesAt</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">Duration</code><code> </code><code class="nf">getDuration</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code> </code><a class="co" href="#callout_introduction_CO23-4" id="co_introduction_CO23-7"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Duration</code><code class="o">.</code><code class="na">between</code><code class="o">(</code><code>&#13;
</code><code>            </code><code class="n">get</code><code class="o">(</code><code class="mi">0</code><code class="o">)</code><code class="o">.</code><code class="na">getDepartureTime</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>            </code><code class="n">get</code><code class="o">(</code><code class="n">size</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">-</code><code> </code><code class="mi">1</code><code class="o">)</code><code class="o">.</code><code class="na">getArrivalTime</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.1&amp;show=file">Example 15.1 [encapsulated-collections.0:src/main/java/travelator/itinerary/Route.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO23-1" id="callout_introduction_CO23-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>A <code>Route</code> encapsulates a <code>List</code> of <code>Journey</code>.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO23-2" id="callout_introduction_CO23-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The raw data is passed in the constructor.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO23-3" id="callout_introduction_CO23-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Access to the data, for example for displaying in the UI, is provided by <code>size</code> and <code>get</code> methods.</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO23-5" id="callout_introduction_CO23-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>Route</code> class implements application logic that uses the contents of the encapsulated list.</p></dd>&#13;
</dl>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393376714536">&#13;
<h5>Defensive Copies</h5>&#13;
<p>To<a data-primary="defensive copies" data-type="indexterm" id="idm46393376713288"/><a data-primary="aliasing errors" data-type="indexterm" id="idm46393376712680"/> fully encapsulate the list, the <code>Route</code> constructor could take a defensive copy of the <code>journeys</code> parameter.&#13;
However, we “know” that our system only creates <code>Route</code> objects in the JSON deserializer or in tests, neither of which holds onto the list of journeys after creating the <code>Route</code> that uses it.&#13;
There is, therefore, no risk of <a href="https://oreil.ly/PeqKs">aliasing errors</a>, and we can save the cost of a copy whenever we create a <code>Route</code>.</p>&#13;
&#13;
<p>If someone comes along and creates a <code>Route</code> with a collection that they later modify, we may come to regret this optimization.&#13;
This is the problem with using conventions that are not underwritten by the type system.</p>&#13;
</div></aside>&#13;
&#13;
<p>Once we have a <code>Route</code> class, it is a convenient namespace to host operations on routes, like <code>getDepartsFrom</code> and <code>getDuration</code>.&#13;
In this case, all the methods shown only use other public methods, and there is no polymorphic behavior, so these operations <em>could</em> be defined as static methods taking a <code>Route</code> parameter.&#13;
We can view <code>Route</code> as more of a namespace than a class: the operations don’t <em>have</em> to be methods; it’s just more convenient that they are, at least in Java, where static functions are so much less discoverable than methods.&#13;
In Kotlin, as we saw in <a data-type="xref" href="ch10.html#functions-to-extension-functions">Chapter 10</a>, making the operations into extension functions would let us find and call them as if they were methods.&#13;
<code>Route</code> as a class would then be adding no value to <code>List</code> of <code>Journey</code>, just preventing people from changing it.&#13;
And in an all-Kotlin codebase, that <code>List</code> would be effectively immutable anyway.</p>&#13;
&#13;
<p>In fact, <code>Route</code> is doing worse than adding no value to <code>List&lt;Journey&gt;</code>—it is removing value.&#13;
If we had a <code>List&lt;Journey&gt;</code>, our frontend code could use its <code>Iterator</code> when &#13;
<span class="keep-together">rendering</span>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">render</code><code class="o">(</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="n">var</code> <code class="n">journey</code> <code class="o">:</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.2&amp;show=file">Example 15.2 [encapsulated-collections.0:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>With a <code>Route</code>, we’re back to programming in the 1980s:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">render</code><code class="o">(</code><code class="n">Route</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">route</code><code class="o">.</code><code class="na">size</code><code class="o">();</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">journey</code> <code class="o">=</code> <code class="n">route</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">i</code><code class="o">);</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.3&amp;show=file">Example 15.3 [encapsulated-collections.0:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>If we encapsulate a collection, we <em>reduce</em> the operations available for us to work with its contents to only those defined by the encapsulating class.&#13;
When we want to process that data in a new way, the path of least resistance is to add new methods to the class.&#13;
The more methods we add to the class, the more the class <em>increases</em> the coupling between different parts of our application.&#13;
Before we know it, adding an operation to support a new UI function ends up recompiling our data-access layer.<a data-primary="" data-startref="ECTAhid15" data-type="indexterm" id="idm46393376601048"/></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Composing Domain Collections" data-type="sect1"><div class="sect1" id="idm46393376599944">&#13;
<h1>Composing Domain Collections</h1>&#13;
&#13;
<p>If<a data-primary="encapsulated collections to type aliases" data-secondary="imposing domain collections" data-type="indexterm" id="idm46393376598440"/><a data-primary="domain collections" data-type="indexterm" id="idm46393376597496"/> we don’t encapsulate the collection—if we make our domain model <em>be</em> the appropriate data structure, rather than hiding it inside another class boundary—we <em>extend</em> the operations available for us to work with the data.&#13;
Then we have our application-specific operations <em>and</em> all the operations defined for the collection.&#13;
Client code can define the operations it needs in terms of the rich Collections API without having to add them to the class.</p>&#13;
&#13;
<p>Rather than a <code>Route</code> class accreting all the route functionality and in turn coupling all the parts of our application together, we can view functionality as operations to be composed by importing extension functions.&#13;
The UI can define functions that render <code>List&lt;Journey&gt;</code>, which in turn import functions that transform <code>Iterable&lt;Journey&gt;</code>.&#13;
The persistence layer can transform database responses into <code>List&lt;Journey&gt;</code> and have no particular concept of “routyness” at all.</p>&#13;
&#13;
<p>We can program like this in Java, but the poor discoverability of static functions, combined with mutable collections, goes against the grain of the language.&#13;
Kotlin has extension functions to make static functions more discoverable, and immutable collections, so that breaking our domain model into collection types and separate operations becomes the happy path.</p>&#13;
&#13;
<p>If we don’t need to control access to a collection to prevent embarrassing mutation, and we don’t need to write a class to host operations on collections of a type, then is our <code>Route</code> class doing anything for us?&#13;
Well, it is giving a name to <code>List&lt;Journey&gt;</code>, and it is also giving a type to this <code>List&lt;Journey&gt;</code> that might distinguish it from another <code>List&lt;Journey&gt;</code>—those in reports about all the journeys our travelers have booked this week, for example.&#13;
Apart from that, though, in some ways it actually gets in our way, as we will see in <a data-type="xref" href="#substitute-type-alias">“Substitute a Type Alias”</a>.</p>&#13;
&#13;
<p>Where<a data-primary="type aliases" data-type="indexterm" id="idm46393376588008"/> differentiating between different types of lists of journeys is <em>not</em> critical, Kotlin allows us to use type aliases to associate the name <code>Route</code> with <code>List&lt;Journey&gt;</code> rather than having to use a class to do this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">typealias</code> <code class="n">Route</code> <code class="p">=</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>In Kotlin, then, the obstacles to using collections as domain types have been removed.&#13;
Encapsulating immutable collections should be the exception rather than the rule.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Collections with Other Properties" data-type="sect1"><div class="sect1" id="idm46393376584408">&#13;
<h1>Collections with Other Properties</h1>&#13;
&#13;
<p>Of<a data-primary="encapsulated collections to type aliases" data-secondary="collections with other properties" data-type="indexterm" id="idm46393376583032"/> course, we can’t always just substitute type aliases for classes.&#13;
Take our <code>Itinerary</code> class, for example:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Itinerary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">route</code><code class="p">:</code> <code class="n">Route</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.4&amp;show=file">Example 15.4 [encapsulated-collections.0:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>In addition to the <code>Journey</code>s currently hidden in its <code>route</code>, <code>Itinerary</code> has an <code>Id</code> that allows us to address it as an entity.&#13;
In these cases, we can’t just replace the class with its collection.</p>&#13;
&#13;
<p>In these cases, we can gain many of the advantages of unencapsulated collections by making <code>Itinerary</code> implement <code>List&lt;Journey&gt;</code>.&#13;
That’s hard to do right now, because <code>Route</code> doesn’t implement that interface itself, but this is a good strategy as more of our domain is expressed as complete collections.&#13;
We’ll get to it in <a data-type="xref" href="#collections-with-properties">“Refactoring Collections with Other Properties”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring Encapsulated Collections" data-type="sect1"><div class="sect1" id="idm46393376500120">&#13;
<h1>Refactoring Encapsulated Collections</h1>&#13;
&#13;
<p>One<a data-primary="encapsulated collections to type aliases" data-secondary="refactoring encapsulated collections" data-type="indexterm" id="ECTAref15"/><a data-primary="refactoring" data-secondary="encapsulated collections to type aliases" data-type="indexterm" id="Rencap15"/> of the core services of our Travelator application is route planning.</p>&#13;
&#13;
<p>The <code>Route</code> that we saw earlier is a sequence of journeys that can take the traveler from one location to another.&#13;
We’d like to add some functionality that will allow us to sell accommodation where a <code>Route</code> is split over days, but as a key domain abstraction, <code>Route</code> is collapsing under the weight of all the operations that we have already added to it and coupling disparate parts of the codebase together.&#13;
Let’s see if we can refactor <code>Route</code> to make some room before we start work on the new feature.</p>&#13;
&#13;
<p>Here again is the Java <code>Route</code> class:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Route</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">journeys</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Route</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">journeys</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">journeys</code> <code class="o">=</code> <code class="n">journeys</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">int</code> <code class="nf">size</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">journeys</code><code class="o">.</code><code class="na">size</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">Journey</code> <code class="nf">get</code><code class="o">(</code><code class="kt">int</code> <code class="n">index</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">journeys</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">index</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">Location</code> <code class="nf">getDepartsFrom</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="nf">get</code><code class="o">(</code><code class="mi">0</code><code class="o">).</code><code class="na">getDepartsFrom</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="o">...</code> <code class="n">many</code> <code class="n">methods</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.5&amp;show=file">Example 15.5 [encapsulated-collections.1:src/main/java/travelator/itinerary/Route.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Convert Operations to Extensions" data-type="sect2"><div class="sect2" id="idm46393376395848">&#13;
<h2>Convert Operations to Extensions</h2>&#13;
&#13;
<p>We’re going to make <code>Route</code> less unwieldy (maybe even more wieldy) by moving its operations from methods to functions.&#13;
Extension functions make this a reasonable strategy, but only from Kotlin, where they are much more discoverable.&#13;
So we’re only going to attempt this stunt once the majority of our uses of <code>Route</code> are Kotlin.&#13;
Luckily, our team really likes converting Java to Kotlin and has been beavering away as they work through the chapters of this book, so we’re ready to try this refactoring.</p>&#13;
&#13;
<p>Ultimately, we want to unencapsulate the collection so that our clients work in terms of <code>List&lt;Journey&gt;</code> rather than using <code>Route</code>, and operations are provided by extension functions on that <code>List&lt;Journey&gt;</code>.</p>&#13;
&#13;
<p>We’ll start by converting <code>Route</code> to Kotlin, which after some tidying yields:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Route</code><code class="p">(</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">fun</code> <code class="nf">size</code><code class="p">():</code> <code class="n">Int</code> <code class="p">=</code> <code class="n">journeys</code><code class="p">.</code><code class="n">size</code>&#13;
&#13;
    <code class="n">operator</code> <code class="k">fun</code> <code class="nf">get</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">=</code> <code class="n">journeys</code><code class="p">[</code><code class="n">index</code><code class="p">]</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">departsFrom</code><code class="p">:</code> <code class="n">Location</code>&#13;
        <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="k">get</code><code class="p">(</code><code class="m">0</code><code class="p">).</code><code class="n">departsFrom</code>&#13;
&#13;
    <code class="p">...</code> <code class="n">many</code> <code class="n">methods</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.6&amp;show=file">Example 15.6 [encapsulated-collections.2:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>As usual, you should assume that we are running our tests between refactors to make sure that we haven’t broken anything. All is fine at the moment.</p>&#13;
&#13;
<p>Once a class is in Kotlin, IntelliJ can convert methods into extension methods.&#13;
Let’s try out this refactoring on the <code>departsFrom</code> property: select it, press Alt-Enter, and  choose “Convert member to extension”.&#13;
The method disappears and reappears at the top level of the file:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">departsFrom</code><code class="p">:</code> <code class="n">Location</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="k">get</code><code class="p">(</code><code class="m">0</code><code class="p">).</code><code class="n">departsFrom</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.7&amp;show=file">Example 15.7 [encapsulated-collections.3:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Kotlin code will continue to be able to access <code>route.departsFrom</code> as a property, but Java code can’t.&#13;
IntelliJ has helpfully fixed up the one Java usage to see the property as a static method:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">renderWithHeader</code><code class="o">(</code><code class="n">Route</code><code> </code><code class="n">route</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>    </code><code class="n">renderHeader</code><code class="o">(</code><code>&#13;
</code><code>        </code><code class="n">RouteKt</code><code class="o">.</code><code class="na">getDepartsFrom</code><code class="o">(</code><code class="n">route</code><code class="o">)</code><code class="o">,</code><code> </code><a class="co" href="#callout_introduction_CO24-1" id="co_introduction_CO24-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">route</code><code class="o">.</code><code class="na">getArrivesAt</code><code class="o">(</code><code class="o">)</code><code class="o">,</code><code>&#13;
</code><code>        </code><code class="n">route</code><code class="o">.</code><code class="na">getDuration</code><code class="o">(</code><code class="o">)</code><code>&#13;
</code><code>    </code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="k">for</code><code> </code><code class="o">(</code><code class="kt">int</code><code> </code><code class="n">i</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="o">;</code><code> </code><code class="n">i</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">route</code><code class="o">.</code><code class="na">size</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><code class="n">i</code><code class="o">+</code><code class="o">+</code><code class="o">)</code><code> </code><code class="o">{</code><code>&#13;
</code><code>        </code><code class="n">var</code><code> </code><code class="n">journey</code><code> </code><code class="o">=</code><code> </code><code class="n">route</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">i</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>        </code><code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">)</code><code class="o">;</code><code>&#13;
</code><code>    </code><code class="o">}</code><code>&#13;
</code><code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.8&amp;show=file">Example 15.8 [encapsulated-collections.3:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO24-1" id="callout_introduction_CO24-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Call of static method in <code>Route.kt</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>“Convert member to extension” works well for methods that only call <code>Route</code>’s public API.&#13;
It will fail if we try it on, for example, <code>withJourneyAt</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">withJourneyAt</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">replacedBy</code><code class="p">:</code> <code class="n">Journey</code><code class="p">):</code> <code class="n">Route</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">newJourneys</code> <code class="p">=</code> <code class="n">ArrayList</code><code class="p">(</code><code class="n">journeys</code><code class="p">)</code>&#13;
    <code class="n">newJourneys</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">replacedBy</code>&#13;
    <code class="k">return</code> <code class="n">Route</code><code class="p">(</code><code class="n">newJourneys</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.9&amp;show=file">Example 15.9 [encapsulated-collections.3:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This references the <code>journeys</code> property, which is currently private and so not visible to an extension function.&#13;
At this point we can make the property public (provided that we don’t abuse it by mutating the <code>List</code> from Java code).&#13;
This fixes the extension &#13;
<span class="keep-together">function</span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="n">withJourneyAt</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">replacedBy</code><code class="p">:</code> <code class="n">Journey</code><code class="p">):</code> <code class="n">Route</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">newJourneys</code> <code class="p">=</code> <code class="n">ArrayList</code><code class="p">(</code><code class="n">journeys</code><code class="p">)</code>&#13;
    <code class="n">newJourneys</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">replacedBy</code>&#13;
    <code class="k">return</code> <code class="n">Route</code><code class="p">(</code><code class="n">newJourneys</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.10&amp;show=file">Example 15.10 [encapsulated-collections.4:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can continue the process of converting members to extensions until there are no members left; even <code>size</code> and <code>get</code> can be moved out,&#13;
provided we are happy to use them statically in any remaining Java clients:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">render</code><code class="o">(</code><code class="n">Route</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">RouteKt</code><code class="o">.</code><code class="na">getSize</code><code class="o">(</code><code class="n">route</code><code class="o">);</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">journey</code> <code class="o">=</code> <code class="n">RouteKt</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">route</code><code class="o">,</code> <code class="n">i</code><code class="o">);</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.11&amp;show=file">Example 15.11 [encapsulated-collections.5:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>(Note that as we have converted the <code>size</code> method to a <code>size</code> extension property, Java sees a <code>getSize</code> function.)</p>&#13;
&#13;
<p>Here then is all that is left of the once-bloated <code>Route</code> class:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Route</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">size</code><code class="p">:</code> <code class="n">Int</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">journeys</code><code class="p">.</code><code class="n">size</code>&#13;
&#13;
<code class="n">operator</code> <code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="k">get</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">=</code> <code class="n">journeys</code><code class="p">[</code><code class="n">index</code><code class="p">]</code>&#13;
&#13;
<code class="p">...</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.12&amp;show=file">Example 15.12 [encapsulated-collections.5:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>All its operations (bar accessing the <code>journeys</code>) are now extensions, albeit in the same file.&#13;
But now that they <em>are</em> extensions, we can move them from this file to others, even in different modules, to better decouple our dependencies.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Substitute a Type Alias" data-type="sect2"><div class="sect2" id="substitute-type-alias">&#13;
<h2>Substitute a Type Alias</h2>&#13;
&#13;
<p>Now that we’ve achieved our goal of decoupling the <code>Route</code> functionality from the class, is that class superfluous?&#13;
Actually, wrapping the <code>List</code> is worse than superfluous: it prevents us from easily using all the useful extension functions in Kotlin’s standard library to construct, transform, and process routes.&#13;
To quote one of Alan Perlis’s <a href="https://oreil.ly/QDOJz">Epigrams of Programming</a>: “It is better to have 100 functions operate on one data structure than 10 functions on 10 data structures.”&#13;
We don’t want a <code>Route</code> to <em>have</em> a <code>List</code> of <code>Journey</code>; we want it to <em>be</em> a <code>List</code> of <code>Journey</code>.&#13;
This is very easy to achieve in Kotlin with delegation:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Route</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="k">by</code> <code class="n">journeys</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.13&amp;show=file">Example 15.13 [encapsulated-collections.6:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>In fact, though, we may want more than for a <code>Route</code> to be a <code>List</code> of <code>Journey</code>; we may want a <code>List</code> of <code>Journey</code> to be a <code>Route</code>.&#13;
To see why, let’s look at that <code>withJourneyAt</code> function that we glossed over earlier.</p>&#13;
&#13;
<p>When a traveler decides that they would rather not travel by camel, we can’t just replace a <code>Journey</code>, because <code>Route</code> is immutable.&#13;
Instead, we return a new <code>Route</code> where <code>journeys</code> is a copy with the relevant <code>Journey</code> replaced:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="nf">replaceJourney</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">journey1</code> <code class="p">=</code> <code class="n">Journey</code><code class="p">(</code><code class="n">waterloo</code><code class="p">,</code> <code class="n">alton</code><code class="p">,</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">RAIL</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">journey2</code> <code class="p">=</code> <code class="n">Journey</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">alresford</code><code class="p">,</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">CAMEL</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">journey3</code> <code class="p">=</code> <code class="n">Journey</code><code class="p">(</code><code class="n">alresford</code><code class="p">,</code> <code class="n">winchester</code><code class="p">,</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">BUS</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">route</code> <code class="p">=</code> <code class="n">Route</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code> <code class="n">journey2</code><code class="p">,</code> <code class="n">journey3</code><code class="p">))</code>&#13;
&#13;
    <code class="k">val</code> <code class="py">replacement</code> <code class="p">=</code> <code class="n">Journey</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">alresford</code><code class="p">,</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">someTime</code><code class="p">(),</code> <code class="n">RAIL</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">replaced</code> <code class="p">=</code> <code class="n">route</code><code class="p">.</code><code class="n">withJourneyAt</code><code class="p">(</code><code class="m">1</code><code class="p">,</code> <code class="n">replacement</code><code class="p">)</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code> <code class="n">replaced</code><code class="p">.</code><code class="k">get</code><code class="p">(</code><code class="m">0</code><code class="p">))</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">replacement</code><code class="p">,</code> <code class="n">replaced</code><code class="p">.</code><code class="k">get</code><code class="p">(</code><code class="m">1</code><code class="p">))</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">journey3</code><code class="p">,</code> <code class="n">replaced</code><code class="p">.</code><code class="k">get</code><code class="p">(</code><code class="m">2</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.14&amp;show=file">Example 15.14 [encapsulated-collections.5:src/test/java/travelator/itinerary/RouteTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>(In passing, note that this test was made more complicated by only having <code>get</code> to access the components of a <code>route</code>.&#13;
We can fix that now that we can access the <code>journeys</code> property directly.)</p>&#13;
&#13;
<p>Here’s the implementation again:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="n">withJourneyAt</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">replacedBy</code><code class="p">:</code> <code class="n">Journey</code><code class="p">):</code> <code class="n">Route</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">newJourneys</code> <code class="p">=</code> <code class="n">ArrayList</code><code class="p">(</code><code class="n">journeys</code><code class="p">)</code>&#13;
    <code class="n">newJourneys</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">replacedBy</code>&#13;
    <code class="k">return</code> <code class="n">Route</code><code class="p">(</code><code class="n">newJourneys</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.15&amp;show=file">Example 15.15 [encapsulated-collections.4:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Because <code>Route</code> wraps <code>journeys</code>, we can’t just operate on <code>journeys</code>; we have to unwrap, operate, and then wrap back up again.&#13;
If a <code>List&lt;Journey&gt;</code> was a <code>Route</code>, then we could use a nice generic function like:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="err">&lt;</code><code class="nf">T</code><code class="p">&gt;</code> <code class="n">Iterable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;.</code><code class="n">withItemAt</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">replacedBy</code><code class="p">:</code> <code class="n">T</code><code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="p">=</code>&#13;
    <code class="k">this</code><code class="p">.</code><code class="n">toMutableList</code><code class="p">().</code><code class="n">apply</code> <code class="p">{</code>&#13;
        <code class="k">this</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">replacedBy</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.16&amp;show=file">Example 15.16 [encapsulated-collections.7:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>As it is, even using <code>withItemAt</code>, we still have to deal with the wrapper:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="n">withJourneyAt</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">replacedBy</code><code class="p">:</code> <code class="n">Journey</code><code class="p">):</code> <code class="n">Route</code> <code class="p">=</code>&#13;
    <code class="n">Route</code><code class="p">(</code><code class="n">journeys</code><code class="p">.</code><code class="n">withItemAt</code><code class="p">(</code><code class="n">index</code><code class="p">,</code> <code class="n">replacedBy</code><code class="p">))</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.17&amp;show=file">Example 15.17 [encapsulated-collections.7:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Any operation that transforms <code>Route</code>s will have this problem—a problem that wouldn’t exist if we just used a type alias to say that a <code>Route</code> and <code>List&lt;Journey&gt;</code> are the same type.</p>&#13;
&#13;
<p>To get there, we will have to remove all the calls to the <code>Route</code> constructor and the accesses of the <code>journeys</code> property, effectively unwrapping our carefully crafted encapsulation.&#13;
There is a trick to do this automagically, but it relies on having converted all clients of <code>Route</code> to Kotlin.&#13;
So does using a type alias though, so if we have any remaining Java clients, we have to resign ourselves to some manual editing.</p>&#13;
&#13;
<p>What we’re going to do is replace the class with a type alias and, at the same time, add temporary definitions that emulate the API of the class.&#13;
That API is currently:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Route</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code> <code class="k">by</code> <code class="n">journeys</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.18&amp;show=file">Example 15.18 [encapsulated-collections.6:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We emulate it with:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">typealias</code> <code class="n">Route</code> <code class="p">=</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">Route</code><code class="p">(</code><code class="n">journeys</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;)</code> <code class="p">=</code> <code class="n">journeys</code>&#13;
&#13;
<code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">journeys</code> <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="k">this</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.19&amp;show=file">Example 15.19 [encapsulated-collections.8:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Because there is no <code>new</code> keyword in Kotlin, we can emulate the constructor call <code>Route(...)</code> with a function of the same name.&#13;
Similarly, we replace the <code>journeys</code> property with an extension property that returns the receiver itself.&#13;
The net result is that our Kotlin clients continue to compile against this new API:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code><code> </code><code class="py">route</code><code> </code><code class="p">=</code><code> </code><code class="n">Route</code><code class="p">(</code><code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code><code> </code><code class="n">journey2</code><code class="p">,</code><code> </code><code class="n">journey3</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO25-1" id="co_introduction_CO25-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="k">val</code><code> </code><code class="py">replacement</code><code> </code><code class="p">=</code><code> </code><code class="n">Journey</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code><code> </code><code class="n">alresford</code><code class="p">,</code><code> </code><code class="n">someTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">someTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">RAIL</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">assertEquals</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code><code> </code><code class="n">replacement</code><code class="p">,</code><code> </code><code class="n">journey3</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">route</code><code class="p">.</code><code class="n">withJourneyAt</code><code class="p">(</code><code class="m">1</code><code class="p">,</code><code> </code><code class="n">replacement</code><code class="p">)</code><code class="p">.</code><code class="n">journeys</code><code> </code><a class="co" href="#callout_introduction_CO25-2" id="co_introduction_CO25-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.20&amp;show=file">Example 15.20 [encapsulated-collections.8:src/test/java/travelator/itinerary/RouteTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO25-1" id="callout_introduction_CO25-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Our new function, not the constructor</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO25-2" id="callout_introduction_CO25-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Extension property, not the class property</p></dd>&#13;
</dl>&#13;
&#13;
<p>Inlining both function and property completes the refactor. The encapsulated collection is now just a collection:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code><code> </code><code class="py">route</code><code> </code><code class="p">=</code><code> </code><code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code><code> </code><code class="n">journey2</code><code class="p">,</code><code> </code><code class="n">journey3</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO26-1" id="co_introduction_CO26-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="k">val</code><code> </code><code class="py">replacement</code><code> </code><code class="p">=</code><code> </code><code class="n">Journey</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code><code> </code><code class="n">alresford</code><code class="p">,</code><code> </code><code class="n">someTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">someTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">RAIL</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">assertEquals</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code><code> </code><code class="n">replacement</code><code class="p">,</code><code> </code><code class="n">journey3</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">route</code><code class="p">.</code><code class="n">withJourneyAt</code><code class="p">(</code><code class="m">1</code><code class="p">,</code><code> </code><code class="n">replacement</code><code class="p">)</code><code> </code><a class="co" href="#callout_introduction_CO26-2" id="co_introduction_CO26-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.21&amp;show=file">Example 15.21 [encapsulated-collections.9:src/test/java/travelator/itinerary/RouteTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO26-1" id="callout_introduction_CO26-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>Route</code> was a no-op</p></dd>&#13;
<dt><a class="co" href="#co_introduction_CO26-2" id="callout_introduction_CO26-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>As was <code>journeys</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>Any remaining Java clients will have been broken when we replaced the <code>Route</code> class with a type alias, because Java doesn’t understand type aliases.&#13;
We fixed those by hand, replacing <code>Route</code> with <code>List&lt;Journey&gt;</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">render</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">RouteKt</code><code class="o">.</code><code class="na">getSize</code><code class="o">(</code><code class="n">route</code><code class="o">);</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">journey</code> <code class="o">=</code> <code class="n">RouteKt</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">route</code><code class="o">,</code> <code class="n">i</code><code class="o">);</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.22&amp;show=file">Example 15.22 [encapsulated-collections.8:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.22&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before">Our transformation is almost complete.&#13;
We still have <code>size</code> and <code>get</code> functions:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">size</code><code class="p">:</code> <code class="n">Int</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="k">this</code><code class="p">.</code><code class="n">size</code>&#13;
&#13;
<code class="n">operator</code> <code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="k">get</code><code class="p">(</code><code class="n">index</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">=</code> <code class="k">this</code><code class="p">[</code><code class="n">index</code><code class="p">]</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.23&amp;show=file">Example 15.23 [encapsulated-collections.9:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.23&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Because these have the same signature as their method counterparts on <code>List</code>, the compiler warns us that they are shadowed; our Kotlin will be calling the methods, not the extensions.&#13;
That means that if we didn’t have any Java client code invoking the extensions as statics, we could delete them.</p>&#13;
&#13;
<p>We do have a Java client, though—that pesky rendering code, which is still calling the extensions as <code>getSize</code> and <code>get</code> in <code>RouteKt</code>.&#13;
Those extensions are calling the methods that we want to use, but we can’t inline code from Kotlin to Java, so we’ll just delete the extensions anyway.&#13;
Now the compiler will tell us where we need to fix the Java, and we can do that by hand:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">render</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">route</code><code class="o">.</code><code class="na">size</code><code class="o">();</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
        <code class="n">var</code> <code class="n">journey</code> <code class="o">=</code> <code class="n">route</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">i</code><code class="o">);</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.24&amp;show=file">Example 15.24 [encapsulated-collections.10:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.24&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>In reality, of course, we would replace this with:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">render</code><code class="o">(</code><code class="n">Iterable</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="n">var</code> <code class="n">journey</code> <code class="o">:</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.25&amp;show=file">Example 15.25 [encapsulated-collections.10:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.25&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The Kotlin clients are unphased by deleting the extensions, because they were always calling the methods on <code>List</code>, so the transformation is almost complete.&#13;
We can also now inline <code>withJourneyAt</code>, because it too is a no-op.&#13;
This leaves us with <code>Route</code> like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">typealias</code> <code class="n">Route</code> <code class="p">=</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Journey</code><code class="p">&gt;</code>&#13;
&#13;
<code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">departsFrom</code><code class="p">:</code> <code class="n">Location</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">first</code><code class="p">().</code><code class="n">departsFrom</code>&#13;
&#13;
<code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">arrivesAt</code><code class="p">:</code> <code class="n">Location</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">last</code><code class="p">().</code><code class="n">arrivesAt</code>&#13;
&#13;
<code class="k">val</code> <code class="py">Route</code><code class="p">.</code><code class="n">duration</code><code class="p">:</code> <code class="n">Duration</code>&#13;
    <code class="k">get</code><code class="p">()</code> <code class="p">=</code> <code class="n">Duration</code><code class="p">.</code><code class="n">between</code><code class="p">(</code>&#13;
        <code class="n">first</code><code class="p">().</code><code class="n">departureTime</code><code class="p">,</code>&#13;
        <code class="n">last</code><code class="p">().</code><code class="n">arrivalTime</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">...</code> <code class="n">other</code> <code class="n">operations</code> <code class="n">moved</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.26&amp;show=file">Example 15.26 [encapsulated-collections.10:src/main/java/travelator/itinerary/Route.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.26&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Our Kotlin usages are just <code>List</code> operations:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">route</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code> <code class="n">journey2</code><code class="p">,</code> <code class="n">journey3</code><code class="p">)</code>&#13;
<code class="n">assertEquals</code><code class="p">(</code>&#13;
    <code class="n">listOf</code><code class="p">(</code><code class="n">journey1</code><code class="p">,</code> <code class="n">replacement</code><code class="p">,</code> <code class="n">journey3</code><code class="p">),</code>&#13;
    <code class="n">route</code><code class="p">.</code><code class="n">withItemAt</code><code class="p">(</code><code class="m">1</code><code class="p">,</code> <code class="n">replacement</code><code class="p">)</code>&#13;
<code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.27&amp;show=file">Example 15.27 [encapsulated-collections.10:src/test/java/travelator/itinerary/RouteTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.27&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Any residual Java is readable, if a little ugly:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">renderWithHeader</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Journey</code><code class="o">&gt;</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">renderHeader</code><code class="o">(</code>&#13;
        <code class="n">RouteKt</code><code class="o">.</code><code class="na">getDepartsFrom</code><code class="o">(</code><code class="n">route</code><code class="o">),</code>&#13;
        <code class="n">RouteKt</code><code class="o">.</code><code class="na">getArrivesAt</code><code class="o">(</code><code class="n">route</code><code class="o">),</code>&#13;
        <code class="n">RouteKt</code><code class="o">.</code><code class="na">getDuration</code><code class="o">(</code><code class="n">route</code><code class="o">)</code>&#13;
    <code class="o">);</code>&#13;
    <code class="k">for</code> <code class="o">(</code><code class="n">var</code> <code class="n">journey</code> <code class="o">:</code> <code class="n">route</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">render</code><code class="o">(</code><code class="n">journey</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.28&amp;show=file">Example 15.28 [encapsulated-collections.10:src/main/java/travelator/UI.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.28&amp;show=diff">(diff)</a>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Refactoring Collections with Other Properties" data-type="sect2"><div class="sect2" id="collections-with-properties">&#13;
<h2>Refactoring Collections with Other Properties</h2>&#13;
&#13;
<p>As we saw previously, we can’t use type aliases when our types have collections with other attributes.&#13;
We looked at <code>Itinerary</code>, which combines an <code>id</code> with a <code>Route</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">Itinerary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">route</code><code class="p">:</code> <code class="n">Route</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">hasJourneyLongerThan</code><code class="p">(</code><code class="n">duration</code><code class="p">:</code> <code class="n">Duration</code><code class="p">)</code> <code class="p">=</code>&#13;
        <code class="n">route</code><code class="p">.</code><code class="n">any</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">duration</code> <code class="p">&gt;</code> <code class="n">duration</code> <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.29&amp;show=file">Example 15.29 [encapsulated-collections.11:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.29&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can get the advantages of being able to query <code>Journey</code>s directly by implementing <code>Route</code> with delegation:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code><code> </code><code class="nc">Itinerary</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="k">val</code><code> </code><code class="py">id</code><code class="p">:</code><code> </code><code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="k">val</code><code> </code><code class="py">route</code><code class="p">:</code><code> </code><code class="n">Route</code><code>&#13;
</code><code class="p">)</code><code> </code><code class="p">:</code><code> </code><code class="n">Route</code><code> </code><code class="k">by</code><code> </code><code class="n">route</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_introduction_CO27-1" id="co_introduction_CO27-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">fun</code><code> </code><code class="nf">hasJourneyLongerThan</code><code class="p">(</code><code class="n">duration</code><code class="p">:</code><code> </code><code class="n">Duration</code><code class="p">)</code><code> </code><code class="p">=</code><code>&#13;
</code><code>        </code><code class="n">any</code><code> </code><code class="p">{</code><code> </code><code class="n">it</code><code class="p">.</code><code class="n">duration</code><code> </code><code class="p">&gt;</code><code> </code><code class="n">duration</code><code> </code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.30&amp;show=file">Example 15.30 [encapsulated-collections.12:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.30&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO27-1" id="callout_introduction_CO27-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>by route</code> clause declares that the <code>Itinerary</code> object will delegate all methods on the <code>Route</code> interface to the <code>route</code> parameter passed to its constructor.&#13;
A class can override this behavior by providing its own implementation of methods of the delegated interface, but we don’t want to do this for <code>Itinerary</code>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>Now that we can treat <code>Itinerary</code> as a <code>Route</code>, we can move <code>hasJourneyLongerThan</code> out as an extension and have it available to any <code>Route</code>, not just to <code>Itinerary</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="n">hasJourneyLongerThan</code><code class="p">(</code><code class="n">duration</code><code class="p">:</code> <code class="n">Duration</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">any</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">duration</code> <code class="p">&gt;</code> <code class="n">duration</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.31&amp;show=file">Example 15.31 [encapsulated-collections.13:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.31&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>All those extensions to <code>Route</code> (aka <code>List&lt;Journey&gt;</code>) that we moved from methods to extensions are also now applicable to <code>Itinerary</code> as well:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code><code> </code><code class="nf">Iterable</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;</code><code class="p">.</code><code class="n">shortest</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code>&#13;
</code><code>    </code><code class="n">minByOrNull</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="n">it</code><code class="p">.</code><code class="n">duration</code><code> </code><a class="co" href="#callout_introduction_CO28-1" id="co_introduction_CO28-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.32&amp;show=file">Example 15.32 [encapsulated-collections.13:src/main/java/travelator/itinerary/itineraries.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.32&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_introduction_CO28-1" id="callout_introduction_CO28-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This is <code>Route.duration</code>, aka <code>List&lt;Journey&gt;.duration</code></p></dd>&#13;
</dl>&#13;
&#13;
<p>What we can’t do as easily is create a new <code>Itinerary</code> from an existing one.&#13;
This is now easy for <code>Route</code>, because standard API operations on <code>List&lt;Journey&gt;</code> (actually, usually <code>Iterable&lt;Journey&gt;</code>, as we saw in <a data-type="xref" href="ch06.html#java-to-kotlin-collections">Chapter 6</a>) return <code>List&lt;Journey&gt;</code>, which is the other name for <code>Route</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Route</code><code class="p">.</code><code class="n">withoutJourneysBy</code><code class="p">(</code><code class="n">travelMethod</code><code class="p">:</code> <code class="n">TravelMethod</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="k">this</code><code class="p">.</code><code class="n">filterNot</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">method</code> <code class="p">==</code> <code class="n">travelMethod</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.33&amp;show=file">Example 15.33 [encapsulated-collections.13:src/main/java/travelator/itinerary/itineraries.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.33&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>For <code>Itinerary</code>, we have to create a new <code>Itinerary</code> to rewrap the result:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Itinerary</code><code class="p">.</code><code class="n">withoutJourneysBy</code><code class="p">(</code><code class="n">travelMethod</code><code class="p">:</code> <code class="n">TravelMethod</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">Itinerary</code><code class="p">(</code>&#13;
        <code class="n">id</code><code class="p">,</code>&#13;
        <code class="k">this</code><code class="p">.</code><code class="n">filterNot</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">method</code> <code class="p">==</code> <code class="n">travelMethod</code> <code class="p">}</code>&#13;
    <code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.34&amp;show=file">Example 15.34 [encapsulated-collections.13:src/main/java/travelator/itinerary/itineraries.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.34&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is yet another place where data classes come to the rescue:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Itinerary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">route</code><code class="p">:</code> <code class="n">Route</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">Route</code> <code class="k">by</code> <code class="n">route</code> <code class="p">{</code>&#13;
&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.35&amp;show=file">Example 15.35 [encapsulated-collections.14:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.35&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Making <code>Itinerary</code> a data class means that we can make a copy with just a revised route, no matter how many other properties it has:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Itinerary</code><code class="p">.</code><code class="n">withoutJourneysBy</code><code class="p">(</code><code class="n">travelMethod</code><code class="p">:</code> <code class="n">TravelMethod</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">copy</code><code class="p">(</code><code class="n">route</code> <code class="p">=</code> <code class="n">filterNot</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">method</code> <code class="p">==</code> <code class="n">travelMethod</code> <code class="p">}</code> <code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.36&amp;show=file">Example 15.36 [encapsulated-collections.14:src/main/java/travelator/itinerary/itineraries.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.36&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Better still, we can add a method <code>withTransformedRoute</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Itinerary</code><code class="p">(</code>&#13;
    <code class="k">val</code> <code class="py">id</code><code class="p">:</code> <code class="n">Id</code><code class="p">&lt;</code><code class="n">Itinerary</code><code class="p">&gt;,</code>&#13;
    <code class="k">val</code> <code class="py">route</code><code class="p">:</code> <code class="n">Route</code>&#13;
<code class="p">)</code> <code class="p">:</code> <code class="n">Route</code> <code class="k">by</code> <code class="n">route</code> <code class="p">{</code>&#13;
&#13;
    <code class="k">fun</code> <code class="nf">withTransformedRoute</code><code class="p">(</code><code class="n">transform</code><code class="p">:</code> <code class="p">(</code><code class="n">Route</code><code class="p">).()</code> <code class="p">-&gt;</code> <code class="n">Route</code><code class="p">)</code> <code class="p">=</code>&#13;
        <code class="n">copy</code><code class="p">(</code><code class="n">route</code> <code class="p">=</code> <code class="n">transform</code><code class="p">(</code><code class="n">route</code><code class="p">))</code>&#13;
&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.37&amp;show=file">Example 15.37 [encapsulated-collections.15:src/main/java/travelator/itinerary/Itinerary.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.37&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This<a data-primary="" data-startref="ECTAref15" data-type="indexterm" id="idm46393374033720"/><a data-primary="" data-startref="Rencap15" data-type="indexterm" id="idm46393374032712"/> allows us to create a transformed <code>Itinerary</code> almost as easily as we could create a transformed <code>Route</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Itinerary</code><code class="p">.</code><code class="n">withoutJourneysBy</code><code class="p">(</code><code class="n">travelMethod</code><code class="p">:</code> <code class="n">TravelMethod</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">withTransformedRoute</code> <code class="p">{</code>&#13;
        <code class="n">filterNot</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">method</code> <code class="p">==</code> <code class="n">travelMethod</code> <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">Itinerary</code><code class="p">.</code><code class="n">withoutLastJourney</code><code class="p">()</code> <code class="p">=</code>&#13;
    <code class="n">withTransformedRoute</code> <code class="p">{</code> <code class="n">dropLast</code><code class="p">(</code><code class="m">1</code><code class="p">)</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=15.38&amp;show=file">Example 15.38 [encapsulated-collections.15:src/main/java/travelator/itinerary/itineraries.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=15.38&amp;show=diff">(diff)</a>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393374593576">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>We started this chapter with a Java class that encapsulated a mutable collection to guarantee value semantics.&#13;
As we translated more of our code to Kotlin, we could rely on Kotlin’s type system to prevent the collection from being modified, and no longer needed to encapsulate it within the class.&#13;
That allowed us to convert operations from methods to extensions, and move their definitions close to where they are used.&#13;
Because our class encapsulated a single collection, we were able to eliminate the class altogether and replace it with a type alias.</p>&#13;
&#13;
<p>Immutable collections and extensions allow us to organize our code in ways that are not available in Java.&#13;
We can group all the logic required by a particular feature of the application in the same module, regardless of the domain classes the logic applies to.&#13;
However, if we wanted methods of those domain classes to be polymorphic methods, we would have to define them on those classes and not in our feature module.&#13;
In <a data-type="xref" data-xrefstyle="chap-num-title" href="ch18.html#open-to-sealed-classes">Chapter 18, <em>Open to Sealed Classes</em></a>, we look at sealed classes, an alternative to object-oriented polymorphism that is more convenient when we define type hierarchies in one part of the code and operations on those types in another.</p>&#13;
&#13;
<p>Finally, note that reusing built-in types like <code>List</code> rather than defining a specific type is not without cost.&#13;
We might be storing items in a <code>List</code> as an implementation detail rather than a modeling choice.&#13;
It’s also a lot easier to “Find usages” of a specific wrapper class than a generic specialization.&#13;
Nevertheless, the standard collection types are pervasive because they are such good abstractions—so good that we generally shouldn’t hide them.&#13;
<a data-type="xref" data-xrefstyle="chap-num-title" href="ch22.html#classes-to-functions">Chapter 22, <em>Classes to Functions</em></a>, looks at what happens if we take this idea and run with it.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>