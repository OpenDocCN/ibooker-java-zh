<html><head></head><body><section data-pdf-bookmark="Chapter 17. Mocks to Maps" data-type="chapter" epub:type="chapter"><div class="chapter" id="mocks-to-maps">&#13;
<h1><span class="label">Chapter 17. </span>Mocks to Maps</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Mocks are a common technique to decouple object-oriented code from its <span class="keep-together">production</span> dependencies.&#13;
Are better solutions available in Kotlin?</p>&#13;
</blockquote>&#13;
&#13;
<p>This<a data-primary="refactoring" data-secondary="mocks to maps" data-type="indexterm" id="Rmock17"/><a data-primary="mocking frameworks" data-type="indexterm" id="mfram17"/> is a short bonus chapter, following on from <a data-type="xref" href="ch16.html#interfaces-to-functions">Chapter 16</a>.&#13;
In that chapter, we saw that our tests used mocks because they had to implement two multimethod interfaces, even though most of those methods were not used.&#13;
We left the refactoring, having replaced dependencies on multimethod interfaces with a dependency on just the two operations that were actually required to perform the task.&#13;
The tests, though, still mock the whole interface, and then pass a reference to the required methods to the subject under test (<code>Recommendations</code>):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">RecommendationsTests</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">DistanceCalculator</code> <code class="n">distanceCalculator</code> <code class="o">=</code>&#13;
        <code class="n">mock</code><code class="o">(</code><code class="n">DistanceCalculator</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">FeaturedDestinations</code> <code class="n">featuredDestinations</code> <code class="o">=</code>&#13;
        <code class="n">mock</code><code class="o">(</code><code class="n">FeaturedDestinations</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">Recommendations</code> <code class="n">recommendations</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Recommendations</code><code class="o">(</code>&#13;
        <code class="nl">featuredDestinations:</code><code class="o">:</code><code class="n">findCloseTo</code><code class="o">,</code>&#13;
        <code class="nl">distanceCalculator:</code><code class="o">:</code><code class="n">distanceInMetersBetween</code>&#13;
    <code class="o">);</code>&#13;
    <code class="o">...</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.1&amp;show=file">Example 17.1 [interfaces-to-funs.7:src/test/java/travelator/recommendations/RecommendationsTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The tests abstract the mocking behind methods <code>givenFeaturedDestinationsFor</code> and <code>givenADistanceBetween</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_recommendations_for_single_location</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code>&#13;
        <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="n">eiffelTower</code><code class="o">,</code>&#13;
            <code class="n">louvre</code>&#13;
        <code class="o">));</code>&#13;
    <code class="n">givenADistanceBetween</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">eiffelTower</code><code class="o">,</code> <code class="mi">5000</code><code class="o">);</code>&#13;
    <code class="n">givenADistanceBetween</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">louvre</code><code class="o">,</code> <code class="mi">1000</code><code class="o">);</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="o">(</code>&#13;
        <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="k">new</code> <code class="nf">FeaturedDestinationSuggestion</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">louvre</code><code class="o">,</code> <code class="mi">1000</code><code class="o">),</code>&#13;
            <code class="k">new</code> <code class="nf">FeaturedDestinationSuggestion</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">eiffelTower</code><code class="o">,</code> <code class="mi">5000</code><code class="o">)</code>&#13;
        <code class="o">),</code>&#13;
        <code class="n">recommendations</code><code class="o">.</code><code class="na">recommendationsFor</code><code class="o">(</code><code class="n">Set</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">paris</code><code class="o">))</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.2&amp;show=file">Example 17.2 [interfaces-to-funs.7:src/test/java/travelator/recommendations/RecommendationsTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Here is the implementation of <code>givenADistanceBetween</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kt">void</code> <code class="nf">givenADistanceBetween</code><code class="o">(</code>&#13;
    <code class="n">Location</code> <code class="n">location</code><code class="o">,</code>&#13;
    <code class="n">FeaturedDestination</code> <code class="n">destination</code><code class="o">,</code>&#13;
    <code class="kt">int</code> <code class="n">result</code>&#13;
<code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">when</code><code class="o">(</code>&#13;
        <code class="n">distanceCalculator</code><code class="o">.</code><code class="na">distanceInMetersBetween</code><code class="o">(</code>&#13;
            <code class="n">location</code><code class="o">,</code>&#13;
            <code class="n">destination</code><code class="o">.</code><code class="na">getLocation</code><code class="o">())</code>&#13;
    <code class="o">).</code><code class="na">thenReturn</code><code class="o">(</code><code class="n">result</code><code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.3&amp;show=file">Example 17.3 [interfaces-to-funs.7:src/test/java/travelator/recommendations/RecommendationsTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393368413912">&#13;
<h5>Mock-Induced Test Damage</h5>&#13;
<p>David Heinemeier Hansson<a data-primary="test-induced design damage" data-type="indexterm" id="idm46393368412120"/><a data-primary="mock-induced test damage" data-type="indexterm" id="idm46393368411448"/> coined the term <a href="https://oreil.ly/8vgJU">test-induced design damage</a> to refer to harm caused to systems in the name of testability.&#13;
In practice, your authors don’t recognize this as much of a problem; we find that systems are usually <em>improved</em> by the decoupling required to test them well.&#13;
We <em>do</em> often see tests ruined by mocks though, so much so that mocking has fallen out of favor in our &#13;
<span class="keep-together">circles</span>.</p>&#13;
&#13;
<p>The problem is that, as well as implementing interfaces, mock frameworks allow us to specify the expected invocations of their methods and what should be returned in those cases.&#13;
Often, though, expected calls and their results don’t make for a human-readable description, as we’ll see if we look at the inlined version of the last &#13;
<span class="keep-together">expectations</span>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">when</code><code class="o">(</code><code class="n">featuredDestinations</code><code class="o">.</code><code class="na">findCloseTo</code><code class="o">(</code><code class="n">paris</code><code class="o">))</code>&#13;
    <code class="o">.</code><code class="na">thenReturn</code><code class="o">(</code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
        <code class="n">eiffelTower</code><code class="o">,</code>&#13;
        <code class="n">louvre</code>&#13;
    <code class="o">));</code>&#13;
<code class="n">when</code><code class="o">(</code><code class="n">distanceCalculator</code><code class="o">.</code><code class="na">distanceInMetersBetween</code><code class="o">(</code>&#13;
    <code class="n">paris</code><code class="o">,</code> <code class="n">eiffelTower</code><code class="o">.</code><code class="na">getLocation</code><code class="o">())</code>&#13;
<code class="o">).</code><code class="na">thenReturn</code><code class="o">(</code><code class="mi">5000</code><code class="o">);</code>&#13;
<code class="n">when</code><code class="o">(</code><code class="n">distanceCalculator</code><code class="o">.</code><code class="na">distanceInMetersBetween</code><code class="o">(</code>&#13;
    <code class="n">paris</code><code class="o">,</code> <code class="n">louvre</code><code class="o">.</code><code class="na">getLocation</code><code class="o">())</code>&#13;
<code class="o">).</code><code class="na">thenReturn</code><code class="o">(</code><code class="mi">1000</code><code class="o">);</code>&#13;
&#13;
<code class="n">when</code><code class="o">(</code><code class="n">featuredDestinations</code><code class="o">.</code><code class="na">findCloseTo</code><code class="o">(</code><code class="n">alton</code><code class="o">))</code>&#13;
    <code class="o">.</code><code class="na">thenReturn</code><code class="o">(</code><code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
        <code class="n">flowerFarm</code><code class="o">,</code>&#13;
        <code class="n">watercressLine</code>&#13;
    <code class="o">));</code>&#13;
<code class="n">when</code><code class="o">(</code><code class="n">distanceCalculator</code><code class="o">.</code><code class="na">distanceInMetersBetween</code><code class="o">(</code>&#13;
    <code class="n">alton</code><code class="o">,</code> <code class="n">flowerFarm</code><code class="o">.</code><code class="na">getLocation</code><code class="o">())</code>&#13;
<code class="o">).</code><code class="na">thenReturn</code><code class="o">(</code><code class="mi">5300</code><code class="o">);</code>&#13;
<code class="n">when</code><code class="o">(</code><code class="n">distanceCalculator</code><code class="o">.</code><code class="na">distanceInMetersBetween</code><code class="o">(</code>&#13;
    <code class="n">alton</code><code class="o">,</code> <code class="n">watercressLine</code><code class="o">.</code><code class="na">getLocation</code><code class="o">())</code>&#13;
<code class="o">).</code><code class="na">thenReturn</code><code class="o">(</code><code class="mi">320</code><code class="o">);</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.4&amp;show=file">Example 17.4 [interfaces-to-funs.1:src/test/java/travelator/recommendations/RecommendationsTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Defining methods like <code>givenADistanceBetween</code> allows us to express the relationship between the mock expectations and our test: they can hide the <em>how</em> to expose the <em>why</em>.&#13;
In practice, though, very few developers take this step, leading to cryptic tests that are blamed on the use of mocking.</p>&#13;
</div></aside>&#13;
&#13;
<p>Nat is keen to point out that the mocks that he and Steve Freeman wrote about in <a href="bibliography01.html#FP_GOOSGBT_2009"><em>Growing Object-Oriented Software Guided by Tests</em></a> were never supposed to be used to implement query functionality like <code>findCloseTo</code> and <code>distanceInMetersBetween</code>, but only methods that change state.&#13;
Duncan doesn’t remember noticing that, and is personally not against using mocks in this way, because they are still a nice way to specify what we expect of collaborators when practicing outside-in test-driven development, whether reading-from or writing-to.&#13;
In the end, maybe it doesn’t matter, because in both of our experiences, most Java codebases have mocks that are used in this way, and most Kotlin codebases would be better off without them.</p>&#13;
&#13;
<p>For now though, we are still mocking, but our previous refactoring has resulted in our passing narrow interfaces (the function types) to the code under test.&#13;
Now that we don’t need to implement uncalled methods, do we still need the mocks?&#13;
Let’s see where pulling that thread takes us.<a data-primary="" data-startref="mfram17" data-type="indexterm" id="idm46393368292552"/></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Replacing Mocks with Maps" data-type="sect1"><div class="sect1" id="idm46393368291448">&#13;
<h1>Replacing Mocks with Maps</h1>&#13;
&#13;
<p>Before<a data-primary="maps, replacing mocks with" data-type="indexterm" id="maprepl17"/><a data-primary="mocks to maps" data-secondary="replacing mocks with maps" data-type="indexterm" id="MMreplace17"/> we go on, we’ll convert the tests to Kotlin, because it has better support for function types.&#13;
We could stay in Java, but then we would have to work out which of the Java function types (<code>Function</code>, <code>BiFunction</code>, etc.) expresses the operations.&#13;
And we’d still have Java.</p>&#13;
&#13;
<p>The automated conversion is quite smooth, although for some reason the converter created lambdas rather than using method references in the <code>Recommendations</code> constructor call that we have to replace by hand, leaving the setup as:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">RecommendationsTests</code> <code class="p">{</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">distanceCalculator</code> <code class="p">=</code> <code class="n">mock</code><code class="p">(</code><code class="n">DistanceCalculator</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">)</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">featuredDestinations</code> <code class="p">=</code> <code class="n">mock</code><code class="p">(</code><code class="n">FeaturedDestinations</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">)</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">recommendations</code> <code class="p">=</code> <code class="n">Recommendations</code><code class="p">(</code>&#13;
        <code class="n">featuredDestinations</code><code class="o">::</code><code class="n">findCloseTo</code><code class="p">,</code>&#13;
        <code class="n">distanceCalculator</code><code class="o">::</code><code class="n">distanceInMetersBetween</code>&#13;
    <code class="p">)</code>&#13;
    <code class="p">...</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.5&amp;show=file">Example 17.5 [mocks-to-maps.0:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We<a data-primary="reified types" data-type="indexterm" id="idm46393368166376"/> could use Kotlin reified types to avoid those <code>::class.java</code> arguments, but we’re moving away from mocks, not toward them, so we resist.</p>&#13;
&#13;
<p>The term <code>when</code> is a keyword in Kotlin, but the converter is smart enough to quote it where required:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">givenFeaturedDestinationsFor</code><code class="p">(</code>&#13;
    <code class="n">location</code><code class="p">:</code> <code class="n">Location</code><code class="p">,</code>&#13;
    <code class="n">result</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">Mockito</code><code class="p">.</code><code class="n">`when`</code><code class="p">(</code><code class="n">featuredDestinations</code><code class="p">.</code><code class="n">findCloseTo</code><code class="p">(</code><code class="n">location</code><code class="p">))</code>&#13;
        <code class="p">.</code><code class="n">thenReturn</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.6&amp;show=file">Example 17.6 [mocks-to-maps.0:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>To see how to remove the mocking, it helps to view a function type as a mapping between its input parameters (as a tuple) and its result.&#13;
So <code>destinationFinder</code> is a mapping between a single <code>Location</code> and a <code>List&lt;FeaturedDestination&gt;</code>, and <code>distanceInMetersBetween</code> is a mapping between <code>Pair&lt;Location, Location&gt;</code> and <code>Int</code>.&#13;
The <code>Map</code> data structure is our way of expressing a set of mappings—the name isn’t accidental.&#13;
So we can fake a function by populating a <code>Map</code> with parameter keys and result values, and replacing the function call with a lookup of the supplied parameters.&#13;
You may have used this trick to cache the result of expensive<a data-primary="calculations" data-secondary="replacing mocks with maps" data-type="indexterm" id="idm46393368135080"/> calculations.&#13;
Here, we won’t cache, but seed the <code>Map</code> with the parameters and result that we expect to see.</p>&#13;
&#13;
<p>Taking the <code>destinationFinder</code> case first, we’ll create a property to hold the <code>Map</code>, &#13;
<span class="keep-together"><code>featuredDestinations</code></span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">val</code> <code class="py">featuredDestinations</code> <code class="p">=</code>&#13;
    <code class="n">mutableMapOf</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;&gt;()</code>&#13;
        <code class="p">.</code><code class="n">withDefault</code> <code class="p">{</code> <code class="n">emptyList</code><code class="p">()</code> <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.7&amp;show=file">Example 17.7 [mocks-to-maps.1:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>givenFeaturedDestinationsFor</code> can populate the <code>destinationLookup</code> <code>Map</code> rather than setting expectations on a mock:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">givenFeaturedDestinationsFor</code><code class="p">(</code>&#13;
    <code class="n">location</code><code class="p">:</code> <code class="n">Location</code><code class="p">,</code>&#13;
    <code class="n">destinations</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">featuredDestinations</code><code class="p">[</code><code class="n">location</code><code class="p">]</code> <code class="p">=</code> <code class="n">destinations</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.8&amp;show=file">Example 17.8 [mocks-to-maps.1:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>If we make <code>Recommendations</code> read out of the <code>featuredDestinations</code> <code>Map</code>, we have passing tests:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">val</code> <code class="py">recommendations</code> <code class="p">=</code>&#13;
    <code class="n">Recommendations</code><code class="p">(</code>&#13;
        <code class="n">featuredDestinations</code><code class="o">::</code><code class="n">getValue</code><code class="p">,</code>&#13;
        <code class="n">distanceCalculator</code><code class="o">::</code><code class="n">distanceInMetersBetween</code>&#13;
    <code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.9&amp;show=file">Example 17.9 [mocks-to-maps.1:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>getValue</code> is an extension on <code>Map</code>.&#13;
It acts like <code>get</code> but respects the defaults set up by the <code>Map.withDefault</code> (in this case to return an <code>emptyList()</code>) and, hence, does not return a nullable result.</p>&#13;
&#13;
<p>It won’t surprise you when we do the same for <code>distanceInMetersBetween</code>, removing all our dependency on  Mockito:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">RecommendationsTests</code> <code class="p">{</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">featuredDestinations</code> <code class="p">=</code>&#13;
        <code class="n">mutableMapOf</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;&gt;()</code>&#13;
            <code class="p">.</code><code class="n">withDefault</code> <code class="p">{</code> <code class="n">emptyList</code><code class="p">()</code> <code class="p">}</code>&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">distanceInMetersBetween</code> <code class="p">=</code>&#13;
        <code class="n">mutableMapOf</code><code class="p">&lt;</code><code class="n">Pair</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">Location</code><code class="p">&gt;,</code> <code class="n">Int</code><code class="p">&gt;()</code>&#13;
            <code class="p">.</code><code class="n">withDefault</code> <code class="p">{</code> <code class="p">-</code><code class="m">1</code> <code class="p">}</code>&#13;
&#13;
    <code class="k">private</code> <code class="k">val</code> <code class="py">recommendations</code> <code class="p">=</code>&#13;
        <code class="n">Recommendations</code><code class="p">(</code>&#13;
            <code class="n">featuredDestinations</code><code class="o">::</code><code class="n">getValue</code><code class="p">,</code>&#13;
            <code class="p">{</code> <code class="n">l1</code><code class="p">,</code> <code class="n">l2</code> <code class="p">-&gt;</code> <code class="n">distanceInMetersBetween</code><code class="p">.</code><code class="n">getValue</code><code class="p">(</code><code class="n">l1</code> <code class="n">to</code> <code class="n">l2</code><code class="p">)</code> <code class="p">}</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.10&amp;show=file">Example 17.10 [mocks-to-maps.2:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">givenADistanceFrom</code><code class="p">(</code>&#13;
    <code class="n">location</code><code class="p">:</code> <code class="n">Location</code><code class="p">,</code>&#13;
    <code class="n">destination</code><code class="p">:</code> <code class="n">FeaturedDestination</code><code class="p">,</code>&#13;
    <code class="n">distanceInMeters</code><code class="p">:</code> <code class="n">Int</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">distanceInMetersBetween</code><code class="p">[</code><code class="n">location</code> <code class="n">to</code> <code class="n">destination</code><code class="p">.</code><code class="n">location</code><code class="p">]</code> <code class="p">=</code>&#13;
        <code class="n">distanceInMeters</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.11&amp;show=file">Example 17.11 [mocks-to-maps.2:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It might take a couple of passes to see how that works; these are the details that mocking frameworks hide for us.&#13;
You can safely ignore them and come back here if you ever execute this refactoring yourself.</p>&#13;
&#13;
<p>Having to use a lambda rather than a method reference in the <code>Recommendations</code> constructor invocation is a bit irritating.&#13;
We can tidy that up with a local <code>getValue</code> extension function.&#13;
Did we mention how much we like extension functions?</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="err">&lt;</code><code class="nf">K1</code><code class="p">,</code> <code class="n">K2</code><code class="p">,</code> <code class="n">V</code><code class="p">&gt;</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Pair</code><code class="p">&lt;</code><code class="n">K1</code><code class="p">,</code> <code class="n">K2</code><code class="p">&gt;,</code> <code class="n">V</code><code class="p">&gt;.</code><code class="n">getValue</code><code class="p">(</code><code class="n">k1</code><code class="p">:</code> <code class="n">K1</code><code class="p">,</code> <code class="n">k2</code><code class="p">:</code> <code class="n">K2</code><code class="p">)</code> <code class="p">=</code>&#13;
    <code class="n">getValue</code><code class="p">(</code><code class="n">k1</code> <code class="n">to</code> <code class="n">k2</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.12&amp;show=file">Example 17.12 [mocks-to-maps.3:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This lets us say:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">val</code> <code class="py">recommendations</code> <code class="p">=</code>&#13;
    <code class="n">Recommendations</code><code class="p">(</code>&#13;
        <code class="n">featuredDestinations</code><code class="o">::</code><code class="n">getValue</code><code class="p">,</code>&#13;
        <code class="n">distanceInMetersBetween</code><code class="o">::</code><code class="n">getValue</code>&#13;
    <code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.13&amp;show=file">Example 17.13 [mocks-to-maps.3:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Oh, and we can improve the readability of the test methods with some judicious parameter naming and helper methods.&#13;
Previously, we had plain function calls:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="nf">deduplicates_using_smallest_distance</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="p">(</code>&#13;
        <code class="n">alton</code><code class="p">,</code>&#13;
        <code class="n">flowerFarm</code><code class="p">,</code> <code class="n">watercressLine</code>&#13;
    <code class="p">)</code>&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="p">(</code>&#13;
        <code class="n">froyle</code><code class="p">,</code>&#13;
        <code class="n">flowerFarm</code><code class="p">,</code> <code class="n">watercressLine</code>&#13;
    <code class="p">)</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="m">5300</code><code class="p">)</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="m">320</code><code class="p">)</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="m">0</code><code class="p">)</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="m">6300</code><code class="p">)</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="m">0</code><code class="p">),</code>&#13;
            <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="m">320</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">recommendations</code><code class="p">.</code><code class="n">recommendationsFor</code><code class="p">(</code><code class="n">setOf</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">froyle</code><code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.14&amp;show=file">Example 17.14 [mocks-to-maps.3:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>A little effort yields:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Test</code>&#13;
<code class="k">fun</code> <code class="nf">deduplicates_using_smallest_distance</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">of</code><code class="p">(</code><code class="n">flowerFarm</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">))</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">to</code> <code class="p">=</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="n">of</code> <code class="p">=</code> <code class="m">5300</code><code class="p">)</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">to</code> <code class="p">=</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="n">of</code> <code class="p">=</code> <code class="m">320</code><code class="p">)</code>&#13;
&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">of</code><code class="p">(</code><code class="n">flowerFarm</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">))</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">to</code> <code class="p">=</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="n">of</code> <code class="p">=</code> <code class="m">0</code><code class="p">)</code>&#13;
    <code class="n">givenADistanceFrom</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">to</code> <code class="p">=</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="n">of</code> <code class="p">=</code> <code class="m">6300</code><code class="p">)</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">listOf</code><code class="p">(</code>&#13;
            <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">froyle</code><code class="p">,</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="m">0</code><code class="p">),</code>&#13;
            <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="m">320</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
        <code class="n">recommendations</code><code class="p">.</code><code class="n">recommendationsFor</code><code class="p">(</code><code class="n">setOf</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">froyle</code><code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.15&amp;show=file">Example 17.15 [mocks-to-maps.4:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Sometimes defining a tiny local function like <code>of</code> can go a long way to letting our brains just read code rather than spending effort interpreting it:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">of</code><code class="p">(</code><code class="k">vararg</code> <code class="n">destination</code><code class="p">:</code> <code class="n">FeaturedDestination</code><code class="p">)</code>&#13;
    <code class="p">=</code> <code class="n">destination</code><code class="p">.</code><code class="n">toList</code><code class="p">()</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.16&amp;show=file">Example 17.16 [mocks-to-maps.4:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
<div data-type="tip"><h1>Faking in Kotlin</h1>&#13;
<p>There<a data-primary="" data-startref="MMreplace17" data-type="indexterm" id="idm46393367425704"/><a data-primary="" data-startref="maprepl17" data-type="indexterm" id="idm46393367424696"/><a data-primary="dynamic proxies" data-type="indexterm" id="idm46393367423752"/><a data-primary="anonymous objects" data-type="indexterm" id="idm46393367423080"/><a data-primary="delegation" data-type="indexterm" id="idm46393367422408"/><a data-primary="selective overriding" data-type="indexterm" id="idm46393367421736"/> will be times, even in Kotlin, when we want to implement just some of an interface’s methods for testing.&#13;
On the JVM, we can combine dynamic proxies with anonymous objects, delegation, and selective overriding to write the following:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">inline</code> <code class="k">fun</code> <code class="err">&lt;</code><code class="nf">reified</code> <code class="n">T</code><code class="p">&gt;</code> <code class="n">fake</code><code class="p">():</code> <code class="n">T</code> <code class="p">=</code>&#13;
    <code class="n">Proxy</code><code class="p">.</code><code class="n">newProxyInstance</code><code class="p">(</code>&#13;
        <code class="n">T</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">.</code><code class="n">classLoader</code><code class="p">,</code>&#13;
        <code class="n">arrayOf</code><code class="p">(</code><code class="n">T</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">)</code>&#13;
    <code class="p">)</code> <code class="p">{</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code><code class="p">,</code> <code class="n">_</code> <code class="p">-&gt;</code>&#13;
        <code class="n">TODO</code><code class="p">(</code><code class="s">"not implemented"</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="k">as</code> <code class="n">T</code>&#13;
&#13;
&#13;
<code class="k">val</code> <code class="py">sentEmails</code> <code class="p">=</code> <code class="n">mutableListOf</code><code class="p">&lt;</code><code class="n">Email</code><code class="p">&gt;()</code>&#13;
<code class="k">val</code> <code class="py">testCollaborator</code><code class="p">:</code> <code class="n">EmailSystem</code> <code class="p">=</code>&#13;
    <code class="k">object</code> <code class="err">: </code><code class="nc">EmailSystem</code> <code class="k">by</code> <code class="n">fake</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">override</code> <code class="k">fun</code> <code class="nf">send</code><code class="p">(</code><code class="n">email</code><code class="p">:</code> <code class="n">Email</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="n">sentEmails</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">email</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Have We Really Weaned Off Mocks, Though?" data-type="sect1"><div class="sect1" id="idm46393367418984">&#13;
<h1>Have We Really Weaned Off Mocks, Though?</h1>&#13;
&#13;
<p>Ah, now<a data-primary="mocks to maps" data-secondary="benefits of refactoring" data-type="indexterm" id="MMbene17"/> that is a good question!</p>&#13;
&#13;
<p>In some ways, we have just implemented a poor imitation of a mocking framework: we have no parameter matchers, no way of failing if a method isn’t called, and no way of expressing execution order.</p>&#13;
&#13;
<p>Looked at another way though, we have implemented the recommendation engine’s dependencies as two maps.&#13;
<code>Recommendations.recommendationsFor</code> is beginning to look like a simple calculation (<a data-type="xref" href="ch07.html#calculations">“Calculations”</a>).&#13;
The result of that calculation depends on the <code>journey</code> parameter and on the contents of those maps that enable us to look up featured destinations and distances.&#13;
We<a data-primary="actions" data-secondary="replacing mocks with maps" data-type="indexterm" id="idm46393367257528"/> know that in reality <em>when</em> we call <code>recommendationsFor</code> does matter; it is really an action (<a data-type="xref" href="ch07.html#actions">“Actions”</a>).&#13;
The distance between locations probably won’t change over time, but which destinations we find around a location will as we add or remove them from whatever database they are held in.&#13;
In our tests, though, the distinction is moot, and we could treat &#13;
<span class="keep-together"><code>recommendationsFor</code></span> as a calculation in much the same way as we saw with &#13;
<span class="keep-together"><code>InMemoryTrips</code></span> in <a data-type="xref" href="ch07.html#actions-to-calculations">Chapter 7</a>.&#13;
Calculations are easier to test than actions—we just check that a given input returns a given output—so let’s pull on this thread.</p>&#13;
&#13;
<p class="pagebreak-before">At the moment, <em>when</em> we call <code>recommendationsFor</code> in the tests matters too, because the result will depend on the contents of the <code>featuredDestinations</code> and <code>distanceInMetersBetween</code> maps.&#13;
These are initially empty, and are populated by calls to <code>givenFeaturedDestinationsFor</code> and <code>givenADistanceFrom</code>. That’s a time sensitivity right there.&#13;
What we need is some way to convert an action to a calculation, and we can do that by manipulating scope.</p>&#13;
&#13;
<p>In <a data-type="xref" href="ch16.html#interfaces-to-functions">Chapter 16</a>, we saw that we can view methods as functions with some of their arguments partially applied by capturing them as fields.&#13;
In tests, we can reverse this process.&#13;
We can write a function that creates the object from its dependencies once for each invocation.&#13;
If we call the populated object the <em>subject</em> of the tests, we can create it from the test state like this:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">subjectFor</code><code class="p">(</code>&#13;
    <code class="n">featuredDestinations</code><code class="p">:</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;&gt;,</code>&#13;
    <code class="n">distances</code><code class="p">:</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Pair</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">Location</code><code class="p">&gt;,</code> <code class="n">Int</code><code class="p">&gt;</code>&#13;
<code class="p">):</code> <code class="n">Recommendations</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">destinationsLookup</code> <code class="p">=</code> <code class="n">featuredDestinations</code><code class="p">.</code><code class="n">withDefault</code> <code class="p">{</code> <code class="n">emptyList</code><code class="p">()</code> <code class="p">}</code>&#13;
    <code class="k">val</code> <code class="py">distanceLookup</code> <code class="p">=</code> <code class="n">distances</code><code class="p">.</code><code class="n">withDefault</code> <code class="p">{</code> <code class="p">-</code><code class="m">1</code> <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="n">Recommendations</code><code class="p">(</code><code class="n">destinationsLookup</code><code class="o">::</code><code class="n">getValue</code><code class="p">,</code> <code class="n">distanceLookup</code><code class="o">::</code><code class="n">getValue</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.17&amp;show=file">Example 17.17 [mocks-to-maps.5:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Here we create a new instance of <code>Recommendations</code> every call so that it can capture immutable maps representing the state of the system.</p>&#13;
&#13;
<p>Now we can write a <code>resultFor</code> function that uses <code>subjectFor</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">resultFor</code><code class="p">(</code>&#13;
    <code class="n">featuredDestinations</code><code class="p">:</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;&gt;,</code>&#13;
    <code class="n">distances</code><code class="p">:</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Pair</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">Location</code><code class="p">&gt;,</code> <code class="n">Int</code><code class="p">&gt;,</code>&#13;
    <code class="n">locations</code><code class="p">:</code> <code class="n">Set</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">&gt;</code>&#13;
<code class="p">):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestinationSuggestion</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">subject</code> <code class="p">=</code> <code class="n">subjectFor</code><code class="p">(</code><code class="n">featuredDestinations</code><code class="p">,</code> <code class="n">distances</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">subject</code><code class="p">.</code><code class="n">recommendationsFor</code><code class="p">(</code><code class="n">locations</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.18&amp;show=file">Example 17.18 [mocks-to-maps.5:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Outside of the scope of the <code>resultFor</code> function, there is no time sensitivity, so it is effectively a calculation.</p>&#13;
&#13;
<p>Now that we have a simple mapping of input to output (<code>resultFor</code>), we can write simple tests that call it.&#13;
Each test can just specify the input parameters and check that the result is as expected, with no need for state in the test at all.</p>&#13;
&#13;
<p>Every test can then be of the form:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">featuredDestinations</code><code class="p">:</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestination</code><code class="p">&gt;&gt;,</code>&#13;
    <code class="n">distances</code><code class="p">:</code> <code class="n">Map</code><code class="p">&lt;</code><code class="n">Pair</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">,</code> <code class="n">Location</code><code class="p">&gt;,</code> <code class="n">Int</code><code class="p">&gt;,</code>&#13;
    <code class="n">recommendations</code><code class="p">:</code> <code class="n">Set</code><code class="p">&lt;</code><code class="n">Location</code><code class="p">&gt;,</code>&#13;
    <code class="n">shouldReturn</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">FeaturedDestinationSuggestion</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">shouldReturn</code><code class="p">,</code>&#13;
        <code class="n">resultFor</code><code class="p">(</code><code class="n">featuredDestinations</code><code class="p">,</code> <code class="n">distances</code><code class="p">,</code> <code class="n">recommendations</code><code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.19&amp;show=file">Example 17.19 [mocks-to-maps.5:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This gives a pleasing simplicity to the previously confusing tests:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">RecommendationsTests</code> <code class="p">{</code>&#13;
    <code class="n">companion</code> <code class="k">object</code> <code class="err">{</code>&#13;
        <code class="k">val</code> <code class="py">distances</code> <code class="p">=</code> <code class="n">mapOf</code><code class="p">(</code>&#13;
            <code class="p">(</code><code class="n">paris</code> <code class="n">to</code> <code class="n">eiffelTower</code><code class="p">.</code><code class="n">location</code><code class="p">)</code> <code class="n">to</code> <code class="m">5000</code><code class="p">,</code>&#13;
            <code class="p">(</code><code class="n">paris</code> <code class="n">to</code> <code class="n">louvre</code><code class="p">.</code><code class="n">location</code><code class="p">)</code> <code class="n">to</code> <code class="m">1000</code><code class="p">,</code>&#13;
            <code class="p">(</code><code class="n">alton</code> <code class="n">to</code> <code class="n">flowerFarm</code><code class="p">.</code><code class="n">location</code><code class="p">)</code> <code class="n">to</code> <code class="m">5300</code><code class="p">,</code>&#13;
            <code class="p">(</code><code class="n">alton</code> <code class="n">to</code> <code class="n">watercressLine</code><code class="p">.</code><code class="n">location</code><code class="p">)</code> <code class="n">to</code> <code class="m">320</code><code class="p">,</code>&#13;
            <code class="p">(</code><code class="n">froyle</code> <code class="n">to</code> <code class="n">flowerFarm</code><code class="p">.</code><code class="n">location</code><code class="p">)</code> <code class="n">to</code> <code class="m">0</code><code class="p">,</code>&#13;
            <code class="p">(</code><code class="n">froyle</code> <code class="n">to</code> <code class="n">watercressLine</code><code class="p">.</code><code class="n">location</code><code class="p">)</code> <code class="n">to</code> <code class="m">6300</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="nf">returns_no_recommendations_when_no_featured</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">check</code><code class="p">(</code>&#13;
            <code class="n">featuredDestinations</code> <code class="p">=</code> <code class="n">emptyMap</code><code class="p">(),</code>&#13;
            <code class="n">distances</code> <code class="p">=</code> <code class="n">distances</code><code class="p">,</code>&#13;
            <code class="n">recommendations</code> <code class="p">=</code> <code class="n">setOf</code><code class="p">(</code><code class="n">paris</code><code class="p">),</code>&#13;
            <code class="n">shouldReturn</code> <code class="p">=</code> <code class="n">emptyList</code><code class="p">()</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="nf">returns_recommendations_for_multi_location</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">check</code><code class="p">(</code>&#13;
            <code class="n">featuredDestinations</code> <code class="p">=</code> <code class="n">mapOf</code><code class="p">(</code>&#13;
                <code class="n">paris</code> <code class="n">to</code> <code class="n">listOf</code><code class="p">(</code><code class="n">eiffelTower</code><code class="p">,</code> <code class="n">louvre</code><code class="p">),</code>&#13;
                <code class="n">alton</code> <code class="n">to</code> <code class="n">listOf</code><code class="p">(</code><code class="n">flowerFarm</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">),</code>&#13;
            <code class="p">),</code>&#13;
            <code class="n">distances</code> <code class="p">=</code> <code class="n">distances</code><code class="p">,</code>&#13;
            <code class="n">recommendations</code> <code class="p">=</code> <code class="n">setOf</code><code class="p">(</code><code class="n">paris</code><code class="p">,</code> <code class="n">alton</code><code class="p">),</code>&#13;
            <code class="n">shouldReturn</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">watercressLine</code><code class="p">,</code> <code class="m">320</code><code class="p">),</code>&#13;
                <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">paris</code><code class="p">,</code> <code class="n">louvre</code><code class="p">,</code> <code class="m">1000</code><code class="p">),</code>&#13;
                <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">paris</code><code class="p">,</code> <code class="n">eiffelTower</code><code class="p">,</code> <code class="m">5000</code><code class="p">),</code>&#13;
                <code class="n">FeaturedDestinationSuggestion</code><code class="p">(</code><code class="n">alton</code><code class="p">,</code> <code class="n">flowerFarm</code><code class="p">,</code> <code class="m">5300</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.20&amp;show=file">Example 17.20 [mocks-to-maps.5:src/test/java/travelator/recommendations/RecommendationsTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It’s instructive to compare this with an original test:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Test</code>&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">returns_recommendations_for_multi_location</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code>&#13;
        <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="n">eiffelTower</code><code class="o">,</code>&#13;
            <code class="n">louvre</code>&#13;
        <code class="o">));</code>&#13;
    <code class="n">givenADistanceBetween</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">eiffelTower</code><code class="o">,</code> <code class="mi">5000</code><code class="o">);</code>&#13;
    <code class="n">givenADistanceBetween</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">louvre</code><code class="o">,</code> <code class="mi">1000</code><code class="o">);</code>&#13;
&#13;
    <code class="n">givenFeaturedDestinationsFor</code><code class="o">(</code><code class="n">alton</code><code class="o">,</code>&#13;
        <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="n">flowerFarm</code><code class="o">,</code>&#13;
            <code class="n">watercressLine</code>&#13;
        <code class="o">));</code>&#13;
    <code class="n">givenADistanceBetween</code><code class="o">(</code><code class="n">alton</code><code class="o">,</code> <code class="n">flowerFarm</code><code class="o">,</code> <code class="mi">5300</code><code class="o">);</code>&#13;
    <code class="n">givenADistanceBetween</code><code class="o">(</code><code class="n">alton</code><code class="o">,</code> <code class="n">watercressLine</code><code class="o">,</code> <code class="mi">320</code><code class="o">);</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="o">(</code>&#13;
        <code class="n">List</code><code class="o">.</code><code class="na">of</code><code class="o">(</code>&#13;
            <code class="k">new</code> <code class="nf">FeaturedDestinationSuggestion</code><code class="o">(</code><code class="n">alton</code><code class="o">,</code> <code class="n">watercressLine</code><code class="o">,</code> <code class="mi">320</code><code class="o">),</code>&#13;
            <code class="k">new</code> <code class="nf">FeaturedDestinationSuggestion</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">louvre</code><code class="o">,</code> <code class="mi">1000</code><code class="o">),</code>&#13;
            <code class="k">new</code> <code class="nf">FeaturedDestinationSuggestion</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">eiffelTower</code><code class="o">,</code> <code class="mi">5000</code><code class="o">),</code>&#13;
            <code class="k">new</code> <code class="nf">FeaturedDestinationSuggestion</code><code class="o">(</code><code class="n">alton</code><code class="o">,</code> <code class="n">flowerFarm</code><code class="o">,</code> <code class="mi">5300</code><code class="o">)</code>&#13;
        <code class="o">),</code>&#13;
        <code class="n">recommendations</code><code class="o">.</code><code class="na">recommendationsFor</code><code class="o">(</code><code class="n">Set</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="n">paris</code><code class="o">,</code> <code class="n">alton</code><code class="o">))</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=17.21&amp;show=file">Example 17.21 [interfaces-to-funs.0:src/test/java/travelator/recommendations/RecommendationsTests.java]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=17.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Admittedly, this is Java, and broken up a bit by the <code>givenADistanceBetween</code> calls, but you can see how this refactoring has migrated our tests from woolly functions that may or may not have a common structure to a clear testing of inputs against outputs.<a data-primary="" data-startref="MMbene17" data-type="indexterm" id="idm46393366464248"/><a data-primary="" data-startref="Rmock17" data-type="indexterm" id="idm46393366463272"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393368289896">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>Mocks<a data-primary="mocks to maps" data-secondary="benefits and drawbacks of maps" data-type="indexterm" id="idm46393366461432"/> have their place in software, and outside-in test-driven development (TDD) can certainly improve our designs by allowing us to prototype how to distribute functionality between collaborating objects without having to commit to complete implementations.&#13;
However, they have a habit of masking design problems by allowing us to test designs expressed as object interactions that would be better seen as data flows.</p>&#13;
&#13;
<p>In this example, we’ve seen how focusing on data can simplify our tests, especially where we are only reading values.&#13;
In <a data-type="xref" data-xrefstyle="chap-num-title" href="ch20.html#performing-io-to-passing-data">Chapter 20, <em>Performing I/O to Passing Data</em></a>, we explore how we can apply this technique to writing as well.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>