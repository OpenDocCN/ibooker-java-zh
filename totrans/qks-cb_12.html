<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 12. Application Secrets Management"><div class="chapter" id="idm45128504256728">
<h1><span class="label">Chapter 12. </span>Application Secrets Management</h1>


<p><a data-type="indexterm" data-primary="secrets" id="sec_ch"/>Every application has information that needs to be kept confidential.
This information could include database credentials, external service authentication, or even the location of certain resources.
All of these are collectively called <em>secrets</em>.
Your application needs a secure place to store these secrets both during application startup and at rest.
In this chapter, we will discuss secret management using Kubernetes and Vault.</p>






<section data-type="sect1" data-pdf-bookmark="12.1 Storing Data Using Kubernetes Secrets"><div class="sect1" id="idm45128501077336">
<h1>12.1 Storing Data Using Kubernetes Secrets</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128501076248">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="data" id="dat_ab"/><a data-type="indexterm" data-primary="secrets" data-secondary="storing data using" id="sec_dat"/>You want to store secrets in Kubernetes in a safer way than directly on the Pod or container.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128501072360">
<h2>Solution</h2>

<p>Use Kubernetes secrets to store and retrieve sensitive data such as passwords, tokens, or SSH keys in plain text on a container.
Kubernetes has the concept of <code>secret</code> objects that can be used to store sensitive data.</p>

<p>It is important to know that storing sensitive data in a secret object does not automatically make it secure because Kubernetes does not encrypt data but instead encodes it in Base64 by default.
Using secrets gives you some features that are not provided by the standard 
<span class="keep-together">configuration</span> process:</p>

<ul class="no-space-list">
<li>
<p>You can define the authorization policies to access the secret.</p>
</li>
<li>
<p>You can configure Kubernetes to encrypt sensitive data (this is known as 
<span class="keep-together"><em>encryption at rest</em>).</span></p>
</li>
<li>
<p>You can grant access to a specific container instance using lists.</p>
</li>
</ul>
<div data-type="important"><h6>Important</h6>
<p>None of these features are enabled by default, and they require some knowledge about Kubernetes. In the book, we explain only how Quarkus integrates with other tools like Kubernetes; we do not explain the operational side of the tool.</p>
</div>

<p>The secrets can be injected into the container as an environment variable or as a volume.
The environment variable approach is less secure because anyone with access to the container instance could dump the content easily.
The volume approach, on the other hand, easily becomes complex when there are a large number of keys because Kubernetes creates one file per key to store inside the value.</p>

<p>Both approaches are shown, so you can choose the one that works better for your use case.</p>

<p>The example covers the use case in which an API token (e.g., GitHub Personal Access Token) needs to be set as secret in the application.</p>

<p>To enable the generation of Kubernetes resources with the <code>secrets</code> injection in the <code>Pod</code>, you need to register the <code>quarkus-kubernetes</code> extension:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-kubernetes"</code></pre>

<p>Create a secret by creating a Kubernetes resource of the kind <code>Secret</code> or by using the <code>kubectl</code> CLI tool.
Open a new terminal and run the following command to register a new secret with <code>greeting-security</code> ID and a key <code>github.api.key.token</code> with a token (this token is invalid and is used only for example purposes):</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl create secret generic greeting-security \</code>
<code class="go">--from-literal=github.api.key.token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.\</code>
<code class="go">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.\</code>
<code class="go">SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code></pre>

<p>Now that the secret is created, let’s see how to set it as an environment variable.</p>

<p>A configuration property is required to get the property from the environment variable.
In this case, the property is called <code>github.api.key.token</code>, but of course you could also access it directly by using <code>System.getenv()</code>.
The former approach is better because it relies on the MicroProfile Config spec to read the configuration properties and not some custom solution:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code> <code class="o">=</code> <code class="s">"github.api.key.token"</code><code class="o">)</code>
<code class="n">String</code> <code class="n">githubToken</code><code class="o">;</code></pre>

<p>Set extra properties for the Kubernetes extension in the <em>application.properties</em> so that the generated Kubernetes deployment file contains the segments needed to inject the secret as an environment variable:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.container-image.group</code><code class="o">=</code><code class="s">quarkus </code><a class="co" id="co_application_secrets_management_CO1-1" href="#callout_application_secrets_management_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.container-image.name</code><code class="o">=</code><code class="s">greeting-started-kubernetes-secrets</code><code>
</code><code class="na">quarkus.container-image.tag</code><code class="o">=</code><code class="s">1.0-SNAPSHOT</code><code>
</code><code class="na">quarkus.kubernetes.image-pull-policy</code><code class="o">=</code><code class="s">if-not-present</code><code>
</code><code class="na">quarkus.kubernetes.env-vars.github-api-key-token.name</code><code class="o">=</code><code class="s">github.api.key.token </code><a class="co" id="co_application_secrets_management_CO1-2" href="#callout_application_secrets_management_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.env-vars.github-api-key-token.secret</code><code class="o">=</code><code class="s">greeting-security </code><a class="co" id="co_application_secrets_management_CO1-3" href="#callout_application_secrets_management_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO1-1" href="#co_application_secrets_management_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Configures Docker image</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO1-2" href="#co_application_secrets_management_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the environment variable to override the <code>github.api.key.token</code> property</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO1-3" href="#co_application_secrets_management_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the secret name to load</p></dd>
</dl>

<p>The generation of the Kubernetes file will contain a new entry in the container definition called <code>secretKeyRef</code> that defines all the key/value pairs.</p>

<p><a data-type="indexterm" data-primary="MicroProfile Config specification" id="idm45128500898872"/>The MicroProfile Config spec permits the override of any configuration property using the equivalent environment variable (in uppercase and changing dots [<code>.</code>] to underscores [<code>_</code>]).
The <code>Secrets</code> contains the configuration properties as secrets.
In <em>application.properties</em>, the Kubernetes extension is configured to generate a deployment descriptor that sets these secrets as environment variables so that when the 
<span class="keep-together">container</span> is started inside the Kubernetes cluster, the secrets are injected into the container as environment variables and are read by MicroProfile Config as configuration properties.</p>

<p>To deploy the application, open a new terminal window, package the application, 
<span class="keep-together">create</span> the Docker container, and apply the generated Kubernetes resources:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -DskipTests</code>

<code class="go">docker build -f src/main/docker/Dockerfile.jvm \</code>
<code class="go">    -t quarkus/greeting-started-kubernetes-secrets:1.0-SNAPSHOT .</code>
<code class="go">kubectl apply -f target/kubernetes/kubernetes.yml</code>

<code class="go">kubectl patch svc greeting-started-kubernetes-secrets \</code>
<code class="go">    --type='json' \</code>
<code class="go">    -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]'</code>
<code class="go">curl $(minikube service greeting-started-kubernetes-secrets --url)/hello</code></pre>

<p>But secrets can also be mounted as volumes instead of being set as environment variables.
Set the Kubernetes extension properties in the <em>application.properties</em> so that the generated Kubernetes deployment file contains the segments to mount the secret file as a volume:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.kubernetes.mounts.github-token.path</code><code class="o">=</code><code class="s">/deployment/github </code><a class="co" id="co_application_secrets_management_CO2-1" href="#callout_application_secrets_management_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="s"> </code><a class="co" id="co_application_secrets_management_CO2-2" href="#callout_application_secrets_management_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.mounts.github-token.read-only</code><code class="o">=</code><code class="s">true </code><a class="co" id="co_application_secrets_management_CO2-3" href="#callout_application_secrets_management_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.secret-volumes.github-token.secret-name</code><code class="o">=</code><code class="s">greeting-security</code><a class="co" id="co_application_secrets_management_CO2-4" href="#callout_application_secrets_management_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">quarkus.kubernetes.secret-volumes.github-token.default-mode</code><code class="o">=</code><code class="s">420 </code><a class="co" id="co_application_secrets_management_CO2-5" href="#callout_application_secrets_management_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></pre>
<div style="page-break-after: always;"/>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO2-1" href="#co_application_secrets_management_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Mounts the volume with <code>github-token</code> name</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO2-2" href="#co_application_secrets_management_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the path where the volume is mounted inside the container</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO2-3" href="#co_application_secrets_management_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the volume as read-only</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO2-4" href="#co_application_secrets_management_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets the secret name to load</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO2-5" href="#co_application_secrets_management_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Sets the mode to be readable from the process</p></dd>
</dl>

<p>The last step is to read the secret from the code.
Since the secret is mounted in the file system, it needs to be read as any other file:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/file"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">ghTokenFile</code><code class="o">(</code><code class="o">)</code><code> </code><code class="kd">throws</code><code> </code><code class="n">IOException</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">final</code><code> </code><code class="kt">byte</code><code class="o">[</code><code class="o">]</code><code> </code><code class="n">encodedGHToken</code><code> </code><code class="o">=</code><code> </code><code class="n">Files</code><code class="o">.</code><code class="na">readAllBytes</code><code class="o">(</code><code>
</code><code>        </code><code class="n">Paths</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"/deployment/github/github.api.key.token"</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_application_secrets_management_CO3-1" href="#callout_application_secrets_management_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="k">new</code><code> </code><code class="nf">String</code><code class="o">(</code><code class="n">encodedGHToken</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO3-1" href="#co_application_secrets_management_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The location of the secret is the mount path plus the secret key</p></dd>
</dl>

<p>To deploy the application, package it, create the Docker container, and apply the generated Kubernetes resources:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -DskipTests</code>

<code class="go">docker build -f src/main/docker/Dockerfile.jvm \</code>
<code class="go">    -t quarkus/greeting-started-kubernetes-secrets:1.0-SNAPSHOT .</code>
<code class="go">kubectl apply -f target/kubernetes/kubernetes.yml</code>

<code class="go">kubectl patch svc greeting-started-kubernetes-secrets --type='json' \</code>
<code class="go">    -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]'</code>
<code class="go">curl $(minikube service greeting-started-kubernetes-secrets --url=/hello/file</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128501071576">
<h2>Discussion</h2>

<p>Kubernetes secrets have some problems that need to be addressed externally.
The 
<span class="keep-together">following</span> are some of these problems:</p>

<ul>
<li>
<p>Secrets are not encrypted but just encoded in Base64 by default.</p>
</li>
<li>
<p>You need to use SSL to communicate with <code>etcd</code>. This is the place where the secrets are stored.</p>
</li>
</ul>
<div style="page-break-after: always;"/>

<ul>
<li>
<p>The disk needs to be encrypted because <code>etcd</code> might store the data on the disk.</p>
</li>
<li>
<p>You need to correctly define the RBAC to prevent anyone from accessing a secret.<a data-type="indexterm" data-primary="" data-startref="dat_ab" id="idm45128500690952"/><a data-type="indexterm" data-primary="" data-startref="sec_dat" id="idm45128500689976"/></p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128500688648">
<h2>See Also</h2>

<p>To learn more about Kubernetes Secrets, visit the following pages on the Kubernetes website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/dFTgh">Secrets</a></p>
</li>
<li>
<p><a href="https://oreil.ly/_auK1">Encrypting Secret Data at Rest</a></p>
</li>
<li>
<p><a href="https://oreil.ly/ctlyn">Authorization Overview</a></p>
</li>
<li>
<p><a href="https://oreil.ly/WrcaP">Using RBAC Authorization</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="12.2 Store Configuration Secrets Securely with Vault"><div class="sect1" id="idm45128500681384">
<h1>12.2 Store Configuration Secrets Securely with Vault</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128500680168">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="secrets" data-secondary="storing securely with Vault" id="sec_vau"/><a data-type="indexterm" data-primary="Vault" data-secondary="storing secrets with" id="vau_sec"/>You want to store configuration secrets securely.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128500676152">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="secrets" data-secondary="website" id="idm45128500674584"/><a data-type="indexterm" data-primary="Vault" data-secondary="website" id="idm45128500673608"/>Use the Quarkus <a href="https://oreil.ly/UMKuH">Vault</a> extension to retrieve secrets.</p>

<p>The key aspects when dealing with secrets are storing them so they cannot be read by forbidden users and protecting access to them so only the services that require the secrets can access them.</p>

<p>Vault is a tool that simplifies these use cases by providing a unified interface for storing and consuming secrets.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45128500670552">
<h5>About Vault</h5>
<p><a href="https://oreil.ly/UMKuH">Vault</a> is an open source tool for securely accessing secrets.
How to run Vault in production is outside the scope of this book.</p>

<p>To simplify the installation of Vault, the Vault Docker container is used:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker run --rm --cap-add=IPC_LOCK -e VAULT_ADDR=http://localhost:8200 \
</code><code class="go">  -p 8200:8200 --name=dev-vault vault:1.2.2
</code><code class="go">
</code><code class="go">You may need to set the following environment variable:
</code><code class="go">
</code><code class="go">    $ export VAULT_ADDR='http://0.0.0.0:8200'
</code><code class="go">
</code><code class="go">The unseal key and root token are displayed below in case you want to
</code><code class="go">seal/unseal the Vault or re-authenticate.
</code><code class="go">
</code><code class="go">Unseal Key: s7WbMScSOh02ERK6XEfl6ep6BReRQZzl9VekrrnyKE8=
</code><code class="go">Root Token: s.ty3QS2uNaxPdiFsSZpCQfjpc </code><a class="co" id="co_application_secrets_management_CO4-1" href="#callout_application_secrets_management_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO4-1" href="#co_application_secrets_management_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Token to initialize access to Vault</p></dd>
</dl>

<p>Open a shell inside the Vault container to configure Vault and add a secret:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker exec -it dev-vault sh
</code><code class="go">export VAULT_TOKEN=s.ty3QS2uNaxPdiFsSZpCQfjpc </code><a class="co" id="co_application_secrets_management_CO5-1" href="#callout_application_secrets_management_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">vault kv put secret/myapps/vault-service/config foo=secretbar </code><a class="co" id="co_application_secrets_management_CO5-2" href="#callout_application_secrets_management_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO5-1" href="#co_application_secrets_management_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the token to access</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO5-2" href="#co_application_secrets_management_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Creates a new secret with key <code>foo</code> at path <em>secret/myapps/vault-service/config</em></p></dd>
</dl>

<p>Create a policy that gives read access to the secret:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">cat &lt;&lt;EOF | vault policy write vault-service-policy -</code>
<code class="go">path "secret/data/myapps/vault-service/*" {</code>
<code class="go">  capabilities = ["read"]</code>
<code class="go">}</code>
<code class="go">EOF</code></pre>

<p>The last step is to enable credentials (<code>userpass</code> engine) for accessing secrets from the service:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">vault auth enable userpass
</code><code class="go">vault write auth/userpass/users/alex password=alex \
</code><code class="go">  policies=vault-service-policy </code><a class="co" id="co_application_secrets_management_CO6-1" href="#callout_application_secrets_management_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO6-1" href="#co_application_secrets_management_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Creates a user with ID <code>alex</code> and password <code>alex</code></p></dd>
</dl>
</div></aside>

<p>Vault supports multiple authentication methods to authenticate against the Vault 
<span class="keep-together">service</span> and start consuming the secrets.
At the time of writing, the following authentication methods are supported by the Quarkus Vault extension<a data-type="indexterm" data-primary="token authentication method" id="idm45128500553016"/><a data-type="indexterm" data-primary="user/password authentication method" id="idm45128500552344"/><a data-type="indexterm" data-primary="approle authentication method" id="idm45128500551704"/><a data-type="indexterm" data-primary="Kubernetes" data-secondary="authentication method" id="idm45128500551064"/>:</p>
<dl>
<dt><code>token</code></dt>
<dd>
<p>Directly pass the user token to bypass the authentication process.</p>
</dd>
<dt><code>user</code>/<code>password</code></dt>
<dd>
<p>Authenticate with Vault using a username and password credentials.</p>
</dd>
<dt><code>approle</code></dt>
<dd>
<p>Authenticate using a <code>role_id</code> and a <code>secret_id</code>. This method is oriented to automated workflows (machines and services). <code>role_id</code> is usually embedded into a Docker container, and <code>secret_id</code> is obtained by a Kubernetes cluster as a cubbyhole response, wrapping it (single use) and delivering it to the target service.</p>
</dd>
<dt><code>kubernetes</code></dt>
<dd>
<p>Authenticate with Vault using the Kubernetes Service Account Token.</p>
</dd>
</dl>

<p>To get started, register the <code>quarkus-vault</code> extension to use Vault:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-vault"</code></pre>

<p><a data-type="indexterm" data-primary="@ConfigProperty annotation" id="idm45128500481576"/>The Quarkus Vault extension integrates with the MicroProfile Configuration spec so that a secret can be injected using the <code>@ConfigProperty</code> annotation.
Configure the application to use username and password as the authentication method for Vault, and set the base path where secrets are stored:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.vault.url</code><code class="o">=</code><code class="s">http://localhost:8200 </code><a class="co" id="co_application_secrets_management_CO7-1" href="#callout_application_secrets_management_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.authentication.userpass.username</code><code class="o">=</code><code class="s">alex </code><a class="co" id="co_application_secrets_management_CO7-2" href="#callout_application_secrets_management_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.authentication.userpass.password</code><code class="o">=</code><code class="s">alex</code><code>

</code><code class="na">quarkus.vault.kv-secret-engine-version</code><code class="o">=</code><code class="s">2 </code><a class="co" id="co_application_secrets_management_CO7-3" href="#callout_application_secrets_management_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.secret-config-kv-path</code><code class="o">=</code><code class="s">myapps/vault-service/config</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO7-1" href="#co_application_secrets_management_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The base URL of the Vault server</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO7-2" href="#co_application_secrets_management_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The credentials to authenticate</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO7-3" href="#co_application_secrets_management_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The path where the secrets are stored</p></dd>
</dl>

<p>Access the secret value of the <code>foo</code> key by using the <code>@org.eclipse.microprofile.config.inject.ConfigProperty</code> annotation:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s">"foo"</code><code class="o">)</code><code> </code><a class="co" id="co_application_secrets_management_CO8-1" href="#callout_application_secrets_management_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">String</code><code> </code><code class="n">foo</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@GET</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">hello</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">foo</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO8-1" href="#co_application_secrets_management_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Secret value for the <code>foo</code> key is injected</p></dd>
</dl>

<p>Start the application and send a request to the endpoint:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean compile quarkus:dev</code>

<code class="go">curl http://localhost:8080/hello</code>
<code class="go">secretbar</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128500675560">
<h2>Discussion</h2>

<p>If the path is known only at runtime, secrets can also be retrieved programmatically by injecting the <code>io.quarkus.vault.VaultKVSecretEngine</code> interface:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code><code>
</code><code class="n">VaultKVSecretEngine</code><code> </code><code class="n">kvSecretEngine</code><code class="o">;</code><code>
</code><code>
</code><code class="kd">final</code><code> </code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code><code> </code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="n">secrets</code><code> </code><code class="o">=</code><code> </code><code class="n">kvSecretEngine</code><code>
</code><code>  </code><code class="o">.</code><code class="na">readSecret</code><code class="o">(</code><code class="s">"myapps/vault-service/config"</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_application_secrets_management_CO9-1" href="#callout_application_secrets_management_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">final</code><code> </code><code class="n">String</code><code> </code><code class="n">fooSecret</code><code> </code><code class="o">=</code><code> </code><code class="n">secrets</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"foo"</code><code class="o">)</code><code class="o">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO9-1" href="#co_application_secrets_management_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Provides the values stored in the Vault key/value secret engine</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128500299800">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="sec_vau" id="idm45128500298632"/><a data-type="indexterm" data-primary="" data-startref="vau_sec" id="idm45128500297656"/><a data-type="indexterm" data-primary="Vault" data-secondary="website" id="idm45128500296712"/>To learn more about Vault, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/ke_Q5">Vault: Documentation</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="12.3 Cryptography as a Service"><div class="sect1" id="idm45128500293672">
<h1>12.3 Cryptography as a Service</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128500264328">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="cryptography-as-a-service" id="cry_ab"/><a data-type="indexterm" data-primary="secrets" data-secondary="cryptography-as-a-service" id="sec_cry"/>You want to avoid spreading all cryptographic operations across all the services.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128500261000">
<h2>Solution</h2>

<p>Use the <em>transit</em> engine of Vault to have all cryptographic operations executed in the same place.</p>

<p>Open a shell inside the Vault container created in the previous recipe to configure Vault and add keys to encrypt and sign messages:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker exec -it dev-vault sh
</code><code class="go">export VAULT_TOKEN=s.ty3QS2uNaxPdiFsSZpCQfjpc </code><a class="co" id="co_application_secrets_management_CO10-1" href="#callout_application_secrets_management_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">vault secrets enable transit </code><a class="co" id="co_application_secrets_management_CO10-2" href="#callout_application_secrets_management_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">vault write -f transit/keys/my_encryption </code><a class="co" id="co_application_secrets_management_CO10-3" href="#callout_application_secrets_management_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="go">
</code><code class="go">vault write transit/keys/my-sign-key type=ecdsa-p256 </code><a class="co" id="co_application_secrets_management_CO10-4" href="#callout_application_secrets_management_CO10-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO10-1" href="#co_application_secrets_management_CO10-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the token to access</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO10-2" href="#co_application_secrets_management_CO10-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Enables <code>transit</code> engine</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO10-3" href="#co_application_secrets_management_CO10-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Creates an encryption key of type <code>AES-256-GCM96</code></p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO10-4" href="#co_application_secrets_management_CO10-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Creates a signing key of type <code>ECDSA-P256</code></p></dd>
</dl>

<p>Create a policy that gives access to transit operations:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">cat &lt;&lt;EOF | vault policy write vault-service-policy -</code>
<code class="go">path "transit/*" {</code>
<code class="go">  capabilities = [ "create", "read", "update" ]</code>
<code class="go">}</code>
<code class="go">EOF</code></pre>

<p>The last step is to enable credentials (<code>userpass</code> engine) for accessing secrets from the service:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">vault auth enable userpass
</code><code class="go">vault write auth/userpass/users/alex password=alex \
</code><code class="go">  policies=vault-service-policy </code><a class="co" id="co_application_secrets_management_CO11-1" href="#callout_application_secrets_management_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO11-1" href="#co_application_secrets_management_CO11-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Creates a user with ID <code>alex</code> and password <code>alex</code></p></dd>
</dl>

<p>Register <code>quarkus-vault</code> extension to use Vault:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-vault"</code></pre>

<p>Configure the application to use username and password as the authentication method for Vault:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.vault.url</code><code class="o">=</code><code class="s">http://localhost:8200 </code><a class="co" id="co_application_secrets_management_CO12-1" href="#callout_application_secrets_management_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>

</code><code class="na">quarkus.vault.authentication.userpass.username</code><code class="o">=</code><code class="s">alex </code><a class="co" id="co_application_secrets_management_CO12-2" href="#callout_application_secrets_management_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.authentication.userpass.password</code><code class="o">=</code><code class="s">alex</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO12-1" href="#co_application_secrets_management_CO12-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The base URL of the Vault server</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO12-2" href="#co_application_secrets_management_CO12-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The credentials to authenticate</p></dd>
</dl>

<p>Inject the <code>io.quarkus.vault.VaultTransitSecretEngine</code> instance to use transit operations:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code><code>
</code><code class="n">VaultTransitSecretEngine</code><code> </code><code class="n">transit</code><code class="o">;</code><code> </code><a class="co" id="co_application_secrets_management_CO13-1" href="#callout_application_secrets_management_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="nd">@GET</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/encrypt"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">encrypt</code><code class="o">(</code><code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"text"</code><code class="o">)</code><code> </code><code class="n">String</code><code> </code><code class="n">text</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">transit</code><code class="o">.</code><code class="na">encrypt</code><code class="o">(</code><code class="s">"my_encryption"</code><code class="o">,</code><code> </code><code class="n">text</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_application_secrets_management_CO13-2" href="#callout_application_secrets_management_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="o">}</code><code>
</code><code>
</code><code class="nd">@GET</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/decrypt"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">decrypt</code><code class="o">(</code><code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"text"</code><code class="o">)</code><code> </code><code class="n">String</code><code> </code><code class="n">text</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">transit</code><code class="o">.</code><code class="na">decrypt</code><code class="o">(</code><code class="s">"my_encryption"</code><code class="o">,</code><code> </code><code class="n">text</code><code class="o">)</code><code class="o">.</code><code class="na">asString</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_application_secrets_management_CO13-3" href="#callout_application_secrets_management_CO13-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="o">}</code><code>
</code><code>
</code><code class="nd">@GET</code><code>
</code><code class="nd">@Path</code><code class="o">(</code><code class="s">"/sign"</code><code class="o">)</code><code>
</code><code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code><code>
</code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">sign</code><code class="o">(</code><code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"text"</code><code class="o">)</code><code> </code><code class="n">String</code><code> </code><code class="n">text</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">transit</code><code class="o">.</code><code class="na">sign</code><code class="o">(</code><code class="s">"my-sign-key"</code><code class="o">,</code><code> </code><code class="n">text</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_application_secrets_management_CO13-4" href="#callout_application_secrets_management_CO13-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO13-1" href="#co_application_secrets_management_CO13-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Transit operations interface</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO13-2" href="#co_application_secrets_management_CO13-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Encrypts using the encryption key</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO13-3" href="#co_application_secrets_management_CO13-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Decrypts using the encryption key</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO13-4" href="#co_application_secrets_management_CO13-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Signs the text with the given signature</p></dd>
</dl>

<p>Start the application and send a request to the endpoint:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean compile quarkus:dev</code>

<code class="go">curl http://localhost:8080/hello/encrypt?text=Ada</code>
<code class="go">vault:v1:iIunGAElLpbaNWWqZq1yf4cctkEUOFdJE1oRTaSI2g==</code>

<code class="go">curl http://localhost:8080/hello/decrypt? \</code>
<code class="go">     text=vault:v1:iIunGAElLpbaNWWqZq1yf4cctkEUOFdJE1oRTaSI2g==</code>
<code class="go">Ada</code>

<code class="go">curl http://localhost:8080/hello/sign?text=Alexandra</code>
<code class="go">vault:v1:MEUCIGkgS5VY5KEU2yHqnIn9qwzgfBUv3O2H4bgNAFVrYCK3AiEAnQznfdEZI6b\</code>
<code class="go">  /Xtko/wEl8WhZLuKZQ/arOYkfsnwBH3M=</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128499930968">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="HMACs (hash-based message authentication codes)" id="idm45128499883816"/>Cryptography operations such as encrypt, decrypt, sign, or hash-based message authentication codes (HMACs) of data are commonly required in services.
These operations are usually implemented in each of the services, which means that you are duplicating this sensitive logic as well as the management of the keys in each of the services.</p>

<p>The Vault Transit engine handles all cryptographic functions for you without storing the resulted data.
You can think of Vault as a <em>cryptographic-as-a-service</em> model in which data is sent, manipulated, and returned back without being stored internally.</p>

<p>Everything is managed internally by Vault, freeing developers to focus on implementing the important business logic.</p>
<div style="page-break-after: always;"/>

<p>The following operations are supported by the Vault extension:</p>
<dl>
<dt><code>encrypt</code></dt>
<dd>
<p>Encrypts a regular string with a Vault key configured in the transit secret engine.</p>
</dd>
<dt><code>decrypt</code></dt>
<dd>
<p>Decrypts the encrypted data with the specified key and returns unencrypted data.</p>
</dd>
<dt><code>rewrap</code></dt>
<dd>
<p>Reencrypts into a new cipher text a cipher text that was obtained from encryption using an old key version with the last key version.</p>
</dd>
<dt><code>sign</code></dt>
<dd>
<p>Signs an input string with the specified key.</p>
</dd>
<dt><code>verifySignature</code></dt>
<dd>
<p>Checks that the signature was obtained from signing the input with the specified key.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128499872648">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="cry_ab" id="idm45128499864216"/><a data-type="indexterm" data-primary="" data-startref="sec_cry" id="idm45128499863240"/>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/rloOa">Vault: Transit Secrets Engine</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="12.4 Generate Database Password as Secret"><div class="sect1" id="idm45128499860200">
<h1>12.4 Generate Database Password as Secret</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128499858984">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="database passwords, generating as secrets" id="dp_gen"/><a data-type="indexterm" data-primary="secrets" data-secondary="generating database passwords" id="sec_gen"/>You want to store the database password securely.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128499855272">
<h2>Solution</h2>

<p>Read the database password as a secret.</p>

<p><a data-type="indexterm" data-primary="Vault" data-secondary="about" id="idm45128499852968"/>The database password is something that needs to be protected and should not be set directly to the configuration file.
The Quarkus Vault extension integrates with persistence configuration to read the database password as a secret from Vault.</p>

<p>Open a shell inside the Vault container created in the previous recipe to configure Vault and add the database password as a secret:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker exec -it dev-vault sh
</code><code class="go">export VAULT_TOKEN=s.ty3QS2uNaxPdiFsSZpCQfjpc </code><a class="co" id="co_application_secrets_management_CO14-1" href="#callout_application_secrets_management_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">vault kv put secret/myapps/vault-service/db password=alex </code><a class="co" id="co_application_secrets_management_CO14-2" href="#callout_application_secrets_management_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO14-1" href="#co_application_secrets_management_CO14-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the token to access</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO14-2" href="#co_application_secrets_management_CO14-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Creates a new secret with a key <code>password</code> and the value <code>alex</code></p></dd>
</dl>

<p>Create a policy that gives read access to the secret:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">cat &lt;&lt;EOF | vault policy write vault-service-policy -</code>
<code class="go">path "secret/data/myapps/vault-service/*" {</code>
<code class="go">  capabilities = ["read"]</code>
<code class="go">}</code>
<code class="go">EOF</code></pre>

<p>The last step is to enable credentials (<code>userpass</code> engine) for accessing secrets from the service:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">vault auth enable userpass
</code><code class="go">vault write auth/userpass/users/alex password=alex \
</code><code class="go">  policies=vault-service-policy </code><a class="co" id="co_application_secrets_management_CO15-1" href="#callout_application_secrets_management_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO15-1" href="#co_application_secrets_management_CO15-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Creates a user with ID <code>alex</code> and password <code>alex</code></p></dd>
</dl>

<p>For this example, the PostgreSQL server is used as database. Start a new Docker instance in a new terminal by running the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">docker run --ulimit memlock=-1:-1 -it --rm=true --memory-swappiness=0 \</code>
<code class="go">  --name postgres-quarkus-hibernate -e POSTGRES_USER=alex \</code>
<code class="go">  -e POSTGRES_PASSWORD=alex -e POSTGRES_DB=mydatabase \</code>
<code class="go">  -p 5432:5432 postgres:10.5</code></pre>

<p>Notice that the password is the same as the one set in the <em>secret/myapps/vault-service/db</em> path.</p>

<p>Register the <code>quarkus-vault</code> and persistence extensions:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension \</code>
<code class="go">  -Dextensions="quarkus-vault, quarkus-hibernate-orm-panache, \</code>
<code class="go">    quarkus-jdbc-postgresql, quarkus-resteasy-jsonb"</code></pre>

<p>The datasource configuration is slightly different than the one shown in <a data-type="xref" href="ch07.xhtml#persistence_chapter">Chapter 7</a>.
Instead of having the password hardcoded in the configuration file, the password is retrieved from Vault as a secret and is used to make the connection.</p>

<p>Apart from Vault configuration parameters such as the URL and the authenticated method (i.e., user/password), you need to define the key/value path inside Vault, where the database configuration is stored.
More specifically, it is the path where the key named <code>password</code> is stored with the database password.
In the following example, to set this information into Vault, you run the command <code>vault kv put secret/myapps/vault-service/db password=alex</code>, but if you have followed this section, you’ve already done this when configuring Vault.</p>

<p>Also, overriding the credentials provider used when establishing the connection 
<span class="keep-together">to the</span> database is required to indicate that the password comes from Vault and 
<span class="keep-together">not as a configuration property.</span>
This is done by using the <code>q⁠u⁠a⁠r⁠k⁠u⁠s⁠.⁠d⁠a⁠t⁠a​s⁠o⁠u⁠r⁠c⁠e⁠.⁠c⁠r⁠e⁠d⁠e⁠n⁠t⁠i⁠a⁠l⁠s⁠-⁠p⁠r⁠o⁠v⁠i⁠d⁠e⁠r</code> property.</p>

<p>Configure the application with the datasource and Vault parameters and override the credentials provider:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.url</code><code class="o">=</code><code class="s">jdbc:postgresql://localhost:5432/mydatabase</code><code>
</code><code class="na">quarkus.datasource.driver</code><code class="o">=</code><code class="s">org.postgresql.Driver</code><code>
</code><code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">alex</code><code>
</code><code class="na">quarkus.datasource.credentials-provider</code><code class="o">=</code><code class="s">mydatabase </code><a class="co" id="co_application_secrets_management_CO16-1" href="#callout_application_secrets_management_CO16-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="err">q</code><code class="err">u</code><code class="err">a</code><code class="err">r</code><code class="err">k</code><code class="err">u</code><code class="err">s</code><code class="err">.</code><code class="err">v</code><code class="err">a</code><code class="err">u</code><code class="err">l</code><code class="err">t</code><code class="err">.</code><code class="err">c</code><code class="err">r</code><code class="err">e</code><code class="err">d</code><code class="err">e</code><code class="err">n</code><code class="err">t</code><code class="err">i</code><code class="err">a</code><code class="err">l</code><code class="err">s</code><code class="err">-</code><code class="err">p</code><code class="err">r</code><code class="err">o</code><code class="err">v</code><code class="err">i</code><code class="err">d</code><code class="err">e</code><code class="err">r</code><code class="err">.</code><code class="err">m</code><code class="err">y</code><code class="err">d</code><code class="err">a</code><code class="err">t</code><code class="err">a</code><code class="err">b</code><code class="err">a</code><code class="err">s</code><code class="err">e</code><code class="err">\</code><code>
  </code><code class="na">.kv-path</code><code class="o">=</code><code class="s">myapps/vault-service/db </code><a class="co" id="co_application_secrets_management_CO16-2" href="#callout_application_secrets_management_CO16-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.url</code><code class="o">=</code><code class="s">http://localhost:8200 </code><a class="co" id="co_application_secrets_management_CO16-3" href="#callout_application_secrets_management_CO16-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.authentication.userpass.username</code><code class="o">=</code><code class="s">alex</code><code>
</code><code class="na">quarkus.vault.authentication.userpass.password</code><code class="o">=</code><code class="s">alex</code><code>
</code><code class="na">quarkus.vault.kv-secret-engine-version</code><code class="o">=</code><code class="s">2</code><code>
</code><code class="na">quarkus.hibernate-orm.database.generation</code><code class="o">=</code><code class="s">drop-and-create</code><code>
</code><code class="na">%dev.quarkus.hibernate-orm.sql-load-script</code><code class="o">=</code><code class="s">import.sql</code><code>
</code><code class="na">%dev.quarkus.hibernate-orm.log.sql</code><code class="o">=</code><code class="s">true</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO16-1" href="#co_application_secrets_management_CO16-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Sets the credentials provider to a custom name (<code>mydatabase</code>)</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO16-2" href="#co_application_secrets_management_CO16-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the key/value path where the password is stored for the <code>mydatabase</code> provider</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO16-3" href="#co_application_secrets_management_CO16-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Configures Vault parameters</p></dd>
</dl>

<p>It is important to note that there is no <code>quarkus.datasource.password</code> property because the password is retrieved from Vault.</p>

<p>At this time, when the Quarkus application is started, the following steps are 
<span class="keep-together">executed</span>:</p>
<ol>
<li>
<p>Service authenticates to the Vault service.</p>
</li>
<li>
<p>Key/Value is retrieved from <code>secret/myapps/vault-service/db</code> path.</p>
</li>
<li>
<p>The value of the key <code>password</code> is used as password credentials for the database.</p>
</li>

</ol>
<div data-type="tip"><h6>Tip</h6>
<p>The key name can be changed from <code>password</code> to any other key name by using the <code>kv-key</code> property: <code>quarkus.vault.credentials-provider.mydatabase.kv-key=pass</code>.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128499854360">
<h2>Discussion</h2>

<p>Vault can generate database credentials dynamically and configure the database instances to use them as credentials instead of having to manually configure the 
<span class="keep-together">credentials</span> and set them in Vault and/or in the service that requires access to the 
<span class="keep-together">database</span>.
This implies that no credentials are hardcoded in any place, as they are requested from Vault.
The generated pair of username and password are subject to Vault’s leasing mechanism, which makes the credentials invalid after a reasonable time.</p>

<p>Take the following steps to configure Vault to generate database credentials 
<span class="keep-together">dynamically</span>:</p>
<ol>
<li>
<p>Enable the database secret engine.</p>
</li>
<li>
<p>Set connection parameters to the database, and set the vendor database (at this time most of SQL and NoSQL databases are supported).</p>
</li>
<li>
<p>Configure a role that maps a name in Vault to an SQL statement to create the database credential:</p>
</li>

</ol>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">vault secrets enable database</code>

<code class="go">cat &lt;&lt;EOF | vault policy write vault-service-policy -</code>
<code class="go">path "database/creds/mydbrole" {</code>
<code class="go">  capabilities = [ "read" ]</code>
<code class="go">}</code>
<code class="go">EOF</code>

<code class="go">vault write database/config/mydb</code>
<code class="go">     plugin_name=postgresql-database-plugin \</code>
<code class="go">     allowed_roles=mydbrole \</code>
<code class="go">     connection_url=postgresql://{{username}}:{{password}}\</code>
<code class="go">          @localhost:5432/mydb?sslmode=disable \</code>
<code class="go">     username=alex \</code>
<code class="go">     password=alex</code>

<code class="go">vault write database/roles/mydbrole \</code>
<code class="go">     db_name=mydb \</code>
<code class="go">     creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD \</code>
<code class="go">                          '{{password}}' VALID UNTIL '{{expiration}}'; \</code>
<code class="go">                          GRANT SELECT,INSERT, UPDATE, DELETE ON ALL \</code>
<code class="go">                          TABLES IN SCHEMA public TO \"{{name}}\"; \</code>
<code class="go">                          GRANT USAGE, SELECT ON ALL SEQUENCES IN \</code>
<code class="go">                          SCHEMA public to \"{{name}}\";" \</code>
<code class="go">     default_ttl="1h" \</code>
<code class="go">     revocation_statements="ALTER ROLE \"{{name}}\" NOLOGIN;" \</code>
<code class="go">     renew_statements="ALTER ROLE \"{{name}}\" VALID UNTIL '{{expiration}}';" \</code>
<code class="go">     max_ttl="24h"</code></pre>

<p>The Vault extension also supports using dynamic database credentials through the <code>database-credentials-role</code> property on the <code>credentials-provider</code>:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.vault.url</code><code class="o">=</code><code class="s">https://localhost:8200</code><code>
</code><code class="na">quarkus.vault.authentication.userpass.username</code><code class="o">=</code><code class="s">alex</code><code>
</code><code class="na">quarkus.vault.authentication.userpass.password</code><code class="o">=</code><code class="s">alex</code><code>

</code><code class="na">quarkus.datasource.driver</code><code class="o">=</code><code class="s">org.postgresql.Driver</code><code>
</code><code class="na">quarkus.datasource.url</code><code class="o">=</code><code class="s">jdbc:postgresql://localhost:6543/mydb</code><code>
</code><code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">postgres</code><code>

</code><code class="na">quarkus.datasource.credentials-provider</code><code class="o">=</code><code class="s">dynamic-ds </code><a class="co" id="co_application_secrets_management_CO17-1" href="#callout_application_secrets_management_CO17-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.datasource.credentials-provider-type</code><code class="o">=</code><code class="s">vault-credentials-provider</code><code>
</code><code class="na">quarkus.vault.credentials-provider.dynamic-ds.database-credentials-role</code><code class="o">=</code><code class="s">\
  mydbrole </code><a class="co" id="co_application_secrets_management_CO17-2" href="#callout_application_secrets_management_CO17-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO17-1" href="#co_application_secrets_management_CO17-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>No password set</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO17-2" href="#co_application_secrets_management_CO17-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Configures dynamic credentials</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128499430344">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="dp_gen" id="idm45128499429176"/><a data-type="indexterm" data-primary="" data-startref="sec_gen" id="idm45128499428200"/>To learn more about dynamic database credentials with Vault, visit the following 
<span class="keep-together">website</span>:</p>

<ul>
<li>
<p><a href="https://oreil.ly/RDaes">Vault: Databases</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="12.5 Authenticating Services Using Vault Kubernetes Auth"><div class="sect1" id="idm45128499424152">
<h1>12.5 Authenticating Services Using Vault Kubernetes Auth</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128499410600">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="secrets" data-secondary="authenticating services using Vault Kubernetes Auth method" id="sec_auth"/><a data-type="indexterm" data-primary="services" data-secondary="authenticating using Vault Kubernetes Auth method" id="ser_auth"/><a data-type="indexterm" data-primary="Vault Kubernetes Auth method" id="vka_ab"/>You want to authenticate services against Vault without using a username/password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128499405832">
<h2>Solution</h2>

<p>Use the Vault Kubernetes Auth method.</p>

<p>So far, you’ve used credentials with the username/password approach to authenticating the Quarkus service against the Vault service.
This method might be good in some circumstances (testing purposes, internal applications, etc.), but notice that you are introducing a new secret (the password) to get more secrets.
One way to fix this problem is by using Kubernetes Secrets to set the Vault password using, for example, the <code>approle</code> authentication method.
Another way is to use the Vault Kubernetes Auth, which makes it a perfect fit for authenticating services deployed in a Kubernetes cluster.</p>

<p>The Vault Kubernetes <code>auth</code> method uses the Kubernetes service account token and a defined role to authenticate against a Vault service.
With this method, Vault does not store the credentials; it uses a trusted third party (the Kubernetes cluster) to validate them.
When the Pod with the service is instantiated, the service account token is mounted inside the container, so it is accessible by the application.
The default mounting point of the secret token is <em>/var/run/secrets/kubernetes.io/serviceaccount/token</em>.</p>

<p>The application then attempts to authenticate using this token by sending it to the Vault server.
After that, Vault makes a call to Kubernetes API to ensure the validity of the token.
If the token is valid, then an internal Vault token is returned to be used in future requests to get secrets.
The process is summarized in <a data-type="xref" href="#vaultk8sauth">Figure 12-1</a>.</p>

<figure><div id="vaultk8sauth" class="figure">
<img src="Images/qucb_1201.png" alt="qucb 1201" width="920" height="532"/>
<h6><span class="label">Figure 12-1. </span>Kubernetes authentication method</h6>
</div></figure>

<p>To configure the Kubernetes auth mode, you need to set two parameters to Vault to connect to Kubernetes API.
The first one is the token to access, and the second one is the certificate authority to validate the communication between Vault and the Kubernetes API.
These values are retrieved from the secret that starts with <code>vault-token</code>.
When Vault was first set up for this example, the value was <code>vault-token-mm5qx</code>.</p>

<p>To get the token and store it in a file, open a terminal window and run the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl get secret vault-token-mm5qx -o jsonpath='{.data.token}' \
</code><code class="go">  | base64 --decode &gt; jwt.txt </code><a class="co" id="co_application_secrets_management_CO18-1" href="#callout_application_secrets_management_CO18-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go"> </code><a class="co" id="co_application_secrets_management_CO18-2" href="#callout_application_secrets_management_CO18-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">cat jwt.txt
</code><code class="go">eyJhbGciOiJSUzI1NiIsImtpZCI6Inp0WWZBcl8weW1SaTI1bjRNYVNHNmtXOUhCWDV\
</code><code class="go">yczhYandVYkVETktzRHMifQ.</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO18-1" href="#co_application_secrets_management_CO18-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Substitute the secret name to your secret name starting with <code>vault-token</code></p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO18-2" href="#co_application_secrets_management_CO18-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Secrets are stored in Base64, so they need to be decoded</p></dd>
</dl>

<p>To get the certificate authority and store it in a file, run the following in the terminal:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl get secret vault-token-mm5qx -o jsonpath="{.data['ca\.crt']}" \
</code><code class="go">  | base64 --decode &gt; ca.crt </code><a class="co" id="co_application_secrets_management_CO19-1" href="#callout_application_secrets_management_CO19-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go"> </code><a class="co" id="co_application_secrets_management_CO19-2" href="#callout_application_secrets_management_CO19-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">cat ca.crt
</code><code class="go">
</code><code class="go">-----BEGIN CERTIFICATE-----
</code><code class="go">MIIC5zCCAc+gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p
</code><code class="go">-----END CERTIFICATE-----</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO19-1" href="#co_application_secrets_management_CO19-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Pod is named <code>vault-0</code></p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO19-2" href="#co_application_secrets_management_CO19-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>A <code>vault-token</code> is set as a secret</p></dd>
</dl>

<p>Before deploying the application, you need to enable Kubernetes <code>auth</code> method, 
<span class="keep-together">configure</span> it, and insert some secrets to test it.</p>

<p>Expose the Vault service out of the Kubernetes cluster so that it can be configured from your local machine.
Open a new terminal window and run the command to forward the traffic from <code>localhost:8200</code> into the Vault instance running inside the Kubernetes cluster:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl port-forward svc/vault 8200:8200</code></pre>

<p>Get back to the terminal window where you run the commands to get the token and the certificate authority, and run the following commands to insert a secret:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">export VAULT_TOKEN=root </code><a class="co" id="co_application_secrets_management_CO20-1" href="#callout_application_secrets_management_CO20-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">export VAULT_ADDR='http://localhost:8200'
</code><code class="go">
</code><code class="go">cat &lt;&lt;EOF | vault policy write vault-service-policy - </code><a class="co" id="co_application_secrets_management_CO20-2" href="#callout_application_secrets_management_CO20-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">path "secret/data/myapps/vault-service/*" {
</code><code class="go">  capabilities = ["read"]
</code><code class="go">}
</code><code class="go">EOF
</code><code class="go">
</code><code class="go">vault kv put secret/myapps/vault-service/config foo=secretbar </code><a class="co" id="co_application_secrets_management_CO20-3" href="#callout_application_secrets_management_CO20-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO20-1" href="#co_application_secrets_management_CO20-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Configure Vault connection parameters</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO20-2" href="#co_application_secrets_management_CO20-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Creates a policy called <code>vault-service-policy</code> to <code>myapps/vault-service/*</code> secrets</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO20-3" href="#co_application_secrets_management_CO20-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets a new secret</p></dd>
</dl>

<p>The last step is enabling the Kubernetes <code>auth</code> method and configuring it to validate the token using the Kubernetes API.</p>
<div style="page-break-after: always;"/>

<p>Execute the following commands:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">vault auth enable kubernetes </code><a class="co" id="co_application_secrets_management_CO21-1" href="#callout_application_secrets_management_CO21-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">vault write auth/kubernetes/config \ </code><a class="co" id="co_application_secrets_management_CO21-2" href="#callout_application_secrets_management_CO21-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="go">
</code><code class="go">    token_reviewer_jwt=@jwt.txt \ </code><a class="co" id="co_application_secrets_management_CO21-3" href="#callout_application_secrets_management_CO21-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="go">
</code><code class="go">    kubernetes_host=https://kubernetes.default.svc \ </code><a class="co" id="co_application_secrets_management_CO21-4" href="#callout_application_secrets_management_CO21-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="go">
</code><code class="go">    kubernetes_ca_cert=@ca.crt </code><a class="co" id="co_application_secrets_management_CO21-5" href="#callout_application_secrets_management_CO21-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="go">
</code><code class="go">
</code><code class="go">vault write auth/kubernetes/role/example \ </code><a class="co" id="co_application_secrets_management_CO21-6" href="#callout_application_secrets_management_CO21-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code class="go">
</code><code class="go">        bound_service_account_names=vault \ </code><a class="co" id="co_application_secrets_management_CO21-7" href="#callout_application_secrets_management_CO21-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code class="go">
</code><code class="go">        bound_service_account_namespaces=default \ </code><a class="co" id="co_application_secrets_management_CO21-8" href="#callout_application_secrets_management_CO21-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code class="go">
</code><code class="go">        policies=vault-service-policy </code><a class="co" id="co_application_secrets_management_CO21-9" href="#callout_application_secrets_management_CO21-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO21-1" href="#co_application_secrets_management_CO21-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Enables Kubernetes <code>auth</code> method</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-2" href="#co_application_secrets_management_CO21-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Configures the <code>auth</code> method</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-3" href="#co_application_secrets_management_CO21-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the token file retrieved in the previous step</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-4" href="#co_application_secrets_management_CO21-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets the Kubernetes API host</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-5" href="#co_application_secrets_management_CO21-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Sets the CA file retrieved in the previous step</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-6" href="#co_application_secrets_management_CO21-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Creates a new role (<code>example</code>) to authenticate from the application</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-7" href="#co_application_secrets_management_CO21-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>Sets the service account name that in our deployment is <code>vault</code></p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-8" href="#co_application_secrets_management_CO21-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>Sets the namespace where services are running</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO21-9" href="#co_application_secrets_management_CO21-9"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt>
<dd><p>Binds the user authenticating with this method to the created policy</p></dd>
</dl>

<p>Let’s develop a Quarkus service that authenticates using the Vault Kubernetes <code>auth</code> method and get the secret named <code>foo</code>.</p>

<p>Add the Vault and Kubernetes extensions:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw quarkus:add-extension -Dextensions="quarkus-vault, quarkus-kubernetes"</code></pre>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@ConfigProperty</code><code class="o">(</code><code class="n">name</code> <code class="o">=</code> <code class="s">"foo"</code><code class="o">)</code>
<code class="n">String</code> <code class="n">foo</code><code class="o">;</code>

<code class="nd">@GET</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{</code>
    <code class="k">return</code> <code class="n">foo</code><code class="o">;</code>
<code class="o">}</code></pre>
<div style="page-break-after: always;"/>

<p>Configure the application to use the Kubernetes Vault <code>auth</code> method and the 
<span class="keep-together">Kubernetes</span> extension to generate the correct deployment file:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.vault.url</code><code class="o">=</code><code class="s">http://vault:8200 </code><a class="co" id="co_application_secrets_management_CO22-1" href="#callout_application_secrets_management_CO22-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.vault.kv-secret-engine-version</code><code class="o">=</code><code class="s">2</code><code>
</code><code class="na">quarkus.vault.secret-config-kv-path</code><code class="o">=</code><code class="s">myapps/vault-service/config</code><code>

</code><code class="na">quarkus.vault.authentication.kubernetes.role</code><code class="o">=</code><code class="s">example </code><a class="co" id="co_application_secrets_management_CO22-2" href="#callout_application_secrets_management_CO22-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">kubernetes.service-account</code><code class="o">=</code><code class="s">vault </code><a class="co" id="co_application_secrets_management_CO22-3" href="#callout_application_secrets_management_CO22-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>

</code><code class="na">kubernetes.group</code><code class="o">=</code><code class="s">quarkus </code><a class="co" id="co_application_secrets_management_CO22-4" href="#callout_application_secrets_management_CO22-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="na">kubernetes.name</code><code class="o">=</code><code class="s">greeting-app</code><code>
</code><code class="na">kubernetes.version</code><code class="o">=</code><code class="s">latest</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO22-1" href="#co_application_secrets_management_CO22-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Configures Vault location and secrets</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO22-2" href="#co_application_secrets_management_CO22-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Sets the <code>example</code> role to be used by the user (created in the previous step)</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO22-3" href="#co_application_secrets_management_CO22-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Sets the <code>serviceaccount</code> name to set in the generated deployment file</p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO22-4" href="#co_application_secrets_management_CO22-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Sets the group name of Docker image</p></dd>
</dl>

<p>Notice that the <code>quarkus.vault.authentication.kubernetes.jwt-token-path</code> property is not set.
The reason is that the default value (<code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>) works perfectly with the defaults.
If the secret was mounted on a different path, then this property should be set to the new location.</p>

<p>To deploy the application, open a new terminal window, package the application, 
<span class="keep-together">create</span> the Docker container, and apply the generated Kubernetes resources:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">./mvnw clean package -DskipTests</code>

<code class="go">docker build -f src/main/docker/Dockerfile.jvm \</code>
<code class="go">  -t quarkus/greeting-started-vault-kubernetes-auth:1.0-SNAPSHOT .</code>
<code class="go">kubectl apply -f target/kubernetes/kubernetes.yml</code>

<code class="go">kubectl patch svc greeting-app --type='json' \</code>
<code class="go">  -p '[{"op":"replace","path":"/spec/type","value":"NodePort"}]'</code>
<code class="go">curl $(minikube service greeting-app --url)/hello</code></pre>

<p>When the Pod is deployed, the application is authenticated with Vault, and Vault 
<span class="keep-together">validates</span> that the token is valid using the Kubernetes API.
The application is then authenticated and can get the secrets from the configured path.</p>

<p>The big difference between this example and the previous ones is that in this case no secret like the Vault password is set, meaning that the secrets can be accessed securely but without having to add any new secret.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128499404920">
<h2>Discussion</h2>

<p>Our intention isn’t to show how to deploy Vault in Kubernetes for production purposes.
For this reason, a deployment file is provided to deploy a Vault service with the minimal requirements to run this example.</p>

<p>This deployment file is located at <em>src/main/kubernetes/vault-dev-deployment.yaml</em> and provides the following elements:</p>

<ul>
<li>
<p>Vault with <code>dev</code> mode and root token set to <code>root</code>.</p>
</li>
<li>
<p>Exposes Vault at port 8200.</p>
</li>
<li>
<p><code>ServiceAccount</code> with the name set to <code>vault</code>.</p>
</li>
<li>
<p><code>ClusterRoleBinding</code> and <code>ClusterRole</code> bound to <code>vault</code>.</p>
</li>
<li>
<p>All resources applied to the <code>default</code> namespace.</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="deploying" data-secondary="Vault" id="idm45128498967912"/><a data-type="indexterm" data-primary="Vault" data-secondary="deploying" id="idm45128498966936"/>Deploy the Vault service by running the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session"><code class="go">kubectl apply -f src/main/kubernetes/vault-dev-deployment.yaml
</code><code class="go">
</code><code class="go">kubectl get pods </code><a class="co" id="co_application_secrets_management_CO23-1" href="#callout_application_secrets_management_CO23-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="go">
</code><code class="go">NAME      READY   STATUS    RESTARTS   AGE
</code><code class="go">vault-0   1/1     Running   0          44s
</code><code class="go">
</code><code class="go">kubectl get secrets
</code><code class="go">NAME                  TYPE                                  DATA   AGE
</code><code class="go">default-token-zdw8r   kubernetes.io/service-account-token   3      2d
</code><code class="go">greeting-security     Opaque                                1      3h9m
</code><code class="go">vault-token-mm5qx     kubernetes.io/service-account-token   3      8s </code><a class="co" id="co_application_secrets_management_CO23-2" href="#callout_application_secrets_management_CO23-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_application_secrets_management_CO23-1" href="#co_application_secrets_management_CO23-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Pod is named <code>vault-0</code></p></dd>
<dt><a class="co" id="callout_application_secrets_management_CO23-2" href="#co_application_secrets_management_CO23-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>A <code>vault-token</code> is set as a secret</p></dd>
</dl>

<p>To configure Vault, you need to install the Vault CLI locally on your computer.
The Vault CLI is a single file that can be downloaded from <a href="https://oreil.ly/fTB0x">Vault</a> and set in your <code>PATH</code> variable.</p>

<p>Assuming you’ve got the Vault client installed locally and available in your PATH variable, you can configure Vault.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128498915672">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="sec_ch" id="idm45128498898168"/><a data-type="indexterm" data-primary="" data-startref="sec_auth" id="idm45128498897256"/><a data-type="indexterm" data-primary="" data-startref="ser_auth" id="idm45128498896312"/><a data-type="indexterm" data-primary="" data-startref="vka_ab" id="idm45128498895368"/>To learn more about Vault Kubernetes <code>auth</code> method, visit the following websites:</p>

<ul class="less-space-list">
<li>
<p><a href="https://oreil.ly/AV3D_">Vault: Kubernetes Auth Method</a></p>
</li>
<li>
<p><a href="https://oreil.ly/WGbUx">Vault Agent with Kubernetes</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div>



  </body></html>