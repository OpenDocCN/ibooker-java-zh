<html><head></head><body><section data-pdf-bookmark="Chapter 8. HTTP with Reactive in Mind" data-type="chapter" epub:type="chapter"><div class="chapter" id="http">&#13;
<h1><span class="label">Chapter 8. </span>HTTP with Reactive in Mind</h1>&#13;
&#13;
&#13;
<p><a data-primary="HTTP" data-type="indexterm" id="ix_http-adoc0"/>Even when building a reactive system, HTTP is unavoidable.&#13;
HTTP is a prevalent protocol, and REST, for instance, is a well-known approach to designing services and APIs. The problem with HTTP, as mentioned in <a data-type="xref" href="ch04.html#reactive-systems">Chapter 4</a>, is the request/response interaction scheme that leads to undesirable time coupling.&#13;
Also, to implement space decoupling, you often need proxies that would route the requests or advanced service discovery and load-balancing mechanism.</p>&#13;
&#13;
<p>But let’s face it: we need to be pragmatic, and HTTP has plenty of great features.&#13;
We recommend using HTTP at the edge of your system (the places interacting with external entities), as shown in <a data-type="xref" href="#image:architecture-http">Figure 8-1</a>&#13;
For example, HTTP is often used on the front tier to expose an API easily consumable by other external services.&#13;
Besides, we often use HTTP at the various integration points with other external services, such as consuming services exposed using a REST API.</p>&#13;
&#13;
<p>Integrating HTTP should not prevent or limit the responsiveness of the reactive system you are building.&#13;
As a consequence, we need to implement this integration carefully.&#13;
It’s not rare to see a system using a so-called asynchronous HTTP client, which can do more harm than provide benefits as it may rely on a hidden thread pool.</p>&#13;
&#13;
<figure><div class="figure" id="image:architecture-http">&#13;
<img alt="Using HTTP at the edge of a reactive system" src="assets/rsij_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>Using HTTP at the edge of a reactive system</h6>&#13;
</div></figure>&#13;
&#13;
<p>This chapter explores the features Quarkus offers to expose HTTP endpoints and the ways we can implement these endpoints.&#13;
In <a data-type="xref" href="#image:architecture-http">Figure 8-1</a>, this part is circled with a dotted line; the right side, HTTP service consumption, is covered in <a data-type="xref" href="ch12.html#http-client">Chapter 12</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Journey of an HTTP Request" data-type="sect1"><div class="sect1" id="idm45358825158176">&#13;
<h1>The Journey of an HTTP Request</h1>&#13;
&#13;
<p><a data-primary="HTTP" data-secondary="request-handling basics" data-type="indexterm" id="idm45358825156672"/><a data-primary="Quarkus" data-secondary="HTTP request handling" data-type="indexterm" id="idm45358825155696"/>To understand the benefits of using Quarkus to handle HTTP in a reactive way, we need to look under the hood.&#13;
As shown in <a data-type="xref" href="ch06.html#quarkus-reactive">Chapter 6</a>, Quarkus is based on a reactive engine, so every facet of Quarkus benefits from this engine to provide asynchronous and nonblocking features.&#13;
Naturally, that also includes HTTP.&#13;
However, while we implemented HTTP endpoints in the previous Quarkus applications, the code was not benefiting from all the features that engine provides.&#13;
Let’s see how Quarkus handles HTTP requests and where we can unleash the power of the reactive engine.</p>&#13;
&#13;
<p>To handle HTTP requests, you need an HTTP server.&#13;
This server listens on a specific port (8080, in the case of Quarkus) and waits for incoming connections.&#13;
When the server receives a new connection, it reads the frame and assembles the HTTP request.&#13;
Typically, the server parses the HTTP method (for example, <code>GET</code> or <code>POST</code>), the invoked path, the body, and so on.&#13;
Several frames can compose an HTTP request, and large bodies are split among multiple frames.</p>&#13;
&#13;
<p>Once the HTTP request is assembled, Quarkus determines how to handle it.&#13;
It checks for <em>interceptors</em> (to handle security or logging concerns) and looks for the endpoint that can process the request.&#13;
This lookup is based on the path, but can also include content type negotiation.&#13;
Once the endpoint method is found, Quarkus invokes the method, and it’s up to the method to process the request.</p>&#13;
&#13;
<p>Let’s imagine that we call a synchronous method and that the result of the method is the payload of the HTTP response.&#13;
Quarkus captures that result and builds an HTTP response.&#13;
It then writes the response into the appropriate HTTP connection, encoding content accordingly.</p>&#13;
&#13;
<p>So far, so good—but not very reactive, right?&#13;
One of the essential pieces in this exchange is the HTTP service.&#13;
The HTTP server used by Quarkus is nonblocking, highly efficient, and concurrent.&#13;
<a data-primary="threads" data-secondary="HTTP requests and" data-type="indexterm" id="ix_http-adoc1"/>It’s powered by Vert.x and handles the HTTP interaction by using the I/O thread.&#13;
So, it follows the reactive approach we explained previously in <a data-type="xref" href="ch04.html#image:reactive-systems">Figure 4-1</a> and can handle multiple HTTP connections using few threads.</p>&#13;
&#13;
<p>Once this HTTP server receives a request, the server delegates that request to Quarkus to handle the lookup.&#13;
This <em>routing</em> layer builds the chain of responsibility that handles the request (typically the interceptors and the endpoint) and invokes it.&#13;
In the case of a JAX-RS endpoint, the routing layer would delegate the lookup to the JAX-RS framework and wait for the JAX-RS response to be computed.</p>&#13;
&#13;
<p>But, wait—are we still on the I/O thread?&#13;
If so, how can we prevent the user endpoint from blocking the I/O thread inadvertently?&#13;
Fortunately, Quarkus has a routing layer that decides how the request must be handled (<a data-type="xref" href="#image:routing">Figure 8-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="image:routing">&#13;
<img alt="Quarkus Routing Layer" src="assets/rsij_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>Quarkus routing layer</h6>&#13;
</div></figure>&#13;
&#13;
<p>In the previous Quarkus application we used in <a data-type="xref" href="ch02.html#quarkus">Chapter 2</a>, the requests were always dispatched on a worker thread, avoiding any risk of blocking.&#13;
It was not ideal in terms of reactive principles.&#13;
Let’s see what Quarkus can do to improve this situation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Say Hello to RESTEasy Reactive!" data-type="sect1"><div class="sect1" id="idm45358825157552">&#13;
<h1>Say Hello to RESTEasy Reactive!</h1>&#13;
&#13;
<p><a data-primary="HTTP" data-secondary="RESTEasy Reactive and" data-type="indexterm" id="ix_http-adoc2"/><a data-primary="Quarkus" data-secondary="RESTEasy Reactive" data-type="indexterm" id="ix_http-adoc3"/><a data-primary="RESTEasy Reactive" data-secondary="basics" data-type="indexterm" id="ix_http-adoc4"/>In the previous application we used in <a data-type="xref" href="ch02.html#quarkus">Chapter 2</a>, we relied on <em>classic</em> RESTEasy, which follows the old-school model of associating a thread to each request.&#13;
However, as we have seen before, that model does not scale and lacks responsiveness.&#13;
Fortunately, Quarkus offers an alternative: <em>RESTEasy Reactive</em>.&#13;
It’s the same development model, except that this variant is aware of the reactive engine and relies on it.</p>&#13;
&#13;
<p>Let’s have a look and experiment with the features offered by RESTEasy Reactive.&#13;
Go to <a href="https://code.quarkus.io"><em class="hyperlink">https://code.quarkus.io</em></a> and select the following extensions:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>RESTEasy Reactive</p>&#13;
</li>&#13;
<li>&#13;
<p>RESTEasy Reactive Jackson</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Then, click “Generate your application” and unzip it.</p>&#13;
&#13;
<p>The reactive version is quite similar to the classic RESTEasy version.&#13;
<a data-type="xref" href="#rr::resource">Example 8-1</a> shows the generated HTTP endpoint.&#13;
You may notice the introduction of the <code>@NonBlocking</code> annotation.&#13;
This is one of the essential differences with classic RESTEasy; RESTEasy Reactive can dispatch the requests on the I/O thread.</p>&#13;
<div data-type="example" id="rr::resource">&#13;
<h5><span class="label">Example 8-1. </span>An HTTP endpoint using RESTEasy Reactive</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.common.annotation.NonBlocking</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Produces</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/hello-resteasy-reactive"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">ReactiveGreetingResource</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>&#13;
    <code class="nd">@NonBlocking</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="s">"Hello RESTEasy Reactive"</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Let’s run this application using <code>mvn quarkus:dev</code>, and point your browser to <a href="http://localhost:8080/hello-resteasy-reactive"><em class="hyperlink">http://localhost:8080/hello-resteasy-reactive</em></a>.&#13;
You should see this:</p>&#13;
&#13;
<pre data-type="programlisting">Hello RESTEasy Reactive</pre>&#13;
&#13;
<p>OK, well, that’s nothing fancy, and not very attractive so far.</p>&#13;
&#13;
<p>First, let’s enhance our endpoint and, in addition to Hello RESTEasy Reactive, add the name of the thread handling the request (<a data-type="xref" href="#rr::resource-thread">Example 8-2</a>).</p>&#13;
<div data-type="example" id="rr::resource-thread">&#13;
<h5><span class="label">Example 8-2. </span>Requests are processed on the I/O thread</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>&#13;
<code class="nd">@NonBlocking</code>&#13;
<code class="kd">public</code> <code class="n">String</code> <code class="nf">hello</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="s">"Hello RESTEasy Reactive from "</code> <code class="o">+</code> <code class="n">Thread</code><code class="o">.</code><code class="na">currentThread</code><code class="o">().</code><code class="na">getName</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Because Quarkus runs in dev mode, there is no need to restart the application, as it will auto-update itself.&#13;
Refresh your browser and you should see something like <a data-type="xref" href="#output-indicating-thread-8-3">Example 8-3</a>.</p>&#13;
<div data-type="example" id="output-indicating-thread-8-3">&#13;
<h5><span class="label">Example 8-3. </span>Output of the application indicating the thread used for the processing</h5>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">Hello RESTEasy Reactive vert.x-eventloop-thread-5</pre></div>&#13;
&#13;
<p>The endpoint method is invoked from the I/O thread!<sup><a data-type="noteref" href="ch08.html#idm45358825012512" id="idm45358825012512-marker">1</a></sup>&#13;
Much more reactive, but…wait…how do we handle blocking logic now?&#13;
With RESTEasy Reactive, you can use the <code>@NonBlocking</code> and <code>@Blocking</code> annotations to indicate on which thread you want the request to be handled.<sup><a data-type="noteref" href="ch08.html#idm45358825016128" id="idm45358825016128-marker">2</a></sup>&#13;
Let’s illustrate this.&#13;
Create another endpoint method with the same code as the <code>hello</code> method, but target a different path and without the &#13;
<span class="keep-together"><code>@NonBlocking</code></span> annotation, as illustrated in <a data-type="xref" href="#rr::resource-blocking">Example 8-4</a>.</p>&#13;
<div data-type="example" id="rr::resource-blocking">&#13;
<h5><span class="label">Example 8-4. </span>Requests are processed on a worker thread when <code>@Blocking</code> is used</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/blocking"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">String</code> <code class="nf">helloBlocking</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="s">"Hello RESTEasy Reactive from "</code> <code class="o">+</code> <code class="n">Thread</code><code class="o">.</code><code class="na">currentThread</code><code class="o">().</code><code class="na">getName</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Refresh your browser again, and voilà:</p>&#13;
&#13;
<pre data-type="programlisting">Hello RESTEasy Reactive executor-thread-198</pre>&#13;
<div data-type="caution"><h1>What Happens If I Block the I/O Thread Inadvertently?</h1>&#13;
<p>Quarkus will warn you if you attempt to block an I/O thread for too long or if you try to execute a blocking operation from an I/O thread.</p>&#13;
</div>&#13;
&#13;
<p>RESTEasy Reactive proposes a set of defaults to avoid having to use the &#13;
<span class="keep-together"><code>@NonBlocking</code></span> annotation:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Method returning an object, such as <code>String</code> in the previous example, is executed on a worker thread, except if the <code>@NonBlocking</code> annotation is used. In this case, the method uses an I/O thread.</p>&#13;
</li>&#13;
<li>&#13;
<p>Method returning <code>Uni</code> is executed on an I/O thread, except if the method is annotated with <code>@Blocking</code>. In this case, the method uses a worker thread.</p>&#13;
</li>&#13;
<li>&#13;
<p>Method returning <code>Multi</code> is executed on an I/O thread, except if the method is annotated with <code>@Blocking</code>. In this case, the method uses a worker thread.<a data-startref="ix_http-adoc4" data-type="indexterm" id="idm45358824898976"/><a data-startref="ix_http-adoc3" data-type="indexterm" id="idm45358824898272"/><a data-startref="ix_http-adoc2" data-type="indexterm" id="idm45358824897600"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What’s the Benefit?" data-type="sect1"><div class="sect1" id="idm45358825139584">&#13;
<h1>What’s the Benefit?</h1>&#13;
&#13;
<p><a data-primary="HTTP" data-secondary="RESTEasy Reactive benefits" data-type="indexterm" id="ix_http-adoc5"/><a data-primary="RESTEasy Reactive" data-secondary="benefits of" data-type="indexterm" id="ix_http-adoc6"/><a data-primary="RESTEasy Reactive" data-secondary="classic RESTEasy versus" data-type="indexterm" id="ix_http-adoc7"/>By dispatching the request on the I/O thread, you are allowing the application to handle the request in a reactive manner.&#13;
You are not only embracing the reactive principles, but also increasing the throughput of your application.</p>&#13;
&#13;
<p>Let’s have a deeper look at the throughput difference.&#13;
We will compare <em>classic</em> and <em>reactive</em> RESTEasy by using <a href="https://oreil.ly/kkvBU">wrk</a>.&#13;
This benchmark is far from being irreproachable (we run everything on the same machine); it’s there just to illustrate the benefits.&#13;
Also note that the result may differ from machine to machine.&#13;
The benchmark is just about calling a <em>hello</em> endpoint concurrently and measuring the response time.&#13;
In <em>chapter-8/simple-benchmark/classic</em>, you get the version using RESTEasy <em>classic</em>.&#13;
In <em>chapter-8/simple-benchmark/reactive</em>, you get the RESTEasy <em>reactive</em> variant.</p>&#13;
&#13;
<p>First, go into <em>chapter-8/simple-benchmark/classic</em>, build the application using <code>mvn package</code>, and run it using <em>java -jar target/quarkus-app/quarkus-run.jar</em>.&#13;
Once the application is started in another terminal, run <a data-type="xref" href="#usewrk-8-5">Example 8-5</a>.</p>&#13;
<div data-type="example" id="usewrk-8-5">&#13;
<h5><span class="label">Example 8-5. </span>Use <code>wrk</code> to stress the application endpoint</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; wrk -t <code class="m">10</code> -c50 -d40s http://localhost:8080/hello&#13;
Running 40s <code class="nb">test</code> @ http://localhost:8080/hello</pre></div>&#13;
&#13;
<p>This command hammers the <em>hello</em> endpoint for 40 seconds, using 10 threads and 50 connections. This is a simple test, but it will give us an idea of the benefits. You should get a report with the result in the terminal.&#13;
For us, we got the result in <a data-type="xref" href="#benchmark-8-6">Example 8-6</a>.</p>&#13;
<div data-type="example" id="benchmark-8-6">&#13;
<h5><span class="label">Example 8-6. </span>Benchmark result</h5>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">  Thread Stats   Avg      Stdev     Max   +/- Stdev&#13;
    Latency    49.35ms   83.26ms 643.82ms   84.52%&#13;
    Req/Sec     2.97k     1.81k   10.66k    64.59%&#13;
  1167359 requests in 40.07s, 92.40MB read&#13;
Requests/sec:  29132.34&#13;
Transfer/sec:      2.31MB</pre></div>&#13;
&#13;
<p>Close the application, and build and run the version using RESTEasy Reactive, as shown in <a data-type="xref" href="#buildrun-8-7">Example 8-7</a>.</p>&#13;
<div data-type="example" id="buildrun-8-7">&#13;
<h5><span class="label">Example 8-7. </span>Build and run a reactive application</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; <code class="nb">cd </code>chapter-8/simple-benchmark/reactive&#13;
&gt; mvn package&#13;
&gt; java -jar target/quarkus-app/quarkus-run.jar</pre></div>&#13;
&#13;
<p>Run the same <code>wrk</code> command in another terminal (<a data-type="xref" href="#usewrk-8-8">Example 8-8</a>).</p>&#13;
<div data-type="example" id="usewrk-8-8">&#13;
<h5><span class="label">Example 8-8. </span>Use <code>wrk</code> to stress the application endpoint</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; wrk -t <code class="m">10</code> -c50 -d40s http://localhost:8080/hello&#13;
Running 40s <code class="nb">test</code> @ http://localhost:8080/hello&#13;
  <code class="m">10</code> threads and <code class="m">50</code> connections&#13;
  Thread Stats   Avg      Stdev     Max   +/- Stdev&#13;
    Latency   600.42us  357.14us  26.17ms   98.24%&#13;
    Req/Sec     8.44k   606.47    15.90k    93.71%&#13;
  <code class="m">3364365</code> requests in 40.10s, 221.39MB <code class="nb">read</code>&#13;
Requests/sec:  83895.54&#13;
Transfer/sec:      5.52MB</pre></div>&#13;
&#13;
<p>Now, let’s compare the number of requests per second:&#13;
29,000 for classic RESTEasy versus 84,000 for RESTEasy Reactive.&#13;
RESTEasy Reactive provides almost three times more throughput.</p>&#13;
&#13;
<p>So far, we compared a reactive framework against a blocking one.&#13;
But what about the <code>@Blocking</code> annotation, which instructs Quarkus to call the endpoint with a worker thread?&#13;
Would <code>@Blocking</code> reduce the performance gain?&#13;
Well, let’s test it.&#13;
In <em>chapter-8/simple-benchmark/reactive-blocking</em>, a variant of the application uses RESTEasy Reactive but without the <code>@NonBlocking</code> annotation.&#13;
So, it invokes the method on a worker thread.&#13;
Let’s run our benchmark against that version, as shown in <a data-type="xref" href="#build-and-run-reactive-blocking">Example 8-9</a>.</p>&#13;
<div data-type="example" id="build-and-run-reactive-blocking">&#13;
<h5><span class="label">Example 8-9. </span>Build and run reactive blocking applications</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; <code class="nb">cd </code>chapter-8/simple-benchmark/reactive-blocking&#13;
&gt; mvn package&#13;
&gt; java -jar target/quarkus-app/quarkus-run.jar</pre></div>&#13;
&#13;
<p>In another terminal, run the <code>wrk</code> command (<a data-type="xref" href="#stress-8-10">Example 8-10</a>).</p>&#13;
<div data-type="example" id="stress-8-10">&#13;
<h5><span class="label">Example 8-10. </span>Stress the application endpoint by using <code>wrk</code></h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; wrk -t <code class="m">10</code> -c50 -d40s http://localhost:8080/hello&#13;
Running 40s <code class="nb">test</code> @ http://localhost:8080/hello&#13;
  <code class="m">10</code> threads and <code class="m">50</code> connections&#13;
  Thread Stats   Avg      Stdev     Max   +/- Stdev&#13;
    Latency    35.99ms   66.23ms 783.62ms   85.87%&#13;
    Req/Sec     5.22k     3.53k   22.22k    71.81%&#13;
  <code class="m">2016035</code> requests in 40.05s, 132.66MB <code class="nb">read</code>&#13;
Requests/sec:  50339.41&#13;
Transfer/sec:      3.31MB</pre></div>&#13;
&#13;
<p>Even when using a worker thread, the application serves 50,000 requests per second.&#13;
That’s more than 1.5 times the throughput of RESTEasy classic.</p>&#13;
&#13;
<p>RESTEasy Reactive offers a solid and highly concurrent alternative to the traditional one-thread-per-request approach.&#13;
And, thanks to the <code>@Blocking</code> and <code>@NonBlocking</code> annotations, you can even use it when dealing with asynchronous and synchronous logic.&#13;
At the end of this chapter, you will see how RESTEasy Reactive produces a reactive score of your endpoint.<a data-startref="ix_http-adoc7" data-type="indexterm" id="idm45358824735504"/>&#13;
Next, we will look at this integration because returning Hello is nice, but it’s rarely enough.<a data-startref="ix_http-adoc6" data-type="indexterm" id="idm45358824734624"/><a data-startref="ix_http-adoc5" data-type="indexterm" id="idm45358824733952"/><a data-startref="ix_http-adoc1" data-type="indexterm" id="idm45358824733280"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Asynchronous Endpoints Returning Uni" data-type="sect1"><div class="sect1" id="idm45358824896544">&#13;
<h1>Asynchronous Endpoints Returning Uni</h1>&#13;
&#13;
<p><a data-primary="HTTP" data-secondary="asynchronous endpoints returning Uni" data-type="indexterm" id="ix_http-adoc8"/><a data-primary="Uni class (Mutiny)" data-secondary="asynchronous endpoints returning Uni instance" data-type="indexterm" id="ix_http-adoc9"/>One way to avoid the temptation to write blocking code is to design your HTTP endpoint method to return a <code>Uni</code> instance.&#13;
<code>Uni</code> represents an asynchronous computation that may not have produced a result yet.&#13;
When an endpoint returns a <code>Uni</code> instance, Quarkus subscribes to it, and when the <code>Uni</code> emits the result, it writes this result into the HTTP response.&#13;
If, unfortunately, the <code>Uni</code> emits a failure, the HTTP response conveys that failure as an HTTP internal server error, bad request, or not found error, depending on the failure.&#13;
While <em>waiting</em> for the outcome of the <code>Uni</code>, the thread can be used to handle other requests.</p>&#13;
&#13;
<p>There’s no need to use <code>@NonBlocking</code> when returning a <code>Uni</code>.&#13;
RESTEasy Reactive recognizes it and automatically considers it nonblocking. Let’s see how this works in practice.&#13;
In this example, we will use the Vert.x filesystem asynchronous API.&#13;
Of course, Quarkus offers other more convenient ways to serve files, but this is just to illustrate the purpose.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You can find the related code in the <em>chapter-8/mutiny-integration-examples</em> directory.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="Vert.x" data-secondary="managed instance" data-type="indexterm" id="idm45358824754176"/>As we said in <a data-type="xref" href="ch06.html#quarkus-reactive">Chapter 6</a>, Quarkus is based on Vert.x.&#13;
If you add the <code>quarkus-vertx</code> extension, you get access to the <em>managed</em> Vert.x instance, as shown in <a data-type="xref" href="#inject-vertx-8-11">Example 8-11</a>.</p>&#13;
<div data-type="example" id="inject-vertx-8-11">&#13;
<h5><span class="label">Example 8-11. </span>Inject the Vert.x instance</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Inject</code> <code class="n">Vertx</code> <code class="n">vertx</code><code class="o">;</code></pre></div>&#13;
&#13;
<p>Be sure to import <code>io.vertx.mutiny.core.Vertx</code>.&#13;
Note that we inject the Mutiny variant of Vert.x.&#13;
This variant exposes all the Vert.x API using Mutiny, which is convenient in Quarkus.&#13;
So, reading a file can be done as in <a data-type="xref" href="#rr::fs">Example 8-12</a>.</p>&#13;
<div data-type="example" id="rr::fs">&#13;
<h5><span class="label">Example 8-12. </span>Read a file with the Vert.x filesystem API</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">uni</code> <code class="o">=</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">readFile</code><code class="o">(</code><code class="n">path</code><code class="o">)</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">buffer</code> <code class="o">-&gt;</code> <code class="n">buffer</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">));</code></pre></div>&#13;
&#13;
<p>Accessing the filesystem is, in most cases, a blocking operation.&#13;
However, thanks to the Vert.x API, we get a nonblocking variant, already providing a <code>Uni</code> instance!&#13;
But it’s a <code>Uni&lt;Buffer&gt;</code>, and to get <code>String</code>, we need to transform the emitted result.<sup><a data-type="noteref" href="ch08.html#idm45358824653424" id="idm45358824653424-marker">3</a></sup>&#13;
In other words, <a data-type="xref" href="#rr::fs">Example 8-12</a> reads a file specified with a <em>path</em>.&#13;
This operation returns <code>Uni</code>.&#13;
When the content is ready to be consumed, <code>Uni</code> emits <code>Buffer</code> as an item, and we transform <code>Buffer</code> into a <code>String</code> object.&#13;
All this, without blocking the thread!</p>&#13;
&#13;
<p>But that’s not all!&#13;
We can return that <code>Uni</code> directly and let Quarkus subscribe and handle the heavy lifting for us, as illustrated in <a data-type="xref" href="#rr::fs-uni">Example 8-13</a>.</p>&#13;
<div data-type="example" id="rr::fs-uni">&#13;
<h5><span class="label">Example 8-13. </span>Return a file read with the Vert.x filesystem API (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/MutinyExampleResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">reactive</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">io.vertx.core.file.FileSystemException</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">io.vertx.mutiny.core.Vertx</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.jboss.resteasy.reactive.server.ServerExceptionMapper</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.Response</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">java.time.Duration</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">MutinyExampleResource</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@Inject</code>&#13;
    <code class="n">Vertx</code> <code class="n">vertx</code><code class="o">;</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/lorem"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getLoremIpsum</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">readFile</code><code class="o">(</code><code class="s">"lorem.txt"</code><code class="o">)</code>&#13;
                <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">buffer</code> <code class="o">-&gt;</code> <code class="n">buffer</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Quarkus subscribes to the returned <code>Uni</code> and sends the emitted item to the HTTP response.&#13;
If the <code>Uni</code> emits a failure, it sends an HTTP error.</p>&#13;
&#13;
<p>Let’s see this in action.&#13;
Start the application, located in <em>chapter-8/mutiny-integration-examples</em>, with <code>mvn quarkus:dev</code> and invoke the endpoint by using <a data-type="xref" href="#retrieve-8-14">Example 8-14</a>.</p>&#13;
<div data-type="example" id="retrieve-8-14">&#13;
<h5><span class="label">Example 8-14. </span>Retrieve the lorem file</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; curl http://localhost:8080/lorem&#13;
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed <code class="k">do</code> eiusmod tempor&#13;
incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis&#13;
nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.&#13;
Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore&#13;
eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident,&#13;
sunt in culpa qui officia deserunt mollit anim id est laborum.</pre></div>&#13;
&#13;
<p>Most Quarkus APIs have reactive variants using Mutiny, such as the mailer service, database access (we will look at Hibernate Reactive in <a data-type="xref" href="ch09.html#data">Chapter 9</a>), messaging, templating, gRPC, and so on.&#13;
Besides, the Mutiny variant of Vert.x gives you access to a vast reactive ecosystem ranging from network protocols (DNS, TCP, UDP, HTTP), to messaging (Apache Kafka, AMQP, RabbitMQ, MQTT) via data accesses and web &#13;
<span class="keep-together">utilities</span>.<a data-startref="ix_http-adoc9" data-type="indexterm" id="idm45358824479312"/><a data-startref="ix_http-adoc8" data-type="indexterm" id="idm45358824478608"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dealing with Failure and Customizing the Response" data-type="sect1"><div class="sect1" id="response">&#13;
<h1>Dealing with Failure and Customizing the Response</h1>&#13;
&#13;
<p><a data-primary="failure handling" data-secondary="Quarkus and" data-type="indexterm" id="ix_http-adoc10"/><a data-primary="HTTP" data-secondary="dealing with failure/customizing the response" data-type="indexterm" id="ix_http-adoc11"/><a data-primary="Quarkus" data-secondary="failure handling" data-type="indexterm" id="ix_http-adoc12"/>Just because a method is asynchronous doesn’t mean it cannot fail.&#13;
For example, the file we are trying to serve may not be available, so we need to handle such a failure.&#13;
But, first, let’s see what Quarkus does by default.</p>&#13;
&#13;
<p>Let’s add an example with a failing operation with the following endpoint (as shown in <a data-type="xref" href="#rr::fs-fail">Example 8-15</a>).</p>&#13;
<div data-type="example" id="rr::fs-fail">&#13;
<h5><span class="label">Example 8-15. </span>Read a missing file with the Vert.x filesystem API (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/MutinyExampleResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/missing"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getMissingFile</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">readFile</code><code class="o">(</code><code class="s">"Oops.txt"</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">buffer</code> <code class="o">-&gt;</code> <code class="n">buffer</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">));</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Invoke the endpoint by using <a data-type="xref" href="#endpoint-8-16">Example 8-16</a>.</p>&#13;
<div data-type="example" id="endpoint-8-16">&#13;
<h5><span class="label">Example 8-16. </span>Propagation of failures</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; curl -f -v http://localhost:8080/missing&#13;
*   Trying ::1...&#13;
* TCP_NODELAY <code class="nb">set</code>&#13;
* Connection failed&#13;
* connect to ::1 port <code class="m">8080</code> failed: Connection refused&#13;
*   Trying 127.0.0.1...&#13;
* TCP_NODELAY <code class="nb">set</code>&#13;
* Connected to localhost <code class="o">(</code>127.0.0.1<code class="o">)</code> port <code class="m">8080</code> <code class="o">(</code><code class="c">#0)</code>&#13;
&gt; GET /missing HTTP/1.1&#13;
&gt; Host: localhost:8080&#13;
&gt; User-Agent: curl/7.64.1&#13;
&gt; Accept: */*&#13;
&gt;&#13;
* The requested URL returned error: <code class="m">500</code> Internal Server Error&#13;
* Closing connection 0&#13;
curl: <code class="o">(</code>22<code class="o">)</code> The requested URL returned error: <code class="m">500</code> Internal Server Error</pre></div>&#13;
&#13;
<p>Quarkus returns <code>500 Internal Server Error</code>.&#13;
This makes sense; there’s clearly a bug in our code.</p>&#13;
&#13;
<p>Let’s see what we can do.&#13;
As you have seen in <a data-type="xref" href="ch07.html#mutiny">Chapter 7</a>, <code>Uni</code> provides failure-handling capabilities that we can use here.&#13;
<a data-type="xref" href="#rr::fs-recover">Example 8-17</a> shows how we can recover with a simple message.</p>&#13;
<div data-type="example" id="rr::fs-recover">&#13;
<h5><span class="label">Example 8-17. </span>Recover on failure (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/MutinyExampleResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/recover"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getMissingFileAndRecover</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">readFile</code><code class="o">(</code><code class="s">"Oops.txt"</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">buffer</code> <code class="o">-&gt;</code> <code class="n">buffer</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code><code class="s">"Oops!"</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>This returns <code>oops</code>, as you can see in <a data-type="xref" href="#failure-recovery-8-18">Example 8-18</a>.</p>&#13;
<div data-type="example" id="failure-recovery-8-18">&#13;
<h5><span class="label">Example 8-18. </span>Failure recovery</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; curl http://localhost:8080/recover&#13;
oops!</pre></div>&#13;
&#13;
<p>We can also customize the HTTP response and return a proper <code>404 Not Found</code> error (<a data-type="xref" href="#rr::fs-404">Example 8-19</a>).</p>&#13;
<div data-type="example" id="rr::fs-404">&#13;
<h5><span class="label">Example 8-19. </span>Response customization (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/MutinyExampleResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/404"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">get404</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">readFile</code><code class="o">(</code><code class="s">"Oops.txt"</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">buffer</code> <code class="o">-&gt;</code> <code class="n">buffer</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">content</code> <code class="o">-&gt;</code> <code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">(</code><code class="n">content</code><code class="o">).</code><code class="na">build</code><code class="o">())</code>&#13;
            <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code>&#13;
                    <code class="n">Response</code><code class="o">.</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">NOT_FOUND</code><code class="o">).</code><code class="na">build</code><code class="o">());</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The signature of the endpoint is a bit different.&#13;
Instead of returning <code>Uni&lt;String&gt;</code>, we return <code>Uni&lt;Response&gt;</code>.&#13;
The emitted item (<code>Response</code>) represents the HTTP response we want to send back.&#13;
In <a data-type="xref" href="#customize-8-20">Example 8-20</a>, we set that on any failure we return a <code>404 Not Found</code>.</p>&#13;
<div data-type="example" id="customize-8-20">&#13;
<h5><span class="label">Example 8-20. </span>Customize the HTTP response</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"> curl -v http://localhost:8080/404&#13;
*   Trying ::1...&#13;
* TCP_NODELAY <code class="nb">set</code>&#13;
* Connection failed&#13;
* connect to ::1 port <code class="m">8080</code> failed: Connection refused&#13;
*   Trying 127.0.0.1...&#13;
* TCP_NODELAY <code class="nb">set</code>&#13;
* Connected to localhost <code class="o">(</code>127.0.0.1<code class="o">)</code> port <code class="m">8080</code> <code class="o">(</code><code class="c">#0)</code>&#13;
&gt; GET /404 HTTP/1.1&#13;
&gt; Host: localhost:8080&#13;
&gt; User-Agent: curl/7.64.1&#13;
&gt; Accept: */*&#13;
&gt;&#13;
&lt; HTTP/1.1 <code class="m">404</code> Not Found&#13;
&lt; content-length: 0&#13;
&lt;&#13;
* Connection <code class="c">#0 to host localhost left intact</code>&#13;
* Closing connection 0</pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You can use <code>Response</code> to customize the response—for example, by adding headers.</p>&#13;
</div>&#13;
&#13;
<p>An alternative is to register an exception mapper for the <code>FileSystemException</code>, as illustrated in <a data-type="xref" href="#rr::exception-mapper">Example 8-21</a>.</p>&#13;
<div data-type="example" id="rr::exception-mapper">&#13;
<h5><span class="label">Example 8-21. </span>Declare an exception mapper (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/MutinyExampleResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@ServerExceptionMapper</code>&#13;
<code class="kd">public</code> <code class="n">Response</code> <code class="nf">mapFileSystemException</code><code class="o">(</code><code class="n">FileSystemException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">Response</code><code class="o">.</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">NOT_FOUND</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">entity</code><code class="o">(</code><code class="n">ex</code><code class="o">.</code><code class="na">getMessage</code><code class="o">())</code>&#13;
            <code class="o">.</code><code class="na">build</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>With such a mapper defined, Quarkus captures the failure emitted by <code>Uni</code> and invokes the mapper to produce the appropriate <code>Response</code>.</p>&#13;
&#13;
<p>And what about time-out?&#13;
While the chances of having a time-out when reading from the filesystem are relatively low, it becomes much more critical when dealing with a remote service.&#13;
Handle time-out as shown in <a data-type="xref" href="#rr::timeout">Example 8-22</a>.</p>&#13;
<div data-type="example" id="rr::timeout">&#13;
<h5><span class="label">Example 8-22. </span>Handling timeout</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">return</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">readFile</code><code class="o">(</code><code class="s">"slow.txt"</code><code class="o">)</code>&#13;
        <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">buffer</code> <code class="o">-&gt;</code> <code class="n">buffer</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">))</code>&#13;
        <code class="o">.</code><code class="na">ifNoItem</code><code class="o">().</code><code class="na">after</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">)).</code><code class="na">fail</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>You can specify the exception to emit in this case, and if you need, register an exception mapper.</p>&#13;
&#13;
<p>When implementing an HTTP endpoint with RESTEasy Reactive, ask yourself if you can use the Mutiny integration to compose asynchronous actions and fully benefit from the performance and efficiency of the reactive engine of Quarkus.&#13;
Of course, you can use <code>@Blocking</code>, but there is a cost to consider.<a data-startref="ix_http-adoc12" data-type="indexterm" id="idm45358824010832"/><a data-startref="ix_http-adoc11" data-type="indexterm" id="idm45358824010224"/><a data-startref="ix_http-adoc10" data-type="indexterm" id="idm45358824009584"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Streaming Data" data-type="sect1"><div class="sect1" id="idm45358824008656">&#13;
<h1>Streaming Data</h1>&#13;
&#13;
<p><a data-primary="HTTP" data-secondary="streaming data" data-type="indexterm" id="ix_http-adoc13"/><a data-primary="streaming data" data-secondary="HTTP response" data-type="indexterm" id="ix_http-adoc14"/>Returning <code>Uni</code> is perfect when we have a single piece of data to send into the response.&#13;
But what about <em>streams</em>?</p>&#13;
&#13;
<p><a data-primary="Multi class (Mutiny)" data-secondary="streaming data and" data-type="indexterm" id="idm45358823968912"/>In addition to <code>Uni</code>, Quarkus lets you return a <code>Multi</code> instance.&#13;
Quarkus subscribes to the returned <code>Multi</code> and writes the items emitted by this <code>Multi</code>, one by one, into the HTTP response.&#13;
It’s an efficient way to deal with streams and limit the application’s memory consumption, as you don’t have to buffer the entire content in memory.&#13;
Indeed, Quarkus uses HTTP <em>chunked</em> responses by setting the <a href="https://oreil.ly/QcHFs"><code>Transfer-Encoding header</code></a> when dealing with <code>Multi</code>.&#13;
That feature from HTTP allows writing into the response chunk after chunk.</p>&#13;
&#13;
<p>As with <code>Uni</code>, a method retuning a <code>Multi</code> is considered nonblocking by default.&#13;
There’s no need to use <code>@NonBlocking</code>.</p>&#13;
&#13;
<p>But when returning <code>Multi</code>, we need to ask ourselves: What envelope do we want? Do we want to stream bytes? Do we want to send a JSON array instead? Or maybe individual events using Server-Sent Events?&#13;
Quarkus supports all these, and that’s what we are going to see in this section.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Raw Streaming" data-type="sect2"><div class="sect2" id="idm45358823961024">&#13;
<h2>Raw Streaming</h2>&#13;
&#13;
<p><a data-primary="raw streaming" data-type="indexterm" id="idm45358823959488"/><a data-primary="streaming data" data-secondary="raw streaming" data-type="indexterm" id="idm45358823958784"/>Let’s start with <em>raw</em> streaming, basically no envelope.&#13;
This model is great for writing large payloads in response, as we can write them chunk by chunk, in order.</p>&#13;
&#13;
<p>Raw streaming is straightforward with Quarkus and RESTEasy Reactive: just return <code>Multi</code>.&#13;
Let’s look at an example.&#13;
You have probably heard about the book <em>War and Peace</em>.&#13;
It’s what we would call a brick, more than 1,200 pages!&#13;
Let’s say that we want to accumulate the full content of <em>War and Peace</em> and return it in an HTTP response as a single batch.&#13;
It’s doable, but let’s make the book easy to digest by streaming the content (<a data-type="xref" href="#rr::stream">Example 8-23</a>).</p>&#13;
<div data-type="example" id="rr::stream">&#13;
<h5><span class="label">Example 8-23. </span>Stream responses (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/book"</code><code class="o">)</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">book</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">open</code><code class="o">(</code><code class="s">"war-and-peace.txt"</code><code class="o">,</code>&#13;
                <code class="k">new</code> <code class="nf">OpenOptions</code><code class="o">().</code><code class="na">setRead</code><code class="o">(</code><code class="kc">true</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMulti</code><code class="o">(</code><code class="nl">AsyncFile:</code><code class="o">:</code><code class="n">toMulti</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">b</code> <code class="o">-&gt;</code> <code class="n">b</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">));</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>This code opens the book text from the filesystem, using the Vert.x filesystem API, and reads it chunk by chunk.&#13;
<code>AsyncFile::toMulti</code> is responsible for reading the file (and <code>AsyncFile</code>) and emitting the content chunk by chunk.&#13;
As we did previously in <a data-type="xref" href="#rr::fs-uni">Example 8-13</a>, we transform the content into UTF-8 strings.</p>&#13;
&#13;
<p>You can find this code in <em>chapter-8/mutiny-integration-examples</em>.&#13;
Run the application by using <code>mvn quarkus:dev</code> and then test it with <a data-type="xref" href="#consume-chunked-responses-8-24">Example 8-24</a>.</p>&#13;
<div data-type="example" id="consume-chunked-responses-8-24">&#13;
<h5><span class="label">Example 8-24. </span>Consume chunked responses</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code>&gt;</code><code> </code><code>curl</code><code> </code><code>http://localhost:8080/book</code><code> </code><code>-N</code><code> </code><a class="co" href="#callout_http_with_reactive_in_mind_CO1-1" id="co_http_with_reactive_in_mind_CO1-1"><img alt="1" src="assets/1.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_http_with_reactive_in_mind_CO1-1" id="callout_http_with_reactive_in_mind_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><code>-N</code> instructs <code>curl</code> to read the response chunk by chunk (it disables the buffering).</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>We get the content, but it’s hard to see that it was sent as a set of chunks.&#13;
Let’s update the endpoint to send a chunk every second (<a data-type="xref" href="#rr::stream-pace">Example 8-25</a>).</p>&#13;
<div data-type="example" id="rr::stream-pace">&#13;
<h5><span class="label">Example 8-25. </span>Pace streamed responses (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/book"</code><code class="o">)</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">bookWithTicks</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code> <code class="n">ticks</code> <code class="o">=</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">));</code>&#13;
    <code class="n">Multi</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">book</code> <code class="o">=</code> <code class="n">vertx</code><code class="o">.</code><code class="na">fileSystem</code><code class="o">().</code><code class="na">open</code><code class="o">(</code><code class="s">"war-and-peace.txt"</code><code class="o">,</code>&#13;
        <code class="k">new</code> <code class="nf">OpenOptions</code><code class="o">().</code><code class="na">setRead</code><code class="o">(</code><code class="kc">true</code><code class="o">))</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transformToMulti</code><code class="o">(</code><code class="nl">AsyncFile:</code><code class="o">:</code><code class="n">toMulti</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">b</code> <code class="o">-&gt;</code> <code class="n">b</code><code class="o">.</code><code class="na">toString</code><code class="o">(</code><code class="s">"UTF-8"</code><code class="o">));</code>&#13;
    <code class="k">return</code>&#13;
            <code class="n">Multi</code><code class="o">.</code><code class="na">createBy</code><code class="o">().</code><code class="na">combining</code><code class="o">().</code><code class="na">streams</code><code class="o">(</code><code class="n">ticks</code><code class="o">,</code> <code class="n">book</code><code class="o">).</code><code class="na">asTuple</code><code class="o">()</code>&#13;
                    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="nl">Tuple2:</code><code class="o">:</code><code class="n">getItem2</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#rr::stream-pace">Example 8-25</a> combines two streams.&#13;
First, it creates a periodic stream, emitting a tick every second (<code>ticks</code>).&#13;
Then it retrieves the stream reading the book (<code>book</code>).&#13;
The combination creates a stream of tuples that will be emitted every second.&#13;
Each tuple contains a tick (<code>getItem1</code>) and the chunk (<code>getItem2</code>).&#13;
We just need to forward the chunk, dropping the tick.</p>&#13;
&#13;
<p>Now, rerun the <code>curl</code> command, and you will see the content appearing chunk by chunk every second.&#13;
Don’t wait until the end because there are many chunks; just hit Ctrl-C to interrupt.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Streaming JSON Array" data-type="sect2"><div class="sect2" id="idm45358823960400">&#13;
<h2>Streaming JSON Array</h2>&#13;
&#13;
<p><a data-primary="JSON array, streaming" data-type="indexterm" id="ix_http-adoc15"/><a data-primary="streaming data" data-secondary="JSON array" data-type="indexterm" id="ix_http-adoc16"/>The <em>War and Peace</em> example is interesting for binary content or simple text, but you may want to send a more structured response, such as a JSON array.&#13;
Imagine you are building a response that is a JSON array, but a potentially large one.&#13;
Each item is a JSON object.&#13;
You could build that structure in memory and flush everything in a single batch, but it may be more efficient to push the JSON objects one by one.&#13;
First, that approach would save some memory on our part, and the client receiving the data may be able to start processing the items immediately. To stream a JSON array, you need to adapt the produced content type.&#13;
In the previous example, we just used <code>text/plain</code>.&#13;
To create a JSON array, we need to set it to &#13;
<span class="keep-together"><code>application/json</code>.</span></p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>We recommend using the <code>MediaType</code> class that provides constants for the most common content types.&#13;
A typo can quickly become a debugging nightmare.</p>&#13;
</div>&#13;
&#13;
<p>Let’s imagine we have a bunch of books.&#13;
Each <code>Book</code> has an ID, a title, and a list of authors (<a data-type="xref" href="#rr::book">Example 8-26</a>).</p>&#13;
<div data-type="example" id="rr::book">&#13;
<h5><span class="label">Example 8-26. </span>The <code>Book</code> structure (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">Book</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">id</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="kt">long</code> <code class="n">id</code><code class="o">,</code> <code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">authors</code> <code class="o">=</code> <code class="n">authors</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Let’s imagine we have a <em>service</em> that lets us retrieve our collection of books as a <code>Multi</code>.&#13;
In other words, we have a service offering the API in <a data-type="xref" href="#rr::book-service">Example 8-27</a>.</p>&#13;
<div data-type="example" id="rr::book-service">&#13;
<h5><span class="label">Example 8-27. </span>Stream books API</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Multi</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">getBooks</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>To build a JSON array from this method, we can return an instance of <code>Multi</code> produced by the <code>getBooks</code> method (<a data-type="xref" href="#rr::book-stream">Example 8-28</a>).</p>&#13;
<div data-type="example" id="rr::book-stream">&#13;
<h5><span class="label">Example 8-28. </span>Stream books (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Inject</code> <code class="n">BookService</code> <code class="n">service</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/books"</code><code class="o">)</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">books</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">getBooks</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>If you call this endpoint by using the command in <a data-type="xref" href="#consume-stream-of-books">Example 8-29</a>, you will get all the books.</p>&#13;
<div data-type="example" id="consume-stream-of-books">&#13;
<h5><span class="label">Example 8-29. </span>Consume the stream of books</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt;  curl -N http://localhost:8080/books&#13;
<code class="o">[{</code><code class="s2">"id"</code>:0,<code class="s2">"title"</code>:<code class="s2">"Fundamentals of Software Architecture"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Mark</code>&#13;
<code class="s2">Richards"</code>,<code class="s2">"Neal Ford"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:1,<code class="s2">"title"</code>:<code class="s2">"Domain-Driven Design"</code>,<code class="s2">"authors"</code>:&#13;
<code class="o">[</code><code class="s2">"Eric Evans"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:2,<code class="s2">"title"</code>:<code class="s2">"Designing Distributed Systems"</code>,&#13;
<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Brendan Burns"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:3,<code class="s2">"title"</code>:<code class="s2">"Building Evolutionary</code>&#13;
<code class="s2">Architectures"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Neal Ford"</code>,<code class="s2">"Rebecca Parsons"</code>,<code class="s2">"Patrick Kua"</code><code class="o">]}</code>,&#13;
<code class="o">{</code><code class="s2">"id"</code>:4,<code class="s2">"title"</code>:<code class="s2">"Principles of Concurrent and Distributed Programming"</code>,&#13;
<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"M. Ben-Ari"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:5,<code class="s2">"title"</code>:<code class="s2">"Distributed Systems Observability"</code>,&#13;
<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Cindy Sridharan"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:6,<code class="s2">"title"</code>:<code class="s2">"Event Streams in Action"</code>,&#13;
<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Alexander Dean"</code>,<code class="s2">"Valentin Crettaz"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:7,<code class="s2">"title"</code>:<code class="s2">"Designing</code>&#13;
<code class="s2">Data-Intensive Applications"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Martin Kleppman"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:8,&#13;
<code class="s2">"title"</code>:<code class="s2">"Building Microservices"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Sam Newman"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:9,&#13;
<code class="s2">"title"</code>:<code class="s2">"Kubernetes in Action"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Marko Luksa"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:10,&#13;
<code class="s2">"title"</code>:<code class="s2">"Kafka - the definitive guide"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Gwenn Shapira"</code>,<code class="s2">"Todd Palino"</code>,&#13;
<code class="s2">"Rajini Sivaram"</code>,<code class="s2">"Krit Petty"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:11,<code class="s2">"title"</code>:<code class="s2">"Effective Java"</code>,&#13;
<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Joshua Bloch"</code><code class="o">]}</code>,<code class="o">{</code><code class="s2">"id"</code>:12,<code class="s2">"title"</code>:<code class="s2">"Building Event-Driven</code>&#13;
<code class="s2">Microservices"</code>,<code class="s2">"authors"</code>:<code class="o">[</code><code class="s2">"Adam Bellemare"</code><code class="o">]}]</code></pre></div>&#13;
&#13;
<p>The result is a well-formed JSON array containing our books, serialized as JSON objects.&#13;
But, again, it’s hard to see that it was streamed.&#13;
We can use the same approach as we did before to limit the emission to one per second, as in <a data-type="xref" href="#rr::stream-book-page">Example 8-30</a>.</p>&#13;
<div data-type="example" id="rr::stream-book-page">&#13;
<h5><span class="label">Example 8-30. </span>Produce a book every second (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/books"</code><code class="o">)</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">booksWithTicks</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code> <code class="n">ticks</code> <code class="o">=</code> <code class="n">Multi</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">ticks</code><code class="o">().</code><code class="na">every</code><code class="o">(</code><code class="n">Duration</code><code class="o">.</code><code class="na">ofSeconds</code><code class="o">(</code><code class="mi">1</code><code class="o">));</code>&#13;
    <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="n">books</code> <code class="o">=</code> <code class="n">service</code><code class="o">.</code><code class="na">getBooks</code><code class="o">();</code>&#13;
&#13;
    <code class="k">return</code>&#13;
            <code class="n">Multi</code><code class="o">.</code><code class="na">createBy</code><code class="o">().</code><code class="na">combining</code><code class="o">().</code><code class="na">streams</code><code class="o">(</code><code class="n">ticks</code><code class="o">,</code> <code class="n">books</code><code class="o">).</code><code class="na">asTuple</code><code class="o">()</code>&#13;
                    <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="nl">Tuple2:</code><code class="o">:</code><code class="n">getItem2</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>With this code, if you rerun the <code>curl</code> command, you will see the items appearing one by one.<a data-startref="ix_http-adoc16" data-type="indexterm" id="idm45358823281344"/><a data-startref="ix_http-adoc15" data-type="indexterm" id="idm45358823173872"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Server-Sent-Events" data-type="sect2"><div class="sect2" id="idm45358823666736">&#13;
<h2>Using Server-Sent-Events</h2>&#13;
&#13;
<p><a data-primary="Server-Sent Events API (SSE)" data-type="indexterm" id="ix_http-adoc17"/><a data-primary="SSE (Server-Sent Events API)" data-type="indexterm" id="ix_http-adoc18"/><a data-primary="streaming data" data-secondary="using Server-Sent Events" data-type="indexterm" id="ix_http-adoc19"/><a data-primary="unbounded streams, Server-Sent Events and" data-type="indexterm" id="ix_http-adoc20"/>Raw streams and JSON arrays are helpful for bounded streams.&#13;
But, sometimes, we have to deal with unbounded ones.</p>&#13;
&#13;
<p><a href="https://oreil.ly/NjQNL">Server-Sent Events</a> (SSE) was designed with this use case in mind.&#13;
It provides a way to stream potentially unbounded structured data using HTTP.</p>&#13;
&#13;
<p>To produce an SSE response, you set the produced content type to <code>text/event-stream</code>. Let’s try this. Imagine we want to stream events from a financial market. Each event is a <code>Quote</code> containing the name of a company and the new stock value (<a data-type="xref" href="#rr::quote">Example 8-31</a>).</p>&#13;
<div data-type="example" id="rr::quote">&#13;
<h5><span class="label">Example 8-31. </span>The <code>Quote</code> structure (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">Quote</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">company</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">final</code> <code class="kt">double</code> <code class="n">value</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Quote</code><code class="o">(</code><code class="n">String</code> <code class="n">company</code><code class="o">,</code> <code class="kt">double</code> <code class="n">value</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">company</code> <code class="o">=</code> <code class="n">company</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">value</code> <code class="o">=</code> <code class="n">value</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Now, let’s imagine a service emitting a <code>Quote</code> every second to represent the fluctuation of the market.&#13;
We can produce an SSE response by returning that stream directly (<a data-type="xref" href="#rr::stream-quotes">Example 8-32</a>).</p>&#13;
<div data-type="example" id="rr::stream-quotes">&#13;
<h5><span class="label">Example 8-32. </span>Stream quotes (<em>chapter-8/mutiny-integration-examples/src/main/java/org/acme/StreamResource.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Inject</code> <code class="n">Market</code> <code class="n">market</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/market"</code><code class="o">)</code>&#13;
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">SERVER_SENT_EVENTS</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Quote</code><code class="o">&gt;</code> <code class="nf">market</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">market</code><code class="o">.</code><code class="na">getEventStream</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>By setting the produced content to SSE, Quarkus writes the response accordingly.&#13;
Each individual <code>Quote</code> is encoded to JSON automatically (<a data-type="xref" href="#consume-sse-8-33">Example 8-33</a>).</p>&#13;
<div data-type="example" id="consume-sse-8-33">&#13;
<h5><span class="label">Example 8-33. </span>Consume the SSE response</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&gt; curl -N http://localhost:8080/market&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"MacroHard"</code>,<code class="s2">"value"</code>:0.9920107877590033<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"Divinator"</code>,<code class="s2">"value"</code>:16.086577691515345<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"Divinator"</code>,<code class="s2">"value"</code>:6.739227006693276<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"MacroHard"</code>,<code class="s2">"value"</code>:1.9383421237456742<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"MacroHard"</code>,<code class="s2">"value"</code>:38.723702725212156<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"Divinator"</code>,<code class="s2">"value"</code>:44.23789420202483<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"Black Coat"</code>,<code class="s2">"value"</code>:171.42142746079418<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"MacroHard"</code>,<code class="s2">"value"</code>:44.37699080288775<code class="o">}</code>&#13;
&#13;
data:<code class="o">{</code><code class="s2">"company"</code>:<code class="s2">"Black Coat"</code>,<code class="s2">"value"</code>:37.33849006264873<code class="o">}</code>&#13;
...</pre></div>&#13;
&#13;
<p>A client reading SSE, such as a <a href="https://oreil.ly/scARA">JavaScript <code>EventSource</code></a>, can process the quotes one by one as they come<a data-startref="ix_http-adoc20" data-type="indexterm" id="idm45358822943904"/><a data-startref="ix_http-adoc19" data-type="indexterm" id="idm45358822943296"/><a data-startref="ix_http-adoc18" data-type="indexterm" id="idm45358822942688"/><a data-startref="ix_http-adoc17" data-type="indexterm" id="idm45358822942048"/>.<a data-startref="ix_http-adoc14" data-type="indexterm" id="idm45358822941248"/><a data-startref="ix_http-adoc13" data-type="indexterm" id="idm45358822940544"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reactive Score" data-type="sect1"><div class="sect1" id="idm45358823172784">&#13;
<h1>Reactive Score</h1>&#13;
&#13;
<p><a data-primary="HTTP" data-secondary="reactive score" data-type="indexterm" id="idm45358822938624"/><a data-primary="reactive score" data-type="indexterm" id="idm45358822937616"/><a data-primary="RESTEasy Reactive" data-secondary="reactive score" data-type="indexterm" id="idm45358822936944"/>So far, we have looked at various features of RESTEasy Reactive and Quarkus.&#13;
But what about tooling around Reactive?</p>&#13;
&#13;
<p>We already experienced dev mode, which made us highly productive, but there is more.&#13;
RESTEasy Reactive produces a <em>reactive score</em> for your endpoints, indicating how <em>responsive</em> the endpoints are.</p>&#13;
&#13;
<p>To compute this score, RESTEasy Reactive looks at the execution model (typically, an endpoint using worker threads will get a lower score), instantiation scheme (favoring singleton over request-based instantiation), the usage of marshaller and reflection-based mechanisms (such as object mapper), and so on.</p>&#13;
&#13;
<p>Let’s look at the score in an example.&#13;
In <em>chapter-8/reactive-scores</em>, an application contains a bunch of endpoints using various features.&#13;
Launch the application in dev mode by using <code>mvn quarkus:dev</code>, and then open a browser.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>This reactive score page is part of the Quarkus dev console. Each extension can contribute to the dev console.&#13;
In dev mode, access the dev console using <a href="http://localhost:8080/q/dev"><em class="hyperlink">http://localhost:8080/q/dev</em></a>.&#13;
In our example, you can navigate to <a href="http://localhost:8080/q/swagger-ui/"><em class="hyperlink">http://localhost:8080/q/swagger-ui/</em></a> to try all the defined endpoints.</p>&#13;
</div>&#13;
&#13;
<p>You can see scores going from 50/100 (rather bad) to 100/100 (excellent!) in our application (<a data-type="xref" href="#image:scores">Figure 8-3</a>).&#13;
You can click each method to understand the given score. This feature is handy when trying to improve the concurrency and the efficiency of your application.&#13;
If you realize that you have a bottleneck, check the score and try to improve it.&#13;
The effect on your application will be immediate.</p>&#13;
&#13;
<figure><div class="figure" id="image:scores">&#13;
<img alt="Endpoint Scores" src="assets/rsij_0803.png"/>&#13;
<h6><span class="label">Figure 8-3. </span>Endpoint scores</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45358822924752">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>HTTP is unavoidable. Although it does not enforce reactive principles, Quarkus offers a way to expose HTTP APIs without renouncing to those reactive principles.</p>&#13;
&#13;
<p>Thanks to RESTEasy Reactive, you get a familiar declarative development model that is a lot more efficient and performant.&#13;
We only scratched the surface.&#13;
RESTEasy Reactive also supports Bean Validation to automatically validate the incoming payloads or OpenAPI to describe your API.</p>&#13;
&#13;
<p>You may wonder how to consume HTTP endpoints.&#13;
This is covered in <a data-type="xref" href="ch12.html#http-client">Chapter 12</a>. But, there is one aspect we didn’t discuss yet: data and how to reactively access data stores. This is the topic of the next chapter.<a data-startref="ix_http-adoc0" data-type="indexterm" id="idm45358822921120"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45358825012512"><sup><a href="ch08.html#idm45358825012512-marker">1</a></sup> Vert.x event loop threads are I/O threads.</p><p data-type="footnote" id="idm45358825016128"><sup><a href="ch08.html#idm45358825016128-marker">2</a></sup> Methods returning instances of <code>Multi</code> or <code>Uni</code> are automatically considered nonblocking if not specified  <span class="keep-together">otherwise</span>.</p><p data-type="footnote" id="idm45358824653424"><sup><a href="ch08.html#idm45358824653424-marker">3</a></sup> <code>Buffer</code> is a convenient way to represent a bag of bytes in Vert.x.</p></div></div></section></body></html>