<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Persistence"><div class="chapter" id="persistence_chapter">
<h1><span class="label">Chapter 7. </span>Persistence</h1>


<p><a data-type="indexterm" data-primary="persistence" data-secondary="about" id="idm45128518721368"/><a data-type="indexterm" data-primary="persistence" id="per_cha"/>The underlying persistence strategies used by Quarkus should already be familiar to you.
Transactions, datasources, Java Persistence API (JPA), and so on are all standards that have existed for many years.
Quarkus uses these and, in some cases, builds on top of them to make working with persistent stores easier.
In this chapter, you will learn about working with persistent stores in Quarkus.
We cover both traditional relational database management systems (RDBMS) and NoSQL databases.</p>

<p>Quarkus has some additional gems if you’re using a traditional RDBMS or MongoDB in the form a Panache, an opinionated, entity or active record type API.
Panache simplifies much of the standard JPA syntax, making your application easier to read and maintain—again, helping you to be more productive!</p>

<p>In this chapter, you’ll learn how to accomplish the following tasks:</p>

<ul>
<li>
<p>Configure datasources</p>
</li>
<li>
<p>Deal with transactions</p>
</li>
<li>
<p>Manage database schema migrations</p>
</li>
<li>
<p>Make use of the Panache API</p>
</li>
<li>
<p>Interact with NoSQL data stores</p>
</li>
</ul>






<section data-type="sect1" data-pdf-bookmark="7.1 Defining a Datasource"><div class="sect1" id="idm45128518692712">
<h1>7.1 Defining a Datasource</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518691832">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="defining datasources" id="idm45128518690824"/><a data-type="indexterm" data-primary="datasources" data-secondary="defining" id="idm45128518689976"/>You want to define and use a datasource.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518688744">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="Agroal extension" id="idm45128518687736"/>Use the Agroal extension and <em>application.properties</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518686360">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="H2 Database Engine" id="idm45128518685112"/><a data-type="indexterm" data-primary="PostgreSQL" id="idm45128518684280"/><a data-type="indexterm" data-primary="MariaDB" id="idm45128518683672"/><a data-type="indexterm" data-primary="MySQL" id="idm45128518683064"/><a data-type="indexterm" data-primary="Microsoft SQL Server" id="idm45128518682456"/><a data-type="indexterm" data-primary="Derby (Apache)" id="idm45128518681848"/><a data-type="indexterm" data-primary="Apache Derby" id="idm45128518681176"/><a data-type="indexterm" data-primary="Hibernate" id="idm45128518680504"/><a data-type="indexterm" data-primary="ORM" id="idm45128518679832"/><a data-type="indexterm" data-primary="Panache" data-secondary="about" id="idm45128518679160"/>Agroal is the preferred datasource and connection pooling implementation in Quarkus.
The Agroal extension has integrations with security, transaction management, and health metrics.
While it does have its own extension, if you are using Hibernate ORM or Panache, the Agroal extension is pulled in transitively.
You will also need a database driver extension.
Currently, H2, PostgreSQL, MariaDB, MySQL, Microsoft SQL Server, and Derby all have supported extensions.
You can add the correct database driver with the Maven <code>add-extension</code>:</p>

<pre data-type="programlisting" data-code-language="bash">./mvnw quarkus:add-extension -Dextensions<code class="o">=</code><code class="s2">"jdbc-mariadb"</code></pre>

<p>Configuration for the datasource, just like all the other configurations for Quarkus, is done in the <em>src/main/resources/application.properties</em> file:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.url</code><code class="o">=</code><code class="s">jdbc::mariadb://localhost:3306/test</code>
<code class="na">quarkus.datasource.driver</code><code class="o">=</code><code class="s">org.mariadb.jdbc.Driver</code>
<code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">username-default</code>
<code class="na">quarkus.datasource.min-size</code><code class="o">=</code><code class="s">3</code>
<code class="na">quarkus.datasource.max-size</code><code class="o">=</code><code class="s">13</code></pre>
<div data-type="tip"><h6>Tip</h6>
<p><a data-type="indexterm" data-primary="secrets" data-secondary="about" id="idm45128518658040"/><a data-type="indexterm" data-primary="Vault" data-secondary="about" id="idm45128518631416"/>Sensitive data can be passed via system properties, environment properties, Kubernetes Secrets, or Vault, as you will see in later chapters.</p>
</div>

<p>Should you need access to the datasource, you can inject it as follows:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code>
<code class="n">DataSource</code> <code class="n">defaultDataSource</code><code class="o">;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You can also use the <code>AgroalDataSource</code> type, which is a subtype of <code>DataSource</code>.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.2 Using Multiple Datasources"><div class="sect1" id="idm45128518610344">
<h1>7.2 Using Multiple Datasources</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518609304">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="datasources" data-secondary="using multiple" id="idm45128518608104"/><a data-type="indexterm" data-primary="persistence" data-secondary="using multiple datasources" id="idm45128518607128"/>You want to use multiple datasources when more than one datasource is necessary for your application.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518627320">
<h2>Solution</h2>

<p>Use named datasources.</p>

<p>Agroal allows for multiple datasources.
They are configured exactly the same as the default, with one noteable exception—a name:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.driver</code><code class="o">=</code><code class="s">org.h2.Driver</code>
<code class="na">quarkus.datasource.url</code><code class="o">=</code><code class="s">jdbc:h2:tcp://localhost/mem:default</code>
<code class="na">quarkus.datasource.username</code><code class="o">=</code><code class="s">username-default</code>
<code class="na">quarkus.datasource.min-size</code><code class="o">=</code><code class="s">3</code>
<code class="na">quarkus.datasource.max-size</code><code class="o">=</code><code class="s">13</code>

<code class="na">quarkus.datasource.users.driver</code><code class="o">=</code><code class="s">org.h2.Driver</code>
<code class="na">quarkus.datasource.users.url</code><code class="o">=</code><code class="s">jdbc:h2:tcp://localhost/mem:users</code>
<code class="na">quarkus.datasource.users.username</code><code class="o">=</code><code class="s">username1</code>
<code class="na">quarkus.datasource.users.min-size</code><code class="o">=</code><code class="s">1</code>
<code class="na">quarkus.datasource.users.max-size</code><code class="o">=</code><code class="s">11</code>

<code class="na">quarkus.datasource.inventory.driver</code><code class="o">=</code><code class="s">org.h2.Driver</code>
<code class="na">quarkus.datasource.inventory.url</code><code class="o">=</code><code class="s">jdbc:h2:tcp://localhost/mem:inventory</code>
<code class="na">quarkus.datasource.inventory.username</code><code class="o">=</code><code class="s">username2</code>
<code class="na">quarkus.datasource.inventory.min-size</code><code class="o">=</code><code class="s">2</code>
<code class="na">quarkus.datasource.inventory.max-size</code><code class="o">=</code><code class="s">12</code></pre>

<p>The format is as follows: <code>quarkus.<em>datasource</em>.[<em>optional name</em>.][<em>datasource property</em>]</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518530232">
<h2>Discussion</h2>

<p>Injection works identically; however, you will need a qualifier (please see <a data-type="xref" href="ch05.xhtml#named_qualifier">Recipe 5.10</a> for more information about qualifiers):</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code>
<code class="n">AgroalDataSource</code> <code class="n">defaultDataSource</code><code class="o">;</code>

<code class="nd">@Inject</code>
<code class="nd">@DataSource</code><code class="o">(</code><code class="s">"users"</code><code class="o">)</code>
<code class="n">AgroalDataSource</code> <code class="n">dataSource1</code><code class="o">;</code>

<code class="nd">@Inject</code>
<code class="nd">@DataSource</code><code class="o">(</code><code class="s">"inventory"</code><code class="o">)</code>
<code class="n">AgroalDataSource</code> <code class="n">dataSource2</code><code class="o">;</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.3 Adding Datasource Health Check"><div class="sect1" id="idm45128518512040">
<h1>7.3 Adding Datasource Health Check</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518510920">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="datasources" data-secondary="adding health checks" id="idm45128518509784"/><a data-type="indexterm" data-primary="persistence" data-secondary="adding datasource health checks" id="idm45128518508808"/>You want to add a health check entry for the datasource(s).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518507512">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="quarkus-agroal extension" id="idm45128518506344"/><a data-type="indexterm" data-primary="quarkus-smallrye-health extension" id="idm45128518505672"/>Use both the <code>quarkus-agroal</code> and <code>quarkus-smallrye-health</code> extensions.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518503736">
<h2>Discussion</h2>

<p>The health check for datasources is automatically added when the <code>quarkus-smallrye-health</code> extension is in use.
It can be disabled, if desired, with the <code>quarkus.datasource.health.enabled</code> (default to <code>true</code>) property in <em>application.properties</em>.
To view the status, access the <em>/health/ready</em> endpoint of your application.
That endpoint is created from the <code>quarkus-smallrye-health</code> extension.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128518499496">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="MicroProfile Health" id="idm45128518498264"/>For more information, visit the following page on GitHub:</p>

<ul>
<li>
<p><a href="https://oreil.ly/CDLOd">MicroProfile Health</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.4 Defining Transaction Boundaries Declaratively"><div class="sect1" id="idm45128518495464">
<h1>7.4 Defining Transaction Boundaries Declaratively</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518494568">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="defining transaction boundaries declaratively" id="idm45128518493368"/><a data-type="indexterm" data-primary="transaction boundaries, defining declaratively" id="idm45128518492296"/>You want to define a transaction boundary using annotations.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518491208">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="@javax.transaction.Transactional annotation" id="idm45128518490040"/><a data-type="indexterm" data-primary="quarkus-narayana-jta extension" id="idm45128518489304"/>Use the <code>@javax.transaction.Transactional</code> annotation from the <code>quarkus-narayana-jta</code> extension.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518487400">
<h2>Discussion</h2>

<p>The <code>quarkus-narayana-jta</code> extension adds in the <code>@javax.transaction.Transactional</code> annotations, as well as the <code>TransactionManager</code> and <code>UserTransaction</code> classes.
This extension is automatically added by any persistence extensions.
Of course, this can be added manually if needed.</p>

<p><a data-type="indexterm" data-primary="@Transactional annotation" id="idm45128518428104"/>The <code>@Transactional</code> annotation can be added to any CDI bean at the method or class level to make those methods transactional—this also includes REST endpoints:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">transaction</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.transaction.Transactional</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Produces</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code>

<code class="nd">@Path</code><code class="o">(</code><code class="s">"/tx"</code><code class="o">)</code>
<code class="nd">@Transactional</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Transact</code> <code class="o">{</code>
<code class="o">}</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.5 Setting a Transaction Context"><div class="sect1" id="idm45128518345688">
<h1>7.5 Setting a Transaction Context</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518387512">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="setting transaction context" id="idm45128518386408"/><a data-type="indexterm" data-primary="transaction context, setting" id="idm45128518385416"/>You want a different transaction context.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518384344">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="@Transactional annotation" id="idm45128518383176"/>The <code>value</code> attribute on <code>@Transactional</code> allows the scope to be set for the 
<span class="keep-together">transaction.</span></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518380648">
<h2>Discussion</h2>

<p>The transaction context specified is propagated to all nested calls within the method that has been annotated.
Unless a runtime exception is thrown in the stack, the 
<span class="keep-together">transaction</span> will commit at the end of the method call:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">transaction</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.transaction.Transactional</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Produces</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code>

<code class="nd">@Path</code><code class="o">(</code><code class="s">"/tx"</code><code class="o">)</code>
<code class="nd">@Transactional</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Transact</code> <code class="o">{</code>
    <code class="nd">@Inject</code>
    <code class="n">NoTransact</code> <code class="n">noTx</code><code class="o">;</code>

    <code class="nd">@GET</code>
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/no"</code><code class="o">)</code>
    <code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">TEXT_PLAIN</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">hi</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">noTx</code><code class="o">.</code><code class="na">word</code><code class="o">();</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">transaction</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.transaction.Transactional</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">static</code> <code class="n">javax</code><code class="o">.</code><code class="na">transaction</code><code class="o">.</code><code class="na">Transactional</code><code class="o">.</code><code class="na">TxType</code><code class="o">.</code><code class="na">NEVER</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">NoTransact</code> <code class="o">{</code>
    <code class="nd">@Transactional</code><code class="o">(</code><code class="n">NEVER</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">word</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="s">"Hi"</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="TransactionManager" id="idm45128518158904"/>This is overridable with the <code>dontRollbackOn</code> or <code>rollbackOn</code> attributes of <code>@⁠T⁠r⁠a⁠n⁠s​a⁠c⁠t⁠i⁠o⁠n⁠a⁠l</code>.
You can also inject the <code>TransactionManager</code> if you need to manually roll back a transaction.</p>

<p>Here is a list of available transactional contexts:</p>
<dl>
<dt><code>@Transactional(REQUIRED)</code> (default)</dt>
<dd>
<p>Starts a transaction if none was started; otherwise, stays with the existing one</p>
</dd>
<dt><code>@Transactional(REQUIRES_NEW)</code></dt>
<dd>
<p>Starts a transaction if none was started; if an existing one was started, suspends it and starts a new one for the boundary of that method</p>
</dd>
<dt><code>@Transactional(MANDATORY)</code></dt>
<dd>
<p>Fails if no transaction was started; otherwise, works within the existing transaction</p>
</dd>
<dt><code>@Transactional(SUPPORTS)</code></dt>
<dd>
<p>If a transaction was started, joins it; otherwise, works with no transaction</p>
</dd>
<dt><code>@Transactional(NOT_SUPPORTED)</code></dt>
<dd>
<p>If a transaction was started, suspends it and works with no transaction for the boundary of the method; otherwise, works with no transaction</p>
</dd>
<dt><code>@Transactional(NEVER)</code></dt>
<dd>
<p>If a transaction was started, raises an exception; otherwise, works with no 
<span class="keep-together">transaction</span></p>
</dd>
</dl>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.6 Programmatic Transaction Control"><div class="sect1" id="idm45128518251096">
<h1>7.6 Programmatic Transaction Control</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518250088">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="programmatic transaction control" id="idm45128518248888"/><a data-type="indexterm" data-primary="programmatic transaction control" id="idm45128518247848"/>You want more fine-grained control over transactions.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518246712">
<h2>Solution</h2>

<p>Inject the <code>UserTransaction</code> and use the methods of that class.</p>

<p><a data-type="indexterm" data-primary="UserTransaction class" id="idm45128518244440"/><a data-type="indexterm" data-primary="begin() method" id="idm45128518243736"/><a data-type="indexterm" data-primary="commit() method" id="idm45128518243064"/><a data-type="indexterm" data-primary="rollback() method" id="idm45128518242392"/><a data-type="indexterm" data-primary="setRollbackOnly() method" id="idm45128518241720"/><a data-type="indexterm" data-primary="getStatus() method" id="idm45128518240984"/><a data-type="indexterm" data-primary="setTransactionTimeout() method" id="idm45128518240312"/>The <code>UserTransaction</code> class has a very simple API:</p>

<ul>
<li>
<p><code>begin()</code></p>
</li>
<li>
<p><code>commit()</code></p>
</li>
<li>
<p><code>rollback()</code></p>
</li>
<li>
<p><code>setRollbackOnly()</code></p>
</li>
<li>
<p><code>getStatus()</code></p>
</li>
<li>
<p><code>setTransactionTimeout(int)</code></p>
</li>
</ul>

<p>The first three methods will be the main methods used.
<code>getStatus()</code> is useful in determining where the transaction is in its life cycle.
Lastly, you are able to set the timeout for a transaction.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If needed, you can also use the <code>javax.transaction.TransactionManager</code> by injecting it.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128518229720">
<h2>See Also</h2>

<p>For more information, visit the following web page:</p>

<ul>
<li>
<p><a href="https://oreil.ly/lmjR_">Jakarta EE 8 Specification APIs: Interface UserTransaction</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.7 Setting and Modifying a Transaction Timeout"><div class="sect1" id="setting-and-modifying-a-transaction-timeout">
<h1>7.7 Setting and Modifying a Transaction Timeout</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518224488">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="modifying transaction timeouts" id="idm45128518223288"/><a data-type="indexterm" data-primary="persistence" data-secondary="setting transaction timeouts" id="idm45128518222296"/><a data-type="indexterm" data-primary="transaction timeouts, setting/modifying" id="idm45128518221336"/>You want a transaction to time out and roll back after a certain amount of time.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518220264">
<h2>Solution</h2>

<p>Use the <code>@io.quarkus.narayana.jta.runtime.TransactionConfiguration</code> annotation if using declarative transactions; otherwise, the transaction API can be used 
<span class="keep-together">for programmatic</span> transaction control.
You can also change the global timeout 
<span class="keep-together">for transactions</span> with the <code>quarkus.transaction-manager.default-transaction-timeout</code> property, specified as a <code>java.time.Duration</code>.</p>

<p><a data-type="indexterm" data-primary="@TransactionConfiguration annotation" id="idm45128518125640"/>Modifying the timeout of a transaction for a one-off is very easy with the <code>@TransactionConfiguration</code> annotation.
Use the <code>timeout</code> attribute to set the number of 
<span class="keep-together">seconds</span> for the timeout.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518123016">
<h2>Discussion</h2>

<p>Should every transaction in the application need a longer or shorter time, use 
<span class="keep-together">the <code>quarkus.transaction-manager.default-transaction-timeout</code></span> property in <em>application.properties</em>.
That property takes a <code>java.time.Duration</code>, which can be specified as a string parsable via <code>Duration#parse()</code>.
You may also start the duration with an integer.
Quarkus will then automatically prepend <code>PT</code> to the value to create the 
<span class="keep-together">correct</span> formatting.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128518117736">
<h2>See Also</h2>

<p>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/8gvMZ">Oracle: Java Platform, Standard Edition 8 API Specification: <code>parse</code></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.8 Setup with Persistence.xml"><div class="sect1" id="idm45128518113768">
<h1>7.8 Setup with Persistence.xml</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518112760">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="JPA" id="idm45128518111560"/><a data-type="indexterm" data-primary="persistence.xml" id="idm45128518110856"/><a data-type="indexterm" data-primary="persistence" data-secondary="setting up with persistence.xml" id="idm45128518110184"/>You want to use JPA with a <em>persistence.xml</em> file.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518108456">
<h2>Solution</h2>

<p>Use JPA like you normally would; just set up the datasource in <em>application.properties</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518106424">
<h2>Discussion</h2>

<p>JPA in Quarkus works exactly as it does in other settings, so there no changes are 
<span class="keep-together">necessary.</span></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You cannot use the <code>quarkus.hibernate-orm.*</code> properties if you are using <em>persistence.xml</em>. If you are, only the persistence units defined in the 
<span class="keep-together"><em>persistence.xml</em></span> file will be available.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.9 Setup Without persistence.xml"><div class="sect1" id="idm45128518101000">
<h1>7.9 Setup Without persistence.xml</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518099976">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="setting up without persistence.xml" id="idm45128518098776"/>You want to use JPA, but without a <em>persistence.xml</em> file.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518096968">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="quarkus-hibernate-orm extension" id="idm45128518095736"/><a data-type="indexterm" data-primary="JDBC driver" id="idm45128518094968"/>Add the <code>quarkus-hibernate-orm</code> extension, the JDBC driver for your RDBMS, configuration via <em>application.properties</em>, and finally annotate your entities with <code>@Entity</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518092520">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="EntityManager" id="idm45128518091288"/>There isn’t anything special to set up using Quarkus and JPA beyond database connectivity.
Quarkus will make some opinionated choices, but don’t worry—they’re probably the choices you would have made anyway—and continue on with your entities.
You will be able to inject and utilize an <code>EntityManager</code> just as your normally would.</p>

<p>In a nutshell, you continue as you usually would with standard JPA, but without all the additional configuration of a <em>persistence.xml</em>.
This is the preferred way to use JPA in Quarkus.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.10 Using Entities from a Different JAR"><div class="sect1" id="idm45128518088360">
<h1>7.10 Using Entities from a Different JAR</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518087304">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="using entities from different JAR files" id="idm45128518086104"/><a data-type="indexterm" data-primary="JAR files" data-secondary="using entities from different" id="idm45128518085352"/><a data-type="indexterm" data-primary="entities" data-secondary="using from different JAR files" id="idm45128518084376"/>You want to include entities from a different jar.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518082968">
<h2>Solution</h2>

<p>Include an empty <em>META-INF/beans.xml</em> file in the jar containing the entities.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518080808">
<h2>Discussion</h2>

<p>Quarkus relies on compile-type bytecode enhancements to entities.
If these entities are defined in the same project (jar) as the rest of the application, everything works as it should.</p>

<p>However, if other classes such as entities or other CDI beans are defined in an external library, that library must contain an empty <em>META-INF/beans.xml</em> file to be properly indexed and enhanced.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.11 Persisting Data with Panache"><div class="sect1" id="persisting_data_panache">
<h1>7.11 Persisting Data with Panache</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518076392">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Hibernate" id="idm45128518075192"/><a data-type="indexterm" data-primary="datasources" data-secondary="persisting with Panache" id="idm45128518074488"/><a data-type="indexterm" data-primary="Panache" data-secondary="persisting data with" id="idm45128518073544"/><a data-type="indexterm" data-primary="persistence" data-secondary="of data with Panache" id="idm45128518072600"/>You want to persist data with Hibernate and Panache.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128518071208">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="persist() method" id="idm45128518070040"/>Call the <code>persist</code> method on a <code>PanacheEntity</code>.</p>

<p>Naturally, you’ll need to add the <code>quarkus-hibernate-orm-panache</code> extension, and the corresponding JDBC extension for your data store.
Next, you’ll need to define an entity.
All that entails is creating a class, annotating it with <code>@javax.persistence.Entity</code>, and extending from <code>PanacheEntity</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128518066088">
<h2>Discussion</h2>

<p>Panache is an opinionated API built on top of a traditional JPA.
It follows more of an active record approach to data entities; however, under the hood, it is done using 
<span class="keep-together">traditional</span> JPA.</p>

<p><a data-type="indexterm" data-primary="persistAndFlush() method" id="idm45128518063352"/>As you will find throughout the exploration of Panache, much of the functionality is passed on to your entities through the <code>PanacheEntity</code> or <code>PanacheEntityBase</code> parent class—<code>persist</code> is no exception to this.
<code>PanacheEntityBase</code> contains both the <code>persist()</code> and <code>persistAndFlush()</code> methods.
While the flush option will immediately send the data to the database, it is not the recommended way of persisting the data.</p>

<p>Persisting is very simple, as you can see in the following:</p>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@POST</code>
    <code class="kd">public</code> <code class="n">Response</code> <code class="nf">newLibrary</code><code class="o">(</code><code class="n">Library</code> <code class="n">library</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">library</code><code class="o">.</code><code class="na">persist</code><code class="o">();</code>
        <code class="k">return</code> <code class="n">Response</code><code class="o">.</code><code class="na">created</code><code class="o">(</code><code class="n">URI</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="s">"/library/"</code> <code class="o">+</code> <code class="n">library</code><code class="o">.</code><code class="na">encodedName</code><code class="o">()))</code>
                <code class="o">.</code><code class="na">entity</code><code class="o">(</code><code class="n">library</code><code class="o">).</code><code class="na">build</code><code class="o">();</code>
    <code class="o">}</code></pre>

<p>For completion, here is the <code>Library</code> entity:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">panache</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.io.UnsupportedEncodingException</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.net.URLEncoder</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.persistence.CascadeType</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.persistence.Entity</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.persistence.OneToMany</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.quarkus.hibernate.orm.panache.PanacheEntity</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.panache.common.Parameters</code><code class="o">;</code>

<code class="nd">@Entity</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Library</code> <code class="kd">extends</code> <code class="n">PanacheEntity</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">name</code><code class="o">;</code>

    <code class="nd">@OneToMany</code><code class="o">(</code><code class="n">cascade</code> <code class="o">=</code> <code class="n">CascadeType</code><code class="o">.</code><code class="na">ALL</code><code class="o">,</code> <code class="n">orphanRemoval</code> <code class="o">=</code> <code class="kc">true</code><code class="o">,</code>
               <code class="n">mappedBy</code> <code class="o">=</code> <code class="s">"library"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Inventory</code><code class="o">&gt;</code> <code class="n">inventory</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="nf">encodedName</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">String</code> <code class="n">result</code><code class="o">;</code>

        <code class="k">try</code> <code class="o">{</code>
            <code class="n">result</code> <code class="o">=</code> <code class="n">URLEncoder</code><code class="o">.</code><code class="na">encode</code><code class="o">(</code><code class="n">name</code><code class="o">,</code> <code class="s">"UTF-8"</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">replaceAll</code><code class="o">(</code><code class="s">"\\+"</code><code class="o">,</code> <code class="s">"%20"</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">replaceAll</code><code class="o">(</code><code class="s">"\\%21"</code><code class="o">,</code> <code class="s">"!"</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">replaceAll</code><code class="o">(</code><code class="s">"\\%27"</code><code class="o">,</code> <code class="s">"'"</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">replaceAll</code><code class="o">(</code><code class="s">"\\%28"</code><code class="o">,</code> <code class="s">"("</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">replaceAll</code><code class="o">(</code><code class="s">"\\%29"</code><code class="o">,</code> <code class="s">")"</code><code class="o">)</code>
                    <code class="o">.</code><code class="na">replaceAll</code><code class="o">(</code><code class="s">"\\%7E"</code><code class="o">,</code> <code class="s">"~"</code><code class="o">);</code>
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">UnsupportedEncodingException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>
            <code class="n">result</code> <code class="o">=</code> <code class="n">name</code><code class="o">;</code>
        <code class="o">}</code>

        <code class="k">return</code> <code class="n">result</code><code class="o">;</code>
    <code class="o">}</code>
<code class="o">}</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.12 Finding All Entity Instances with Panache listAll Method"><div class="sect1" id="idm45128518020152">
<h1>7.12 Finding All Entity Instances with Panache listAll Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128518019272">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="entities" data-secondary="finding instances with Panache listAll() method" id="idm45128518018136"/><a data-type="indexterm" data-primary="listAll() method" id="idm45128517807672"/><a data-type="indexterm" data-primary="persistence" data-secondary="finding entity instances with Panache listAll() method" id="idm45128517807000"/><a data-type="indexterm" data-primary="Panache" data-secondary="finding entity instances with listAll() method" id="idm45128517806024"/>You want to find all entries of an entity.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517804664">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="PanacheEntityBase class" id="idm45128517803256"/>Use the <code>listAll()</code> method from the <code>PanacheEntityBase</code> class.</p>

<p><a data-type="indexterm" data-primary="persist() method" id="idm45128517801240"/>Just like the <code>persist()</code> method covered in the previous recipe, <code>listAll()</code> is a method from the <code>PanacheEntityBase</code> class.
There isn’t anything special about it; it queries the database for all the entries of the given entity.
It returns those entities in a <code>List</code>:</p>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@GET</code>
    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">getAllBooks</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Book</code><code class="o">.</code><code class="na">listAll</code><code class="o">();</code>
    <code class="o">}</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This method is actually a shortcut for the <code>findAll().list()</code> chain.
More info can be found in the <code>hibernate-orm-panache</code> code base.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.13 Finding Individual Entities with Panache findById Method"><div class="sect1" id="idm45128517778568">
<h1>7.13 Finding Individual Entities with Panache findById Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517777528">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="entities" data-secondary="finding with Panache findByID() method" id="idm45128517776328"/><a data-type="indexterm" data-primary="findByID() method" id="idm45128517775384"/><a data-type="indexterm" data-primary="Panache" data-secondary="finding entities with findByID() method" id="idm45128517774712"/><a data-type="indexterm" data-primary="persistence" data-secondary="finding entities with Panache findByID() method" id="idm45128517773800"/>I want to find and load an entity from the database based on its ID.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517772376">
<h2>Solution</h2>

<p>Use <code>PanacheEntityBase.findById(Object)</code>.</p>

<p>Panache simplifies finding an entity by using the <code>findById(Object)</code> method. All you need to do is pass the ID of the object and you will be returned the correct instance from the database:</p>

<pre data-type="programlisting" data-code-language="java">    <code class="nd">@GET</code>
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/byId/{id}"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">Book</code> <code class="nf">getBookById</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="n">value</code> <code class="o">=</code> <code class="s">"id"</code><code class="o">)</code> <code class="n">Long</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">Book</code> <code class="n">b</code> <code class="o">=</code> <code class="n">Book</code><code class="o">.</code><code class="na">findById</code><code class="o">(</code><code class="n">id</code><code class="o">);</code>
        <code class="k">return</code> <code class="n">b</code><code class="o">;</code>
    <code class="o">}</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.14 Finding Entities Using Panache Find and List Methods"><div class="sect1" id="idm45128517767928">
<h1>7.14 Finding Entities Using Panache Find and List Methods</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517637800">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="entities" data-secondary="finding with Panache find() and list() methods" id="idm45128517636696"/><a data-type="indexterm" data-primary="find() method" id="idm45128517635688"/><a data-type="indexterm" data-primary="list() method" id="idm45128517635016"/><a data-type="indexterm" data-primary="Panache" data-secondary="finding entities with find() and list() methods" id="idm45128517634344"/><a data-type="indexterm" data-primary="persistence" data-secondary="finding entities with Panache find() and list() methods" id="idm45128517633368"/>You want to query the database for a specific entity based on its properties.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517632008">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="PanacheEntityBase class" id="idm45128517630600"/>Use the various instances of the <code>find</code> and <code>list</code> methods from <code>PanacheEntityBase</code>.</p>

<p>Depending on how you need the result returned, you will use either <code>list</code> or <code>find</code> from the <code>PanacheEntityBase</code>.
Internally, <code>list</code> uses <code>find</code>, so they are essentially the same:</p>

<pre data-type="programlisting" data-code-language="java">    <code class="kd">public</code> <code class="kd">static</code> <code class="n">Book</code> <code class="nf">findByTitle</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">find</code><code class="o">(</code><code class="s">"title"</code><code class="o">,</code> <code class="n">title</code><code class="o">).</code><code class="na">firstResult</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">findByAuthor</code><code class="o">(</code><code class="n">String</code> <code class="n">author</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">list</code><code class="o">(</code><code class="s">"author"</code><code class="o">,</code> <code class="n">author</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">findByIsbn</code><code class="o">(</code><code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">list</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code> <code class="n">isbn</code><code class="o">);</code>
    <code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="Parameters class" id="idm45128517608360"/><a data-type="indexterm" data-primary="HQL (Hibernate Query Language)" id="idm45128517607752"/><a data-type="indexterm" data-primary="JPQL (Java Persistence Query Language)" id="idm45128517563496"/>There are multiple overrides for both methods—they change based on the necessity of sorting and how you wish to send parameters.
The following code is an example of using Hibernate Query Language (HQL) (or Java Persistence Query Language [JPQL]) and using the <code>Parameters</code> class:</p>

<pre data-type="programlisting" data-code-language="java">    <code class="kd">public</code> <code class="kd">static</code> <code class="n">Library</code> <code class="nf">findByName</code><code class="o">(</code><code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Library</code>
                <code class="o">.</code><code class="na">find</code><code class="o">(</code><code class="s">"SELECT l FROM Library l "</code> <code class="o">+</code>
                      <code class="s">"LEFT JOIN fetch l.inventory "</code> <code class="o">+</code>
                      <code class="s">"WHERE l.name = :name "</code><code class="o">,</code>
                        <code class="n">Parameters</code><code class="o">.</code><code class="na">with</code><code class="o">(</code><code class="s">"name"</code><code class="o">,</code> <code class="n">name</code><code class="o">)).</code><code class="na">firstResult</code><code class="o">();</code>
    <code class="o">}</code></pre>

<p>The <code>Parameters</code> class override is available for both <code>find</code> and <code>list</code> methods.
Consult the API for more information.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You may be wondering, Why the full JPQL query? Put simply, it is to avoid serialization issues with the list.
Using the left join, we are able to fetch the library and all the inventory for that library.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.15 Obtaining a Count of Entities Using the Panache count Method"><div class="sect1" id="idm45128517545976">
<h1>7.15 Obtaining a Count of Entities Using the Panache count Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517544968">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="count() method" id="idm45128517543768"/><a data-type="indexterm" data-primary="entities" data-secondary="counting using Panache count() method" id="idm45128517543064"/><a data-type="indexterm" data-primary="Panache" data-secondary="counting entities using Panache count() method" id="idm45128517542104"/><a data-type="indexterm" data-primary="persistence" data-secondary="obtaining entity counts using Panache count() method" id="idm45128517500344"/>You want to get a count of items for a resource.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517498984">
<h2>Solution</h2>

<p>Use the various <code>count</code> methods from <code>PanacheEntityBase</code>.</p>

<p>Just like the <code>find</code> methods discussed earlier, Panache has various <code>count</code> method overrides available to obtain the number of entities of a given type in the database:</p>

<pre data-type="programlisting" data-code-language="java"><code class="n">Book</code><code class="o">.</code><code class="na">count</code><code class="o">()</code>
<code class="n">Book</code><code class="o">.</code><code class="na">count</code><code class="o">(</code><code class="s">"WHERE title = ?"</code><code class="o">,</code> <code class="o">)</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.16 Paginating Through Entity Lists Using the Panache page Method"><div class="sect1" id="idm45128517493304">
<h1>7.16 Paginating Through Entity Lists Using the Panache page Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517492184">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="entities" data-secondary="paginating through using Panache page9) method" id="idm45128517491048"/><a data-type="indexterm" data-primary="page() method" id="idm45128517488568"/><a data-type="indexterm" data-primary="Panache" data-secondary="paginating through using page() method" id="idm45128517487896"/><a data-type="indexterm" data-primary="persistence" data-secondary="paginating through entity lists using Panache page() method" id="idm45128517486984"/>You want to use pagination.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517485688">
<h2>Solution</h2>

<p>Quarkus, specifically Panache, has pagination built in.
There are a number of methods on the <code>PanacheQuery</code> object that support pagination.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128517483608">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="find() method" id="idm45128517446456"/>Pagination is very easy to get going.
The first step is to get an instance of a <code>PanacheQuery</code>.
This is as easy as using the <code>find</code> methods:</p>

<pre data-type="programlisting" data-code-language="java"><code class="n">PanacheQuery</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code><code> </code><code class="n">authors</code><code> </code><code class="o">=</code><code> </code><code class="n">Book</code><code class="o">.</code><code class="na">find</code><code class="o">(</code><code class="s">"author"</code><code class="o">,</code><code> </code><code class="n">author</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="n">authors</code><code class="o">.</code><code class="na">page</code><code class="o">(</code><code class="n">Page</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="mi">3</code><code class="o">,</code><code> </code><code class="mi">25</code><code class="o">)</code><code class="o">)</code><code class="o">.</code><code class="na">list</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>                        </code><a class="co" id="co_persistence_CO1-1" href="#callout_persistence_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code class="n">authors</code><code class="o">.</code><code class="na">page</code><code class="o">(</code><code class="n">Page</code><code class="o">.</code><code class="na">sizeOf</code><code class="o">(</code><code class="mi">10</code><code class="o">)</code><code class="o">)</code><code class="o">.</code><code class="na">list</code><code class="o">(</code><code class="o">)</code><code class="o">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_persistence_CO1-1" href="#co_persistence_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Pages of 25 items, starting on page 3</p></dd>
</dl>

<p><a data-type="indexterm" data-primary="firstPage() method" id="idm45128517380600"/><a data-type="indexterm" data-primary="lastPage() method" id="idm45128517379496"/><a data-type="indexterm" data-primary="nextPage() method" id="idm45128517378824"/><a data-type="indexterm" data-primary="previousPage() method" id="idm45128517378152"/><a data-type="indexterm" data-primary="hasNextPage() method" id="idm45128517377480"/><a data-type="indexterm" data-primary="hasPreviousPage() method" id="idm45128517376808"/><a data-type="indexterm" data-primary="pageCount() method" id="idm45128517376168"/>There are, of course, other methods such as <code>firstPage()</code>, <code>lastPage()</code>, <code>nextPage()</code>, and <code>previousPage()</code>.
Boolean supporting methods exist as well: <code>hasNextPage()</code>, <code>hasPreviousPage()</code>, and <code>pageCount()</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128517380200">
<h2>See Also</h2>

<p>For more information, see the following pages on GitHub:</p>

<ul>
<li>
<p><a href="https://oreil.ly/KYlsJ"><code>Page</code> object</a></p>
</li>
<li>
<p><a href="https://oreil.ly/BtgHK"><code>PanacheQuery</code> interface</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.17 Streaming Results via the Panache Stream Method"><div class="sect1" id="streaming-results-via-panache-stream">
<h1>7.17 Streaming Results via the Panache Stream Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517334312">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="streaming results via Panache stream() method" id="idm45128517333304"/><a data-type="indexterm" data-primary="Panache" data-secondary="stream() method" id="idm45128517332456"/><a data-type="indexterm" data-primary="stream() method" id="idm45128517331608"/>You want to use streams for data.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517330616">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="list() method" id="idm45128517329240"/>All <code>list</code> methods have corresponding <code>stream</code> methods when using Panache.
Below you will see how these are used, which isn’t any different than how <code>list</code> methods are used:</p>

<pre data-type="programlisting" data-code-language="java"><code class="n">Book</code><code class="o">.</code><code class="na">streamAll</code><code class="o">();</code>
<code class="o">...</code>
<code class="n">Book</code><code class="o">.</code><code class="na">stream</code><code class="o">(</code><code class="s">"author"</code><code class="o">,</code> <code class="s">"Alex Soto"</code><code class="o">);</code></pre>

<p><a data-type="indexterm" data-primary="streamAll() method" id="idm45128517317352"/>Each of the <code>stream</code> and <code>streamAll</code> methods return a <code>java.util.Stream</code> instance.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><code>stream</code> methods require a transaction to work correctly.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128517306328">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="PanacheEntityBase class" id="idm45128517305128"/>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/OW2fV">io.quarkus: <code>PanacheEntityBase</code></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.18 Testing Panache Entities"><div class="sect1" id="idm45128517301848">
<h1>7.18 Testing Panache Entities</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517300872">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="entities" data-secondary="testing Panache" id="idm45128517299672"/><a data-type="indexterm" data-primary="persistence" data-secondary="testing Panache entities" id="idm45128517298696"/><a data-type="indexterm" data-primary="testing" data-secondary="Panache entities" id="idm45128517297784"/>You want to use an embedded database for testing.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517296392">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="H2 Database Engine" id="idm45128517294984"/><a data-type="indexterm" data-primary="Derby (Apache)" id="idm45128517294280"/><a data-type="indexterm" data-primary="Apache Derby" id="idm45128517293608"/>Quarkus comes with helpers for the in-memory databases H2 and Derby to properly boot the database as a separate process.</p>

<p>Be sure to add either the <code>io.quarkus:quarkus-test-h2:1.4.1.Final</code> or the <code>i⁠o​.⁠q⁠u⁠a⁠r⁠k⁠u⁠s⁠:⁠q⁠u⁠a⁠r⁠k⁠u⁠s⁠-⁠t⁠e⁠s⁠t⁠-⁠d⁠e⁠r⁠b⁠y⁠:⁠1⁠.⁠4⁠.⁠1⁠.⁠F⁠i⁠n⁠a⁠l</code> artifacts to your build file.</p>

<p>The next step is to annotate any test using the embedded database with <code>@⁠Q⁠u⁠a⁠r⁠k⁠u⁠s​T⁠e⁠s⁠t⁠R⁠e⁠s⁠o⁠u⁠r⁠c⁠e⁠(⁠H⁠2⁠D⁠a⁠t⁠a⁠b⁠a⁠s⁠e⁠T⁠e⁠s⁠t⁠R⁠e⁠s⁠o⁠u⁠r⁠c⁠e⁠.⁠c⁠l⁠a⁠s⁠s⁠)</code> or <code>@QuarkusTestResource(DerbyDatabaseTestResource.class)</code>.
Lastly, be sure to set the correct database URL and driver for the chosen database in <em>src/test/resources/META-INF/application.properties</em>.</p>
<div style="page-break-after: always;"/>

<p>The following is an example for H2:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">my</code><code class="o">.</code><code class="na">app</code><code class="o">.</code><code class="na">integrationtests</code><code class="o">.</code><code class="na">db</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.quarkus.test.common.QuarkusTestResource</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.test.h2.H2DatabaseTestResource</code><code class="o">;</code>

<code class="nd">@QuarkusTestResource</code><code class="o">(</code><code class="n">H2DatabaseTestResource</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">TestResources</code> <code class="o">{</code>
<code class="o">}</code></pre>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.datasource.url</code><code class="o">=</code><code class="s">jdbc:h2:tcp://localhost/mem:test</code>
<code class="na">quarkus.datasource.driver</code><code class="o">=</code><code class="s">org.h2.Driver</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="JVM mode" id="idm45128517234856"/><a data-type="indexterm" data-primary="native image mode" id="idm45128517234216"/>This helper does not add the database into the native image, only the client code.
However, feel free to use this for tests against your application in JVM mode or native image mode.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128517242168">
<h2>See Also</h2>

<p>For more information, visit the following websites:</p>

<ul>
<li>
<p><a href="https://oreil.ly/_MMus">H2 Database Engine</a></p>
</li>
<li>
<p><a href="https://oreil.ly/FUFeH">Apache Derby</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.19 Using a Data Access Object (DAO) or Repository Pattern"><div class="sect1" id="idm45128517237448">
<h1>7.19 Using a Data Access Object (DAO) or Repository Pattern</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517231912">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="repository pattern" id="idm45128517230712"/><a data-type="indexterm" data-primary="persistence" data-secondary="using DAOs" id="idm45128517229736"/><a data-type="indexterm" data-primary="repository pattern" id="idm45128517228792"/><a data-type="indexterm" data-primary="DAOs (data access objects)" id="idm45128517228120"/>You want to use the DAO or the repository pattern.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517227032">
<h2>Solution</h2>

<p>Quarkus doesn’t limit with Panache; you can use the Entity pattern as previously described, a DAO, or a repository pattern.</p>

<p><a data-type="indexterm" data-primary="PanacheRepository" id="idm45128517225064"/><a data-type="indexterm" data-primary="PanacheRepositoryBase" id="idm45128517224136"/>The two interfaces you’ll need to understand to use a repository are <code>PanacheRepository</code> and <code>PanacheRepositoryBase</code>.
The base interface is necessary only if you have 
<span class="keep-together">a primary</span> key that isn’t a <code>Long</code>.
All of the same operations available on <code>PanacheEntity</code> are available on <code>PanacheRepository</code>.
A repository is a CDI bean, so it must be 
<span class="keep-together">injected</span> when it is being used.
Here are some basic examples:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">panache</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.Collections</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">io.quarkus.hibernate.orm.panache.PanacheQuery</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.hibernate.orm.panache.PanacheRepository</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.panache.common.Parameters</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">io.quarkus.panache.common.Sort</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">LibraryRepository</code> <code class="kd">implements</code> <code class="n">PanacheRepository</code><code class="o">&lt;</code><code class="n">Library</code><code class="o">&gt;</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="n">Library</code> <code class="nf">findByName</code><code class="o">(</code><code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">find</code><code class="o">(</code><code class="s">"SELECT l FROM Library l "</code> <code class="o">+</code>
                    <code class="s">"left join fetch l.inventory where l.name = :name "</code><code class="o">,</code>
                <code class="n">Parameters</code><code class="o">.</code><code class="na">with</code><code class="o">(</code><code class="s">"name"</code><code class="o">,</code> <code class="n">name</code><code class="o">)).</code><code class="na">firstResult</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">PanacheQuery</code><code class="o">&lt;</code><code class="n">Library</code><code class="o">&gt;</code> <code class="nf">findAll</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">find</code><code class="o">(</code><code class="s">"from Library l left join fetch l.inventory"</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="n">PanacheQuery</code><code class="o">&lt;</code><code class="n">Library</code><code class="o">&gt;</code> <code class="nf">findAll</code><code class="o">(</code><code class="n">Sort</code> <code class="n">sort</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="nf">find</code><code class="o">(</code><code class="s">"from Library l left join fetch l.inventory"</code><code class="o">,</code>
                <code class="n">sort</code><code class="o">,</code> <code class="n">Collections</code><code class="o">.</code><code class="na">emptyMap</code><code class="o">());</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>A DAO would work exactly as you would expect.
You would need to inject an <code>EntityManager</code> and query as normal.
There are a myriad of solutions and examples for using a DAO with Java that are available both online and in other books.
Those examples will all function the same with Quarkus.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128517168536">
<h2>See Also</h2>

<p>For more information, visit the following website:</p>

<ul>
<li>
<p><a href="https://oreil.ly/H6kTU">io.quarkus: <code>PanacheRepositoryBase</code></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.20 Using Amazon DynamoDB"><div class="sect1" id="idm45128517064232">
<h1>7.20 Using Amazon DynamoDB</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128517063256">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Amazon DynamoDB" id="amz_ab"/><a data-type="indexterm" data-primary="persistence" data-secondary="using Amazon DynamoDB" id="per_amz"/>You want to use DynamoDB with a Quarkus application.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128517059384">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="AWS SDK (Apache Amazon Web Service Software Development Kit)" id="idm45128517057816"/>Use the DynamoDB extension and setup configuration.
The DynamoDB extension allows both sync and async clients to make use of the Apache Amazon Web Service Software Development Kit (AWS SDK) client.
There are a few things necessary to 
<span class="keep-together">set up</span> and enable in your project to get this running.
The first is, of course, the 
<span class="keep-together">dependency:</span></p>

<pre data-type="programlisting" data-code-language="xml"> <code class="nt">&lt;dependency&gt;</code>
     <code class="nt">&lt;groupId&gt;</code>software.amazon.awssdk<code class="nt">&lt;/groupId&gt;</code>
     <code class="nt">&lt;artifactId&gt;</code>url-connection-client<code class="nt">&lt;/artifactId&gt;</code>
 <code class="nt">&lt;/dependency&gt;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There is no Quarkus extension for the AWS connection client.</p>
</div>

<p><a data-type="indexterm" data-primary="URLConnection HTTP client" id="idm45128517052184"/>The extension uses the URLConnection HTTP client by default.
You need to add the correct client (URLConnection, Apache, or Netty NIO) to your build script:</p>

<pre data-type="programlisting" data-code-language="xml"><code> </code><code class="nt">&lt;dependency</code><code class="nt">&gt;</code><code>
     </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>software.amazon.awssdk</code><code class="nt">&lt;/groupId&gt;</code><code>
     </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>apache-client</code><code class="nt">&lt;/artifactId&gt;</code><code>
     </code><code class="nt">&lt;exclusions</code><code class="nt">&gt;</code><code>    </code><a class="co" id="co_persistence_CO2-1" href="#callout_persistence_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
         </code><code class="nt">&lt;exclusion</code><code class="nt">&gt;</code><code>
             </code><code class="nt">&lt;groupId</code><code class="nt">&gt;</code><code>commons-logging</code><code class="nt">&lt;/groupId&gt;</code><code>
             </code><code class="nt">&lt;artifactId</code><code class="nt">&gt;</code><code>commons-logging</code><code class="nt">&lt;/artifactId&gt;</code><code>
         </code><code class="nt">&lt;/exclusion&gt;</code><code>
     </code><code class="nt">&lt;/exclusions&gt;</code><code>
 </code><code class="nt">&lt;/dependency&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_persistence_CO2-1" href="#co_persistence_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p><a data-type="indexterm" data-primary="commons-logging" id="idm45128516989544"/>You must exclude <code>commons-logging</code> to force the client to use the Quarkus logger</p></dd>
</dl>

<p>If you are using the Apache client, you will also need to make an adjustment to the 
<span class="keep-together"><em>application.properties</em></span> file because <code>url</code> is the default:</p>

<pre data-type="programlisting" data-code-language="properties"> <code class="na">quarkus.dynamodb.sync-client.type</code><code class="o">=</code><code class="s">apache</code></pre>

<p>There are also configurations for the client in <em>application.properties</em> (please see the <a href="https://oreil.ly/HZ4A-">properties references</a> for more):</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.dynamodb.endpoint-override</code><code class="o">=</code><code class="s">http://localhost:8000                       </code><a class="co" id="co_persistence_CO3-1" href="#callout_persistence_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="na">quarkus.dynamodb.aws.region</code><code class="o">=</code><code class="s">eu-central-1                                       </code><a class="co" id="co_persistence_CO3-2" href="#callout_persistence_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="na">quarkus.dynamodb.aws.credentials.type</code><code class="o">=</code><code class="s">static                                   </code><a class="co" id="co_persistence_CO3-3" href="#callout_persistence_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="na">quarkus.dynamodb.aws.credentials.static-provider.access-key-id</code><code class="o">=</code><code class="s">test-key</code><code>
</code><code class="na">quarkus.dynamodb.aws.credentials.static-provider.secret-access-key</code><code class="o">=</code><code class="s">test-secret</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_persistence_CO3-1" href="#co_persistence_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Useful if using a nonstandard endpoint, such as a local DynamoDB instance</p></dd>
<dt><a class="co" id="callout_persistence_CO3-2" href="#co_persistence_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Correct, and valid, region</p></dd>
<dt><a class="co" id="callout_persistence_CO3-3" href="#co_persistence_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p><code>static</code> or <code>default</code></p></dd>
</dl>

<p><a data-type="indexterm" data-primary="Amazon EC2" id="idm45128516864056"/>The <code>default</code> credential type will look for credentials in order:</p>

<ul>
<li>
<p>System properties <code>aws.accessKeyId</code> and <code>aws.secretKey</code></p>
</li>
<li>
<p>Environment variables <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></p>
</li>
<li>
<p>Credential profiles at the default location (<em>$HOME/.aws/credentials</em>)</p>
</li>
<li>
<p>Credentials delivered through the Amazon EC2 container service</p>
</li>
<li>
<p>Instance profile credentials delivered through Amazon EC2 metadata service</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128517058792">
<h2>Discussion</h2>

<p>The following example is from <a data-type="xref" href="#persisting_data_panache">Recipe 7.11</a>, but with DynamoDB as the persistence store.</p>

<p>Here are the two classes used to talk to DynamoDB and create an injectable service to be used in the REST endpoint:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">dynamodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.stream.Collectors</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">software.amazon.awssdk.services.dynamodb.DynamoDbClient</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookSyncService</code> <code class="kd">extends</code> <code class="n">AbstractBookService</code> <code class="o">{</code>
    <code class="nd">@Inject</code>
    <code class="n">DynamoDbClient</code> <code class="n">dynamoDbClient</code><code class="o">;</code>

    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">findAll</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">dynamoDbClient</code><code class="o">.</code><code class="na">scanPaginator</code><code class="o">(</code><code class="n">scanRequest</code><code class="o">()).</code><code class="na">items</code><code class="o">().</code><code class="na">stream</code><code class="o">()</code>
                <code class="o">.</code><code class="na">map</code><code class="o">(</code><code class="nl">Book:</code><code class="o">:</code><code class="n">from</code><code class="o">)</code>
                <code class="o">.</code><code class="na">collect</code><code class="o">(</code><code class="n">Collectors</code><code class="o">.</code><code class="na">toList</code><code class="o">());</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">add</code><code class="o">(</code><code class="n">Book</code> <code class="n">b</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">dynamoDbClient</code><code class="o">.</code><code class="na">putItem</code><code class="o">(</code><code class="n">putRequest</code><code class="o">(</code><code class="n">b</code><code class="o">));</code>
        <code class="k">return</code> <code class="nf">findAll</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Book</code> <code class="nf">get</code><code class="o">(</code><code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Book</code><code class="o">.</code><code class="na">from</code><code class="o">(</code><code class="n">dynamoDbClient</code><code class="o">.</code><code class="na">getItem</code><code class="o">(</code><code class="n">getRequest</code><code class="o">(</code><code class="n">isbn</code><code class="o">)).</code><code class="na">item</code><code class="o">());</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>The following abstract class contains boilerplate code needed to talk to DynamoDB and persist and query <code>Book</code> instances:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">dynamodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.HashMap</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Map</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">software.amazon.awssdk.services.dynamodb.model.AttributeValue</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">software.amazon.awssdk.services.dynamodb.model.GetItemRequest</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">software.amazon.awssdk.services.dynamodb.model.PutItemRequest</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">software.amazon.awssdk.services.dynamodb.model.ScanRequest</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">abstract</code> <code class="kd">class</code> <code class="nc">AbstractBookService</code> <code class="o">{</code>

    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">BOOK_TITLE</code> <code class="o">=</code> <code class="s">"title"</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">BOOK_ISBN</code> <code class="o">=</code> <code class="s">"isbn"</code><code class="o">;</code>
    <code class="kd">public</code> <code class="kd">final</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">BOOK_AUTHOR</code> <code class="o">=</code> <code class="s">"author"</code><code class="o">;</code>

    <code class="kd">public</code> <code class="n">String</code> <code class="nf">getTableName</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="s">"QuarkusBook"</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">protected</code> <code class="n">ScanRequest</code> <code class="nf">scanRequest</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">ScanRequest</code><code class="o">.</code><code class="na">builder</code><code class="o">().</code><code class="na">tableName</code><code class="o">(</code><code class="n">getTableName</code><code class="o">()).</code><code class="na">build</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="kd">protected</code> <code class="n">PutItemRequest</code> <code class="nf">putRequest</code><code class="o">(</code><code class="n">Book</code> <code class="n">book</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">AttributeValue</code><code class="o">&gt;</code> <code class="n">item</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;&gt;();</code>
        <code class="n">item</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">BOOK_ISBN</code><code class="o">,</code> <code class="n">AttributeValue</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
                            <code class="o">.</code><code class="na">s</code><code class="o">(</code><code class="n">book</code><code class="o">.</code><code class="na">getIsbn</code><code class="o">()).</code><code class="na">build</code><code class="o">());</code>
        <code class="n">item</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">BOOK_AUTHOR</code><code class="o">,</code> <code class="n">AttributeValue</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
                              <code class="o">.</code><code class="na">s</code><code class="o">(</code><code class="n">book</code><code class="o">.</code><code class="na">getAuthor</code><code class="o">()).</code><code class="na">build</code><code class="o">());</code>
        <code class="n">item</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">BOOK_TITLE</code><code class="o">,</code> <code class="n">AttributeValue</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
                             <code class="o">.</code><code class="na">s</code><code class="o">(</code><code class="n">book</code><code class="o">.</code><code class="na">getTitle</code><code class="o">()).</code><code class="na">build</code><code class="o">());</code>

        <code class="k">return</code> <code class="n">PutItemRequest</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
                <code class="o">.</code><code class="na">tableName</code><code class="o">(</code><code class="n">getTableName</code><code class="o">())</code>
                <code class="o">.</code><code class="na">item</code><code class="o">(</code><code class="n">item</code><code class="o">)</code>
                <code class="o">.</code><code class="na">build</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="kd">protected</code> <code class="n">GetItemRequest</code> <code class="nf">getRequest</code><code class="o">(</code><code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code> <code class="n">AttributeValue</code><code class="o">&gt;</code> <code class="n">key</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;&gt;();</code>
        <code class="n">key</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">BOOK_ISBN</code><code class="o">,</code> <code class="n">AttributeValue</code><code class="o">.</code><code class="na">builder</code><code class="o">().</code><code class="na">s</code><code class="o">(</code><code class="n">isbn</code><code class="o">).</code><code class="na">build</code><code class="o">());</code>

        <code class="k">return</code> <code class="n">GetItemRequest</code><code class="o">.</code><code class="na">builder</code><code class="o">()</code>
                <code class="o">.</code><code class="na">tableName</code><code class="o">(</code><code class="n">getTableName</code><code class="o">())</code>
                <code class="o">.</code><code class="na">key</code><code class="o">(</code><code class="n">key</code><code class="o">)</code>
                <code class="o">.</code><code class="na">build</code><code class="o">();</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>This last class is the class representing the <code>Book</code> entity:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">dynamodb</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.Map</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.Objects</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.runtime.annotations.RegisterForReflection</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">software.amazon.awssdk.services.dynamodb.model.AttributeValue</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@RegisterForReflection</code><code>      </code><a class="co" id="co_persistence_CO4-1" href="#callout_persistence_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Book</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">String</code><code> </code><code class="n">author</code><code class="o">;</code><code>
</code><code>    </code><code class="kd">private</code><code> </code><code class="n">String</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="nf">Book</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>         </code><a class="co" id="co_persistence_CO4-2" href="#callout_persistence_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Book</code><code> </code><code class="nf">from</code><code class="o">(</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="o">,</code><code> </code><code class="n">AttributeValue</code><code class="o">&gt;</code><code> </code><code class="n">item</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="n">Book</code><code> </code><code class="n">b</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="n">Book</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">item</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="kc">null</code><code> </code><code class="o">&amp;</code><code class="o">&amp;</code><code> </code><code class="o">!</code><code class="n">item</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>            </code><code class="n">b</code><code class="o">.</code><code class="na">setAuthor</code><code class="o">(</code><code class="n">item</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">AbstractBookService</code><code class="o">.</code><code class="na">BOOK_AUTHOR</code><code class="o">)</code><code class="o">.</code><code class="na">s</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">b</code><code class="o">.</code><code class="na">setIsbn</code><code class="o">(</code><code class="n">item</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">AbstractBookService</code><code class="o">.</code><code class="na">BOOK_ISBN</code><code class="o">)</code><code class="o">.</code><code class="na">s</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>            </code><code class="n">b</code><code class="o">.</code><code class="na">setTitle</code><code class="o">(</code><code class="n">item</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">AbstractBookService</code><code class="o">.</code><code class="na">BOOK_TITLE</code><code class="o">)</code><code class="o">.</code><code class="na">s</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">;</code><code>
</code><code>        </code><code class="o">}</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">b</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">getIsbn</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">setIsbn</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">isbn</code><code> </code><code class="o">=</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">getAuthor</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">author</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">setAuthor</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">author</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">author</code><code> </code><code class="o">=</code><code> </code><code class="n">author</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="nf">getTitle</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">void</code><code> </code><code class="nf">setTitle</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">title</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">this</code><code class="o">.</code><code class="na">title</code><code> </code><code class="o">=</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@Override</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">boolean</code><code> </code><code class="nf">equals</code><code class="o">(</code><code class="n">Object</code><code> </code><code class="n">o</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="k">this</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="n">o</code><code class="o">)</code><code> </code><code class="k">return</code><code> </code><code class="kc">true</code><code class="o">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="o">(</code><code class="n">o</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="kc">null</code><code> </code><code class="o">|</code><code class="o">|</code><code> </code><code class="n">getClass</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="n">o</code><code class="o">.</code><code class="na">getClass</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code> </code><code class="k">return</code><code> </code><code class="kc">false</code><code class="o">;</code><code>
</code><code>        </code><code class="n">Book</code><code> </code><code class="n">book</code><code> </code><code class="o">=</code><code> </code><code class="o">(</code><code class="n">Book</code><code class="o">)</code><code> </code><code class="n">o</code><code class="o">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">isbn</code><code class="o">,</code><code> </code><code class="n">book</code><code class="o">.</code><code class="na">isbn</code><code class="o">)</code><code> </code><code class="o">&amp;</code><code class="o">&amp;</code><code>
</code><code>                </code><code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">author</code><code class="o">,</code><code> </code><code class="n">book</code><code class="o">.</code><code class="na">author</code><code class="o">)</code><code> </code><code class="o">&amp;</code><code class="o">&amp;</code><code>
</code><code>                </code><code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">title</code><code class="o">,</code><code> </code><code class="n">book</code><code class="o">.</code><code class="na">title</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="nd">@Override</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kt">int</code><code> </code><code class="nf">hashCode</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Objects</code><code class="o">.</code><code class="na">hash</code><code class="o">(</code><code class="n">isbn</code><code class="o">,</code><code> </code><code class="n">author</code><code class="o">,</code><code> </code><code class="n">title</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_persistence_CO4-1" href="#co_persistence_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Necessary to have reflection in a native application</p></dd>
<dt><a class="co" id="callout_persistence_CO4-2" href="#co_persistence_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Required by DynamoDB client</p></dd>
</dl>

<p>Most of this is standard DynamoDB code, with the exception of the Quarkus annotation registering the <code>Book</code> class for reflection, which is necessary only if you are 
<span class="keep-together">creating</span> a native image.</p>

<p>As you can see, the skills you have already acquired while working previously with DynamoDB are still usable without much modification when working with Quarkus, which helps you be more productive<a data-type="indexterm" data-primary="" data-startref="amz_ab" id="idm45128514300488"/><a data-type="indexterm" data-primary="" data-startref="per_amz" id="idm45128514299512"/>.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.21 Working with MongoDB"><div class="sect1" id="working_mongodb">
<h1>7.21 Working with MongoDB</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128514245896">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="MongoDB" data-secondary="working with" id="mong_ab"/><a data-type="indexterm" data-primary="persistence" data-secondary="working with MongoDB" id="per_mong"/>You want to use MongoDB as a persistent store.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128514325688">
<h2>Solution</h2>

<p>The Quarkus MongoDB extension makes use of the MongoDB Driver and Client.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128514255400">
<h2>Discussion</h2>

<p>By now you should be familiar with the basics of a RESTful resource and Quarkus configuration.
Here we’ll show the code and example configuration used to talk to a local MongoDB instance.</p>

<p>Naturally, you’ll need to add the connection information to your application:</p>

<pre data-type="programlisting" data-code-language="properties"><code class="na">quarkus.mongodb.connection-string</code> <code class="o">=</code> <code class="s">mongodb://localhost:27017</code></pre>

<p><a data-type="indexterm" data-primary="Book class" id="idm45128514266024"/>The <code>Book</code> class is a representation of the document within MongoDB:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">mongodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.HashSet</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Objects</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Set</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">org.bson.Document</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Book</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">id</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">;</code>
    <code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">;</code>

    <code class="c1">// Needed for JSON-B</code>
    <code class="kd">public</code> <code class="nf">Book</code><code class="o">()</code> <code class="o">{}</code>

    <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">,</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">authors</code> <code class="o">=</code> <code class="n">authors</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">id</code><code class="o">,</code> <code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">,</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
        <code class="k">this</code><code class="o">.</code><code class="na">authors</code> <code class="o">=</code> <code class="n">authors</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kd">static</code> <code class="n">Book</code> <code class="nf">from</code><code class="o">(</code><code class="n">Document</code> <code class="n">doc</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">Book</code><code class="o">(</code><code class="n">doc</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="s">"id"</code><code class="o">),</code>
                        <code class="n">doc</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="s">"title"</code><code class="o">),</code>
                        <code class="n">doc</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">),</code>
                        <code class="k">new</code> <code class="n">HashSet</code><code class="o">&lt;&gt;(</code><code class="n">doc</code><code class="o">.</code><code class="na">getList</code><code class="o">(</code><code class="s">"authors"</code><code class="o">,</code> <code class="n">String</code><code class="o">.</code><code class="na">class</code><code class="o">)));</code>
    <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">equals</code><code class="o">(</code><code class="n">Object</code> <code class="n">o</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">if</code> <code class="o">(</code><code class="k">this</code> <code class="o">==</code> <code class="n">o</code><code class="o">)</code> <code class="k">return</code> <code class="kc">true</code><code class="o">;</code>
        <code class="k">if</code> <code class="o">(</code><code class="n">o</code> <code class="o">==</code> <code class="kc">null</code> <code class="o">||</code> <code class="n">getClass</code><code class="o">()</code> <code class="o">!=</code> <code class="n">o</code><code class="o">.</code><code class="na">getClass</code><code class="o">())</code> <code class="k">return</code> <code class="kc">false</code><code class="o">;</code>
        <code class="n">Book</code> <code class="n">book</code> <code class="o">=</code> <code class="o">(</code><code class="n">Book</code><code class="o">)</code> <code class="n">o</code><code class="o">;</code>
        <code class="k">return</code> <code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">id</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">id</code><code class="o">)</code> <code class="o">&amp;&amp;</code>
                <code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">title</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">title</code><code class="o">)</code> <code class="o">&amp;&amp;</code>
                <code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">isbn</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">isbn</code><code class="o">)</code> <code class="o">&amp;&amp;</code>
                <code class="n">Objects</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="n">authors</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">authors</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@Override</code>
    <code class="kd">public</code> <code class="kt">int</code> <code class="nf">hashCode</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">Objects</code><code class="o">.</code><code class="na">hash</code><code class="o">(</code><code class="n">id</code><code class="o">,</code> <code class="n">title</code><code class="o">,</code> <code class="n">isbn</code><code class="o">,</code> <code class="n">authors</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>This service class acts as a DAO, a way into the MongoDB instance:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">mongodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Objects</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">com.mongodb.client.MongoClient</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">com.mongodb.client.MongoCollection</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">com.mongodb.client.MongoCursor</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">com.mongodb.client.model.Filters</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.bson.Document</code><code class="o">;</code>

<code class="nd">@ApplicationScoped</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookService</code> <code class="o">{</code>

    <code class="nd">@Inject</code>
    <code class="n">MongoClient</code> <code class="n">mongoClient</code><code class="o">;</code>

    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">list</code><code class="o">()</code> <code class="o">{</code>
        <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="n">list</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>

        <code class="k">try</code> <code class="o">(</code><code class="n">MongoCursor</code><code class="o">&lt;</code><code class="n">Document</code><code class="o">&gt;</code> <code class="n">cursor</code> <code class="o">=</code> <code class="n">getCollection</code><code class="o">()</code>
                                            <code class="o">.</code><code class="na">find</code><code class="o">()</code>
                                            <code class="o">.</code><code class="na">iterator</code><code class="o">())</code> <code class="o">{</code>
            <code class="n">cursor</code><code class="o">.</code><code class="na">forEachRemaining</code><code class="o">(</code><code class="n">doc</code> <code class="o">-&gt;</code> <code class="n">list</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">Book</code><code class="o">.</code><code class="na">from</code><code class="o">(</code><code class="n">doc</code><code class="o">)));</code>
        <code class="o">}</code>

        <code class="k">return</code> <code class="n">list</code><code class="o">;</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="n">Book</code> <code class="nf">findSingle</code><code class="o">(</code><code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">Document</code> <code class="n">document</code> <code class="o">=</code> <code class="n">Objects</code><code class="o">.</code><code class="na">requireNonNull</code><code class="o">(</code><code class="n">getCollection</code><code class="o">()</code>
                <code class="o">.</code><code class="na">find</code><code class="o">(</code><code class="n">Filters</code><code class="o">.</code><code class="na">eq</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code> <code class="n">isbn</code><code class="o">))</code>
                <code class="o">.</code><code class="na">limit</code><code class="o">(</code><code class="mi">1</code><code class="o">).</code><code class="na">first</code><code class="o">());</code>
        <code class="k">return</code> <code class="n">Book</code><code class="o">.</code><code class="na">from</code><code class="o">(</code><code class="n">document</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">add</code><code class="o">(</code><code class="n">Book</code> <code class="n">b</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">Document</code> <code class="n">doc</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Document</code><code class="o">()</code>
                <code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">isbn</code><code class="o">)</code>
                <code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"title"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">title</code><code class="o">)</code>
                <code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="s">"authors"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">authors</code><code class="o">);</code>
        <code class="n">getCollection</code><code class="o">().</code><code class="na">insertOne</code><code class="o">(</code><code class="n">doc</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="kd">private</code> <code class="n">MongoCollection</code><code class="o">&lt;</code><code class="n">Document</code><code class="o">&gt;</code> <code class="nf">getCollection</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">mongoClient</code><code class="o">.</code><code class="na">getDatabase</code><code class="o">(</code><code class="s">"book"</code><code class="o">).</code><code class="na">getCollection</code><code class="o">(</code><code class="s">"book"</code><code class="o">);</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p>Lastly, a RESTful resource makes use of the previous two classes:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">mongodb</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.List</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">javax.inject.Inject</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Consumes</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.POST</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.PathParam</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.Produces</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.MediaType</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.Response</code><code class="o">;</code>

<code class="nd">@Path</code><code class="o">(</code><code class="s">"/book"</code><code class="o">)</code>
<code class="nd">@Produces</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>
<code class="nd">@Consumes</code><code class="o">(</code><code class="n">MediaType</code><code class="o">.</code><code class="na">APPLICATION_JSON</code><code class="o">)</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookResource</code> <code class="o">{</code>
    <code class="nd">@Inject</code>
    <code class="n">BookService</code> <code class="n">service</code><code class="o">;</code>

    <code class="nd">@GET</code>
    <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code> <code class="nf">getAll</code><code class="o">()</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">list</code><code class="o">();</code>
    <code class="o">}</code>

    <code class="nd">@GET</code>
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"{isbn}"</code><code class="o">)</code>
    <code class="kd">public</code> <code class="n">Book</code> <code class="nf">getSingle</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">)</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">findSingle</code><code class="o">(</code><code class="n">isbn</code><code class="o">);</code>
    <code class="o">}</code>

    <code class="nd">@POST</code>
    <code class="kd">public</code> <code class="n">Response</code> <code class="nf">add</code><code class="o">(</code><code class="n">Book</code> <code class="n">b</code><code class="o">)</code> <code class="o">{</code>
        <code class="n">service</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">b</code><code class="o">);</code>
        <code class="k">return</code> <code class="n">Response</code><code class="o">.</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">CREATED</code><code class="o">)</code>
                <code class="o">.</code><code class="na">entity</code><code class="o">(</code><code class="n">service</code><code class="o">.</code><code class="na">list</code><code class="o">()).</code><code class="na">build</code><code class="o">();</code>
    <code class="o">}</code>
<code class="o">}</code></pre>

<p><a data-type="indexterm" data-primary="BSON Codec" id="idm45128515353240"/>We’ll leave it as an exercise for the reader to create and use a BSON Codec.
One of the other handy features of the MongoDB extension is an automatic health check 
<span class="keep-together">that runs</span> when using the <code>quarkus-smallrye-health</code> extension.
The <code>quarkus-smallrye-health</code> extension will automatically create a readiness health check for your 
<span class="keep-together">MongoDB</span> connection.
The readiness check, of course, is configurable.</p>

<p><a data-type="indexterm" data-primary="" data-startref="mong_ab" id="idm45128515204440"/><a data-type="indexterm" data-primary="" data-startref="per_mong" id="idm45128515203464"/>The Quarkus MongoDB extension also includes a reactive client, which will be detailed in <a data-type="xref" href="ch15.xhtml#using-reactive-mongodb-client-recipe">Recipe 15.12</a>.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.22 Using Panache with MongoDB"><div class="sect1" id="idm45128514255080">
<h1>7.22 Using Panache with MongoDB</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128515200536">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="using Panache with MongoDB" id="idm45128515199336"/><a data-type="indexterm" data-primary="MongoDB" data-secondary="using Panache with" id="idm45128515198392"/><a data-type="indexterm" data-primary="Panache" data-secondary="using with MongoDB" id="idm45128515197448"/>You want to use Panache with MongoDB.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128515196120">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="mongodb-panache extension" id="idm45128515194712"/><a data-type="indexterm" data-primary="PanacheMongoEntity" id="idm45128515194040"/>Add the <code>mongodb-panache</code> extension and use all the Panache abilities with <code>PanacheMongoEntity</code>.</p>

<p>Panache for MongoDB works the same as Panache for Hibernate, which we saw in recipes
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#setting-and-modifying-a-transaction-timeout">7.7</a> through <a data-type="xref" data-xrefstyle="select:labelnumber" href="#streaming-results-via-panache-stream">7.17</a>.
It significantly simplifies your entity code<a data-type="indexterm" data-primary="@MongoEntity annotation" id="idm45128515189320"/>:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code><code> </code><code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">mongodb</code><code class="o">.</code><code class="na">panache</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.time.LocalDate</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">java.util.List</code><code class="o">;</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.mongodb.panache.MongoEntity</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">io.quarkus.mongodb.panache.PanacheMongoEntity</code><code class="o">;</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">org.bson.codecs.pojo.annotations.BsonProperty</code><code class="o">;</code><code>
</code><code>
</code><code class="nd">@MongoEntity</code><code class="o">(</code><code class="n">collection</code><code> </code><code class="o">=</code><code> </code><code class="s">"book"</code><code class="o">,</code><code> </code><code class="n">database</code><code> </code><code class="o">=</code><code> </code><code class="s">"book"</code><code class="o">)</code><code>    </code><a class="co" id="co_persistence_CO5-1" href="#callout_persistence_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kd">public</code><code> </code><code class="kd">class</code><code> </code><code class="nc">Book</code><code> </code><code class="kd">extends</code><code> </code><code class="n">PanacheMongoEntity</code><code> </code><code class="o">{</code><code>          </code><a class="co" id="co_persistence_CO5-2" href="#callout_persistence_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="n">title</code><code class="o">;</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">;</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code> </code><code class="n">authors</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="nd">@BsonProperty</code><code class="o">(</code><code class="s">"pubDate"</code><code class="o">)</code><code>                            </code><a class="co" id="co_persistence_CO5-3" href="#callout_persistence_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="n">LocalDate</code><code> </code><code class="n">publishDate</code><code class="o">;</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">Book</code><code> </code><code class="nf">findByIsbn</code><code class="o">(</code><code class="n">String</code><code> </code><code class="n">isbn</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">find</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code><code> </code><code class="n">isbn</code><code class="o">)</code><code class="o">.</code><code class="na">firstResult</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code> </code><a class="co" id="co_persistence_CO5-4" href="#callout_persistence_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code>    </code><code class="kd">public</code><code> </code><code class="kd">static</code><code> </code><code class="n">List</code><code class="o">&lt;</code><code class="n">Book</code><code class="o">&gt;</code><code> </code><code class="nf">findPublishedOn</code><code class="o">(</code><code class="n">LocalDate</code><code> </code><code class="n">date</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">list</code><code class="o">(</code><code class="s">"pubDate"</code><code class="o">,</code><code> </code><code class="n">date</code><code class="o">)</code><code class="o">;</code><code>
</code><code>    </code><code class="o">}</code><code>
</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_persistence_CO5-1" href="#co_persistence_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The optional <code>@MongoEntity</code> annotation allows you to customize the database and/or 
<span class="keep-together">collection</span> used</p></dd>
<dt><a class="co" id="callout_persistence_CO5-2" href="#co_persistence_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The required part—add your fields as public fields</p></dd>
<dt><a class="co" id="callout_persistence_CO5-3" href="#co_persistence_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Customize the serialized field name with <code>@BsonProperty</code></p></dd>
<dt><a class="co" id="callout_persistence_CO5-4" href="#co_persistence_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Query using PanacheQL (subset of JPQL), just like with JPA</p></dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128515496040">
<h2>Discussion</h2>

<p>The Panache MongoDB extension uses the <code>PojoCodecProvider</code> to map entites to a MongoDB <code>Document</code>.
Besides <code>@BsonProperty</code>, you can also ignore fields with 
<span class="keep-together"><code>@BsonIgnore</code>.</span>
You are also able to set up custom IDs with <code>@BsonId</code> and extend 
<span class="keep-together"><code>PanacheMongoEntityBase</code>.</span></p>

<p>Of course, if you need to write accessor methods, Panache doesn’t stop you from doing that; in fact, at build time all the field calls are replaced with the corresponding accessor/mutator calls.
Just like Panache for Hibernate, the MongoDB version 
<span class="keep-together">supports</span> pagination, sorting, streams, and the rest of the Panache API.</p>

<p>The PanacheQL query you see in the previous example is easy to use and understand; but if you prefer to use regular MongoDB queries, those are also supported, provided that the query starts with <code>{</code>.</p>

<p><a data-type="indexterm" data-primary="find() method" id="idm45128515444136"/>A slight difference between the Hibernate and MongoDB Panache varieties is 
<span class="keep-together">MongoDB’s</span> ability to use Query Projection on the return of a <code>find()</code> method.
This allows you to restrict which fields are returned from the database.
Here is a very basic 
<span class="keep-together">example</span> with our <code>Book</code> entity:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">import</code> <code class="nn">io.quarkus.mongodb.panache.ProjectionFor</code><code class="o">;</code>

<code class="nd">@ProjectionFor</code><code class="o">(</code><code class="n">Book</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookTitle</code> <code class="o">{</code>
    <code class="kd">public</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
<code class="o">}</code>

<code class="n">PanacheQuery</code><code class="o">&lt;</code><code class="n">BookTitle</code><code class="o">&gt;</code> <code class="n">query</code> <code class="o">=</code> <code class="n">Book</code><code class="o">.</code><code class="na">find</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">,</code> <code class="s">"978-1-492-06265-3"</code><code class="o">)</code>
                                    <code class="o">.</code><code class="na">project</code><code class="o">(</code><code class="n">BookTitle</code><code class="o">.</code><code class="na">class</code><code class="o">);</code></pre>

<p>If you have a hierarchy of projection classes, the parent class(es) will also need to be annotated with <code>@ProjectionFor</code>.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.23 Using Neo4j with Quarkus"><div class="sect1" id="neo4j_with_quarkus">
<h1>7.23 Using Neo4j with Quarkus</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128515085576">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Neo4j" id="neo_ab"/><a data-type="indexterm" data-primary="persistence" data-secondary="using Neo4j with Quarkus" id="per_neo"/><a data-type="indexterm" data-primary="Quarkus" data-secondary="using Neo4j with" id="qu_neo"/>You want to connect to and use Neo4j.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128515080616">
<h2>Solution</h2>

<p>Use the Quarkus Neo4j extension based on the Neo4j Java Driver.</p>

<p>The following examples make use of the asynchronous programming model (based on JDK’s completable futures).
The driver also makes use of a blocking model, similar to JDBC, and a reactive model.
The reactive model is available only to Neo4j 4+ 
<span class="keep-together">versions</span>.</p>

<p>By now you’ve seen how to add additional extensions to your project, so we won’t cover that here.
The following example also manages books, like others before it:</p>

<pre data-type="programlisting" data-code-language="java"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">neo4j</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">java.util.HashSet</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.Set</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">java.util.StringJoiner</code><code class="o">;</code>

<code class="kn">import</code> <code class="nn">org.neo4j.driver.Values</code><code class="o">;</code>
<code class="kn">import</code> <code class="nn">org.neo4j.driver.types.Node</code><code class="o">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Book</code> <code class="o">{</code>
  <code class="kd">public</code> <code class="n">Long</code> <code class="n">id</code><code class="o">;</code>
  <code class="kd">public</code> <code class="n">String</code> <code class="n">title</code><code class="o">;</code>
  <code class="kd">public</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">;</code>
  <code class="kd">public</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">;</code>

  <code class="c1">// Needed for JSON-B</code>
  <code class="kd">public</code> <code class="nf">Book</code><code class="o">()</code> <code class="o">{}</code>

  <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
  <code class="o">}</code>

  <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
    <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
  <code class="o">}</code>

  <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">,</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
    <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
    <code class="k">this</code><code class="o">.</code><code class="na">authors</code> <code class="o">=</code> <code class="n">authors</code><code class="o">;</code>
  <code class="o">}</code>

  <code class="kd">public</code> <code class="nf">Book</code><code class="o">(</code><code class="n">Long</code> <code class="n">id</code><code class="o">,</code> <code class="n">String</code> <code class="n">title</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">,</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">authors</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">this</code><code class="o">.</code><code class="na">id</code> <code class="o">=</code> <code class="n">id</code><code class="o">;</code>
    <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">=</code> <code class="n">title</code><code class="o">;</code>
    <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">=</code> <code class="n">isbn</code><code class="o">;</code>
    <code class="k">this</code><code class="o">.</code><code class="na">authors</code> <code class="o">=</code> <code class="n">authors</code><code class="o">;</code>
  <code class="o">}</code>

  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Book</code> <code class="nf">from</code><code class="o">(</code><code class="n">Node</code> <code class="n">node</code><code class="o">)</code> <code class="o">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nf">Book</code><code class="o">(</code><code class="n">node</code><code class="o">.</code><code class="na">id</code><code class="o">(),</code>
        <code class="n">node</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"title"</code><code class="o">).</code><code class="na">asString</code><code class="o">(),</code>
        <code class="n">node</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"isbn"</code><code class="o">).</code><code class="na">asString</code><code class="o">(),</code>
        <code class="k">new</code> <code class="n">HashSet</code><code class="o">&lt;&gt;(</code>
          <code class="n">node</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"authors"</code><code class="o">)</code>
          <code class="o">.</code><code class="na">asList</code><code class="o">(</code><code class="n">Values</code><code class="o">.</code><code class="na">ofString</code><code class="o">())</code>
          <code class="o">)</code>
        <code class="o">);</code>
  <code class="o">}</code>

  <code class="kd">public</code> <code class="n">String</code> <code class="nf">toJson</code><code class="o">()</code> <code class="o">{</code>
    <code class="kd">final</code> <code class="n">StringJoiner</code> <code class="n">authorString</code> <code class="o">=</code>
      <code class="k">new</code> <code class="nf">StringJoiner</code><code class="o">(</code><code class="s">"\",\""</code><code class="o">,</code> <code class="s">"[\""</code><code class="o">,</code> <code class="s">"\"]"</code><code class="o">);</code>

    <code class="n">authors</code><code class="o">.</code><code class="na">forEach</code><code class="o">(</code><code class="nl">authorString:</code><code class="o">:</code><code class="n">add</code><code class="o">);</code>

    <code class="k">return</code> <code class="s">"{"</code> <code class="o">+</code>
      <code class="s">"\"title\":\""</code> <code class="o">+</code> <code class="k">this</code><code class="o">.</code><code class="na">title</code> <code class="o">+</code> <code class="s">"\","</code> <code class="o">+</code>
      <code class="s">"\"isbn\":\""</code> <code class="o">+</code> <code class="k">this</code><code class="o">.</code><code class="na">isbn</code> <code class="o">+</code> <code class="s">"\","</code> <code class="o">+</code>
      <code class="s">"\"authors\":"</code> <code class="o">+</code> <code class="n">authorString</code><code class="o">.</code><code class="na">toString</code><code class="o">()</code> <code class="o">+</code>
      <code class="s">"}"</code><code class="o">;</code>
  <code class="o">}</code>
<code class="o">}</code></pre>

<p>Naturally, you will need to configure the client.
This can be as easy as setting 
<span class="keep-together">the <code>quarkus.neo4j.uri</code>,</span> <code>quarkus.neo4j.authentication.username</code>, and <code>q⁠u⁠a⁠r⁠k⁠u⁠s​.⁠n⁠e⁠o⁠4⁠j⁠.⁠a⁠u⁠t⁠h⁠e⁠n⁠t⁠i⁠c⁠a⁠t⁠i⁠o⁠n⁠.⁠p⁠a⁠s⁠s⁠w⁠o⁠r⁠d</code> properties.
You can consult the extension for more 
<span class="keep-together">properties</span>.</p>

<p>The first thing you will need to configure the client is the Neo4j Driver.
The extension provides an injectable instance:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code>
<code class="n">Driver</code> <code class="n">driver</code><code class="o">;</code></pre>

<p>Next, create a new REST resource and add the Driver injection point, then add the basic CRUD operations:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code><code>
</code><code class="kd">public</code><code> </code><code class="n">CompletionStage</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code><code> </code><code class="nf">getAll</code><code class="o">(</code><code class="o">)</code><code> </code><code class="o">{</code><code>
</code><code>    </code><code class="n">AsyncSession</code><code> </code><code class="n">session</code><code> </code><code class="o">=</code><code> </code><code class="n">driver</code><code class="o">.</code><code class="na">asyncSession</code><code class="o">(</code><code class="o">)</code><code class="o">;</code><code>   </code><a class="co" id="co_persistence_CO6-1" href="#callout_persistence_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">session</code><code>
</code><code>            </code><code class="o">.</code><code class="na">runAsync</code><code class="o">(</code><code class="s">"MATCH (b:Book) RETURN b ORDER BY b.title"</code><code class="o">)</code><code>   </code><a class="co" id="co_persistence_CO6-2" href="#callout_persistence_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="n">cursor</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">cursor</code><code class="o">.</code><code class="na">listAsync</code><code class="o">(</code><code class="n">record</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code>
</code><code>                    </code><code class="n">Book</code><code class="o">.</code><code class="na">from</code><code class="o">(</code><code class="n">record</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"b"</code><code class="o">)</code><code class="o">.</code><code class="na">asNode</code><code class="o">(</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code class="o">)</code><code> </code><a class="co" id="co_persistence_CO6-3" href="#callout_persistence_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="n">books</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">session</code><code class="o">.</code><code>
</code><code>                    </code><code class="n">closeAsync</code><code class="o">(</code><code class="o">)</code><code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">signal</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">books</code><code class="o">)</code><code class="o">)</code><code>  </code><a class="co" id="co_persistence_CO6-4" href="#callout_persistence_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="nl">Response:</code><code class="o">:</code><code class="n">ok</code><code class="o">)</code><code>    </code><a class="co" id="co_persistence_CO6-5" href="#callout_persistence_CO6-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code>            </code><code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">ResponseBuilder</code><code class="o">:</code><code class="o">:</code><code class="n">build</code><code class="o">)</code><code class="o">;</code><code>
</code><code class="o">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_persistence_CO6-1" href="#co_persistence_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Gets an <code>AsyncSession</code> from the driver</p></dd>
<dt><a class="co" id="callout_persistence_CO6-2" href="#co_persistence_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Executes Cypher (Neo4j’s query language) to fetch the data</p></dd>
<dt><a class="co" id="callout_persistence_CO6-3" href="#co_persistence_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Retrieves a cursor, creating <code>Book</code> instances from the nodes</p></dd>
<dt><a class="co" id="callout_persistence_CO6-4" href="#co_persistence_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Closes the session once we’re done</p></dd>
<dt><a class="co" id="callout_persistence_CO6-5" href="#co_persistence_CO6-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Builds a JAX-RS response</p></dd>
</dl>

<p>The rest of the class/code follow the same pattern:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@POST</code>
<code class="kd">public</code> <code class="n">CompletionStage</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">create</code><code class="o">(</code><code class="n">Book</code> <code class="n">b</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">AsyncSession</code> <code class="n">session</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="na">asyncSession</code><code class="o">();</code>
    <code class="k">return</code> <code class="n">session</code>
            <code class="o">.</code><code class="na">writeTransactionAsync</code><code class="o">(</code><code class="n">tx</code> <code class="o">-&gt;</code>
                    <code class="o">{</code>
                        <code class="n">String</code> <code class="n">query</code> <code class="o">=</code> <code class="s">"CREATE (b:Book "</code> <code class="o">+</code>
                        <code class="s">"{title: $title, isbn: $isbn, authors: $authors})"</code> <code class="o">+</code>
                        <code class="s">" RETURN b"</code><code class="o">;</code>
                        <code class="k">return</code> <code class="n">tx</code><code class="o">.</code><code class="na">runAsync</code><code class="o">(</code><code class="n">query</code><code class="o">,</code>
                                <code class="n">Values</code><code class="o">.</code><code class="na">parameters</code><code class="o">(</code><code class="s">"title"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">title</code><code class="o">,</code>
                                        <code class="s">"isbn"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">isbn</code><code class="o">,</code>
                                        <code class="s">"authors"</code><code class="o">,</code> <code class="n">b</code><code class="o">.</code><code class="na">authors</code><code class="o">))</code>
                                <code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="nl">ResultCursor:</code><code class="o">:</code><code class="n">singleAsync</code><code class="o">);</code>
                    <code class="o">}</code>
            <code class="o">)</code>
            <code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">record</code> <code class="o">-&gt;</code> <code class="n">Book</code><code class="o">.</code><code class="na">from</code><code class="o">(</code><code class="n">record</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"b"</code><code class="o">).</code><code class="na">asNode</code><code class="o">()))</code>
            <code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="n">persistedBook</code> <code class="o">-&gt;</code> <code class="n">session</code><code class="o">.</code><code class="na">closeAsync</code><code class="o">()</code>
                    <code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">signal</code> <code class="o">-&gt;</code> <code class="n">persistedBook</code><code class="o">))</code>
            <code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">persistedBook</code> <code class="o">-&gt;</code> <code class="n">Response</code><code class="o">.</code><code class="na">created</code><code class="o">(</code>
                    <code class="n">URI</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="s">"/book/"</code> <code class="o">+</code> <code class="n">persistedBook</code><code class="o">.</code><code class="na">id</code><code class="o">)).</code><code class="na">build</code><code class="o">());</code>
<code class="o">}</code></pre>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@DELETE</code>
<code class="nd">@Path</code><code class="o">(</code><code class="s">"{id}"</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">CompletionStage</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">delete</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"id"</code><code class="o">)</code> <code class="n">Long</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">AsyncSession</code> <code class="n">session</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="na">asyncSession</code><code class="o">();</code>
    <code class="k">return</code> <code class="n">session</code>
            <code class="o">.</code><code class="na">writeTransactionAsync</code><code class="o">(</code><code class="n">tx</code> <code class="o">-&gt;</code> <code class="n">tx</code>
                    <code class="o">.</code><code class="na">runAsync</code><code class="o">(</code><code class="s">"MATCH (b:Book) WHERE id(b) = $id DELETE b"</code><code class="o">,</code>
                            <code class="n">Values</code><code class="o">.</code><code class="na">parameters</code><code class="o">(</code><code class="s">"id"</code><code class="o">,</code> <code class="n">id</code><code class="o">))</code>
                    <code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="nl">ResultCursor:</code><code class="o">:</code><code class="n">consumeAsync</code><code class="o">))</code>
            <code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="n">resp</code> <code class="o">-&gt;</code> <code class="n">session</code><code class="o">.</code><code class="na">closeAsync</code><code class="o">())</code>
            <code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">signal</code> <code class="o">-&gt;</code> <code class="n">Response</code><code class="o">.</code><code class="na">noContent</code><code class="o">().</code><code class="na">build</code><code class="o">());</code>
<code class="o">}</code></pre>

<p>This last one is a little different, in that it handles errors:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@GET</code>
<code class="nd">@Path</code><code class="o">(</code><code class="s">"{id}"</code><code class="o">)</code>
<code class="kd">public</code> <code class="n">CompletionStage</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">getById</code><code class="o">(</code><code class="nd">@PathParam</code><code class="o">(</code><code class="s">"id"</code><code class="o">)</code> <code class="n">Long</code> <code class="n">id</code><code class="o">)</code> <code class="o">{</code>
    <code class="n">AsyncSession</code> <code class="n">session</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="na">asyncSession</code><code class="o">();</code>
    <code class="k">return</code> <code class="n">session</code><code class="o">.</code><code class="na">readTransactionAsync</code><code class="o">(</code><code class="n">tx</code> <code class="o">-&gt;</code>
            <code class="n">tx</code><code class="o">.</code><code class="na">runAsync</code><code class="o">(</code><code class="s">"MATCH (b:Book) WHERE id(b) = $id RETURN b"</code><code class="o">,</code>
                                <code class="n">Values</code><code class="o">.</code><code class="na">parameters</code><code class="o">(</code><code class="s">"id"</code><code class="o">,</code> <code class="n">id</code><code class="o">))</code>
                    <code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="nl">ResultCursor:</code><code class="o">:</code><code class="n">singleAsync</code><code class="o">))</code>
            <code class="o">.</code><code class="na">handle</code><code class="o">(((</code><code class="n">record</code><code class="o">,</code> <code class="n">err</code><code class="o">)</code> <code class="o">-&gt;</code> <code class="o">{</code>
                <code class="k">if</code> <code class="o">(</code><code class="n">err</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>
                    <code class="n">Throwable</code> <code class="n">source</code> <code class="o">=</code> <code class="n">err</code><code class="o">;</code>
                    <code class="k">if</code> <code class="o">(</code><code class="n">err</code> <code class="k">instanceof</code> <code class="n">CompletionException</code><code class="o">)</code>
                        <code class="n">source</code> <code class="o">=</code> <code class="o">((</code><code class="n">CompletionException</code><code class="o">)</code> <code class="n">err</code><code class="o">).</code><code class="na">getCause</code><code class="o">();</code>
                    <code class="n">Response</code><code class="o">.</code><code class="na">Status</code> <code class="n">status</code> <code class="o">=</code> <code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code>
                                                <code class="n">INTERNAL_SERVER_ERROR</code><code class="o">;</code>
                    <code class="k">if</code> <code class="o">(</code><code class="n">source</code> <code class="k">instanceof</code> <code class="n">NoSuchRecordException</code><code class="o">)</code>
                        <code class="n">status</code> <code class="o">=</code> <code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">NOT_FOUND</code><code class="o">;</code>

                    <code class="k">return</code> <code class="n">Response</code><code class="o">.</code><code class="na">status</code><code class="o">(</code><code class="n">status</code><code class="o">).</code><code class="na">build</code><code class="o">();</code>
                <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>
                    <code class="k">return</code> <code class="n">Response</code><code class="o">.</code><code class="na">ok</code><code class="o">(</code><code class="n">Book</code><code class="o">.</code><code class="na">from</code><code class="o">(</code><code class="n">record</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="s">"b"</code><code class="o">)</code>
                                        <code class="o">.</code><code class="na">asNode</code><code class="o">())).</code><code class="na">build</code><code class="o">();</code>
                <code class="o">}</code>
            <code class="o">}))</code>
            <code class="o">.</code><code class="na">thenCompose</code><code class="o">(</code><code class="n">response</code> <code class="o">-&gt;</code> <code class="n">session</code><code class="o">.</code><code class="na">closeAsync</code><code class="o">()</code>
                                            <code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">signal</code> <code class="o">-&gt;</code> <code class="n">response</code><code class="o">));</code>
<code class="o">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45128515080024">
<h2>See Also</h2>

<p><a data-type="indexterm" data-primary="" data-startref="neo_ab" id="idm45128513770984"/><a data-type="indexterm" data-primary="" data-startref="per_neo" id="idm45128513770008"/><a data-type="indexterm" data-primary="" data-startref="qu_neo" id="idm45128513494120"/>The <a href="https://oreil.ly/ITHPx">Neo4j Cypher Manual</a> will come in handy as you learn and try new things with Cypher.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.24 Flyway at Startup"><div class="sect1" id="idm45128513492104">
<h1>7.24 Flyway at Startup</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128513491096">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="Flyway" id="idm45128513489864"/><a data-type="indexterm" data-primary="persistence" data-secondary="using Flyway at startup" id="idm45128513489160"/><a data-type="indexterm" data-primary="startup, using Flyway at" id="idm45128513488216"/>You want to use Flyway to migrate my database schema.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128513487128">
<h2>Solution</h2>

<p>Use the <code>quarkus-flyway</code> integration extension.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128513485128">
<h2>Discussion</h2>

<p>Quarkus has first-class support for schema migrations using Flyway.
There are five things you need to do to use Flyway with Quarkus at application start:</p>
<ol>
<li>
<p>Add the Flyway extension.</p>
</li>
<li>
<p>Add the JDBC driver for your database.</p>
</li>
<li>
<p>Setup the datasource(s).</p>
</li>
<li>
<p>Add migrations to <em>src/main/resources/db/migration</em>.</p>
</li>
<li>
<p>Set the <code>quarkus.flyway.migrate-at-start</code> to <code>true</code>.</p>
</li>

</ol>

<p>The default naming schema for Flyway migrations is <code>V.&lt;version&gt;__&lt;description&gt;.sql</code>.
Everything else is taken care of.</p>

<p>You can also use Flyway with multiple datasources.
Any settings that need to be configured for each datasource are named with the same schema as datasource <span class="keep-together">names: <code>quarkus.flyway.<em>datasource name</em>.<em>setting</em></code></span>.
For example, it might be <code>quarkus.flyway.users.migrate-at-start</code>.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.25 Using Flyway Programmatically"><div class="sect1" id="idm45128513473048">
<h1>7.25 Using Flyway Programmatically</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45128513472072">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="persistence" data-secondary="using Flyway programmatically" id="idm45128513470872"/>You want to use Flyway programmatically.
There may be times when you want to control when the schema is migrated instead of doing it at application startup.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45128513469272">
<h2>Solution</h2>

<p>Use the <code>quarkus-flyway</code> extension and inject the <code>Flyway</code> instance:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code>
<code class="n">Flyway</code> <code class="n">flyway</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45128513441752">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="@FlywayDataSource annotation" id="idm45128513440744"/><a data-type="indexterm" data-primary="@Named annotation" id="idm45128513439880"/>This will inject the default <code>org.flywaydb.core.Flyway</code> instance configured against the default datasource.
If you have multiple datasources and Flyway instances, you can inject specific ones using either the <code>@FlywayDataSource</code> or <code>@Named</code> annotation.
When using <code>@FlywayDataSource</code>, the value is the name of the datasource.
If instead you use <code>@Named</code>, the value should be the name of the datasource with the <code>flyway_</code> prefix:</p>

<pre data-type="programlisting" data-code-language="java"><code class="nd">@Inject</code>
<code class="nd">@FlywayDataSource</code><code class="o">(</code><code class="s">"books"</code><code class="o">)</code>
<code class="n">Flyway</code> <code class="n">flywayBooks</code><code class="o">;</code>

<code class="nd">@Inject</code>
<code class="nd">@Named</code><code class="o">(</code><code class="s">"flyway_users"</code><code class="o">)</code>
<code class="n">Flyway</code> <code class="n">flywayUsers</code><code class="o">;</code></pre>

<p>Naturally, you will be able to run all the standard Flyway operations such as <code>clean</code>, <code>migrate</code>, <code>validate</code>, <code>info</code>, <code>baseline</code>, and <code>repair</code><a data-type="indexterm" data-primary="" data-startref="per_cha" id="idm45128513446792"/>.</p>
</div></section>





</div></section>







</div></section></div>



  </body></html>