<html><head></head><body><section data-pdf-bookmark="Chapter 20. Performing I/O to Passing Data" data-type="chapter" epub:type="chapter"><div class="chapter" id="performing-io-to-passing-data">&#13;
<h1><span class="label">Chapter 20. </span>Performing I/O to Passing Data</h1>&#13;
&#13;
<blockquote data-type="epigraph" epub:type="epigraph">&#13;
<p>Input and output are problematic in code.&#13;
Our program is subject to errors talking to the outside world when files disappear or network sockets fail.&#13;
I/O is also an action and so limits our ability to reason with and refactor our code.&#13;
How can we limit the scope of the problems that I/O causes?</p>&#13;
</blockquote>&#13;
&#13;
<p>Now that earlier chapters have built some foundations, we’re going to up the pace here, going straight into refactoring and learning lessons as we go.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Listening to Tests" data-type="sect1"><div class="sect1" id="idm46393358265960">&#13;
<h1>Listening to Tests</h1>&#13;
&#13;
<p>In<a data-primary="performing I/O to passing data" data-secondary="listening to tests" data-type="indexterm" id="idm46393358264232"/> <a data-type="xref" href="ch10.html#functions-to-extension-functions">Chapter 10</a>, we looked at some Java code that produced a report for marketing.&#13;
When we left the code, we had introduced extension functions to the <code>HighValue​Custo⁠mersReport</code>, giving us:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code>&#13;
        <code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">customerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">toValuableCustomers</code><code class="p">()</code> <code class="p">=</code> <code class="n">withoutHeader</code><code class="p">()</code>&#13;
    <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">withoutHeader</code><code class="p">()</code> <code class="p">=</code> <code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;.</code><code class="n">summarised</code><code class="p">():</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">sumByDouble</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">spend</code> <code class="p">}.</code><code class="n">let</code> <code class="p">{</code> <code class="n">total</code> <code class="p">-&gt;</code>&#13;
        <code class="s">"\tTOTAL\t${total.toMoneyString()}"</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.1&amp;show=file">Example 20.1 [io-to-data.0:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.1&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Here are the tests after conversion to Kotlin:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">HighValueCustomersReportTests</code> <code class="p">{</code>&#13;
&#13;
    <code class="n">@Test</code>&#13;
    <code class="k">fun</code> <code class="nf">test</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="n">check</code><code class="p">(</code>&#13;
            <code class="n">inputLines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="s">"ID\tFirstName\tLastName\tScore\tSpend"</code><code class="p">,</code>&#13;
                <code class="s">"1\tFred\tFlintstone\t11\t1000.00"</code><code class="p">,</code>&#13;
                <code class="s">"4\tBetty\tRubble\t10\t2000.00"</code><code class="p">,</code>&#13;
                <code class="s">"2\tBarney\tRubble\t0\t20.00"</code><code class="p">,</code>&#13;
                <code class="s">"3\tWilma\tFlintstone\t9\t0.00"</code>&#13;
            <code class="p">),</code>&#13;
            <code class="n">expectedLines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code>&#13;
                <code class="s">"ID\tName\tSpend"</code><code class="p">,</code>&#13;
                <code class="s">"4\tRUBBLE, Betty\t2000.00"</code><code class="p">,</code>&#13;
                <code class="s">"1\tFLINTSTONE, Fred\t1000.00"</code><code class="p">,</code>&#13;
                <code class="s">"\tTOTAL\t3000.00"</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
        <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
        <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
    <code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">output</code> <code class="p">=</code> <code class="n">StringWriter</code><code class="p">()</code>&#13;
        <code class="n">generate</code><code class="p">(</code>&#13;
            <code class="n">StringReader</code><code class="p">(</code><code class="n">inputLines</code><code class="p">.</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">)),</code>&#13;
            <code class="n">output</code>&#13;
        <code class="p">)</code>&#13;
        <code class="n">assertEquals</code><code class="p">(</code><code class="n">expectedLines</code><code class="p">.</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">),</code> <code class="n">output</code><code class="p">.</code><code class="n">toString</code><code class="p">())</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.2&amp;show=file">Example 20.2 [io-to-data.1:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.2&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We<a data-primary="calculations" data-secondary="check function and" data-type="indexterm" id="idm46393357913800"/><a data-primary="actions" data-secondary="check function and" data-type="indexterm" id="idm46393357912792"/> didn’t really look at the tests in <a data-type="xref" href="ch10.html#functions-to-extension-functions">Chapter 10</a>, but if we do now, what stands out in the light of your authors’ obsession with actions and calculations (<a data-type="xref" href="ch07.html#actions-to-calculations">Chapter 7</a>)?&#13;
In particular, look at that <code>check</code> function.</p>&#13;
&#13;
<p><code>check</code> is evidently not a calculation (<a data-type="xref" href="ch07.html#calculations">“Calculations”</a>), because it works entirely by throwing an exception instead of returning a value.&#13;
What if we look at it this way though?</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">output</code> <code class="p">=</code> <code class="n">StringWriter</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">reader</code> <code class="p">=</code> <code class="n">StringReader</code><code class="p">(</code><code class="n">inputLines</code><code class="p">.</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">))</code>&#13;
    <code class="n">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">,</code> <code class="n">output</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">outputLines</code> <code class="p">=</code> <code class="n">output</code><code class="p">.</code><code class="n">toString</code><code class="p">().</code><code class="n">lines</code><code class="p">()</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">expectedLines</code><code class="p">,</code> <code class="n">outputLines</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.3&amp;show=file">Example 20.3 [io-to-data.2:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.3&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is for all intents and purposes the same code, but now we can see that we have a calculation, taking <code>inputLines</code> and yielding <code>outputLines</code>, before we go on to the assertion.&#13;
Even though <code>generate</code> is an action, relying on the side effects of reading and writing to and from its parameters, we can convert it to a calculation by limiting the scope of its side effects to local variables.</p>&#13;
&#13;
<p>If we stop for a moment and listen, we can hear the tests talking to us.&#13;
They are saying, “Look, that report generation is fundamentally a calculation: it converts a <code>List&lt;String&gt;</code> to a <code>List&lt;String&gt;</code>.&#13;
We know it does, because that’s what we are &#13;
<span class="keep-together">checking</span>.”</p>&#13;
&#13;
<p>So the tests are telling us that the fundamental signature of <code>generate</code> is &#13;
<span class="keep-together"><code>generate(lines: List&lt;String&gt;): List&lt;String&gt;</code></span>.&#13;
If <em>this</em> was the signature, then it would not have to declare that it throws <code>IOException</code> either, because all the I/O would happen outside the function.&#13;
I/O has to happen somewhere, but, in common with other actions, the closer to the entry points of our system we can move it, the more we can deal in nice easy calculations.</p>&#13;
&#13;
<p>Shall we refactor toward this goal?&#13;
You’re right, that was a rhetorical question.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="I/O to Data" data-type="sect1"><div class="sect1" id="idm46393358265336">&#13;
<h1>I/O to Data</h1>&#13;
&#13;
<p>As<a data-primary="performing I/O to passing data" data-secondary="I/O to data" data-type="indexterm" id="PIOiotodata20"/><a data-primary="refactoring" data-secondary="I/O to data" data-type="indexterm" id="Rio20"/> the first stage in our refactor, let’s try to wean <code>generate</code> off its <code>reader</code> parameter.&#13;
The code is currently:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code> <code class="n">Reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">reader</code>&#13;
        <code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">customerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.4&amp;show=file">Example 20.4 [io-to-data.3:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.4&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We can convert <code>generate</code> to read from a <code>List</code> by invoking “Introduce parameter” on the <code>reader.readLines()</code> expression, naming the parameter <code>lines</code>.&#13;
Because the expression is the only use of the existing <code>reader</code> parameter, IntelliJ removes <code>reader</code> for us:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">,</code> <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">customerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.5&amp;show=file">Example 20.5 [io-to-data.4:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.5&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The refactoring has moved the <code>readLines()</code> out into the callers; here is the result in test:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">output</code> <code class="p">=</code> <code class="n">StringWriter</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">reader</code> <code class="p">=</code> <code class="n">StringReader</code><code class="p">(</code><code class="n">inputLines</code><code class="p">.</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">))</code>&#13;
    <code class="n">generate</code><code class="p">(</code><code class="n">output</code><code class="p">,</code> <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">())</code>&#13;
    <code class="k">val</code> <code class="py">outputLines</code> <code class="p">=</code> <code class="n">output</code><code class="p">.</code><code class="n">toString</code><code class="p">().</code><code class="n">lines</code><code class="p">()</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">expectedLines</code><code class="p">,</code> <code class="n">outputLines</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.6&amp;show=file">Example 20.6 [io-to-data.4:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.6&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This now shouts what the test was whispering all along.&#13;
We were having to create a <code>StringReader</code> from a list of lines just to parse the lines back out in <code>generate</code>.&#13;
Now that the steps are in the same place in the test, we can elide them to remove the <code>Reader</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">output</code> <code class="p">=</code> <code class="n">StringWriter</code><code class="p">()</code>&#13;
    <code class="n">generate</code><code class="p">(</code><code class="n">output</code><code class="p">,</code> <code class="n">inputLines</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">outputLines</code> <code class="p">=</code> <code class="n">output</code><code class="p">.</code><code class="n">toString</code><code class="p">().</code><code class="n">lines</code><code class="p">()</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">expectedLines</code><code class="p">,</code> <code class="n">outputLines</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.7&amp;show=file">Example 20.7 [io-to-data.5:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.7&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>We are now reading from a <code>List</code>.&#13;
Let’s go back and look at how to return a <code>List</code> too, rather than modifying the <code>Writer</code>.&#13;
Here is the code:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code>&#13;
<code class="k">for</code> <code class="p">(</code><code class="n">customerData</code> <code class="k">in</code> <code class="n">valuableCustomers</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">customerData</code><code class="p">.</code><code class="n">outputLine</code><code class="p">)</code>&#13;
<code class="p">}</code>&#13;
<code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">())</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.8&amp;show=file">Example 20.8 [io-to-data.5:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.8&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Instead of thinking imperatively about the ways that we want to mutate <code>Writer</code>, let’s think in terms of the data that we want written and create that:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">val</code> <code class="py">resultLines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
    <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
    <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.9&amp;show=file">Example 20.9 [io-to-data.6:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.9&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Then we can write it in one lump to <code>writer</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">,</code> <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">resultLines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">resultLines</code><code class="p">.</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.10&amp;show=file">Example 20.10 [io-to-data.6:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.10&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This function is now two statements that make up a calculation, and a final action taking the result of the calculation.&#13;
If we now “Extract function” with the calculation lines, making it public and calling it <code>generate</code> too, we get the following:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">,</code> <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">resultLines</code> <code class="p">=</code> <code class="n">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">resultLines</code><code class="p">.</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">))</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">resultLines</code> <code class="p">=</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">resultLines</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.11&amp;show=file">Example 20.11 [io-to-data.7:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.11&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Inlining both vestigial <code>resultLines</code> gives:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">@Throws</code><code class="p">(</code><code class="n">IOException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">writer</code><code class="p">:</code> <code class="n">Writer</code><code class="p">,</code> <code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;)</code> <code class="p">{</code>&#13;
    <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">).</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">))</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.12&amp;show=file">Example 20.12 [io-to-data.8:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.12&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>One more inline then, this time of the old <code>generate</code> function.&#13;
That replaces its invocation in client code, leaving this in the test:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">output</code> <code class="p">=</code> <code class="n">StringWriter</code><code class="p">()</code>&#13;
    <code class="n">output</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">generate</code><code class="p">(</code><code class="n">inputLines</code><code class="p">).</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">))</code>&#13;
    <code class="k">val</code> <code class="py">outputLines</code> <code class="p">=</code> <code class="n">output</code><code class="p">.</code><code class="n">toString</code><code class="p">().</code><code class="n">lines</code><code class="p">()</code>&#13;
&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">expectedLines</code><code class="p">,</code> <code class="n">outputLines</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.13&amp;show=file">Example 20.13 [io-to-data.9:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.13&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This<a data-primary="transformations" data-secondary="I/O and" data-type="indexterm" id="idm46393356854888"/> refactor has moved the action part of <code>generate</code> out a level, leaving the nice pure calculation bits in its place.&#13;
Another way of looking at this is that our original <code>Writer</code> was an accumulating object, which we have replaced with a transformation, as we saw in <a data-type="xref" href="ch14.html#accumulating-objects-to-transformations">Chapter 14</a>.&#13;
Our tests didn’t really want to be testing an action anyway, so they again have redundant I/O, which we can simplify to the form we were aiming for:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code><code class="n">expectedLines</code><code class="p">,</code> <code class="n">generate</code><code class="p">(</code><code class="n">inputLines</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.14&amp;show=file">Example 20.14 [io-to-data.10:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.14&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Let’s take stock of our new <code>generate</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">toValuableCustomers</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">toValuableCustomers</code><code class="p">()</code> <code class="p">=</code> <code class="n">withoutHeader</code><code class="p">()</code>&#13;
    <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">withoutHeader</code><code class="p">()</code> <code class="p">=</code> <code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.15&amp;show=file">Example 20.15 [io-to-data.11:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.15&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now that <code>generate</code> is doing so much less, it isn’t clear that the function <code>toValuable​Cus⁠tomers()</code> is worthwhile.&#13;
Looking at it afresh, we see that it is working at mixed levels, converting and filtering.&#13;
Let’s try inlining it:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.16&amp;show=file">Example 20.16 [io-to-data.12:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.16&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>That’s better.&#13;
The local variable <code>valuableCustomers</code> does a good job of telling us what the expression means, and the list operations spell out the implementation in place.&#13;
This function is a case where a single-expression function (<a data-type="xref" href="ch09.html#multi-to-single-expression-functions">Chapter 9</a>) would probably make things worse, so we’ll leave it in two parts.&#13;
We’ll also continue to resist the temptation to make it an extension function, <code>List&lt;String&gt;.toReport()</code>, at least for now.<a data-primary="" data-startref="PIOiotodata20" data-type="indexterm" id="idm46393356561736"/><a data-primary="" data-startref="Rio20" data-type="indexterm" id="idm46393356560728"/></p>&#13;
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46393356559656">&#13;
<h5>Refactoring for Readability</h5>&#13;
<p>Refactoring<a data-primary="refactoring" data-secondary="for readability" data-secondary-sortas="readability" data-type="indexterm" id="idm46393356558104"/><a data-primary="performing I/O to passing data" data-secondary="refactoring for readability" data-type="indexterm" id="idm46393356556824"/> for readability is often this way.&#13;
We might extract a function to make something more readable in context, but when the context changes, the function we extracted makes things worse.&#13;
Time is also a context.&#13;
Sometimes something that we felt was quite expressive when we wrote it turns out to be less so when we read it back later, or could now be improved because we have internalized new idioms.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Efficient Writing" data-type="sect1"><div class="sect1" id="idm46393358055224">&#13;
<h1>Efficient Writing</h1>&#13;
&#13;
<p>We’re<a data-primary="performing I/O to passing data" data-secondary="efficient writing" data-type="indexterm" id="PIOwrit20"/> quite pleased with this refactor.&#13;
It has simplified our tests and the production code, and we have moved from mixing I/O and logic to a simpler calculation with no side effects.</p>&#13;
&#13;
<p>For<a data-primary="OutOfMemoryError" data-type="indexterm" id="idm46393356552264"/><a data-primary="error handling" data-secondary="OutOfMemoryError" data-type="indexterm" id="idm46393356551528"/> a while, all is fine in production too, but with the easing of COVID-19 travel restrictions, Travelator becomes the roaring success that we all knew it would be.&#13;
Eventually, though, the lovely people in marketing start complaining that the report generation is failing with an <code>OutOfMemoryError</code>.&#13;
Could we look into it?</p>&#13;
&#13;
<p>(Apart from running out of memory, we have had two other issues with errors in this code in living memory.&#13;
Both these times, the input file turned out to have been malformed, but marketing sit next door and just call us over to help if these occur.&#13;
They feed us cake in these cases, so we’re hardly incentivized to do a better job of error handling for now (but see <a data-type="xref" href="ch21.html#exceptions-to-values">Chapter 21</a>).&#13;
If we can fix the <code>OutOfMemoryError</code> quickly, we think we saw some crumpets…)</p>&#13;
&#13;
<p>We haven’t bothered you with the details so far, but there is a <code>main</code> method that invokes our report.&#13;
It is designed to be invoked with shell redirection, reading from a file piped as the standard input and writing to a file collected from the standard output.&#13;
This way, our process doesn’t have to read filenames from the command line:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">InputStreamReader</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">).</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">OutputStreamWriter</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">).</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">,</code> <code class="n">writer</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.17&amp;show=file">Example 20.17 [io-to-data.0:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.17&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>When we refactored <code>generate</code> to work with <code>List</code>s rather than a <code>Reader</code> and <code>Writer</code>, IntelliJ automatically updated <code>main</code> to yield:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code>&#13;
                <code class="n">generate</code><code class="p">(</code>&#13;
                    <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
                <code class="p">).</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.18&amp;show=file">Example 20.18 [io-to-data.9:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.18&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Ah, there’s our problem.&#13;
We’re reading the whole of the input into memory (<code>readLines()</code>), processing it, and then creating the entire output in memory (<code>joinToString()</code>) before writing it back out.</p>&#13;
&#13;
<p>We sometimes run into problems like these with<a data-primary="functional decomposition" data-type="indexterm" id="idm46393356416040"/> functional decomposition.&#13;
In this case the original <code>Reader</code> and <code>Writer</code> code did not have this issue, so we have brought it on ourselves in the name of good style.&#13;
We could quickly revert our changes and go and see whether there are any crumpets left, or we could find a more functional &#13;
<span class="keep-together">solution</span>.</p>&#13;
&#13;
<p>Let’s go back to <code>generate</code> and see what leeway we have:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">listOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.19&amp;show=file">Example 20.19 [io-to-data.12:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.19&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Concentrating on the output for now, we can see that we are building a <code>List</code> of the lines of the output;&#13;
<code>main</code> then takes each <code>String</code> in the result and creates one giant one with <code>joinToString()</code>.&#13;
At this point both the individual output lines and their conglomerate will be taking up memory.&#13;
To avoid running out of memory, we’ll need to defer the creation of the intermediate collections, and, as we saw in <a data-type="xref" href="ch13.html#streams-to-sequences">Chapter 13</a>, <code>Sequence</code>s are designed for just that.</p>&#13;
&#13;
<p>We can convert <code>generate</code> to return a <code>Sequence</code> methodically or quickly.&#13;
For once, we’ll choose quickly and just replace <code>listOf</code> with <code>sequenceOf</code> in our <code>return</code> expression:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">sequenceOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.20&amp;show=file">Example 20.20 [io-to-data.13:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.20&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now we will only be creating the output lines one at a time when the <code>Sequence</code> is iterated; each line can be disposed of quickly rather than hanging around until we have written the whole file.</p>&#13;
&#13;
<p>The tests have to change to convert the returned <code>Sequence</code> to a <code>List</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">expectedLines</code><code class="p">,</code>&#13;
        <code class="n">generate</code><code class="p">(</code><code class="n">inputLines</code><code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.21&amp;show=file">Example 20.21 [io-to-data.13:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.21&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Interestingly, though, <code>main</code> does not:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">writer</code><code class="p">.</code><code class="n">append</code><code class="p">(</code>&#13;
                <code class="n">generate</code><code class="p">(</code>&#13;
                    <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
                <code class="p">).</code><code class="n">joinToString</code><code class="p">(</code><code class="s">"\n"</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.22&amp;show=file">Example 20.22 [io-to-data.13:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.22&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p><code>main</code> needs<a data-primary="recompilation" data-type="indexterm" id="idm46393356065992"/> to be <em>recompiled</em> now that <code>generate</code> returns a <code>Sequence</code> rather than a <code>List</code>, but its <em>source</em> doesn’t need to be changed.&#13;
This is because there are extension functions <code>joinToString()</code> defined on both <code>Iterable</code> and <code>Sequence</code>, both returning <code>String</code>.</p>&#13;
&#13;
<p>It might not <em>need</em> to change, but unless <code>main</code> <em>does</em> change, we are still creating one large string of all the output before writing it in one operation.&#13;
To avoid that, we need to get imperative again and write each output line individually, as our original &#13;
<span class="keep-together"><code>generate</code></span> had done:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">generate</code><code class="p">(</code>&#13;
                <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">()</code>&#13;
            <code class="p">).</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">line</code> <code class="p">-&gt;</code>&#13;
                <code class="n">writer</code><code class="p">.</code><code class="n">appendLine</code><code class="p">(</code><code class="n">line</code><code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.23&amp;show=file">Example 20.23 [io-to-data.14:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.23&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The pedantic reader (don’t worry, you’re among friends) will have spotted that this behavior is subtly different from the <code>joinToString("\n")</code> version.&#13;
We’re quietly confident that a trailing newline won’t break anything, so we press on.</p>&#13;
&#13;
<p>We can always pretend we aren’t looping by hiding the iteration inside a <code>Writer::appendLines</code> extension function that we assumed the Kotlin standard library would define, but doesn’t seem to:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">writer</code><code class="p">.</code><code class="n">appendLines</code><code class="p">(</code>&#13;
                <code class="n">generate</code><code class="p">(</code><code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">())</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">fun</code> <code class="nf">Writer</code><code class="p">.</code><code class="n">appendLines</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">CharSequence</code><code class="p">&gt;):</code> <code class="n">Writer</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="n">also</code> <code class="p">{</code>&#13;
        <code class="n">lines</code><code class="p">.</code><code class="n">forEach</code><code class="p">(</code><code class="k">this</code><code class="o">::</code><code class="n">appendLine</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.24&amp;show=file">Example 20.24 [io-to-data.15:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.24&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Note that although the definition of <code>Writer::appendLines</code> is a single expression, we agreed in <a data-type="xref" href="ch09.html#multi-to-single-expression-functions">Chapter 9</a> to use the long form where functions are actions, and <code>appendLines</code> is definitely that.</p>&#13;
&#13;
<p>Now that we are here, we realize that we could have postponed our memory crisis by just iterating over the original result <code>List</code> in <code>main</code>, writing each line individually, as we are doing now with the <code>Sequence</code>.&#13;
This solution will use even less memory, though, so we’ll commit it, having bought ourselves lots of headroom with few changes and earned our crumpets.&#13;
Is there any butter?<a data-primary="" data-startref="PIOwrit20" data-type="indexterm" id="idm46393355865128"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Efficient Reading" data-type="sect1"><div class="sect1" id="idm46393356554872">&#13;
<h1>Efficient Reading</h1>&#13;
&#13;
<p>We<a data-primary="performing I/O to passing data" data-secondary="efficient reading" data-type="indexterm" id="PIOread20"/> would be remiss if we didn’t finish the job and pretend that we also need to save memory on reading too.&#13;
Let’s look at <code>generate</code> again:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">sequenceOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.25&amp;show=file">Example 20.25 [io-to-data.15:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.25&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The pipeline of operations that builds <code>valuableCustomers</code> will build intermediate <code>List</code>s: one for each stage, and each taking up memory.&#13;
Every line in the input is going to be in memory at once, along with a <code>CustomerData</code> object for every line.</p>&#13;
&#13;
<p>We can avoid the intermediate collections by reading from a <code>Sequence</code>, although that will bring a few problems of its own.&#13;
We can see this if we change the code in &#13;
<span class="keep-together"><code>generate</code></span> to convert the <code>lines</code> to a <code>Sequence</code> and fix up the methods that did take <code>List</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">sequenceOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">withoutHeader</code><code class="p">()</code> <code class="p">=</code> <code class="n">drop</code><code class="p">(</code><code class="m">1</code><code class="p">)</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">Sequence</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;.</code><code class="n">summarised</code><code class="p">():</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">sumByDouble</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">spend</code> <code class="p">}.</code><code class="n">let</code> <code class="p">{</code> <code class="n">total</code> <code class="p">-&gt;</code>&#13;
        <code class="s">"\tTOTAL\t${total.toMoneyString()}"</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.26&amp;show=file">Example 20.26 [io-to-data.16:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.26&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This passes the unit tests.&#13;
Are we done?&#13;
Is this another rhetorical question?</p>&#13;
&#13;
<p>We’ll cut to the chase and say that the issue is that we end up iterating over <code>valuableCustomers</code> twice, once <em>before</em> we return from <code>generate</code> in that <code>sumByDouble</code>, and again <em>after</em> we return, when our callers iterate over the returned <code>Sequence</code> to print the report.&#13;
If we iterate over a <code>Sequence</code> twice, we do all the work of creating the <code>Sequence</code> twice, in this case: removing the header and mapping and filtering and sorting twice.&#13;
Worse, when we try to use the code in production, passing a <code>Sequence</code> reading standard input, we won’t be able to iterate over that twice, giving an <code>IllegalState​Excep⁠tion</code>.&#13;
As we saw in <a data-type="xref" href="ch13.html#streams-to-sequences">Chapter 13</a>, instances of <code>Sequence</code> differ in ways that aren’t expressed in the type system, and they also carry hidden state.&#13;
Iterating over a <code>Sequence</code> looks like iterating over a <code>List</code> but will change the <code>Sequence</code> itself by consuming its contents.</p>&#13;
&#13;
<p>We can show that we are abusing this <code>Sequence</code> by adding a <code>.constrainOnce()</code> call:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting">    <code class="k">val</code> <code class="py">valuableCustomers</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">constrainOnce</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.27&amp;show=file">Example 20.27 [io-to-data.17:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.27&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This will cause our tests to fail with an <code>IllegalStateException</code>.&#13;
The simplest fix is to resolve the <code>Sequence</code> with a <code>.toList()</code> call:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting">    <code class="k">val</code> <code class="py">valuableCustomers</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">asSequence</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">constrainOnce</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">toList</code><code class="p">()</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.28&amp;show=file">Example 20.28 [io-to-data.18:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.28&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This terminates the sequence (and hence ultimately reads the whole file) in that statement, but at least we run the pipeline only once, and the memory for each line can be discarded as soon as it is parsed <code>toCustomerData</code>.&#13;
We will in fact have to read through the whole input in this function anyway, because <code>Sequence.sortedBy</code> needs to read every item to perform the sort—it may return a <code>Sequence</code>, but it isn’t lazy.</p>&#13;
&#13;
<p>Now we can replay the “Introduce parameter” refactoring we used at the beginning of this chapter.&#13;
There we converted a <code>Reader</code> parameter into a <code>List</code>; now we convert the <code>List</code> to a <code>Sequence</code>.&#13;
The parameter we introduce is the expression <code>lines.as​Se⁠quence().constrainOnce()</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">generate</code><code class="p">(</code><code class="n">lines</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="n">lines</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">sequenceOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">private</code> <code class="k">fun</code> <code class="nf">List</code><code class="p">&lt;</code><code class="n">CustomerData</code><code class="p">&gt;.</code><code class="n">summarised</code><code class="p">():</code> <code class="n">String</code> <code class="p">=</code>&#13;
    <code class="n">sumByDouble</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">spend</code> <code class="p">}.</code><code class="n">let</code> <code class="p">{</code> <code class="n">total</code> <code class="p">-&gt;</code>&#13;
        <code class="s">"\tTOTAL\t${total.toMoneyString()}"</code>&#13;
    <code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.29&amp;show=file">Example 20.29 [io-to-data.19:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.29&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>The refactoring pulls the conversion of the <code>List</code> to the <code>Sequence</code> up into the tests:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">check</code><code class="p">(</code>&#13;
    <code class="n">inputLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;,</code>&#13;
    <code class="n">expectedLines</code><code class="p">:</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code>&#13;
<code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">assertEquals</code><code class="p">(</code>&#13;
        <code class="n">expectedLines</code><code class="p">,</code>&#13;
        <code class="n">generate</code><code class="p">(</code>&#13;
            <code class="n">inputLines</code><code class="p">.</code><code class="n">asSequence</code><code class="p">().</code><code class="n">constrainOnce</code><code class="p">()</code>&#13;
        <code class="p">).</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.30&amp;show=file">Example 20.30 [io-to-data.19:src/test/java/travelator/marketing/HighValueCustomersReportTests.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.30&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>It also pulls it up into <code>main</code>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">writer</code><code class="p">.</code><code class="n">appendLines</code><code class="p">(</code>&#13;
                <code class="n">generate</code><code class="p">(</code>&#13;
                    <code class="n">reader</code><code class="p">.</code><code class="n">readLines</code><code class="p">().</code><code class="n">asSequence</code><code class="p">().</code><code class="n">constrainOnce</code><code class="p">()</code>&#13;
                <code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.31&amp;show=file">Example 20.31 [io-to-data.19:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.31&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>This is where we are really able to save memory.&#13;
Instead of reading all the lines at once and converting to a <code>Sequence</code>, we can get a <code>Sequence</code> from the <code>Reader</code> with &#13;
<span class="keep-together"><code>buffered().lineSequence()</code></span>:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">writer</code><code class="p">.</code><code class="n">appendLines</code><code class="p">(</code>&#13;
                <code class="n">generate</code><code class="p">(</code>&#13;
                    <code class="n">reader</code><code class="p">.</code><code class="n">buffered</code><code class="p">().</code><code class="n">lineSequence</code><code class="p">()</code>&#13;
                <code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.32&amp;show=file">Example 20.32 [io-to-data.20:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.32&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Now <code>generate</code> will be pulling the lines into memory one by one as it executes its pipeline.&#13;
We’re now really quite efficient in our use of memory and run pleasingly quickly.&#13;
Can we resist one last tinker?&#13;
How much nicer would <code>main</code> read with more extension functions?</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">System</code><code class="p">.</code><code class="n">`in`</code><code class="p">.</code><code class="n">reader</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">reader</code> <code class="p">-&gt;</code>&#13;
        <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">writer</code><code class="p">().</code><code class="n">use</code> <code class="p">{</code> <code class="n">writer</code> <code class="p">-&gt;</code>&#13;
            <code class="n">reader</code>&#13;
                <code class="p">.</code><code class="n">asLineSequence</code><code class="p">()</code>&#13;
                <code class="p">.</code><code class="n">toHighValueCustomerReport</code><code class="p">()</code>&#13;
                <code class="p">.</code><code class="n">writeTo</code><code class="p">(</code><code class="n">writer</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.33&amp;show=file">Example 20.33 [io-to-data.21:src/main/java/travelator/marketing/HighValueCustomersMain.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.33&amp;show=diff">(diff)</a>&#13;
</div>&#13;
&#13;
<p>Which finally answers the question we posed back at the end of <a data-type="xref" href="ch10.html#functions-to-extension-functions">Chapter 10</a>: yes, we do end up with report generation as an extension function.&#13;
We love it when a plan comes together:</p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">fun</code> <code class="nf">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;.</code><code class="n">toHighValueCustomerReport</code><code class="p">():</code> <code class="n">Sequence</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">valuableCustomers</code> <code class="p">=</code> <code class="k">this</code>&#13;
        <code class="p">.</code><code class="n">withoutHeader</code><code class="p">()</code>&#13;
        <code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">String</code><code class="o">::</code><code class="n">toCustomerData</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">filter</code> <code class="p">{</code> <code class="n">it</code><code class="p">.</code><code class="n">score</code> <code class="p">&gt;=</code> <code class="m">10</code> <code class="p">}</code>&#13;
        <code class="p">.</code><code class="n">sortedBy</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">score</code><code class="p">)</code>&#13;
        <code class="p">.</code><code class="n">toList</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">sequenceOf</code><code class="p">(</code><code class="s">"ID\tName\tSpend"</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">map</code><code class="p">(</code><code class="n">CustomerData</code><code class="o">::</code><code class="n">outputLine</code><code class="p">)</code> <code class="p">+</code>&#13;
        <code class="n">valuableCustomers</code><code class="p">.</code><code class="n">summarised</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
<div class="coderef">&#13;
    <a class="orm:hideurl" href="https://java-to-kotlin.dev/code.html?ref=20.34&amp;show=file">Example 20.34 [io-to-data.21:src/main/java/travelator/marketing/HighValueCustomersReport.kt]</a> <a class="orm:hideurl print-hide" href="https://java-to-kotlin.dev/code.html?ref=20.34&amp;show=diff">(diff)</a>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Moving On" data-type="sect1"><div class="sect1" id="idm46393355863240">&#13;
<h1>Moving On</h1>&#13;
&#13;
<p>This<a data-primary="" data-startref="PIOread20" data-type="indexterm" id="idm46393354887448"/> refactoring was motivated by a desire to simplify our code.&#13;
By moving I/O to the entry point of our program, the inner workings can be calculations rather than actions.&#13;
They can also abdicate responsibility for I/O errors.&#13;
That was all well and good, but calculations take and return values, and forming a value of the entire contents of large files is sometimes too much for even today’s computers.</p>&#13;
&#13;
<p>To solve this problem, we resorted to converting our <code>List</code>s to <code>Sequence</code>s.&#13;
Sequences have state and are not values, but with a little care we can treat them like lazy values—lazy in that they don’t require or return all their contents up front, but can read or supply them on demand.&#13;
They aren’t as simple as lists, but their compatible Kotlin API allows something of the best of both worlds.</p>&#13;
&#13;
<p>Our original <code>Reader</code> to <code>Writer</code> version of <code>generate</code> had to worry about I/O errors, whereas the <code>List</code> to <code>List</code> version moved all I/O to its callers.&#13;
The <code>Sequence</code> version is in a middle ground.&#13;
It doesn’t worry about I/O errors because they are hidden from it by the <code>Sequence</code> abstractions wrapping the <code>Reader</code> and <code>Writer</code>.&#13;
That doesn’t mean that they can’t happen, just that <code>generate</code> isn’t responsible for them.&#13;
We’ll take a break to see whether our colleagues in marketing have any more batter-based rewards before addressing that topic in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch21.html#exceptions-to-values">Chapter 21, <em>Exceptions to Values</em></a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>