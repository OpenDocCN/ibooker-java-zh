<html><head></head><body><section data-pdf-bookmark="Chapter 16. Threaded Java" data-type="chapter" epub:type="chapter"><div class="chapter" id="javacook-threads">&#13;
<h1><span class="label">Chapter 16. </span>Threaded Java</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.0 Introduction" data-type="sect1"><div class="sect1" id="javacook-threads-intro">&#13;
<h1>16.0 Introduction</h1>&#13;
&#13;
<p><a data-primary="threading" data-type="indexterm" id="thr_ch"/><a data-primary="threading" data-secondary="in Java" data-type="indexterm" id="thr_jav"/><a data-primary="Java" data-secondary="threading in" data-type="indexterm" id="jav_thr"/>We live in a world of multiple activities. A person may be talking on the phone while&#13;
doodling or reading a memo. A multifunction office machine may scan one fax while receiving another and&#13;
printing a document from somebody’s computer. We expect the GUI programs we use to be able to respond to a menu while&#13;
updating the screen. But ordinary computer programs can do only one thing at a time. The&#13;
conventional computer programming model—that of writing one statement after another,&#13;
punctuated by repetitive loops and binary decision making—is sequential at heart.</p>&#13;
&#13;
<p>Sequential processing is straightforward but not as efficient as it could be. To enhance&#13;
performance, Java offers <em>threading</em>, the capability to handle multiple flows of control&#13;
within a single application or process. Java provides thread support and, in fact,&#13;
requires threads: the Java runtime itself is inherently multithreaded. For example, window&#13;
system action handling and Java’s garbage collection—that miracle that lets us avoid&#13;
having to free everything we allocate, as others must do when working in languages at or&#13;
below C level—run in separate threads.</p>&#13;
&#13;
<p>Just as multitasking allows a single operating system to give the appearance of running&#13;
more than one program at the same time on a single-processor computer, multithreading&#13;
can allow a single program or process to give the appearance of working on more than one&#13;
thing at the same time. Multithreading leads to more interactive graphics and more responsive GUI&#13;
applications (the program can draw in a window while responding to a menu, with both&#13;
activities occurring more or less independently), more reliable network servers (if one&#13;
client does something wrong, the server continues communicating with the others), and so&#13;
on.</p>&#13;
&#13;
<p>Note that I did not say “multiprocessing” in the previous paragraph. The term&#13;
multi-tasking is sometimes erroneously called multiprocessing, but that term in fact&#13;
refers to different issue: it’s the case of two or more CPUs running under a single operating&#13;
system. Multiprocessing per se is nothing new: IBM mainframes did it in the 1970s, Sun&#13;
SPARCstations did it in the 1980s, and Intel PCs did it in the 1990s. Since the mid-2010s,&#13;
it has become increasingly hard to buy a single-processor computer packaged inside anything&#13;
larger than a wristwatch.&#13;
True multiprocessing allows you to have more than one process running concurrently on more than&#13;
one CPU. Java’s support for threading includes multiprocessing, as long as the operating&#13;
system supports it. Consult your system documentation for details.</p>&#13;
&#13;
<p>Though most modern operating systems provide threads, Java was the first mainstream programming&#13;
language to have intrinsic support for threaded operations built&#13;
right into the language. The semantics of <code>java.lang.Object</code>, of&#13;
which all objects are instances, includes the notion of monitor&#13;
locking of objects, and some methods (<code>notify</code>, <code>notifyAll</code>, <code>wait</code>)&#13;
are meaningful only in the context of a multithreaded application.&#13;
Java also has language keywords such as <code>synchronized</code> to control&#13;
the behavior of threaded applications.</p>&#13;
&#13;
<p>Now that the world has had years of experience with threaded&#13;
Java, experts have started building better ways of writing threaded&#13;
applications. The <a data-primary="Concurrency Utilities" data-type="indexterm" id="idm45290633713688"/>Concurrency Utilities, specified in<a data-primary="Java Specification Request (JSR)" data-type="indexterm" id="idm45290633712856"/><a data-primary="JSR (Java Specification Request)" data-type="indexterm" id="idm45290633712168"/> JSR&#13;
166<sup><a data-type="noteref" href="ch16.html#idm45290633711352" id="idm45290633711352-marker">1</a></sup> and included in&#13;
all modern Java releases, are heavily based on the&#13;
<code>util.concurrent</code> package by Professor <a data-primary="Lea, Doug" data-type="indexterm" id="idm45290633709016"/>Doug Lea of the Computer&#13;
Science Department at the State University of New York at Oswego.&#13;
This package aims to do for the difficulties of threading what the&#13;
Collections classes (see <a data-type="xref" href="ch07.html#javacook-structure">Chapter 7</a>) did for structuring data.&#13;
This is no small undertaking, but they pulled it off.</p>&#13;
&#13;
<p>The <code>java.util.concurrent</code> package includes several main sections:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>Executor</code>s, thread pools (<code>ExecutorService</code>s), and <code>Future</code>s/<code>CompletableFuture</code>s</p>&#13;
</li>&#13;
<li>&#13;
<p><code>Queue</code>s and <code>BlockingQueue</code>s</p>&#13;
</li>&#13;
<li>&#13;
<p>Locks and conditions, with JVM support for faster locking and unlocking</p>&#13;
</li>&#13;
<li>&#13;
<p>Synchronizers, including <code>Semaphore</code>s and <code>Barrier</code>s</p>&#13;
</li>&#13;
<li>&#13;
<p>Atomic variables</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In this chapter I will focus on the first set of these, thread pools and <code>Future</code>s.</p>&#13;
&#13;
<p>An implementation of the <code>Executor</code> interface is, as the name implies, a class that can execute code for you. The code to be executed can be the familiar <code>Runnable</code> or a new interface <code>Callable</code>. One common kind of <code>Executor</code> is a<a data-primary="thread pool" data-type="indexterm" id="idm45290633694632"/> <em>thread pool</em>. The <code>Future</code> interface represents the future state of something that has been started; it has <span class="keep-together">methods</span> to wait until the result is ready.&#13;
A <code>CompletableFuture</code> is an implementation of <code>Future</code> that adds many additional methods&#13;
for chaining <code>CompletableFuture</code>s and post-applied methods.</p>&#13;
&#13;
<p>These brief definitions are oversimplifications.&#13;
Addressing all the issues is beyond the scope of this chapter, but I do provide several examples.<a data-primary="" data-startref="thr_jav" data-type="indexterm" id="idm45290633690584"/><a data-primary="" data-startref="jav_thr" data-type="indexterm" id="idm45290633689608"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.1 Running Code in a Different Thread" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-1">&#13;
<h1>16.1 Running Code in a Different Thread</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-1.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="threading" data-secondary="constructing threads" data-type="indexterm" id="thr_con"/>You need to write a threaded application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-1.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Write code that implements <code>Runnable</code>; pass it to an <code>Executor</code>, or instantiate a <code>Thread</code> and start it.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-1.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>There are several ways to implement threading, and they all require you to&#13;
implement the <code>Runnable</code> or <code>Callable</code> interface. <code>Runnable</code> has only one&#13;
method, and it returns no value; this is its signature:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">Runnable</code> <code class="o">{</code>&#13;
  <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">();</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><code>Callable</code> has similarly only one method, but the <a data-primary="call() method" data-type="indexterm" id="idm45290633658072"/><code>call()</code> method returns a specific type so the&#13;
interface has a type parameter (<code>V</code> here, for “value”):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">concurrent</code><code class="o">.</code><code class="na">Callable</code><code class="o">&lt;</code><code class="n">V</code><code class="o">&gt;</code> <code class="o">{</code>&#13;
  <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">V</code> <code class="nf">call</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code><code class="o">;</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>You must provide an implementation of the <a data-primary="run() method" data-type="indexterm" id="idm45290633573112"/><code>run()</code> or <code>call()</code> method.&#13;
There is nothing special to this method; it’s an ordinary method and you could call it yourself. But if you did, what then? There wouldn’t be the special magic that launches it as an independent flow of control, so it wouldn’t run concurrently with your main program or flow of control. For this, you need to invoke the magic of thread creation.</p>&#13;
&#13;
<p>The original way of using threads, no longer generally recommended, is to create <code>Thread</code> objects directly&#13;
and call their <a data-primary="start() method" data-type="indexterm" id="idm45290633570632"/><code>start()</code> method, which would cause the thread to call the <code>run()</code> method&#13;
after the new thread had been initialized.&#13;
There was no support for the <code>Callable</code> interface in the original threads model.&#13;
You create threads by doing one of the following things:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Subclass <code>java.lang.Thread</code> (which implements <code>Runnable</code>) and override the <code>run()</code> method.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create your <code>Runnable</code> and pass it into the <code>Thread</code> constructor.</p>&#13;
</li>&#13;
<li>&#13;
<p>With Java 8+, as shown in <a data-type="xref" href="ch09.html#javacook-fp-intro">Recipe 9.0</a>, you can use a&#13;
lambda expression to implement <code>Runnable</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>This approach is no longer recommended because of issues such as performance&#13;
(<code>Thread</code> objects are expensive to create and tear down, and a thread is unusable&#13;
once its <code>run()</code> method returns).&#13;
Because it is no longer recommended to invoke threading in this fashion,&#13;
I no longer show examples of doing so.&#13;
There are some examples in the online source, in the <em>threads</em> directory; see especially <em>ThreadsDemo4</em>.</p>&#13;
&#13;
<p>Instead, the recommended way to perform threaded operations is to use the&#13;
<code>java.util.concurrent</code> package’s <code>ExecutorService</code>.&#13;
An <code>ExecutorService</code> is, as its name implies, a service class that can execute code for you.&#13;
The code to be executed can be in a <code>Runnable</code> or a <code>Callable</code>.&#13;
You obtain an <code>ExecutorService</code> by invoking a factory method on the <code>Executors</code> class.&#13;
The code in <a data-type="xref" href="#javacook-threads-EX-16">Example 16-1</a> shows a simple example of a thread pool.</p>&#13;
<div data-type="example" id="javacook-threads-EX-16">&#13;
<h5><span class="label">Example 16-1. </span>main/src/main/java/threads/ThreadPoolDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="kd">final</code> <code class="n">ExecutorService</code> <code class="n">pool</code> <code class="o">=</code> <code class="n">Executors</code><code class="o">.</code><code class="na">newFixedThreadPool</code><code class="o">(</code><code class="n">HOWMANY</code><code class="o">);</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">&gt;&gt;</code> <code class="n">futures</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;(</code><code class="n">HOWMANY</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">HOWMANY</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="n">Future</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">&gt;</code> <code class="n">f</code> <code class="o">=</code> <code class="n">pool</code><code class="o">.</code><code class="na">submit</code><code class="o">(</code><code class="k">new</code> <code class="n">DemoRunnable</code><code class="o">(</code><code class="n">i</code><code class="o">));</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Got 'Future' of type "</code> <code class="o">+</code> <code class="n">f</code><code class="o">.</code><code class="na">getClass</code><code class="o">());</code>&#13;
            <code class="n">futures</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">f</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">3</code> <code class="o">*</code> <code class="mi">1000</code><code class="o">);</code>&#13;
        <code class="n">done</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">Future</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">&gt;</code> <code class="n">f</code> <code class="o">:</code> <code class="n">futures</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Result "</code> <code class="o">+</code> <code class="n">f</code><code class="o">.</code><code class="na">get</code><code class="o">());</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">pool</code><code class="o">.</code><code class="na">shutdown</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>This will print a series of lines like the following, showing the threads running&#13;
interspersed:</p>&#13;
&#13;
<pre data-type="programlisting">Running Thread[pool-1-thread-3,5,main]&#13;
Running Thread[pool-1-thread-3,5,main]&#13;
Running Thread[pool-1-thread-1,5,main]&#13;
Running Thread[pool-1-thread-1,5,main]</pre>&#13;
&#13;
<p>Note that there are several submission methods, the first in the parent interface <code>Executor</code>&#13;
and two more in <code>ExecutorService</code>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kt">void</code> <code class="nf">execute</code><code class="o">(</code><code class="n">Runnable</code><code class="o">);</code>&#13;
<code class="kd">public</code> <code class="n">Future</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code> <code class="nf">submit</code><code class="o">(</code><code class="n">Callable</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;);</code>&#13;
<code class="kd">public</code> <code class="n">Future</code><code class="o">&lt;</code><code class="n">T</code><code class="o">&gt;</code> <code class="nf">submit</code><code class="o">(</code><code class="n">Runnable</code><code class="o">);</code></pre>&#13;
&#13;
<p>That is, <a data-primary="execute() method" data-type="indexterm" id="idm45290633405064"/><code>execute()</code> takes a <code>Runnable</code> and returns nothing,&#13;
whilst the <code>submit()</code> methods both return a <code>Future&lt;T&gt;</code>&#13;
(for the method <code>submit(Runnable)</code>, the type parameter <code>x</code> is always <code>java.lang.Void</code>).</p>&#13;
&#13;
<p>When you are finished with the thread pool, you should call its <code>shutDown()</code> method.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="javacook-threaded-FUTURE">&#13;
<h5>Understanding Future and CompletableFuture</h5>&#13;
<p><a data-primary="Future interface" data-type="indexterm" id="idm45290633391352"/><code>Future</code> is an interface representing a claim ticket on some deliverable&#13;
that may or may not be ready.&#13;
It’s a software analogue of the claim ticket you are given when you&#13;
take laundry in to a dry cleaning service&#13;
or take some item in to be repaired. The following describes the important methods of the <code>Future</code> interface:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">interface</code> <code class="nc">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">concurrent</code><code class="o">.</code><code class="na">Future</code><code class="o">&lt;</code><code class="n">V</code><code class="o">&gt;</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">isDone</code><code class="o">();</code>&#13;
    <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">V</code> <code class="nf">get</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">InterruptedException</code><code class="o">,</code>&#13;
        <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">concurrent</code><code class="o">.</code><code class="na">ExecutionException</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">V</code> <code class="nf">get</code><code class="o">(</code><code class="kt">long</code><code class="o">,</code> <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">concurrent</code><code class="o">.</code><code class="na">TimeUnit</code><code class="o">)</code>&#13;
        <code class="kd">throws</code> <code class="n">InterruptedException</code><code class="o">,</code>&#13;
        <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">concurrent</code><code class="o">.</code><code class="na">ExecutionException</code><code class="o">,</code>&#13;
        <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">concurrent</code><code class="o">.</code><code class="na">TimeoutException</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">cancel</code><code class="o">(</code><code class="kt">boolean</code><code class="o">);</code>&#13;
    <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">isCancelled</code><code class="o">();</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>The purpose of each method in this interface is shown here:</p>&#13;
<dl>&#13;
<dt><a data-primary="isDone() method" data-type="indexterm" id="idm45290633173960"/><code>isDone()</code></dt>&#13;
<dd>&#13;
<p>Returns true if the operation that will deliver the result has completed</p>&#13;
</dd>&#13;
<dt><a data-primary="get() method" data-type="indexterm" id="idm45290633172024"/><code>get()</code></dt>&#13;
<dd>&#13;
<p>Will return the deliverable immediately if <code>isDone()</code> is true;&#13;
else will block indefinitely until it becomes true</p>&#13;
</dd>&#13;
<dt><code>get(long, TimeUnit)</code></dt>&#13;
<dd>&#13;
<p>Will return the deliverable immediately if <code>isDone()</code> is true,&#13;
blocking until it becomes true, or&#13;
until  the specified time has elapsed, in which case it will throw a <code>TimeoutException</code></p>&#13;
</dd>&#13;
<dt><a data-primary="cancel() method" data-type="indexterm" id="idm45290633167224"/><code>cancel(boolean)</code></dt>&#13;
<dd>&#13;
<p>Will cancel the operation if it hasn’t started (if the <code>boolean</code> is false)&#13;
or even if it is in process (if the <code>boolean</code> is true)</p>&#13;
</dd>&#13;
<dt><a data-primary="isCancelled() method" data-type="indexterm" id="idm45290633164184"/><code>isCancelled()</code></dt>&#13;
<dd>&#13;
<p>Returns true if the operation has been canceled</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><code>Future</code> is commonly returned from a thread pool <code>execute()</code> operation, as shown in&#13;
<a data-type="xref" href="#javacook-threads-EX-62">Example 16-2</a>.</p>&#13;
<div data-type="example" id="javacook-threads-EX-62">&#13;
<h5><span class="label">Example 16-2. </span>main/src/main/java/threads/FutureFromThreadpool.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">        <code class="kt">double</code> <code class="n">d</code> <code class="o">=</code> <code class="mi">2</code><code class="o">;</code>&#13;
        <code class="n">Callable</code><code class="o">&lt;</code><code class="n">Double</code><code class="o">&gt;</code> <code class="n">computeTotal</code> <code class="o">=</code> <code class="o">()</code> <code class="o">-&gt;</code> <code class="n">d</code> <code class="o">+</code> <code class="n">d</code><code class="o">;</code>&#13;
        <code class="n">Future</code><code class="o">&lt;</code><code class="n">Double</code><code class="o">&gt;</code> <code class="n">future</code> <code class="o">=</code> <code class="n">threadPool</code><code class="o">.</code><code class="na">submit</code><code class="o">(</code><code class="n">computeTotal</code><code class="o">);</code>&#13;
        <code class="k">while</code> <code class="o">(!</code><code class="n">future</code><code class="o">.</code><code class="na">isDone</code><code class="o">())</code> <code class="o">{</code>&#13;
            <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">100</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="kt">double</code> <code class="n">value</code> <code class="o">=</code> <code class="n">future</code><code class="o">.</code><code class="na">get</code><code class="o">();</code>&#13;
        <code class="n">process</code><code class="o">(</code><code class="n">value</code><code class="o">);</code>&#13;
        <code class="n">threadPool</code><code class="o">.</code><code class="na">shutdown</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>There are many classes implementing <code>Future</code> in various parts of Java SE and Jakarta.&#13;
The most general and powerful is <code>CompletableFuture&lt;V&gt;</code>,&#13;
so called because you can control it by calling a <code>complete(V)</code> method at any time.&#13;
This has far too many public methods (120) for a complete treatment here.&#13;
In fairness, the number of methods is high because many methods can accept&#13;
either a <code>Runnable</code> or a <code>Callable</code>, and many have multiple overloads&#13;
(a plain one, one with <code>Async</code> appended to the name, and one with <code>Async</code>&#13;
that lets you provide the <code>Executor</code>).  I’ll show examples of these shortly.</p>&#13;
&#13;
<p>You can create an empty <code>CompletableFuture</code> by calling a no-argument constructor,&#13;
making this available to some calling code,&#13;
and calling its <a data-primary="complete() method" data-type="indexterm" id="idm45290633075768"/><code>complete()</code> method when you have a result:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Integer</code><code class="o">&gt;</code> <code class="n">cf</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CompletableFuture</code><code class="o">&lt;&gt;();</code>&#13;
<code class="c1">// Do some work</code>&#13;
<code class="n">cf</code><code class="o">.</code><code class="na">complete</code><code class="o">();</code></pre>&#13;
&#13;
<p>Many of the more interesting methods in <code>CompletableFuture</code> have to do with chaining operations.&#13;
First, you can specify a function to be invoked automatically when the result is ready:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting">  <code class="kd">public</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">thenRun</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">Runnable</code><code class="o">);</code>&#13;
  <code class="kd">public</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">thenRunAsync</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">Runnable</code><code class="o">);</code>&#13;
  <code class="kd">public</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">thenRunAsync</code><code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">lang</code><code class="o">.</code><code class="na">Runnable</code><code class="o">,</code> <code class="n">Executor</code><code class="o">);</code>&#13;
  <code class="kd">public</code> <code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code> <code class="n">thenApply</code><code class="o">(</code>&#13;
      <code class="n">Function</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">T</code><code class="o">,</code>&#13;
          <code class="o">?</code> <code class="kd">extends</code> <code class="n">U</code><code class="o">&gt;);</code>&#13;
  <code class="kd">public</code> <code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code> <code class="n">thenApplyAsync</code><code class="o">(</code>&#13;
      <code class="n">Function</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">T</code><code class="o">,</code>&#13;
          <code class="o">?</code> <code class="kd">extends</code> <code class="n">U</code><code class="o">&gt;);</code>&#13;
  <code class="kd">public</code> <code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">U</code><code class="o">&gt;</code> <code class="n">thenApplyAsync</code><code class="o">(</code>&#13;
      <code class="n">Function</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">T</code><code class="o">,</code>&#13;
          <code class="o">?</code> <code class="kd">extends</code> <code class="n">U</code><code class="o">&gt;,</code> <code class="n">Executor</code><code class="o">);</code>&#13;
  <code class="kd">public</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">thenAccept</code><code class="o">(</code><code class="n">Consumer</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">T</code><code class="o">&gt;);</code>&#13;
  <code class="kd">public</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">thenAcceptAsync</code><code class="o">(</code><code class="n">Consumer</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">T</code><code class="o">&gt;);</code>&#13;
  <code class="kd">public</code> <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">thenAcceptAsync</code><code class="o">(</code>&#13;
      <code class="n">Consumer</code><code class="o">&lt;?</code> <code class="kd">super</code> <code class="n">T</code><code class="o">&gt;,</code> <code class="n">Executor</code><code class="o">);</code></pre>&#13;
&#13;
<p>These methods will invoke the given <code>Runnable</code>, <code>Consumer</code>, or <code>Function</code> after the <code>Future</code> is completed.&#13;
Each of these exists in the three forms as mentioned above.&#13;
The first will run it on the same thread as the main task.&#13;
The second method will run it in a default executor. The third allows you to&#13;
provide your own executor.&#13;
<a data-type="xref" href="#javacook-threads-EX-88">Example 16-3</a> is a simple demo of creating a <code>CompletableFuture</code>,&#13;
giving it a <code>thenApply</code> method call and a final <code>run</code> method, both of which don’t fire&#13;
until the <code>Future</code> is completed.</p>&#13;
<div data-type="example" id="javacook-threads-EX-88">&#13;
<h5><span class="label">Example 16-3. </span>main/src/main/java/threads/CompletableFutureSimple.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">CompletableFutureSimple</code> <code class="o">{</code>&#13;
    <code class="kd">static</code> <code class="n">String</code> <code class="nf">twice</code><code class="o">(</code><code class="n">String</code> <code class="n">x</code><code class="o">)</code> <code class="o">{</code> <code class="k">return</code> <code class="n">x</code> <code class="o">+</code> <code class="sc">' '</code> <code class="o">+</code> <code class="n">x</code><code class="o">;</code> <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">CompletableFuture</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">cf</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CompletableFuture</code><code class="o">&lt;&gt;();</code>&#13;
        <code class="n">cf</code><code class="o">.</code><code class="na">thenApply</code><code class="o">(</code><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">twice</code><code class="o">(</code><code class="n">x</code><code class="o">))</code>&#13;
          <code class="o">.</code><code class="na">thenAccept</code><code class="o">(</code><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">x</code><code class="o">));</code>&#13;
        <code class="c1">// Possibly some computation going on here... Then:</code>&#13;
        <code class="n">cf</code><code class="o">.</code><code class="na">complete</code><code class="o">(</code><code class="s">"Hello"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The online source includes <em>CompletableFutureDemo.java</em>, which offers&#13;
some more sophisticated examples.<a data-primary="" data-startref="thr_con" data-type="indexterm" id="idm45290632818264"/></p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.2 Displaying a Moving Image with Animation" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-2">&#13;
<h1>16.2 Displaying a Moving Image with Animation</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-2.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="animation" data-type="indexterm" id="ani_ab"/><a data-primary="threading" data-secondary="animation" data-type="indexterm" id="thr_ani"/>You need to update a graphical display while other parts of the program are running.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-2.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a background thread to drive the animation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-2.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>One common use of threads is an animator, a class that displays a moving image. This animator program does just that. It draws a graphical image  at locations around the screen; the location is updated and redrawn from a different <code>Thread</code> for each such image so that all the animations run in parallel.  You can see the program running in <a data-type="xref" href="#javacook-threads-FIG-1">Figure 16-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="javacook-threads-FIG-1">&#13;
<img alt="jcb4 1601" src="assets/jcb4_1601.png"/>&#13;
<h6><span class="label">Figure 16-1. </span>Animator</h6>&#13;
</div></figure>&#13;
&#13;
<p>The code for the animator program consists of two classes, <code>Sprite</code> (see <a data-type="xref" href="#javacook-threads-EX-4ch22">Example 16-4</a>) and <code>Bounce</code><sup><a data-type="noteref" href="ch16.html#idm45290632776280" id="idm45290632776280-marker">2</a></sup> (see <a data-type="xref" href="#javacook-threads-EX-5">Example 16-5</a>). A <code>Sprite</code> is one image that moves around; <code>Bounce</code> is the main program.</p>&#13;
<div data-type="example" id="javacook-threads-EX-4ch22">&#13;
<h5><span class="label">Example 16-4. </span>main/src/main/java/threads/Sprite.java (part of animator program)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/** A Sprite is one Image that moves around the screen on its own */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Sprite</code> <code class="kd">extends</code> <code class="n">Component</code> <code class="kd">implements</code> <code class="n">Runnable</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">serialVersionUID</code> <code class="o">=</code> <code class="mi">1L</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">spriteNumber</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="kt">int</code> <code class="n">number</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="kt">int</code> <code class="n">x</code><code class="o">,</code> <code class="n">y</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="n">Component</code> <code class="n">parent</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="n">Image</code> <code class="n">image</code><code class="o">;</code>&#13;
    <code class="kd">protected</code> <code class="kd">volatile</code> <code class="kt">boolean</code> <code class="n">done</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
    <code class="cm">/** The time in mSec to pause between each move. */</code>&#13;
    <code class="kd">protected</code> <code class="kd">volatile</code> <code class="kt">int</code> <code class="n">sleepTime</code> <code class="o">=</code> <code class="mi">250</code><code class="o">;</code>&#13;
    <code class="cm">/** The direction for this particular sprite. */</code>&#13;
    <code class="kd">protected</code> <code class="n">Direction</code> <code class="n">direction</code><code class="o">;</code>&#13;
    <code class="kd">enum</code> <code class="n">Direction</code> <code class="o">{</code>&#13;
        <code class="n">VERTICAL</code><code class="o">,</code> <code class="n">HORIZONTAL</code><code class="o">,</code> <code class="n">DIAGONAL</code>&#13;
    <code class="o">}</code>&#13;
    <code class="cm">/** Construct a Sprite with a Component parent, image and direction.</code>&#13;
<code class="cm">     * Construct and start a Thread to drive this Sprite.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="nf">Sprite</code><code class="o">(</code><code class="n">Component</code> <code class="n">parent</code><code class="o">,</code> <code class="n">Image</code> <code class="n">image</code><code class="o">,</code> <code class="n">Direction</code> <code class="n">direction</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">parent</code> <code class="o">=</code> <code class="n">parent</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">image</code> <code class="o">=</code> <code class="n">image</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">direction</code> <code class="o">=</code> <code class="n">direction</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">number</code> <code class="o">=</code> <code class="n">Sprite</code><code class="o">.</code><code class="na">spriteNumber</code><code class="o">++;</code>&#13;
        <code class="n">setSize</code><code class="o">(</code><code class="n">image</code><code class="o">.</code><code class="na">getWidth</code><code class="o">(</code><code class="k">this</code><code class="o">),</code> <code class="n">image</code><code class="o">.</code><code class="na">getHeight</code><code class="o">(</code><code class="k">this</code><code class="o">));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Construct a Sprite with the default direction */</code>&#13;
    <code class="kd">public</code> <code class="nf">Sprite</code><code class="o">(</code><code class="n">Component</code> <code class="n">parent</code><code class="o">,</code> <code class="n">Image</code> <code class="n">image</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">(</code><code class="n">parent</code><code class="o">,</code> <code class="n">image</code><code class="o">,</code> <code class="n">Direction</code><code class="o">.</code><code class="na">DIAGONAL</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Stop this Sprite. */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">stop</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Stopping "</code> <code class="o">+</code> <code class="n">number</code><code class="o">);</code>&#13;
        <code class="n">done</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Adjust the motion rate */</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">setSleepTime</code><code class="o">(</code><code class="kt">int</code> <code class="n">n</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">sleepTime</code> <code class="o">=</code> <code class="n">n</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/**</code>&#13;
<code class="cm">     * Run one Sprite around the screen.</code>&#13;
<code class="cm">     * This version just moves them around either across, down, or</code>&#13;
<code class="cm">     * at some 45-degree angle.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="kt">int</code> <code class="n">width</code> <code class="o">=</code> <code class="n">parent</code><code class="o">.</code><code class="na">getSize</code><code class="o">().</code><code class="na">width</code><code class="o">;</code>&#13;
        <code class="kt">int</code> <code class="n">height</code> <code class="o">=</code> <code class="n">parent</code><code class="o">.</code><code class="na">getSize</code><code class="o">().</code><code class="na">height</code><code class="o">;</code>&#13;
        <code class="c1">// Set initial location</code>&#13;
        <code class="n">x</code> <code class="o">=</code> <code class="o">(</code><code class="kt">int</code><code class="o">)(</code><code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()</code> <code class="o">*</code> <code class="n">width</code><code class="o">);</code>&#13;
        <code class="n">y</code> <code class="o">=</code> <code class="o">(</code><code class="kt">int</code><code class="o">)(</code><code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()</code> <code class="o">*</code> <code class="n">height</code><code class="o">);</code>&#13;
        <code class="c1">// Flip coin for x &amp; y directions</code>&#13;
        <code class="kt">int</code> <code class="n">xincr</code> <code class="o">=</code> <code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()&gt;</code><code class="mf">0.5</code><code class="o">?</code><code class="mi">1</code><code class="o">:-</code><code class="mi">1</code><code class="o">;</code>&#13;
        <code class="kt">int</code> <code class="n">yincr</code> <code class="o">=</code> <code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()&gt;</code><code class="mf">0.5</code><code class="o">?</code><code class="mi">1</code><code class="o">:-</code><code class="mi">1</code><code class="o">;</code>&#13;
        <code class="k">while</code> <code class="o">(!</code><code class="n">done</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">width</code> <code class="o">=</code> <code class="n">parent</code><code class="o">.</code><code class="na">getSize</code><code class="o">().</code><code class="na">width</code><code class="o">;</code>&#13;
            <code class="n">height</code> <code class="o">=</code> <code class="n">parent</code><code class="o">.</code><code class="na">getSize</code><code class="o">().</code><code class="na">height</code><code class="o">;</code>&#13;
            <code class="k">if</code> <code class="o">((</code><code class="n">x</code><code class="o">+=</code><code class="n">xincr</code><code class="o">)</code> <code class="o">&gt;=</code> <code class="n">width</code><code class="o">)</code>&#13;
                <code class="n">x</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code>&#13;
            <code class="k">if</code> <code class="o">((</code><code class="n">y</code><code class="o">+=</code><code class="n">yincr</code><code class="o">)</code> <code class="o">&gt;=</code> <code class="n">height</code><code class="o">)</code>&#13;
                <code class="n">y</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">x</code><code class="o">&lt;</code><code class="mi">0</code><code class="o">)</code>&#13;
                <code class="n">x</code> <code class="o">=</code> <code class="n">width</code><code class="o">;</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">y</code><code class="o">&lt;</code><code class="mi">0</code><code class="o">)</code>&#13;
                <code class="n">y</code> <code class="o">=</code> <code class="n">height</code><code class="o">;</code>&#13;
            <code class="k">switch</code><code class="o">(</code><code class="n">direction</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="k">case</code> <code class="nl">VERTICAL:</code>&#13;
                    <code class="n">x</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>&#13;
                    <code class="k">break</code><code class="o">;</code>&#13;
                <code class="k">case</code> <code class="nl">HORIZONTAL:</code>&#13;
                    <code class="n">y</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>&#13;
                    <code class="k">break</code><code class="o">;</code>&#13;
                <code class="k">case</code> <code class="nl">DIAGONAL:</code>&#13;
                    <code class="c1">// Let it wrap around</code>&#13;
                    <code class="k">break</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="c1">//System.out.println("from " + getLocation() + "-&gt;" + x + "," + y);</code>&#13;
            <code class="n">setLocation</code><code class="o">(</code><code class="n">x</code><code class="o">,</code> <code class="n">y</code><code class="o">);</code>&#13;
            <code class="n">repaint</code><code class="o">();</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="n">sleepTime</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="k">return</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** paint -- just draw our image at its current location */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">paint</code><code class="o">(</code><code class="n">Graphics</code> <code class="n">g</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">g</code><code class="o">.</code><code class="na">drawImage</code><code class="o">(</code><code class="n">image</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="k">this</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>This example features several uses of the <code>volatile</code> keyword.&#13;
The <code>volatile</code> keyword is used to inform Java that a variable&#13;
is subject to change by more than one thread, so that its&#13;
current value must always be fetched when it is used.&#13;
Absent this keyword, it is legal for Java to use a cached&#13;
version of the given variable. That increases performance when&#13;
a variable is only used in one thread, but (without <code>volatile</code>)&#13;
can give incorrect results when the variable is modified in&#13;
one thread and observed in another.<a data-primary="" data-startref="ani_ab" data-type="indexterm" id="idm45290632525864"/><a data-primary="" data-startref="thr_ani" data-type="indexterm" id="idm45290632524952"/></p>&#13;
<div data-type="example" id="javacook-threads-EX-5">&#13;
<h5><span class="label">Example 16-5. </span>main/src/main/java/threads/Bounce.java (part of animator program)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Bounce</code> <code class="kd">extends</code> <code class="n">JPanel</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">serialVersionUID</code> <code class="o">=</code> <code class="o">-</code><code class="mi">5359162621719520213L</code><code class="o">;</code>&#13;
    <code class="cm">/** The main Panel */</code>&#13;
    <code class="kd">protected</code> <code class="n">JPanel</code> <code class="n">p</code><code class="o">;</code>&#13;
    <code class="cm">/** The image, shared by all the Sprite objects */</code>&#13;
    <code class="kd">protected</code> <code class="n">Image</code> <code class="n">img</code><code class="o">;</code>&#13;
    <code class="cm">/** A Thread Pool */</code>&#13;
    <code class="kd">protected</code> <code class="n">ExecutorService</code> <code class="n">tp</code> <code class="o">=</code> <code class="n">Executors</code><code class="o">.</code><code class="na">newCachedThreadPool</code><code class="o">();</code>&#13;
    <code class="cm">/** A Vector of Sprite objects. */</code>&#13;
    <code class="kd">protected</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Sprite</code><code class="o">&gt;</code> <code class="n">v</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="o">&lt;</code><code class="n">Sprite</code><code class="o">&gt;();</code> <code class="c1">// multithreaded, use Vector;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">JFrame</code> <code class="n">jf</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JFrame</code><code class="o">(</code><code class="s">"Bounce Demo"</code><code class="o">);</code>&#13;
        <code class="n">jf</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="k">new</code> <code class="n">Bounce</code><code class="o">(</code><code class="n">args</code><code class="o">.</code><code class="na">length</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="o">?</code> <code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">:</code> <code class="kc">null</code><code class="o">));</code>&#13;
        <code class="n">jf</code><code class="o">.</code><code class="na">setSize</code><code class="o">(</code><code class="mi">300</code><code class="o">,</code> <code class="mi">300</code><code class="o">);</code>&#13;
        <code class="n">jf</code><code class="o">.</code><code class="na">setVisible</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>&#13;
        <code class="n">jf</code><code class="o">.</code><code class="na">setDefaultCloseOperation</code><code class="o">(</code><code class="n">JFrame</code><code class="o">.</code><code class="na">EXIT_ON_CLOSE</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Bounce</code><code class="o">(</code><code class="n">String</code> <code class="n">imgName</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">setLayout</code><code class="o">(</code><code class="k">new</code> <code class="n">BorderLayout</code><code class="o">());</code>&#13;
        <code class="n">JButton</code> <code class="n">b</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Add a Sprite"</code><code class="o">);</code>&#13;
        <code class="n">b</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Creating another one!"</code><code class="o">);</code>&#13;
            <code class="n">Sprite</code> <code class="n">s</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Sprite</code><code class="o">(</code><code class="k">this</code><code class="o">,</code> <code class="n">img</code><code class="o">);</code>&#13;
            <code class="n">tp</code><code class="o">.</code><code class="na">execute</code><code class="o">(</code><code class="n">s</code><code class="o">);</code>&#13;
            <code class="n">p</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">s</code><code class="o">);</code>&#13;
            <code class="n">v</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">s</code><code class="o">);</code>&#13;
        <code class="o">});</code>&#13;
        <code class="n">add</code><code class="o">(</code><code class="n">b</code><code class="o">,</code> <code class="n">BorderLayout</code><code class="o">.</code><code class="na">NORTH</code><code class="o">);</code>&#13;
        <code class="n">add</code><code class="o">(</code><code class="n">p</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JPanel</code><code class="o">(),</code> <code class="n">BorderLayout</code><code class="o">.</code><code class="na">CENTER</code><code class="o">);</code>&#13;
        <code class="n">p</code><code class="o">.</code><code class="na">setLayout</code><code class="o">(</code><code class="kc">null</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">imgName</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="n">imgName</code> <code class="o">=</code> <code class="s">"duke.gif"</code><code class="o">;</code>&#13;
        <code class="kd">final</code> <code class="n">URL</code> <code class="n">resource</code> <code class="o">=</code> <code class="n">getClass</code><code class="o">().</code><code class="na">getResource</code><code class="o">(</code><code class="s">"/"</code> <code class="o">+</code> <code class="n">imgName</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">resource</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalStateException</code><code class="o">(</code><code class="s">"Could not load image "</code> <code class="o">+</code> <code class="n">imgName</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">img</code> <code class="o">=</code> <code class="n">Toolkit</code><code class="o">.</code><code class="na">getDefaultToolkit</code><code class="o">().</code><code class="na">getImage</code><code class="o">(</code><code class="n">resource</code><code class="o">);</code>&#13;
        <code class="n">MediaTracker</code> <code class="n">mt</code> <code class="o">=</code> <code class="k">new</code> <code class="n">MediaTracker</code><code class="o">(</code><code class="k">this</code><code class="o">);</code>&#13;
        <code class="n">mt</code><code class="o">.</code><code class="na">addImage</code><code class="o">(</code><code class="n">img</code><code class="o">,</code> <code class="mi">0</code><code class="o">);</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">mt</code><code class="o">.</code><code class="na">waitForID</code><code class="o">(</code><code class="mi">0</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code><code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code>&#13;
                <code class="s">"InterruptedException while loading image "</code> <code class="o">+</code> <code class="n">imgName</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">mt</code><code class="o">.</code><code class="na">isErrorID</code><code class="o">(</code><code class="mi">0</code><code class="o">))</code> <code class="o">{</code>&#13;
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IllegalArgumentException</code><code class="o">(</code>&#13;
                <code class="s">"Couldn't load image "</code> <code class="o">+</code> <code class="n">imgName</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">JButton</code> <code class="n">stopper</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JButton</code><code class="o">(</code><code class="s">"Shut down"</code><code class="o">);</code>&#13;
        <code class="n">stopper</code><code class="o">.</code><code class="na">addActionListener</code><code class="o">(</code><code class="n">e</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
            <code class="n">stop</code><code class="o">();</code>&#13;
            <code class="n">tp</code><code class="o">.</code><code class="na">shutdown</code><code class="o">();</code>&#13;
        <code class="o">});</code>&#13;
        <code class="n">add</code><code class="o">(</code><code class="n">stopper</code><code class="o">,</code> <code class="n">BorderLayout</code><code class="o">.</code><code class="na">SOUTH</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">stop</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="n">Sprite</code> <code class="n">s</code> <code class="o">:</code> <code class="n">v</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">s</code><code class="o">.</code><code class="na">stop</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">v</code><code class="o">.</code><code class="na">clear</code><code class="o">();</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">tp</code><code class="o">.</code><code class="na">awaitTermination</code><code class="o">(</code><code class="mi">5</code><code class="o">,</code> <code class="n">TimeUnit</code><code class="o">.</code><code class="na">SECONDS</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"ThreadPool is shut down, ending program"</code><code class="o">);</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">exit</code><code class="o">(</code><code class="mi">0</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// Empty</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.3 Stopping a Thread" data-type="sect1"><div class="sect1" id="javacook-threads-stopping">&#13;
<h1>16.3 Stopping a Thread</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-stopping.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="threading" data-secondary="stopping" data-type="indexterm" id="thr_sto"/>You need to stop a thread.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-stopping.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Don’t use the <a data-primary="stop() method" data-type="indexterm" id="idm45290631662216"/><code>Thread.stop()</code> method; instead, use a <code>boolean</code> tested at the top of the main loop&#13;
in the <a data-primary="run() method" data-type="indexterm" id="idm45290631660680"/><code>run()</code> method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-stopping.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Though you can use the thread’s <code>stop()</code> method, it is not recommended. That’s because the method is so drastic that it can never be made to behave reliably in a program with multiple active threads. That is why, when you try to use it, the compiler will generate deprecation warnings. The recommended method is to use a <code>boolean</code> variable in the main loop of the <code>run()</code> method. The program in <a data-type="xref" href="#javacook-threads-EX-6">Example 16-6</a> prints a message endlessly until its<a data-primary="shutDown() method" data-type="indexterm" id="idm45290631654696"/> <code>shutDown()</code> method is called; it then sets the controlling variable <code>done</code> to false, which terminates the loop. This causes the <code>run()</code> method to return, ending its processing.</p>&#13;
<div data-type="example" id="javacook-threads-EX-6">&#13;
<h5><span class="label">Example 16-6. </span>main/src/main/java/threads/StopBoolean.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StopBoolean</code> <code class="o">{</code>&#13;
&#13;
    <code class="c1">// Must be volatile to ensure changes visible to other threads.</code>&#13;
    <code class="kd">protected</code> <code class="kd">volatile</code> <code class="kt">boolean</code> <code class="n">done</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
&#13;
    <code class="n">Runnable</code> <code class="n">r</code> <code class="o">=</code> <code class="o">()</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
        <code class="k">while</code> <code class="o">(!</code><code class="n">done</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"StopBoolean running"</code><code class="o">);</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">720</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="c1">// nothing to do</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"StopBoolean finished."</code><code class="o">);</code>&#13;
    <code class="o">};</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shutDown</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Shutting down..."</code><code class="o">);</code>&#13;
        <code class="n">done</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">doDemo</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">InterruptedException</code> <code class="o">{</code>&#13;
        <code class="n">ExecutorService</code> <code class="n">pool</code> <code class="o">=</code> <code class="n">Executors</code><code class="o">.</code><code class="na">newSingleThreadExecutor</code><code class="o">();</code>&#13;
        <code class="n">pool</code><code class="o">.</code><code class="na">submit</code><code class="o">(</code><code class="n">r</code><code class="o">);</code>&#13;
        <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">1000</code><code class="o">*</code><code class="mi">5</code><code class="o">);</code>&#13;
        <code class="n">shutDown</code><code class="o">();</code>&#13;
        <code class="n">pool</code><code class="o">.</code><code class="na">shutdown</code><code class="o">();</code>&#13;
        <code class="n">pool</code><code class="o">.</code><code class="na">awaitTermination</code><code class="o">(</code><code class="mi">2</code><code class="o">,</code> <code class="n">TimeUnit</code><code class="o">.</code><code class="na">SECONDS</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">InterruptedException</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">StopBoolean</code><code class="o">().</code><code class="na">doDemo</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Running it looks like this:</p>&#13;
&#13;
<pre data-type="programlisting">StopBoolean running&#13;
StopBoolean running&#13;
StopBoolean running&#13;
StopBoolean running&#13;
StopBoolean running&#13;
StopBoolean running&#13;
StopBoolean running&#13;
StopBoolean finished.</pre>&#13;
&#13;
<p>But what if your thread is blocked reading from a network connection? You then cannot check a <code>boolean</code>, because the thread that is reading is asleep. This is what the <code>stop</code> method was designed for, but, as we’ve seen, it is now deprecated. Instead, you can simply close the socket. The program shown in <a data-type="xref" href="#javacook-threads-EX-7">Example 16-7</a> intentionally deadlocks itself by reading from a socket that you are supposed to write to, simply to demonstrate that closing the socket does in fact terminate the loop.</p>&#13;
<div data-type="example" id="javacook-threads-EX-7">&#13;
<h5><span class="label">Example 16-7. </span>main/src/main/java/threads/StopClose.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">StopClose</code> <code class="kd">extends</code> <code class="n">Thread</code> <code class="o">{</code>&#13;
    <code class="kd">protected</code> <code class="n">Socket</code> <code class="n">io</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">io</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Socket</code><code class="o">(</code><code class="s">"java.sun.com"</code><code class="o">,</code> <code class="mi">80</code><code class="o">);</code>    <code class="c1">// HTTP</code>&#13;
            <code class="n">BufferedReader</code> <code class="n">is</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="o">(</code>&#13;
                <code class="k">new</code> <code class="nf">InputStreamReader</code><code class="o">(</code><code class="n">io</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">()));</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"StopClose reading"</code><code class="o">);</code>&#13;
&#13;
            <code class="c1">// The following line will deadlock (intentionally), since HTTP</code>&#13;
            <code class="c1">// enjoins the client to send a request (like "GET / HTTP/1.0")</code>&#13;
            <code class="c1">// and a null line, before reading the response.</code>&#13;
&#13;
            <code class="n">String</code> <code class="n">line</code> <code class="o">=</code> <code class="n">is</code><code class="o">.</code><code class="na">readLine</code><code class="o">();</code>    <code class="c1">// DEADLOCK</code>&#13;
&#13;
            <code class="c1">// Should only get out of the readLine if an interrupt</code>&#13;
            <code class="c1">// is thrown, as a result of closing the socket.</code>&#13;
&#13;
            <code class="c1">// So we shouldn't get here, ever:</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">printf</code><code class="o">(</code><code class="s">"StopClose FINISHED after reading %s!?"</code><code class="o">,</code> <code class="n">line</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"StopClose terminating: "</code> <code class="o">+</code> <code class="n">ex</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">shutDown</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">io</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// This is supposed to interrupt the waiting read.</code>&#13;
            <code class="kd">synchronized</code><code class="o">(</code><code class="n">io</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">io</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"StopClose.shutDown() completed"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">InterruptedException</code><code class="o">,</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">StopClose</code> <code class="n">t</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StopClose</code><code class="o">();</code>&#13;
        <code class="n">t</code><code class="o">.</code><code class="na">start</code><code class="o">();</code>&#13;
        <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">1000</code><code class="o">*</code><code class="mi">5</code><code class="o">);</code>&#13;
        <code class="n">t</code><code class="o">.</code><code class="na">shutDown</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>When run, it prints a message that the close is happening:</p>&#13;
&#13;
<pre data-type="programlisting">StopClose reading&#13;
StopClose terminating: java.net.SocketException: Resource temporarily unavailable</pre>&#13;
&#13;
<p>“But wait,” you say. “What if I want to break the wait, but not really terminate the socket?” A good question, indeed, and there is no perfect answer. But you can <em>interrupt</em> the thread that is reading; the read is interrupted by a <code>java.io.InterruptedIOException</code>, and you can retry the read. The file <em>Intr.java</em> in this chapter’s source code shows this.<a data-primary="" data-startref="thr_sto" data-type="indexterm" id="idm45290631148872"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.4 Rendezvous and Timeouts" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-4">&#13;
<h1>16.4 Rendezvous and Timeouts</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-4.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="rendezvous" data-type="indexterm" id="idm45290631144952"/><a data-primary="threading" data-secondary="rendezvous" data-type="indexterm" id="idm45290631144248"/><a data-primary="timeouts" data-type="indexterm" id="idm45290631143304"/><a data-primary="threading" data-secondary="timeouts" data-type="indexterm" id="idm45290631142632"/>You need to know whether something finished or whether it finished in a certain length of time.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-4.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Start that something in its own thread and call its <code>join()</code> method with or without a timeout value.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-4.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <a data-primary="join() method" data-type="indexterm" id="idm45290631136952"/><code>join()</code> method of the target thread is used to suspend the current thread until the target thread is finished (returns from its<a data-primary="run() method" data-type="indexterm" id="idm45290631135688"/> <code>run()</code> method). This method is overloaded; a version with no arguments waits forever for the thread to terminate, whereas a version with arguments waits up to the specified time. For a simple example, I create (and start!) a simple thread that just reads from the console terminal, and the main thread simply waits for it. When I run the program, it looks like this:</p>&#13;
<pre data-type="programlisting" id="I_24_tt636">darwinsys.com$ <strong>java threads.Join</strong>&#13;
Starting&#13;
Joining&#13;
Reading&#13;
hello from standard input # waits indefinitely for me to type this line&#13;
Thread Finished.&#13;
Main Finished.&#13;
darwinsys.com$</pre>&#13;
&#13;
<p><a data-type="xref" href="#javacook-threads-EX-8">Example 16-8</a> lists the code for the <code>join()</code> demo.</p>&#13;
<div data-type="example" id="javacook-threads-EX-8">&#13;
<h5><span class="label">Example 16-8. </span>main/src/main/java/threads/Join.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Join</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Thread</code> <code class="n">t</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Thread</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Reading"</code><code class="o">);</code>&#13;
                <code class="k">try</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">in</code><code class="o">.</code><code class="na">read</code><code class="o">();</code>&#13;
                <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">java</code><code class="o">.</code><code class="na">io</code><code class="o">.</code><code class="na">IOException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="n">ex</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Thread Finished."</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">};</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Starting"</code><code class="o">);</code>&#13;
        <code class="n">t</code><code class="o">.</code><code class="na">start</code><code class="o">();</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Joining"</code><code class="o">);</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">t</code><code class="o">.</code><code class="na">join</code><code class="o">();</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// should not happen:</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Who dares interrupt my sleep?"</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Main Finished."</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>As you can see, it uses an inner class <code>Runnable</code> (see <a data-type="xref" href="#javacook-threads-SECT-1">Recipe 16.1</a>) in <code>Thread t</code> to be runnable.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.5 Synchronizing Threads with the synchronized Keyword" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-5">&#13;
<h1>16.5 Synchronizing Threads with the synchronized Keyword</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-5.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="synchronization" data-type="indexterm" id="syn_ab"/><a data-primary="threading" data-secondary="synchronization of" data-type="indexterm" id="thr_syn"/>You need to protect  certain data from access by multiple threads.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-5.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>synchronized</code> keyword on the method or code you wish to protect.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-5.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>I discussed the <code>synchronized</code> keyword briefly in <a data-type="xref" href="ch13.html#javacook-netserver-SECT-4">Recipe 13.5</a>.&#13;
This keyword specifies that only one thread at a time is allowed to run the given method (or any&#13;
other synchronized method in the same class) in a&#13;
given object instance (for static methods, only one thread is allowed to run the method at a time).&#13;
You can synchronize methods or smaller blocks of code. It is easier and safer to&#13;
synchronize entire methods, but this can be more costly in terms of blocking threads that&#13;
could run. You can simply add the <code>synchronized</code> keyword on the method. For example, many of the&#13;
methods of <code>Vector</code> (see <a data-type="xref" href="ch07.html#javacook-structure-SECT-3">Recipe 7.4</a>) are synchronized in order to&#13;
ensure that the vector does not become corrupted or give incorrect results when two&#13;
threads update or retrieve from it at the same time.</p>&#13;
&#13;
<p>Bear in mind that threads can be interrupted at almost any time, in which case control is&#13;
given to another thread. Consider the case of two threads appending to a data structure at&#13;
the same time. Let’s suppose we have the same methods as <code>Vector</code>, but we’re operating on&#13;
a simple array. The<a data-primary="add() method" data-type="indexterm" id="idm45290630893224"/> <code>add()</code> method simply uses the current number of objects as an array&#13;
index, then increments it:</p>&#13;
&#13;
<pre data-type="programlisting">public void add(Object obj) {&#13;
   data[max] = obj; <a class="co" href="#callout_threaded_java_CO1-1" id="co_threaded_java_CO1-1"><img alt="1" src="assets/1.png"/></a>&#13;
   max = max + 1;   <a class="co" href="#callout_threaded_java_CO1-2" id="co_threaded_java_CO1-2"><img alt="2" src="assets/2.png"/></a>&#13;
}</pre>&#13;
&#13;
<p>Threads A and B both wish to call this method. Suppose that Thread A gets interrupted after <a class="co" href="#co_threaded_java_CO1-1"><img alt="1" src="assets/1.png"/></a> but before <a class="co" href="#co_threaded_java_CO1-2"><img alt="2" src="assets/2.png"/></a>, and then Thread B gets to run.</p>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_threaded_java_CO1-1" id="callout_threaded_java_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Thread B does  <a class="co" href="#co_threaded_java_CO1-1"><img alt="1" src="assets/1.png"/></a>, overwriting the contents of <code>data[max]</code>; we’ve now lost all reference to the object that Thread A passed in!</p></dd>&#13;
<dt><a class="co" href="#co_threaded_java_CO1-2" id="callout_threaded_java_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Thread B then increments <code>max</code> at <a class="co" href="#co_threaded_java_CO1-2"><img alt="2" src="assets/2.png"/></a> and returns. Later, Thread A gets to run again; it resumes at <a class="co" href="#co_threaded_java_CO1-2"><img alt="2" src="assets/2.png"/></a> and increments <code>max</code> past the last valid object. So not only have we lost an object, but we have an uninitialized reference in the array. This state of affairs is shown in <a data-type="xref" href="#javacook-threads-FIG-2">Figure 16-2</a>.</p></dd>&#13;
</dl>&#13;
&#13;
<figure><div class="figure" id="javacook-threads-FIG-2">&#13;
<img alt="jcb4 1602" src="assets/jcb4_1602.png"/>&#13;
<h6><span class="label">Figure 16-2. </span>Non-thread-safe add method in operation: normal and failed updates</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now you might think, “No problem, I’ll just combine the two lines of code!”:</p>&#13;
&#13;
<pre data-type="programlisting">data[max++] = obj;</pre>&#13;
&#13;
<p>As the game show host sometimes says, “Bzzzzt! Thanks for playing!” This change makes the&#13;
code a bit shorter but has absolutely no effect on reliability. Interrupts don’t happen&#13;
conveniently on Java statement boundaries; they can happen between any of the many JVM&#13;
machine instructions that correspond to your program. The code can still be interrupted&#13;
after the store and before the increment. The only good solution is to use proper synchronization.</p>&#13;
&#13;
<p>Making the method <code>synchronized</code> means that any invocations of it will wait if one&#13;
thread has already started running the method:</p>&#13;
&#13;
<pre data-type="programlisting">public synchronized void add(Object obj) {&#13;
    ...&#13;
}</pre>&#13;
&#13;
<p>Any time you wish to synchronize some code, but not an entire method, use the <code>synchronized</code> keyword on an unnamed code block within a method, like this:</p>&#13;
&#13;
<pre data-type="programlisting">public void add(Object obj) {&#13;
    synchronized (someObject) {&#13;
        // this code will execute in one thread at a time&#13;
    }&#13;
}</pre>&#13;
&#13;
<p>The choice of object to synchronize on is up to you. Sometimes it makes sense to&#13;
synchronize on the object containing the code, as in <a data-type="xref" href="#javacook-threads-EX-9">Example 16-9</a>. For&#13;
synchronizing access to an <code>ArrayList</code>, it would make sense to use the <code>ArrayList</code>&#13;
instance, like this:</p>&#13;
&#13;
<pre data-type="programlisting">synchronized(myArrayList) {&#13;
     if (myArrayList.indexOf(someObject) != -1) {&#13;
         // do something with it.&#13;
     } else {&#13;
         create an object and add it...&#13;
    }&#13;
}</pre>&#13;
&#13;
<p><a data-type="xref" href="#javacook-threads-EX-9">Example 16-9</a> is a web servlet that I wrote for use in the classroom,&#13;
following a suggestion from fellow Learning Tree instructor Scott Weingust.<sup><a data-type="noteref" href="ch16.html#idm45290630859608" id="idm45290630859608-marker">3</a></sup>&#13;
It lets you play a quiz show game of the style where the host asks a question and the&#13;
first person to press their buzzer (buzz in) gets to try to answer the question correctly.&#13;
To ensure against having two people buzz in simultaneously, the code uses a synchronized&#13;
block around the code that updates the <code>Boolean</code> <code>buzzed</code> variable. And for reliability, any&#13;
code that accesses this <code>Boolean</code> is also synchronized.</p>&#13;
<div data-type="example" id="javacook-threads-EX-9">&#13;
<h5><span class="label">Example 16-9. </span>main/src/main/java/threads/BuzzInServlet.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BuzzInServlet</code> <code class="kd">extends</code> <code class="n">HttpServlet</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** The attribute name used throughout. */</code>&#13;
    <code class="kd">protected</code> <code class="kd">final</code> <code class="kd">static</code> <code class="n">String</code> <code class="n">WINNER</code> <code class="o">=</code> <code class="s">"buzzin.winner"</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** doGet is called from the contestants web page.</code>&#13;
<code class="cm">     * Uses a synchronized code block to ensure that</code>&#13;
<code class="cm">     * only one contestant can change the state of "buzzed".</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">doGet</code><code class="o">(</code><code class="n">HttpServletRequest</code> <code class="n">request</code><code class="o">,</code> <code class="n">HttpServletResponse</code> <code class="n">response</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">ServletException</code><code class="o">,</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">ServletContext</code> <code class="n">application</code> <code class="o">=</code> <code class="n">getServletContext</code><code class="o">();</code>&#13;
&#13;
        <code class="kt">boolean</code> <code class="n">iWon</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
        <code class="n">String</code> <code class="n">user</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="na">getRemoteHost</code><code class="o">()</code> <code class="o">+</code> <code class="sc">'@'</code> <code class="o">+</code> <code class="n">request</code><code class="o">.</code><code class="na">getRemoteAddr</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// Do the synchronized stuff first, and all in one place.</code>&#13;
        <code class="kd">synchronized</code><code class="o">(</code><code class="n">application</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">application</code><code class="o">.</code><code class="na">getAttribute</code><code class="o">(</code><code class="n">WINNER</code><code class="o">)</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">application</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="n">WINNER</code><code class="o">,</code> <code class="n">user</code><code class="o">);</code>&#13;
                <code class="n">application</code><code class="o">.</code><code class="na">log</code><code class="o">(</code><code class="s">"BuzzInServlet: WINNER "</code> <code class="o">+</code> <code class="n">user</code><code class="o">);</code>&#13;
                <code class="n">iWon</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
         <code class="o">}</code>&#13;
&#13;
        <code class="n">response</code><code class="o">.</code><code class="na">setContentType</code><code class="o">(</code><code class="s">"text/html"</code><code class="o">);</code>&#13;
        <code class="n">PrintWriter</code> <code class="n">out</code> <code class="o">=</code> <code class="n">response</code><code class="o">.</code><code class="na">getWriter</code><code class="o">();</code>&#13;
&#13;
        <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Thanks for playing&lt;/title&gt;&lt;/head&gt;"</code><code class="o">);</code>&#13;
        <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;body bgcolor=\"white\"&gt;"</code><code class="o">);</code>&#13;
&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">iWon</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;b&gt;YOU GOT IT&lt;/b&gt;"</code><code class="o">);</code>&#13;
            <code class="c1">// TODO - output HTML to play a sound file :-)</code>&#13;
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Thanks for playing, "</code> <code class="o">+</code> <code class="n">request</code><code class="o">.</code><code class="na">getRemoteAddr</code><code class="o">());</code>&#13;
                <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">", but "</code> <code class="o">+</code> <code class="n">application</code><code class="o">.</code><code class="na">getAttribute</code><code class="o">(</code><code class="n">WINNER</code><code class="o">)</code> <code class="o">+</code>&#13;
                    <code class="s">" buzzed in first"</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;/body&gt;&lt;/html&gt;"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** The Post method is used from an Administrator page (which should</code>&#13;
<code class="cm">     * only be installed in the instructor/host's localweb directory).</code>&#13;
<code class="cm">     * Post is used for administrative functions:</code>&#13;
<code class="cm">     * 1) to display the winner;</code>&#13;
<code class="cm">     * 2) to reset the buzzer for the next question.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">doPost</code><code class="o">(</code><code class="n">HttpServletRequest</code> <code class="n">request</code><code class="o">,</code> <code class="n">HttpServletResponse</code> <code class="n">response</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">ServletException</code><code class="o">,</code> <code class="n">IOException</code> <code class="o">{</code>&#13;
        <code class="n">ServletContext</code> <code class="n">application</code> <code class="o">=</code> <code class="n">getServletContext</code><code class="o">();</code>&#13;
&#13;
        <code class="n">response</code><code class="o">.</code><code class="na">setContentType</code><code class="o">(</code><code class="s">"text/html"</code><code class="o">);</code>&#13;
        <code class="n">HttpSession</code> <code class="n">session</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="na">getSession</code><code class="o">();</code>&#13;
&#13;
        <code class="n">PrintWriter</code> <code class="n">out</code> <code class="o">=</code> <code class="n">response</code><code class="o">.</code><code class="na">getWriter</code><code class="o">();</code>&#13;
&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">request</code><code class="o">.</code><code class="na">isUserInRole</code><code class="o">(</code><code class="s">"host"</code><code class="o">))</code> <code class="o">{</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome back, "</code> <code class="o">+</code>&#13;
                <code class="n">request</code><code class="o">.</code><code class="na">getUserPrincipal</code><code class="o">().</code><code class="na">getName</code><code class="o">()</code> <code class="o">+</code> <code class="s">"&lt;/title&gt;&lt;head&gt;"</code><code class="o">);</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;body bgcolor=\"white\"&gt;"</code><code class="o">);</code>&#13;
            <code class="n">String</code> <code class="n">command</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="na">getParameter</code><code class="o">(</code><code class="s">"command"</code><code class="o">);</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">command</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"reset"</code><code class="o">))</code> <code class="o">{</code>&#13;
&#13;
                <code class="c1">// Synchronize what you need, no more, no less.</code>&#13;
                <code class="kd">synchronized</code><code class="o">(</code><code class="n">application</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">application</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="n">WINNER</code><code class="o">,</code> <code class="kc">null</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
                <code class="n">session</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="s">"buzzin.message"</code><code class="o">,</code> <code class="s">"RESET"</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">else</code> <code class="k">if</code> <code class="o">(</code><code class="n">command</code><code class="o">.</code><code class="na">equals</code><code class="o">(</code><code class="s">"show"</code><code class="o">))</code> <code class="o">{</code>&#13;
                <code class="n">String</code> <code class="n">winner</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
                <code class="kd">synchronized</code><code class="o">(</code><code class="n">application</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">winner</code> <code class="o">=</code> <code class="o">(</code><code class="n">String</code><code class="o">)</code><code class="n">application</code><code class="o">.</code><code class="na">getAttribute</code><code class="o">(</code><code class="n">WINNER</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
                <code class="k">if</code> <code class="o">(</code><code class="n">winner</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">session</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="s">"buzzin.message"</code><code class="o">,</code>&#13;
                        <code class="s">"&lt;b&gt;No winner yet!&lt;/b&gt;"</code><code class="o">);</code>&#13;
                <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                    <code class="n">session</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="s">"buzzin.message"</code><code class="o">,</code>&#13;
                        <code class="s">"&lt;b&gt;Winner is: &lt;/b&gt;"</code> <code class="o">+</code> <code class="n">winner</code><code class="o">);</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">else</code> <code class="o">{</code>&#13;
                <code class="n">session</code><code class="o">.</code><code class="na">setAttribute</code><code class="o">(</code><code class="s">"buzzin.message"</code><code class="o">,</code>&#13;
                    <code class="s">"ERROR: Command "</code> <code class="o">+</code> <code class="n">command</code> <code class="o">+</code> <code class="s">" invalid."</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
            <code class="n">RequestDispatcher</code> <code class="n">rd</code> <code class="o">=</code> <code class="n">application</code><code class="o">.</code><code class="na">getRequestDispatcher</code><code class="o">(</code>&#13;
                <code class="s">"/hosts/index.jsp"</code><code class="o">);</code>&#13;
            <code class="n">rd</code><code class="o">.</code><code class="na">forward</code><code class="o">(</code><code class="n">request</code><code class="o">,</code> <code class="n">response</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Nice try, but... &lt;/title&gt;&lt;head&gt;"</code><code class="o">);</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;body bgcolor=\"white\"&gt;"</code><code class="o">);</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
                <code class="s">"I'm sorry, Dave, but you know I can't allow you to do that."</code><code class="o">);</code>&#13;
            <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Even if you are "</code> <code class="o">+</code> <code class="n">request</code><code class="o">.</code><code class="na">getUserPrincipal</code><code class="o">());</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"&lt;/body&gt;&lt;/html&gt;"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Two HTML pages lead to the servlet. The contestant’s page simply has a large link (<code>&lt;a href=/servlet/BuzzInServlet&gt;</code>). Anchor links generate an HTML GET, so the servlet engine calls <code>doGet()</code>:</p>&#13;
&#13;
<pre data-type="programlisting">&lt;html&gt;&lt;head&gt;&lt;title&gt;Buzz In!&lt;/title&gt;&lt;/head&gt;&#13;
&lt;body&gt;&#13;
&lt;h1&gt;Buzz In!&lt;/h1&gt;&#13;
&lt;p&gt;&#13;
&lt;font size=+6&gt;&#13;
&lt;a href="servlet/BuzzInServlet"&gt;&#13;
Press here to buzz in!&#13;
&lt;/a&gt;&#13;
&lt;/font&gt;</pre>&#13;
&#13;
<p>The HTML is pretty plain, but it does the job. <a data-type="xref" href="#javacook-threads-FIG-3">Figure 16-3</a> shows the look and feel.</p>&#13;
&#13;
<figure><div class="figure" id="javacook-threads-FIG-3">&#13;
<img alt="jcb4 1603" src="assets/jcb4_1603.png"/>&#13;
<h6><span class="label">Figure 16-3. </span>BuzzInServlet in action</h6>&#13;
</div></figure>&#13;
&#13;
<p>The game show host has access to an HTML form with a POST method, which calls the<a data-primary="doPost() method" data-type="indexterm" id="idm45290630303384"/> <code>doPost()</code>  method. This displays the winner to the game show host and resets the buzzer for the&#13;
next question.</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="nt">&lt;html&gt;&lt;head&gt;&lt;title&gt;</code>Reset Buzzer<code class="nt">&lt;/title&gt;&lt;/head&gt;</code>&#13;
<code class="nt">&lt;body&gt;</code>&#13;
<code class="nt">&lt;h1&gt;</code>Display Winner<code class="nt">&lt;/h1&gt;</code>&#13;
<code class="nt">&lt;p&gt;</code>&#13;
<code class="nt">&lt;b&gt;</code>The winner is:<code class="nt">&lt;/b&gt;</code>&#13;
<code class="nt">&lt;form</code> <code class="na">method=</code><code class="s">"post"</code> <code class="na">action=</code><code class="s">"servlet/BuzzInServlet"</code><code class="nt">&gt;</code>&#13;
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"command"</code> <code class="na">value=</code><code class="s">"show"</code><code class="nt">&gt;</code>&#13;
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"password"</code> <code class="na">value=</code><code class="s">"syzzy"</code><code class="nt">&gt;</code>&#13;
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">name=</code><code class="s">"Show"</code> <code class="na">value=</code><code class="s">"Show"</code><code class="nt">&gt;</code>&#13;
<code class="nt">&lt;/form&gt;</code>&#13;
<code class="nt">&lt;h1&gt;</code>Reset Buzzer<code class="nt">&lt;/h1&gt;</code>&#13;
<code class="nt">&lt;p&gt;</code>&#13;
<code class="nt">&lt;b&gt;</code>Remember to RESET before you ask the contestants each question!<code class="nt">&lt;/b&gt;</code>&#13;
<code class="nt">&lt;form</code> <code class="na">method=</code><code class="s">"post"</code> <code class="na">action=</code><code class="s">"servlet/BuzzInServlet"</code><code class="nt">&gt;</code>&#13;
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"command"</code> <code class="na">value=</code><code class="s">"reset"</code><code class="nt">&gt;</code>&#13;
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"password"</code> <code class="na">value=</code><code class="s">"syzzy"</code><code class="nt">&gt;</code>&#13;
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">name=</code><code class="s">"Reset"</code> <code class="na">value=</code><code class="s">"RESET!"</code><code class="nt">&gt;</code>&#13;
<code class="nt">&lt;/form&gt;</code></pre>&#13;
&#13;
<p>A password is provided; it’s hardcoded here, but in reality the password&#13;
would come from a properties file (<a data-type="xref" href="ch07.html#javacook-structure-SECT-7">Recipe 7.10</a>) or a servlet&#13;
initialization parameter <a data-primary="Java Servlet Programming" data-type="indexterm" id="idm45290630298552"/>(as described in <em><a class="orm:hideurl" href="http://shop.oreilly.com/product/9780596000400.do">Java Servlet Programming</a></em> [O’Reilly]):</p>&#13;
&#13;
<p>The game show host functionality is shown in <a data-type="xref" href="#javacook-threads-FIG-4">Figure 16-4</a>.</p>&#13;
&#13;
<figure><div class="figure" id="javacook-threads-FIG-4">&#13;
<img alt="jcb4 1604" src="assets/jcb4_1604.png"/>&#13;
<h6><span class="label">Figure 16-4. </span>BuzzInServlet game show host function</h6>&#13;
</div></figure>&#13;
&#13;
<p>For a more complete game, of course, the servlet would keep a <code>Stack</code> (see <a data-type="xref" href="ch07.html#javacook-structure-SECT-14">Recipe 7.16</a>) of people in the order they buzzed in, in case the first person doesn’t answer the question correctly. Access to this would have to be synchronized, too.<a data-primary="" data-startref="syn_ab" data-type="indexterm" id="idm45290630207176"/><a data-primary="" data-startref="thr_syn" data-type="indexterm" id="idm45290630206232"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.6 Simplifying Synchronization with Locks" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-6">&#13;
<h1>16.6 Simplifying Synchronization with Locks</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-6.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="locks" data-type="indexterm" id="loc_ab"/><a data-primary="synchronization" data-type="indexterm" id="syn_loc"/><a data-primary="threading" data-secondary="locks" data-type="indexterm" id="thr_loc"/>You want an easier means of synchronizing threads.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-6.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>Lock</code> mechanism in <code>java.util.concurrent.locks</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-6.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Use the <code>java.util.concurrent.locks</code> package; its major interface is <code>Lock</code>. This interface has several methods for locking and one for unlocking. Here is the general pattern for using it:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Lock</code> <code class="n">thelock</code> <code class="o">=</code> <code class="o">....</code>&#13;
<code class="k">try</code>  <code class="o">{</code>&#13;
        <code class="n">lock</code><code class="o">.</code><code class="na">lock</code><code class="o">(</code> <code class="o">);</code>&#13;
        <code class="c1">// do the work that is protected by the lock</code>&#13;
<code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
        <code class="n">lock</code><code class="o">.</code><code class="na">unlock</code><code class="o">(</code> <code class="o">);</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>The point of putting the <a data-primary="unlock() method" data-type="indexterm" id="idm45290630177496"/><code>unlock()</code> call in the <code>finally</code> block&#13;
is, of course, to ensure that it is not bypassed if an exception&#13;
occurs (the code may also include one or more <code>catch</code> blocks, as&#13;
required by the work being performed).</p>&#13;
&#13;
<p>The improvement here, compared with the traditional synchronized methods and blocks, is that using a <code>Lock</code> actually looks like a locking operation! And, as I mentioned, several means of locking are available, shown in <a data-type="xref" href="#javacook-threads-TABLE-1">Table 16-1</a>.</p>&#13;
<table id="javacook-threads-TABLE-1">&#13;
<caption><span class="label">Table 16-1. </span>Locking methods of the Lock class</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Return type</th>&#13;
<th>Method</th>&#13;
<th>Meaning</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>void</p></td>&#13;
<td><p><code>lock( )</code></p></td>&#13;
<td><p>Get the lock, even if you have to wait until another thread frees it first</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>boolean</p></td>&#13;
<td><p><code>tryLock( )</code></p></td>&#13;
<td><p>Get the lock only if it is free right now</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>boolean</p></td>&#13;
<td><p><code>tryLock(long time, TimeUnit units) throws</code> <code class="keep-together">InterruptedException</code></p></td>&#13;
<td><p>Try to get the lock, but only wait for the length of time indicated</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>void</p></td>&#13;
<td><p><code>lockInterruptibly( ) throws</code> <code class="keep-together">InterruptedException</code></p></td>&#13;
<td><p>Get the lock, waiting unless interrupted</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>void</p></td>&#13;
<td><p><code>unlock( )</code></p></td>&#13;
<td><p>Release the lock</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>The <code>TimeUnit</code> class lets you specify the units for the amount of time specified, including <code>TimeUnit.SECONDS</code>, <code>TimeUnit.MILLISECONDS</code>, <code>TimeUnit.MICROSECONDS</code>, and <code>TimeUnit.NANOSECONDS</code>.</p>&#13;
&#13;
<p>In all cases, the lock must be released with <code>unlock()</code> before it can be locked again.</p>&#13;
&#13;
<p>The standard <code>Lock</code> is useful in many applications, but depending&#13;
on the application’s requirements, other types of locks may be more&#13;
appropriate. Applications with asymmetric load patterns may benefit&#13;
from a common pattern called the <em>reader-writer lock</em>; I call this&#13;
one a readers-writer lock to emphasize that there can be many readers&#13;
but only one writer. It’s actually a pair of interconnected locks;&#13;
any number of readers can hold the read lock and read the data, as&#13;
long as it’s not being written (shared read access). A thread trying&#13;
to lock the write lock, however, waits until all the readers are&#13;
finished and then locks them out until the writer is finished (exclusive&#13;
write access). To support this pattern, both the&#13;
<code>ReadWriteLock</code> interface and the implementing class&#13;
<code>ReentrantReadWriteLock</code> are available. The interface has only two methods,&#13;
<a data-primary="readLock() method" data-type="indexterm" id="idm45290630080424"/><a data-primary="writeLock() method" data-type="indexterm" id="idm45290630079720"/><code>readLock()</code> and <code>writeLock()</code>, which provide a reference to the&#13;
appropriate <code>Lock</code> implementation. <em>These methods do not, in&#13;
themselves, lock or unlock the locks</em>; they only provide access to&#13;
them, so it is common to see code like this:</p>&#13;
&#13;
<pre data-type="programlisting">rwlock.readLock( ).lock( );&#13;
...&#13;
rwlock.readLock( ).unlock( );</pre>&#13;
&#13;
<p>To demonstrate <code>ReadWriteLock</code> in action, I wrote the business logic portion of a&#13;
web-based voting application. It could be used in voting for candidates or for the more&#13;
common web poll. Presuming that you display the results on the home page and change the&#13;
data only when somebody takes the time to click a response to vote, this application&#13;
fits one of the intended criteria for <code>ReadWriteLock</code>—that is, that you have more readers&#13;
than writers. The main class, <code>ReadersWritersDemo</code>, is shown in&#13;
<a data-type="xref" href="#javacook-threads-EX-10">Example 16-10</a>. The helper class <code>BallotBox</code> is online; it simply keeps track&#13;
of the votes and returns a read-only <code>Iterator</code> upon request. Note that in the<a data-primary="run() method" data-type="indexterm" id="idm45290630073048"/> <code>run()</code>&#13;
method of the reading threads, you could obtain the iterator while holding the lock but release&#13;
the lock before printing it; this allows greater concurrency and better performance, but it could&#13;
(depending on your application) require additional locking against concurrent update.</p>&#13;
<div data-type="example" id="javacook-threads-EX-10">&#13;
<h5><span class="label">Example 16-10. </span>main/src/main/java/threads/ReadersWriterDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ReadersWriterDemo</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">NUM_READER_THREADS</code> <code class="o">=</code> <code class="mi">3</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">ReadersWriterDemo</code><code class="o">().</code><code class="na">demo</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Set this to true to end the program */</code>&#13;
    <code class="kd">private</code> <code class="kd">volatile</code> <code class="kt">boolean</code> <code class="n">done</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** The data being protected. */</code>&#13;
    <code class="kd">private</code> <code class="n">BallotBox</code> <code class="n">theData</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** The read lock / write lock combination */</code>&#13;
    <code class="kd">private</code> <code class="n">ReadWriteLock</code> <code class="n">lock</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ReentrantReadWriteLock</code><code class="o">();</code>&#13;
&#13;
    <code class="cm">/**</code>&#13;
<code class="cm">     * Constructor: set up some quasi-random initial data</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="nf">ReadersWriterDemo</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">questionsList</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;();</code>&#13;
        <code class="n">questionsList</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="s">"Agree"</code><code class="o">);</code>&#13;
        <code class="n">questionsList</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="s">"Disagree"</code><code class="o">);</code>&#13;
        <code class="n">questionsList</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="s">"No opinion"</code><code class="o">);</code>&#13;
        <code class="n">theData</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BallotBox</code><code class="o">(</code><code class="n">questionsList</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/**</code>&#13;
<code class="cm">     * Run a demo with more readers than writers</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">demo</code><code class="o">()</code> <code class="o">{</code>&#13;
&#13;
        <code class="c1">// Start two reader threads</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">NUM_READER_THREADS</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="k">new</code> <code class="nf">Thread</code><code class="o">()</code> <code class="o">{</code>&#13;
                <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
                    <code class="k">while</code> <code class="o">(!</code><code class="n">done</code><code class="o">)</code> <code class="o">{</code>&#13;
                        <code class="n">lock</code><code class="o">.</code><code class="na">readLock</code><code class="o">().</code><code class="na">lock</code><code class="o">();</code>&#13;
                        <code class="k">try</code> <code class="o">{</code>&#13;
                            <code class="n">theData</code><code class="o">.</code><code class="na">forEach</code><code class="o">(</code><code class="n">p</code> <code class="o">-&gt;</code>&#13;
                                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">printf</code><code class="o">(</code><code class="s">"%s: votes %d%n"</code><code class="o">,</code>&#13;
                                    <code class="n">p</code><code class="o">.</code><code class="na">getName</code><code class="o">(),</code>&#13;
                                    <code class="n">p</code><code class="o">.</code><code class="na">getVotes</code><code class="o">()));</code>&#13;
                        <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
                            <code class="c1">// Unlock in "finally" to be sure it gets done.</code>&#13;
                            <code class="n">lock</code><code class="o">.</code><code class="na">readLock</code><code class="o">().</code><code class="na">unlock</code><code class="o">();</code>&#13;
                        <code class="o">}</code>&#13;
&#13;
                        <code class="k">try</code> <code class="o">{</code>&#13;
                            <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(((</code><code class="kt">long</code><code class="o">)(</code><code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()*</code> <code class="mi">1000</code><code class="o">)));</code>&#13;
                        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                            <code class="c1">// nothing to do</code>&#13;
                        <code class="o">}</code>&#13;
                    <code class="o">}</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}.</code><code class="na">start</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="c1">// Start one writer thread to simulate occasional voting</code>&#13;
        <code class="k">new</code> <code class="nf">Thread</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
                <code class="k">while</code> <code class="o">(!</code><code class="n">done</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">lock</code><code class="o">.</code><code class="na">writeLock</code><code class="o">().</code><code class="na">lock</code><code class="o">();</code>&#13;
                    <code class="k">try</code> <code class="o">{</code>&#13;
                        <code class="n">theData</code><code class="o">.</code><code class="na">voteFor</code><code class="o">(</code>&#13;
                            <code class="c1">// Vote for random candidate :-)</code>&#13;
                            <code class="c1">// Performance: should have one PRNG per thread.</code>&#13;
                            <code class="o">(((</code><code class="kt">int</code><code class="o">)(</code><code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()*</code>&#13;
                            <code class="n">theData</code><code class="o">.</code><code class="na">getCandidateCount</code><code class="o">()))));</code>&#13;
                    <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
                        <code class="n">lock</code><code class="o">.</code><code class="na">writeLock</code><code class="o">().</code><code class="na">unlock</code><code class="o">();</code>&#13;
                    <code class="o">}</code>&#13;
                    <code class="k">try</code> <code class="o">{</code>&#13;
                        <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(((</code><code class="kt">long</code><code class="o">)(</code><code class="n">Math</code><code class="o">.</code><code class="na">random</code><code class="o">()*</code><code class="mi">1000</code><code class="o">)));</code>&#13;
                    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                        <code class="c1">// nothing to do</code>&#13;
                    <code class="o">}</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}.</code><code class="na">start</code><code class="o">();</code>&#13;
&#13;
        <code class="c1">// In the main thread, wait a while then terminate the run.</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
            <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">10</code> <code class="o">*</code> <code class="mi">1000</code><code class="o">);</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// nothing to do</code>&#13;
        <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
            <code class="n">done</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Because this is a simulation and the voting is random, it does not always come out 50/50. In two consecutive runs, the following were the last line of each run:</p>&#13;
&#13;
<pre data-type="programlisting">Agree(6), Disagree(6)&#13;
Agree(9), Disagree(4)</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-6.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>The <code>Lock</code>  interface also makes available <code>Condition</code> objects, which provide even more flexibility. Consult the online documentation for more information.<a data-primary="" data-startref="loc_ab" data-type="indexterm" id="idm45290630057416"/><a data-primary="" data-startref="syn_loc" data-type="indexterm" id="idm45290630056440"/><a data-primary="" data-startref="thr_loc" data-type="indexterm" id="idm45290629718744"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.7 Simplifying Producer/Consumer with the Queue Interface" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-8">&#13;
<h1>16.7 Simplifying Producer/Consumer with the Queue Interface</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-8.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="producer-consumer implementation" data-type="indexterm" id="pci_ab"/><a data-primary="queue interface" data-type="indexterm" id="qi_ab"/><a data-primary="threading" data-secondary="queue interface" data-type="indexterm" id="thr_qi"/>You need to control producer/consumer implementations involving multiple threads.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-8.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>Queue</code> interface or the <code>BlockingQueue</code> subinterface.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-8.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>As an example of the simplifications possible with the <code>java.util.Concurrent</code>&#13;
package, consider the standard producer/consumer program.&#13;
An implementation synchronized using traditional <code>Thread</code> code (<code>wait()</code> and <code>notifyAll()</code>) is in the online&#13;
source as <code>ProdCons2</code>.&#13;
<a data-type="xref" href="#javacook-threads-EX-13">Example 16-11</a>,&#13;
<em>ProdCons15.java</em>, uses the <code>java​.util.BlockingQueue</code>&#13;
(a subinterface of <code>java.util.Queue</code>) to reimplement <code>ProdCons2</code>&#13;
in about two-thirds the number of lines of code, and it’s simpler.&#13;
The application simply puts items into a queue and takes them from it. In the example,&#13;
I have four producers and only three consumers, so the producers eventually wait.&#13;
Running the application on one of my older notebooks, the producers’ lead over the&#13;
consumers increases to about 350 over the 10 seconds or so of running it.</p>&#13;
<div data-type="example" id="javacook-threads-EX-13">&#13;
<h5><span class="label">Example 16-11. </span>main/src/main/java/threads/ProdCons15.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ProdCons15</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kd">volatile</code> <code class="kt">boolean</code> <code class="n">done</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code>&#13;
&#13;
    <code class="cm">/** Inner class representing the Producer side */</code>&#13;
    <code class="kd">class</code> <code class="nc">Producer</code> <code class="kd">implements</code> <code class="n">Runnable</code> <code class="o">{</code>&#13;
&#13;
        <code class="kd">protected</code> <code class="n">BlockingQueue</code><code class="o">&lt;</code><code class="n">Object</code><code class="o">&gt;</code> <code class="n">queue</code><code class="o">;</code>&#13;
&#13;
        <code class="n">Producer</code><code class="o">(</code><code class="n">BlockingQueue</code><code class="o">&lt;</code><code class="n">Object</code><code class="o">&gt;</code> <code class="n">theQueue</code><code class="o">)</code> <code class="o">{</code> <code class="k">this</code><code class="o">.</code><code class="na">queue</code> <code class="o">=</code> <code class="n">theQueue</code><code class="o">;</code> <code class="o">}</code>&#13;
&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="k">while</code> <code class="o">(!</code><code class="n">done</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">Object</code> <code class="n">justProduced</code> <code class="o">=</code> <code class="n">getRequestFromNetwork</code><code class="o">();</code>&#13;
                    <code class="n">queue</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">justProduced</code><code class="o">);</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code>&#13;
                        <code class="s">"Produced 1 object; List size now "</code> <code class="o">+</code> <code class="n">queue</code><code class="o">.</code><code class="na">size</code><code class="o">());</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Producer INTERRUPTED"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="n">Object</code> <code class="nf">getRequestFromNetwork</code><code class="o">()</code> <code class="o">{</code>    <code class="c1">// Simulation of reading from client</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                    <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">10</code><code class="o">);</code> <code class="c1">// simulate time passing during read</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                 <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Producer Read INTERRUPTED"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">return</code> <code class="k">new</code> <code class="nf">Object</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="cm">/** Inner class representing the Consumer side */</code>&#13;
    <code class="kd">class</code> <code class="nc">Consumer</code> <code class="kd">implements</code> <code class="n">Runnable</code> <code class="o">{</code>&#13;
        <code class="kd">protected</code> <code class="n">BlockingQueue</code><code class="o">&lt;</code><code class="n">Object</code><code class="o">&gt;</code> <code class="n">queue</code><code class="o">;</code>&#13;
&#13;
        <code class="n">Consumer</code><code class="o">(</code><code class="n">BlockingQueue</code><code class="o">&lt;</code><code class="n">Object</code><code class="o">&gt;</code> <code class="n">theQueue</code><code class="o">)</code> <code class="o">{</code> <code class="k">this</code><code class="o">.</code><code class="na">queue</code> <code class="o">=</code> <code class="n">theQueue</code><code class="o">;</code> <code class="o">}</code>&#13;
&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">Object</code> <code class="n">obj</code> <code class="o">=</code> <code class="n">queue</code><code class="o">.</code><code class="na">take</code><code class="o">();</code>&#13;
                    <code class="kt">int</code> <code class="n">len</code> <code class="o">=</code> <code class="n">queue</code><code class="o">.</code><code class="na">size</code><code class="o">();</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"List size now "</code> <code class="o">+</code> <code class="n">len</code><code class="o">);</code>&#13;
                    <code class="n">process</code><code class="o">(</code><code class="n">obj</code><code class="o">);</code>&#13;
                    <code class="k">if</code> <code class="o">(</code><code class="n">done</code><code class="o">)</code> <code class="o">{</code>&#13;
                        <code class="k">return</code><code class="o">;</code>&#13;
                    <code class="o">}</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">ex</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"CONSUMER INTERRUPTED"</code><code class="o">);</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code>&#13;
&#13;
        <code class="kt">void</code> <code class="nf">process</code><code class="o">(</code><code class="n">Object</code> <code class="n">obj</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="c1">// Thread.sleep(123) // Simulate time passing</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Consuming object "</code> <code class="o">+</code> <code class="n">obj</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="n">ProdCons15</code><code class="o">(</code><code class="kt">int</code> <code class="n">nP</code><code class="o">,</code> <code class="kt">int</code> <code class="n">nC</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">BlockingQueue</code><code class="o">&lt;</code><code class="n">Object</code><code class="o">&gt;</code> <code class="n">myQueue</code> <code class="o">=</code> <code class="k">new</code> <code class="n">LinkedBlockingQueue</code><code class="o">&lt;&gt;();</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">nP</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code>&#13;
            <code class="k">new</code> <code class="nf">Thread</code><code class="o">(</code><code class="k">new</code> <code class="n">Producer</code><code class="o">(</code><code class="n">myQueue</code><code class="o">)).</code><code class="na">start</code><code class="o">();</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">nC</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code>&#13;
            <code class="k">new</code> <code class="nf">Thread</code><code class="o">(</code><code class="k">new</code> <code class="n">Consumer</code><code class="o">(</code><code class="n">myQueue</code><code class="o">)).</code><code class="na">start</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code>&#13;
    <code class="kd">throws</code> <code class="n">IOException</code><code class="o">,</code> <code class="n">InterruptedException</code> <code class="o">{</code>&#13;
&#13;
        <code class="c1">// Start producers and consumers</code>&#13;
        <code class="kt">int</code> <code class="n">numProducers</code> <code class="o">=</code> <code class="mi">4</code><code class="o">;</code>&#13;
        <code class="kt">int</code> <code class="n">numConsumers</code> <code class="o">=</code> <code class="mi">3</code><code class="o">;</code>&#13;
        <code class="n">ProdCons15</code> <code class="n">pc</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ProdCons15</code><code class="o">(</code><code class="n">numProducers</code><code class="o">,</code> <code class="n">numConsumers</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// Let the simulation run for, say, 10 seconds</code>&#13;
        <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">10</code><code class="o">*</code><code class="mi">1000</code><code class="o">);</code>&#13;
&#13;
        <code class="c1">// End of simulation - shut down gracefully</code>&#13;
        <code class="n">pc</code><code class="o">.</code><code class="na">done</code> <code class="o">=</code> <code class="kc">true</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><code>ProdCons15</code> is superior to <code>ProdCons2</code> in almost&#13;
all aspects. However, the queue sizes that are output no longer necessarily exactly reflect the size&#13;
of the queue after the object is inserted or removed. Because there’s no longer any locking&#13;
ensuring atomicity here, any number of queue operations could occur on other threads&#13;
between the <code>Producer</code> thread’s <code>queue.put()</code> and the <code>Consumer</code> thread’s queue size query.<a data-primary="" data-startref="pci_ab" data-type="indexterm" id="idm45290629688360"/><a data-primary="" data-startref="qi_ab" data-type="indexterm" id="idm45290629687384"/><a data-primary="" data-startref="thr_qi" data-type="indexterm" id="idm45290629686440"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.8 Optimizing Parallel Processing with Fork/Join" data-type="sect1"><div class="sect1" id="javacook-threads-forkjoin">&#13;
<h1>16.8 Optimizing Parallel Processing with Fork/Join</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-forkjoin.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="fork/join framework" data-type="indexterm" id="fjf_ab"/><a data-primary="threading" data-secondary="fork/join framework" data-type="indexterm" id="thr_fjf"/>You want to optimize use of multiple processors and/or large problem spaces.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-forkjoin.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the Fork/Join framework.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-forkjoin.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Fork/Join is an <code>ExecutorService</code> intended mainly for reasonably&#13;
large tasks that can naturally be divided recursively, where you&#13;
don’t have to ensure equal timing for each division. It uses&#13;
work-stealing to keep threads busy.</p>&#13;
&#13;
<p>The basic means of using Fork/Join is to extend <code>RecursiveTask</code> or <code>RecursiveAction</code>&#13;
and override its <a data-primary="compute() method" data-type="indexterm" id="idm45290629173496"/><code>compute()</code> method along these lines:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="k">if</code> <code class="o">(</code><code class="n">assigned</code> <code class="n">portion</code> <code class="n">of</code> <code class="n">work</code> <code class="n">is</code> <code class="err">“</code><code class="n">small</code> <code class="n">enough</code><code class="err">”</code><code class="o">)</code> <code class="o">{</code>&#13;
	<code class="n">perform</code> <code class="n">the</code> <code class="n">work</code> <code class="n">myself</code>&#13;
<code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
	<code class="n">split</code> <code class="n">my</code> <code class="n">work</code> <code class="n">into</code> <code class="n">two</code> <code class="n">pieces</code>&#13;
	<code class="n">invoke</code> <code class="n">the</code> <code class="n">two</code> <code class="n">pieces</code> <code class="n">and</code> <code class="n">await</code> <code class="n">the</code> <code class="n">results</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>There are two classes: <code>RecursiveTask</code> and <code>RecursiveAction</code>. The main difference is that&#13;
<code>RecursiveTask</code> has each step of the work returning a value, whereas <code class="keep-together">RecursiveAction</code> does not.&#13;
In other words, the <code>RecursiveAction</code> method <code>compute()</code> has a return type of void,&#13;
whereas the <code>RecursiveAction</code> method of the same name has a return type of <code>T</code>, some type parameter.&#13;
You might use <code>RecursiveTask</code> when each call returns&#13;
a value that represents the computation for its subset of the overall task, in other words,&#13;
to divide a problem like summarizing data—each task would&#13;
summarize one part and return that.&#13;
You might use <code>RecursiveAction</code> to operate over a large&#13;
data structure performing some transform of the data in place.</p>&#13;
&#13;
<p>There are two demos of the Fork/Join framework here, named after the <code>ForkJoinTask</code> that each subclasses:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>RecursiveTaskDemo</code> uses<a data-primary="fork() method" data-type="indexterm" id="idm45290629123512"/><a data-primary="join() method" data-type="indexterm" id="idm45290629122776"/> <code>fork()</code> and <code>join()</code> directly.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>RecursiveActionDemo</code> uses <code>invokeAll()</code> to invoke the two subtasks.&#13;
<code>invoke()</code> is just a <code>fork()</code> and a <code>join()</code>; and <code>invokeAll()</code>&#13;
just does this repeatedly until done. Compare the versions of&#13;
<code>compute()</code> in Examples <a data-type="xref" data-xrefstyle="select: labelnumber" href="#javacook-threads-forkjoin-recursiveActionDemo">16-12</a> and <a data-type="xref" data-xrefstyle="select: labelnumber" href="#javacook-threads-forkjoin-recursiveTaskDemo">16-13</a> and this will make sense.</p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="example" id="javacook-threads-forkjoin-recursiveActionDemo">&#13;
<h5><span class="label">Example 16-12. </span>main/src/main/java/threads/RecursiveActionDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/** A trivial demonstration of the "Fork-Join" framework:</code>&#13;
<code class="cm"> * square a bunch of numbers using RecursiveAction.</code>&#13;
<code class="cm"> * We use RecursiveAction here b/c we don't need each</code>&#13;
<code class="cm"> * compute() call to return its result; the work is</code>&#13;
<code class="cm"> * accumulated in the "dest" array.</code>&#13;
<code class="cm"> * @see RecursiveTaskDemo when each computation has to return a value.</code>&#13;
<code class="cm"> * @author Ian Darwin</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">RecursiveActionDemo</code> <code class="kd">extends</code> <code class="n">RecursiveAction</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">serialVersionUID</code> <code class="o">=</code> <code class="mi">3742774374013520116L</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">static</code> <code class="kt">int</code><code class="o">[]</code> <code class="n">raw</code> <code class="o">=</code> <code class="o">{</code>&#13;
        <code class="mi">19</code><code class="o">,</code> <code class="mi">3</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="o">-</code><code class="mi">1</code><code class="o">,</code> <code class="mi">57</code><code class="o">,</code> <code class="mi">24</code><code class="o">,</code> <code class="mi">65</code><code class="o">,</code> <code class="n">Integer</code><code class="o">.</code><code class="na">MAX_VALUE</code><code class="o">,</code> <code class="mi">42</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="mi">3</code><code class="o">,</code> <code class="mi">5</code>&#13;
    <code class="o">};</code>&#13;
    <code class="kd">static</code> <code class="kt">int</code><code class="o">[]</code> <code class="n">sorted</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
&#13;
    <code class="kt">int</code><code class="o">[]</code> <code class="n">source</code><code class="o">;</code>&#13;
    <code class="kt">int</code><code class="o">[]</code> <code class="n">dest</code><code class="o">;</code>&#13;
    <code class="kt">int</code> <code class="n">length</code><code class="o">;</code>&#13;
    <code class="kt">int</code> <code class="n">start</code><code class="o">;</code>&#13;
    <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">THRESHOLD</code> <code class="o">=</code> <code class="mi">4</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">sorted</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">raw</code><code class="o">.</code><code class="na">length</code><code class="o">];</code>&#13;
        <code class="n">RecursiveActionDemo</code> <code class="n">fb</code> <code class="o">=</code>&#13;
            <code class="k">new</code> <code class="nf">RecursiveActionDemo</code><code class="o">(</code><code class="n">raw</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">raw</code><code class="o">.</code><code class="na">length</code><code class="o">,</code> <code class="n">sorted</code><code class="o">);</code>&#13;
        <code class="n">ForkJoinPool</code> <code class="n">pool</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ForkJoinPool</code><code class="o">();</code>&#13;
        <code class="n">pool</code><code class="o">.</code><code class="na">invoke</code><code class="o">(</code><code class="n">fb</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="sc">'['</code><code class="o">);</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">:</code> <code class="n">sorted</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">print</code><code class="o">(</code><code class="n">i</code> <code class="o">+</code> <code class="s">","</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="sc">']'</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">RecursiveActionDemo</code><code class="o">(</code><code class="kt">int</code><code class="o">[]</code> <code class="n">src</code><code class="o">,</code> <code class="kt">int</code> <code class="n">start</code><code class="o">,</code> <code class="kt">int</code> <code class="n">length</code><code class="o">,</code> <code class="kt">int</code><code class="o">[]</code> <code class="n">dest</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">source</code> <code class="o">=</code> <code class="n">src</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">start</code> <code class="o">=</code> <code class="n">start</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">length</code> <code class="o">=</code> <code class="n">length</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">dest</code> <code class="o">=</code> <code class="n">dest</code><code class="o">;</code>&#13;
      <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">compute</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"RecursiveActionDemo.compute()"</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">length</code> <code class="o">&lt;=</code> <code class="n">THRESHOLD</code><code class="o">)</code> <code class="o">{</code> <code class="c1">// Compute Directly</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="n">start</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">start</code> <code class="o">+</code> <code class="n">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
                <code class="n">dest</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">source</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">*</code> <code class="n">source</code><code class="o">[</code><code class="n">i</code><code class="o">];</code>&#13;
            <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>                    <code class="c1">// Divide and Conquer</code>&#13;
            <code class="kt">int</code> <code class="n">split</code> <code class="o">=</code> <code class="n">length</code> <code class="o">/</code> <code class="mi">2</code><code class="o">;</code>&#13;
            <code class="n">invokeAll</code><code class="o">(</code>&#13;
              <code class="k">new</code> <code class="nf">RecursiveActionDemo</code><code class="o">(</code><code class="n">source</code><code class="o">,</code> <code class="n">start</code><code class="o">,</code>         <code class="n">split</code><code class="o">,</code>          <code class="n">dest</code><code class="o">),</code>&#13;
              <code class="k">new</code> <code class="nf">RecursiveActionDemo</code><code class="o">(</code><code class="n">source</code><code class="o">,</code> <code class="n">start</code> <code class="o">+</code> <code class="n">split</code><code class="o">,</code> <code class="n">length</code> <code class="o">-</code> <code class="n">split</code><code class="o">,</code> <code class="n">dest</code><code class="o">));</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
<div data-type="example" id="javacook-threads-forkjoin-recursiveTaskDemo">&#13;
<h5><span class="label">Example 16-13. </span>main/src/main/java/threads/RecursiveTaskDemo.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Demonstrate the Fork-Join Framework to average a large array.</code>&#13;
<code class="cm"> * Running this on a multi-core machine as e.g.,</code>&#13;
<code class="cm"> * $ time java threads.RecursiveTaskDemo</code>&#13;
<code class="cm"> * shows that the CPU time is always greater than the elapsed time,</code>&#13;
<code class="cm"> * indicating that we are making use of multiple cores.</code>&#13;
<code class="cm"> * That said, it is a somewhat contrived demo.</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * Use RecursiveTask&lt;T&gt; where, as in this example, each call returns</code>&#13;
<code class="cm"> * a value that represents the computation for its subset of the overall task.</code>&#13;
<code class="cm"> * @see RecursiveActionDemo when each computation does not return a value,</code>&#13;
<code class="cm"> * e.g., when each is just working on some section of a large array.</code>&#13;
<code class="cm"> * @author Ian Darwin</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">RecursiveTaskDemo</code> <code class="kd">extends</code> <code class="n">RecursiveTask</code><code class="o">&lt;</code><code class="n">Long</code><code class="o">&gt;</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">long</code> <code class="n">serialVersionUID</code> <code class="o">=</code> <code class="mi">3742774374013520116L</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">N</code> <code class="o">=</code> <code class="mi">10000000</code><code class="o">;</code>&#13;
    <code class="kd">final</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">THRESHOLD</code> <code class="o">=</code> <code class="mi">500</code><code class="o">;</code>&#13;
&#13;
    <code class="kt">int</code><code class="o">[]</code> <code class="n">data</code><code class="o">;</code>&#13;
    <code class="kt">int</code> <code class="n">start</code><code class="o">,</code> <code class="n">length</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="kt">int</code><code class="o">[]</code> <code class="n">source</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">N</code><code class="o">];</code>&#13;
        <code class="n">loadData</code><code class="o">(</code><code class="n">source</code><code class="o">);</code>&#13;
        <code class="n">RecursiveTaskDemo</code> <code class="n">fb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">RecursiveTaskDemo</code><code class="o">(</code><code class="n">source</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">source</code><code class="o">.</code><code class="na">length</code><code class="o">);</code>&#13;
        <code class="n">ForkJoinPool</code> <code class="n">pool</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ForkJoinPool</code><code class="o">();</code>&#13;
        <code class="kt">long</code> <code class="n">before</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">currentTimeMillis</code><code class="o">();</code>&#13;
        <code class="n">pool</code><code class="o">.</code><code class="na">invoke</code><code class="o">(</code><code class="n">fb</code><code class="o">);</code>&#13;
        <code class="kt">long</code> <code class="n">after</code> <code class="o">=</code> <code class="n">System</code><code class="o">.</code><code class="na">currentTimeMillis</code><code class="o">();</code>&#13;
        <code class="kt">long</code> <code class="n">total</code> <code class="o">=</code> <code class="n">fb</code><code class="o">.</code><code class="na">getRawResult</code><code class="o">();</code>&#13;
        <code class="kt">long</code> <code class="n">avg</code> <code class="o">=</code> <code class="n">total</code> <code class="o">/</code> <code class="n">N</code><code class="o">;</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Average: "</code> <code class="o">+</code> <code class="n">avg</code><code class="o">);</code>&#13;
        <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Time :"</code> <code class="o">+</code> <code class="o">(</code><code class="n">after</code> <code class="o">-</code> <code class="n">before</code><code class="o">)</code> <code class="o">+</code> <code class="s">" mSec"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">static</code> <code class="kt">void</code> <code class="nf">loadData</code><code class="o">(</code><code class="kt">int</code><code class="o">[]</code> <code class="n">data</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Random</code> <code class="n">r</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Random</code><code class="o">();</code>&#13;
        <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">data</code><code class="o">.</code><code class="na">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
            <code class="n">data</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">r</code><code class="o">.</code><code class="na">nextInt</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">RecursiveTaskDemo</code><code class="o">(</code><code class="kt">int</code><code class="o">[]</code> <code class="n">data</code><code class="o">,</code> <code class="kt">int</code> <code class="n">start</code><code class="o">,</code> <code class="kt">int</code> <code class="n">length</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">data</code> <code class="o">=</code> <code class="n">data</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">start</code> <code class="o">=</code> <code class="n">start</code><code class="o">;</code>&#13;
        <code class="k">this</code><code class="o">.</code><code class="na">length</code> <code class="o">=</code> <code class="n">length</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">protected</code> <code class="n">Long</code> <code class="nf">compute</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">length</code> <code class="o">&lt;=</code> <code class="n">THRESHOLD</code><code class="o">)</code> <code class="o">{</code> <code class="c1">// Compute Directly</code>&#13;
            <code class="kt">long</code> <code class="n">total</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>&#13;
            <code class="k">for</code> <code class="o">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="n">start</code><code class="o">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">start</code> <code class="o">+</code> <code class="n">length</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>&#13;
                <code class="n">total</code> <code class="o">+=</code> <code class="n">data</code><code class="o">[</code><code class="n">i</code><code class="o">];</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">return</code> <code class="n">total</code><code class="o">;</code>&#13;
        <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>                    <code class="c1">// Divide and Conquer</code>&#13;
            <code class="kt">int</code> <code class="n">split</code> <code class="o">=</code> <code class="n">length</code> <code class="o">/</code> <code class="mi">2</code><code class="o">;</code>&#13;
            <code class="n">RecursiveTaskDemo</code> <code class="n">t1</code> <code class="o">=</code>&#13;
                <code class="k">new</code> <code class="nf">RecursiveTaskDemo</code><code class="o">(</code><code class="n">data</code><code class="o">,</code> <code class="n">start</code><code class="o">,</code>         <code class="n">split</code><code class="o">);</code>&#13;
            <code class="n">t1</code><code class="o">.</code><code class="na">fork</code><code class="o">();</code>&#13;
            <code class="n">RecursiveTaskDemo</code> <code class="n">t2</code> <code class="o">=</code>&#13;
                <code class="k">new</code> <code class="nf">RecursiveTaskDemo</code><code class="o">(</code><code class="n">data</code><code class="o">,</code> <code class="n">start</code> <code class="o">+</code> <code class="n">split</code><code class="o">,</code> <code class="n">length</code> <code class="o">-</code> <code class="n">split</code><code class="o">);</code>&#13;
            <code class="k">return</code> <code class="n">t2</code><code class="o">.</code><code class="na">compute</code><code class="o">()</code> <code class="o">+</code> <code class="n">t1</code><code class="o">.</code><code class="na">join</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The biggest undefined part there is “small enough”; you may have to do some&#13;
experimentation to see what works well as a chunk size. Or, better yet, write more code&#13;
using a feedback control system, measuring the system throughput as the parameter is&#13;
<span class="keep-together">dynamically</span> tweaked up and down, and have the system automatically arrive at the optimal&#13;
value for that particular computer system and runtime.  This is left as an extended exercise&#13;
for the reader.<a data-primary="" data-startref="fjf_ab" data-type="indexterm" id="idm45290628707880"/><a data-primary="" data-startref="thr_fjf" data-type="indexterm" id="idm45290628707032"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="16.9 Scheduling Tasks: Future Times, Background Saving in an Editor" data-type="sect1"><div class="sect1" id="javacook-threads-SECT-9">&#13;
<h1>16.9 Scheduling Tasks: Future Times, Background Saving in an Editor</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-9.1">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="threading" data-secondary="scheduling tasks" data-type="indexterm" id="thr_st"/>You need to schedule something for a fixed time in the future.&#13;
You need to save the user’s work periodically in an interactive program.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-9.2">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>For one-shot future tasks, use the <code>Timer</code> service with a <code>TimerTask</code> object.&#13;
For recurring tasks, either use a background thread, or use the <code>Timer</code> service&#13;
and recompute the next time.&#13;
For more complex tasks, such as running something at high noon every second Thursday,&#13;
consider using a third-party scheduling library such as<a data-primary="Quartz" data-type="indexterm" id="idm45290628150696"/>&#13;
<a href="http://www.quartz-scheduler.org">Quartz</a> or, in JavaEE/Jakarta, the<a data-primary="EJB Timer Service" data-type="indexterm" id="idm45290628149160"/>&#13;
<a href="https://eclipse-ee4j.github.io/jakartaee-tutorial/ejb-basicexamples005.html">EJB Timer Service</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-9.3">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>There are several ways of scheduling things in the future.&#13;
For one-shot scheduling, you can use the <code>Timer</code> service from <code>java.util</code>.&#13;
For recurring tasks, you can use a <code>Runnable</code>, which sleeps in a loop.</p>&#13;
&#13;
<p>Here is an example of the <code>Timer</code> service in <code>java.util</code>.&#13;
These are the basics of using this API:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create a <code>Timer</code> service object.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use it to schedule instances of <code>TimerTask</code> with a legacy <code>Date</code> object indicating the date and time.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>The example code in <a data-type="xref" href="#javacook-CHAPTER-EX-ReminderService">Example 16-14</a> uses <code>Item</code> as a&#13;
subclass of <code>TimerTask</code> to perform a simple notification action in the future,&#13;
based on reading lines with <code>year-month-day-hour-minute Task</code>, such as the following:</p>&#13;
<pre>2020 12 25 10 30 Get some sleep.&#13;
2020 12 26 01 27 Finish this program&#13;
2020 12 25 01 29 Document this program</pre>&#13;
<div data-type="example" id="javacook-CHAPTER-EX-ReminderService">&#13;
<h5><span class="label">Example 16-14. </span>main/src/main/java/threads/ReminderService.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ReminderService</code> <code class="o">{</code>&#13;
&#13;
    <code class="cm">/** The Timer object */</code>&#13;
    <code class="n">Timer</code> <code class="n">timer</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Timer</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">Item</code> <code class="kd">extends</code> <code class="n">TimerTask</code> <code class="o">{</code>&#13;
        <code class="n">String</code> <code class="n">message</code><code class="o">;</code>&#13;
        <code class="n">Item</code><code class="o">(</code><code class="n">String</code> <code class="n">m</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">message</code> <code class="o">=</code> <code class="n">m</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
        <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
            <code class="n">message</code><code class="o">(</code><code class="n">message</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="o">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">argv</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">ReminderService</code><code class="o">().</code><code class="na">loadReminders</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="n">String</code> <code class="n">dfPattern</code> <code class="o">=</code> <code class="s">"yyyy MM dd hh mm ss"</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="n">SimpleDateFormat</code> <code class="n">formatter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">SimpleDateFormat</code><code class="o">(</code><code class="n">dfPattern</code><code class="o">);</code>&#13;
&#13;
    <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">loadReminders</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
&#13;
        <code class="n">Files</code><code class="o">.</code><code class="na">lines</code><code class="o">(</code><code class="n">Path</code><code class="o">.</code><code class="na">of</code><code class="o">(</code><code class="s">"ReminderService.txt"</code><code class="o">)).</code><code class="na">forEach</code><code class="o">(</code><code class="n">aLine</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
&#13;
            <code class="n">ParsePosition</code> <code class="n">pp</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ParsePosition</code><code class="o">(</code><code class="mi">0</code><code class="o">);</code>&#13;
            <code class="n">Date</code> <code class="n">date</code> <code class="o">=</code> <code class="n">formatter</code><code class="o">.</code><code class="na">parse</code><code class="o">(</code><code class="n">aLine</code><code class="o">,</code> <code class="n">pp</code><code class="o">);</code>&#13;
            <code class="n">String</code> <code class="n">task</code> <code class="o">=</code> <code class="n">aLine</code><code class="o">.</code><code class="na">substring</code><code class="o">(</code><code class="n">pp</code><code class="o">.</code><code class="na">getIndex</code><code class="o">());</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">date</code> <code class="o">==</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Invalid date in "</code> <code class="o">+</code> <code class="n">aLine</code><code class="o">);</code>&#13;
                <code class="k">return</code><code class="o">;</code>&#13;
            <code class="o">}</code>&#13;
            <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Date = "</code> <code class="o">+</code> <code class="n">date</code> <code class="o">+</code> <code class="s">"; task = "</code> <code class="o">+</code> <code class="n">task</code><code class="o">);</code>&#13;
            <code class="n">timer</code><code class="o">.</code><code class="na">schedule</code><code class="o">(</code><code class="k">new</code> <code class="n">Item</code><code class="o">(</code><code class="n">task</code><code class="o">),</code> <code class="n">date</code><code class="o">);</code>&#13;
        <code class="o">});</code>&#13;
    <code class="o">}</code></pre></div>&#13;
&#13;
<p>In real life the program would need to run for long periods of time and use some more&#13;
sophisticated messaging pattern; here we only show the timing scheduling portion.</p>&#13;
&#13;
<p>The code fragment in <a data-type="xref" href="#javacook-CHAPTER-EX-AutoSave">Example 16-15</a>&#13;
creates a background thread to handle background saves, as in most word processors.</p>&#13;
<div data-type="example" id="javacook-CHAPTER-EX-AutoSave">&#13;
<h5><span class="label">Example 16-15. </span>main/src/main/java/threads/ReminderService.java</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">AutoSave</code> <code class="kd">extends</code> <code class="n">Thread</code> <code class="o">{</code>&#13;
    <code class="cm">/** The FileSave interface is implemented by the main class. */</code>&#13;
    <code class="kd">protected</code> <code class="n">FileSaver</code> <code class="n">model</code><code class="o">;</code>&#13;
    <code class="cm">/** How long to sleep between tries */</code>&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">MINUTES</code> <code class="o">=</code> <code class="mi">5</code><code class="o">;</code>&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">SECONDS</code> <code class="o">=</code> <code class="n">MINUTES</code> <code class="o">*</code> <code class="mi">60</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">AutoSave</code><code class="o">(</code><code class="n">FileSaver</code> <code class="n">m</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="kd">super</code><code class="o">(</code><code class="s">"AutoSave Thread"</code><code class="o">);</code>&#13;
        <code class="n">setDaemon</code><code class="o">(</code><code class="kc">true</code><code class="o">);</code>        <code class="c1">// so we don't keep the main app alive</code>&#13;
        <code class="n">model</code> <code class="o">=</code> <code class="n">m</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">run</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">while</code> <code class="o">(</code><code class="kc">true</code><code class="o">)</code> <code class="o">{</code>        <code class="c1">// entire run method runs forever.</code>&#13;
            <code class="k">try</code> <code class="o">{</code>&#13;
                <code class="n">sleep</code><code class="o">(</code><code class="n">SECONDS</code><code class="o">*</code><code class="mi">1000</code><code class="o">);</code>&#13;
            <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
                <code class="c1">// do nothing with it</code>&#13;
            <code class="o">}</code>&#13;
            <code class="k">if</code> <code class="o">(</code><code class="n">model</code><code class="o">.</code><code class="na">wantAutoSave</code><code class="o">()</code> <code class="o">&amp;&amp;</code> <code class="n">model</code><code class="o">.</code><code class="na">hasUnsavedChanges</code><code class="o">())</code>&#13;
                <code class="n">model</code><code class="o">.</code><code class="na">saveFile</code><code class="o">(</code><code class="kc">null</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="c1">// Not shown:</code>&#13;
    <code class="c1">// 1) saveFile() must now be synchronized.</code>&#13;
    <code class="c1">// 2) method that shuts down main program be synchronized on *SAME* object</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="cm">/** Local copy of FileSaver interface, for compiling AutoSave demo. */</code>&#13;
<code class="kd">interface</code> <code class="nc">FileSaver</code> <code class="o">{</code>&#13;
    <code class="cm">/** Load new model from fn; if null, prompt for new fname */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">loadFile</code><code class="o">(</code><code class="n">String</code> <code class="n">fn</code><code class="o">);</code>&#13;
&#13;
    <code class="cm">/** Ask the model if it wants AutoSave done for it */</code>&#13;
    <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">wantAutoSave</code><code class="o">();</code>&#13;
&#13;
    <code class="cm">/** Ask the model if it has any unsaved changes, don't save otherwise */</code>&#13;
    <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">hasUnsavedChanges</code><code class="o">();</code>&#13;
&#13;
    <code class="cm">/** Save the current model's data in fn.</code>&#13;
<code class="cm">     * If fn == null, use current fname or prompt for a filename if null.</code>&#13;
<code class="cm">     */</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">saveFile</code><code class="o">(</code><code class="n">String</code> <code class="n">fn</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>As you can see in the <a data-primary="run() method" data-type="indexterm" id="idm45290628048280"/><code>run()</code> method, this code sleeps for five minutes (300 seconds),&#13;
then checks whether it should do anything. If the user has turned autosave off, or hasn’t&#13;
made any changes since the last save, nothing needs to be done. Otherwise, we call the&#13;
<a data-primary="saveFile() method" data-type="indexterm" id="idm45290628047032"/><code>saveFile()</code> method in the main program, which saves the data to the current file. It&#13;
would be smarter to save it to a recovery file of some name, as the better word processors&#13;
do.</p>&#13;
&#13;
<p>What’s not shown is that now all the methods must be synchronized.&#13;
It’s easy to see why if you think about how the save method would work if the user&#13;
clicked the Save button at the same time that the autosave method called it, or if the&#13;
user clicked Exit while the file save method had just opened the file for writing. The strategy of saving to a recovery file gets around some of this, but it still needs a great deal&#13;
of care.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="javacook-threads-SECT-11.4">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>For details on <code>java.util.concurrent</code>, see the documentation accompanying the JDK. For background on JSR 166, see<a data-primary="Lea, Doug" data-type="indexterm" id="idm45290627605736"/> <a href="http://gee.cs.oswego.edu">Doug Lea’s home page</a> and his <a href="http://gee.cs.oswego.edu/dl/concurrency-interest/index.html">JSR 166 page</a>.</p>&#13;
&#13;
<p>A great reference on Java threading is<a data-primary="Java Concurrency in Practice (Goetz)" data-type="indexterm" id="idm45290627603112"/><a data-primary="Goetz, Brian" data-secondary="Java Concurrency in Practice" data-type="indexterm" id="idm45290627602392"/> <em>Java Concurrency in Practice</em> by Brian Goetz et al. (Addison-Wesley).</p>&#13;
&#13;
<p><a data-primary="Project Loom: Fibers and Continuations" data-type="indexterm" id="idm45290627600568"/><a href="https://wiki.openjdk.java.net/display/loom/Main">Project Loom: Fibers and Continuations</a> aims to promote&#13;
easier-to-use, lighter-weight concurrency mechanisms.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45290633711352"><sup><a href="ch16.html#idm45290633711352-marker">1</a></sup> JSR stands for Java Specification Request. The Java Community Process calls standards, both proposed and adopted, JSRs. See <a href="http://www.jcp.org"><em class="hyperlink">http://www.jcp.org</em></a> for details.</p><p data-type="footnote" id="idm45290632776280"><sup><a href="ch16.html#idm45290632776280-marker">2</a></sup> The title belies some unfulfilled ambitions to make the animations follow the bouncing curves seen in some flashier animation demonstrations.</p><p data-type="footnote" id="idm45290630859608"><sup><a href="ch16.html#idm45290630859608-marker">3</a></sup> A <em>servlet</em> is a low-level server-side API for interacting with remote clients; today it would probably be written in the form of a JavaServer Faces (JSF) handler.</p></div></div></section></body></html>