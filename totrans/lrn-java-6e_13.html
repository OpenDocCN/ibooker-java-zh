<html><head></head><body><section data-pdf-bookmark="Chapter 13. Network Programming in Java" data-type="chapter" epub:type="chapter"><div class="chapter" id="learnjava6-CHP-13">&#13;
<h1><span class="label">Chapter 13. </span>Network Programming in Java</h1>&#13;
&#13;
&#13;
<p>When you <a data-primary="network programming" data-secondary="web services" data-type="indexterm" id="ix_net_web_ch13"/><a data-primary="web services" data-type="indexterm" id="ix_web_serv_ch13"/>think about the web, you probably think of web-based applications and services. If you are asked to go deeper, you may consider tools such as web browsers and web servers that support those applications and move data around the network. <a data-primary="java.net package" data-type="indexterm" id="id2470"/>In this chapter, we’ll look at how Java interacts with web services. We’ll also peek under the hood a bit and discuss some of the lower-level networking classes of the <em>java.net</em> package.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uniform Resource Locators" data-type="sect1"><div class="sect1" id="learnjava6-CHP-13-SECT-1">&#13;
<h1>Uniform Resource Locators</h1>&#13;
&#13;
<p>A <em>Uniform Resource Locator</em> (URL) <a data-primary="URLs (uniform resource locators)" data-type="indexterm" id="ix_url_unif_res_loc"/><a data-primary="web services" data-secondary="URLs" data-type="indexterm" id="ix_web_url"/><a data-primary="Uniform Resource Locators (URLs)" data-type="indexterm" id="ix_unif_res_loc_url"/>points to an object on the internet. It’s a text string that identifies an item, tells you where to find it, and specifies a method for communicating with it or retrieving it from its source. A URL can point to any kind of information source: static data, such as a file on a local filesystem, a web server, or an FTP site. It can point to a more dynamic object, such as an RSS news feed or a record in a database. URLs can also refer to other resources, such as email addresses.</p>&#13;
&#13;
<p>Because there are many different ways to locate an item on the internet, and different mediums and transports require different kinds of information, URLs can have many forms. The most common form has four components as shown in <a data-type="xref" href="#learnjava6-CHP-13-FIG-annotated-url">Figure 13-1</a>: a network host or server, the name of the item, its location on that host, and a protocol by which the host should communicate.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-13-FIG-annotated-url">&#13;
<img alt="ljv6 1301" src="assets/ljv6_1301.png"/>&#13;
<h6><span class="label">Figure 13-1. </span>Common elements of a URL</h6>&#13;
</div></figure>&#13;
&#13;
<p><em><code>protocol</code></em> (also called the “scheme”) is an identifier such as <code>http</code>, <code>https</code>, or <code>ftp</code>; <em><code>hostname</code></em> is usually an <a data-primary="hostname" data-type="indexterm" id="id2471"/><a data-primary="protocol" data-secondary="URL" data-type="indexterm" id="id2472"/><a data-primary="resources" data-secondary="URL" data-type="indexterm" id="id2473"/><a data-primary="path" data-secondary="URL" data-type="indexterm" id="id2474"/>internet host and domain name; and the <em><code>path</code></em> and <em><code>resource</code></em> components form a unique path that identifies the object on that host.</p>&#13;
&#13;
<p>Variants of this form pack extra information into the URL. For example, you can specify fragment identifiers (those suffixes that start with a “#” character) that reference sections inside documents. Other, more specialized types of URLs exist as well, such as “mailto” URLs for email addresses, or URLs for addressing things like database components. <a data-primary="Uniform Resource Identifiers (URIs)" data-type="indexterm" id="id2475"/><a data-primary="URIs (Uniform Resource Identifiers)" data-type="indexterm" id="id2476"/>These types of locators may not follow this format precisely, but they generally contain a protocol, host, and path. Some are more properly called <em>Uniform Resource Identifiers</em>, or URIs, which can specify more information about the name or the location of a resource. URLs are a subset of URIs.</p>&#13;
&#13;
<p>Because most URLs have the notion of a hierarchy or path, we sometimes speak of a URL that is relative to another URL, called a <em>base URL</em>. In that case, we are using the base URL as a starting point and supplying additional information to target an object relative to that URL. For example, the base URL might point to a directory on a web server, and a relative URL might name a particular file in that directory or in a <span class="keep-together">subdirectory.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The URL Class" data-type="sect1"><div class="sect1" id="learnjava6-CHP-13-SECT-2">&#13;
<h1>The URL Class</h1>&#13;
&#13;
<p>The Java <code>java.net.URL</code> class <a data-primary="URL class" data-type="indexterm" id="ix_url_class"/>represents a URL address and provides a simple API for accessing web resources, such as documents and applications on servers. It can use an extensible set of protocol and content handlers to perform the necessary communication and, in theory, even data conversion. With the <code>URL</code> class, an application can open a connection to a server and retrieve content with just a few lines of code.</p>&#13;
&#13;
<p>An instance of the <code>URL</code> class manages all the component information within a URL string and provides methods for retrieving the object it identifies. We can construct a <code>URL</code> object from a complete string or from component parts:</p>&#13;
&#13;
<pre class="less_space pagebreak-before" data-code-language="java" data-type="programlisting"><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">URL</code><code class="w"> </code><code class="n">aDoc</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="s">"http://foo.bar.com/documents/homepage.html"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">URL</code><code class="w"> </code><code class="n">sameDoc</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="s">"http"</code><code class="p">,</code><code class="s">"foo.bar.com"</code><code class="p">,</code><code class="s">"/documents/homepage.html"</code><code class="p">);</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">MalformedURLException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="c1">// Something wrong with our URL</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>These two <code>URL</code> objects point to the same network resource, the <em>homepage.html</em> document on the server <em>foo.bar.com</em>. We can’t know whether the resource actually exists and is available until we try to access it. A new <code>URL</code> object contains only data about the object’s location and how to access it. Creating a <code>URL</code> object does not make any network connections.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Oracle deprecated the <code>URL</code> constructor in Java 20. Deprecation doesn’t remove methods or classes, but it does mean you should consider other means of accomplishing your goal. The Javadoc for deprecated items often includes suggested alternatives. In this case, the <code>URI</code> class has better validation code, so Oracle recommends <code>new URI("http://your.url/").toURL()</code> as a replacement.</p>&#13;
&#13;
<p>If you are using Java 20 or later, feel free to update the code examples to use <code>URI</code> if you want to get rid of the compiler’s deprecation warnings. As this is a recent deprecation, though, you will still see the <code>URL</code> constructor used widely in online examples.</p>&#13;
</div>&#13;
&#13;
<p>We can <a data-primary="sameFile() method, URL" data-type="indexterm" id="id2477"/><a data-primary="getFile() method, URL" data-type="indexterm" id="id2478"/><a data-primary="getHost() method, URL" data-type="indexterm" id="id2479"/><a data-primary="getProtocol() method, URL" data-type="indexterm" id="id2480"/>examine the parts of the <code>URL</code> with the <code>getProtocol()</code>, <code>getHost()</code>, and <code>getFile()</code> methods. We can also compare it to another <code>URL</code> with the <code>sameFile()</code> method (an unfortunate name for something that may not point to a file), which determines whether two URLs point to the same resource. It’s not foolproof, but <code>sameFile()</code> does more than compare the URL strings for equality; it takes into account the possibility that one server may have several names, as well as other factors.</p>&#13;
&#13;
<p>When you <a data-primary="protocol handler" data-type="indexterm" id="id2481"/><a data-primary="MalformedURLException" data-type="indexterm" id="id2482"/>create a <code>URL</code>, Java parses the URL’s specification to identify the protocol component. It then tries to match what it parses from your URL with a <em>protocol handler</em>. A protocol handler is essentially a helper that can speak the given protocol and can retrieve a resource by following the protocol’s rules. If the URL’s protocol doesn’t make sense, or if Java can’t find a compatible protocol handler, the <code>URL</code> constructor throws a <code>MalformedURLException</code>.</p>&#13;
&#13;
<p>Java provides URL protocol handlers for <code>http</code>, <code>https</code> (secure HTTP), and <code>ftp</code>, as well as local <code>file</code> URLs and <code>jar</code> URLs that refer to files inside JAR archives. Java also provides the necessary low-level structure for third-party libraries to add support for other types of URLs.<a data-primary="" data-startref="ix_unif_res_loc_url" data-type="indexterm" id="id2483"/><a data-primary="" data-startref="ix_url_unif_res_loc" data-type="indexterm" id="id2484"/><a data-primary="" data-startref="ix_web_url" data-type="indexterm" id="id2485"/></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Stream Data" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-2.1">&#13;
<h2>Stream Data</h2>&#13;
&#13;
<p>The lowest-level and <a data-primary="URL class" data-secondary="stream data" data-type="indexterm" id="id2486"/><a data-primary="InputStream class" data-type="indexterm" id="id2487"/><a data-primary="openStream() method" data-type="indexterm" id="id2488"/><a data-primary="UnknownServiceException" data-type="indexterm" id="id2489"/>most general way to get data back from a <code>URL</code> is to ask for an <code>InputStream</code> from the <code>URL</code> by calling <code>openStream()</code>. Getting data as a stream may also be useful if you want to receive continuous updates from a dynamic information source. Unfortunately, you have to parse the contents of this stream yourself. Not all types of URLs support the <code>openStream()</code> method because not all types of URLs refer to concrete data; you’ll get an <code>UnknownServiceException</code> if the URL doesn’t.</p>&#13;
&#13;
<p>The following code (a simplification of the <em>ch13/examples/Read.java</em> file) prints the contents of an HTML file from an imaginary web server:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URL</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="s">"http://some.server/index.html"</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">bin</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">url</code><code class="p">.</code><code class="na">openStream</code><code class="p">()));</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">bin</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">bin</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">Exception</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">e</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>In this snippet, we ask for an <code>InputStream</code> from our <code>url</code> with <code>openStream()</code> and wrap it in a <code>BufferedReader</code> to read the lines of text. Because we specify the <code>http</code> protocol in the URL, we enlist the services of an HTTP protocol handler. We haven’t talked about content handlers yet. Because we’re reading directly from the input stream, we don’t need a content handler to transform the content.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting the Content as an Object" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-2.2">&#13;
<h2>Getting the Content as an Object</h2>&#13;
&#13;
<p>As we said <a data-primary="URL class" data-secondary="getting content as object" data-type="indexterm" id="id2490"/>previously, <code>openStream()</code> is the most general way to access web content, but it leaves the data parsing up to the programmer. The <code>URL</code> class supports a more sophisticated, pluggable, content-handling mechanism, but the Java community never really standardized the actual handlers, so its usefulness is limited.</p>&#13;
&#13;
<p>Many <a data-primary="javax.swing package" data-secondary="ImageIcon" data-type="indexterm" id="id2491"/>developers are curious about loading objects over the network because they need to load images from URLs. Java provides a few alternative approaches to accomplish this task. The simplest approach is to use the <code>javax.swing.ImageIcon</code> class which has a constructor that accepts a URL:</p>&#13;
&#13;
<pre class="less_space pagebreak-before" data-code-language="java" data-type="programlisting"><code class="c1">//file: ch13/examples/IconLabel.java</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">URL</code><code class="w"> </code><code class="n">fav</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="s">"https://www.oracle.com/.../favicon-192.png"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">ImageIcon</code><code class="w"> </code><code class="n">image1</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">ImageIcon</code><code class="p">(</code><code class="n">fav</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">JLabel</code><code class="w"> </code><code class="n">iconLabel</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">JLabel</code><code class="p">(</code><code class="n">image1</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// iconLabel can be placed in any panel, just as other labels</code><code class="w"/></pre>&#13;
&#13;
<p>If you need to turn a <a data-primary="Java Network Programming (Rusty-Harold)" data-type="indexterm" id="id2492"/><a data-primary="Rusty-Harold, Elliotte" data-type="indexterm" id="id2493"/><a data-primary="getContent() method" data-secondary="URL class" data-type="indexterm" id="id2494"/>network stream into some other type of object, you can look into the <code>getContent()</code> method of the <code>URL</code> class. You may need to write your own handler, though. For that advanced topic, we recommend <a href="https://oreil.ly/1GwXT"><em>Java Network Programming</em></a> by Elliotte Rusty-Harold (O’Reilly).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Managing Connections" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-2.3">&#13;
<h2>Managing Connections</h2>&#13;
&#13;
<p>Upon <a data-primary="URL class" data-secondary="managing connections" data-type="indexterm" id="id2495"/><a data-primary="URLConnection object" data-type="indexterm" id="id2496"/><a data-primary="HttpURLConnection class" data-type="indexterm" id="id2497"/>calling <code>openStream()</code> on a <code>URL</code>, Java consults the protocol handler, and a connection is made to the remote server or location. Connections are represented by a <code>URLConnection</code> object, subtypes of which manage different protocol-specific communications and offer additional metadata about the source. The <code>HttpURLConnection</code> class, for example, handles basic web requests and also adds some HTTP-specific capabilities, such as interpreting “404 Not Found” messages and other web server errors. We’ll talk more about <code>HttpURLConnection</code> later in this chapter.</p>&#13;
&#13;
<p>We can get a <code>URLConnection</code> from our <code>URL</code> directly with the <code>openConnection()</code> method. One of the things we can do with the <code>URLConnection</code> is ask for the object’s content type before reading data. For example:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">URLConnection</code><code class="w"> </code><code class="n">connection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">myURL</code><code class="p">.</code><code class="na">openConnection</code><code class="p">();</code><code class="w"/>&#13;
<code class="n">String</code><code class="w"> </code><code class="n">mimeType</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">connection</code><code class="p">.</code><code class="na">getContentType</code><code class="p">();</code><code class="w"/>&#13;
<code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">connection</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/></pre>&#13;
&#13;
<p>Despite its <a data-primary="getContentType() method, URLConnection" data-type="indexterm" id="id2498"/><a data-primary="connect() method, URLConnection" data-type="indexterm" id="id2499"/>name, a <code>URLConnection</code> object is initially created in a raw, unconnected state. In this example, the network connection was not actually initiated until we called the <code>getContentType()</code> method. The <code>URLConnection</code> does not talk to the source until data is requested or its <code>connect()</code> method is explicitly invoked. Prior to connection, we can set up network parameters and provide protocol-specific details. For example, we can set timeouts on the initial connection to the server and on read attempts:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">URLConnection</code><code class="w"> </code><code class="n">connection</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">myURL</code><code class="p">.</code><code class="na">openConnection</code><code class="p">();</code><code class="w"/>&#13;
<code class="n">connection</code><code class="p">.</code><code class="na">setConnectTimeout</code><code class="p">(</code><code class="mi">10000</code><code class="p">);</code><code class="w"> </code><code class="c1">// milliseconds</code><code class="w"/>&#13;
<code class="n">connection</code><code class="p">.</code><code class="na">setReadTimeout</code><code class="p">(</code><code class="mi">10000</code><code class="p">);</code><code class="w"> </code><code class="c1">// milliseconds</code><code class="w"/>&#13;
<code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">connection</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/></pre>&#13;
&#13;
<p>As we’ll see in <a data-type="xref" href="#learnjava6-CHP-13-SECT-3.2">“Using the POST Method”</a>, we can get at the protocol-specific information by casting the <code>URLConnection</code> to its specific subtype.<a data-primary="" data-startref="ix_url_class" data-type="indexterm" id="id2500"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Talking to Web Applications" data-type="sect1"><div class="sect1" id="learnjava6-CHP-13-SECT-3">&#13;
<h1>Talking to Web Applications</h1>&#13;
&#13;
<p>Web browsers are the universal clients for web applications. They retrieve documents for display and serve as a user interface, primarily through the use of HTML, JavaScript, and linked documents such as images. In this section, we’ll write client-side Java code that uses HTTP through the <code>URL</code> class. This combination allows us to work with web applications directly using <code>GET</code> and <code>POST</code> operations to retrieve and send data.</p>&#13;
&#13;
<p>The primary task we discuss here is sending data to the server, specifically HTML form-encoded data. Browsers encode the name/value pairs of HTML form fields in a special format and send them to the server (typically) using one of two methods. The first method, using the HTTP <code>GET</code> command, encodes the user’s input into the URL itself and requests the corresponding document. The server recognizes that the first part of the URL refers to a program and invokes it, passing along the information encoded in the other part of the URL as a parameter. The second method uses the HTTP <code>POST</code> command to ask the server to accept the encoded data and pass it to a web application as a stream.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the GET Method" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-3.1">&#13;
<h2>Using the GET Method</h2>&#13;
&#13;
<p>You can get <a data-primary="GET method, HTML environment" data-type="indexterm" id="id2501"/><a data-primary="web services" data-secondary="GET method" data-type="indexterm" id="id2502"/>going with network resources quite quickly using the <code>GET</code> method of encoding data in a URL. Just create a URL pointing to a server program and use a simple convention to tack on the encoded name/value pairs that make up our data. For example, the following code snippet opens a URL to an old-school CGI program called <em>login.cgi</em> on the server <em>myhost</em> and passes it two name/value pairs. It then prints whatever text the CGI sends back:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="n">URL</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// this string should be URL-encoded</code><code class="w"/>&#13;
<code class="w">    </code><code class="s">"http://myhost/cgi-bin/login.cgi?Name=Pat&amp;Password=foobar"</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">bin</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">url</code><code class="p">.</code><code class="na">openStream</code><code class="p">()));</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="k">while</code><code class="w"> </code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">bin</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>To form the URL with parameters, we start with the base URL of <em>login.cgi</em>. We add a question mark (<code>?</code>), which marks the beginning of the parameter data, followed by the first “name=value” pair. We can add as many pairs as we want, separated by ampersand (<code>&amp;</code>) characters. The rest of our code simply opens the stream and reads back the response from the server. Remember that creating a URL doesn’t actually open the connection. In this case, the URL connection was made implicitly when we called <code>openStream()</code>. Although we are assuming here that our server sends back text, it could send anything, including images, audio, or PDFs.</p>&#13;
&#13;
<p>We have <a data-primary="URLEncoder class" data-type="indexterm" id="id2503"/><a data-primary="java.net package" data-secondary="URLEncoder class" data-type="indexterm" id="id2504"/>skipped a step here. This example works because our name/value pairs happen to be simple text. If any “nonprintable” or special characters (including <code>?</code> or <code>&amp;</code>) are in the pairs, they must be encoded first. The <code>java.net.URLEncoder</code> class provides a utility for encoding the data. We’ll show how to use it in the next example in <a data-type="xref" href="#learnjava6-CHP-13-SECT-3.2">“Using the POST Method”</a>.</p>&#13;
&#13;
<p>Although this small example sends a password field, you should never send sensitive data using this simplistic approach. The data in this example is sent in clear text across the network (it is not encrypted). Even using HTTPS (HTTP Secure) won’t obscure the URL. And in this case, the password field would appear anywhere the URL is printed as well, including server logs, browser history, and bookmarks.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the POST Method" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-3.2">&#13;
<h2>Using the POST Method</h2>&#13;
&#13;
<p>For larger <a data-primary="web services" data-secondary="POST method" data-type="indexterm" id="ix_web_serv_post_meth"/><a data-primary="POST method, HTML environment" data-type="indexterm" id="ix_post_meth_html"/><a data-primary="Postman Echo service" data-type="indexterm" id="id2505"/>amounts of input data or for sensitive content, you’ll likely use the <code>POST</code> option. Here’s a small application that acts like an HTML form. It gathers data from two text fields—<code>name</code> and <code>password</code>—and posts the data to the Postman Echo service<sup><a data-type="noteref" href="ch13.html#id2506" id="id2506-marker">1</a></sup> URL using the HTTP <code>POST</code> method. This Swing-based client application works just like a web browser and connects with a web application.</p>&#13;
&#13;
<p>Here’s the key networking method that performs the request and handles the response:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">//file: ch13/examples/Post.java</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">protected</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">postData</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">StringBuilder</code><code class="w"> </code><code class="n">sb</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">StringBuilder</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">pw</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">String</code><code class="p">(</code><code class="n">passwordField</code><code class="p">.</code><code class="na">getPassword</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">URLEncoder</code><code class="p">.</code><code class="na">encode</code><code class="p">(</code><code class="s">"Name"</code><code class="p">,</code><code class="w"> </code><code class="s">"UTF-8"</code><code class="p">)</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">"="</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">URLEncoder</code><code class="p">.</code><code class="na">encode</code><code class="p">(</code><code class="n">nameField</code><code class="p">.</code><code class="na">getText</code><code class="p">(),</code><code class="w"> </code><code class="s">"UTF-8"</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">"&amp;"</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">URLEncoder</code><code class="p">.</code><code class="na">encode</code><code class="p">(</code><code class="s">"Password"</code><code class="p">,</code><code class="w"> </code><code class="s">"UTF-8"</code><code class="p">)</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">"="</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">URLEncoder</code><code class="p">.</code><code class="na">encode</code><code class="p">(</code><code class="n">pw</code><code class="p">,</code><code class="w"> </code><code class="s">"UTF-8"</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">UnsupportedEncodingException</code><code class="w"> </code><code class="n">uee</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">uee</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">formData</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">URL</code><code class="w"> </code><code class="n">url</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">URL</code><code class="p">(</code><code class="n">postURL</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">HttpURLConnection</code><code class="w"> </code><code class="n">urlcon</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">          </code><code class="p">(</code><code class="n">HttpURLConnection</code><code class="p">)</code><code class="w"> </code><code class="n">url</code><code class="p">.</code><code class="na">openConnection</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">urlcon</code><code class="p">.</code><code class="na">setRequestMethod</code><code class="p">(</code><code class="s">"POST"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">urlcon</code><code class="p">.</code><code class="na">setRequestProperty</code><code class="p">(</code><code class="s">"Content-type"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="s">"application/x-www-form-urlencoded"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">urlcon</code><code class="p">.</code><code class="na">setDoOutput</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">urlcon</code><code class="p">.</code><code class="na">setDoInput</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">PrintWriter</code><code class="w"> </code><code class="n">pout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">OutputStreamWriter</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">urlcon</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">(),</code><code class="w"> </code><code class="s">"8859_1"</code><code class="p">),</code><code class="w"> </code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">pout</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="n">formData</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">pout</code><code class="p">.</code><code class="na">flush</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// Did the post succeed?</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">urlcon</code><code class="p">.</code><code class="na">getResponseCode</code><code class="p">()</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="n">HttpURLConnection</code><code class="p">.</code><code class="na">HTTP_OK</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Posted ok!"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Bad post..."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// Hooray! Go ahead and read the results</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">InputStream</code><code class="w"> </code><code class="n">is</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">urlcon</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">InputStreamReader</code><code class="w"> </code><code class="n">isr</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">is</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">br</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="n">isr</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">line</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">while</code><code class="w"> </code><code class="p">((</code><code class="n">line</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">br</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">line</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">br</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">MalformedURLException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">e</code><code class="p">);</code><code class="w">     </code><code class="c1">// bad postURL</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e2</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">e2</code><code class="p">);</code><code class="w">    </code><code class="c1">// I/O error</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The beginning of the <a data-primary="postData() method" data-type="indexterm" id="id2507"/><a data-primary="StringBuilder" data-type="indexterm" id="id2508"/><a data-primary="encode() method" data-secondary="URLEncoder" data-type="indexterm" id="id2509"/>application creates the form using Swing elements, like we did in <a data-type="xref" href="ch12.html#learnjava6-CHP-12">Chapter 12</a>. All the magic happens in the protected <code>postData()</code> method. First, we create a <code>StringBuilder</code> and load it with name/value pairs, separated by ampersands. (We don’t need the initial question mark when we’re using the <code>POST</code> method because we’re not appending to the URL.) Each pair is first encoded using the static <code>URLEncoder.encode()</code> method. We run the name fields through the encoder as well, even though they contain no special characters in this example. This extra step is a best practice and simply a good habit. The field names may not always be so plain.</p>&#13;
&#13;
<p>Next, we set up the connection to the server. In our previous example, we weren’t required to do anything special to send the data because the request was made by the simple act of opening the URL on the server. Here, we have to carry some of the weight of talking to the remote web server. <a data-primary="openConnection() method" data-secondary="URLConnection" data-type="indexterm" id="id2510"/><a data-primary="HttpURLConnection class" data-type="indexterm" id="id2511"/>Fortunately, the <code>HttpURLConnection</code> object does most of the work for us; we just have to tell it what type of data we are sending and how we want to send it. We get a <code>URLConnection</code> object via the <code>openConnection()</code> method. We know that we are using the HTTP protocol, so we should be able to cast it to an <code>HttpURLConnection</code> type, which has the support we need. Because HTTP is one of the guaranteed protocols, we can safely make this assumption. (Speaking of safety, we use HTTP here only for demonstration purposes. So much data these days is considered sensitive. Industry guidelines have settled on defaulting to HTTPS; more on that soon in <a data-type="xref" href="#learnjava6-CHP-13-SECT-3.4">“SSL and Secure Web Communications”</a>.)</p>&#13;
&#13;
<p>We use <code>setRequestMethod()</code> to tell the <a data-primary="setRequestMethod() method, HttpURLConnection" data-type="indexterm" id="id2512"/><a data-primary="setRequestProperty() method, HttpURLConnection" data-type="indexterm" id="id2513"/>connection we want to do a <code>POST</code> operation. We also use <code>setRequestProperty()</code> to set the <code>Content-Type</code> field of our HTTP request to the appropriate type—in this case, the proper media type<sup><a data-type="noteref" href="ch13.html#id2514" id="id2514-marker">2</a></sup> for encoded form data. (This is necessary to tell the server what kind of data we’re sending, <code>"application/x-www-form-urlencoded"</code> in our case.)</p>&#13;
&#13;
<p>For the final <a data-primary="setDoInput() method, HttpURLConnection" data-type="indexterm" id="id2515"/><a data-primary="setDoOutput() method, HttpURLConnection" data-type="indexterm" id="id2516"/>configuration step, we use the <code>setDoOutput()</code> and <code>setDoInput()</code> methods to tell the connection that we want to send <em>and</em> receive stream data. The URL connection infers from this combination that we are going to do a <code>POST</code> operation and expects a response.</p>&#13;
&#13;
<p>To send data, we get an <a data-primary="PrintWriter class" data-type="indexterm" id="id2517"/><a data-primary="getOutputStream() method" data-secondary="HttpURLConnection" data-type="indexterm" id="id2518"/><a data-primary="getResponseCode() method, HttpURLConnection" data-type="indexterm" id="id2519"/>output stream from the connection with <code>getOutputStream()</code> and create a <code>PrintWriter</code> so that we can easily write our encoded form content. After we post the data, our application calls <code>getResponseCode()</code> to see whether the HTTP response code from the server indicates that the <code>POST</code> was successful. Other response codes (defined as constants in <code>HttpURLConnection</code>) indicate various failures.</p>&#13;
&#13;
<p>Although form-encoded data (as indicated by the media type we specified for the <code>Content-Type</code> field) is common, other types of communications are possible. We could use the input and output streams to exchange arbitrary data types with the server program. The <code>POST</code> operation could send any kind of data; the server application simply has to know how to handle it. <a data-primary="URLDecoder class" data-type="indexterm" id="id2520"/><a data-primary="java.net package" data-secondary="URLDecoder class" data-type="indexterm" id="id2521"/>One final note: if you are writing an application that needs to decode form data, you can use the <code>java.net.URLDecoder</code> to undo the operation of the <code>URLEncoder</code>. Be sure to specify UTF-8 when calling <code>decode()</code>.<a data-primary="" data-startref="ix_post_meth_html" data-type="indexterm" id="id2522"/><a data-primary="" data-startref="ix_web_serv_post_meth" data-type="indexterm" id="id2523"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The HttpURLConnection" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-3.3">&#13;
<h2>The HttpURLConnection</h2>&#13;
&#13;
<p>Other <a data-primary="getContentLength() method, HttpURLConnection" data-type="indexterm" id="id2524"/><a data-primary="getHeaderField(), HttpURLConnection" data-type="indexterm" id="id2525"/><a data-primary="getLastModified() method, HttpURLConnection" data-type="indexterm" id="id2526"/><a data-primary="web services" data-secondary="HttpURLConnection" data-type="indexterm" id="id2527"/>information from the request is available from the <code>HttpURLConnection</code> as well. We could use <code>getContentType()</code> and <code>getContentEncoding()</code> to determine the MIME type and encoding of the response. We could also interrogate the HTTP response headers by using <code>getHeaderField()</code>. (HTTP response headers are metadata name/value pairs carried with the response.) Convenience methods can fetch integer- and date-formatted header fields, <code>getHeaderFieldInt()</code> and <code>getHeaderFieldDate()</code>, which return an <code>int</code> and a <code>long</code> type, respectively. The content length and last modification date are provided through <code>getContentLength()</code> and <code>getLastModified()</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SSL and Secure Web Communications" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-3.4">&#13;
<h2>SSL and Secure Web Communications</h2>&#13;
&#13;
<p>Some of the <a data-primary="web services" data-secondary="SSL and secure web communications" data-type="indexterm" id="id2528"/><a data-primary="HTTPS protocol" data-type="indexterm" id="id2529"/><a data-primary="Secure Sockets Layer (SSL)" data-type="indexterm" id="id2530"/><a data-primary="SSL (Secure Sockets Layer)" data-type="indexterm" id="id2531"/>previous examples sent sensitive data to the server. Standard HTTP doesn’t provide encryption to hide our data. Fortunately, adding security for <code>GET</code> and <code>POST</code> operations like this is easy (trivial, in fact, for the client-side developer). Where available, you simply need to use a secure form of the HTTP protocol—HTTPS. Consider the testing URL from the <code>Post</code> example:</p>&#13;
&#13;
<pre data-type="programlisting">https://postman-echo.com/post</pre>&#13;
&#13;
<p>HTTPS is a version of the standard HTTP protocol run over Secure Sockets Layer (SSL), which uses public-key encryption techniques to encrypt the browser-to-server communications. Most web browsers and servers currently come with built-in support for HTTPS (or raw SSL sockets). Therefore, if your web server supports HTTPS and has it configured, you can use a browser to send and receive secure data simply by specifying the <code>https</code> protocol in your URLs. There is much more to learn about SSL and related aspects of security, such as authenticating to whom you are actually talking, but as far as basic data encryption goes, this is all you have to do. It is not something your code has to deal with directly. Java ships with both SSL and HTTPS support.<a data-primary="" data-startref="ix_net_web_ch13" data-type="indexterm" id="id2532"/><a data-primary="" data-startref="ix_web_serv_ch13" data-type="indexterm" id="id2533"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Network Programming" data-type="sect1"><div class="sect1" id="learnjava6-CHP-13-SECT-4">&#13;
<h1>Network Programming</h1>&#13;
&#13;
<p>The web <a data-primary="network programming" data-type="indexterm" id="ix_net_prog"/>dominates developer discussions of networking, but there is more out there than just HTML pages! As Java’s networking APIs have matured, Java has also become the language of choice for implementing traditional client/server applications and services. In this section, we look at the <code>java.net</code> package, which contains the fundamental classes for communications and working with networked resources.</p>&#13;
&#13;
<p>The classes of <code>java.net</code> fall into two general categories: the Sockets API, for working with low-level network protocols, and higher-level, web-oriented APIs that work with URLs, as we saw in the previous section. <a data-type="xref" href="#learnjava6-CHP-13-FIG-3">Figure 13-2</a> shows most of the <code>java.net</code> package hierarchy.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-13-FIG-3">&#13;
<img alt="ljv6 1302" src="assets/ljv6_1302.png"/>&#13;
<h6><span class="label">Figure 13-2. </span>Main classes and interfaces of the <code>java.net</code> package</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Java’s Sockets API provides access to the standard protocols used for communications between hosts. <em>Sockets</em> are the mechanism underlying all other kinds of portable networked communications. Sockets are the lowest-level tool in the general networking toolbox—you can use sockets for any kind of communications between client and server or peer applications, but you have to implement your own application-level protocols for handling and interpreting the data. Higher-level networking tools, such as remote method invocation, HTTP, and web services, are implemented on top of sockets.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sockets" data-type="sect1"><div class="sect1" id="learnjava6-CHP-13-SECT-5">&#13;
<h1>Sockets</h1>&#13;
&#13;
<p>Sockets are a <a data-primary="sockets" data-type="indexterm" id="ix_sockets_ch13"/>low-level programming interface for networked communications. They send streams of data between applications that may or may not be on the same host.</p>&#13;
&#13;
<p>Sockets originated in BSD Unix and are, in some programming languages, messy, complicated things with lots of small parts that can break off and cause havoc. The reason for this is that most socket APIs can be used with almost any kind of underlying network protocol. Since the protocols that transport data across the network can have radically different features, the socket interface can be quite complex.<sup><a data-type="noteref" href="ch13.html#id2534" id="id2534-marker">3</a></sup></p>&#13;
&#13;
<p>The <code>java.net</code> package supports a simplified, object-oriented socket interface that makes network communications considerably easier. If you’ve done network programming using sockets in other languages, you should be pleasantly surprised at how simple things can be when objects encapsulate the gory details. If this is the first time you’ve come across sockets, you’ll find that talking to another application over the network can be as simple as reading a file or getting user input. Most forms of I/O in Java, including most network I/O, use the stream classes described in <a data-type="xref" href="ch10.html#learnjava6-CHP-10-SECT-1">“Streams”</a>. Streams provide a unified I/O interface so that reading or writing across the internet is similar to reading or writing on the local system. In addition to the <span class="keep-together">stream-oriented</span> interfaces, the Java networking APIs can work with the Java NIO buffer-oriented API for highly scalable applications.</p>&#13;
&#13;
<p>Java <a data-primary="DatagramSocket class" data-type="indexterm" id="id2535"/><a data-primary="MulticastSocket class" data-type="indexterm" id="id2536"/><a data-primary="reliable protocol" data-type="indexterm" id="id2537"/><a data-primary="Socket class" data-type="indexterm" id="id2538"/><a data-primary="connection-oriented protocol" data-type="indexterm" id="id2539"/>provides sockets to support three distinct classes of underlying protocols: <code>Socket</code>, <code>DatagramSocket</code>, and <code>MulticastSocket</code>. In this section, we look at Java’s basic <code>Socket</code> class, which uses a <em>connection-oriented</em> and <em>reliable</em> protocol. A connection-oriented protocol provides the equivalent of a telephone conversation. After establishing a connection, two applications can send streams of data back and forth, and the connection stays in place even when no one is talking. Because the protocol is reliable, it also ensures that no data is lost (resending data, as necessary), and that whatever you send always arrives in the order in which you sent it.</p>&#13;
&#13;
<p>We’ll have to leave the other two classes, which use a <em>connectionless</em>, <em>unreliable</em> protocol, for you to explore on your own. (Again, see <a href="https://oreil.ly/RzACA"><em>Java Network Programming</em></a> by Elliotte Rusty-Harold for a detailed discussion.) A connectionless protocol is like the postal service. Applications can send short messages to each other, but no end-to-end connection is set up in advance, and no attempt is made to keep the messages in order. It’s not even guaranteed that the messages will arrive at all. A <code>MulticastSocket</code> is a variation of a <code>DatagramSocket</code> that performs <em>multicasting</em>—simultaneously sending data to multiple recipients. Think of the postal service delivering flyers for the local grocery market to “Resident” addresses throughout a large neighborhood. Working with multicast sockets is very much like working with datagram sockets; there are simply more recipients.</p>&#13;
&#13;
<p>In theory, just about any <a data-primary="Internet Protocol (IP)" data-type="indexterm" id="id2540"/><a data-primary="IP (Internet Protocol)" data-type="indexterm" id="id2541"/><a data-primary="TCP/IP (Transmission Control Protocol/Internet Protocol)" data-type="indexterm" id="id2542"/><a data-primary="Transmission Control Protocol/Internet Protocol (TCP/IP)" data-type="indexterm" id="id2543"/><a data-primary="UDP (User Datagram Protocol)" data-type="indexterm" id="id2544"/><a data-primary="User Datagram Protocol (UDP)" data-type="indexterm" id="id2545"/>protocol can be used underneath the socket layer. In practice, there’s only one important protocol family used on the internet, and only one protocol family that Java supports: the Internet Protocol (IP). The <code>Socket</code> class speaks <em>TCP</em>, Transmission Control Protocol, over IP (often lumped together as TCP/IP); and the connectionless <code>DatagramSocket</code> class speaks <em>UDP</em>, User Datagram Protocol, &#13;
<span class="keep-together">over IP</span>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Clients and Servers" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-5.1">&#13;
<h2>Clients and Servers</h2>&#13;
&#13;
<p>When writing <a data-primary="client/server applications and services" data-type="indexterm" id="ix_client_server2"/><a data-primary="sockets" data-secondary="clients and servers" data-type="indexterm" id="ix_socket_client_serv"/><a data-primary="client/server applications and services" data-secondary="clients and servers" data-type="indexterm" id="ix_client_server"/><a data-primary="network programming" data-secondary="client/server applications and services" data-type="indexterm" id="ix_net_client_server"/>network applications, it’s common to talk about clients and servers. The distinction is increasingly vague, but the  <em>client</em> usually initiates the conversation. The <em>server</em> usually accepts incoming requests. There are many subtleties to these roles,<sup><a data-type="noteref" href="ch13.html#id2546" id="id2546-marker">4</a></sup> but for simplicity we’ll use this definition.</p>&#13;
&#13;
<p>An important difference between a client and a server is that a client can create a socket to initiate a conversation with a server application at any time, while a server must be prepared in advance to listen for incoming conversation requests. The <code>java.net.Socket</code> class represents one side of an individual socket connection on both the client and server. <a data-primary="java.net package" data-secondary="ServerSocket class" data-type="indexterm" id="id2547"/><a data-primary="ServerSocket class" data-type="indexterm" id="id2548"/><a data-primary="accept() method, ServerSocket" data-type="indexterm" id="id2549"/>In addition, the server uses the <code>java.net.ServerSocket</code> class to listen for new connections from clients. In most cases, an application acting as a server creates a <code>ServerSocket</code> object and waits, blocked in a call to its <code>accept()</code> method, until a request arrives. When a client attempts to connect, the <code>accept()</code> method creates a new <code>Socket</code> object that the server uses to communicate with the client. The <code>ServerSocket</code> instance hands over details on the client to the new <code>Socket</code>, as shown in <a data-type="xref" href="#learnjava6-CHP-13-FIG-4">Figure 13-3</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-13-FIG-4">&#13;
<img alt="ljv6 1303" src="assets/ljv6_1303.png"/>&#13;
<h6><span class="label">Figure 13-3. </span>Clients and servers using <code>Socket</code> and <code>ServerSocket</code></h6>&#13;
</div></figure>&#13;
&#13;
<p>That socket continues the conversation with the client, allowing the <code>ServerSocket</code> to resume its listening task. In this way, a server can carry on conversations with multiple clients at once. There is still only a single <code>ServerSocket</code>, but the server has multiple <code>Socket</code> objects—one associated with each client.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Clients" data-type="sect3"><div class="sect3" id="learnjava6-CHP-13-SECT-5.1.1">&#13;
<h3>Clients</h3>&#13;
&#13;
<p>At the <a data-primary="hostname" data-type="indexterm" id="id2550"/><a data-primary="port number" data-type="indexterm" id="id2551"/>socket level, a client needs two pieces of information to locate and connect to a server on the internet: a <em>hostname</em> (used to find the host computer’s network address) and a <em>port number</em>. The port number is an identifier that differentiates between multiple network services or connections on the same host.</p>&#13;
&#13;
<p>A server application listens on a prearranged port while waiting for connections. Clients make a request to that prearranged port number. If you think of the host computer as a hotel and the various services available as guests, the ports are like the guests’ room numbers. To connect to a service, you must know the hotel name and the right room number.</p>&#13;
&#13;
<p>A client <a data-primary="Socket class" data-type="indexterm" id="ix_socket_class"/>application opens a connection to a server by constructing a <code>Socket</code> that specifies those two bits of information:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">Socket</code><code class="w"> </code><code class="n">sock</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Socket</code><code class="p">(</code><code class="s">"wupost.wustl.edu"</code><code class="p">,</code><code class="w"> </code><code class="mi">25</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">UnknownHostException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Can't find host."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Error connecting to host."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>This client-side <a data-primary="IP addresses" data-type="indexterm" id="id2552"/><a data-primary="DNS (Domain Name Service)" data-type="indexterm" id="id2553"/><a data-primary="Domain Name Service (DNS)" data-type="indexterm" id="id2554"/>code fragment attempts to connect a <code>Socket</code> to port 25 (the SMTP mail service) of the host <em>wupost.wustl.edu</em>. The client must handle the possibility that the hostname can’t be resolved (<code>UnknownHostException</code>) and that the server might not accept a new connection (<code>IOException</code>). Java uses DNS, the standard <em>Domain Name Service</em> (DNS), to resolve the hostname to an <em>IP address</em> for us.</p>&#13;
&#13;
<p>IP addresses (from the Internet Protocol) are the phone numbers of the internet, and DNS is the global phone book. Every machine connected to the internet has an IP address. If you don’t know that address, you look it up with DNS. But if you do know a server’s address, the <code>Socket</code> constructor can also accept a string containing a raw IP address:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="n">Socket</code><code class="w"> </code><code class="n">sock</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Socket</code><code class="p">(</code><code class="s">"22.66.89.167"</code><code class="p">,</code><code class="w"> </code><code class="mi">25</code><code class="p">);</code><code class="w"/></pre>&#13;
&#13;
<p>Regardless of which way you <a data-primary="getInputStream() method, Socket" data-type="indexterm" id="id2555"/><a data-primary="getOutputStream() method" data-secondary="Socket" data-type="indexterm" id="id2556"/>start, after <code>sock</code> connects, you can retrieve input and output streams with the <code>getInputStream()</code> and <code>getOutputStream()</code> methods. The following (rather arbitrary) code sends and receives some data with the streams:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">Socket</code><code class="w"> </code><code class="n">server</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Socket</code><code class="p">(</code><code class="s">"foo.bar.com"</code><code class="p">,</code><code class="w"> </code><code class="mi">1234</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">server</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">OutputStream</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">server</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// write a byte</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">out</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="mi">42</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// write a newline or carriage return delimited string</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">PrintWriter</code><code class="w"> </code><code class="n">pout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="n">out</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">pout</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Hello!"</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// read a byte</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">byte</code><code class="w"> </code><code class="n">back</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="kt">byte</code><code class="p">)</code><code class="n">in</code><code class="p">.</code><code class="na">read</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// read a newline or carriage return delimited string</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">bin</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">in</code><code class="p">)</code><code class="w"> </code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">bin</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="n">server</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">e</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>In this <a data-primary="port number" data-type="indexterm" id="id2557"/>exchange, the client first creates a <code>Socket</code> for communicating with the server. The <code>Socket</code> constructor specifies the server’s hostname (<em>foo.bar.com</em>) and a prearranged port number (1234). Once the client connects, it writes a single byte to the server using the <code>OutputStream</code>’s <code>write()</code> method. To send a string of text more easily, it then wraps a <code>PrintWriter</code> around the <code>OutputStream</code>. Next, it performs the complementary operations: reading a byte back from the server using <code>InputStream</code>’s <code>read()</code> method and then creating a <code>BufferedReader</code> from which to get a full string of text. The client then terminates the connection with the <code>close()</code> method. All these operations have the potential to generate <code>IOException</code>s; our snippet handles these checked exceptions by wrapping the entire conversation in a <code>try/catch</code> block.<a data-primary="" data-startref="ix_socket_class" data-type="indexterm" id="id2558"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Servers" data-type="sect3"><div class="sect3" id="learnjava6-CHP-13-SECT-5.1.2">&#13;
<h3>Servers</h3>&#13;
&#13;
<p>On the other <a data-primary="ServerSocket class" data-type="indexterm" id="ix_server_socket"/><a data-primary="servers" data-type="indexterm" id="ix_server_ch13"/>side of the conversation, after a connection is established, a server application uses the same kind of <code>Socket</code> object for its communication with a client. However, to accept a connection from a <span class="keep-together">client,</span> it must first create a <code>ServerSocket</code>, bound to the correct port. Let’s re-create the previous conversation from the server’s point of view:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// Meanwhile, on foo.bar.com...</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">ServerSocket</code><code class="w"> </code><code class="n">listener</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">ServerSocket</code><code class="p">(</code><code class="mi">1234</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="o">!</code><code class="n">finished</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Socket</code><code class="w"> </code><code class="n">client</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">listener</code><code class="p">.</code><code class="na">accept</code><code class="p">();</code><code class="w">  </code><code class="c1">// wait for connection</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">OutputStream</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">client</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="c1">// read a byte</code><code class="w"/>&#13;
<code class="w">        </code><code class="kt">byte</code><code class="w"> </code><code class="n">someByte</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="kt">byte</code><code class="p">)</code><code class="n">in</code><code class="p">.</code><code class="na">read</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="c1">// read a newline or carriage-return-delimited string</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">bin</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">          </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">in</code><code class="p">)</code><code class="w"> </code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">String</code><code class="w"> </code><code class="n">someString</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">bin</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="c1">// write a byte</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">out</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="mi">43</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="c1">// say goodbye</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">PrintWriter</code><code class="w"> </code><code class="n">pout</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="n">out</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">pout</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Goodbye!"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">   </code>&#13;
<code class="w">        </code><code class="n">client</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="n">listener</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">e</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>First, our server creates a <code>ServerSocket</code> attached to port 1234. On most systems, there are rules about which ports an application can use. Port numbers are unsigned, 16-bit integers, which means they can range from 0 to 65,535. Port numbers below 1,024 are usually reserved for system processes and standard, “well-known” services, so we pick a port number outside of this reserved range.<sup><a data-type="noteref" href="ch13.html#id2559" id="id2559-marker">5</a></sup> We need to create the <code>ServerSocket</code> only once; thereafter, it can accept as many connections as arrive.</p>&#13;
&#13;
<p>Next, we enter a <a data-primary="accept() method, ServerSocket" data-type="indexterm" id="id2560"/>loop, waiting for the <code>accept()</code> method of the <code>ServerSocket</code> to return an active <code>Socket</code> connection from a client. When a connection has been established, we perform the server side of our dialog, then close the connection and return to the top of the loop to wait for another connection. Finally, when the server <span class="keep-together">application</span> wants to stop listening for connections altogether, it calls the <code>close()</code> method of the <code>ServerSocket</code>.</p>&#13;
&#13;
<p>This server is single threaded; it handles one connection at a time, finishing a complete conversation with one client before returning to the top of the loop and calling <code>accept()</code> to listen for another connection. A more realistic server would have a loop that accepts connections concurrently and passes them off to their own threads for processing. Even though we don’t plan on creating a MMORPG,<sup><a data-type="noteref" href="ch13.html#id2561" id="id2561-marker">6</a></sup> we do show how to conduct a conversation using the thread-per-client approach in <a data-type="xref" href="#learnjava6-CHP-13-SECT-5.3">“A Distributed Game”</a>. If you want to do a little independent reading, you can also look up the nonblocking, NIO equivalent <code>ServerSocketChannel</code>.<a data-primary="" data-startref="ix_client_server" data-type="indexterm" id="id2562"/><a data-primary="" data-startref="ix_socket_client_serv" data-type="indexterm" id="id2563"/><a data-primary="" data-startref="ix_server_ch13" data-type="indexterm" id="id2564"/><a data-primary="" data-startref="ix_server_socket" data-type="indexterm" id="id2565"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The DateAtHost Client" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-5.2">&#13;
<h2>The DateAtHost Client</h2>&#13;
&#13;
<p>In the past, many <a data-primary="DateAtHost client" data-type="indexterm" id="ix_date_at_host"/><a data-primary="sockets" data-secondary="DateAtHost client" data-type="indexterm" id="ix_socket_date_host"/><a data-primary="Network Time Protocol (NTP)" data-type="indexterm" id="id2566"/><a data-primary="NTP (Network Time Protocol)" data-type="indexterm" id="id2567"/><a data-primary="client/server applications and services" data-secondary="DateAtHost client" data-type="indexterm" id="ix_client_server_date_host"/>networked computers ran a simple time service that dispensed their clock’s local time on a well-known port. The time protocol is a precursor of NTP, the more general Network Time Protocol. We’ll stick with the time protocol for its simplicity, but if you do want to synchronize the clocks of networked system, NTP is a better option.<sup><a data-type="noteref" href="ch13.html#id2568" id="id2568-marker">7</a></sup></p>&#13;
&#13;
<p>The next <a data-primary="Date class" data-type="indexterm" id="id2569"/><a data-primary="java.util package" data-secondary="Date class" data-type="indexterm" id="id2570"/>example, <code>DateAtHost</code>, includes a subclass of <code>java.util.Date</code> that fetches the time from a remote host instead of initializing itself from the local clock. (See <a data-type="xref" href="ch08.html#learnjava6-CHP-8">Chapter 8</a> for a discussion of the <code>Date</code> class, which is still good for some uses but has been largely replaced by its newer, more flexible cousins, <code>LocalDate</code> and <code>LocalTime</code>.)</p>&#13;
&#13;
<p><code>DateAtHost</code> connects to the time service (port 37) and reads four bytes representing the time on the remote host. These four bytes have a peculiar specification that we decode to get the time. Here’s the code:</p>&#13;
&#13;
<pre class="less_space pagebreak-before" data-code-language="java" data-type="programlisting"><code class="c1">//file: ch13.examples.DateAtHost.java</code><code class="w"/>&#13;
<code class="kn">package</code><code class="w"> </code><code class="nn">ch13.examples</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="kn">import</code><code class="w"> </code><code class="nn">java.net.Socket</code><code class="p">;</code><code class="w"/>&#13;
<code class="kn">import</code><code class="w"> </code><code class="nn">java.io.*</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">   </code>&#13;
<code class="kd">public</code><code class="w"> </code><code class="kd">class</code> <code class="nc">DateAtHost</code><code class="w"> </code><code class="kd">extends</code><code class="w"> </code><code class="n">java</code><code class="p">.</code><code class="na">util</code><code class="p">.</code><code class="na">Date</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">static</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="n">timePort</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">37</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="c1">// seconds from start of 20th century to Jan 1, 1970 00:00 GMT</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">static</code><code class="w"> </code><code class="kd">final</code><code class="w"> </code><code class="kt">long</code><code class="w"> </code><code class="n">offset</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">2208988800L</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="nf">DateAtHost</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">host</code><code class="p">)</code><code class="w"> </code><code class="kd">throws</code><code class="w"> </code><code class="n">IOException</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">this</code><code class="p">(</code><code class="n">host</code><code class="p">,</code><code class="w"> </code><code class="n">timePort</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="w"> </code>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="nf">DateAtHost</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">host</code><code class="p">,</code><code class="w"> </code><code class="kt">int</code><code class="w"> </code><code class="n">port</code><code class="p">)</code><code class="w"> </code><code class="kd">throws</code><code class="w"> </code><code class="n">IOException</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Socket</code><code class="w"> </code><code class="n">server</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Socket</code><code class="p">(</code><code class="n">host</code><code class="p">,</code><code class="w"> </code><code class="n">port</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">DataInputStream</code><code class="w"> </code><code class="n">din</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">new</code><code class="w"> </code><code class="n">DataInputStream</code><code class="p">(</code><code class="n">server</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">    </code><code class="kt">int</code><code class="w"> </code><code class="n">time</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">din</code><code class="p">.</code><code class="na">readInt</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">server</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="n">setTime</code><code class="p">((((</code><code class="mi">1L</code><code class="w"> </code><code class="o">&lt;&lt;</code><code class="w"> </code><code class="mi">32</code><code class="p">)</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">time</code><code class="p">)</code><code class="w"> </code><code class="o">-</code><code class="w"> </code><code class="n">offset</code><code class="p">)</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="mi">1000</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>That’s all there is to it. It’s not very long, even with a few frills. We have supplied two possible constructors for <code>DateAtHost</code>. Normally we’d expect to use the first, which simply takes the name of the remote host as an argument. The second constructor specifies the hostname and the port number of the remote time service. (If the time service were running on a nonstandard port, we would use the second constructor to specify the alternate port number.) This second constructor does the work of making the connection and setting the time. The first constructor simply invokes the second (using the <code>this()</code> construct) with the default port as an argument. Supplying simplified constructors that invoke their siblings with default arguments is a common and useful pattern in Java; that is the main reason we’ve shown it here.</p>&#13;
&#13;
<p>The second <a data-primary="DataInputStream class" data-type="indexterm" id="id2571"/><a data-primary="DataOutputStream class" data-type="indexterm" id="id2572"/><a data-primary="network byte order" data-type="indexterm" id="id2573"/><a data-primary="" data-type="indexterm" id="id2574"/>constructor opens a socket to the specified port on the remote host. It creates a <code>DataInputStream</code> to wrap the input stream and then reads a four-byte integer using the <code>readInt()</code> method. It’s no coincidence that the bytes are in the right order. Java’s <code>DataInputStream</code> and <code>DataOutputStream</code> classes work with the bytes of integer types in <em>network byte order</em> (most significant to least significant). The time protocol (and other standard network protocols that deal with binary data) also uses the network byte order, so we don’t need to call any conversion routines. Explicit data conversions would probably be necessary if we were using a nonstandard protocol, especially when talking to a non-Java client or server. In that case, we’d have to read byte by byte and do some rearranging to get our four-byte value. After reading the data, we’re finished with the socket, so we close it, terminating the connection to the server. Finally, the constructor initializes the rest of the object by calling <code>Date</code>’s <code>setTime()</code> method with the calculated time value.</p>&#13;
&#13;
<p>The four bytes of the time value are interpreted as an integer representing the number of seconds since the beginning of the 20th century. <code>DateAtHost</code> converts this to Java’s notion of absolute time—the count of milliseconds since January 1, 1970 (an arbitrary date standardized by C and Unix). The conversion first creates a <code>long</code> value, which is the unsigned equivalent of the integer <code>time</code>. It subtracts an offset to make the time relative to the epoch (January 1, 1970) rather than the century, and multiplies by 1,000 to convert to milliseconds. The converted time is used to initialize the object.</p>&#13;
&#13;
<p>The <code>DateAtHost</code> class can work with a time retrieved from a remote host almost as easily as <code>Date</code> is used with the time on the local host. The only additional overhead is dealing with the possible <code>IOException</code> that the <code>DateAtHost</code> constructor can throw:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">Date</code><code class="w"> </code><code class="n">d</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">DateAtHost</code><code class="p">(</code><code class="s">"time.nist.gov"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"The time over there is: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">d</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Failed to get the time: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">e</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>This example fetches the time at the host <em>time.nist.gov</em> and prints its value.<a data-primary="" data-startref="ix_client_server_date_host" data-type="indexterm" id="id2575"/><a data-primary="" data-startref="ix_date_at_host" data-type="indexterm" id="id2576"/><a data-primary="" data-startref="ix_socket_date_host" data-type="indexterm" id="id2577"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Distributed Game" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-5.3">&#13;
<h2>A Distributed Game</h2>&#13;
&#13;
<p>We can use our <a data-primary="sockets" data-secondary="distributed game setup" data-type="indexterm" id="ix_sockets_distr_game"/><a data-primary="client/server applications and services" data-secondary="distributed game setup" data-type="indexterm" id="ix_client_server_distr_game"/>newfound networking skills to extend our apple tossing game and go two-player. We’ll have to keep this foray simple, but you might be surprised by how quickly we can get a proof of concept off the ground. While there are several mechanisms two players could use to get connected for a shared experience, our example uses the basic client/server model we’ve been discussing in this chapter. One user will start the server, and the second user will be able to contact that server as the client. Once both players are connected, they’ll race to see who can clear the trees and hedges the fastest!</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting up the UI" data-type="sect3"><div class="sect3" id="learnjava6-CHP-13-SECT-5.3.1">&#13;
<h3>Setting up the UI</h3>&#13;
&#13;
<p>Let’s start by adding a menu to our game. <a data-primary="servers" data-type="indexterm" id="ix_servers_distr_game"/>Recall from <a data-type="xref" href="ch12.html#learnjava6-CHP-12-SECT-5.1">“Menus”</a> that menus live in a menu bar and work with <code>ActionEvent</code> objects, much like buttons. We need one option for starting a server and another for joining a game at a server someone has already started. The core code for these menu items is straightforward; we can use another helper method in the <code>AppleToss</code> class:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="kd">private</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">setupNetworkMenu</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">JMenu</code><code class="w"> </code><code class="n">netMenu</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">JMenu</code><code class="p">(</code><code class="s">"Multiplayer"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">multiplayerHelper</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Multiplayer</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="n">JMenuItem</code><code class="w"> </code><code class="n">startItem</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">JMenuItem</code><code class="p">(</code><code class="s">"Start Server"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">startItem</code><code class="p">.</code><code class="na">addActionListener</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">            </code><code class="n">e</code><code class="w"> </code><code class="o">-&gt;</code><code class="w"> </code><code class="n">multiplayerHelper</code><code class="p">.</code><code class="na">startServer</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">netMenu</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">startItem</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="n">JMenuItem</code><code class="w"> </code><code class="n">joinItem</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">JMenuItem</code><code class="p">(</code><code class="s">"Join Game..."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">joinItem</code><code class="p">.</code><code class="na">addActionListener</code><code class="p">(</code><code class="n">e</code><code class="w"> </code><code class="o">-&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">String</code><code class="w"> </code><code class="n">otherServer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">showInputDialog</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">AppleToss</code><code class="p">.</code><code class="na">this</code><code class="p">,</code><code class="w"> </code><code class="s">"Enter server name or address:"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">multiplayerHelper</code><code class="p">.</code><code class="na">joinGame</code><code class="p">(</code><code class="n">otherServer</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">});</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">netMenu</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">joinItem</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="n">JMenuItem</code><code class="w"> </code><code class="n">quitItem</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">JMenuItem</code><code class="p">(</code><code class="s">"Disconnect"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">quitItem</code><code class="p">.</code><code class="na">addActionListener</code><code class="p">(</code><code class="w"/>&#13;
<code class="w">            </code><code class="n">e</code><code class="w"> </code><code class="o">-&gt;</code><code class="w"> </code><code class="n">multiplayerHelper</code><code class="p">.</code><code class="na">disconnect</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">netMenu</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">quitItem</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// build a JMenuBar for the application</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">JMenuBar</code><code class="w"> </code><code class="n">mainBar</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">JMenuBar</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">mainBar</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">netMenu</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">setJMenuBar</code><code class="p">(</code><code class="n">mainBar</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The use of lambdas for each menu’s <code>ActionListener</code> should look familiar. We also use the <code>JOptionPane</code> discussed in <a data-type="xref" href="ch12.html#learnjava6-CHP-12-SECT-5.2">“Modals and Pop-Ups”</a> to ask the second player for the name or IP address of the server where the first player is waiting. The networking logic is handled in a separate class.</p>&#13;
&#13;
<p>We’ll look at the <code>Multiplayer</code> class in more detail in the coming sections, but you can see the methods we’ll be implementing. The code for this version of the game (in the <em>ch13/examples/game</em> folder) contains the <code>setupNetworkMenu()</code> method, but the lambda listeners just pop up an info dialog to indicate which menu item was selected. You get to build the <code>Multiplayer</code> class and call the actual multiplayer methods in the exercises at the end of the chapter. But do feel free to check out the completed game—including the networking parts—in the <em>ch13/solutions/game</em> folder.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The game server" data-type="sect3"><div class="sect3" id="learnjava6-CHP-13-SECT-5.3.2">&#13;
<h3>The game server</h3>&#13;
&#13;
<p>As we did in <a data-type="xref" href="#learnjava6-CHP-13-SECT-5.1.2">“Servers”</a>, we need to pick a port and set up a socket that is listening for an incoming connection. We’ll use port 8677—“TOSS” on a phone number pad. We can create a <code>Server</code> inner class in our <code>Multiplayer</code> class to drive a thread ready for network communications. The <code>reader</code> and <code>writer</code> variables will be used to send and receive the actual game data. More on that in <a data-type="xref" href="#learnjava6-CHP-13-SECT-5.3.4">“The game protocol”</a>:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Server</code><code class="w"> </code><code class="kd">implements</code><code class="w"> </code><code class="n">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">ServerSocket</code><code class="w"> </code><code class="n">listener</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Socket</code><code class="w"> </code><code class="n">socket</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">null</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">listener</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">ServerSocket</code><code class="p">(</code><code class="n">gamePort</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">keepListening</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">socket</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">listener</code><code class="p">.</code><code class="na">accept</code><code class="p">();</code><code class="w">  </code><code class="c1">// wait for connection</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">socket</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">reader</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">in</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">OutputStream</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">socket</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">PrintWriter</code><code class="w"> </code><code class="n">writer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="n">out</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">        </code><code class="c1">// ... game protocol logic starts here</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">ioe</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">ioe</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We set up our <code>ServerSocket</code> and then wait for a new client inside a loop. While we plan to play only one opponent at a time, this allows us to accept subsequent clients without going through all the network setup again.</p>&#13;
&#13;
<p>To actually start the server listening the first time, we just need a new thread that uses our <code>Server</code> class:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// from Multiplayer</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">Server</code><code class="w"> </code><code class="n">server</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// ...</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">startServer</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">keepListening</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// ... other game state can go here</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">server</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Server</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">serverThread</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="n">server</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">serverThread</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We keep a reference to the instance of <code>Server</code> in our <code>Multiplayer</code> class so that we have ready access to shut down the connections if the user selects the “disconnect” option from the menu, like so:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// from Multiplayer</code><code class="w"/>&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">disconnect</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">disconnecting</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">keepListening</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Are we in the middle of a game and regularly checking these flags?</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// If not, just close the server socket to interrupt the blocking</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// accept() method.</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">server</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="kc">false</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">server</code><code class="p">.</code><code class="na">stopListening</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// ... clean up other game state here</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We mainly use the <code>keepPlaying</code> flag once we’re inside our game loop, but it comes in handy above, too. If we have a valid <code>server</code> reference but we’re not currently playing a game (<code>keepPlaying</code> is false), we know to shut down the listener socket.</p>&#13;
&#13;
<p>The <code>stopListening()</code> method in the <code>Server</code> inner class is straightforward:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">stopListening</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">listener</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="o">!</code><code class="n">listener</code><code class="p">.</code><code class="na">isClosed</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">listener</code><code class="p">.</code><code class="na">close</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">ioe</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Error disconnecting listener: "</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">            </code><code class="n">ioe</code><code class="p">.</code><code class="na">getMessage</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We do a quick check of our server and try to close <code>listener</code> only if it exists and is still open.<a data-primary="" data-startref="ix_servers_distr_game" data-type="indexterm" id="id2578"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The game client" data-type="sect3"><div class="sect3" id="learnjava6-CHP-13-SECT-5.3.3">&#13;
<h3>The game client</h3>&#13;
&#13;
<p>The setup and teardown of the client side is similar—without the listening <code>ServerSocket</code>, of course. We’ll mirror the <code>Server</code> inner class with a <code>Client</code> inner class and build a smart <code>run()</code> method to implement our client logic:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Client</code><code class="w"> </code><code class="kd">implements</code><code class="w"> </code><code class="n">Runnable</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">String</code><code class="w"> </code><code class="n">gameHost</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="kt">boolean</code><code class="w"> </code><code class="n">startNewGame</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="nf">Client</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">host</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">gameHost</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">host</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">startNewGame</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">run</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">try</code><code class="w"> </code><code class="p">(</code><code class="n">Socket</code><code class="w"> </code><code class="n">socket</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Socket</code><code class="p">(</code><code class="n">gameHost</code><code class="p">,</code><code class="w"> </code><code class="n">gamePort</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="n">InputStream</code><code class="w"> </code><code class="n">in</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">socket</code><code class="p">.</code><code class="na">getInputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">BufferedReader</code><code class="w"> </code><code class="n">reader</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="w">          </code><code class="k">new</code><code class="w"> </code><code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">InputStreamReader</code><code class="p">(</code><code class="n">in</code><code class="p">)</code><code class="w"> </code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">OutputStream</code><code class="w"> </code><code class="n">out</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">socket</code><code class="p">.</code><code class="na">getOutputStream</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">PrintWriter</code><code class="w"> </code><code class="n">writer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">PrintWriter</code><code class="p">(</code><code class="n">out</code><code class="p">,</code><code class="w"> </code><code class="kc">true</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="c1">// ... game protocol logic starts here</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="w"> </code><code class="p">(</code><code class="n">IOException</code><code class="w"> </code><code class="n">ioe</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">ioe</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We pass the name of the server to the <code>Client</code> constructor and rely on the common <code>gamePort</code> variable used by <code>Server</code> to set up the socket. We use the “try with resource” technique discussed in <a data-type="xref" href="ch06.html#learnjava6-CHP-6-SECT-1.9">“try with Resources”</a> to create our socket and make sure it gets cleaned up when we’re done. Inside that resource <code>try</code> block, we create our <code>reader</code> and <code>writer</code> instances for the client’s half of the conversation, as shown in <a data-type="xref" href="#learnjava6-CHP-13-FIG-5">Figure 13-4</a>.</p>&#13;
&#13;
<figure><div class="figure" id="learnjava6-CHP-13-FIG-5">&#13;
<img alt="ljv6 1304" src="assets/ljv6_1304.png"/>&#13;
<h6><span class="label">Figure 13-4. </span>Game client and server connections</h6>&#13;
</div></figure>&#13;
&#13;
<p>To get this going, we’ll add another helper method to our <code>Multiplayer</code> helper class:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// from Multiplayer</code><code class="w"/>&#13;
&#13;
<code class="w">  </code><code class="kd">public</code><code class="w"> </code><code class="kt">void</code><code class="w"> </code><code class="nf">joinGame</code><code class="p">(</code><code class="n">String</code><code class="w"> </code><code class="n">otherServer</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">clientThread</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Thread</code><code class="p">(</code><code class="k">new</code><code class="w"> </code><code class="n">Client</code><code class="p">(</code><code class="n">otherServer</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">clientThread</code><code class="p">.</code><code class="na">start</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We don’t need a separate <code>disconnect()</code> method—we can use the same state variables used by the server. For the client, the <code>server</code> reference will be <code>null</code>, so we won’t attempt to shut down a nonexistent <span class="keep-together">listener.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The game protocol" data-type="sect3"><div class="sect3" id="learnjava6-CHP-13-SECT-5.3.4">&#13;
<h3>The game protocol</h3>&#13;
&#13;
<p>You likely <a data-primary="protocol" data-secondary="distributed game network setup" data-type="indexterm" id="ix_protocol_distr_game"/>noticed we left out the bulk of the <code>run()</code> method for both the <code>Server</code> and <code>Client</code> classes. After we build and connect our data streams, the remaining work is all about collaboratively sending and receiving information about the state of our game. This structured communication is the game’s <em>protocol</em>. Every network service has a protocol. Think of the “P” in HTTP. Even our <code>DateAtHost</code> example uses a (very simple) protocol so that clients and servers know who is expected to talk and who must listen at any given moment. If both sides try to talk at the same time, information will likely be lost. If both sides end up waiting for the other side to say something (for instance, both the server and the client are blocking on a <code>reader.readLine()</code> call), then the connection will appear to hang.</p>&#13;
&#13;
<p>Managing those communication expectations is the core of any protocol, but what to say and how to respond are also important. This portion of a protocol often requires the most effort from the developer. Part of the difficulty is that you really need both sides to test your work as you go. You can’t test a server without a client, and vice versa. Building up both sides as you go can feel tedious, but it is worth the extra effort. As with other kinds of debugging, fixing a small incremental change is much simpler than figuring out what might be wrong within a large block of code.</p>&#13;
&#13;
<p>In our game, we’ll have the server steer the conversation. This choice is <span class="keep-together">arbitrary—</span>we could have used the client, or we could have built a fancier foundation and allowed both the client and the server to be in charge of certain things simultaneously. With the “server in charge” decision made, though, we can try a very simple first step in our protocol. We’ll have the server send a <code>"NEW_GAME"</code> command and then wait for the client to respond with an <code>"OK"</code> answer. The server-side code (after the connection with the client is established) looks like this:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// Create a new game with the client</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"NEW_GAME"</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// If the client agrees, send over the location of the trees</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">response</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"OK"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Starting a new game!"</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// ... write game data here</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Unexpected start response: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">response</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Skipping game and waiting again."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>If we get the expected <code>"OK"</code> response, we can proceed with setting up a new game and sharing the tree and hedge locations with our opponent—more on that in a minute. (If we don’t get an <code>"OK"</code>, we show an error and reset to wait for some other attempt.) The corresponding client-side code for this first step flows similarly:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// We expect to see the NEW_GAME command first</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">String</code><code class="w"> </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// If we don't see that command, disconnect and return</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">response</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="kc">null</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="o">!</code><code class="n">response</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"NEW_GAME"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Unexpected initial command: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">response</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Disconnecting"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"DISCONNECT"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">return</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Yay! We're going to play a game. Send an acknowledgement</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"OK"</code><code class="p">);</code><code class="w"/></pre>&#13;
&#13;
<p>If you want to try things as they stand, you can start your server from one system and then join that game from a second system. (You can also just launch a second copy of the game from a separate terminal window. In that case, the name of the “other host” would be the networking keyword <code>localhost</code>.) Almost immediately after joining from the second game instance, you should see the “Starting a new game!” confirmation printed in the terminal of the first game. Congratulations! You’re on your way to designing a game protocol. Let’s keep going.</p>&#13;
&#13;
<p>We need to even the playing field—quite literally. The server will tell its game to build a new field, and then it can ship the coordinates of all the new obstacles to the client. The client, in turn, can accept all the incoming trees and hedges, and place them on a clean field. Once the server has sent all of the trees, it can send a <code>"START"</code> command and play can begin. We’ll stick to using strings to communicate our messages. Here’s one way we can pass our tree details to the <span class="keep-together">client:</span></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="n">gameField</code><code class="p">.</code><code class="na">setupNewGame</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="n">Tree</code><code class="w"> </code><code class="n">tree</code><code class="w"> </code><code class="p">:</code><code class="w"> </code><code class="n">gameField</code><code class="p">.</code><code class="na">trees</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"TREE "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">tree</code><code class="p">.</code><code class="na">getPositionX</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">" "</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">tree</code><code class="p">.</code><code class="na">getPositionY</code><code class="p">());</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// do the same for hedges or any other shared elements ...</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// Attempt to start the game, but make sure the client is ready</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"START"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"OK"</code><code class="p">);</code><code class="w"/></pre>&#13;
&#13;
<p>On the client side, we can call <code>readLine()</code> in a loop for <code>"TREE"</code> lines until we see the <code>“START”</code> line, like so (with a little error handling thrown in):</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// And now gather the trees and set up our field</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">gameField</code><code class="p">.</code><code class="na">trees</code><code class="p">.</code><code class="na">clear</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">response</code><code class="p">.</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"TREE"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="o">[]</code><code class="w"> </code><code class="n">parts</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">" "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">int</code><code class="w"> </code><code class="n">x</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Integer</code><code class="p">.</code><code class="na">parseInt</code><code class="p">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">int</code><code class="w"> </code><code class="n">y</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">Integer</code><code class="p">.</code><code class="na">parseInt</code><code class="p">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">2</code><code class="o">]</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">Tree</code><code class="w"> </code><code class="n">tree</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="k">new</code><code class="w"> </code><code class="n">Tree</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">tree</code><code class="p">.</code><code class="na">setPosition</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="w"> </code><code class="n">y</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">gameField</code><code class="p">.</code><code class="na">trees</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">tree</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Do the same for hedges or other shared elements</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// After all the obstacle lists have been sent, the server will issue</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// a START command. Make sure we get that before playing</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="o">!</code><code class="n">response</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"START"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Hmm, we should have ended the lists of obstacles with a START,</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// but didn't. Bail out.</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Unexpected start to the game: "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="n">response</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Disconnecting"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"DISCONNECT"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">return</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Yay again! We're starting a game. Acknowledge this command</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"OK"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">gameField</code><code class="p">.</code><code class="na">repaint</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>At this point, both games should have the same obstacles, and players can begin clearing them. The server will enter a polling loop and send the current score twice a second. The client will reply with its current score. Note that there are certainly other options for how to share changes in the score. While polling is straightforward, more advanced games, or games that require more immediate feedback regarding remote players, will likely use more direct communication options. For now, we mainly want to concentrate on a good network back-and-forth, so polling keeps our code simpler.</p>&#13;
&#13;
<p>The server should keep sending the current score until the local player has cleared everything or we see a game-ending response from the client. We’ll need to parse the client’s response to update the other player’s score and watch for their request to end the game. We also have to be prepared for the client to simply disconnect. That loop looks something like this:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">keepPlaying</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">try</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">gameField</code><code class="p">.</code><code class="na">trees</code><code class="p">.</code><code class="na">size</code><code class="p">()</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">writer</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"SCORE "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">writer</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"END "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">gameField</code><code class="p">.</code><code class="na">getScore</code><code class="p">(</code><code class="mi">1</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">response</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">disconnecting</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">String</code><code class="w"> </code><code class="n">parts</code><code class="o">[]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">" "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="k">switch</code><code class="w"> </code><code class="p">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">case</code><code class="w"> </code><code class="s">"END"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">case</code><code class="w"> </code><code class="s">"SCORE"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">gameField</code><code class="p">.</code><code class="na">setScore</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="n">parts</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">              </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">case</code><code class="w"> </code><code class="s">"DISCONNECT"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">disconnecting</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">              </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">default</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Warning. Unexpected command: "</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">                  </code><code class="n">parts</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">". Ignoring."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">catch</code><code class="p">(</code><code class="n">InterruptedException</code><code class="w"> </code><code class="n">e</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Interrupted while polling. Ignoring."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The client will mirror these actions. Fortunately for the client, it is just reacting to the commands coming from the server. We don’t need a separate polling mechanism here. We block waiting to read a line, parse it, and then build our response:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">while</code><code class="w"> </code><code class="p">(</code><code class="n">keepPlaying</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="o">[]</code><code class="w"> </code><code class="n">parts</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">" "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">switch</code><code class="w"> </code><code class="p">(</code><code class="n">parts</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">case</code><code class="w"> </code><code class="s">"END"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">case</code><code class="w"> </code><code class="s">"SCORE"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">gameField</code><code class="p">.</code><code class="na">setScore</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="w"> </code><code class="n">parts</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">case</code><code class="w"> </code><code class="s">"DISCONNECT"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">disconnecting</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">          </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">default</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Unexpected game command: "</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">response</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">". Ignoring."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">disconnecting</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="c1">// We're disconnecting or they are. Acknowledge and quit.</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"DISCONNECT"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="c1">// If we're not disconnecting, reply with our current score</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">gameField</code><code class="p">.</code><code class="na">trees</code><code class="p">.</code><code class="na">size</code><code class="p">()</code><code class="w"> </code><code class="o">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">writer</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"SCORE "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">writer</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"END "</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">gameField</code><code class="p">.</code><code class="na">getScore</code><code class="p">(</code><code class="mi">1</code><code class="p">));</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>When a player has cleared all of their trees and hedges, they send (or respond with) an <code>"END"</code> command that includes their final score. At that point, we ask if the same two players want to play again. If so, we can continue using the same <code>reader</code> and <code>writer</code> instances for both the server and the client. If not, we’ll let the client disconnect and the server will go back to listening for another player to join:<a data-primary="" data-startref="ix_net_client_server" data-type="indexterm" id="id2579"/><a data-primary="" data-startref="ix_sockets_ch13" data-type="indexterm" id="id2580"/><a data-primary="" data-startref="ix_net_prog" data-type="indexterm" id="id2581"/><a data-primary="" data-startref="ix_client_server2" data-type="indexterm" id="id2582"/><a data-primary="" data-startref="ix_client_server_distr_game" data-type="indexterm" id="id2583"/><a data-primary="" data-startref="ix_sockets_distr_game" data-type="indexterm" id="id2584"/><a data-primary="" data-startref="ix_protocol_distr_game" data-type="indexterm" id="id2585"/></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="c1">// If we're not disconnecting, ask about playing again</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="o">!</code><code class="n">disconnecting</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">String</code><code class="w"> </code><code class="n">message</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">gameField</code><code class="p">.</code><code class="na">getWinner</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">          </code><code class="s">" Would you like to ask them to play again?"</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">      </code><code class="kt">int</code><code class="w"> </code><code class="n">myPlayAgain</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">showConfirmDialog</code><code class="p">(</code><code class="n">gameField</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">message</code><code class="p">,</code><code class="w"> </code><code class="s">"Play Again?"</code><code class="p">,</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">YES_NO_OPTION</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">myPlayAgain</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">YES_OPTION</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="c1">// If they haven't disconnected, ask to play again</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"PLAY_AGAIN"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">String</code><code class="w"> </code><code class="n">playAgain</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">playAgain</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="k">switch</code><code class="w"> </code><code class="p">(</code><code class="n">playAgain</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">case</code><code class="w"> </code><code class="s">"YES"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">startNewGame</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">              </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">case</code><code class="w"> </code><code class="s">"DISCONNECT"</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">keepPlaying</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">startNewGame</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">false</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">disconnecting</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">              </code><code class="k">break</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">default</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Warning. Unexpected response: "</code><code class="w"/>&#13;
<code class="w">                  </code><code class="o">+</code><code class="w"> </code><code class="n">playAgain</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="s">". Not playing again."</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>And one last reciprocal bit of code for the client:</p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="o">!</code><code class="n">disconnecting</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="c1">// Check to see if they want to play again</code><code class="w"/>&#13;
<code class="w">      </code><code class="n">response</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">();</code><code class="w"/>&#13;
<code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">response</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">null</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="n">response</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"PLAY_AGAIN"</code><code class="p">))</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="c1">// Do we want to play again?</code><code class="w"/>&#13;
<code class="w">        </code><code class="n">String</code><code class="w"> </code><code class="n">message</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">gameField</code><code class="p">.</code><code class="na">getWinner</code><code class="p">()</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="w">            </code><code class="s">" Would you like to play again?"</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="kt">int</code><code class="w"> </code><code class="n">myPlayAgain</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">showConfirmDialog</code><code class="p">(</code><code class="n">gameField</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="n">message</code><code class="p">,</code><code class="w"> </code><code class="s">"Play Again?"</code><code class="p">,</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">YES_NO_OPTION</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="n">myPlayAgain</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="n">JOptionPane</code><code class="p">.</code><code class="na">YES_OPTION</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"YES"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">startNewGame</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="c1">// Not playing again so disconnect.</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">disconnecting</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">          </code><code class="n">writer</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"DISCONNECT"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p><a data-type="xref" href="#learnjava6-CHP-13-TABLE-4">Table 13-1</a> summarizes our simple protocol.</p>&#13;
<table id="learnjava6-CHP-13-TABLE-4">&#13;
<caption><span class="label">Table 13-1. </span>Apple tossing game protocol</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Server command</th>&#13;
<th>Args (optional)</th>&#13;
<th>Client response</th>&#13;
<th>Args (optional)</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>NEW_GAME</p></td>&#13;
<td/>&#13;
<td><p>OK</p></td>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>TREE</p></td>&#13;
<td><p>x y</p></td>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>START</p></td>&#13;
<td/>&#13;
<td><p>OK</p></td>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>SCORE</p></td>&#13;
<td><p>score</p></td>&#13;
<td><div>&#13;
<p>SCORE<br/>&#13;
END<br/>&#13;
DISCONNECT</p></div></td>&#13;
<td><div>&#13;
<p>score<br/>&#13;
score</p></div></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>END</p></td>&#13;
<td><p>score</p></td>&#13;
<td><div>&#13;
<p>SCORE<br/>&#13;
DISCONNECT</p></div></td>&#13;
<td><p>score</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>PLAY_AGAIN</p></td>&#13;
<td/>&#13;
<td><div>&#13;
<p>YES<br/>&#13;
DISCONNECT</p></div></td>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>DISCONNECT</p></td>&#13;
<td/>&#13;
<td/>&#13;
<td/>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Much More to Explore" data-type="sect1"><div class="sect1" id="learnjava6-CHP-13-SECT-6">&#13;
<h1>Much More to Explore</h1>&#13;
&#13;
<p>We could spend much more time on our game. We could expand the protocol to allow multiple opponents. We could change the objective to clear the obstacles and destroy your opponent. We could make the protocol more bidirectional, allowing the client to initiate some of the updates. We could use alternate lower-level protocols supported by Java, such as UDP rather than TCP. Indeed, there are entire books devoted to games, network programming, and programming networked games!</p>&#13;
&#13;
<p>But whew! You made it! Saying we covered a lot of ground is quite an understatement. We hope you have a solid understanding of Java’s syntax and core classes. You can use that understanding as you go forward and learn other interesting details and advanced techniques. Pick an area that interests you and go a little deeper. If you’re still curious about Java in general, try connecting parts of this book. For example, you could try using regular expressions to parse our apple toss game protocol. Or you could build a more sophisticated protocol altogether and pass small chunks of binary data over the network rather than simple strings. For practice writing more complex programs, you could rewrite some of the inner and anonymous classes in the game to be separate, standalone classes, or even replace them with lambda expressions.</p>&#13;
&#13;
<p>If you want to explore other Java libraries and packages while sticking with some of the examples you have already worked on, you could dig into the Java2D API and make nicer looking apples and trees. You could try out some of the other collection objects, like <code>TreeMap</code> or <code>Deque</code>. You could research the popular <a href="https://oreil.ly/oEa0E">JSON format</a> and try rewriting the multiplayer communication code. Using JSON for the protocol will likely give you the opportunity to work with a library as well.</p>&#13;
&#13;
<p>When you’re ready to branch out further, you could see how Java works off the desktop by trying some Android development. Or look at large networked environments and the Jakarta Enterprise Edition from the Eclipse Foundation. Maybe big data is on your radar? The Apache Foundation has several projects, such as Hadoop or Spark. Java has its detractors, but it remains a vibrant, vital part of the professional developer world.</p>&#13;
&#13;
<p>Now that we’ve laid out some avenues for future research, we are ready to wrap up the main part of our book. The <a data-type="xref" href="glossary01.html#learnjava6-GLOSS">Glossary</a> contains a quick reference of many useful terms and topics we’ve covered. <a data-type="xref" href="app01.html#learnjava6-APP-A">Appendix A</a> has some details on getting the code examples imported into IntelliJ IDEA. <a data-type="xref" href="app02.html#learnjava6-APP-B">Appendix B</a> includes answers to all of the review questions as well as some hints and guidance on the code exercises.</p>&#13;
&#13;
<p>We hope that you’ve enjoyed this sixth edition of <em>Learning Java</em>. This is really the eighth edition of the series that began over two decades ago with <em>Exploring Java</em>. It has been a long and amazing trip watching Java develop in that time, and we thank those of you who have come along with us over the years. As always, we welcome your feedback to help us keep making this book better in the future. Ready for another decade of Java? We are!</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review Questions" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-6.1">&#13;
<h2>Review Questions</h2>&#13;
<ol>&#13;
<li>&#13;
<p>Which networking protocols does the <code>URL</code> class support by default?</p>&#13;
</li>&#13;
<li>&#13;
<p>Can you use Java to download binary data from an online source?</p>&#13;
</li>&#13;
<li>&#13;
<p>What are the high-level steps to send form data to a web server using Java? Which classes are involved?</p>&#13;
</li>&#13;
<li>&#13;
<p>What class do you use to listen for incoming network connections?</p>&#13;
</li>&#13;
<li>&#13;
<p>When creating your own server like you did for the game, are there any rules for picking a port number?</p>&#13;
</li>&#13;
<li>&#13;
<p>Can a server application written in Java support multiple, simultaneous clients?</p>&#13;
</li>&#13;
<li>&#13;
<p>How many simultaneous servers can a given client <code>Socket</code> instance connect to?</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Code Exercises" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-6.2">&#13;
<h2>Code Exercises</h2>&#13;
<ol>&#13;
<li>&#13;
<p>Create your own, human-friendly <code>DateAtHost</code> client (<code>FDClient</code>, Friendly Date Client, in our solutions) and server (<code>FDServer</code>). Use the classes and formatters from <a data-type="xref" href="ch08.html#learnjava6-CHP-8-SECT-5">“Dates and Times”</a> to produce a server that sends one line of nicely formatted text containing the current date and time. Your client should read that line after connecting and print it out. (Your client does not need to extend <code>Instant</code> or even store the response beyond printing it out.)</p>&#13;
</li>&#13;
<li>&#13;
<p>Our game protocol does not yet include support for the hedge obstacles. (Hedges are still in the game, but they aren’t part of the network communications yet.) Review <a data-type="xref" href="#learnjava6-CHP-13-TABLE-4">Table 13-1</a> and add support for a <code>HEDGE</code> entry similar to our <code>TREE</code> lines. It may be easier to update the client side first, although you will need to update both sides to have the hedges work like the trees for both players.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Advanced Exercises" data-type="sect2"><div class="sect2" id="learnjava6-CHP-13-SECT-6.3">&#13;
<h2>Advanced Exercises</h2>&#13;
<ol>&#13;
<li>&#13;
<p>Upgrade your <code>FDServer</code> class to handle multiple, simultaneous clients with threads or virtual threads. You can put your client handling code in a lambda, an (anonymous) inner class, or a separate helper class. You should be able to use the same <code>FDClient</code> class from the first exercise without recompiling. If you use virtual threads, remember that they may still be a preview feature in your version of Java. Use the appropriate flags when compiling and running. (Our solution for this exercise is in <code>FDServer2</code>.)</p>&#13;
</li>&#13;
<li>&#13;
<p>This exercise is more of a nudge to go explore the world of web services now that you have seen some examples of using Java to interact with online APIs. Search online for a service with a free developer account option (signing up may still be necessary), and write a Java client for that service. Many of the services available online require some type of authentication, such as an <em>API token</em> or <em>API key</em> (usually long strings that work like unique usernames). Sites like <a href="https://oreil.ly/moEyN">random.org</a> or <a href="https://oreil.ly/8B4rl">openweathermap.org</a> could be fun places to start. (We do provide a completed client, <code>NetworkInt</code>, for getting random integers from <em>random.org</em> in the solutions. You’ll need to provide your own API key in the source for the client to work.)</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id2506"><sup><a href="ch13.html#id2506-marker">1</a></sup> Postman is a fantastic tool for web developers. You can learn more at the <a href="https://oreil.ly/3LKc6">Postman site</a>. The testing service they host at <a href="https://oreil.ly/hzZpS">postman-echo.com</a> accepts both GET and POST requests, and echoes back the request and any form or URL parameters.</p><p data-type="footnote" id="id2514"><sup><a href="ch13.html#id2514-marker">2</a></sup> You may have heard the phrase “MIME type” before. MIME has its roots in email, and the term “media” is meant to be more generic.</p><p data-type="footnote" id="id2534"><sup><a href="ch13.html#id2534-marker">3</a></sup> For a detailed discussion of these low-level sockets, see <em>Unix Network Programming</em> by W. Richard Stevens et al. (Prentice-Hall).</p><p data-type="footnote" id="id2546"><sup><a href="ch13.html#id2546-marker">4</a></sup> A peer-to-peer environment, for example, has machines that simultaneously perform both roles.</p><p data-type="footnote" id="id2559"><sup><a href="ch13.html#id2559-marker">5</a></sup> For more on well-known services and their standard port numbers, see the <a href="https://oreil.ly/4WCON">official list</a> hosted by the Internet Assigned Numbers Authority.</p><p data-type="footnote" id="id2561"><sup><a href="ch13.html#id2561-marker">6</a></sup> Massively Multiplayer Online Role-Playing Game, if, like the authors, you’re too old to recognize the acronym. Sigh.</p><p data-type="footnote" id="id2568"><sup><a href="ch13.html#id2568-marker">7</a></sup> Indeed, the publicly available site we use from NIST strongly encourages users to upgrade. See the <a href="https://oreil.ly/hYBSO">introductory notes</a> for the NIST Internet Time Servers for more information.</p></div></div></section></body></html>