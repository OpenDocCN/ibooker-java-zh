<html><head></head><body><section data-pdf-bookmark="Chapter 12. Reactive REST Client: Connecting &#10;with HTTP Endpoints" data-type="chapter" epub:type="chapter"><div class="chapter" id="http-client">&#13;
<h1><span class="label">Chapter 12. </span>Reactive REST Client: Connecting &#13;
<span class="keep-together">with HTTP Endpoints</span></h1>&#13;
&#13;
&#13;
<p><a data-primary="HTTP endpoints" data-secondary="connecting with" data-type="indexterm" id="ix_http-client-adoc0"/>The previous two chapters focused on messaging, the connective tissue of reactive systems.&#13;
Modern message brokers provide the perfect feature set to implement the internal communication of reactive systems.&#13;
However, at the frontier of your system, where you need to integrate remote services, there’s a good chance you need to use HTTP.&#13;
So let’s be pragmatic and see how we can consume HTTP services without breaking the reactive principles.</p>&#13;
&#13;
<p>In <a data-type="xref" href="ch08.html#http">Chapter 8</a>, you saw how to <em>expose</em> reactive HTTP endpoints.&#13;
This chapter presents the other side: how to <em>consume</em> HTTP endpoints.&#13;
Quarkus offers a nonblocking way to consume HTTP endpoints.&#13;
In addition, it provides resilience features to protect the integration points against failures and slowness.&#13;
It’s important to notice that the called service does not have to be a reactive application.&#13;
That’s up to the implementation of that service.</p>&#13;
&#13;
<p>Let’s see what Quarkus offers to consume HTTP endpoints.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Interacting with an HTTP Endpoint" data-type="sect1"><div class="sect1" id="idm45358816681824">&#13;
<h1>Interacting with an HTTP Endpoint</h1>&#13;
&#13;
<p><a data-primary="HTTP endpoints" data-secondary="interacting with" data-type="indexterm" id="ix_http-client-adoc1"/>Quarkus provides multiple ways to consume HTTP endpoints:</p>&#13;
<dl>&#13;
<dt>Vert.x Web Client</dt>&#13;
<dd>&#13;
<p>This low-level HTTP client is implemented on top of Vert.x and Netty (and so is inherently asynchronous and based on nonblocking I/O).</p>&#13;
</dd>&#13;
<dt>Reactive Messaging connector</dt>&#13;
<dd>&#13;
<p>This connector sends HTTP requests for each processed message.</p>&#13;
</dd>&#13;
<dt>REST client</dt>&#13;
<dd>&#13;
<p>This type-safe approach eases the consumption of HTTP-based APIs.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-primary="Vert.x Web Client" data-type="indexterm" id="idm45358816674576"/>Vert.x Web Client is convenient when you don’t want to bother being exposed to low-level HTTP details, such as verbs, headers, bodies, and response status.&#13;
The web client is flexible, and you have complete control over the HTTP request and the response processing.</p>&#13;
&#13;
<p>To use Vert.x Web Client, you need to add the dependency shown in <a data-type="xref" href="#dep-vertx-client">Example 12-1</a> in your project.</p>&#13;
<div data-type="example" id="dep-vertx-client">&#13;
<h5><span class="label">Example 12-1. </span>Dependency for Mutiny Vert.x Web Client</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.smallrye.reactive<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>smallrye-mutiny-vertx-web-client<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p>Then you can use it as shown in <a data-type="xref" href="#http-vertx-client">Example 12-2</a>.</p>&#13;
<div data-type="example" id="http-vertx-client">&#13;
<h5><span class="label">Example 12-2. </span>Vert.x Web Client example</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@ApplicationScoped</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">WebClientExample</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">final</code> <code class="n">WebClient</code> <code class="n">client</code><code class="o">;</code>&#13;
&#13;
    <code class="nd">@Inject</code>&#13;
    <code class="kd">public</code> <code class="nf">WebClientExample</code><code class="o">(</code><code class="n">Vertx</code> <code class="n">vertx</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">client</code> <code class="o">=</code> <code class="n">WebClient</code><code class="o">.</code><code class="na">create</code><code class="o">(</code><code class="n">vertx</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@PreDestroy</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">close</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">client</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">JsonObject</code><code class="o">&gt;</code> <code class="nf">invokeService</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">client</code>&#13;
            <code class="o">.</code><code class="na">getAbs</code><code class="o">(</code><code class="s">"https://httpbin.org/json"</code><code class="o">).</code><code class="na">send</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">response</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
                <code class="k">if</code> <code class="o">(</code><code class="n">response</code><code class="o">.</code><code class="na">statusCode</code><code class="o">()</code> <code class="o">==</code> <code class="mi">200</code><code class="o">)</code> <code class="o">{</code>&#13;
                    <code class="k">return</code> <code class="n">response</code><code class="o">.</code><code class="na">bodyAsJsonObject</code><code class="o">();</code>&#13;
                <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
                    <code class="k">return</code> <code class="k">new</code> <code class="nf">JsonObject</code><code class="o">()</code>&#13;
                            <code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="s">"error"</code><code class="o">,</code> <code class="n">response</code><code class="o">.</code><code class="na">statusMessage</code><code class="o">());</code>&#13;
                <code class="o">}</code>&#13;
            <code class="o">});</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>As you can see, you need to create and close <code>WebClient</code> yourself.&#13;
It exposes a Mutiny API, so it integrates perfectly within your Quarkus application.</p>&#13;
&#13;
<p><a data-primary="Reactive Messaging" data-secondary="connectors" data-type="indexterm" id="idm45358816663664"/>The HTTP reactive connector integrates with Reactive Messaging (see <a data-type="xref" href="ch10.html#messaging">Chapter 10</a>) and allows sending HTTP requests for each message.&#13;
It’s convenient when you design a message-processing pipeline where the outbound is an HTTP endpoint.&#13;
It handles the backpressure and controls the amount of concurrency (number of in-flight requests) but does not allow processing the response.</p>&#13;
&#13;
<p>To use this HTTP connector, you need the dependency shown in <a data-type="xref" href="#dep-http-connect">Example 12-3</a>.</p>&#13;
<div data-type="example" id="dep-http-connect">&#13;
<h5><span class="label">Example 12-3. </span>Dependency for the HTTP connector</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-reactive-messaging-http<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p>Then you can configure the connector as shown in <a data-type="xref" href="#http-send-messages">Example 12-4</a>.</p>&#13;
<div data-type="example" id="http-send-messages">&#13;
<h5><span class="label">Example 12-4. </span>Use the HTTP connector to send messages using HTTP POST requests</h5>&#13;
&#13;
<pre data-code-language="properties" data-type="programlisting"><code class="na">mp.messaging.outgoing.my-http-endpoint.connector</code><code class="o">=</code><code class="s">quarkus-http            </code><a class="co" href="#callout_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-1" id="co_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="na">mp.messaging.outgoing.my-http-endpoint.method</code><code class="o">=</code><code class="s">POST                       </code><a class="co" href="#callout_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-2" id="co_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="na">mp.messaging.outgoing.my-http-endpoint.url</code><code class="o">=</code><code class="s">https://httpbin.org/anything  </code><a class="co" href="#callout_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-3" id="co_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-1" id="callout_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Instruct Quarkus to use the <code>quarkus-http</code> connector to manage the <code>my-http-endpoint</code> channel.</p></dd>&#13;
<dt><a class="co" href="#co_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-2" id="callout_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Configure the HTTP method to use.</p></dd>&#13;
<dt><a class="co" href="#co_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-3" id="callout_reactive_rest_client__connecting___span_class__keep_together__with_http_endpoints__span__CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Configure the URL of the service to invoke.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>By default, the connector encodes the received messages to JSON.&#13;
You can also configure a custom serializer.&#13;
The connector also supports retries and time-out but, as said earlier, does not allow processing the response.&#13;
Any non-2<em>XX</em> HTTP response is considered a failure and will nack the message.</p>&#13;
&#13;
<p><a data-primary="REST client" data-type="indexterm" id="ix_http-client-adoc2"/>The last approach, the REST client, offers a declarative way to invoke an HTTP service.&#13;
It implements the <a href="https://oreil.ly/dX0Lv">MicroProfile REST Client specification</a>.&#13;
Instead of dealing with the HTTP requests and responses, you map the HTTP API in a Java interface.&#13;
Thanks to a couple of annotations, you express how to send the request and process the response.&#13;
The client uses the same JAX-RS annotations as the server side; see <a data-type="xref" href="#eg-rest-client">Example 12-5</a>.</p>&#13;
<div data-type="example" id="eg-rest-client">&#13;
<h5><span class="label">Example 12-5. </span>Example of REST client</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Path</code><code class="o">(</code><code class="s">"/v2"</code><code class="o">)</code>&#13;
<code class="nd">@RegisterRestClient</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">CountriesService</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/name/{name}"</code><code class="o">)</code>&#13;
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">Country</code><code class="o">&gt;</code> <code class="nf">getByName</code><code class="o">(</code><code class="nd">@PathParam</code> <code class="n">String</code> <code class="n">name</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The application uses the method from the interface directly.&#13;
The rest of this chapter focuses on the REST client and how to integrate it in reactive applications, including how to handle failure gracefully<a data-startref="ix_http-client-adoc2" data-type="indexterm" id="idm45358816380656"/>.<a data-startref="ix_http-client-adoc1" data-type="indexterm" id="idm45358816379920"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The REST Client Reactive" data-type="sect1"><div class="sect1" id="idm45358816681232">&#13;
<h1>The REST Client Reactive</h1>&#13;
&#13;
<p><a data-primary="HTTP endpoints" data-secondary="reactive REST client and" data-type="indexterm" id="ix_http-client-adoc3"/><a data-primary="reactive REST client" data-secondary="HTTP endpoints and" data-type="indexterm" id="ix_http-client-adoc4"/><a data-primary="REST client" data-secondary="reactive REST client and HTTP endpoints" data-type="indexterm" id="ix_http-client-adoc5"/>We need to be careful.&#13;
<a data-primary="threads" data-secondary="reactive REST client and" data-type="indexterm" id="idm45358816374048"/>Lots of <em>asynchronous</em> HTTP and REST clients do not use nonblocking I/O and instead delegate the HTTP requests to an internal thread pool.&#13;
This is not the case with the reactive REST client from Quarkus.&#13;
It relies on the reactive architecture of Quarkus.&#13;
Note that it’s not because it’s reactive that you can’t use it in a blocking manner.&#13;
As with most Quarkus features, you have the choice.&#13;
Even if you decide to use the blocking way, Quarkus would continue using I/O threads and delegate the calls on a worker thread for your application.</p>&#13;
&#13;
<p>To use the reactive REST client in Quarkus, add the dependency in <a data-type="xref" href="#dep-react-rest-client">Example 12-6</a> to your project.</p>&#13;
<div data-type="example" id="dep-react-rest-client">&#13;
<h5><span class="label">Example 12-6. </span>Dependency for the reactive REST client (<em>chapter-12/rest-client-example/pom.xml</em>)</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-rest-client-reactive<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p>If you plan to use JSON, which is often the case when using HTTP services, also add the dependency in <a data-type="xref" href="#dep-jackson-support">Example 12-7</a>.</p>&#13;
<div data-type="example" id="dep-jackson-support">&#13;
<h5><span class="label">Example 12-7. </span>Dependency for the Jackson support for the reactive REST client (<em>chapter-12/rest-client-example/pom.xml</em>)</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-rest-client-reactive-jackson<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
<p>The dependency adds the ability to serialize the request body into JSON and deserialize JSON payloads into objects.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mapping HTTP APIs to Java Interfaces" data-type="sect2"><div class="sect2" id="http-client-mapping">&#13;
<h2>Mapping HTTP APIs to Java Interfaces</h2>&#13;
&#13;
<p><a data-primary="reactive REST client" data-secondary="mapping HTTP APIs to Java interfaces" data-type="indexterm" id="ix_http-client-adoc6"/>The cornerstone of the REST client is a Java interface that represents the consumed HTTP endpoint.&#13;
This interface represents the HTTP API your application consumes.&#13;
It acts as a facade, enabling your application to avoid dealing with HTTP directly.&#13;
On each method of the interface, you use JAX-RS annotations to describe how to handle the HTTP request and response.&#13;
Let’s consider an example.&#13;
Imagine that you need to integrate the <a href="https://httpbin.org"><code>httpbin</code></a> service.&#13;
To call the <em>/uuid</em> endpoint (which returns a UUID), you need to create a Java interface with the method representing the call; see <a data-type="xref" href="#client-httpbin">Example 12-8</a>.</p>&#13;
<div data-type="example" id="client-httpbin">&#13;
<h5><span class="label">Example 12-8. </span>REST client for the <code>httpbin</code> service (<em>chapter-12/rest-client-example/src/main/java/org/acme/restclient/HttpApi.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@RegisterRestClient</code><code class="o">(</code><code class="n">configKey</code> <code class="o">=</code> <code class="s">"httpbin"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">HttpBinService</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
    <code class="n">String</code> <code class="nf">getUUID</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The first important fact about this interface is the <code>@RegisterRestClient</code> annotation.&#13;
It indicates that the interface represents an HTTP endpoint.&#13;
The <code>configKey</code> attribute defines the key we will use to configure the HTTP endpoint, such as the location.</p>&#13;
&#13;
<p>For now, this interface has a single method: <code>getUUID</code>.&#13;
When the application calls this method, it sends a <code>GET</code> request to <code>/uuid</code>, waits for the response, and reads the response body as <code>String</code>.&#13;
We define this behavior by using the <code>@GET</code> and <code>@Path</code> &#13;
<span class="keep-together">annotations</span>.</p>&#13;
&#13;
<p>Let’s add a method by using another HTTP method, as shown in <a data-type="xref" href="#send-json-payloads">Example 12-9</a>.</p>&#13;
<div data-type="example" id="send-json-payloads">&#13;
<h5><span class="label">Example 12-9. </span>Send JSON payloads</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">Person</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="n">name</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="nd">@POST</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/anything"</code><code class="o">)</code>&#13;
<code class="n">String</code> <code class="nf">anything</code><code class="o">(</code><code class="n">Person</code> <code class="n">someone</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>Calling this method sends a <code>POST</code> request on <code>/anything</code> with a JSON payload as the body.&#13;
The reactive REST client maps the instance of <code>Person</code> to JSON.&#13;
You can also use the <code>@Consume</code> annotation to set <code>content-type</code> explicitly.</p>&#13;
&#13;
<p>The REST client also lets you configure the request headers.&#13;
These headers can be constant and defined by using the <code>@ClientHeaderParam</code> annotation or can be passed as a method parameter by using the <code>@HeaderParam</code> annotation; see <a data-type="xref" href="#pass-headers">Example 12-10</a>.</p>&#13;
<div data-type="example" id="pass-headers">&#13;
<h5><span class="label">Example 12-10. </span>Pass headers</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@POST</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/anything"</code><code class="o">)</code>&#13;
<code class="nd">@ClientHeaderParam</code><code class="o">(</code><code class="n">name</code> <code class="o">=</code> <code class="s">"X-header"</code><code class="o">,</code> <code class="n">value</code> <code class="o">=</code> <code class="s">"constant value"</code><code class="o">)</code>&#13;
<code class="n">String</code> <code class="nf">anythingWithConstantHeader</code><code class="o">(</code><code class="n">Person</code> <code class="n">someone</code><code class="o">);</code>&#13;
&#13;
<code class="nd">@POST</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/anything"</code><code class="o">)</code>&#13;
<code class="n">String</code> <code class="nf">anythingWithHeader</code><code class="o">(</code><code class="n">Person</code> <code class="n">someone</code><code class="o">,</code>&#13;
                          <code class="nd">@HeaderParam</code><code class="o">(</code><code class="s">"X-header"</code><code class="o">)</code> <code class="n">String</code> <code class="n">value</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>To pass query parameters, use the <code>@QueryParameter</code> annotation (<a data-type="xref" href="#pass-query-params">Example 12-11</a>).</p>&#13;
<div data-type="example" id="pass-query-params">&#13;
<h5><span class="label">Example 12-11. </span>Pass query parameters</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@POST</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/anything"</code><code class="o">)</code>&#13;
<code class="n">String</code> <code class="nf">anythingWithQuery</code><code class="o">(</code><code class="n">Person</code> <code class="n">someone</code><code class="o">,</code>&#13;
                         <code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"param1"</code><code class="o">)</code> <code class="n">String</code> <code class="n">p1</code><code class="o">,</code>&#13;
                         <code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"param2"</code><code class="o">)</code> <code class="n">String</code> <code class="n">p2</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>Let’s now look at the response.&#13;
So far, we used only <code>String</code>, but the REST client can map the response to objects.&#13;
If we go back to the initial example (<code>/uuid</code>), it returns a JSON object with a single field: <code>uuid</code>.&#13;
We can map this response into an object, as shown in <a data-type="xref" href="#receive-json-objs">Example 12-12</a>.</p>&#13;
<div data-type="example" id="receive-json-objs">&#13;
<h5><span class="label">Example 12-12. </span>Receive JSON objects</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">UUID</code> <code class="o">{</code>&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="n">uuid</code><code class="o">;</code>&#13;
<code class="o">}</code>&#13;
&#13;
<code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="n">UUID</code> <code class="nf">uuid</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>By default, the REST client uses JSON to map the responses to objects.&#13;
You can use the <code>@Produces</code> annotation to configure the <code>Accept</code> header.</p>&#13;
&#13;
<p>If you want to handle the HTTP response yourself, to retrieve the status code or headers, you can return a <code>Response</code>, as shown in <a data-type="xref" href="#use-responses">Example 12-13</a>.</p>&#13;
<div data-type="example" id="use-responses">&#13;
<h5><span class="label">Example 12-13. </span>Use responses</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="n">Response</code> <code class="nf">getResponse</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>It’s the same <code>Response</code> as in <a data-type="xref" href="ch08.html#response">“Dealing with Failure and Customizing the Response”</a>.</p>&#13;
&#13;
<p>Mapping an HTTP API to a Java interface introduces a clear contract and avoids having HTTP code everywhere in the application code.&#13;
It also improves testability as you can quickly mock the remote service.&#13;
Finally, note that you don’t have to map all the endpoints of the remote service, only the one you use in your application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Invoking the Service" data-type="sect2"><div class="sect2" id="idm45358816325600">&#13;
<h2>Invoking the Service</h2>&#13;
&#13;
<p>To use the interface we defined in the previous section in your application, we need to do the following:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Inject the REST client in the application code.</p>&#13;
</li>&#13;
<li>&#13;
<p>Configure the URL of the service.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>The first step is straightforward; we just need to inject the client, as shown in <a data-type="xref" href="#use-httpbin-client">Example 12-14</a>.</p>&#13;
<div data-type="example" id="use-httpbin-client">&#13;
<h5><span class="label">Example 12-14. </span>Use the HTTPBin REST client (<em>chapter-12/rest-client-example/src/main/java/org/acme/restclient/HttpEndpoint.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Inject</code>&#13;
<code class="nd">@RestClient</code> <code class="n">HttpBinService</code> <code class="n">service</code><code class="o">;</code>&#13;
&#13;
<code class="kd">public</code> <code class="n">HttpBinService</code><code class="o">.</code><code class="na">UUID</code> <code class="nf">invoke</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="na">uuid</code><code class="o">();</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>@RestClient</code> qualifier indicates that the injected object is a REST client.&#13;
Once it’s injected, you can use any of the methods you have defined on the interface.</p>&#13;
&#13;
<p>To configure the client, open the <em>application.properties</em> file and add the following property:</p>&#13;
&#13;
<pre data-type="programlisting">httpbin/mp-rest/url=https://httpbin.org</pre>&#13;
&#13;
<p>The <code>httpbin</code> part is the configuration key used in the <code>@RegisterRestClient</code> interface.&#13;
Here we configure only the location, but you can configure <a href="https://oreil.ly/rD1tL">a lot more</a>.</p>&#13;
&#13;
<p>Of course, the URL can also be passed at runtime by using the <code>httpbin/mp-rest/url</code> system property or the <code>HTTPBIN_MP_REST_URL</code> environment property<a data-startref="ix_http-client-adoc6" data-type="indexterm" id="idm45358815939424"/>.<a data-startref="ix_http-client-adoc5" data-type="indexterm" id="idm45358815938560"/><a data-startref="ix_http-client-adoc4" data-type="indexterm" id="idm45358815937856"/><a data-startref="ix_http-client-adoc3" data-type="indexterm" id="idm45358815937184"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Blocking and Nonblocking" data-type="sect1"><div class="sect1" id="idm45358815990944">&#13;
<h1>Blocking and Nonblocking</h1>&#13;
&#13;
<p><a data-primary="blocking methods, reactive REST client and" data-type="indexterm" id="idm45358815935136"/><a data-primary="imperative methods" data-type="indexterm" id="idm45358815907328"/><a data-primary="nonblocking methods, reactive REST client and" data-type="indexterm" id="idm45358815906688"/><a data-primary="reactive methods" data-type="indexterm" id="idm45358815905920"/><a data-primary="reactive REST client" data-secondary="blocking/nonblocking methods" data-type="indexterm" id="idm45358815905248"/><a data-primary="threads" data-secondary="reactive REST client and" data-type="indexterm" id="idm45358815904288"/>As said previously, the reactive REST client from Quarkus supports both imperative (blocking) methods and reactive (nonblocking) methods.&#13;
The distinction is made by using the return type.&#13;
In <a data-type="xref" href="#http-client-mapping">“Mapping HTTP APIs to Java Interfaces”</a>, all our returned types are synchronous.&#13;
So Quarkus blocks the caller thread until the reception of the HTTP responses.&#13;
This is not great in terms of Reactive. Fortunately, you can avoid this by changing the return types to <code>Uni</code>, as shown in <a data-type="xref" href="#mutiny-rest-client">Example 12-15</a>.</p>&#13;
<div data-type="example" id="mutiny-rest-client">&#13;
<h5><span class="label">Example 12-15. </span>Use Mutiny in the REST client interfaces</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@RegisterRestClient</code><code class="o">(</code><code class="n">configKey</code> <code class="o">=</code> <code class="s">"reactive-httpbin"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">ReactiveHttpBinService</code> <code class="o">{</code>&#13;
&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getUUID</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">Person</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="n">String</code> <code class="n">name</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@POST</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/anything"</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">anything</code><code class="o">(</code><code class="n">Person</code> <code class="n">someone</code><code class="o">);</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">UUID</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="n">String</code> <code class="n">uuid</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">getResponse</code><code class="o">();</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>By returning <code>Uni</code> instead of the direct result type, you instruct the REST client not to block the caller thread.&#13;
Even better, it will use the current I/O thread, embrace the asynchronous execution model, and avoid additional thread switches.</p>&#13;
&#13;
<p>On the consumer side, you just use <code>Uni</code> and append the processing of the response to your pipeline (<a data-type="xref" href="#http-client-reactive-api">Example 12-16</a>).</p>&#13;
<div data-type="example" id="http-client-reactive-api">&#13;
<h5><span class="label">Example 12-16. </span>Use the reactive API of the REST client</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Inject</code>&#13;
<code class="nd">@RestClient</code> <code class="n">ReactiveHttpBinService</code> <code class="n">service</code><code class="o">;</code>&#13;
&#13;
<code class="kd">public</code> <code class="kt">void</code> <code class="nf">invoke</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">service</code><code class="o">.</code><code class="na">uuid</code><code class="o">()</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">u</code> <code class="o">-&gt;</code> <code class="n">u</code><code class="o">.</code><code class="na">uuid</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">subscribe</code><code class="o">().</code><code class="na">with</code><code class="o">(</code>&#13;
                    <code class="n">s</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Received "</code> <code class="o">+</code> <code class="n">s</code><code class="o">),</code>&#13;
                    <code class="n">f</code> <code class="o">-&gt;</code> <code class="n">System</code><code class="o">.</code><code class="na">out</code><code class="o">.</code><code class="na">println</code><code class="o">(</code><code class="s">"Failed with "</code> <code class="o">+</code> <code class="n">f</code><code class="o">)</code>&#13;
    <code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>In this example, we handle the subscription ourselves.&#13;
Don’t forget that you often rely on Quarkus to take care of this.&#13;
For example, returning <code>Uni</code> from a RESTEasy Reactive endpoint subscribes on the returned <code>Uni</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Failures" data-type="sect1"><div class="sect1" id="idm45358815687056">&#13;
<h1>Handling Failures</h1>&#13;
&#13;
<p><a data-primary="failure handling" data-secondary="reactive REST client and" data-type="indexterm" id="ix_http-client-adoc7"/><a data-primary="HTTP endpoints" data-secondary="failure handling" data-type="indexterm" id="ix_http-client-adoc8"/><a data-primary="reactive REST client" data-secondary="failure handling" data-type="indexterm" id="ix_http-client-adoc9"/>If you look at <a data-type="xref" href="#http-client-reactive-api">Example 12-16</a>, you can see that calling the REST client can emit a failure, and you need to handle it. Quarkus provides multiple ways to handle failure gracefully. You can use the Mutiny API to handle the failure, execute retries, or recover gracefully, as shown in <a data-type="xref" href="ch07.html#mutiny">Chapter 7</a>.&#13;
Also, Quarkus provides a declarative way to express how to handle failures.&#13;
This approach is particularly convenient when integrating remote systems (as with the REST client), because it combines the integration point and the failure management in a single location.</p>&#13;
&#13;
<p>The <code>quarkus-smallrye-fault-tolerance</code> extension provides a set of annotations to configure:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Fallback methods</p>&#13;
</li>&#13;
<li>&#13;
<p>Retries</p>&#13;
</li>&#13;
<li>&#13;
<p>Circuit breakers</p>&#13;
</li>&#13;
<li>&#13;
<p>Bulkheads</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><code>quarkus-smallrye-fault-tolerance</code> works for both imperative and reactive APIs.&#13;
In this section, we focus only on the latter.</p>&#13;
&#13;
<p>First, to use the Fault-Tolerance extension, add the dependency in <a data-type="xref" href="#dep-fault-tolerance">Example 12-17</a> to your project.</p>&#13;
<div data-type="example" id="dep-fault-tolerance">&#13;
<h5><span class="label">Example 12-17. </span>Dependency for fault-tolerance support (<em>chapter-12/api-gateway-example/api-gateway/pom.xml</em>)</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;dependency&gt;</code>&#13;
    <code class="nt">&lt;groupId&gt;</code>io.quarkus<code class="nt">&lt;/groupId&gt;</code>&#13;
    <code class="nt">&lt;artifactId&gt;</code>quarkus-smallrye-fault-tolerance<code class="nt">&lt;/artifactId&gt;</code>&#13;
<code class="nt">&lt;/dependency&gt;</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fallback" data-type="sect2"><div class="sect2" id="idm45358815650672">&#13;
<h2>Fallback</h2>&#13;
&#13;
<p><a data-primary="failure handling" data-secondary="fallback" data-type="indexterm" id="ix_http-client-adoc10"/><a data-primary="fallback" data-type="indexterm" id="ix_http-client-adoc11"/>A <em>fallback</em> is a method that provides an alternative result if the original invocation fails. Let’s reuse the example we have seen before, shown again here in <a data-type="xref" href="#uuid-method">Example 12-18</a>.</p>&#13;
<div data-type="example" id="uuid-method">&#13;
<h5><span class="label">Example 12-18. </span>The <code>uuid</code> method</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>If the interaction with the remote service fails, we can generate a fallback (local) UUID, as shown in <a data-type="xref" href="#declare-fallback">Example 12-19</a>.</p>&#13;
<div data-type="example" id="declare-fallback">&#13;
<h5><span class="label">Example 12-19. </span>Declare a fallback for the <code>uuid</code> method</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.Fallback</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
&#13;
&#13;
<code class="nd">@RegisterRestClient</code><code class="o">(</code><code class="n">configKey</code> <code class="o">=</code> <code class="s">"reactive-httpbin"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">ReactiveHttpBinServiceWithFallbackMethod</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">UUID</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="n">String</code> <code class="n">uuid</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
    <code class="nd">@Fallback</code><code class="o">(</code><code class="n">fallbackMethod</code> <code class="o">=</code> <code class="s">"fallback"</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code>&#13;
&#13;
    <code class="k">default</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">fallback</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="n">UUID</code> <code class="n">u</code> <code class="o">=</code> <code class="k">new</code> <code class="n">UUID</code><code class="o">();</code>&#13;
        <code class="n">u</code><code class="o">.</code><code class="na">uuid</code> <code class="o">=</code> <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">UUID</code><code class="o">.</code><code class="na">randomUUID</code><code class="o">().</code><code class="na">toString</code><code class="o">();</code>&#13;
        <code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">item</code><code class="o">(</code><code class="n">u</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>@Fallback</code> annotation indicates the name of the method to call.&#13;
This method must have the same signature as the original method.&#13;
So, in our case, it must return <code>Uni&lt;UUID&gt;</code>.&#13;
Our fallback implementation is simple, but you can imagine more complex scenarios such as calling an alternative service.</p>&#13;
&#13;
<p>If you need more control on the fallback, you can also provide a <code>FallbackHandler</code>; see <a data-type="xref" href="#fallback-handler">Example 12-20</a>.</p>&#13;
<div data-type="example" id="fallback-handler">&#13;
<h5><span class="label">Example 12-20. </span>Use a fallback handler</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">import</code> <code class="nn">io.smallrye.common.annotation.NonBlocking</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.ExecutionContext</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.Fallback</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.FallbackHandler</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@RegisterRestClient</code><code class="o">(</code><code class="n">configKey</code> <code class="o">=</code> <code class="s">"reactive-httpbin"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">ReactiveHttpBinServiceWithFallbackHandler</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">UUID</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="n">String</code> <code class="n">uuid</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
    <code class="nd">@Fallback</code><code class="o">(</code><code class="n">value</code> <code class="o">=</code> <code class="n">MyFallbackHandler</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">MyFallbackHandler</code> <code class="kd">implements</code> <code class="n">FallbackHandler</code><code class="o">&lt;</code><code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;&gt;</code> <code class="o">{</code>&#13;
&#13;
        <code class="nd">@Override</code>&#13;
        <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">handle</code><code class="o">(</code><code class="n">ExecutionContext</code> <code class="n">context</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="n">UUID</code> <code class="n">u</code> <code class="o">=</code> <code class="k">new</code> <code class="n">UUID</code><code class="o">();</code>&#13;
            <code class="n">u</code><code class="o">.</code><code class="na">uuid</code> <code class="o">=</code> <code class="n">java</code><code class="o">.</code><code class="na">util</code><code class="o">.</code><code class="na">UUID</code><code class="o">.</code><code class="na">randomUUID</code><code class="o">().</code><code class="na">toString</code><code class="o">();</code>&#13;
            <code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">item</code><code class="o">(</code><code class="n">u</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The configured fallback handler is called with an <code>ExecutionContext</code> encapsulating the original method and the exception.<a data-startref="ix_http-client-adoc11" data-type="indexterm" id="idm45358815460416"/><a data-startref="ix_http-client-adoc10" data-type="indexterm" id="idm45358815459808"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Retries" data-type="sect2"><div class="sect2" id="idm45358815459072">&#13;
<h2>Retries</h2>&#13;
&#13;
<p><a data-primary="failure handling" data-secondary="retries" data-type="indexterm" id="idm45358815286832"/><a data-primary="retries" data-type="indexterm" id="idm45358815285856"/>Fallback allows recovering gracefully with a local value.&#13;
The Fault-Tolerance extension also allows retrying.&#13;
Remember, retries should be used only when the called service is idempotent.&#13;
So, before using this feature, be sure it won’t harm your system.</p>&#13;
&#13;
<p>The <code>@Retry</code> annotation instructs Quarkus to retry the invocation multiple times, hoping that the next call would be successful (<a data-type="xref" href="#http-client-retry">Example 12-21</a>).</p>&#13;
<div data-type="example" id="http-client-retry">&#13;
<h5><span class="label">Example 12-21. </span>Declare a retry strategy</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="nd">@Retry</code><code class="o">(</code><code class="n">maxRetries</code> <code class="o">=</code> <code class="mi">10</code><code class="o">,</code> <code class="n">delay</code> <code class="o">=</code> <code class="mi">1000</code><code class="o">,</code> <code class="n">jitter</code> <code class="o">=</code> <code class="mi">100</code><code class="o">)</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>As you can see, you can configure the number of retries, as well as a delay and jitter to avoid retrying immediately.&#13;
You could combine <code>@Retry</code> and <code>@Fallback</code> to invoke the fallback method if all the attempts failed.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Time-out" data-type="sect2"><div class="sect2" id="idm45358815259808">&#13;
<h2>Time-out</h2>&#13;
&#13;
<p><a data-primary="failure handling" data-secondary="time-out" data-type="indexterm" id="idm45358815258816"/><a data-primary="time-out" data-type="indexterm" id="idm45358815257840"/>Failing fast is always better than having users waiting a long time.&#13;
The <code>@Timeout</code> annotation enforces that an invocation completes in a timely fashion; see <a data-type="xref" href="#config-timeout">Example 12-22</a>.</p>&#13;
<div data-type="example" id="config-timeout">&#13;
<h5><span class="label">Example 12-22. </span>Configure a time-out</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="nd">@Timeout</code><code class="o">(</code><code class="n">value</code> <code class="o">=</code> <code class="mi">3</code><code class="o">,</code> <code class="n">unit</code> <code class="o">=</code> <code class="n">ChronoUnit</code><code class="o">.</code><code class="na">SECONDS</code><code class="o">)</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>If the invocation does not produce a result in the configured time-out, it fails.&#13;
Combining <code>@Timeout</code> with <code>@Fallback</code> allows using a fallback result if the original call was unable to complete in the expected time.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bulkheads and Circuit Breaker" data-type="sect2"><div class="sect2" id="idm45358815203280">&#13;
<h2>Bulkheads and Circuit Breaker</h2>&#13;
&#13;
<p><a data-primary="bulkheads" data-type="indexterm" id="idm45358815201728"/><a data-primary="circuit breakers" data-type="indexterm" id="idm45358815201024"/><a data-primary="failure handling" data-secondary="circuit breakers/bulkheads" data-type="indexterm" id="idm45358815200352"/>The Quarkus fault-tolerance feature also provides circuit breakers and bulkheads.&#13;
While the other patterns protect your application against remote failures and slowness, these two last patterns avoid hammering unhealthy or brittle services.</p>&#13;
&#13;
<p>The first pattern, popularized a few years ago with libraries such as <a href="https://oreil.ly/eLHn0">Hystrix</a> or <a href="https://oreil.ly/yr4dO">Resilience4j</a>, detects failing services and gives them time to recover (instead of continuously calling them).&#13;
The circuit breaker allows your application to fail immediately to prevent repeated calls that are likely going to fail.&#13;
The circuit breaker operates much like an electrical circuit breaker.&#13;
A closed circuit represents a fully functional system, and an open circuit means an incomplete system.&#13;
If a failure occurs, the circuit breaker triggers to open the circuit, removing the point of failure from the system.</p>&#13;
&#13;
<p>The software circuit breaker has one more state: the half-open state.&#13;
After the circuit is opened, it periodically changes to the half-open state.&#13;
It checks whether the failed component is restored and closes the circuit after being considered safe and functional. To use a circuit breaker in Quarkus, just use the <code>@CircuitBreaker</code> annotation, as shown in <a data-type="xref" href="#use-circuit-breaker">Example 12-23</a>.</p>&#13;
<div data-type="example" id="use-circuit-breaker">&#13;
<h5><span class="label">Example 12-23. </span>Use a circuit breaker</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="nd">@CircuitBreaker</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>You can also configure the circuit breaker; see <a data-type="xref" href="#config-circuit-breaker">Example 12-24</a>.</p>&#13;
<div data-type="example" id="config-circuit-breaker">&#13;
<h5><span class="label">Example 12-24. </span>Configure a circuit breaker</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="nd">@CircuitBreaker</code><code class="o">(</code>&#13;
    <code class="c1">// Delay before switching to the half-open state</code>&#13;
    <code class="n">delay</code> <code class="o">=</code> <code class="mi">10</code><code class="o">,</code> <code class="n">delayUnit</code> <code class="o">=</code> <code class="n">ChronoUnit</code><code class="o">.</code><code class="na">SECONDS</code><code class="o">,</code>&#13;
    <code class="c1">// The number of successful executions,</code>&#13;
    <code class="c1">// before a half-open circuit is closed again</code>&#13;
    <code class="n">successThreshold</code> <code class="o">=</code> <code class="mi">2</code><code class="o">,</code>&#13;
    <code class="c1">// The ratio of failures within the rolling</code>&#13;
    <code class="c1">// window that will trip the circuit to open</code>&#13;
    <code class="n">failureRatio</code> <code class="o">=</code> <code class="mf">0.75</code><code class="o">,</code>&#13;
    <code class="c1">// The number of consecutive requests in a</code>&#13;
    <code class="c1">// rolling window</code>&#13;
    <code class="n">requestVolumeThreshold</code> <code class="o">=</code> <code class="mi">10</code>&#13;
<code class="o">)</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuidWithConfiguredCircuitBreaker</code><code class="o">();</code></pre></div>&#13;
&#13;
<p>Protecting your integration point with a circuit breaker not only allows you to prevent slow responses and failures in your application, but also gives the failing service time to recover.&#13;
Using a circuit breaker is handy when the service you interact with is under maintenance or heavy load.</p>&#13;
&#13;
<p>The idea behind the bulkhead pattern is to limit the propagation of failure.&#13;
You protect your application from failures happening in the remote service and avoid cascading them to the entire system and causing widespread issues.&#13;
The <code>@Bulkhead</code> annotation limits the number of concurrent requests and saves an unresponsive remote service from wasting system resources.</p>&#13;
&#13;
<p>Using the annotation helps you avoid having to deal with too many failures and avoids flooding a remote service with a high number of concurrent requests.&#13;
The latter aspect is essential.&#13;
With the reactive principles enabling high concurrency, you should never forget that the service you are calling may not be prepared for that load.&#13;
So using the <code>@Bulkhead</code> annotation allows controlling the outbound concurrency.&#13;
Yes, it will increase your response time and reduce your concurrency, but that’s for the sake of the global system state.</p>&#13;
&#13;
<p>You can configure the bulkhead with the max concurrency (<code>value</code>), and the maximum number of requests waiting for their turn, as demonstrated in <a data-type="xref" href="#http-client-bulkhead">Example 12-25</a>.&#13;
If the queue is full, it rejects any new invocations immediately, avoiding slow response time.<a data-startref="ix_http-client-adoc9" data-type="indexterm" id="idm45358815047392"/><a data-startref="ix_http-client-adoc8" data-type="indexterm" id="idm45358815046720"/><a data-startref="ix_http-client-adoc7" data-type="indexterm" id="idm45358815046048"/></p>&#13;
<div data-type="example" id="http-client-bulkhead">&#13;
<h5><span class="label">Example 12-25. </span>Declare a bulkhead</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@GET</code>&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/uuid"</code><code class="o">)</code>&#13;
<code class="nd">@Bulkhead</code><code class="o">(</code><code class="n">value</code> <code class="o">=</code> <code class="mi">5</code><code class="o">,</code> <code class="n">waitingTaskQueue</code> <code class="o">=</code> <code class="mi">1000</code><code class="o">)</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">UUID</code><code class="o">&gt;</code> <code class="nf">uuid</code><code class="o">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Building API Gateways with the RESTEasy Reactive Client" data-type="sect1"><div class="sect1" id="idm45358815202816">&#13;
<h1>Building API Gateways with the RESTEasy Reactive Client</h1>&#13;
&#13;
<p><a data-primary="API gateways" data-type="indexterm" id="ix_http-client-adoc12"/><a data-primary="HTTP endpoints" data-secondary="building API gateways with RESTEasy Reactive client" data-type="indexterm" id="ix_http-client-adoc13"/><a data-primary="RESTEasy Reactive" data-secondary="building API gateways with RESTEasy Reactive client" data-type="indexterm" id="ix_http-client-adoc14"/>In <a data-type="xref" href="ch08.html#http">Chapter 8</a>, we showed how to implement HTTP endpoints relying on nonblocking I/O and how this implementation can use Mutiny (covered in <a data-type="xref" href="ch07.html#mutiny">Chapter 7</a>) to orchestrate asynchronous tasks and avoid blocking.&#13;
This approach enables high concurrency and efficient resource usage.&#13;
This is the perfect combination for building API gateways.</p>&#13;
&#13;
<p>An <em>API gateway</em> is a service that sits in front of a set of backend services.&#13;
The gateway handles external requests and orchestrates other services.&#13;
For example, it can delegate a request to a single service and implement more complex processes involving multiple backend services.</p>&#13;
&#13;
<p>We can build highly concurrent, responsive, and resilient API gateways by combining Mutiny, RESTEasy Reactive, the reactive REST client, and the fault-tolerance annotations. In this section, we explain the basics of implementing such a gateway by exploring an example.&#13;
Three applications compose our system:</p>&#13;
<dl>&#13;
<dt>Greeting service</dt>&#13;
<dd>&#13;
<p>Exposes an HTTP API returning <code>Hello <em>{name}</em></code>, the name being a query &#13;
<span class="keep-together">parameter</span>.</p>&#13;
</dd>&#13;
<dt>Quote service</dt>&#13;
<dd>&#13;
<p>Exposes another HTTP API returning a random funny quote about coffee.</p>&#13;
</dd>&#13;
<dt>API gateway</dt>&#13;
<dd>&#13;
<p>Exposes an HTTP API that delegates requests on <code>/quote</code> to the quote service.&#13;
Requests made to <code>/</code> will call the greeting and quote services and build a JSON object encapsulating both.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>You can find the full code of the system in the <em>chapter-12/api-gateway-example</em> directory.&#13;
This section focuses on the API gateway component.&#13;
We do not cover the code of the greeting and quote services here as they are simple.&#13;
The source code of these components is available in the <em>chapter-12/api-gateway-example/greeting-service</em> and <em>chapter-12/api-gateway-example/quote-service</em> directories.&#13;
The API gateway application that you can find in <em>chapter-12/api-gateway-example/api-gateway</em> is more interesting, and we explore it together.</p>&#13;
&#13;
<p>First, let’s build and run this system. To build this example, in a terminal, navigate into <em>chapter-12/api-gateway-example</em> and run <code>mvn package</code>.&#13;
Then you will need three terminals:</p>&#13;
<ol>&#13;
<li>&#13;
<p>In the first one, run <code>java -jar target/quarkus-app/quarkus-run.jar</code> from the <em>chapter-12/api-gateway-example/greeting-service</em> directory.</p>&#13;
</li>&#13;
<li>&#13;
<p>In the second one, run <code>java -jar target/quarkus-app/quarkus-run.jar</code> from the <em>chapter-12/api-gateway-example/quote-service</em> directory.</p>&#13;
</li>&#13;
<li>&#13;
<p>Finally, in the third one, run <code>java -jar target/quarkus-app/quarkus-run.jar</code> from the <em>chapter-12/api-gateway-example/api-gateway</em> directory.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Ensure that ports 9010 (greeting service) and 9020 (quote service) are not used on your system. The API gateway uses port 8080.</p>&#13;
</div>&#13;
&#13;
<p>Once all services are running, you can use <code>curl</code> to invoke the API gateway, which orchestrates the other backend services (<a data-type="xref" href="#invoke-greeting">Example 12-26</a>).</p>&#13;
<div data-type="example" id="invoke-greeting">&#13;
<h5><span class="label">Example 12-26. </span>Invoke the greeting endpoint</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl http://localhost:8080/&#13;
<code class="o">{</code><code class="s2">"greeting"</code>:<code class="s2">"Hello anonymous"</code>,<code class="s2">"quote"</code>:<code class="s2">"I never drink coffee</code>&#13;
<code class="s2">at lunch. I find it keeps me awake for the afternoon."</code><code class="o">}</code></pre></div>&#13;
&#13;
<p>The cornerstone of the API gateway is the <code>Gateway</code> class, shown in <a data-type="xref" href="#gateway-class">Example 12-27</a>.</p>&#13;
<div data-type="example" id="gateway-class">&#13;
<h5><span class="label">Example 12-27. </span>The <code>Gateway</code> class (<em>chapter-12/api-gateway-example/api-gateway/src/main/java/org/acme/gateway/Gateway.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">gateway</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.rest.client.inject.RestClient</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.DefaultValue</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.QueryParam</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Gateway</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@RestClient</code>&#13;
    <code class="n">GreetingService</code> <code class="n">greetingService</code><code class="o">;</code>&#13;
&#13;
    <code class="nd">@RestClient</code>&#13;
    <code class="n">QuoteService</code> <code class="n">quoteService</code><code class="o">;</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/quote"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getQuote</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">quoteService</code><code class="o">.</code><code class="na">getQuote</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Greeting</code><code class="o">&gt;</code> <code class="nf">getBoth</code><code class="o">(</code>&#13;
            <code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"name"</code><code class="o">)</code>&#13;
            <code class="nd">@DefaultValue</code><code class="o">(</code><code class="s">"anonymous"</code><code class="o">)</code> <code class="n">String</code> <code class="n">name</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">greeting</code> <code class="o">=</code> <code class="n">greetingService</code><code class="o">.</code><code class="na">greeting</code><code class="o">(</code><code class="n">name</code><code class="o">);</code>&#13;
        <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">quote</code> <code class="o">=</code> <code class="n">quoteService</code><code class="o">.</code><code class="na">getQuote</code><code class="o">()</code>&#13;
                <code class="o">.</code><code class="na">onFailure</code><code class="o">()</code>&#13;
                    <code class="o">.</code><code class="na">recoverWithItem</code><code class="o">(</code><code class="s">"No coffee - no quote"</code><code class="o">);</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">combine</code><code class="o">().</code><code class="na">all</code><code class="o">().</code><code class="na">unis</code><code class="o">(</code><code class="n">greeting</code><code class="o">,</code> <code class="n">quote</code><code class="o">).</code><code class="na">asTuple</code><code class="o">()</code>&#13;
                <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">tuple</code> <code class="o">-&gt;</code>&#13;
                        <code class="k">new</code> <code class="nf">Greeting</code><code class="o">(</code><code class="n">tuple</code><code class="o">.</code><code class="na">getItem1</code><code class="o">(),</code>&#13;
                                <code class="n">tuple</code><code class="o">.</code><code class="na">getItem2</code><code class="o">())</code>&#13;
                <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">public</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">Greeting</code> <code class="o">{</code>&#13;
        <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">greeting</code><code class="o">;</code>&#13;
        <code class="kd">public</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">quote</code><code class="o">;</code>&#13;
&#13;
        <code class="kd">public</code> <code class="nf">Greeting</code><code class="o">(</code><code class="n">String</code> <code class="n">greeting</code><code class="o">,</code> <code class="n">String</code> <code class="n">quote</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">this</code><code class="o">.</code><code class="na">greeting</code> <code class="o">=</code> <code class="n">greeting</code><code class="o">;</code>&#13;
            <code class="k">this</code><code class="o">.</code><code class="na">quote</code> <code class="o">=</code> <code class="n">quote</code><code class="o">;</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>Gateway</code> class retrieves the two REST clients and handles the HTTP requests using them.&#13;
As an API gateway can be under heavy load and high concurrency, we use RESTEasy Reactive and its Mutiny integration, so we don’t need worker threads.</p>&#13;
&#13;
<p>The <code>getQuote</code> method is straightforward.&#13;
It delegates the calls to the <code>QuoteService</code>.</p>&#13;
&#13;
<p>The <code>getBoth</code> method is more interesting.&#13;
It needs to call both services and aggregate the response.&#13;
As both services are unrelated, we can call them concurrently.&#13;
As you have seen in <a data-type="xref" href="ch07.html#mutiny">Chapter 7</a>, this can be easily achieved with Mutiny by using the <code>Uni.combine</code> construct.&#13;
Once we have both responses encapsulated in a tuple, we build the <code>Greeting</code> structure and emit it.</p>&#13;
&#13;
<p>Let’s look at the REST clients. <code>GreetingService</code> uses the fault-tolerance annotation to be sure we handle failures or slow responses appropriately; see <a data-type="xref" href="#greeting-service-client">Example 12-28</a>.</p>&#13;
<div data-type="example" id="greeting-service-client">&#13;
<h5><span class="label">Example 12-28. </span>The <code>GreetingService</code> REST client (<em>chapter-12/api-gateway-example/api-gateway/src/main/java/org/acme/gateway/GreetingService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">gateway</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.*</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.QueryParam</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@RegisterRestClient</code><code class="o">(</code><code class="n">configKey</code> <code class="o">=</code> <code class="s">"greeting-service"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">GreetingService</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/"</code><code class="o">)</code>&#13;
    <code class="nd">@CircuitBreaker</code>&#13;
    <code class="nd">@Timeout</code><code class="o">(</code><code class="mi">2000</code><code class="o">)</code>&#13;
    <code class="nd">@Fallback</code><code class="o">(</code><code class="n">GreetingFallback</code><code class="o">.</code><code class="na">class</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">greeting</code><code class="o">(</code><code class="nd">@QueryParam</code><code class="o">(</code><code class="s">"name"</code><code class="o">)</code> <code class="n">String</code> <code class="n">name</code><code class="o">);</code>&#13;
&#13;
    <code class="kd">class</code> <code class="nc">GreetingFallback</code> <code class="kd">implements</code> <code class="n">FallbackHandler</code><code class="o">&lt;</code><code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code> <code class="o">{</code>&#13;
        <code class="nd">@Override</code>&#13;
        <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">handle</code><code class="o">(</code><code class="n">ExecutionContext</code> <code class="n">context</code><code class="o">)</code> <code class="o">{</code>&#13;
            <code class="k">return</code> <code class="n">Uni</code><code class="o">.</code><code class="na">createFrom</code><code class="o">().</code><code class="na">item</code><code class="o">(</code><code class="s">"Hello fallback"</code><code class="o">);</code>&#13;
        <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Notice that the greeting method combines the circuit breaker, time-out, and fallback annotations. <code>QuoteService</code> is similar but does not use the fallback annotation, as you can see in <a data-type="xref" href="#quote-service-client">Example 12-29</a>.</p>&#13;
<div data-type="example" id="quote-service-client">&#13;
<h5><span class="label">Example 12-29. </span>The <code>QuoteService</code> REST client (<em>chapter-12/api-gateway-example/api-gateway/src/main/java/org/acme/gateway/QuoteService.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">gateway</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.CircuitBreaker</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.faulttolerance.Timeout</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.rest.client.inject.RegisterRestClient</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@RegisterRestClient</code><code class="o">(</code><code class="n">configKey</code> <code class="o">=</code> <code class="s">"quote-service"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">interface</code> <code class="nc">QuoteService</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="nd">@Path</code><code class="o">(</code><code class="s">"/"</code><code class="o">)</code>&#13;
    <code class="nd">@CircuitBreaker</code>&#13;
    <code class="nd">@Timeout</code><code class="o">(</code><code class="mi">2000</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">getQuote</code><code class="o">();</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Instead, as you may have noticed, we handle failure by using the Mutiny API in the <code>Gateway</code> class (<a data-type="xref" href="#mutiny-fail-recover">Example 12-30</a>).</p>&#13;
<div data-type="example" id="mutiny-fail-recover">&#13;
<h5><span class="label">Example 12-30. </span>Recover from failures by using the Mutiny API (<em>chapter-12/api-gateway-example/api-gateway/src/main/java/org/acme/gateway/Gateway.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Uni</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">quote</code> <code class="o">=</code> <code class="n">quoteService</code><code class="o">.</code><code class="na">getQuote</code><code class="o">()</code>&#13;
   <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code><code class="s">"No coffee - no quote"</code><code class="o">);</code></pre></div>&#13;
&#13;
<p>While, in general, we choose between using the fault-tolerance annotation or using the Mutiny API, we wanted to highlight that you have the choice and can combine the two easily.&#13;
However, the <code>getQuote</code> method does not handle the failure and &#13;
<span class="keep-together">propagate</span> the error.&#13;
So, when using Mutiny to handle the failure, make sure you cover all entry points. Now, if you stop the quote service (by pressing Ctrl-C in the second terminal), you get the output in <a data-type="xref" href="#invoke-endpoint">Example 12-31</a>.</p>&#13;
<div data-type="example" id="invoke-endpoint">&#13;
<h5><span class="label">Example 12-31. </span>Invoke the endpoint</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl http://localhost:8080<code class="se">\?</code>name<code class="se">\=</code>luke&#13;
<code class="o">{</code><code class="s2">"greeting"</code>:<code class="s2">"Hello luke"</code>,<code class="s2">"quote"</code>:<code class="s2">"No coffee - no quote"</code><code class="o">}</code></pre></div>&#13;
&#13;
<p>If you also stop the greeting service, by pressing Ctrl-C in the first terminal, you get <a data-type="xref" href="#invoke-greeting-wo-service">Example 12-32</a>.</p>&#13;
<div data-type="example" id="invoke-greeting-wo-service">&#13;
<h5><span class="label">Example 12-32. </span>Invoke the greeting endpoint when there’s no greeting service</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl http://localhost:8080<code class="se">\?</code>name<code class="se">\=</code>luke&#13;
<code class="o">{</code><code class="s2">"greeting"</code>:<code class="s2">"Hello fallback"</code>,<code class="s2">"quote"</code>:<code class="s2">"No coffee - no quote"</code><code class="o">}</code></pre></div>&#13;
&#13;
<p>This section explored the fundamental constructs to build a highly concurrent API gateway.&#13;
Combining RESTEasy Reactive, the reactive REST client, fault tolerance, and Mutiny provides all the features you need to expose robust APIs to your users and handle failure gracefully.&#13;
The following section illustrates how the REST client can also be used in messaging applications.<a data-startref="ix_http-client-adoc14" data-type="indexterm" id="idm45358814362176"/><a data-startref="ix_http-client-adoc13" data-type="indexterm" id="idm45358814361680"/><a data-startref="ix_http-client-adoc12" data-type="indexterm" id="idm45358814361072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the REST Client in Messaging Applications" data-type="sect1"><div class="sect1" id="idm45358815025408">&#13;
<h1>Using the REST Client in Messaging Applications</h1>&#13;
&#13;
<p><a data-primary="HTTP endpoints" data-secondary="using the REST client in messaging applications" data-type="indexterm" id="ix_http-client-adoc15"/><a data-primary="messaging" data-secondary="using the REST client in messaging applications" data-type="indexterm" id="ix_http-client-adoc16"/><a data-primary="REST client" data-secondary="in messaging applications" data-type="indexterm" id="ix_http-client-adoc17"/>The REST client can also be helpful in messaging applications.&#13;
For example, a message-processing pipeline can call a remote HTTP API for each message or forward the messages to a remote HTTP endpoint.&#13;
We can use the REST client in a processing pipeline modeled with Reactive Messaging to achieve this. In this section, we explore an application receiving simple orders from an HTTP endpoint, process them, and persist them in a database:</p>&#13;
<ol>&#13;
<li>&#13;
<p><code>OrderEndpoint</code> receives <code>Order</code> and emits it into the <code>new-orders</code> channel.</p>&#13;
</li>&#13;
<li>&#13;
<p>An <code>OrderProcessing</code> component consumes the orders from the <code>new-order</code> channel and invokes the remote validation service. If the order gets validated successfully, it is sent to the <code>validated-orders</code> channel. Otherwise, the order is acknowledged negatively.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>OrderStorage</code> receives the order from the <code>validated-orders</code> channel and stores it in the database.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p class="pagebreak-before less_space">For the sake of simplicity, the validation endpoint runs in the same process, but invocations still use the REST client.&#13;
You can find the complete code of the application in <em>chapter-12/http-messaging-example</em>, but let’s go through it quickly.</p>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#http-client-order">Example 12-33</a>, the <code>Order</code> structure is simple.&#13;
It contains just the name of a product and a quantity.&#13;
Note that the <code>Order</code> class is a Panache entity.&#13;
We will use that to store the validated orders in the database.</p>&#13;
<div data-type="example" id="http-client-order">&#13;
<h5><span class="label">Example 12-33. </span>The <code>Order</code> structure (<em>chapter-12/http-messaging-example/src/main/java/org/acme/http/model/Order.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">http</code><code class="o">.</code><code class="na">model</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.quarkus.hibernate.reactive.panache.PanacheEntity</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.persistence.Entity</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.persistence.Table</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@Entity</code>&#13;
<code class="nd">@Table</code><code class="o">(</code><code class="n">name</code> <code class="o">=</code> <code class="s">"orders"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">Order</code> <code class="kd">extends</code> <code class="n">PanacheEntity</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">public</code> <code class="n">String</code> <code class="n">name</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="kt">int</code> <code class="n">quantity</code><code class="o">;</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p><code>OrderEndpoint</code> is also straightforward, as you can see in <a data-type="xref" href="#order-endpoint-class">Example 12-34</a>.</p>&#13;
<div data-type="example" id="order-endpoint-class">&#13;
<h5><span class="label">Example 12-34. </span>The <code>OrderEndpoint</code> class (<em>chapter-12/http-messaging-example/src/main/java/org/acme/http/OrderEndpoint.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">http</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Multi</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.reactive.messaging.MutinyEmitter</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.acme.http.model.Order</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Channel</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.GET</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.POST</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.Path</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">javax.ws.rs.core.Response</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@Path</code><code class="o">(</code><code class="s">"/order"</code><code class="o">)</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">OrderEndpoint</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@Channel</code><code class="o">(</code><code class="s">"new-orders"</code><code class="o">)</code>&#13;
    <code class="n">MutinyEmitter</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="n">emitter</code><code class="o">;</code>&#13;
&#13;
    <code class="nd">@POST</code>&#13;
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Response</code><code class="o">&gt;</code> <code class="nf">order</code><code class="o">(</code><code class="n">Order</code> <code class="n">order</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">emitter</code><code class="o">.</code><code class="na">send</code><code class="o">(</code><code class="n">order</code><code class="o">)</code>&#13;
                <code class="o">.</code><code class="na">log</code><code class="o">()</code>&#13;
                <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">Response</code><code class="o">.</code><code class="na">accepted</code><code class="o">().</code><code class="na">build</code><code class="o">())</code>&#13;
                <code class="o">.</code><code class="na">onFailure</code><code class="o">().</code><code class="na">recoverWithItem</code><code class="o">(</code>&#13;
                        <code class="n">Response</code><code class="o">.</code><code class="na">status</code><code class="o">(</code><code class="n">Response</code><code class="o">.</code><code class="na">Status</code><code class="o">.</code><code class="na">BAD_REQUEST</code><code class="o">)</code>&#13;
                                <code class="o">.</code><code class="na">build</code><code class="o">()</code>&#13;
                <code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@GET</code>&#13;
    <code class="kd">public</code> <code class="n">Multi</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">getAllValidatedOrders</code><code class="o">()</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">Order</code><code class="o">.</code><code class="na">streamAll</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The <code>order</code> method emits the received order to the <code>new-orders</code> channel.&#13;
When the message gets acknowledged, it produces a <code>202 - ACCEPTED</code> response.&#13;
If the message is nacked, it creates a <code>400 - BAD REQUEST</code> response.</p>&#13;
&#13;
<p>The <code>getAllValidatedOrders</code> method lets us check what has been written in the database. The <code>OrderProcessing</code> component consumes the orders from the <code>new-orders</code> channel and invokes the validation service, as shown in <a data-type="xref" href="#order-processing-class">Example 12-35</a>.</p>&#13;
<div data-type="example" id="order-processing-class">&#13;
<h5><span class="label">Example 12-35. </span>The <code>OrderProcessing</code> class (<em>chapter-12/http-messaging-example/src/main/java/org/acme/http/OrderProcessing.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">http</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.acme.http.model.Order</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.rest.client.inject.RestClient</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@ApplicationScoped</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">OrderProcessing</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@RestClient</code>&#13;
    <code class="n">ValidationService</code> <code class="n">validation</code><code class="o">;</code>&#13;
&#13;
    <code class="nd">@Incoming</code><code class="o">(</code><code class="s">"new-orders"</code><code class="o">)</code>&#13;
    <code class="nd">@Outgoing</code><code class="o">(</code><code class="s">"validated-orders"</code><code class="o">)</code>&#13;
    <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">validate</code><code class="o">(</code><code class="n">Order</code> <code class="n">order</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">validation</code><code class="o">.</code><code class="na">validate</code><code class="o">(</code><code class="n">order</code><code class="o">)</code>&#13;
                <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">order</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>The validation service fails if the order is invalid.&#13;
As a result, the message is nacked.&#13;
If the order is valid, it sends the order to the <code>validated-orders</code> channel.&#13;
The <code>OrderStorage</code> component consumes this channel and writes each order in the database (<a data-type="xref" href="#persist-orders">Example 12-36</a>).</p>&#13;
<div data-type="example" id="persist-orders">&#13;
<h5><span class="label">Example 12-36. </span>Persist orders in a database (<em>chapter-12/http-messaging-example/src/main/java/org/acme/http/OrderStorage.java</em>)</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kn">package</code> <code class="n">org</code><code class="o">.</code><code class="na">acme</code><code class="o">.</code><code class="na">http</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">io.quarkus.hibernate.reactive.panache.Panache</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">io.smallrye.mutiny.Uni</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.acme.http.model.Order</code><code class="o">;</code>&#13;
<code class="kn">import</code> <code class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</code><code class="o">;</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">javax.enterprise.context.ApplicationScoped</code><code class="o">;</code>&#13;
&#13;
<code class="nd">@ApplicationScoped</code>&#13;
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">OrderStorage</code> <code class="o">{</code>&#13;
&#13;
    <code class="nd">@Incoming</code><code class="o">(</code><code class="s">"validated-orders"</code><code class="o">)</code>&#13;
    <code class="kd">public</code> <code class="n">Uni</code><code class="o">&lt;</code><code class="n">Void</code><code class="o">&gt;</code> <code class="nf">store</code><code class="o">(</code><code class="n">Order</code> <code class="n">order</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="n">Panache</code><code class="o">.</code><code class="na">withTransaction</code><code class="o">(</code><code class="nl">order:</code><code class="o">:</code><code class="n">persist</code><code class="o">)</code>&#13;
                <code class="o">.</code><code class="na">replaceWithVoid</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Run the application with <code>mvn quarkus:dev</code> from the <em>chapter-12/http-messaging-example</em> directory.&#13;
As it uses Quarkus Dev Services, you don’t need to provision a database in dev mode; Quarkus does it for you.</p>&#13;
&#13;
<p>Once the application is running, add an order as shown in <a data-type="xref" href="#add-new-order">Example 12-37</a>.</p>&#13;
<div data-type="example" id="add-new-order">&#13;
<h5><span class="label">Example 12-37. </span>Invoke the endpoint to add a new order</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl -v  --header <code class="s2">"Content-Type: application/json"</code> <code class="se">\</code>&#13;
  --request POST <code class="se">\</code>&#13;
  --data <code class="s1">'{"name":"coffee", "quantity":2}'</code> <code class="se">\</code>&#13;
  http://localhost:8080/order</pre></div>&#13;
&#13;
<p>You can verify that the order has been processed by using <a data-type="xref" href="#retrieve-persisted-orders">Example 12-38</a>.</p>&#13;
<div data-type="example" id="retrieve-persisted-orders">&#13;
<h5><span class="label">Example 12-38. </span>Invoke the endpoint to retrieve the persisted orders</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl http://localhost:8080/order&#13;
<code class="o">[{</code><code class="s2">"id"</code>:1,<code class="s2">"name"</code>:<code class="s2">"coffee"</code>,<code class="s2">"quantity"</code>:2<code class="o">}]</code></pre></div>&#13;
&#13;
<p>Now try to insert an invalid order (using a negative quantity), as shown in <a data-type="xref" href="#invalid-order">Example 12-39</a>.</p>&#13;
<div data-type="example" id="invalid-order">&#13;
<h5><span class="label">Example 12-39. </span>Invoke the endpoint to introduce an invalid order</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl -v  --header <code class="s2">"Content-Type: application/json"</code> <code class="se">\</code>&#13;
  --request POST <code class="se">\</code>&#13;
  --data <code class="s1">'{"name":"book", "quantity":-1}'</code> <code class="se">\</code>&#13;
  http://localhost:8080/order</pre></div>&#13;
&#13;
<p>The response is <code>400</code>.&#13;
You can verify that it was not inserted in the database by using code in <a data-type="xref" href="#invalid-not-listed">Example 12-40</a>.</p>&#13;
<div data-type="example" id="invalid-not-listed">&#13;
<h5><span class="label">Example 12-40. </span>Invoke the endpoint to retrieve the persisted orders: the invalid order is not listed</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">&gt; curl http://localhost:8080/order&#13;
<code class="o">[{</code><code class="s2">"id"</code>:1,<code class="s2">"name"</code>:<code class="s2">"coffee"</code>,<code class="s2">"quantity"</code>:2<code class="o">}]</code></pre></div>&#13;
&#13;
<p>The validation step of the processing can use the fault-tolerance annotations to improve the reliability of the application (<a data-type="xref" href="#ft-annotations">Example 12-41</a>).</p>&#13;
<div data-type="example" id="ft-annotations">&#13;
<h5><span class="label">Example 12-41. </span>Use fault-tolerance annotations</h5>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="nd">@Incoming</code><code class="o">(</code><code class="s">"new-orders"</code><code class="o">)</code>&#13;
<code class="nd">@Outgoing</code><code class="o">(</code><code class="s">"validated-orders"</code><code class="o">)</code>&#13;
<code class="nd">@Timeout</code><code class="o">(</code><code class="mi">2000</code><code class="o">)</code>&#13;
<code class="n">Uni</code><code class="o">&lt;</code><code class="n">Order</code><code class="o">&gt;</code> <code class="nf">validate</code><code class="o">(</code><code class="n">Order</code> <code class="n">order</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">validation</code><code class="o">.</code><code class="na">validate</code><code class="o">(</code><code class="n">order</code><code class="o">)</code>&#13;
            <code class="o">.</code><code class="na">onItem</code><code class="o">().</code><code class="na">transform</code><code class="o">(</code><code class="n">x</code> <code class="o">-&gt;</code> <code class="n">order</code><code class="o">);</code>&#13;
<code class="o">}</code></pre></div>&#13;
&#13;
<p>Using the REST client in the messaging application allows you to smoothly integrate remote services in a processing workflow.<a data-startref="ix_http-client-adoc17" data-type="indexterm" id="idm45358813716784"/><a data-startref="ix_http-client-adoc16" data-type="indexterm" id="idm45358813671776"/><a data-startref="ix_http-client-adoc15" data-type="indexterm" id="idm45358813635632"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45358814329456">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>This chapter focused on integrating a remote HTTP API into your reactive application without breaking the reactive principles.&#13;
You learned how to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Integrate a remote HTTP endpoint with your reactive application by using the reactive REST client</p>&#13;
</li>&#13;
<li>&#13;
<p>Protect your integration point by using the fault-tolerance annotations</p>&#13;
</li>&#13;
<li>&#13;
<p>Build API gateways by combining Mutiny, RESTEasy Reactive, and the REST &#13;
<span class="keep-together">client</span></p>&#13;
</li>&#13;
<li>&#13;
<p>Integrate remote HTTP APIs in message-processing pipelines<a data-startref="ix_http-client-adoc0" data-type="indexterm" id="idm45358813629232"/></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The next chapter focuses on observability and how to keep your reactive system running under fluctuating load and when facing failures.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>